
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Starting to Protect My Private Keys With SmartCard-Hsm - stafwag Blog</title>
  <meta name="author" content="staf wagemakers">

  
  <meta name="description" content="Starting to Protect My Private Keys With SmartCard-Hsm Nov 21st, 2015 10:32 am I still have too many private keys on a local filesystem, I started &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="https://stafwag.github.io/blog/blog/2015/11/21/starting-to-protect-my-private-keys-with-smartcard-hsm/">
  <link href="/blog/favicon.png" rel="icon">
  <link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/blog/atom.xml" rel="alternate" title="stafwag Blog" type="application/atom+xml">
  <script src="/blog/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/blog/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37258385-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/blog/">stafwag Blog</a></h1>
  
    <h2>staf wagemakers blog</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/blog/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="stafwag.github.io/blog">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/">Blog</a></li>
  <li><a href="/blog/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Starting to Protect My Private Keys With SmartCard-Hsm</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-11-21T10:32:06+01:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2015</span></span> <span class='time'>10:32 am</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>I still have too many private keys on a local filesystem, I started to use the <a href="https://www.yubico.com/products/yubikey-hardware/yubikey-neo/">yubikey neo</a> for <a href="http://stafwag.github.io/blog/blog/2015/06/16/using-yubikey-neo-as-gpg-smartcard-for-ssh-authentication/">my ssh authentication</a>. Mainly because the nice formfactor of the yubikey.</p>

<p>For my other private keys/data I was looking for something cheeper since I need to have a backup of my secured data so I bought a few <a href="http://www.smartcard-hsm.com">Smartcard-HSM smartcards</a> they cost 16 &euro; each while a yubi-key neo cost 54 &euro; at amazon.de</p>

<h2>Preparing Backup and Restore</h2>

<p>The Smartcard-HSM has a backup/restore functionality this needs to be enabled before any keys are generated on the HSM.</p>

<p>To store our Device Key Encryption Key (DKEK) securely we need a safe place, we&rsquo;ll use an ecrypted usb stick.</p>

<p>It'is possible to configure multiple DKEK shares e.g. you will need multiple keys to perform a backup restore you might want to store these DKEK shares over multiple (encrypted) USB sticks/people.</p>

<p>If you want to create a backup of your DKEK shares we need to store at least two encrypted USB sticks.</p>

<p>For the convenience we&rsquo;ll store all DKEK shares on 1 encrypted USB stick in the example below you should executed it on an secured computer.</p>

<h3>Install opensc</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@vicky ~]$ sudo dnf install opensc
</span><span class='line'>Last metadata expiration check performed 0:23:14 ago on Wed Nov 11 14:47:21 2015.
</span><span class='line'>Package opensc-0.15.0-2.fc23.x86_64 is already installed, skipping.
</span><span class='line'>Dependencies resolved.
</span><span class='line'>Nothing to do.
</span><span class='line'>Complete!
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h3>Create an encrypted USB key stick</h3>

<h4>Write random data to the USB stick</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ sudo dd if=/dev/urandom of=/dev/sdn bs=1024
</span><span class='line'>[sudo] password for staf:                                                                                      
</span><span class='line'>dd: error writing ‘/dev/sdn’: No space left on device                                                          
</span><span class='line'>4029441+0 records in                                                                                           
</span><span class='line'>4029440+0 records out                                                                                          
</span><span class='line'>4126146560 bytes (4.1 GB) copied, 1280.14 s, 3.2 MB/s                                                          
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h4>luksFormat</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ sudo cryptsetup luksFormat --cipher serpent-cbc-essiv:sha256 --key-size 256 /dev/sdn
</span><span class='line'>
</span><span class='line'>WARNING!
</span><span class='line'>========
</span><span class='line'>This will overwrite data on /dev/sdn irrevocably.
</span><span class='line'>
</span><span class='line'>Are you sure? (Type uppercase yes): YES
</span><span class='line'>Enter passphrase: 
</span><span class='line'>Verify passphrase: 
</span><span class='line'>[staf@vicky ~]$ sudo cry
</span><span class='line'>cryptoflex-tool  cryptsetup       crywrap          
</span><span class='line'>[staf@vicky ~]$ sudo cryptsetup luksOpen /dev/sdn myprivatedata
</span><span class='line'>Enter passphrase for /dev/sdn: 
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h4>luksOpen</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ sudo cryptsetup luksOpen /dev/sdn myprivatedata
</span><span class='line'>Enter passphrase for /dev/sdn: 
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h4>mkfs</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ sudo mkfs.ext4 /dev/mapper/myprivatedata
</span><span class='line'>mke2fs 1.42.13 (17-May-2015)
</span><span class='line'>Creating filesystem with 1007360 4k blocks and 251968 inodes
</span><span class='line'>Filesystem UUID: 49390936-49e3-4606-abf2-567c3f5b50e1
</span><span class='line'>Superblock backups stored on blocks: 
</span><span class='line'>        32768, 98304, 163840, 229376, 294912, 819200, 884736
</span><span class='line'>
</span><span class='line'>Allocating group tables: done                            
</span><span class='line'>Writing inode tables: done                            
</span><span class='line'>Creating journal (16384 blocks): done
</span><span class='line'>Writing superblocks and filesystem accounting information: done 
</span><span class='line'>
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h3>Verify the encrypted USB stick</h3>

<p>To verify that the USB stick is encrypted and we can&rsquo;t mount without typing our passphrase we&rsquo;ll close the luks device and mount it.</p>

<h4>luksClose</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ sudo cryptsetup luksClose myprivatedata
</span><span class='line'>[sudo] password for staf: 
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h4>Try to mount it without luksOpen</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ sudo mount /dev/sdn /mnt
</span><span class='line'>mount: unknown filesystem type 'crypto_LUKS'
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h4>Mount it with luksOpen / mount</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ sudo cryptsetup luksOpen /dev/sdn myhsm_dkek
</span><span class='line'>Enter passphrase for /dev/sdn: 
</span><span class='line'>[staf@vicky ~]$ sudo mount /dev/mapper/myhsm_dkek /mnt
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h4>update the ownership</h4>

<p>Update the usb stick ownership</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ sudo chown staf:staf .
</span><span class='line'>[sudo] password for staf: 
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<h2>SmartCard initialization</h2>

<h3>pcsc_scan</h3>

<h4>start the pcscd service</h4>

<p>Start/enable the pcscd service if didn&rsquo;t enable it before</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@vicky ~]# systemctl list-unit-files -t service | grep pcscd
</span><span class='line'>pcscd.service                               static  
</span><span class='line'>[root@vicky ~]# systemctl start pcscd
</span><span class='line'>[root@vicky ~]# systemctl enable pcscd
</span><span class='line'>[root@vicky ~]# </span></code></pre></td></tr></table></div></figure>


<h4>run pcsc_scan</h4>

<p>Insert the smartcard into the read, run pcsc_scan to verify that you see the smartcard</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ pcsc_scan                    
</span><span class='line'>PC/SC device scanner
</span><span class='line'>V 1.4.23 (c) 2001-2011, Ludovic Rousseau &lt;ludovic.rousseau@free.fr&gt;
</span><span class='line'>Compiled with PC/SC lite version: 1.8.13
</span><span class='line'>Using reader plug'n play mechanism
</span><span class='line'>Scanning present readers...
</span><span class='line'>0: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>
</span><span class='line'>Wed Nov 11 10:58:59 2015
</span><span class='line'>Reader 0: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>  Card state: Card inserted, 
</span><span class='line'>  ATR: 3B FE 18 00 00 81 31 FE 45 80 31 81 54 48 53 4D 31 73 80 21 40 81 07 FA
</span><span class='line'>
</span><span class='line'>ATR: 3B FE 18 00 00 81 31 FE 45 80 31 81 54 48 53 4D 31 73 80 21 40 81 07 FA
</span><span class='line'>+ TS = 3B --&gt; Direct Convention
</span><span class='line'>+ T0 = FE, Y(1): 1111, K: 14 (historical bytes)
</span><span class='line'>  TA(1) = 18 --&gt; Fi=372, Di=12, 31 cycles/ETU
</span><span class='line'>    129032 bits/s at 4 MHz, fMax for Fi = 5 MHz =&gt; 161290 bits/s                                                     
</span><span class='line'>  TB(1) = 00 --&gt; VPP is not electrically connected
</span><span class='line'>  TC(1) = 00 --&gt; Extra guard time: 0
</span><span class='line'>  TD(1) = 81 --&gt; Y(i+1) = 1000, Protocol T = 1 
</span><span class='line'>-----
</span><span class='line'>  TD(2) = 31 --&gt; Y(i+1) = 0011, Protocol T = 1 
</span><span class='line'>-----
</span><span class='line'>  TA(3) = FE --&gt; IFSC: 254
</span><span class='line'>  TB(3) = 45 --&gt; Block Waiting Integer: 4 - Character Waiting Integer: 5
</span><span class='line'>+ Historical bytes: 80 31 81 54 48 53 4D 31 73 80 21 40 81 07
</span><span class='line'>  Category indicator byte: 80 (compact TLV data object)
</span><span class='line'>    Tag: 3, len: 1 (card service data byte)
</span><span class='line'>      Card service data byte: 81
</span><span class='line'>        - Application selection: by full DF name
</span><span class='line'>        - EF.DIR and EF.ATR access services: by GET RECORD(s) command
</span><span class='line'>        - Card without MF
</span><span class='line'>    Tag: 5, len: 4 (card issuer's data)
</span><span class='line'>      Card issuer data: 48 53 4D 31
</span><span class='line'>    Tag: 7, len: 3 (card capabilities)
</span><span class='line'>      Selection methods: 80
</span><span class='line'>        - DF selection by full DF name
</span><span class='line'>      Data coding byte: 21
</span><span class='line'>        - Behaviour of write functions: proprietary
</span><span class='line'>        - Value 'FF' for the first byte of BER-TLV tag fields: invalid
</span><span class='line'>        - Data unit in quartets: 2
</span><span class='line'>      Command chaining, length fields and logical channels: 40
</span><span class='line'>        - Extended Lc and Le fields
</span><span class='line'>        - Logical channel number assignment: No logical channel
</span><span class='line'>        - Maximum number of logical channels: 1
</span><span class='line'>    Tag: 8, len: 1 (status indicator)
</span><span class='line'>      LCS (life card cycle): 07
</span><span class='line'>+ TCK = FA (correct checksum)
</span><span class='line'>
</span><span class='line'>Possibly identified card (using /usr/share/pcsc/smartcard_list.txt):
</span><span class='line'>3B FE 18 00 00 81 31 FE 45 80 31 81 54 48 53 4D 31 73 80 21 40 81 07 FA
</span><span class='line'>        Smartcard-HSM
</span><span class='line'>        http://www.cardcontact.de/products/sc-hsm.html
</span></code></pre></td></tr></table></div></figure>


<h3>Initialize the first smartcard</h3>

<h4>Create two DKEK shares</h4>

<ul>
<li>1st share;</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --create-dkek-share dkek-share-1.pbe
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>
</span><span class='line'>The DKEK share will be enciphered using a key derived from a user supplied password.
</span><span class='line'>The security of the DKEK share relies on a well chosen and sufficiently long password.
</span><span class='line'>The recommended length is more than 10 characters, which are mixed letters, numbers and
</span><span class='line'>symbols.
</span><span class='line'>
</span><span class='line'>Please keep the generated DKEK share file in a safe location. We also recommend to keep a
</span><span class='line'>paper printout, in case the electronic version becomes unavailable. A printable version
</span><span class='line'>of the file can be generated using "openssl base64 -in &lt;filename&gt;".
</span><span class='line'>Enter password to encrypt DKEK share : 
</span><span class='line'>
</span><span class='line'>Please retype password to confirm : 
</span><span class='line'>
</span><span class='line'>Passwords do not match. Please retry.
</span><span class='line'>Enter password to encrypt DKEK share : 
</span><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --create-dkek-share dkek-share-1.pbe
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>
</span><span class='line'>The DKEK share will be enciphered using a key derived from a user supplied password.
</span><span class='line'>The security of the DKEK share relies on a well chosen and sufficiently long password.
</span><span class='line'>The recommended length is more than 10 characters, which are mixed letters, numbers and
</span><span class='line'>symbols.
</span><span class='line'>
</span><span class='line'>Please keep the generated DKEK share file in a safe location. We also recommend to keep a
</span><span class='line'>paper printout, in case the electronic version becomes unavailable. A printable version
</span><span class='line'>of the file can be generated using "openssl base64 -in &lt;filename&gt;".
</span><span class='line'>Enter password to encrypt DKEK share : 
</span><span class='line'>
</span><span class='line'>Please retype password to confirm : 
</span><span class='line'>
</span><span class='line'>Enciphering DKEK share, please wait...
</span><span class='line'>DKEK share created and saved to dkek-share-1.pbe
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<ul>
<li>2nd share;</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --create-dkek-share dkek-share-2.pbe
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>
</span><span class='line'>The DKEK share will be enciphered using a key derived from a user supplied password.
</span><span class='line'>The security of the DKEK share relies on a well chosen and sufficiently long password.
</span><span class='line'>The recommended length is more than 10 characters, which are mixed letters, numbers and
</span><span class='line'>symbols.
</span><span class='line'>
</span><span class='line'>Please keep the generated DKEK share file in a safe location. We also recommend to keep a
</span><span class='line'>paper printout, in case the electronic version becomes unavailable. A printable version
</span><span class='line'>of the file can be generated using "openssl base64 -in &lt;filename&gt;".
</span><span class='line'>Enter password to encrypt DKEK share : 
</span><span class='line'>
</span><span class='line'>Please retype password to confirm : 
</span><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --create-dkek-share dkek-share-2.pbe
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>
</span><span class='line'>The DKEK share will be enciphered using a key derived from a user supplied password.
</span><span class='line'>The security of the DKEK share relies on a well chosen and sufficiently long password.
</span><span class='line'>The recommended length is more than 10 characters, which are mixed letters, numbers and
</span><span class='line'>symbols.
</span><span class='line'>
</span><span class='line'>Please keep the generated DKEK share file in a safe location. We also recommend to keep a
</span><span class='line'>paper printout, in case the electronic version becomes unavailable. A printable version
</span><span class='line'>of the file can be generated using "openssl base64 -in &lt;filename&gt;".
</span><span class='line'>Enter password to encrypt DKEK share : 
</span><span class='line'>
</span><span class='line'>Please retype password to confirm : 
</span><span class='line'>
</span><span class='line'>Enciphering DKEK share, please wait...
</span><span class='line'>DKEK share created and saved to dkek-share-2.pbe
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<p>If you want a backup of DKEK shares copy them to another (encrypted) USB stick(s).</p>

<h4>Initialize the SmartCard</h4>

<ul>
<li>Initialize</li>
</ul>


<p>Use sc-hsm-tool to Intialize the smartcard and specify the number DKEK shares that you&rsquo;ll use. You&rsquo;ll need to pick a PIN code for the &ldquo;security officer&rdquo; and the &ldquo;user&rdquo;.</p>

<p>If you forget the so-pin you can not reinitialize the smartcard again so be sure that you pick so-pin that you can remember or write it down and store it on secure location. The so-pin has to be 16 digits long.</p>

<p><strong>
The sc-hsm-tool only asks for the PIN code ones so be sure that you know what you have typed. If you don&rsquo;t know it you smartcard becomes trash&hellip;
</strong></p>

<p>It possible to specify the pin code with &ldquo;&ndash;so-pin&rdquo; and &ldquo;&ndash;pin&rdquo; argument but this leaves the pin code in your shell history or in the process list&hellip;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --initialize --dkek-shares 2
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>Enter SO-PIN (16 hexadecimal characters) : 
</span><span class='line'>
</span><span class='line'>Enter initial User-PIN (6 - 16 characters) : 
</span><span class='line'>
</span><span class='line'>[staf@vicky mnt]$ 
</span></code></pre></td></tr></table></div></figure>


<p>If you execute the sc-hsm-tool command you&rsquo;ll see that the DKEK shares are still missing;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ sc-hsm-tool 
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>Version              : 1.2
</span><span class='line'>User PIN tries left  : 3
</span><span class='line'>DKEK shares          : 2
</span><span class='line'>DKEK import pending, 2 share(s) still missing
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<ul>
<li>import the dkek shares</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --import-dkek-share dkek-share-1.pbe
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>Enter password to decrypt DKEK share : 
</span><span class='line'>
</span><span class='line'>Deciphering DKEK share, please wait...
</span><span class='line'>DKEK share imported
</span><span class='line'>DKEK shares          : 2
</span><span class='line'>DKEK import pending, 1 share(s) still missing
</span><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --import-dkek-share dkek-share-2.pbe
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>Enter password to decrypt DKEK share : 
</span><span class='line'>
</span><span class='line'>Deciphering DKEK share, please wait...
</span><span class='line'>DKEK share imported
</span><span class='line'>DKEK shares          : 2
</span><span class='line'>DKEK key check value : 2C63E9E5D6FE0B8C
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<h4>test the user and so pin</h4>

<p>list the pkcs#11 slots</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ pkcs11-tool --module opensc-pkcs11.so -L
</span><span class='line'>Available slots:
</span><span class='line'>Slot 0 (0xffffffffffffffff): Virtual hotplug slot
</span><span class='line'>  (empty)
</span><span class='line'>Slot 1 (0x1): Generic Smart Card Reader Interface [Smart Card Reader Interface
</span><span class='line'>  token label        : SmartCard-HSM (UserPIN)
</span><span class='line'>  token manufacturer : www.CardContact.de
</span><span class='line'>  token model        : PKCS#15 emulated
</span><span class='line'>  token flags        : rng, login required, PIN initialized, token initialized
</span><span class='line'>  hardware version   : 24.13
</span><span class='line'>  firmware version   : 1.2
</span><span class='line'>  serial num         : DECM0102332
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<p>test the user pin;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@vicky mnt]$ pkcs11-tool --module opensc-pkcs11.so --slot 1 --login --test
</span><span class='line'>Logging in to "SmartCard-HSM (UserPIN)".
</span><span class='line'>Please enter User PIN: 
</span><span class='line'>C_SeedRandom() and C_GenerateRandom():
</span><span class='line'>  seeding (C_SeedRandom) not supported
</span><span class='line'>  seems to be OK
</span><span class='line'>Digests:
</span><span class='line'>  all 4 digest functions seem to work
</span><span class='line'>  MD5: OK
</span><span class='line'>  SHA-1: OK
</span><span class='line'>  RIPEMD160: OK
</span><span class='line'>Signatures (currently only RSA signatures)
</span><span class='line'>Signatures: no private key found in this slot
</span><span class='line'>Verify (currently only for RSA):
</span><span class='line'>  No private key found for testing
</span><span class='line'>Unwrap: not implemented
</span><span class='line'>Decryption (RSA)
</span><span class='line'>No errors
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<p>test the so pin</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ pkcs11-tool --module opensc-pkcs11.so --slot 1 --login --test --login-type so
</span><span class='line'>Logging in to "SmartCard-HSM (UserPIN)".
</span><span class='line'>Please enter SO PIN: 
</span><span class='line'>C_SeedRandom() and C_GenerateRandom():
</span><span class='line'>  seeding (C_SeedRandom) not supported
</span><span class='line'>  seems to be OK
</span><span class='line'>Digests:
</span><span class='line'>  all 4 digest functions seem to work
</span><span class='line'>  MD5: OK
</span><span class='line'>  SHA-1: OK
</span><span class='line'>  RIPEMD160: OK
</span><span class='line'>Signatures: not logged in, skipping signature tests
</span><span class='line'>Verify: not logged in, skipping verify tests
</span><span class='line'>Key unwrap: not a R/W session, skipping key unwrap tests
</span><span class='line'>Decryption: not logged in, skipping decryption tests
</span><span class='line'>No errors
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<h3>Create your first keypair</h3>

<h4>create key pair</h4>

<p>The command below an <a href="https://en.wikipedia.org/wiki/Elliptic_curve_cryptography">Elliptic Curve Cryptography (ECC)</a> key pair.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ pkcs11-tool --module opensc-pkcs11.so --keypairgen --key-type EC:prime256v1 --label myfirst_keypair --login
</span><span class='line'>Using slot 1 with a present token (0x1)
</span><span class='line'>Logging in to "SmartCard-HSM (UserPIN)".
</span><span class='line'>Please enter User PIN: 
</span><span class='line'>Key pair generated:
</span><span class='line'>Private Key Object; EC
</span><span class='line'>  label:      myfirst_keypair
</span><span class='line'>  ID:         ae79417e809ed19b9a69d4c14f444462ad0bd66c
</span><span class='line'>  Usage:      sign, derive
</span><span class='line'>Public Key Object; EC  EC_POINT 256 bits
</span><span class='line'>  EC_POINT:   044104f8ead77d1411e016196141d9d1f747a481aec4be40d1f8822d26d407fee05902082e18843ee58db4f5575b19ff243a735b66b2c91adbec1a59aeacc7c1ae8b52
</span><span class='line'>  EC_PARAMS:  06082a8648ce3d030107
</span><span class='line'>  label:      myfirst_keypair
</span><span class='line'>  ID:         ae79417e809ed19b9a69d4c14f444462ad0bd66c
</span><span class='line'>  Usage:      verify
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<h4>list objects</h4>

<p>list the objects to verif that your keypair in on the smartcard</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@vicky mnt]$ pkcs11-tool --module opensc-pkcs11.so --list-objects
</span><span class='line'>Using slot 1 with a present token (0x1)
</span><span class='line'>Public Key Object; EC  EC_POINT 256 bits
</span><span class='line'>  EC_POINT:   044104f8ead77d1411e016196141d9d1f747a481aec4be40d1f8822d26d407fee05902082e18843ee58db4f5575b19ff243a735b66b2c91adbec1a59aeacc7c1ae8b52
</span><span class='line'>  EC_PARAMS:  06082a8648ce3d030107
</span><span class='line'>  label:      myfirst_keypair
</span><span class='line'>  ID:         ae79417e809ed19b9a69d4c14f444462ad0bd66c
</span><span class='line'>  Usage:      none
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<h2>Copy objects to another smartcard</h2>

<h3>Backup</h3>

<p>To create a backup of our keys or data we need to extract it from the smartcard and copy it to another.
To store the object temporary we can use an encrypted filesystem or even a ram disk on a secured computer.</p>

<p>For security reasons you might want to separate your DKEK share from you key backups,
For the convenience we&rsquo;ll store everything on an encrypted USB stick.</p>

<h4>get the object reference</h4>

<p>First we need to find the object reference</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ pkcs15-tool -D
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>PKCS#15 Card [SmartCard-HSM]:
</span><span class='line'>        Version        : 0
</span><span class='line'>        Serial number  : DECM0102332
</span><span class='line'>        Manufacturer ID: www.CardContact.de
</span><span class='line'>        Flags          : 
</span><span class='line'>
</span><span class='line'>PIN [UserPIN]
</span><span class='line'>        Object Flags   : [0x3], private, modifiable
</span><span class='line'>        ID             : 01
</span><span class='line'>        Flags          : [0x81A], local, unblock-disabled, initialized, exchangeRefData
</span><span class='line'>        Length         : min_len:6, max_len:15, stored_len:0
</span><span class='line'>        Pad char       : 0x00
</span><span class='line'>        Reference      : 129 (0x81)
</span><span class='line'>        Type           : ascii-numeric
</span><span class='line'>        Tries left     : 3
</span><span class='line'>
</span><span class='line'>PIN [SOPIN]
</span><span class='line'>        Object Flags   : [0x1], private
</span><span class='line'>        ID             : 02
</span><span class='line'>        Flags          : [0x9E], local, change-disabled, unblock-disabled, initialized, soPin
</span><span class='line'>        Length         : min_len:16, max_len:16, stored_len:0
</span><span class='line'>        Pad char       : 0x00
</span><span class='line'>        Reference      : 136 (0x88)
</span><span class='line'>        Type           : bcd
</span><span class='line'>        Tries left     : 3
</span><span class='line'>
</span><span class='line'>Private EC Key [myfirst_keypair]
</span><span class='line'>        Object Flags   : [0x3], private, modifiable
</span><span class='line'>        Usage          : [0x10C], sign, signRecover, derive
</span><span class='line'>        Access Flags   : [0x1D], sensitive, alwaysSensitive, neverExtract, local
</span><span class='line'>        FieldLength    : 256
</span><span class='line'>        Key ref        : 1 (0x1)
</span><span class='line'>        Native         : yes
</span><span class='line'>        Path           : e82b0601040181c31f0201::
</span><span class='line'>        Auth ID        : 01
</span><span class='line'>        ID             : ae79417e809ed19b9a69d4c14f444462ad0bd66c
</span><span class='line'>        MD:guid        : {3a03d245-ea49-1da1-d8cd-f2ced0526400}
</span><span class='line'>          :cmap flags  : 0x0
</span><span class='line'>          :sign        : 0
</span><span class='line'>          :key-exchange: 0
</span><span class='line'>
</span><span class='line'>Public EC Key [myfirst_keypair]
</span><span class='line'>        Object Flags   : [0x0]
</span><span class='line'>        Usage          : [0x0]
</span><span class='line'>        Access Flags   : [0x2], extract
</span><span class='line'>        FieldLength    : 256
</span><span class='line'>        Key ref        : 0 (0x0)
</span><span class='line'>        Native         : no
</span><span class='line'>        ID             : ae79417e809ed19b9a69d4c14f444462ad0bd66c
</span><span class='line'>        DirectValue    : &lt;present&gt;
</span><span class='line'>
</span><span class='line'>[staf@vicky mnt]$ pkcs15-tool -D</span></code></pre></td></tr></table></div></figure>


<p></p>

<h4>extract the object(s)</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --wrap-key private_myfirst_keypair --key-reference 1 
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>Enter User PIN : 
</span><span class='line'>
</span><span class='line'>[staf@vicky mnt]$ ls -l
</span><span class='line'>total 28
</span><span class='line'>-rw-r--r-- 1 swagemakers backup    64 Nov 11 13:42 dkek-share-1.pbe
</span><span class='line'>-rw-r--r-- 1 swagemakers backup    64 Nov 11 13:42 dkek-share-2.pbe
</span><span class='line'>drwx------ 2 root        root   16384 Nov 11 13:37 lost+found
</span><span class='line'>-rw-rw-r-- 1 staf        staf     926 Nov 11 14:05 private_myfirst_keypair
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<p>Please not that we only need to copy the private key, the backup object also contains the public keypair.</p>

<h3>Initialize a second smartcard</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --initialize --dkek-shares 2
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>Enter SO-PIN (16 hexadecimal characters) : 
</span><span class='line'>
</span><span class='line'>Enter initial User-PIN (6 - 16 characters) : 
</span><span class='line'>
</span><span class='line'>[staf@vicky mnt]$ sc-hsm-tool 
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>Version              : 1.2
</span><span class='line'>User PIN tries left  : 3
</span><span class='line'>DKEK shares          : 2
</span><span class='line'>DKEK import pending, 2 share(s) still missing
</span><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --import-dkek-share dkek-share-1.pbe
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>Enter password to decrypt DKEK share : 
</span><span class='line'>
</span><span class='line'>Deciphering DKEK share, please wait...
</span><span class='line'>DKEK share imported
</span><span class='line'>DKEK shares          : 2
</span><span class='line'>DKEK import pending, 1 share(s) still missing
</span><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --import-dkek-share dkek-share-2.pbe
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>Enter password to decrypt DKEK share : 
</span><span class='line'>
</span><span class='line'>Deciphering DKEK share, please wait...
</span><span class='line'>DKEK share imported
</span><span class='line'>DKEK shares          : 2
</span><span class='line'>DKEK key check value : 2C63E9E5D6FE0B8C
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<h3>Store the key pair</h3>

<p>It&rsquo;s possible to write the private object to another smartcard with the same DKEK shares.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --unwrap-key private_myfirst_keypair --key-reference 1
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>Wrapped key contains:
</span><span class='line'>  Key blob
</span><span class='line'>  Private Key Description (PRKD)
</span><span class='line'>  Certificate
</span><span class='line'>Enter User PIN : 
</span><span class='line'>
</span><span class='line'>Key successfully imported
</span><span class='line'>[staf@vicky mnt]$ pkcs11-tool --list-objects 
</span><span class='line'>Using slot 1 with a present token (0x1)
</span><span class='line'>Public Key Object; EC  EC_POINT 256 bits
</span><span class='line'>  EC_POINT:   044104f8ead77d1411e016196141d9d1f747a481aec4be40d1f8822d26d407fee05902082e18843ee58db4f5575b19ff243a735b66b2c91adbec1a59aeacc7c1ae8b52
</span><span class='line'>  EC_PARAMS:  06082a8648ce3d030107
</span><span class='line'>  label:      myfirst_keypair
</span><span class='line'>  ID:         ae79417e809ed19b9a69d4c14f444462ad0bd66c
</span><span class='line'>  Usage:      none
</span><span class='line'>[staf@vicky mnt]$ pkcs15-tool -D
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>PKCS#15 Card [SmartCard-HSM]:
</span><span class='line'>        Version        : 0
</span><span class='line'>        Serial number  : DECM0102330
</span><span class='line'>        Manufacturer ID: www.CardContact.de
</span><span class='line'>        Flags          : 
</span><span class='line'>
</span><span class='line'>PIN [UserPIN]
</span><span class='line'>        Object Flags   : [0x3], private, modifiable
</span><span class='line'>        ID             : 01
</span><span class='line'>        Flags          : [0x81A], local, unblock-disabled, initialized, exchangeRefData
</span><span class='line'>        Length         : min_len:6, max_len:15, stored_len:0
</span><span class='line'>        Pad char       : 0x00
</span><span class='line'>        Reference      : 129 (0x81)
</span><span class='line'>        Type           : ascii-numeric
</span><span class='line'>        Tries left     : 3
</span><span class='line'>
</span><span class='line'>PIN [SOPIN]
</span><span class='line'>        Object Flags   : [0x1], private
</span><span class='line'>        ID             : 02
</span><span class='line'>        Flags          : [0x9E], local, change-disabled, unblock-disabled, initialized, soPin
</span><span class='line'>        Length         : min_len:16, max_len:16, stored_len:0
</span><span class='line'>        Pad char       : 0x00
</span><span class='line'>        Reference      : 136 (0x88)
</span><span class='line'>        Type           : bcd
</span><span class='line'>        Tries left     : 3
</span><span class='line'>
</span><span class='line'>Private EC Key [myfirst_keypair]
</span><span class='line'>        Object Flags   : [0x3], private, modifiable
</span><span class='line'>        Usage          : [0x10C], sign, signRecover, derive
</span><span class='line'>        Access Flags   : [0x1D], sensitive, alwaysSensitive, neverExtract, local
</span><span class='line'>        FieldLength    : 256
</span><span class='line'>        Key ref        : 1 (0x1)
</span><span class='line'>        Native         : yes
</span><span class='line'>        Path           : e82b0601040181c31f0201::
</span><span class='line'>        Auth ID        : 01
</span><span class='line'>        ID             : ae79417e809ed19b9a69d4c14f444462ad0bd66c
</span><span class='line'>        MD:guid        : {8e96ad75-4f6c-eb5e-6bb3-4a637bbcda50}
</span><span class='line'>          :cmap flags  : 0x0
</span><span class='line'>          :sign        : 0
</span><span class='line'>          :key-exchange: 0
</span><span class='line'>
</span><span class='line'>Public EC Key [myfirst_keypair]
</span><span class='line'>        Object Flags   : [0x0]
</span><span class='line'>        Usage          : [0x0]
</span><span class='line'>        Access Flags   : [0x2], extract
</span><span class='line'>        FieldLength    : 256
</span><span class='line'>        Key ref        : 0 (0x0)
</span><span class='line'>        Native         : no
</span><span class='line'>        ID             : ae79417e809ed19b9a69d4c14f444462ad0bd66c
</span><span class='line'>        DirectValue    : &lt;present&gt;
</span><span class='line'>
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<h3>Done&hellip;</h3>

<p>We have a backup to our second smartcard and an ecrypted backup of the key on the usb, umount the backup and store it to a safe location.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ mount | grep mnt
</span><span class='line'>/dev/mapper/my on /mnt type ext4 (rw,relatime,data=ordered)
</span><span class='line'>[staf@vicky ~]$ umount /mnt
</span><span class='line'>umount: /mnt: umount failed: Operation not permitted
</span><span class='line'>[staf@vicky ~]$ sudo umount /mnt
</span><span class='line'>[sudo] password for staf: 
</span><span class='line'>[staf@vicky ~]$ sudo cryptsetup luksClose my
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<p><strong><em> I might publish some smartcard-hsm usage examples in the further&hellip;. </em></strong></p>

<h3>Links</h3>

<p><a href="https://github.com/OpenSC/OpenSC/wiki/SmartCardHSM">https://github.com/OpenSC/OpenSC/wiki/SmartCardHSM</a></p>
</div>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog_actrikel -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4659298941528586"
     data-ad-slot="7394058542"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">staf wagemakers</span></span>

      




<time class='entry-date' datetime='2015-11-21T10:32:06+01:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2015</span></span> <span class='time'>10:32 am</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/blog/categories/hsm/'>hsm</a>, <a class='category' href='/blog/blog/categories/security/'>security</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="https://stafwag.github.io/blog/blog/2015/11/21/starting-to-protect-my-private-keys-with-smartcard-hsm/" data-via="" data-counturl="https://stafwag.github.io/blog/blog/2015/11/21/starting-to-protect-my-private-keys-with-smartcard-hsm/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
  <span style="overflow: hidden; text-overflow: ellipsis;white-space: nowrap;">
    <script src="//platform.linkedin.com/in.js" type="text/javascript">
    lang: en_US
  </script>
  <script type="IN/Share" data-url="https://stafwag.github.io/blog/blog/2015/11/21/starting-to-protect-my-private-keys-with-smartcard-hsm/" data-counter="right"></script>
  </snap>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/blog/2015/10/17/lookat-1-dot-4-4rc2-released/" title="Previous Post: Lookat 1.4.4rc2 Released">&laquo; Lookat 1.4.4rc2 Released</a>
      
      
        <a class="basic-alignment right" href="/blog/blog/2015/12/05/protecting-your-ssh-keys-with-smartcard-hsm/" title="Next Post: Protecting your SSH keys with SmartCard-HSM">Protecting your SSH keys with SmartCard-HSM &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>


</div>

<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <p><a href="http://www.wagemakers.be">http://www.wagemakers.be</a></p>
  <p><a href="http://www.linkedin.com/in/stafwagemakers">LinkedIn profile</a></p>
  <p><a href="https://google.com/+StafWagemakers">Google Plus profile</a></p>
<!-- Place this tag where you want the widget to render. -->
<div class="g-person" data-width="180" data-href="http://google.com/+StafWagemakers" data-showtagline="false" data-showcoverphoto="false" data-rel="author"></div>

<!-- Place this tag after the last widget tag. -->
<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
</section>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/blog/2019/02/10/how-to-install-libreboot-on-a-thinkspad-w500/">How to Install Libreboot on a ThinkPad W500</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2019/01/21/settinp-up-openstack-ansible-all-in-one-on-a-centos-7-system/">Setting Up OpenStack-Ansible All-In-One on a Centos 7 System</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2019/01/02/best-wishes-2019/">Best Wishes 2019</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2018/12/09/configure-dns-tls-on-opnsense/">How to Configure DNS-over-TLS on OPNsense</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2018/10/07/dns-privacy-with-stubby-part-2-freebsd/">DNS Privacy With Stubby (Part 2 FreeBSD)</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/stafwag">@stafwag</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'stafwag',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/blog/javascripts/github.js" type="text/javascript"> </script>
</section>





<hr />
<br />
<br />
<br />
<br />
<script type="text/javascript"><!--
google_ad_client = "ca-pub-4659298941528586";
/* blogads_right */
google_ad_slot = "8839948148";
google_ad_width = 160;
google_ad_height = 600;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2019 - staf wagemakers -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'stafwag';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'https://stafwag.github.io/blog/blog/2015/11/21/starting-to-protect-my-private-keys-with-smartcard-hsm/';
        var disqus_url = 'https://stafwag.github.io/blog/blog/2015/11/21/starting-to-protect-my-private-keys-with-smartcard-hsm/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
