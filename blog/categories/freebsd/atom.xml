<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Freebsd, | stafwag Blog]]></title>
  <link href="https://stafwag.github.io/blog/blog/categories/freebsd/atom.xml" rel="self"/>
  <link href="https://stafwag.github.io/blog/"/>
  <updated>2018-10-07T11:39:22+02:00</updated>
  <id>https://stafwag.github.io/blog/</id>
  <author>
    <name><![CDATA[staf wagemakers]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Bacula on FreeBSD (Part 1 PostgresSQL in a Jail)]]></title>
    <link href="https://stafwag.github.io/blog/blog/2017/08/06/bacula-on-freebsd:w_part1/"/>
    <updated>2017-08-06T08:43:28+02:00</updated>
    <id>https://stafwag.github.io/blog/blog/2017/08/06/bacula-on-freebsd:w_part1</id>
    <content type="html"><![CDATA[<p>I do take backups; my current solution are couple of shell script wrapper around dump/zfs send/btrfs send/rsync which is a mess.
So decided give <a href="http://www.bacula.org/">bacula</a> a try</p>

<p>I use <a href="http://erdgeist.org/arts/software/ezjail/">ezjail</a> to manage my <a href="https://en.wikipedia.org/wiki/FreeBSD_jail">FreeBSD jails</a>. <a href="https://www.postgresql.org/">PostgresSQL</a> is my favorite database and will use this database as the backend for bacula  and will use this database as the backend for bacula. I want to move all my databases to 1 FreeBSD jail this should make the easier to create reliable database backup in the further. For this reason we&rsquo;ll setup 2 FreeBSD jails 1 for the database and 1 for bacula.</p>

<p>You&rsquo;ll find my journey of installing PostgreSQL on a FreeBSD jail. In another blog post we will continue with the installation of baccula.</p>

<h2>PostgreSQL</h2>

<h3>Jail</h3>

<h4>Create the PostgreSQL Jail</h4>

<pre><code>root@rataplan:~ # ezjail-admin create stafdb "em0|192.168.1.51"
Warning: Some services already seem to be listening on all IP, (including 192.168.1.51)
  This may cause some confusion, here they are:
root     ntpd       754   20 udp6   *:123                 *:*
root     ntpd       754   21 udp4   *:123                 *:*
root     rpc.statd  717   4  udp6   *:640                 *:*
root     rpc.statd  717   5  tcp6   *:640                 *:*
root     rpc.statd  717   6  udp4   *:640                 *:*
root     rpc.statd  717   7  tcp4   *:640                 *:*
root     nfsd       713   5  tcp4   *:2049                *:*
root     nfsd       713   6  tcp6   *:2049                *:*
root     mountd     707   5  udp6   *:753                 *:*
root     mountd     707   6  tcp6   *:753                 *:*
root     mountd     707   7  udp4   *:753                 *:*
root     mountd     707   8  tcp4   *:753                 *:*
root     rpcbind    676   6  udp6   *:111                 *:*
root     rpcbind    676   7  udp6   *:847                 *:*
root     rpcbind    676   8  tcp6   *:111                 *:*
root     rpcbind    676   9  udp4   *:111                 *:*
root     rpcbind    676   10 udp4   *:766                 *:*
root     rpcbind    676   11 tcp4   *:111                 *:*
root     syslogd    657   6  udp6   *:514                 *:*
root     syslogd    657   7  udp4   *:514                 *:*
root@rataplan:~ # 
</code></pre>

<h4>PostgreSQL requires shared memory</h4>

<p>PostgreSQL uses shared memory it&rsquo;s required to set &ldquo;allow.sysvipc=1&rdquo; for the jail. I don&rsquo;t want to enable this globaly since this might be a security risk. Shared memory has permissions set based on the uid enabling sysvipc on a jail might cause the jail to read shared memory from the host system or another jail.</p>

<p>To enable &ldquo;allow.sysvipc=1&rdquo; a jail we can update the ezjail configuration. Ezjail keep the jail configuration in /usr/local/etc/ezjail</p>

<pre><code>root@rataplan:~ # cd /usr/local/etc/ezjail
root@rataplan:/usr/local/etc/ezjail # ls
stafansible     staffs          stafproxy       staftestbuild
stafdb          stafmail        stafpuppet
root@rataplan:/usr/local/etc/ezjail # 
</code></pre>

<p>Open the database jail file and update the configuration.</p>

<pre><code>root@rataplan:/usr/local/etc/ezjail # vi stafdb
</code></pre>

<pre><code>#
# Required to run PostgeSQL in the jail
#

export jail_stafdb_parameters="allow.sysvipc=1"
</code></pre>

<h4>Start the database jail</h4>

<pre><code>root@rataplan:~ # ezjail-admin start stafdb
Starting jails: stafdb.
/etc/rc.d/jail: WARNING: Per-jail configuration via jail_* variables  is obsolete.  Please consider migrating to /etc/jail.conf.
root@rataplan:~ #
</code></pre>

<h4>Console access</h4>

<pre><code>root@rataplan:~ # ezjail-admin console stafdb
FreeBSD 11.0-RELEASE-p9 (GENERIC) #0: Tue Apr 11 08:48:40 UTC 2017

Welcome to FreeBSD!

Release Notes, Errata: https://www.FreeBSD.org/releases/
Security Advisories:   https://www.FreeBSD.org/security/
FreeBSD Handbook:      https://www.FreeBSD.org/handbook/
FreeBSD FAQ:           https://www.FreeBSD.org/faq/
Questions List: https://lists.FreeBSD.org/mailman/listinfo/freebsd-questions/
FreeBSD Forums:        https://forums.FreeBSD.org/

Documents installed with the system are in the /usr/local/share/doc/freebsd/
directory, or can be installed later with:  pkg install en-freebsd-doc
For other languages, replace "en" with a language code like de or fr.

Show the version of FreeBSD installed:  freebsd-version ; uname -a
Please include that output and any error messages when posting questions.
Introduction to manual pages:  man man
FreeBSD directory layout:      man hier

Edit /etc/motd to change this login announcement.
root@stafdb:~ # 
root@stafdb:~ # 
</code></pre>

<h3>ProgreSQL installation</h3>

<h4>Install pkg</h4>

<p>Set up dns</p>

<pre><code>root@stafdb:~ # vi /etc/resolv.conf
</code></pre>

<pre><code>nameserver 192.168.1.1
</code></pre>

<p>Bootstrap pkg</p>

<pre><code>root@stafdb:~ # pkg
The package management tool is not yet installed on your system.
Do you want to fetch and install it now? [y/N]: y
Bootstrapping pkg from pkg+http://pkg.FreeBSD.org/FreeBSD:11:amd64/quarterly, please wait...
Verifying signature with trusted certificate pkg.freebsd.org.2013102301... done
[stafdb] Installing pkg-1.10.1...
[stafdb] Extracting pkg-1.10.1: 100%
pkg: not enough arguments
Usage: pkg [-v] [-d] [-l] [-N] [-j &lt;jail name or id&gt;|-c &lt;chroot path&gt;|-r &lt;rootdir&gt;] [-C &lt;configuration file&gt;] [-R &lt;repo config dir&gt;] [-o var=value] [-4|-6] &lt;command&gt; [&lt;args&gt;]

For more information on available commands and options see 'pkg help'.
root@stafdb:~ # 
</code></pre>

<h4>Install PostgreSQL</h4>

<p>Search for the latest PostgreSQL server version.</p>

<pre><code>root@stafdb:~ # pkg search postgresql | grep server
pgtcl-postgresql92-2.0.0_1     TCL extension for accessing a PostgreSQL server (PGTCL-NG)
pgtcl-postgresql93-2.0.0_1     TCL extension for accessing a PostgreSQL server (PGTCL-NG)
pgtcl-postgresql94-2.0.0_1     TCL extension for accessing a PostgreSQL server (PGTCL-NG)
pgtcl-postgresql95-2.0.0_1     TCL extension for accessing a PostgreSQL server (PGTCL-NG)
pgtcl-postgresql96-2.0.0_1     TCL extension for accessing a PostgreSQL server (PGTCL-NG)
postgresql92-server-9.2.21_1   PostgreSQL is the most advanced open-source database available anywhere
postgresql93-server-9.3.17_1   PostgreSQL is the most advanced open-source database available anywhere
postgresql94-server-9.4.12_1   PostgreSQL is the most advanced open-source database available anywhere
postgresql95-server-9.5.7_1    PostgreSQL is the most advanced open-source database available anywhere
postgresql96-server-9.6.3_1    PostgreSQL is the most advanced open-source database available anywhere
root@stafdb:~ # 
</code></pre>

<p>Install the PostgreSQL package.</p>

<pre><code>root@stafdb:~ # pkg install postgresql96-server
Updating FreeBSD repository catalogue...
FreeBSD repository is up to date.
All repositories are up to date.
The following 8 package(s) will be affected (of 0 checked):

New packages to be INSTALLED:
        postgresql96-server: 9.6.3_1
        libxml2: 2.9.4
        icu: 58.2_2,1
        gettext-runtime: 0.19.8.1_1
        indexinfo: 0.2.6
        postgresql96-client: 9.6.3_2
        perl5: 5.24.1_1
        readline: 7.0.3

Number of packages to be installed: 8

The process will require 131 MiB more space.
30 MiB to be downloaded.

Proceed with this action? [y/N]: y
[stafdb] [1/8] Fetching postgresql96-server-9.6.3_1.txz: 100%    4 MiB 357.1kB/s    00:11    
[stafdb] [2/8] Fetching libxml2-2.9.4.txz: 100%  802 KiB 410.4kB/s    00:02    
[stafdb] [3/8] Fetching icu-58.2_2,1.txz: 100%    9 MiB 313.3kB/s    00:30    
[stafdb] [4/8] Fetching gettext-runtime-0.19.8.1_1.txz: 100%  147 KiB 151.0kB/s    00:01    
[stafdb] [5/8] Fetching indexinfo-0.2.6.txz: 100%    5 KiB   5.3kB/s    00:01    
[stafdb] [6/8] Fetching postgresql96-client-9.6.3_2.txz: 100%    2 MiB 300.0kB/s    00:08    
[stafdb] [7/8] Fetching perl5-5.24.1_1.txz: 100%   13 MiB 341.5kB/s    00:41    
[stafdb] [8/8] Fetching readline-7.0.3.txz: 100%  334 KiB 342.3kB/s    00:01    
Checking integrity... done (0 conflicting)
[stafdb] [1/8] Installing indexinfo-0.2.6...
[stafdb] [1/8] Extracting indexinfo-0.2.6: 100%
[stafdb] [2/8] Installing gettext-runtime-0.19.8.1_1...
[stafdb] [2/8] Extracting gettext-runtime-0.19.8.1_1: 100%
[stafdb] [3/8] Installing perl5-5.24.1_1...
[stafdb] [3/8] Extracting perl5-5.24.1_1: 100%
[stafdb] [4/8] Installing readline-7.0.3...
[stafdb] [4/8] Extracting readline-7.0.3: 100%
[stafdb] [5/8] Installing libxml2-2.9.4...
[stafdb] [5/8] Extracting libxml2-2.9.4: 100%
[stafdb] [6/8] Installing icu-58.2_2,1...
[stafdb] [6/8] Extracting icu-58.2_2,1: 100%
[stafdb] [7/8] Installing postgresql96-client-9.6.3_2...
[stafdb] [7/8] Extracting postgresql96-client-9.6.3_2: 100%
[stafdb] [8/8] Installing postgresql96-server-9.6.3_1...
===&gt; Creating groups.
Creating group 'postgres' with gid '770'.
===&gt; Creating users
Creating user 'postgres' with uid '770'.

  =========== BACKUP YOUR DATA! =============
  As always, backup your data before
  upgrading. If the upgrade leads to a higher
  minor revision (e.g. 8.3.x -&gt; 8.4), a dump
  and restore of all databases is
  required. This is *NOT* done by the port!
  ===========================================
[stafdb] Extracting postgresql96-server-9.6.3_1: 100%
Message from perl5-5.24.1_1:
The /usr/bin/perl symlink has been removed starting with Perl 5.20.
For shebangs, you should either use:

#!/usr/local/bin/perl

or

#!/usr/bin/env perl

The first one will only work if you have a /usr/local/bin/perl,
the second will work as long as perl is in PATH.
Message from postgresql96-client-9.6.3_2:
The PostgreSQL port has a collection of "side orders":

postgresql-docs
  For all of the html documentation

p5-Pg
  A perl5 API for client access to PostgreSQL databases.

postgresql-tcltk 
  If you want tcl/tk client support.

postgresql-jdbc
  For Java JDBC support.

postgresql-odbc
  For client access from unix applications using ODBC as access
  method. Not needed to access unix PostgreSQL servers from Win32
  using ODBC. See below.

ruby-postgres, py-PyGreSQL
  For client access to PostgreSQL databases using the ruby &amp; python
  languages.

postgresql-plperl, postgresql-pltcl &amp; postgresql-plruby
  For using perl5, tcl &amp; ruby as procedural languages.

postgresql-contrib
  Lots of contributed utilities, postgresql functions and
  datatypes. There you find pg_standby, pgcrypto and many other cool
  things.

etc...
Message from postgresql96-server-9.6.3_1:
For procedural languages and postgresql functions, please note that
you might have to update them when updating the server.

If you have many tables and many clients running, consider raising
kern.maxfiles using sysctl(8), or reconfigure your kernel
appropriately.

The port is set up to use autovacuum for new databases, but you might
also want to vacuum and perhaps backup your database regularly. There
is a periodic script, /usr/local/etc/periodic/daily/502.pgsql, that
you may find useful. You can use it to backup and perform vacuum on all
databases nightly. Per default, it performs `vacuum analyze'. See the
script for instructions. For autovacuum settings, please review
~pgsql/data/postgresql.conf.

If you plan to access your PostgreSQL server using ODBC, please
consider running the SQL script /usr/local/share/postgresql/odbc.sql
to get the functions required for ODBC compliance.

Please note that if you use the rc script,
/usr/local/etc/rc.d/postgresql, to initialize the database, unicode
(UTF-8) will be used to store character data by default.  Set
postgresql_initdb_flags or use login.conf settings described below to
alter this behaviour. See the start rc script for more info.

To set limits, environment stuff like locale and collation and other
things, you can set up a class in /etc/login.conf before initializing
the database. Add something similar to this to /etc/login.conf:
---
postgres:\
        :lang=en_US.UTF-8:\
        :setenv=LC_COLLATE=C:\
        :tc=default:
---
and run `cap_mkdb /etc/login.conf'.
Then add 'postgresql_class="postgres"' to /etc/rc.conf.

======================================================================

To initialize the database, run

  /usr/local/etc/rc.d/postgresql initdb

You can then start PostgreSQL by running:

  /usr/local/etc/rc.d/postgresql start

For postmaster settings, see ~pgsql/data/postgresql.conf

NB. FreeBSD's PostgreSQL port logs to syslog by default
    See ~pgsql/data/postgresql.conf for more info

======================================================================

To run PostgreSQL at startup, add
'postgresql_enable="YES"' to /etc/rc.conf
</code></pre>

<p>Enable the postgresql daemon at the jail startup</p>

<pre><code>root@stafdb:~ # sysrc postgresql_enable="YES"
postgresql_enable:  -&gt; YES
root@stafdb:~ # grep postgresql_enable /etc/rc.conf
postgresql_enable="YES"
root@stafdb:~ # 
</code></pre>

<p>Initialize the database</p>

<pre><code>root@stafdb:~ # service postgresql initdb
The files belonging to this database system will be owned by user "postgres".
This user must also own the server process.

The database cluster will be initialized with locale "C".
The default text search configuration will be set to "english".

Data page checksums are disabled.

creating directory /var/db/postgres/data96 ... ok
creating subdirectories ... ok
selecting default max_connections ... 100
selecting default shared_buffers ... 128MB
selecting dynamic shared memory implementation ... posix
creating configuration files ... ok
running bootstrap script ... ok
performing post-bootstrap initialization ... ok
syncing data to disk ... ok

WARNING: enabling "trust" authentication for local connections
You can change this by editing pg_hba.conf or using the option -A, or
--auth-local and --auth-host, the next time you run initdb.

Success. You can now start the database server using:

    /usr/local/bin/pg_ctl -D /var/db/postgres/data96 -l logfile start

root@stafdb:~ # 
</code></pre>

<p>Start the database</p>

<pre><code>Droot@stafdb:~ # service postgresql start
LOG:  could not create IPv6 socket: Protocol not supported
LOG:  ending log output to stderr
HINT:  Future log output will go to log destination "syslog".
root@stafdb:~ # 
</code></pre>

<p>Verify the database</p>

<pre><code>root@stafdb:~ # su - postgres                                                                                                   
$ psql -l                                                                                                                       
psql: could not connect to server: No such file or directory                                                                    
        Is the server running locally and accepting                                                                             
        connections on Unix domain socket "/tmp/.s.PGSQL.5432"?                                                                 
$ ^Droot@stafdb:~ # service postgresql start
LOG:  could not create IPv6 socket: Protocol not supported                                                                      
LOG:  ending log output to stderr                                                                                               
HINT:  Future log output will go to log destination "syslog".                                                                   
root@stafdb:~ # su - postgres
$ psql -l
                             List of databases
   Name    |  Owner   | Encoding | Collate | Ctype |   Access privileges   
-----------+----------+----------+---------+-------+-----------------------
 postgres  | postgres | UTF8     | C       | C     | 
 template0 | postgres | UTF8     | C       | C     | =c/postgres          +
           |          |          |         |       | postgres=CTc/postgres
 template1 | postgres | UTF8     | C       | C     | =c/postgres          +
           |          |          |         |       | postgres=CTc/postgres
(3 rows)

$ 
</code></pre>

<p style="font-style: italic;">
Have fun!
</p>


<h1>Links</h1>

<ul>
<li><a href="https://dan.langille.org/2015/01/10/bacula-on-freebsd-with-zfs/">https://dan.langille.org/2015/01/10/bacula-on-freebsd-with-zfs/</a></li>
<li><a href="https://cwharton.com/blog/2016/10/postgresql-and-freebsd-quick-start/">https://cwharton.com/blog/2016/10/postgresql-and-freebsd-quick-start/</a></li>
<li><a href="https://dan.langille.org/2013/07/09/fatal-could-not-create-shared-memory-segment-function-not-implemented/">https://dan.langille.org/2013/07/09/fatal-could-not-create-shared-memory-segment-function-not-implemented/</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Migrating From Qjail to Ezjail]]></title>
    <link href="https://stafwag.github.io/blog/blog/2013/04/10/migrating-from-qjail-to-ezjail/"/>
    <updated>2013-04-10T12:36:00+02:00</updated>
    <id>https://stafwag.github.io/blog/blog/2013/04/10/migrating-from-qjail-to-ezjail</id>
    <content type="html"><![CDATA[<p>I was using <a href="http://qjail.sourceforge.net/">qjail</a> on <a href="http://stafwag.github.io/blog/blog/2012/12/16/running-freebsd-9.0-on-asus-c60m1-i-motherboard/">my freebsd system</a> but I&rsquo;m migrating to <a href="http://erdgeist.org/arts/software/ezjail/">ezjail</a>.</p>

<p>The reason for this is that the <a href="http://www.freshports.org/sysutils/qjail">port</a> is marked as RESTRICTED.
Since it seems to be a fork from <a href="http://erdgeist.org/arts/software/ezjail/">ezjail</a> without respecting the copyright and license <a href="https://lists.freebsd.org/pipermail/freebsd-jail/2013-March/002149.html"><a href="https://lists.freebsd.org/pipermail/freebsd-jail/2013-March/002149.html">https://lists.freebsd.org/pipermail/freebsd-jail/2013-March/002149.html</a></a>.</p>

<h3>Backup</h3>

<h4>Move the existing jails to old_jails</h4>

<p>Move the existing jails zfs filesystem aside just in case we need to migrate back</p>

<pre><code>root@rataplan:/usr/ports/sysutils/ezjail # zfs set mountpoint=/usr/old_jails zroot/usr/jails
root@rataplan:/usr/ports/sysutils/ezjail # zfs set mountpoint=/usr/old_jails/staffs zroot/usr/jails/staffs
root@rataplan:/usr/ports/sysutils/ezjail # zfs set mountpoint=/usr/old_jails/stafmail zroot/usr/jails/stafmail
root@rataplan:/usr/ports/sysutils/ezjail # zfs set mountpoint=/usr/old_jails/stafdb zroot/usr/jails/stafdb
root@rataplan:/usr/ports/sysutils/ezjail # zfs rename zroot/usr/jails zroot/usr/old_jails
</code></pre>

<h4>Stop the running jails</h4>

<p>Stop the jails that are still running.</p>

<pre><code>root@rataplan:/usr/local/etc # qjail stop
Jail stopped successfully. stafmail
Jail stopped successfully. staffs
Jail already stopped.      stafdb
</code></pre>

<h3><em>ezjail</em> setup</h3>

<h4>Installing ezjail</h4>

<p>The installation of <em>ezjail</em> is pretty straightforward&hellip;</p>

<pre><code>root@rataplan:/root # cd /usr/ports/sysutils/ezjail/
root@rataplan:/usr/ports/sysutils/ezjail # make install clean
===&gt;  Installing for ezjail-3.2.3
===&gt;   Generating temporary packing list
===&gt;  Checking if sysutils/ezjail already installed
mkdir -p /usr/local/etc/ezjail/ /usr/local/man/man1/ /usr/local/man/man5/ /usr/local/man/man7 /usr/local/man/man8 /usr/local/etc/rc.d/ /usr/local/bin/ /usr/local/share/examples/ezjail /usr/local/share/zsh/site-functions
cp -p ezjail.conf.sample /usr/local/etc/
cp -R -p examples/example /usr/local/share/examples/ezjail/
cp -R -p examples/nullmailer-example /usr/local/share/examples/ezjail/
cp -R -p share/zsh/site-functions/ /usr/local/share/zsh/site-functions/
sed s:EZJAIL_PREFIX:/usr/local: ezjail.sh &gt; /usr/local/etc/rc.d/ezjail
sed s:EZJAIL_PREFIX:/usr/local: ezjail-admin &gt; /usr/local/bin/ezjail-admin
sed s:EZJAIL_PREFIX:/usr/local: man8/ezjail-admin.8 &gt; /usr/local/man/man8/ezjail-admin.8
sed s:EZJAIL_PREFIX:/usr/local: man5/ezjail.conf.5 &gt; /usr/local/man/man5/ezjail.conf.5
sed s:EZJAIL_PREFIX:/usr/local: man7/ezjail.7 &gt; /usr/local/man/man7/ezjail.7
chmod 755 /usr/local/etc/rc.d/ezjail /usr/local/bin/ezjail-admin
chown -R root:wheel /usr/local/man/man8/ezjail-admin.8 /usr/local/man/man5/ezjail.conf.5 /usr/local/man/man7/ezjail.7 /usr/local/share/examples/ezjail/
chmod 0440 /usr/local/share/examples/ezjail/example/usr/local/etc/sudoers
[ -f /usr/local/etc/ezjail.conf ] ||  /bin/cp -p /usr/local/etc/ezjail.conf.sample  /usr/local/etc/ezjail.conf
===&gt;   Compressing manual pages for ezjail-3.2.3
===&gt;   Registering installation for ezjail-3.2.3
===&gt;  Cleaning for ezjail-3.2.3
root@rataplan:/usr/ports/sysutils/ezjail # 
</code></pre>

<h4>Create /usr/jails</h4>

<pre><code>root@rataplan:/root # zfs create zroot/usr/jails
root@rataplan:/root # 
</code></pre>

<h4>Copy the sample config</h4>

<pre><code>root@rataplan:/root # cd /usr/local/etc/
root@rataplan:/usr/local/etc # cp ezjail.conf.sample ezjail.conf
</code></pre>

<h4>Update ezjail.conf to use zfs</h4>

<p>This will create a zfs filesystem for each jail automatically. Cool ;-)</p>

<pre><code># Setting this to YES will start to manage the basejail and newjail in ZFS
ezjail_use_zfs="YES"
# Setting this to YES will manage ALL new jails in their own zfs
ezjail_use_zfs_for_jails="YES"
# The name of the ZFS ezjail should create jails on, it will be mounted at the ezjail_jaildir
ezjail_jailzfs="zroot/usr/jails"
</code></pre>

<h4>Installing the base jail without a make world</h4>

<p>Most ezjail howto&rsquo;s that I found assume that you already ran a &ldquo;make world&rdquo;. I want to setup the base jail without a &ldquo;make world&rdquo; because this takes too much time on my system.
Lucky you can install the basejail without a &ldquo;make world&rdquo;.</p>

<pre><code>root@rataplan:/usr/local/etc # ezjail-admin install
Trying 193.162.146.4:21 ...
Connected to ftp.freebsd.org.
220 beastie.tdk.net FTP server (Version 6.00LS) ready.
331 Guest login ok, send your email address as password.
230 Guest login ok, access restrictions apply.
Remote system type is UNIX.
Using binary mode to transfer files.
200 Type set to I.
250 CWD command successful.
local: base.txz remote: base.txz
229 Entering Extended Passive Mode (|||65080|)
150 Opening BINARY mode data connection for 'base.txz' (59854248 bytes).
100% |***********************************************************************************************************************************| 58451 KiB  451.20 KiB/s    00:00 ETA
226 Transfer complete.
59854248 bytes received in 02:09 (451.20 KiB/s)
221 Goodbye.
Trying 193.162.146.4:21 ...
Connected to ftp.freebsd.org.
220 beastie.tdk.net FTP server (Version 6.00LS) ready.
331 Guest login ok, send your email address as password.
230 Guest login ok, access restrictions apply.
Remote system type is UNIX.
Using binary mode to transfer files.
200 Type set to I.
250 CWD command successful.
local: lib32.txz remote: lib32.txz
229 Entering Extended Passive Mode (|||55936|)
150 Opening BINARY mode data connection for 'lib32.txz' (9743636 bytes).
 37% |************************************************                                                                                   |  3576 KiB  447.04 KiB/s    00:13 ETA
</code></pre>

<p>&lt;snip&gt;
<code>
/usr/jails/basejail/usr/lib32/libbsnmp.so.6
/usr/jails/basejail/usr/lib32/libcam.a
/usr/jails/basejail/usr/lib32/libsupc++.a
/usr/jails/basejail/usr/lib32/libarchive.a
/usr/jails/basejail/usr/lib32/libpcap.so.8
/usr/jails/basejail/usr/lib32/libbsdxml.so.4
108748 blocks
Note: a non-standard /etc/make.conf was copied to the template jail in order to get the ports collection running inside jails.
root@rataplan:/usr/local/etc #
</code>
<code>
root@rataplan:/usr/local/etc # cd /usr/jails/
root@rataplan:/usr/jails # ls
basejail    flavours    newjail
root@rataplan:/usr/jails #
</code></p>

<h4>Add the jails ip addresses to the system.</h4>

<p>This is different from qjail, by ezjail it&rsquo;s required to setup the ip addresses for each jail.</p>

<p>Open /etc/rc.conf and create interface aliases for each jail.</p>

<pre><code>ifconfig_re0="inet 192.168.1.40/24"
ifconfig_re0_alias0="inet 192.168.1.41/32"
ifconfig_re0_alias1="inet 192.168.1.42/32"
ifconfig_re0_alias2="inet 192.168.1.43/32"
ifconfig_re0_alias3="inet 192.168.1.44/32"
</code></pre>

<p>And create them by running netif restart</p>

<pre><code>root@rataplan:/etc/rc.d # ./netif restart
Stopping Network: lo0 re0.
lo0: flags=8048&lt;LOOPBACK,RUNNING,MULTICAST&gt; metric 0 mtu 16384
    options=600003&lt;RXCSUM,TXCSUM,RXCSUM_IPV6,TXCSUM_IPV6&gt;
    nd6 options=21&lt;PERFORMNUD,AUTO_LINKLOCAL&gt;
re0: flags=8802&lt;BROADCAST,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
    options=8209b&lt;RXCSUM,TXCSUM,VLAN_MTU,VLAN_HWTAGGING,VLAN_HWCSUM,WOL_MAGIC,LINKSTATE&gt;
    ether 30:85:a9:40:58:ba
    inet6 fe80::3285:a9ff:fe40:58ba%re0 prefixlen 64 scopeid 0x6 
    nd6 options=29&lt;PERFORMNUD,IFDISABLED,AUTO_LINKLOCAL&gt;
    media: Ethernet autoselect (1000baseT &lt;full-duplex&gt;)
    status: active
Starting Network: lo0 re0.
lo0: flags=8049&lt;UP,LOOPBACK,RUNNING,MULTICAST&gt; metric 0 mtu 16384
    options=600003&lt;RXCSUM,TXCSUM,RXCSUM_IPV6,TXCSUM_IPV6&gt;
    inet6 ::1 prefixlen 128 
    inet6 fe80::1%lo0 prefixlen 64 scopeid 0x9 
    inet 127.0.0.1 netmask 0xff000000 
    nd6 options=21&lt;PERFORMNUD,AUTO_LINKLOCAL&gt;
re0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
    options=8209b&lt;RXCSUM,TXCSUM,VLAN_MTU,VLAN_HWTAGGING,VLAN_HWCSUM,WOL_MAGIC,LINKSTATE&gt;
    ether 30:85:a9:40:58:ba
    inet6 fe80::3285:a9ff:fe40:58ba%re0 prefixlen 64 scopeid 0x6 
    inet 192.168.1.40 netmask 0xffffff00 broadcast 192.168.1.255
    inet 192.168.1.41 netmask 0xffffffff broadcast 192.168.1.41
    inet 192.168.1.42 netmask 0xffffffff broadcast 192.168.1.42
    inet 192.168.1.43 netmask 0xffffffff broadcast 192.168.1.43
    inet 192.168.1.44 netmask 0xffffffff broadcast 192.168.1.44
    nd6 options=29&lt;PERFORMNUD,IFDISABLED,AUTO_LINKLOCAL&gt;
    media: Ethernet autoselect (none)
    status: no carrier
root@rataplan:/etc/rc.d # 
</code></pre>

<h4>Creating the first jail</h4>

<pre><code>root@rataplan:/etc/rc.d # ezjail-admin create stafpuppet 192.168.1.44
Warning: Some services already seem to be listening on IP 192.168.1.44
  This may cause some confusion, here they are:
root     ntpd       29764 31 udp4   192.168.1.44:123      *:*
Warning: Some services already seem to be listening on all IP, (including 192.168.1.44)
  This may cause some confusion, here they are:
root     ntpd       29764 20 udp4   *:123                 *:*
root     ntpd       29764 21 udp6   *:123                 *:*
root     rpc.statd  1161  4  udp6   *:1021                *:*
root     rpc.statd  1161  5  tcp6   *:1021                *:*
root     rpc.statd  1161  6  udp4   *:1021                *:*
root     rpc.statd  1161  7  tcp4   *:1021                *:*
root     nfsd       1157  5  tcp4   *:2049                *:*
root     nfsd       1157  6  tcp6   *:2049                *:*
root     mountd     1151  6  udp6   *:942                 *:*
root     mountd     1151  7  tcp6   *:942                 *:*
root     mountd     1151  8  udp4   *:942                 *:*
root     mountd     1151  9  tcp4   *:942                 *:*
root     rpcbind    1120  6  udp6   *:111                 *:*
root     rpcbind    1120  7  udp6   *:960                 *:*
root     rpcbind    1120  8  tcp6   *:111                 *:*
root     rpcbind    1120  9  udp4   *:111                 *:*
root     rpcbind    1120  10 udp4   *:777                 *:*
root     rpcbind    1120  11 tcp4   *:111                 *:*
root     syslogd    1099  6  udp6   *:514                 *:*
root     syslogd    1099  7  udp4   *:514                 *:*
root@rataplan:/etc/rc.d # 
</code></pre>

<h4>Starting the jail</h4>

<pre><code>root@rataplan:/etc/rc.d # /usr/local/etc/rc.d/ezjail 
Usage: /usr/local/etc/rc.d/ezjail [fast|force|one|quiet](start|stop|restart|rcvar|startcrypto|stopcrypto)
root@rataplan:/etc/rc.d # /usr/local/etc/rc.d/ezjail start
 ezjailConfiguring jails:.
Starting jails: stafpuppet.
</code></pre>

<h4>Listing the jail</h4>

<pre><code>root@rataplan:/etc/rc.d # jls
   JID  IP Address      Hostname                      Path
     3  192.168.1.44    stafpuppet                    /usr/jails/stafpuppet
root@rataplan:/etc/rc.d # ping 192.168.1.44
PING 192.168.1.44 (192.168.1.44): 56 data bytes
64 bytes from 192.168.1.44: icmp_seq=0 ttl=64 time=0.053 ms
^C
--- 192.168.1.44 ping statistics ---
1 packets transmitted, 1 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 0.053/0.053/0.053/0.000 ms
root@rataplan:/etc/rc.d # 
</code></pre>

<h4>Console access</h4>

<pre><code>root@rataplan:/etc/rc.d # jexec 3 csh
root@stafpuppet:/ # 
</code></pre>

<h4>Install the freebsd ports into the base jail</h4>

<pre><code>[root@rataplan ~]# ezjail-admin update -P   
Looking up portsnap.FreeBSD.org mirrors... 6 mirrors found.
Fetching snapshot tag from ec2-eu-west-1.portsnap.freebsd.org... done.
Fetching snapshot metadata... done.
Updating from Wed Apr 10 14:55:36 CEST 2013 to Thu Apr 11 14:00:20 CEST 2013.
Fetching 3 metadata patches.. done.
Applying metadata patches... done.
Fetching 0 metadata files... done.
Fetching 17 patches.....10... done.
Applying patches... done.
Fetching 0 new ports or files... done.
/usr/jails/basejail/usr/ports/CHANGES
/usr/jails/basejail/usr/ports/COPYRIGHT
/usr/jails/basejail/usr/ports/GIDs
/usr/jails/basejail/usr/ports/KNOBS
/usr/jails/basejail/usr/ports/Keywords/info.yaml
/usr/jails/basejail/usr/ports/LEGAL
/usr/jails/basejail/usr/ports/MOVED
/usr/jails/basejail/usr/ports/Makefile
/usr/jails/basejail/usr/ports/Mk/Uses/
/usr/jails/basejail/usr/ports/Mk/bsd.apache.mk
/usr/jails/basejail/usr/ports/Mk/bsd.autotools.mk
</code></pre>

<p>&lt;snip&gt;
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/usr/jails/basejail/usr/ports/x11/xzoom/
</span><span class='line'>/usr/jails/basejail/usr/ports/x11/yad/
</span><span class='line'>/usr/jails/basejail/usr/ports/x11/yakuake-kde4/
</span><span class='line'>/usr/jails/basejail/usr/ports/x11/yakuake/
</span><span class='line'>/usr/jails/basejail/usr/ports/x11/yalias/
</span><span class='line'>/usr/jails/basejail/usr/ports/x11/yeahconsole/
</span><span class='line'>/usr/jails/basejail/usr/ports/x11/yelp/
</span><span class='line'>/usr/jails/basejail/usr/ports/x11/zenity/
</span><span class='line'>Building new INDEX files&hellip; done.
</span><span class='line'>[root@rataplan ~]#&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;
</span><span class='line'>Verify
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;[root@rataplan ~]# jls
</span><span class='line'>   JID  IP Address      Hostname                      Path
</span><span class='line'>     3  192.168.1.44    stafpuppet                    /usr/jails/stafpuppet
</span><span class='line'>[root@rataplan ~]# jexec 3 csh
</span><span class='line'>root@stafpuppet:/ # cd /usr/ports/
</span><span class='line'>root@stafpuppet:/usr/ports # ls
</span><span class='line'>.portsnap.INDEX KNOBS       Templates   astro       converters  finance     hungarian   math        news        science     www     x11-themes
</span><span class='line'>CHANGES     Keywords    Tools       audio       databases   french      irc     misc        palm        security    x11     x11-toolkits
</span><span class='line'>COPYRIGHT   LEGAL       UIDs        benchmarks  deskutils   ftp     japanese    multimedia  polish      shells      x11-clocks  x11-wm
</span><span class='line'>GIDs        MOVED       UPDATING    biology     devel       games       java        net     ports-mgmt  sysutils    x11-drivers
</span><span class='line'>INDEX-7     Makefile    accessibility   cad     dns     german      korean      net-im      portuguese  textproc    x11-fm
</span><span class='line'>INDEX-8     Mk      arabic      chinese     editors     graphics    lang        net-mgmt    print       ukrainian   x11-fonts
</span><span class='line'>INDEX-9     README      archivers   comms       emulators   hebrew      mail        net-p2p     russian     vietnamese  x11-servers
</span><span class='line'>root@stafpuppet:/usr/ports #&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;
</span><span class='line'>#### Update the base jail
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;[root@rataplan /usr]# ezjail-admin update -u
</span><span class='line'>Looking up update.FreeBSD.org mirrors&hellip; 3 mirrors found.
</span><span class='line'>Fetching metadata signature for 9.1-RELEASE from update4.freebsd.org&hellip; done.
</span><span class='line'>Fetching metadata index&hellip; done.
</span><span class='line'>Inspecting system&hellip;</span></code></pre></td></tr></table></div></figure></p>

<h4>update /etc/rc.conf</h4>

<pre><code>#
# ezjails
#

ezjail_enable="YES"
</code></pre>

<h3>Migrate the jails to <em>ezjail</em></h3>

<h4>Recreate the jail</h4>

<pre><code>[root@rataplan /etc]# ezjail-admin create staffs 192.168.1.41
Warning: Some services already seem to be listening on IP 192.168.1.41
  This may cause some confusion, here they are:
root     ntpd       29764 24 udp4   192.168.1.41:123      *:*
Warning: Some services already seem to be listening on all IP, (including 192.168.1.41)
  This may cause some confusion, here they are:
root     ntpd       29764 20 udp4   *:123                 *:*
root     ntpd       29764 21 udp6   *:123                 *:*
root     rpc.statd  1161  4  udp6   *:1021                *:*
root     rpc.statd  1161  5  tcp6   *:1021                *:*
root     rpc.statd  1161  6  udp4   *:1021                *:*
root     rpc.statd  1161  7  tcp4   *:1021                *:*
root     nfsd       1157  5  tcp4   *:2049                *:*
root     nfsd       1157  6  tcp6   *:2049                *:*
root     mountd     1151  6  udp6   *:942                 *:*
root     mountd     1151  7  tcp6   *:942                 *:*
root     mountd     1151  8  udp4   *:942                 *:*
root     mountd     1151  9  tcp4   *:942                 *:*
root     rpcbind    1120  6  udp6   *:111                 *:*
root     rpcbind    1120  7  udp6   *:960                 *:*
root     rpcbind    1120  8  tcp6   *:111                 *:*
root     rpcbind    1120  9  udp4   *:111                 *:*
root     rpcbind    1120  10 udp4   *:777                 *:*
root     rpcbind    1120  11 tcp4   *:111                 *:*
root     syslogd    1099  6  udp6   *:514                 *:*
root     syslogd    1099  7  udp4   *:514                 *:*
[root@rataplan /etc]# 
</code></pre>

<h4>Clone the zfs filesystem</h4>

<pre><code>[root@rataplan /etc]# zfs destroy zroot/usr/jails/staffs
[root@rataplan /etc]# zfs snapshot zroot/usr/old_jails/staffs@org
[root@rataplan /etc]# zfs clone zroot/usr/old_jails/staffs@org zroot/usr/jails/staffs
</code></pre>

<h4>Start the jail</h4>

<pre><code>[root@rataplan /etc]# /usr/local/etc/rc.d/ezjail start staffs
Configuring jails:.
Starting jails: staffs.
[root@rataplan /etc]# 
</code></pre>
]]></content>
  </entry>
  
</feed>
