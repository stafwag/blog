<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Btrfs | stafwag Blog]]></title>
  <link href="https://stafwag.github.io/blog/blog/categories/btrfs/atom.xml" rel="self"/>
  <link href="https://stafwag.github.io/blog/"/>
  <updated>2018-12-09T09:25:33+01:00</updated>
  <id>https://stafwag.github.io/blog/</id>
  <author>
    <name><![CDATA[staf wagemakers]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Install Parabola GNU/Linux on an Encrypted Btrfs Logical Volume]]></title>
    <link href="https://stafwag.github.io/blog/blog/2017/05/25/install-parabola-gnu-slash-linux-on-an-encrypted-btrfs-logical-volume/"/>
    <updated>2017-05-25T09:05:38+02:00</updated>
    <id>https://stafwag.github.io/blog/blog/2017/05/25/install-parabola-gnu-slash-linux-on-an-encrypted-btrfs-logical-volume</id>
    <content type="html"><![CDATA[<p><img class="left" src="/images/413px-Gnu10-mascot-logo_100ppi.png" width="200" height="291" title="&ldquo;413px-Gnu10-mascot-logo_100ppi.png&rdquo;" ></p>

<p>I finally found time to complete the installation of my <a href="http://stafwag.github.io/blog/blog/2017/02/11/how-to-install-libreboot-on-a-thinkpad-x60/">Libreboot laptop</a></p>

<p>I decided to give <a href="https://www.parabola.nu/">Parabola GNU/Linux</a> a try as my daily driver to get a fully <a href="https://en.wikipedia.org/wiki/Free_software">Free Software</a> Laptop/tablet.</p>

<h2>Download the Parabola GNU/Linux iso and boot it</h2>

<p>After Parabola GNU/Linux is booted verify that you have internet access if the network card is support and dhcp is enabled on you network you should get a network address.</p>

<h2>Network access</h2>

<p>To setup the system remotely we first need to setup network to our system.</p>

<h3>Verify the interface</h3>

<pre><code>1 root@parabolaiso ~ # ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: enp1s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 00:16:d3:b7:3a:96 brd ff:ff:ff:ff:ff:ff
    inet 192.168.1.11/24 brd 192.168.1.255 scope global enp1s0
       valid_lft forever preferred_lft forever
    inet6 fe80::e5db:c85f:4478:1f44/64 scope link 
       valid_lft forever preferred_lft forever
3: wlp2s0: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000
    link/ether 00:1b:77:4d:5a:57 brd ff:ff:ff:ff:ff:ff
root@parabolaiso ~ # 
</code></pre>

<h3>Verify internet access</h3>

<pre><code>root@parabolaiso ~ # ping -c 3 www.google.be
PING www.google.be (172.217.17.67) 56(84) bytes of data.
64 bytes from ams16s30-in-f3.1e100.net (172.217.17.67): icmp_seq=1 ttl=56 time=91.3 ms
64 bytes from ams16s30-in-f3.1e100.net (172.217.17.67): icmp_seq=2 ttl=56 time=48.7 ms
64 bytes from ams16s30-in-f3.1e100.net (172.217.17.67): icmp_seq=3 ttl=56 time=47.9 ms

--- www.google.be ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2003ms
rtt min/avg/max/mdev = 47.998/62.714/91.366/20.264 ms
root@parabolaiso ~ # 
</code></pre>

<h2>ssh access</h2>

<p>If you want to install Parabola GNU/Linux over ssh you need to assign a root passwd and start the sshd service.</p>

<h3>root password</h3>

<pre><code>root@parabolaiso ~ # passwd root
New password: 
Retype new password: 
passwd: password updated successfully
root@parabolaiso ~ # 
</code></pre>

<h3>create a user account</h3>

<p>Parabola doesn&rsquo;t allow remote ssh root logons. Create a new account to access the system remotely.</p>

<pre><code>root@parabolaiso ~ # useradd install
root@parabolaiso ~ # passwd install
New password: 
Retype new password: 
passwd: password updated successfully
root@parabolaiso ~ # 
</code></pre>

<h3>start sshd</h3>

<pre><code>root@parabolaiso ~ # systemctl start sshd
root@parabolaiso ~ # 
</code></pre>

<h3>Logon remotely</h3>

<pre><code>[staf@vicky ~]$ ssh install@petronella 
install@petronella's password: 

===============================================================================

         Parabola live media 2016.11.03                                

    To install Parabola, the system must be connected to the internet.    
    For instructions, enter this command:                                 
      lynx network.html                                           

    Press the number keys while holding Alt to switch virtual terminals.  
    This allows entering commands without closing lynx.                   

===============================================================================

Could not chdir to home directory /home/install: No such file or directory
[install@parabolaiso /]$ su -
Password: 
root@parabolaiso ~ # 
</code></pre>

<h2>Partition your harddisk</h2>

<h3>Find your harddisk device name</h3>

<pre><code>root@parabolaiso ~ # lsblk -o NAME,VENDOR,MODEL,TYPE,SIZE 
NAME                  VENDOR   MODEL            TYPE   SIZE
loop1                                           loop   1.9G
`-parabola_root-image                           dm     1.9G
sdb                   ATA      OCZ-VERTEX2      disk 107.1G
`-sdb1                                          part 107.1G
loop2                                           loop   1.9G
`-parabola_root-image                           dm     1.9G
loop0                                           loop 269.7M
sda                   Kingston DataTraveler 2.0 disk   7.2G
|-sda2                                          part    31M
`-sda1                                          part   613M
root@parabolaiso ~ # 
</code></pre>

<h3>Overwrite it with random data</h3>

<p>Because we are creating an ecrypted filesystem it&rsquo;s a good idea to overwrite it with random data.</p>

<p>We&rsquo;ll use badblocks for this another method is to use &ldquo;dd if=/dev/random of=/dev/xxx&rdquo; the &ldquo;dd&rdquo; method is probably the best method but is a lot slower.</p>

<pre><code>root@parabolaiso ~ # badblocks -c 10240 -s -w -t random -v /dev/sdb


Checking for bad blocks in read-write mode
From block 0 to 112337063
Testing with random pattern: done                                                 
Reading and comparing: done                                                 
Pass completed, 0 bad blocks found. (0/0/0 errors)
badblocks -c 10240 -s -w -t random -v /dev/sdb  82.82s user 20.08s system 3% cpu 48:12.29 total
root@parabolaiso ~ # 
</code></pre>

<h3>Partition the harddisk</h3>

<p>We&rsquo;ll use lvm is this setup, while it should be possible to  boot from an encrypted partition with Libreboot partition I create a small unencrypted boot partition.</p>

<pre><code>root@parabolaiso ~ # fdisk /dev/sdb

Welcome to fdisk (util-linux 2.28.2).
Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.

Device does not contain a recognized partition table.
Created a new DOS disklabel with disk identifier 0x2640923c.

Command (m for help): p
Disk /dev/sdb: 107.1 GiB, 115033153536 bytes, 224674128 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0x2640923c

Command (m for help): n
Partition type
   p   primary (0 primary, 0 extended, 4 free)
   e   extended (container for logical partitions)
Select (default p): p
Partition number (1-4, default 1): 
First sector (2048-224674127, default 2048): 
Last sector, +sectors or +size{K,M,G,T,P} (2048-224674127, default 224674127): +1G

Created a new partition 1 of type 'Linux' and of size 1 GiB.

Command (m for help): n
Partition type
   p   primary (1 primary, 0 extended, 3 free)
   e   extended (container for logical partitions)
Select (default p): p
Partition number (2-4, default 2): 
First sector (2099200-224674127, default 2099200): 
Last sector, +sectors or +size{K,M,G,T,P} (2099200-224674127, default 224674127): 

Created a new partition 2 of type 'Linux' and of size 106.1 GiB.

Command (m for help): p
Disk /dev/sdb: 107.1 GiB, 115033153536 bytes, 224674128 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0x2640923c

Device     Boot   Start       End   Sectors   Size Id Type
/dev/sdb1          2048   2099199   2097152     1G 83 Linux
/dev/sdb2       2099200 224674127 222574928 106.1G 83 Linux

Command (m for help): w
The partition table has been altered.
Calling ioctl() to re-read partition table.
Syncing disks.

root@parabolaiso ~ # 
</code></pre>

<h3>Encrypt the LVM physical volume</h3>

<h4>Benchmark</h4>

<p>We bechmark the encryption to decide which encryption we&rsquo;ll use.</p>

<pre><code>root@parabolaiso ~ # cryptsetup benchmark
# Tests are approximate using memory only (no storage IO).
PBKDF2-sha1       382134 iterations per second for 256-bit key
PBKDF2-sha256     479239 iterations per second for 256-bit key
PBKDF2-sha512     347671 iterations per second for 256-bit key
PBKDF2-ripemd160  319687 iterations per second for 256-bit key
PBKDF2-whirlpool  221032 iterations per second for 256-bit key
#  Algorithm | Key |  Encryption |  Decryption
     aes-cbc   128b    79.1 MiB/s    93.9 MiB/s
 serpent-cbc   128b    30.0 MiB/s   112.0 MiB/s
 twofish-cbc   128b    77.5 MiB/s   102.5 MiB/s
     aes-cbc   256b    62.7 MiB/s    71.0 MiB/s
 serpent-cbc   256b    30.0 MiB/s   111.9 MiB/s
 twofish-cbc   256b    77.5 MiB/s   102.4 MiB/s
     aes-xts   256b    93.0 MiB/s    93.3 MiB/s
 serpent-xts   256b   100.3 MiB/s   104.5 MiB/s
 twofish-xts   256b    93.8 MiB/s    95.0 MiB/s
     aes-xts   512b    70.5 MiB/s    70.7 MiB/s
 serpent-xts   512b   100.3 MiB/s   104.4 MiB/s
 twofish-xts   512b    93.9 MiB/s    94.9 MiB/s
cryptsetup benchmark  3.91s user 24.02s system 99% cpu 28.093 total
root@parabolaiso ~ # 
</code></pre>

<h4>Create Luks volume</h4>

<p>The serpent xts with a 512 bits keys seems to give a pretty good performance while sha256 hashing gives the best performance.</p>

<pre><code>root@parabolaiso ~ # cryptsetup luksFormat --cipher serpent-xts-plain64 --key-size 512 --hash sha256 --use-random /dev/sdb2 

WARNING!
========
This will overwrite data on /dev/sdb2 irrevocably.

Are you sure? (Type uppercase yes): YES
Enter passphrase: 
Verify passphrase: 
root@parabolaiso ~ # 
</code></pre>

<h2>LVM setup</h2>

<h3>Create the volumes</h3>

<h4>Open the LUKS volume</h4>

<pre><code>root@parabolaiso ~ #  cryptsetup luksOpen /dev/sdb2 pv
Enter passphrase for /dev/sdb2: 
root@parabolaiso ~ # 
</code></pre>

<p>This create /dev/mapper/pv</p>

<h4>Create the physical volume</h4>

<pre><code>root@parabolaiso ~ # pvcreate /dev/mapper/pv                 
  Physical volume "/dev/mapper/pv" successfully created.
root@parabolaiso ~ # 
</code></pre>

<p>Show the pv</p>

<pre><code>root@parabolaiso ~ # pvs
  PV             VG Fmt  Attr PSize   PFree  
  /dev/mapper/pv    lvm2 ---  106.13g 106.13g
root@parabolaiso ~ # 
</code></pre>

<h4>Create the volume group</h4>

<pre><code>root@parabolaiso ~ # vgcreate vg /dev/mapper/pv
  Volume group "vg" successfully created
root@parabolaiso ~ # 
</code></pre>

<p>Show the created volume group</p>

<pre><code>root@parabolaiso ~ # vgs
  VG #PV #LV #SN Attr   VSize   VFree  
  vg   1   0   0 wz--n- 106.13g 106.13g
root@parabolaiso ~ # 
</code></pre>

<h4>Create the swap logical volume</h4>

<pre><code>root@parabolaiso ~ # lvcreate -L 4G vg -n lv_swap 
  Logical volume "lv_swap" created.
root@parabolaiso ~ # 
</code></pre>

<h4>Create the root logical volume</h4>

<pre><code>root@parabolaiso ~ # lvcreate -L 20G vg -n lv_root   
  Logical volume "lv_root" created.
root@parabolaiso ~ # 
</code></pre>

<h4>Display the create logical volumes</h4>

<pre><code>root@parabolaiso ~ # lvs
  LV      VG Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  lv_root vg -wi-a----- 20.00g                                                    
  lv_swap vg -wi-a-----  4.00g                                                    
root@parabolaiso ~ # 
</code></pre>

<h3>Format the logical volumes</h3>

<h4>Create the swapspace</h4>

<pre><code>root@parabolaiso ~ # mkswap /dev/mapper/vg-lv_swap       
Setting up swapspace version 1, size = 4 GiB (4294963200 bytes)
no label, UUID=32f6e5d4-67a3-42e3-8a90-6ee3ae0fdaa3
root@parabolaiso ~ # 
</code></pre>

<p>And activate it;</p>

<pre><code>root@parabolaiso ~ # swapon /dev/mapper/vg-lv_swap       
root@parabolaiso ~ # 
</code></pre>

<h4>Create the root filesystem</h4>

<pre><code>root@parabolaiso ~ # mkfs.btrfs /dev/mapper/vg-lv_root       
btrfs-progs v4.8.2
See http://btrfs.wiki.kernel.org for more information.

Detected a SSD, turning off metadata duplication.  Mkfs with -m dup if you want to force metadata duplication.
Label:              (null)
UUID:               
Node size:          16384
Sector size:        4096
Filesystem size:    20.00GiB
Block group profiles:
  Data:             single            8.00MiB
  Metadata:         single            8.00MiB
  System:           single            4.00MiB
SSD detected:       yes
Incompat features:  extref, skinny-metadata
Number of devices:  1
Devices:
   ID        SIZE  PATH
    1    20.00GiB  /dev/mapper/vg-lv_root

root@parabolaiso ~ # 
</code></pre>

<h4>Create the boot filesystem</h4>

<pre><code>root@parabolaiso ~ # mkfs.ext2 /dev/sdb1 
mke2fs 1.43.3 (04-Sep-2016)
Discarding device blocks: done                            
Creating filesystem with 262144 4k blocks and 65536 inodes
Filesystem UUID: e3fd741d-d0e0-483f-a9cd-3fbd3f9d66d1
Superblock backups stored on blocks: 
        32768, 98304, 163840, 229376

Allocating group tables: done                            
Writing inode tables: done                            
Writing superblocks and filesystem accounting information: done

root@parabolaiso ~ # 
</code></pre>

<h4>Mount the filesystems</h4>

<p>Mount the root filesystem;</p>

<pre><code>root@parabolaiso ~ # 
root@parabolaiso ~ # mount -o noatime,compress=lzo,discard,ssd,defaults /dev/mapper/vg-lv_root /mnt
root@parabolaiso ~ # 
</code></pre>

<p>Create the /home and /boot directories</p>

<pre><code>root@parabolaiso ~ # mkdir -p /mnt/{boot,home}
</code></pre>

<p>Mount the boot filesystem</p>

<pre><code>root@parabolaiso ~ # mount /dev/sdb1 /mnt/boot
root@parabolaiso ~ # 
</code></pre>

<p>Show;</p>

<pre><code>root@parabolaiso ~ # df -h
Filesystem                       Size  Used Avail Use% Mounted on
dev                              1.6G     0  1.6G   0% /dev
run                              1.6G   26M  1.6G   2% /run
/dev/sda1                        613M  613M     0 100% /run/parabolaiso/bootmnt
cowspace                         2.4G  8.9M  2.4G   1% /run/parabolaiso/cowspace
/dev/loop0                       270M  270M     0 100% /run/parabolaiso/sfs/root-image
/dev/mapper/parabola_root-image  1.9G  885M 1003M  47% /
tmpfs                            1.6G     0  1.6G   0% /dev/shm
tmpfs                            1.6G     0  1.6G   0% /sys/fs/cgroup
tmpfs                            1.6G     0  1.6G   0% /tmp
tmpfs                            1.6G  1.6M  1.6G   1% /etc/pacman.d/gnupg
tmpfs                            320M     0  320M   0% /run/user/0
tmpfs                            320M     0  320M   0% /run/user/1001
/dev/mapper/vg-lv_root            20G   17M   20G   1% /mnt
/dev/sdb1                       1008M  1.3M  956M   1% /mnt/boot
root@parabolaiso ~ # 
</code></pre>

<h2>System installation</h2>

<h3>boostrap the system</h3>

<pre><code>root@parabolaiso ~ # pacstrap /mnt base base-devel btrfs-progs
==&gt; Creating install root at /mnt
==&gt; Installing packages to /mnt
:: Synchronizing package databases...
 libre                                              437.7 KiB   228K/s 00:02 [############################################] 100%
 core                                               111.1 KiB   280K/s 00:00 [############################################] 100%
 extra                                             1535.4 KiB   544K/s 00:03 [############################################] 100%
 community                                            3.6 MiB   615K/s 00:06 [############################################] 100%
 pcr                                                620.0 KiB   662K/s 00:01 [############################################] 100%
:: There are 52 members in group base:
:: Repository libre
   1) filesystem  2) licenses  3) linux-libre  4) pacman  5) pacman-mirrorlist  6) systemd-sysvcompat  7) your-freedom
:: Repository core
   8) bash  9) bzip2  10) coreutils  11) cryptsetup  12) device-mapper  13) dhcpcd  14) diffutils  15) e2fsprogs  16) file
   17) findutils  18) gawk  19) gcc-libs  20) gettext  21) glibc  22) grep  23) gzip  24) inetutils  25) iproute2  26) iputils
   27) jfsutils  28) less  29) logrotate  30) lvm2  31) man-db  32) man-pages  33) mdadm  34) nano  35) netctl  36) pciutils
   37) pcmciautils  38) perl  39) procps-ng  40) psmisc  41) reiserfsprogs  42) s-nail  43) sed  44) shadow  45) sysfsutils
   46) tar  47) texinfo  48) usbutils  49) util-linux  50) vi  51) which  52) xfsprogs

Enter a selection (default=all): 
</code></pre>

<p>&lt; snip &gt;</p>

<pre><code>(2/7) Updating udev hardware database...
(3/7) Updating system user accounts...
(4/7) Creating temporary files...
(5/7) Arming ConditionNeedsUpdate...
(6/7) Updating the info directory file...
(7/7) Rebuilding certificate stores...
pacstrap /mnt base base-devel btrfs-progs  62.07s user 14.31s system 1% cpu 1:13:22.44 total
root@parabolaiso ~ # 
</code></pre>

<h3>Generate /etc/fstab</h3>

<pre><code>root@parabolaiso ~ #
root@parabolaiso ~ # genfstab -U -p /mnt  &gt;&gt; /mnt/etc/fstab
root@parabolaiso ~ # 
</code></pre>

<p>review</p>

<pre><code>root@parabolaiso ~ # cat /mnt/etc/fstab
# 
# /etc/fstab: static file system information
#
# &lt;file system&gt; &lt;dir&gt;   &lt;type&gt;  &lt;options&gt;       &lt;dump&gt;  &lt;pass&gt;
# UUID=3731a69b-7240-4618-8e5e-4684d7e719e3
# /dev/mapper/vg-lv_root
UUID=3731a69b-7240-4618-8e5e-4684d7e719e3       /               btrfs           rw,relatime,ssd,space_cache,subvolid=5,subvol=/0 0

# /dev/sdb1
UUID=e3fd741d-d0e0-483f-a9cd-3fbd3f9d66d1       /boot           ext2            rw,relatime,block_validity,barrier,user_xattr,acl       0 2

# /dev/mapper/vg-lv_swap
UUID=32f6e5d4-67a3-42e3-8a90-6ee3ae0fdaa3       none            swap            defaults        0 0

root@parabolaiso ~ # 
</code></pre>

<h3>chroot</h3>

<pre><code>root@parabolaiso ~ # arch-chroot /mnt
[root@parabolaiso /]# 
</code></pre>

<h3>Set the timezone</h3>

<p>Set the link for the correct timezone</p>

<pre><code>[root@parabolaiso /]# ln -sf /usr/share/zoneinfo/Europe/Brussels /etc/localtime
[root@parabolaiso /]# 
</code></pre>

<p>Set the hardwareclock to UTC</p>

<pre><code>[root@parabolaiso /]# hwclock --systohc --utc
[root@parabolaiso /]# 
</code></pre>

<h3>Generate the required locales</h3>

<pre><code>[root@parabolaiso /]# vi /etc/locale.gen 
[root@parabolaiso /]# local 
local       locale      locale-gen  localectl   localedef   
[root@parabolaiso /]# locale-gen
Generating locales...
  en_IE.UTF-8... done
  en_IE.ISO-8859-1... done
  en_IE.ISO-8859-15@euro... done
  en_US.UTF-8... done
  en_US.ISO-8859-1... done
  nl_BE.UTF-8... done
  nl_BE.ISO-8859-1... done
  nl_BE.ISO-8859-15@euro... done
Generation complete.
[root@parabolaiso /]# 
</code></pre>

<h3>Hostname</h3>

<pre><code>[root@parabolaiso /]# vi /etc/hostname
[root@parabolaiso /]# 
</code></pre>

<h3>mkinitcpio</h3>

<h4>HOOKS</h4>

<p>Add &ldquo;encrypt lvm2&rdquo; to HOOKS before filesystems in /etc/mkinitcpio.conf</p>

<pre><code>[root@parabolaiso /]# vi /etc/mkinitcpio.conf
</code></pre>

<pre><code>HOOKS="base udev autodetect modconf block encrypt lvm2 filesystems keyboard fsck"
</code></pre>

<h4>Create boot image</h4>

<pre><code>[root@parabolaiso /]#  mkinitcpio -p linux-libre
==&gt; Building image from preset: /etc/mkinitcpio.d/linux-libre.preset: 'default'
  -&gt; -k /boot/vmlinuz-linux-libre -c /etc/mkinitcpio.conf -g /boot/initramfs-linux-libre.img
==&gt; Starting build: 4.10.6-gnu-1
  -&gt; Running build hook: [base]
  -&gt; Running build hook: [udev]
  -&gt; Running build hook: [autodetect]
  -&gt; Running build hook: [modconf]
  -&gt; Running build hook: [block]
  -&gt; Running build hook: [sd-encrypt]
/usr/lib/initcpio/install/sd-encrypt: line 21: add_systemd_unit: command not found
/usr/lib/initcpio/install/sd-encrypt: line 25: add_systemd_unit: command not found
/usr/lib/initcpio/install/sd-encrypt: line 26: add_systemd_unit: command not found
  -&gt; Running build hook: [lvm2]
  -&gt; Running build hook: [filesystems]
  -&gt; Running build hook: [keyboard]
  -&gt; Running build hook: [fsck]
==&gt; Generating module dependencies
==&gt; Creating gzip-compressed initcpio image: /boot/initramfs-linux-libre.img
==&gt; Image generation successful
==&gt; Building image from preset: /etc/mkinitcpio.d/linux-libre.preset: 'fallback'
  -&gt; -k /boot/vmlinuz-linux-libre -c /etc/mkinitcpio.conf -g /boot/initramfs-linux-libre-fallback.img -S autodetect
==&gt; Starting build: 4.10.6-gnu-1
  -&gt; Running build hook: [base]
  -&gt; Running build hook: [udev]
  -&gt; Running build hook: [modconf]
  -&gt; Running build hook: [block]
==&gt; WARNING: Possibly missing firmware for module: isci
  -&gt; Running build hook: [sd-encrypt]
/usr/lib/initcpio/install/sd-encrypt: line 21: add_systemd_unit: command not found
/usr/lib/initcpio/install/sd-encrypt: line 25: add_systemd_unit: command not found
/usr/lib/initcpio/install/sd-encrypt: line 26: add_systemd_unit: command not found
  -&gt; Running build hook: [lvm2]
  -&gt; Running build hook: [filesystems]
  -&gt; Running build hook: [keyboard]
  -&gt; Running build hook: [fsck]
==&gt; Generating module dependencies
==&gt; Creating gzip-compressed initcpio image: /boot/initramfs-linux-libre-fallback.img
==&gt; Image generation successful
[root@parabolaiso /]# 
</code></pre>

<h3>set the root password</h3>

<pre><code>[root@parabolaiso /]# passwd root
New password: 
Retype new password: 
passwd: password updated successfully
[root@parabolaiso /]# 
</code></pre>

<h3>GRUB</h3>

<h4>install Grub</h4>

<pre><code>[root@parabolaiso /]#  pacman -Sy grub
:: Synchronizing package databases...
 libre is up to date
 core is up to date
 extra is up to date
 community is up to date
 pcr is up to date
resolving dependencies...
looking for conflicting packages...

Packages (1) grub-1:2.02.rc2-1.parabola1

Total Download Size:    6.04 MiB
Total Installed Size:  35.87 MiB

:: Proceed with installation? [Y/n] 
:: Retrieving packages...
 grub-1:2.02.rc2-1.parabola1-x86_64                   6.0 MiB   128K/s 00:48 [############################################] 100%
(1/1) checking keys in keyring                                               [############################################] 100%
(1/1) checking package integrity                                             [############################################] 100%
(1/1) loading package files                                                  [############################################] 100%
(1/1) checking for file conflicts                                            [############################################] 100%
(1/1) checking available disk space                                          [############################################] 100%
:: Processing package changes...
(1/1) installing grub                                                        [############################################] 100%
Generating grub.cfg.example config file...
This may fail on some machines running a custom kernel.
done.
Optional dependencies for grub
    freetype2: For grub-mkfont usage
    fuse: For grub-mount usage
    dosfstools: For grub-mkrescue FAT FS and EFI support
    efibootmgr: For grub-install EFI support
    libisoburn: Provides xorriso for generating grub rescue iso using grub-mkrescue
    os-prober: To detect other OSes when generating grub.cfg in BIOS systems
    mtools: For grub-mkrescue FAT FS support
:: Running post-transaction hooks...
(1/2) Arming ConditionNeedsUpdate...
(2/2) Updating the info directory file...
[root@parabolaiso /]# 
</code></pre>

<h4>Install grub to your boot disk</h4>

<pre><code>[root@parabolaiso /]# grub-install --target=i386-pc /dev/sdb
Installing for i386-pc platform.
Installation finished. No error reported.
[root@parabolaiso /]# 
</code></pre>

<h4>Create grub.cfg</h4>

<p>We&rsquo;ll use the uuid for the crypted device.</p>

<h5>Get the UUID for the encrypted physical volume</h5>

<pre><code>[root@parabolaiso /]# ls -l /dev/disk/by-uuid/
total 0
lrwxrwxrwx 1 root root 10 Apr  3 10:07 2016-11-03-15-52-21-00 -&gt; ../../sda1
lrwxrwxrwx 1 root root 10 Apr  3 10:09 32f6e5d4-67a3-42e3-8a90-6ee3ae0fdaa3 -&gt; ../../dm-2
lrwxrwxrwx 1 root root 10 Apr  3 10:09 3731a69b-7240-4618-8e5e-4684d7e719e3 -&gt; ../../dm-3
lrwxrwxrwx 1 root root 10 Apr  3 10:07 BD3C-9D8E -&gt; ../../sda2
lrwxrwxrwx 1 root root 10 Apr  3 10:07 e3fd741d-d0e0-483f-a9cd-3fbd3f9d66d1 -&gt; ../../sdb1
lrwxrwxrwx 1 root root 10 Apr  3 10:09 eb600d4a-a2fd-4698-8847-14e6dc1b5e6c -&gt; ../../sdb2
lrwxrwxrwx 1 root root 10 Apr  3 10:07 f6312bc5-7593-4b6d-8427-0cf92d9de40b -&gt; ../../dm-0
[root@parabolaiso /]# 
</code></pre>

<h5>Update /etc/default/grub</h5>

<pre><code>GRUB_DEFAULT=0
GRUB_TIMEOUT=5
GRUB_DISTRIBUTOR="Parabola"
GRUB_CMDLINE_LINUX_DEFAULT="quiet"
GRUB_CMDLINE_LINUX="cryptdevice=/dev/disk/by-uuid/eb600d4a-a2fd-4698-8847-14e6dc1b5e6c:pv"
</code></pre>

<h5>Generate grub.cfg</h5>

<pre><code>[root@parabolaiso /]# grub-mkconfig -o /boot/grub/grub.cfg
Generating grub configuration file ...
  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
Found linux image: /boot/vmlinuz-linux-libre
Found initrd image: /boot/initramfs-linux-libre.img
Found fallback initramfs image: /boot/initramfs-linux-libre-fallback.img
  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
done
[root@parabolaiso /]# 
</code></pre>

<h2>Reboot</h2>

<pre><code>[root@parabolaiso /]# exit
root@parabolaiso ~ # umount /mnt/boot
root@parabolaiso ~ # umount /mnt/    
root@parabolaiso ~ # lvchange -an /dev/vg/lv_root  
root@parabolaiso ~ # swapoff /dev/vg/lv_swap
root@parabolaiso ~ # lvchange -an /dev/vg/lv_swap
root@parabolaiso ~ # cryptsetup luksClose  /dev/mapper/pv
root@parabolaiso ~ # reboot
Connection to petronella closed by remote host.
Connection to petronella closed.
[staf@vicky octopress]$ 
</code></pre>

<h2>First boot</h2>

<p>If everything goes well GNU/Linux get booted, &hellip; if not. You&rsquo;ll have some fun to resolve the boot issues :-)</p>

<p style="font-style: italic;">
Have fun!
</p>


<h1>Links</h1>

<ul>
<li><a href="https://libreboot.org/docs/gnulinux/encrypted_parabola.html">https://libreboot.org/docs/gnulinux/encrypted_parabola.html</a></li>
<li><a href="http://stafwag.github.io/blog/blog/2016/08/30/arch-on-an-encrypted-btrfs-partition/">http://stafwag.github.io/blog/blog/2016/08/30/arch-on-an-encrypted-btrfs-partition/</a></li>
<li><a href="http://www.brunoparmentier.be/blog/how-to-install-arch-linux-on-an-encrypted-btrfs-partition.html">http://www.brunoparmentier.be/blog/how-to-install-arch-linux-on-an-encrypted-btrfs-partition.html</a></li>
<li><a href="http://blog.fabio.mancinelli.me/2012/12/28/Arch_Linux_on_BTRFS.html">http://blog.fabio.mancinelli.me/2012/12/28/Arch_Linux_on_BTRFS.html</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Install Arch on an Encrypted Btrfs Partition]]></title>
    <link href="https://stafwag.github.io/blog/blog/2016/08/30/arch-on-an-encrypted-btrfs-partition/"/>
    <updated>2016-08-30T08:59:00+02:00</updated>
    <id>https://stafwag.github.io/blog/blog/2016/08/30/arch-on-an-encrypted-btrfs-partition</id>
    <content type="html"><![CDATA[<p><img class="right" src="/images/Arch-linux-logo.png" width="300" height="225" title="&ldquo;Arch Linux Logo&rdquo;" ></p>

<p>I&rsquo;m preparing to move <a href="http://stafwag.github.io/blog/blog/2013/08/25/the-benefits-of-stopping-smoking-dot-dot-dot/">my workstation</a> to <a href="https://www.archlinux.org/">arch linux</a> Before I&rsquo;ll install it on my physical workstation I did the installation on a virtual machine. I&rsquo;ll use <a href="https://btrfs.wiki.kernel.org/index.php/Main_Page">btrfs</a> as the filesystem during the installation. btrfs is a nice filesystem but it had some serious dataloss issue with <a href="https://btrfs.wiki.kernel.org/index.php/RAID56">RAID5/RAID6</a> recently.</p>

<p>btrfs might not stable enough for a production environment but it has some nice features like snapshots, send/recieve, compression etc. I use <a href="http://www.open-zfs.org/wiki/Main_Page">zfs</a> for my important date anyway.</p>

<h2>To encrypt or not to encrypt&hellip;</h2>

<p>It&rsquo;s possible to encrypt your boot partition <a href="https://www.gnu.org/software/grub/">grub</a> has support for <a href="https://en.wikipedia.org/wiki/Linux_Unified_Key_Setup">luks</a> volumes. This cause grub to ask for a password during the system startup you&rsquo;ll need to type in your password a second time during the system startup when you Linux initrd image is booted. It&rsquo;s possible to avoid this by adding a keyfile to your crypttab - which migh be considered as a security risk -.</p>

<p>In this howto we&rsquo;ll setup a single root partition to have full disk encryption. I&rsquo;m not sure I go with an encrypted boot partition during my final installation. I might just create an empty partition of 1G so I can move switch between an encrypted and an non-encrypted boot filesystem.</p>

<p><img class="left" src="/images/arch-on-an-encrypted-btrfs-partition/00_boot.png" width="440" title="&ldquo;00_boot.png&rdquo;" ></p>

<h2>Download the arch linux iso and boot it</h2>

<p>After arch linux is booted verify that you have internet access if the network card is support and dchp is enabled on you network you should get a network address.</p>

<h2>Network access</h2>

<p>To setup the system remotely we first need to setup network to our system.</p>

<h3>Verify the interface</h3>

<pre><code>root@archiso ~ # ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default 
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 52:54:00:69:d4:94 brd ff:ff:ff:ff:ff:ff
    inet 192.168.122.23/24 brd 192.168.122.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::a7b:481f:2f70:e688/64 scope link 
       valid_lft forever preferred_lft forever
root@archiso ~ # 
</code></pre>

<h3>Verify internet access</h3>

<pre><code>root@archiso ~ # ping -c 3 8.8.8.8                                                                                      :(
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=49 time=49.2 ms
64 bytes from 8.8.8.8: icmp_seq=2 ttl=49 time=45.8 ms
64 bytes from 8.8.8.8: icmp_seq=3 ttl=49 time=46.8 ms

--- 8.8.8.8 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2003ms
rtt min/avg/max/mdev = 45.896/47.329/49.201/1.406 ms
root@archiso ~ # nslookup www.google.be
Server:         192.168.122.1
Address:        192.168.122.1#53

Non-authoritative answer:
Name:   www.google.be
Address: 64.233.167.94

root@archiso ~ # ping www.google.be
PING www.google.be (64.233.167.94) 56(84) bytes of data.
64 bytes from wl-in-f94.1e100.net (64.233.167.94): icmp_seq=1 ttl=46 time=58.7 ms
64 bytes from wl-in-f94.1e100.net (64.233.167.94): icmp_seq=2 ttl=46 time=58.7 ms
64 bytes from wl-in-f94.1e100.net (64.233.167.94): icmp_seq=3 ttl=46 time=58.4 ms
^C
--- www.google.be ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2000ms
rtt min/avg/max/mdev = 58.479/58.645/58.742/0.230 ms
root@archiso ~ #                   
</code></pre>

<h2>ssh access</h2>

<p>If you want to install arch linux over ssh you need to assign a root passwd and start the sshd service.</p>

<h3>root password</h3>

<pre><code>root@archiso ~ # passwd root       
Enter new UNIX password: 
Retype new UNIX password: 
passwd: password updated successfully
root@archiso ~ # 
</code></pre>

<h3>start sshd</h3>

<pre><code>root@archiso ~ # systemctl list-unit-files -t service | grep ssh
sshd.service                               disabled
sshd@.service                              static  
sshdgenkeys.service                        static  
root@archiso ~ # systemctl start sshd                           
root@archiso ~ #
</code></pre>

<h3>Logon remotely</h3>

<pre><code>[staf@vicky ~]$ ssh -l root 192.168.122.23
root@192.168.122.23's password: 
Last login: Tue Jun 30 09:06:00 2015 from 192.168.122.1
root@archiso ~ # 
</code></pre>

<h2>Partition</h2>

<h3>Find your harddisk device name</h3>

<pre><code>root@archiso ~ # cat /proc/partitions
major minor  #blocks  name

   8        0  268435456 sda
  11        0     759808 sr0
   7        0     328616 loop0
root@archiso ~ # 
</code></pre>

<h3>Overwrite it with random data</h3>

<p>Because we are creating an ecrypted filesystem it&rsquo;s a good idea to overwrite it with random data.</p>

<p>We&rsquo;ll use badblocks for this another method is to use &ldquo;dd if=/dev/random of=/dev/xxx&rdquo; the &ldquo;dd&rdquo; method is probably the best method but is a lot slower.</p>

<pre><code>root@archiso ~ # badblocks -c 10240 -s -w -t random -v /dev/sda
Checking for bad blocks in read-write mode
From block 0 to 268435455
Testing with random pattern: done                                                 
Reading and comparing: done                                                 
Pass completed, 0 bad blocks found. (0/0/0 errors)
badblocks -c 10240 -s -w -t random -v /dev/sda  49.22s user 21.72s system 3% cpu 33:48.40 total
root@archiso ~ # 
</code></pre>

<h3>Partition the harddisk</h3>

<p>Create 3 partitions:</p>

<ul>
<li>1G /boot (we&rsquo;ll not use this during the installation - see above - )</li>
<li>32G swap</li>
<li>root btrfs partition</li>
</ul>


<pre><code>root@archiso ~ # fdisk /dev/sda                                

Welcome to fdisk (util-linux 2.28).                                                    
Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.

Device does not contain a recognized partition table.
Created a new DOS disklabel with disk identifier 0x7ff944e5.

Command (m for help): p
Disk /dev/sda: 256 GiB, 274877906944 bytes, 536870912 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0x7ff944e5

Command (m for help): n
Partition type
   p   primary (0 primary, 0 extended, 4 free)
   e   extended (container for logical partitions)
Select (default p): p
Partition number (1-4, default 1): 1
First sector (2048-536870911, default 2048): +1G
Value out of range.
First sector (2048-536870911, default 2048): 
Last sector, +sectors or +size{K,M,G,T,P} (2048-536870911, default 536870911): 
Do you really want to quit? y
1 root@archiso ~ # fdisk /dev/sda                                                   :(

Welcome to fdisk (util-linux 2.28).                                                    
Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.

Device does not contain a recognized partition table.
Created a new DOS disklabel with disk identifier 0xa806e281.

Command (m for help): p
Disk /dev/sda: 256 GiB, 274877906944 bytes, 536870912 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0xa806e281

Command (m for help): n
Partition type
   p   primary (0 primary, 0 extended, 4 free)
   e   extended (container for logical partitions)
Select (default p): p
Partition number (1-4, default 1): 1
First sector (2048-536870911, default 2048): 
Last sector, +sectors or +size{K,M,G,T,P} (2048-536870911, default 536870911): +1G

Created a new partition 1 of type 'Linux' and of size 1 GiB.

Command (m for help): n
Partition type
   p   primary (1 primary, 0 extended, 3 free)
   e   extended (container for logical partitions)
Select (default p): p
Partition number (2-4, default 2): 
First sector (2099200-536870911, default 2099200): 
Last sector, +sectors or +size{K,M,G,T,P} (2099200-536870911, default 536870911): +32G

Created a new partition 2 of type 'Linux' and of size 32 GiB.

Command (m for help): n
Partition type
   p   primary (2 primary, 0 extended, 2 free)
   e   extended (container for logical partitions)
Select (default p): p
Partition number (3,4, default 3): 
First sector (69208064-536870911, default 69208064): 
Last sector, +sectors or +size{K,M,G,T,P} (69208064-536870911, default 536870911): 

Created a new partition 3 of type 'Linux' and of size 223 GiB.

Command (m for help): w
The partition table has been altered.
Calling ioctl() to re-read partition table.
Syncing disks.

root@archiso ~ # 
</code></pre>

<h3>Format the root partition</h3>

<p>We&rsquo;ll continue with the root filesystem - we&rsquo;ll initialize the swapspace after the installation -</p>

<h4>Create the root luks volume;</h4>

<pre><code>root@archiso ~ # cryptsetup luksFormat --cipher aes-xts-plain64 --key-size 256 --hash sha256 --use-random /dev/sda3

WARNING!
========
This will overwrite data on /dev/sda3 irrevocably.

Are you sure? (Type uppercase yes): YES
Enter passphrase: 
Verify passphrase: 
5.01s user 0.04s system 21% cpu 23.750 total
root@archiso ~ # 
</code></pre>

<h4>Open the root luks volume</h4>

<pre><code>root@archiso ~ # cryptsetup luksOpen /dev/sda3 cryptroot
Enter passphrase for /dev/sda3: 
root@archiso ~ # 
</code></pre>

<h4>Format the root volume with btrfs</h4>

<pre><code>root@archiso ~ # mkfs.btrfs /dev/mapper/cryptroot
btrfs-progs v4.6.1
See http://btrfs.wiki.kernel.org for more information.

Label:              (null)
UUID:               cbfcc8d6-0cf9-4656-bcda-2525faeadfe6
Node size:          16384
Sector size:        4096
Filesystem size:    217.00GiB
Block group profiles:
  Data:             single            8.00MiB
  Metadata:         DUP               1.01GiB
  System:           DUP              12.00MiB
SSD detected:       no
Incompat features:  extref, skinny-metadata
Number of devices:  1
Devices:
   ID        SIZE  PATH
    1   217.00GiB  /dev/mapper/cryptroot

root@archiso ~ # 
</code></pre>

<h4>Mount the root filesystem</h4>

<pre><code>root@archiso ~ # mount -o noatime,compress=lzo,discard,ssd,defaults /dev/mapper/cryptroot /mnt
root@archiso ~ # 
</code></pre>

<h4>Create the subvolumes</h4>

<pre><code>root@archiso ~ # cd /mnt
root@archiso /mnt # btrfs subvolume create __active
Create subvolume './__active'
root@archiso /mnt # btrfs subvolume create __active/rootvol
Create subvolume '__active/rootvol'
root@archiso /mnt # btrfs subvolume create __active/home
Create subvolume '__active/home'
root@archiso /mnt # btrfs subvolume create __active/var
Create subvolume '__active/var'
root@archiso /mnt # btrfs subvolume create __snapshots
Create subvolume './__snapshots'
root@archiso /mnt #
</code></pre>

<h4>Mount the subvolumes</h4>

<pre><code>root@archiso /mnt # cd 
root@archiso ~ # umount /mnt
root@archiso ~ # mount -o noatime,compress=lzo,discard,ssd,defaults,subvol=__active/rootvol /dev/mapper/cryptroot /mnt
root@archiso ~ # mkdir /mnt/{home,var}
root@archiso ~ # mount -o noatime,compress=lzo,discard,ssd,defaults,subvol=__active/home /dev/mapper/cryptroot /mnt/home
root@archiso ~ # mount -o noatime,compress=lzo,discard,ssd,defaults,subvol=__active/var /dev/mapper/cryptroot /mnt/var
root@archiso ~ # sync
root@archiso ~ # 
</code></pre>

<h2>System installation</h2>

<h3>bootstrap the system</h3>

<pre><code>root@archiso ~ # pacstrap /mnt base base-devel btrfs-progs
==&gt; Creating install root at /mnt
==&gt; Installing packages to /mnt
:: Synchronizing package databases...
 core                     119.9 KiB   652K/s 00:00 [######################] 100%
 extra                   1760.1 KiB   688K/s 00:03 [######################] 100%
 community                  3.6 MiB   906K/s 00:04 [######################] 100%
:: There are 50 members in group base:
:: Repository core
   1) bash  2) bzip2  3) coreutils  4) cryptsetup  5) device-mapper  6) dhcpcd
   7) diffutils  8) e2fsprogs  9) file  10) filesystem  11) findutils  12) gawk
   13) gcc-libs  14) gettext  15) glibc  16) grep  17) gzip  18) inetutils
   19) iproute2  20) iputils  21) jfsutils  22) less  23) licenses  24) linux
   25) logrotate  26) lvm2  27) man-db  28) man-pages  29) mdadm  30) nano
   31) netctl  32) pacman  33) pciutils  34) pcmciautils  35) perl
   36) procps-ng  37) psmisc  38) reiserfsprogs  39) s-nail  40) sed
   41) shadow  42) sysfsutils  43) systemd-sysvcompat  44) tar  45) texinfo
   46) usbutils  47) util-linux  48) vi  49) which  50) xfsprogs

Enter a selection (default=all): 
:: There are 25 members in group base-devel:
:: Repository core
   1) autoconf  2) automake  3) binutils  4) bison  5) fakeroot  6) file
   7) findutils  8) flex  9) gawk  10) gcc  11) gettext  12) grep  13) groff
   14) gzip  15) libtool  16) m4  17) make  18) pacman  19) patch
   20) pkg-config  21) sed  22) sudo  23) texinfo  24) util-linux  25) which

Enter a selection (default=all): 
warning: skipping target: file
warning: skipping target: findutils
warning: skipping target: gawk
warning: skipping target: gettext
warning: skipping target: grep
warning: skipping target: gzip
warning: skipping target: pacman
warning: skipping target: sed
warning: skipping target: texinfo
warning: skipping target: util-linux
warning: skipping target: which
resolving dependencies...
looking for conflicting packages...

Packages (144) acl-2.2.52-2  archlinux-keyring-20160812-1  attr-2.4.47-1
               ca-certificates-20160507-1  ca-certificates-cacert-20140824-3
               ca-certificates-mozilla-3.26-1  ca-certificates-utils-20160507-1
               cracklib-2.9.6-1  curl-7.50.1-1  db-5.3.28-3  dbus-1.10.8-1
               expat-2.2.0-2  gc-7.4.2-4  gdbm-1.12-2  glib2-2.48.1-1
&lt;snip&gt;
               procps-ng-3.3.12-1  psmisc-22.21-3  reiserfsprogs-3.6.25-1
               s-nail-14.8.10-1  sed-4.2.2-4  shadow-4.2.1-3  sudo-1.8.17.p1-1
               sysfsutils-2.1.0-9  systemd-sysvcompat-231-1  tar-1.29-1
               texinfo-6.1-4  usbutils-008-1  util-linux-2.28.1-1
               vi-1:070224-2  which-2.21-2  xfsprogs-4.7.0-1

Total Download Size:   231.85 MiB
Total Installed Size:  801.27 MiB

:: Proceed with installation? [Y/n] 
:: Retrieving packages...
 linux-api-headers-4...   810.7 KiB   891K/s 00:01 [######################] 100%
 tzdata-2016f-1-any       215.4 KiB   909K/s 00:00 [######################] 100%
 iana-etc-20160513-1-any  352.2 KiB   723K/s 00:00 [######################] 100%
 filesystem-2015.09-...     8.8 KiB   875K/s 00:00 [######################] 100%
 glibc-2.24-2-x86_64        8.1 MiB   918K/s 00:09 [######################] 100%
 gcc-libs-6.1.1-5-x86_64   14.9 MiB   899K/s 00:17 [######################] 100%
&lt;snip&gt;
(144/144) installing btrfs-progs                   [######################] 100%
:: Running post-transaction hooks...
(1/4) Updating manpage index...
mandb: can't set the locale; make sure $LC_* and $LANG are correct
(2/4) Updating the info directory file...
(3/4) Updating udev Hardware Database...
(4/4) Rebuilding certificate stores...
pacstrap /mnt base base-devel btrfs-progs  27.81s user 10.20s system 10% cpu 5:50.56 total
root@archiso ~ # 
</code></pre>

<h3>Generate /etc/fstab</h3>

<pre><code>root@archiso ~ # genfstab -p /mnt &gt;&gt; /mnt/etc/fstab
root@archiso ~ # vi /mnt/etc/fstab
# 
# /etc/fstab: static file system information
#
# &lt;file system&gt; &lt;dir&gt;   &lt;type&gt;  &lt;options&gt;       &lt;dump&gt;  &lt;pass&gt;
# UUID=c8ca38de-4e58-4c7c-8f5b-c9c3f92f6a24
/dev/mapper/cryptroot   /               btrfs           rw,noatime,compress=lzo,ssd,dis
card,space_cache,subvolid=258,subvol=/__active/rootvol,subvol=__active/rootvol  0 0

# UUID=c8ca38de-4e58-4c7c-8f5b-c9c3f92f6a24
/dev/mapper/cryptroot   /home           btrfs           rw,noatime,compress=lzo,ssd,dis
card,space_cache,subvolid=259,subvol=/__active/home,subvol=__active/home        0 0

# UUID=c8ca38de-4e58-4c7c-8f5b-c9c3f92f6a24
/dev/mapper/cryptroot   /var            btrfs           rw,noatime,compress=lzo,ssd,dis
card,space_cache,subvolid=260,subvol=/__active/var,subvol=__active/var  0 0
</code></pre>

<h3>chroot</h3>

<pre><code>root@archiso ~ # arch-chroot /mnt
[root@archiso /]# 
</code></pre>

<h3>Set the timezone</h3>

<p>Link for timezone to /etc/localtime</p>

<pre><code>[root@archiso /]# ln -s /usr/share/zoneinfo/Europe/Brussels /etc/localtime
[root@archiso /]# 
</code></pre>

<p>Set the hardwareclock to UTC</p>

<pre><code>hwclock --systohc --utc
</code></pre>

<h3>Generate the required locales</h3>

<pre><code>[root@archiso /]# vi /etc/locale.gen 
[root@archiso /]# locale-gen
Generating locales...
  en_IE.UTF-8... done
  en_IE.ISO-8859-1... done
  en_IE.ISO-8859-15@euro... done
  en_US.UTF-8... done
  en_US.ISO-8859-1... done
  nl_BE.UTF-8... done
  nl_BE.ISO-8859-1... done
  nl_BE.ISO-8859-15@euro... done
Generation complete.
[root@archiso /]# 
</code></pre>

<h3>Hostname</h3>

<pre><code>[root@archiso /]# vi /etc/hostname
[root@archiso /]# 
</code></pre>

<pre><code>[root@archiso /]# vi /etc/hosts
</code></pre>

<h3>mkinitcpio</h3>

<h4>HOOKS</h4>

<p>Add encrypt to HOOKS before filesystems in /etc/mkinitcpio.conf</p>

<pre><code>[root@archiso /]# vi /etc/mkinitcpio.conf 
</code></pre>

<pre><code>HOOKS="base udev autodetect modconf block encrypt filesystems keyboard fsck"
</code></pre>

<h4>Create boot image</h4>

<pre><code>[root@archiso /]# mkinitcpio -p linux
==&gt; Building image from preset: /etc/mkinitcpio.d/linux.preset: 'default'
  -&gt; -k /boot/vmlinuz-linux -c /etc/mkinitcpio.conf -g /boot/initramfs-linux.img
==&gt; Starting build: 4.7.1-1-ARCH
  -&gt; Running build hook: [base]
  -&gt; Running build hook: [udev]
  -&gt; Running build hook: [autodetect]
  -&gt; Running build hook: [modconf]
  -&gt; Running build hook: [block]
  -&gt; Running build hook: [encrypt]
  -&gt; Running build hook: [filesystems]
  -&gt; Running build hook: [keyboard]
  -&gt; Running build hook: [fsck]
==&gt; Generating module dependencies
==&gt; Creating gzip-compressed initcpio image: /boot/initramfs-linux.img
==&gt; Image generation successful
==&gt; Building image from preset: /etc/mkinitcpio.d/linux.preset: 'fallback'
  -&gt; -k /boot/vmlinuz-linux -c /etc/mkinitcpio.conf -g /boot/initramfs-linux-fallback.img -S autodetect
==&gt; Starting build: 4.7.1-1-ARCH
  -&gt; Running build hook: [base]
  -&gt; Running build hook: [udev]
  -&gt; Running build hook: [modconf]
  -&gt; Running build hook: [block]
==&gt; WARNING: Possibly missing firmware for module: wd719x
==&gt; WARNING: Possibly missing firmware for module: aic94xx
  -&gt; Running build hook: [encrypt]
  -&gt; Running build hook: [filesystems]
  -&gt; Running build hook: [keyboard]
  -&gt; Running build hook: [fsck]
==&gt; Generating module dependencies
==&gt; Creating gzip-compressed initcpio image: /boot/initramfs-linux-fallback.img
==&gt; Image generation successful
[root@archiso /]#
</code></pre>

<h3>set the root password</h3>

<pre><code>[root@archiso /]# passwd root
New password: 
Retype new password: 
passwd: password updated successfully
[root@archiso /]# 
</code></pre>

<h3>GRUB</h3>

<h4>install Grub</h4>

<pre><code>[root@archiso /]# pacman -Sy grub
:: Synchronizing package databases...
 core is up to date
 extra                   1760.1 KiB   917K/s 00:02 [######################] 100%
 community                  3.6 MiB   896K/s 00:04 [######################] 100%
resolving dependencies...
looking for conflicting packages...

Packages (1) grub-1:2.02.beta3-3

Total Download Size:    5.83 MiB
Total Installed Size:  28.70 MiB

:: Proceed with installation? [Y/n] y
:: Retrieving packages...
 grub-1:2.02.beta3-3...     5.8 MiB   917K/s 00:07 [######################] 100%
(1/1) checking keys in keyring                     [######################] 100%
(1/1) checking package integrity                   [######################] 100%
(1/1) loading package files                        [######################] 100%
(1/1) checking for file conflicts                  [######################] 100%
(1/1) checking available disk space                [######################] 100%
:: Processing package changes...
(1/1) installing grub                              [######################] 100%
Generating grub.cfg.example config file...
This may fail on some machines running a custom kernel.
done.
Optional dependencies for grub
    freetype2: For grub-mkfont usage
    fuse: For grub-mount usage
    dosfstools: For grub-mkrescue FAT FS and EFI support
    efibootmgr: For grub-install EFI support
    libisoburn: Provides xorriso for generating grub rescue iso using
    grub-mkrescue
    os-prober: To detect other OSes when generating grub.cfg in BIOS systems
    mtools: For grub-mkrescue FAT FS support
:: Running post-transaction hooks...
(1/2) Updating manpage index...
(2/2) Updating the info directory file...
[root@archiso /]# 
</code></pre>

<h4>Install grub to your boot disk</h4>

<pre><code>[root@archiso /]# grub-install --target=i386-pc /dev/sda
Installing for i386-pc platform.
grub-install: error: attempt to install to encrypted disk without cryptodisk enabled. Set `GRUB_ENABLE_CRYPTODISK=y' in file `/etc/default/grub'.
[root@archiso /]# 
</code></pre>

<h4>Enable cryptodisk</h4>

<p>Because we use an encrypted boot disk we need to enable cryptdisk support.</p>

<p>Add  GRUB_ENABLE_CRYPTODISK=y to /etc/default/grub</p>

<pre><code>[root@archiso /]# vi /etc/default/grub
[root@archiso /]# 
</code></pre>

<pre><code>GRUB_DEFAULT=0
GRUB_TIMEOUT=5
GRUB_DISTRIBUTOR="Arch"
GRUB_CMDLINE_LINUX_DEFAULT="quiet"
GRUB_CMDLINE_LINUX=""
GRUB_ENABLE_CRYPTODISK=y
</code></pre>

<p>And run grub-install again</p>

<pre><code>[root@archiso /]# grub-install --target=i386-pc /dev/sda
Installing for i386-pc platform.
Installation finished. No error reported.
[root@archiso /]# 
</code></pre>

<h4>Create grub.cfg</h4>

<p>Add your encrypted root partition to GRUB_CMDLINE_LINUX= in /etc/default/grub</p>

<pre><code>GRUB_DEFAULT=0
GRUB_TIMEOUT=5
GRUB_DISTRIBUTOR="Arch"
GRUB_CMDLINE_LINUX_DEFAULT="quiet"
GRUB_CMDLINE_LINUX=""cryptdevice=/dev/sda3:cryptroot""
ENABLE_CRYPTODISK=y 
</code></pre>

<p>And generate grub.cfg</p>

<pre><code>[root@archiso /]# grub-mkconfig -o /boot/grub/grub.cfg
Generating grub configuration file ...
Found linux image: /boot/vmlinuz-linux
Found initrd image(s) in /boot: initramfs-linux.img
Found fallback initrd image(s) in /boot: initramfs-linux-fallback.img
done
[root@archiso /]# 
</code></pre>

<h2>Reboot</h2>

<pre><code>[root@archiso /]# vi /boot/grub/grub.cfg
[root@archiso /]# sync
[root@archiso /]# reboot
Running in chroot, ignoring request.
[root@archiso /]# exit
arch-chroot /mnt  9.76s user 1.37s system 0% cpu 23:13.29 total
root@archiso ~ # reboot
</code></pre>

<h2>Finish the installation</h2>

<h3>1st boot</h3>

<p>As mentioned before the GRUB will as for a passphrase to decrypt the boot partition.</p>

<p><img class="center" src="/images/arch-on-an-encrypted-btrfs-partition/01_1st_boot.png" width="700" height="274" title="&ldquo;01_1st_boot.png&rdquo;" >
<img class="center" src="/images/arch-on-an-encrypted-btrfs-partition/02_1st_grub_menu.png" width="700" height="484" title="&ldquo;01_1st_boot.png&rdquo;" ></p>

<p>You&rsquo;ll need to type it the password a secod time during the loading of initrd.</p>

<p><img class="center" src="/images/arch-on-an-encrypted-btrfs-partition/02_1st_decrypt_root.png" width="700" height="165" title="&ldquo;01_1st_boot.png&rdquo;" ></p>

<h3>Setup swap space</h3>

<p>Update /etc/crypttab</p>

<pre><code>swap         /dev/sda2                                    /dev/urandom            swap,
cipher=aes-cbc-essiv:sha256,size=256
</code></pre>

<p>reboot the system to verify that the encrypted swap partition is mapper correctly during the system startup</p>

<pre><code>[root@vicky ~]# ls -l /dev/mapper/
total 0
crw------- 1 root root 10, 236 Aug 29 15:43 control
lrwxrwxrwx 1 root root       7 Aug 29 15:43 cryptroot -&gt; ../dm-0
lrwxrwxrwx 1 root root       7 Aug 29 15:43 swap -&gt; ../dm-1
[root@vicky ~]# 
</code></pre>

<p>Create swap</p>

<pre><code>[root@vicky ~]# mkswap /dev/mapper/swap 
Setting up swapspace version 1, size = 32 GiB (34359734272 bytes)
no label, UUID=66ea5a08-0833-4e84-8b95-f1a9c2d772b2
[root@vicky ~]# 
</code></pre>

<p>Activate swap</p>

<pre><code>[root@vicky ~]# swapon /dev/mapper/swap
[root@vicky ~]# free
              total        used        free      shared  buff/cache   available
Mem:        4051236       85932     3890708         440       74596     3807084
Swap:      33554428           0    33554428
[root@vicky ~]# 
</code></pre>

<p>Update /etc/fstab</p>

<pre><code>/dev/mapper/swap swap                    swap    defaults,discard,pri=3        0 0 
</code></pre>

<p style="font-style: italic;">
Have fun
</p>


<h2>Links</h2>

<ul>
<li><a href="https://wiki.archlinux.org/index.php/Installation_guide"><a href="https://wiki.archlinux.org/index.php/Installation_guide">https://wiki.archlinux.org/index.php/Installation_guide</a></a></li>
<li><a href="http://www.brunoparmentier.be/blog/how-to-install-arch-linux-on-an-encrypted-btrfs-partition.html"><a href="http://www.brunoparmentier.be/blog/how-to-install-arch-linux-on-an-encrypted-btrfs-partition.html">http://www.brunoparmentier.be/blog/how-to-install-arch-linux-on-an-encrypted-btrfs-partition.html</a></a></li>
<li><a href="http://blog.fabio.mancinelli.me/2012/12/28/Arch_Linux_on_BTRFS.html"><a href="http://blog.fabio.mancinelli.me/2012/12/28/Arch_Linux_on_BTRFS.html">http://blog.fabio.mancinelli.me/2012/12/28/Arch_Linux_on_BTRFS.html</a></a></li>
</ul>

]]></content>
  </entry>
  
</feed>
