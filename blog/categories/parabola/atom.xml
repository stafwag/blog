<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Parabola | stafwag Blog]]></title>
  <link href="https://stafwag.github.io/blog/blog/categories/parabola/atom.xml" rel="self"/>
  <link href="https://stafwag.github.io/blog/"/>
  <updated>2018-12-09T09:25:33+01:00</updated>
  <id>https://stafwag.github.io/blog/</id>
  <author>
    <name><![CDATA[staf wagemakers]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Install Parabola GNU/Linux on an Encrypted Btrfs Logical Volume]]></title>
    <link href="https://stafwag.github.io/blog/blog/2017/05/25/install-parabola-gnu-slash-linux-on-an-encrypted-btrfs-logical-volume/"/>
    <updated>2017-05-25T09:05:38+02:00</updated>
    <id>https://stafwag.github.io/blog/blog/2017/05/25/install-parabola-gnu-slash-linux-on-an-encrypted-btrfs-logical-volume</id>
    <content type="html"><![CDATA[<p><img class="left" src="/images/413px-Gnu10-mascot-logo_100ppi.png" width="200" height="291" title="&ldquo;413px-Gnu10-mascot-logo_100ppi.png&rdquo;" ></p>

<p>I finally found time to complete the installation of my <a href="http://stafwag.github.io/blog/blog/2017/02/11/how-to-install-libreboot-on-a-thinkpad-x60/">Libreboot laptop</a></p>

<p>I decided to give <a href="https://www.parabola.nu/">Parabola GNU/Linux</a> a try as my daily driver to get a fully <a href="https://en.wikipedia.org/wiki/Free_software">Free Software</a> Laptop/tablet.</p>

<h2>Download the Parabola GNU/Linux iso and boot it</h2>

<p>After Parabola GNU/Linux is booted verify that you have internet access if the network card is support and dhcp is enabled on you network you should get a network address.</p>

<h2>Network access</h2>

<p>To setup the system remotely we first need to setup network to our system.</p>

<h3>Verify the interface</h3>

<pre><code>1 root@parabolaiso ~ # ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: enp1s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 00:16:d3:b7:3a:96 brd ff:ff:ff:ff:ff:ff
    inet 192.168.1.11/24 brd 192.168.1.255 scope global enp1s0
       valid_lft forever preferred_lft forever
    inet6 fe80::e5db:c85f:4478:1f44/64 scope link 
       valid_lft forever preferred_lft forever
3: wlp2s0: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000
    link/ether 00:1b:77:4d:5a:57 brd ff:ff:ff:ff:ff:ff
root@parabolaiso ~ # 
</code></pre>

<h3>Verify internet access</h3>

<pre><code>root@parabolaiso ~ # ping -c 3 www.google.be
PING www.google.be (172.217.17.67) 56(84) bytes of data.
64 bytes from ams16s30-in-f3.1e100.net (172.217.17.67): icmp_seq=1 ttl=56 time=91.3 ms
64 bytes from ams16s30-in-f3.1e100.net (172.217.17.67): icmp_seq=2 ttl=56 time=48.7 ms
64 bytes from ams16s30-in-f3.1e100.net (172.217.17.67): icmp_seq=3 ttl=56 time=47.9 ms

--- www.google.be ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2003ms
rtt min/avg/max/mdev = 47.998/62.714/91.366/20.264 ms
root@parabolaiso ~ # 
</code></pre>

<h2>ssh access</h2>

<p>If you want to install Parabola GNU/Linux over ssh you need to assign a root passwd and start the sshd service.</p>

<h3>root password</h3>

<pre><code>root@parabolaiso ~ # passwd root
New password: 
Retype new password: 
passwd: password updated successfully
root@parabolaiso ~ # 
</code></pre>

<h3>create a user account</h3>

<p>Parabola doesn&rsquo;t allow remote ssh root logons. Create a new account to access the system remotely.</p>

<pre><code>root@parabolaiso ~ # useradd install
root@parabolaiso ~ # passwd install
New password: 
Retype new password: 
passwd: password updated successfully
root@parabolaiso ~ # 
</code></pre>

<h3>start sshd</h3>

<pre><code>root@parabolaiso ~ # systemctl start sshd
root@parabolaiso ~ # 
</code></pre>

<h3>Logon remotely</h3>

<pre><code>[staf@vicky ~]$ ssh install@petronella 
install@petronella's password: 

===============================================================================

         Parabola live media 2016.11.03                                

    To install Parabola, the system must be connected to the internet.    
    For instructions, enter this command:                                 
      lynx network.html                                           

    Press the number keys while holding Alt to switch virtual terminals.  
    This allows entering commands without closing lynx.                   

===============================================================================

Could not chdir to home directory /home/install: No such file or directory
[install@parabolaiso /]$ su -
Password: 
root@parabolaiso ~ # 
</code></pre>

<h2>Partition your harddisk</h2>

<h3>Find your harddisk device name</h3>

<pre><code>root@parabolaiso ~ # lsblk -o NAME,VENDOR,MODEL,TYPE,SIZE 
NAME                  VENDOR   MODEL            TYPE   SIZE
loop1                                           loop   1.9G
`-parabola_root-image                           dm     1.9G
sdb                   ATA      OCZ-VERTEX2      disk 107.1G
`-sdb1                                          part 107.1G
loop2                                           loop   1.9G
`-parabola_root-image                           dm     1.9G
loop0                                           loop 269.7M
sda                   Kingston DataTraveler 2.0 disk   7.2G
|-sda2                                          part    31M
`-sda1                                          part   613M
root@parabolaiso ~ # 
</code></pre>

<h3>Overwrite it with random data</h3>

<p>Because we are creating an ecrypted filesystem it&rsquo;s a good idea to overwrite it with random data.</p>

<p>We&rsquo;ll use badblocks for this another method is to use &ldquo;dd if=/dev/random of=/dev/xxx&rdquo; the &ldquo;dd&rdquo; method is probably the best method but is a lot slower.</p>

<pre><code>root@parabolaiso ~ # badblocks -c 10240 -s -w -t random -v /dev/sdb


Checking for bad blocks in read-write mode
From block 0 to 112337063
Testing with random pattern: done                                                 
Reading and comparing: done                                                 
Pass completed, 0 bad blocks found. (0/0/0 errors)
badblocks -c 10240 -s -w -t random -v /dev/sdb  82.82s user 20.08s system 3% cpu 48:12.29 total
root@parabolaiso ~ # 
</code></pre>

<h3>Partition the harddisk</h3>

<p>We&rsquo;ll use lvm is this setup, while it should be possible to  boot from an encrypted partition with Libreboot partition I create a small unencrypted boot partition.</p>

<pre><code>root@parabolaiso ~ # fdisk /dev/sdb

Welcome to fdisk (util-linux 2.28.2).
Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.

Device does not contain a recognized partition table.
Created a new DOS disklabel with disk identifier 0x2640923c.

Command (m for help): p
Disk /dev/sdb: 107.1 GiB, 115033153536 bytes, 224674128 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0x2640923c

Command (m for help): n
Partition type
   p   primary (0 primary, 0 extended, 4 free)
   e   extended (container for logical partitions)
Select (default p): p
Partition number (1-4, default 1): 
First sector (2048-224674127, default 2048): 
Last sector, +sectors or +size{K,M,G,T,P} (2048-224674127, default 224674127): +1G

Created a new partition 1 of type 'Linux' and of size 1 GiB.

Command (m for help): n
Partition type
   p   primary (1 primary, 0 extended, 3 free)
   e   extended (container for logical partitions)
Select (default p): p
Partition number (2-4, default 2): 
First sector (2099200-224674127, default 2099200): 
Last sector, +sectors or +size{K,M,G,T,P} (2099200-224674127, default 224674127): 

Created a new partition 2 of type 'Linux' and of size 106.1 GiB.

Command (m for help): p
Disk /dev/sdb: 107.1 GiB, 115033153536 bytes, 224674128 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0x2640923c

Device     Boot   Start       End   Sectors   Size Id Type
/dev/sdb1          2048   2099199   2097152     1G 83 Linux
/dev/sdb2       2099200 224674127 222574928 106.1G 83 Linux

Command (m for help): w
The partition table has been altered.
Calling ioctl() to re-read partition table.
Syncing disks.

root@parabolaiso ~ # 
</code></pre>

<h3>Encrypt the LVM physical volume</h3>

<h4>Benchmark</h4>

<p>We bechmark the encryption to decide which encryption we&rsquo;ll use.</p>

<pre><code>root@parabolaiso ~ # cryptsetup benchmark
# Tests are approximate using memory only (no storage IO).
PBKDF2-sha1       382134 iterations per second for 256-bit key
PBKDF2-sha256     479239 iterations per second for 256-bit key
PBKDF2-sha512     347671 iterations per second for 256-bit key
PBKDF2-ripemd160  319687 iterations per second for 256-bit key
PBKDF2-whirlpool  221032 iterations per second for 256-bit key
#  Algorithm | Key |  Encryption |  Decryption
     aes-cbc   128b    79.1 MiB/s    93.9 MiB/s
 serpent-cbc   128b    30.0 MiB/s   112.0 MiB/s
 twofish-cbc   128b    77.5 MiB/s   102.5 MiB/s
     aes-cbc   256b    62.7 MiB/s    71.0 MiB/s
 serpent-cbc   256b    30.0 MiB/s   111.9 MiB/s
 twofish-cbc   256b    77.5 MiB/s   102.4 MiB/s
     aes-xts   256b    93.0 MiB/s    93.3 MiB/s
 serpent-xts   256b   100.3 MiB/s   104.5 MiB/s
 twofish-xts   256b    93.8 MiB/s    95.0 MiB/s
     aes-xts   512b    70.5 MiB/s    70.7 MiB/s
 serpent-xts   512b   100.3 MiB/s   104.4 MiB/s
 twofish-xts   512b    93.9 MiB/s    94.9 MiB/s
cryptsetup benchmark  3.91s user 24.02s system 99% cpu 28.093 total
root@parabolaiso ~ # 
</code></pre>

<h4>Create Luks volume</h4>

<p>The serpent xts with a 512 bits keys seems to give a pretty good performance while sha256 hashing gives the best performance.</p>

<pre><code>root@parabolaiso ~ # cryptsetup luksFormat --cipher serpent-xts-plain64 --key-size 512 --hash sha256 --use-random /dev/sdb2 

WARNING!
========
This will overwrite data on /dev/sdb2 irrevocably.

Are you sure? (Type uppercase yes): YES
Enter passphrase: 
Verify passphrase: 
root@parabolaiso ~ # 
</code></pre>

<h2>LVM setup</h2>

<h3>Create the volumes</h3>

<h4>Open the LUKS volume</h4>

<pre><code>root@parabolaiso ~ #  cryptsetup luksOpen /dev/sdb2 pv
Enter passphrase for /dev/sdb2: 
root@parabolaiso ~ # 
</code></pre>

<p>This create /dev/mapper/pv</p>

<h4>Create the physical volume</h4>

<pre><code>root@parabolaiso ~ # pvcreate /dev/mapper/pv                 
  Physical volume "/dev/mapper/pv" successfully created.
root@parabolaiso ~ # 
</code></pre>

<p>Show the pv</p>

<pre><code>root@parabolaiso ~ # pvs
  PV             VG Fmt  Attr PSize   PFree  
  /dev/mapper/pv    lvm2 ---  106.13g 106.13g
root@parabolaiso ~ # 
</code></pre>

<h4>Create the volume group</h4>

<pre><code>root@parabolaiso ~ # vgcreate vg /dev/mapper/pv
  Volume group "vg" successfully created
root@parabolaiso ~ # 
</code></pre>

<p>Show the created volume group</p>

<pre><code>root@parabolaiso ~ # vgs
  VG #PV #LV #SN Attr   VSize   VFree  
  vg   1   0   0 wz--n- 106.13g 106.13g
root@parabolaiso ~ # 
</code></pre>

<h4>Create the swap logical volume</h4>

<pre><code>root@parabolaiso ~ # lvcreate -L 4G vg -n lv_swap 
  Logical volume "lv_swap" created.
root@parabolaiso ~ # 
</code></pre>

<h4>Create the root logical volume</h4>

<pre><code>root@parabolaiso ~ # lvcreate -L 20G vg -n lv_root   
  Logical volume "lv_root" created.
root@parabolaiso ~ # 
</code></pre>

<h4>Display the create logical volumes</h4>

<pre><code>root@parabolaiso ~ # lvs
  LV      VG Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  lv_root vg -wi-a----- 20.00g                                                    
  lv_swap vg -wi-a-----  4.00g                                                    
root@parabolaiso ~ # 
</code></pre>

<h3>Format the logical volumes</h3>

<h4>Create the swapspace</h4>

<pre><code>root@parabolaiso ~ # mkswap /dev/mapper/vg-lv_swap       
Setting up swapspace version 1, size = 4 GiB (4294963200 bytes)
no label, UUID=32f6e5d4-67a3-42e3-8a90-6ee3ae0fdaa3
root@parabolaiso ~ # 
</code></pre>

<p>And activate it;</p>

<pre><code>root@parabolaiso ~ # swapon /dev/mapper/vg-lv_swap       
root@parabolaiso ~ # 
</code></pre>

<h4>Create the root filesystem</h4>

<pre><code>root@parabolaiso ~ # mkfs.btrfs /dev/mapper/vg-lv_root       
btrfs-progs v4.8.2
See http://btrfs.wiki.kernel.org for more information.

Detected a SSD, turning off metadata duplication.  Mkfs with -m dup if you want to force metadata duplication.
Label:              (null)
UUID:               
Node size:          16384
Sector size:        4096
Filesystem size:    20.00GiB
Block group profiles:
  Data:             single            8.00MiB
  Metadata:         single            8.00MiB
  System:           single            4.00MiB
SSD detected:       yes
Incompat features:  extref, skinny-metadata
Number of devices:  1
Devices:
   ID        SIZE  PATH
    1    20.00GiB  /dev/mapper/vg-lv_root

root@parabolaiso ~ # 
</code></pre>

<h4>Create the boot filesystem</h4>

<pre><code>root@parabolaiso ~ # mkfs.ext2 /dev/sdb1 
mke2fs 1.43.3 (04-Sep-2016)
Discarding device blocks: done                            
Creating filesystem with 262144 4k blocks and 65536 inodes
Filesystem UUID: e3fd741d-d0e0-483f-a9cd-3fbd3f9d66d1
Superblock backups stored on blocks: 
        32768, 98304, 163840, 229376

Allocating group tables: done                            
Writing inode tables: done                            
Writing superblocks and filesystem accounting information: done

root@parabolaiso ~ # 
</code></pre>

<h4>Mount the filesystems</h4>

<p>Mount the root filesystem;</p>

<pre><code>root@parabolaiso ~ # 
root@parabolaiso ~ # mount -o noatime,compress=lzo,discard,ssd,defaults /dev/mapper/vg-lv_root /mnt
root@parabolaiso ~ # 
</code></pre>

<p>Create the /home and /boot directories</p>

<pre><code>root@parabolaiso ~ # mkdir -p /mnt/{boot,home}
</code></pre>

<p>Mount the boot filesystem</p>

<pre><code>root@parabolaiso ~ # mount /dev/sdb1 /mnt/boot
root@parabolaiso ~ # 
</code></pre>

<p>Show;</p>

<pre><code>root@parabolaiso ~ # df -h
Filesystem                       Size  Used Avail Use% Mounted on
dev                              1.6G     0  1.6G   0% /dev
run                              1.6G   26M  1.6G   2% /run
/dev/sda1                        613M  613M     0 100% /run/parabolaiso/bootmnt
cowspace                         2.4G  8.9M  2.4G   1% /run/parabolaiso/cowspace
/dev/loop0                       270M  270M     0 100% /run/parabolaiso/sfs/root-image
/dev/mapper/parabola_root-image  1.9G  885M 1003M  47% /
tmpfs                            1.6G     0  1.6G   0% /dev/shm
tmpfs                            1.6G     0  1.6G   0% /sys/fs/cgroup
tmpfs                            1.6G     0  1.6G   0% /tmp
tmpfs                            1.6G  1.6M  1.6G   1% /etc/pacman.d/gnupg
tmpfs                            320M     0  320M   0% /run/user/0
tmpfs                            320M     0  320M   0% /run/user/1001
/dev/mapper/vg-lv_root            20G   17M   20G   1% /mnt
/dev/sdb1                       1008M  1.3M  956M   1% /mnt/boot
root@parabolaiso ~ # 
</code></pre>

<h2>System installation</h2>

<h3>boostrap the system</h3>

<pre><code>root@parabolaiso ~ # pacstrap /mnt base base-devel btrfs-progs
==&gt; Creating install root at /mnt
==&gt; Installing packages to /mnt
:: Synchronizing package databases...
 libre                                              437.7 KiB   228K/s 00:02 [############################################] 100%
 core                                               111.1 KiB   280K/s 00:00 [############################################] 100%
 extra                                             1535.4 KiB   544K/s 00:03 [############################################] 100%
 community                                            3.6 MiB   615K/s 00:06 [############################################] 100%
 pcr                                                620.0 KiB   662K/s 00:01 [############################################] 100%
:: There are 52 members in group base:
:: Repository libre
   1) filesystem  2) licenses  3) linux-libre  4) pacman  5) pacman-mirrorlist  6) systemd-sysvcompat  7) your-freedom
:: Repository core
   8) bash  9) bzip2  10) coreutils  11) cryptsetup  12) device-mapper  13) dhcpcd  14) diffutils  15) e2fsprogs  16) file
   17) findutils  18) gawk  19) gcc-libs  20) gettext  21) glibc  22) grep  23) gzip  24) inetutils  25) iproute2  26) iputils
   27) jfsutils  28) less  29) logrotate  30) lvm2  31) man-db  32) man-pages  33) mdadm  34) nano  35) netctl  36) pciutils
   37) pcmciautils  38) perl  39) procps-ng  40) psmisc  41) reiserfsprogs  42) s-nail  43) sed  44) shadow  45) sysfsutils
   46) tar  47) texinfo  48) usbutils  49) util-linux  50) vi  51) which  52) xfsprogs

Enter a selection (default=all): 
</code></pre>

<p>&lt; snip &gt;</p>

<pre><code>(2/7) Updating udev hardware database...
(3/7) Updating system user accounts...
(4/7) Creating temporary files...
(5/7) Arming ConditionNeedsUpdate...
(6/7) Updating the info directory file...
(7/7) Rebuilding certificate stores...
pacstrap /mnt base base-devel btrfs-progs  62.07s user 14.31s system 1% cpu 1:13:22.44 total
root@parabolaiso ~ # 
</code></pre>

<h3>Generate /etc/fstab</h3>

<pre><code>root@parabolaiso ~ #
root@parabolaiso ~ # genfstab -U -p /mnt  &gt;&gt; /mnt/etc/fstab
root@parabolaiso ~ # 
</code></pre>

<p>review</p>

<pre><code>root@parabolaiso ~ # cat /mnt/etc/fstab
# 
# /etc/fstab: static file system information
#
# &lt;file system&gt; &lt;dir&gt;   &lt;type&gt;  &lt;options&gt;       &lt;dump&gt;  &lt;pass&gt;
# UUID=3731a69b-7240-4618-8e5e-4684d7e719e3
# /dev/mapper/vg-lv_root
UUID=3731a69b-7240-4618-8e5e-4684d7e719e3       /               btrfs           rw,relatime,ssd,space_cache,subvolid=5,subvol=/0 0

# /dev/sdb1
UUID=e3fd741d-d0e0-483f-a9cd-3fbd3f9d66d1       /boot           ext2            rw,relatime,block_validity,barrier,user_xattr,acl       0 2

# /dev/mapper/vg-lv_swap
UUID=32f6e5d4-67a3-42e3-8a90-6ee3ae0fdaa3       none            swap            defaults        0 0

root@parabolaiso ~ # 
</code></pre>

<h3>chroot</h3>

<pre><code>root@parabolaiso ~ # arch-chroot /mnt
[root@parabolaiso /]# 
</code></pre>

<h3>Set the timezone</h3>

<p>Set the link for the correct timezone</p>

<pre><code>[root@parabolaiso /]# ln -sf /usr/share/zoneinfo/Europe/Brussels /etc/localtime
[root@parabolaiso /]# 
</code></pre>

<p>Set the hardwareclock to UTC</p>

<pre><code>[root@parabolaiso /]# hwclock --systohc --utc
[root@parabolaiso /]# 
</code></pre>

<h3>Generate the required locales</h3>

<pre><code>[root@parabolaiso /]# vi /etc/locale.gen 
[root@parabolaiso /]# local 
local       locale      locale-gen  localectl   localedef   
[root@parabolaiso /]# locale-gen
Generating locales...
  en_IE.UTF-8... done
  en_IE.ISO-8859-1... done
  en_IE.ISO-8859-15@euro... done
  en_US.UTF-8... done
  en_US.ISO-8859-1... done
  nl_BE.UTF-8... done
  nl_BE.ISO-8859-1... done
  nl_BE.ISO-8859-15@euro... done
Generation complete.
[root@parabolaiso /]# 
</code></pre>

<h3>Hostname</h3>

<pre><code>[root@parabolaiso /]# vi /etc/hostname
[root@parabolaiso /]# 
</code></pre>

<h3>mkinitcpio</h3>

<h4>HOOKS</h4>

<p>Add &ldquo;encrypt lvm2&rdquo; to HOOKS before filesystems in /etc/mkinitcpio.conf</p>

<pre><code>[root@parabolaiso /]# vi /etc/mkinitcpio.conf
</code></pre>

<pre><code>HOOKS="base udev autodetect modconf block encrypt lvm2 filesystems keyboard fsck"
</code></pre>

<h4>Create boot image</h4>

<pre><code>[root@parabolaiso /]#  mkinitcpio -p linux-libre
==&gt; Building image from preset: /etc/mkinitcpio.d/linux-libre.preset: 'default'
  -&gt; -k /boot/vmlinuz-linux-libre -c /etc/mkinitcpio.conf -g /boot/initramfs-linux-libre.img
==&gt; Starting build: 4.10.6-gnu-1
  -&gt; Running build hook: [base]
  -&gt; Running build hook: [udev]
  -&gt; Running build hook: [autodetect]
  -&gt; Running build hook: [modconf]
  -&gt; Running build hook: [block]
  -&gt; Running build hook: [sd-encrypt]
/usr/lib/initcpio/install/sd-encrypt: line 21: add_systemd_unit: command not found
/usr/lib/initcpio/install/sd-encrypt: line 25: add_systemd_unit: command not found
/usr/lib/initcpio/install/sd-encrypt: line 26: add_systemd_unit: command not found
  -&gt; Running build hook: [lvm2]
  -&gt; Running build hook: [filesystems]
  -&gt; Running build hook: [keyboard]
  -&gt; Running build hook: [fsck]
==&gt; Generating module dependencies
==&gt; Creating gzip-compressed initcpio image: /boot/initramfs-linux-libre.img
==&gt; Image generation successful
==&gt; Building image from preset: /etc/mkinitcpio.d/linux-libre.preset: 'fallback'
  -&gt; -k /boot/vmlinuz-linux-libre -c /etc/mkinitcpio.conf -g /boot/initramfs-linux-libre-fallback.img -S autodetect
==&gt; Starting build: 4.10.6-gnu-1
  -&gt; Running build hook: [base]
  -&gt; Running build hook: [udev]
  -&gt; Running build hook: [modconf]
  -&gt; Running build hook: [block]
==&gt; WARNING: Possibly missing firmware for module: isci
  -&gt; Running build hook: [sd-encrypt]
/usr/lib/initcpio/install/sd-encrypt: line 21: add_systemd_unit: command not found
/usr/lib/initcpio/install/sd-encrypt: line 25: add_systemd_unit: command not found
/usr/lib/initcpio/install/sd-encrypt: line 26: add_systemd_unit: command not found
  -&gt; Running build hook: [lvm2]
  -&gt; Running build hook: [filesystems]
  -&gt; Running build hook: [keyboard]
  -&gt; Running build hook: [fsck]
==&gt; Generating module dependencies
==&gt; Creating gzip-compressed initcpio image: /boot/initramfs-linux-libre-fallback.img
==&gt; Image generation successful
[root@parabolaiso /]# 
</code></pre>

<h3>set the root password</h3>

<pre><code>[root@parabolaiso /]# passwd root
New password: 
Retype new password: 
passwd: password updated successfully
[root@parabolaiso /]# 
</code></pre>

<h3>GRUB</h3>

<h4>install Grub</h4>

<pre><code>[root@parabolaiso /]#  pacman -Sy grub
:: Synchronizing package databases...
 libre is up to date
 core is up to date
 extra is up to date
 community is up to date
 pcr is up to date
resolving dependencies...
looking for conflicting packages...

Packages (1) grub-1:2.02.rc2-1.parabola1

Total Download Size:    6.04 MiB
Total Installed Size:  35.87 MiB

:: Proceed with installation? [Y/n] 
:: Retrieving packages...
 grub-1:2.02.rc2-1.parabola1-x86_64                   6.0 MiB   128K/s 00:48 [############################################] 100%
(1/1) checking keys in keyring                                               [############################################] 100%
(1/1) checking package integrity                                             [############################################] 100%
(1/1) loading package files                                                  [############################################] 100%
(1/1) checking for file conflicts                                            [############################################] 100%
(1/1) checking available disk space                                          [############################################] 100%
:: Processing package changes...
(1/1) installing grub                                                        [############################################] 100%
Generating grub.cfg.example config file...
This may fail on some machines running a custom kernel.
done.
Optional dependencies for grub
    freetype2: For grub-mkfont usage
    fuse: For grub-mount usage
    dosfstools: For grub-mkrescue FAT FS and EFI support
    efibootmgr: For grub-install EFI support
    libisoburn: Provides xorriso for generating grub rescue iso using grub-mkrescue
    os-prober: To detect other OSes when generating grub.cfg in BIOS systems
    mtools: For grub-mkrescue FAT FS support
:: Running post-transaction hooks...
(1/2) Arming ConditionNeedsUpdate...
(2/2) Updating the info directory file...
[root@parabolaiso /]# 
</code></pre>

<h4>Install grub to your boot disk</h4>

<pre><code>[root@parabolaiso /]# grub-install --target=i386-pc /dev/sdb
Installing for i386-pc platform.
Installation finished. No error reported.
[root@parabolaiso /]# 
</code></pre>

<h4>Create grub.cfg</h4>

<p>We&rsquo;ll use the uuid for the crypted device.</p>

<h5>Get the UUID for the encrypted physical volume</h5>

<pre><code>[root@parabolaiso /]# ls -l /dev/disk/by-uuid/
total 0
lrwxrwxrwx 1 root root 10 Apr  3 10:07 2016-11-03-15-52-21-00 -&gt; ../../sda1
lrwxrwxrwx 1 root root 10 Apr  3 10:09 32f6e5d4-67a3-42e3-8a90-6ee3ae0fdaa3 -&gt; ../../dm-2
lrwxrwxrwx 1 root root 10 Apr  3 10:09 3731a69b-7240-4618-8e5e-4684d7e719e3 -&gt; ../../dm-3
lrwxrwxrwx 1 root root 10 Apr  3 10:07 BD3C-9D8E -&gt; ../../sda2
lrwxrwxrwx 1 root root 10 Apr  3 10:07 e3fd741d-d0e0-483f-a9cd-3fbd3f9d66d1 -&gt; ../../sdb1
lrwxrwxrwx 1 root root 10 Apr  3 10:09 eb600d4a-a2fd-4698-8847-14e6dc1b5e6c -&gt; ../../sdb2
lrwxrwxrwx 1 root root 10 Apr  3 10:07 f6312bc5-7593-4b6d-8427-0cf92d9de40b -&gt; ../../dm-0
[root@parabolaiso /]# 
</code></pre>

<h5>Update /etc/default/grub</h5>

<pre><code>GRUB_DEFAULT=0
GRUB_TIMEOUT=5
GRUB_DISTRIBUTOR="Parabola"
GRUB_CMDLINE_LINUX_DEFAULT="quiet"
GRUB_CMDLINE_LINUX="cryptdevice=/dev/disk/by-uuid/eb600d4a-a2fd-4698-8847-14e6dc1b5e6c:pv"
</code></pre>

<h5>Generate grub.cfg</h5>

<pre><code>[root@parabolaiso /]# grub-mkconfig -o /boot/grub/grub.cfg
Generating grub configuration file ...
  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
Found linux image: /boot/vmlinuz-linux-libre
Found initrd image: /boot/initramfs-linux-libre.img
Found fallback initramfs image: /boot/initramfs-linux-libre-fallback.img
  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
done
[root@parabolaiso /]# 
</code></pre>

<h2>Reboot</h2>

<pre><code>[root@parabolaiso /]# exit
root@parabolaiso ~ # umount /mnt/boot
root@parabolaiso ~ # umount /mnt/    
root@parabolaiso ~ # lvchange -an /dev/vg/lv_root  
root@parabolaiso ~ # swapoff /dev/vg/lv_swap
root@parabolaiso ~ # lvchange -an /dev/vg/lv_swap
root@parabolaiso ~ # cryptsetup luksClose  /dev/mapper/pv
root@parabolaiso ~ # reboot
Connection to petronella closed by remote host.
Connection to petronella closed.
[staf@vicky octopress]$ 
</code></pre>

<h2>First boot</h2>

<p>If everything goes well GNU/Linux get booted, &hellip; if not. You&rsquo;ll have some fun to resolve the boot issues :-)</p>

<p style="font-style: italic;">
Have fun!
</p>


<h1>Links</h1>

<ul>
<li><a href="https://libreboot.org/docs/gnulinux/encrypted_parabola.html">https://libreboot.org/docs/gnulinux/encrypted_parabola.html</a></li>
<li><a href="http://stafwag.github.io/blog/blog/2016/08/30/arch-on-an-encrypted-btrfs-partition/">http://stafwag.github.io/blog/blog/2016/08/30/arch-on-an-encrypted-btrfs-partition/</a></li>
<li><a href="http://www.brunoparmentier.be/blog/how-to-install-arch-linux-on-an-encrypted-btrfs-partition.html">http://www.brunoparmentier.be/blog/how-to-install-arch-linux-on-an-encrypted-btrfs-partition.html</a></li>
<li><a href="http://blog.fabio.mancinelli.me/2012/12/28/Arch_Linux_on_BTRFS.html">http://blog.fabio.mancinelli.me/2012/12/28/Arch_Linux_on_BTRFS.html</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How to Install Libreboot on a ThinkPad X60]]></title>
    <link href="https://stafwag.github.io/blog/blog/2017/02/11/how-to-install-libreboot-on-a-thinkpad-x60/"/>
    <updated>2017-02-11T16:09:11+01:00</updated>
    <id>https://stafwag.github.io/blog/blog/2017/02/11/how-to-install-libreboot-on-a-thinkpad-x60</id>
    <content type="html"><![CDATA[<p><br />&nbsp;<br />
I got a <a href="https://en.wikipedia.org/wiki/ThinkPad_X_Series#X60_Tablet">ThinkPad x60 (tablet version)</a> from <a href="http://ebay.be">ebay.be</a> to install <a href="https://libreboot.org/">libreboot</a> on it.
<br />&nbsp;<br />
I tried to compile libreboot on <a href="http://www.debian">Debian</a> and <a href="https://www.parabola.nu/">Parabola</a> GNU/Linux but both failed, compling Libreboot on <a href="https://trisquel.info/">Trisquel 7</a> works fine so I&rsquo;ll use Trisquel to replace the BIOS with libreboot.
<br />&nbsp;<br />
I&rsquo;m not sure that I&rsquo;ll use Trisquel 7 as my daily driver since it is a bit outdated&hellip;
I might go with <a href="http://https://wiki.debian.org/DebianStretch">Debian Strech</a> without the non-free repositories to get a fully <a href="https://en.wikipedia.org/wiki/Free_software">Free Software</a> Laptop/tablet. I&rsquo;ll need to replace the Intel wifi adapter since this requires non-free firmware.
<br />&nbsp;<br />
You&rsquo;ll find a small howto install libreboot on a Thinkpad X60 below.
<br />&nbsp;<br /></p>

<p><img class="centre" src="/images/x60_open.jpg" width="750" height="1050" title="&ldquo;Thinkpad x60 open&rdquo;" ></p>

<h1>Build Libreboot</h1>

<p>The latest version of libreboot isn&rsquo;t available via a binary distribution so I decided to build it from source.</p>

<h2>Download the Libreboot source</h2>

<p>Download the latest libreboot image from <a href="https://libreboot.org/download/"><a href="https://libreboot.org/download/">https://libreboot.org/download/</a></a></p>

<h3>Download the source tarball</h3>

<pre><code>staf@petronella:~/libreboot$ wget https://libreboot.org/release/stable/20160907/libreboot_r20160907_src.tar.xz
--2017-02-11 10:24:41--  https://libreboot.org/release/stable/20160907/libreboot_r20160907_src.tar.xz
Resolving libreboot.org (libreboot.org)... 149.56.232.100
Connecting to libreboot.org (libreboot.org)|149.56.232.100|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 438622508 (418M) [application/x-xz]
Saving to: libreboot_r20160907_src.tar.xz

100%[==========================================================&gt;] 438.622.508  541KB/s   in 18m 35s


2017-02-11 10:43:17 (384 KB/s) - libreboot_r20160907_src.tar.xz saved [438622508/438622508]

staf@petronella:~/libreboot$ 
</code></pre>

<h3>Verify</h3>

<p>As always verify the checksums and the gpg signature, the gpg public key is available at:
<a href="https://libreboot.org/gpg/"</a><a href="https://libreboot.org/gpg/">https://libreboot.org/gpg/</a></a></p>

<h4>Download the  SHA512SUMS and SHA512SUMS.sig</h4>

<pre><code>staf@petronella:~/libreboot$ wget https://libreboot.org/release/stable/20160907/SHA512SUMS                                                      
--2017-02-11 10:52:23--  https://libreboot.org/release/stable/20160907/SHA512SUMS                                                                          
Resolving libreboot.org (libreboot.org)... 149.56.232.100                                                                                                            
Connecting to libreboot.org (libreboot.org)|149.56.232.100|:443... connected.                                                                                                  
HTTP request sent, awaiting response... 200 OK                                                                                                                                 
Length: 5112 (5,0K) [application/octet-stream]                                                                                                                                        
Saving to: 'SHA512SUMS'                                                                                                                                                                          

100%[=====================================================================================================================================================================================================&gt;] 5.112       --.-K/s   in 0,006s  

2017-02-11 10:52:24 (852 KB/s) - 'SHA512SUMS' saved [5112/5112]                                                                                                                                                                      

staf@petronella:~/libreboot$ wget https://libreboot.org/release/stable/20160907/SHA512SUMS.sig
--2017-02-11 10:52:39--  https://libreboot.org/release/stable/20160907/SHA512SUMS.sig
Resolving libreboot.org (libreboot.org)... 149.56.232.100
Connecting to libreboot.org (libreboot.org)|149.56.232.100|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 543 [application/pgp-signature]
Saving to: 'SHA512SUMS.sig'

100%[=====================================================================================================================================================================================================&gt;] 543         --.-K/s   in 0s      

2017-02-11 10:52:39 (11,4 MB/s) - 'SHA512SUMS.sig' saved [543/543]

staf@petronella:~/libreboot$ 
</code></pre>

<h4>Import the public gpg key</h4>

<pre><code>staf@petronella:~/libreboot$ gpg --recv-keys 0x05E8C5B2
gpg: directory `/home/staf/.gnupg' created
gpg: new configuration file `/home/staf/.gnupg/gpg.conf' created
gpg: WARNING: options in `/home/staf/.gnupg/gpg.conf' are not yet active during this run
gpg: keyring `/home/staf/.gnupg/secring.gpg' created
gpg: keyring `/home/staf/.gnupg/pubring.gpg' created
gpg: no keyserver known (use option --keyserver)
gpg: keyserver receive failed: bad URI
staf@petronella:~/libreboot$ gpg --recv-keys 0x05E8C5B2
gpg: requesting key 05E8C5B2 from hkp server keys.gnupg.net
gpg: /home/staf/.gnupg/trustdb.gpg: trustdb created
gpg: key 05E8C5B2: public key "Leah Rowe (Libreboot signing key) &lt;info@minifree.org&gt;" imported
gpg: key 05E8C5B2: public key "Leah Rowe (Libreboot signing key) &lt;info@minifree.org&gt;" imported
gpg: no ultimately trusted keys found
gpg: Total number processed: 2
gpg:               imported: 2  (RSA: 2)
staf@petronella:~/libreboot$ 
</code></pre>

<h4>Verify the checksum file</h4>

<pre><code>staf@petronella:~/libreboot$ gpg --verify SHA512SUMS.sig SHA512SUMS
gpg: Signature made Don 08 Sep 2016 00:15:17 CEST using RSA key ID 05E8C5B2
gpg: Good signature from "Leah Rowe (Libreboot signing key) &lt;info@minifree.org&gt;"
gpg: WARNING: This key is not certified with a trusted signature!
gpg:          There is no indication that the signature belongs to the owner.
Primary key fingerprint: CDC9 CAE3 2CB4 B7FC 84FD  C804 969A 9795 05E8 C5B2
staf@petronella:~/libreboot$ 
</code></pre>

<h4>Verify the checksum</h4>

<pre><code>staf@petronella:~/libreboot$ sha512sum -c SHA512SUMS | head -2
sha512sum: ./libreboot_r20160907_util.tar.xz: No such file or directory
sha512sum: ./rom/depthcharge/libreboot_r20160907_depthcharge_veyron_speedy.tar.xz: No such file or directory
sha512sum: ./rom/grub/libreboot_r20160907_grub_d510mo.tar.xz: No such file or directory
sha512sum: ./libreboot_r20160907_src.tar.xz: OK
./rom/grub/libreboot_r20160907_grub_ga-g41m-es2l.tar.xz./libreboot_r20160907_util.tar.xz: FAILED open or read
: No such file or directory
staf@petronella:~/libreboot$ 
</code></pre>

<h2>Build the modules</h2>

<h3>Git</h3>

<p>It&rsquo;s required to have git installed and to set the user email &amp; name if you don&rsquo;t do this the complilation will fail.</p>

<p>Install git</p>

<pre><code>staf@petronella:~/libreboot$ sudo apt-get install git
[sudo] password for staf: 
Reading package lists... Done
Building dependency tree       
Reading state information... Done
The following extra packages will be installed:
  git-man liberror-perl
Suggested packages:
  git-daemon-run git-daemon-sysvinit git-doc git-el git-email git-gui gitk
  gitweb git-arch git-bzr git-cvs git-mediawiki git-svn
The following NEW packages will be installed:
  git git-man liberror-perl
0 upgraded, 3 newly installed, 0 to remove and 0 not upgraded.
Need to get 3.306 kB of archives.
After this operation, 21,9 MB of additional disk space will be used.
Do you want to continue? [Y/n] y
Get:1 http://fr.archive.trisquel.info/trisquel/ belenos/main liberror-perl all 0.17-1.1 [21,1 kB]
Get:2 http://fr.archive.trisquel.info/trisquel/ belenos-security/main git-man all 1:1.9.1-1ubuntu0.3 [699 kB]
Get:3 http://fr.archive.trisquel.info/trisquel/ belenos-security/main git amd64 1:1.9.1-1ubuntu0.3 [2.586 kB]
Fetched 3.306 kB in 4s (723 kB/s)
Selecting previously unselected package liberror-perl.
(Reading database ... 206214 files and directories currently installed.)
Preparing to unpack .../liberror-perl_0.17-1.1_all.deb ...
Unpacking liberror-perl (0.17-1.1) ...
Selecting previously unselected package git-man.
Preparing to unpack .../git-man_1%3a1.9.1-1ubuntu0.3_all.deb ...
Unpacking git-man (1:1.9.1-1ubuntu0.3) ...
Selecting previously unselected package git.
Preparing to unpack .../git_1%3a1.9.1-1ubuntu0.3_amd64.deb ...
Unpacking git (1:1.9.1-1ubuntu0.3) ...
Processing triggers for man-db (2.6.7.1-1ubuntu1) ...
Setting up liberror-perl (0.17-1.1) ...
Setting up git-man (1:1.9.1-1ubuntu0.3) ...
Setting up git (1:1.9.1-1ubuntu0.3) ...
staf@petronella:~/libreboot$ 
</code></pre>

<p>Set the git username and password.</p>

<pre><code>staf@petronella:~/libreboot$ git config --global user.email "staf@wagemakers.be"
staf@petronella:~/libreboot$ git config --global user.name "staf wagemakers"
staf@petronella:~/libreboot$ 
</code></pre>

<h3>Extract the source</h3>

<pre><code>staf@petronella:~/libreboot$ tar xf libreboot_r20160907_src.tar.xz 
staf@petronella:~/libreboot$ 
</code></pre>

<h3>Install the dependencies</h3>

<p>cd into the extracted directory</p>

<pre><code>staf@petronella:~/libreboot$ ls
SHA512SUMS  SHA512SUMS.sig  libreboot_r20160907_src  libreboot_r20160907_src.tar.xz
staf@petronella:~/libreboot$ cd libreboot_r20160907_src
</code></pre>

<p>run dependencies trisquel7 to install the software dependencies.</p>

<pre><code>staf@petronella:~/libreboot/libreboot_r20160907_src$ sudo ./build dependencies trisquel7
Reading package lists... Done
Building dependency tree       
Reading state information... Done
wget is already the newest version.
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
Reading package lists... Done
Building dependency tree       
Reading state information... Done
git is already the newest version.
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
Reading package lists... Done
Building dependency tree       
Reading state information... Done
The following extra packages will be installed:
  fonts-lmodern fonts-texgyre latex-beamer latex-xcolor libintl-perl
  liblua5.1-0 libpaper-utils libptexenc1 libruby1.9.1 libtext-unidecode-perl
  libxml-libxml-perl libxml-namespacesupport-perl libxml-sax-base-perl
  libxml-sax-expat-perl libxml-sax-perl libyaml-0-2 lmodern luatex pandoc-data
  pgf prosper ps2eps ruby ruby1.9.1 tcl tcl8.6 tex-common tex-gyre
  texlive-base texlive-binaries texlive-extra-utils texlive-font-utils
</code></pre>

<p>&lt; snip &gt;</p>

<pre><code>(Reading database ... 236394 files and directories currently installed.)
Preparing to unpack .../lib32z1_1%3a1.2.8.dfsg-1ubuntu1_amd64.deb ...
Unpacking lib32z1 (1:1.2.8.dfsg-1ubuntu1) ...
Selecting previously unselected package lib32z1-dev.
Preparing to unpack .../lib32z1-dev_1%3a1.2.8.dfsg-1ubuntu1_amd64.deb ...
Unpacking lib32z1-dev (1:1.2.8.dfsg-1ubuntu1) ...
Setting up lib32z1 (1:1.2.8.dfsg-1ubuntu1) ...
Setting up lib32z1-dev (1:1.2.8.dfsg-1ubuntu1) ...
Processing triggers for libc-bin (2.19-0ubuntu6.9) ...
staf@petronella:~/libreboot/libreboot_r20160907_src$ 
</code></pre>

<h3>Build module all</h3>

<p>Build the modules by excuting build module all</p>

<pre><code>staf@petronella:~/libreboot/libreboot/libreboot_r20160907_src$ ./build module all
Building bucts
rm -f bucts bucts.o
gcc  -DVERSION='"withoutgit"' -c bucts.c
gcc -o bucts bucts.o  -lpci


Building the utilities in coreboot
make: Entering directory `/home/staf/libreboot/libreboot_r20160907_src/coreboot/15fca66bf08db45937ce88b950491963654805b9/15fca66bf08db45937ce88b950491963654805b9/util/cbfstool'
    HOSTCC     cbfstool/cbfstool.o
    HOSTCC     cbfstool/common.o
    HOSTCC     cbfstool/compress.o
    HOSTCC     cbfstool/cbfs_hash.o
    HOSTCC     cbfstool/cbfs_image.o
    HOSTCC     cbfstool/cbfs-mkstage.o
    HOSTCC     cbfstool/cbfs-mkpayload.o
    HOSTCC     cbfstool/elfheaders.o
    HOSTCC     cbfstool/rmodule.o
    HOSTCC     cbfstool/xdr.o
    HOSTCC     cbfstool/fit.o
    HOSTCC     cbfstool/partitioned_file.o
</code></pre>

<p>&lt; snip &gt;</p>

<pre><code>  Compile checking out/vgasrc/stdvgamodes.o
  Compile checking out/vgasrc/stdvgaio.o
  Compile checking out/vgasrc/clext.o
  Compile checking out/vgasrc/bochsvga.o
  Compile checking out/vgasrc/geodevga.o
  Compile checking out/vgasrc/cbvga.o
  Compiling whole program out/vgaccode16.raw.s
  Fixup VGA rom assembler
  Compiling (16bit) out/vgaentry.o
  Precompiling out/vgasrc/vgalayout.lds
  Linking out/vgarom.o
Version: ?-20170211_123929-petronella
  Extracting binary out/vgabios.bin.raw
  Finalizing rom out/vgabios.bin
staf@petronella:~/libreboot/libreboot_r20160907_src$ 
</code></pre>

<h2>Build the ROMS</h2>

<pre><code>staf@petronella:~/libreboot/libreboot_r20160907_src$ ./build roms withgrub
Building ROM images with the GRUB payload
Creating GRUB ELF executable for configuration 'txtmode'


Creating GRUB ELF executable for configuration 'vesafb'


GRUB Helper script: build ROM images for 'd510mo'
M       3rdparty/vboot
Switched to branch 'grub_d510mo'
Switched to branch 'grub_d510mo'
No submodule mapping found in .gitmodules for path '3rdparty/vboot'
No submodule mapping found in .gitmodules for path '3rdparty/vboot'
</code></pre>

<p>&lt; snip &gt;</p>

<pre><code>12288 bytes (12 kB) copied, 0,026113 s, 471 kB/s
12288+0 records in
12288+0 records out
12288 bytes (12 kB) copied, 0,0259776 s, 473 kB/s
12288+0 records in
12288+0 records out
12288 bytes (12 kB) copied, 0,0261767 s, 469 kB/s
12288+0 records in
12288+0 records out
12288 bytes (12 kB) copied, 0,0261144 s, 471 kB/s
12288+0 records in
12288+0 records out
12288 bytes (12 kB) copied, 0,0282761 s, 435 kB/s
12288+0 records in
12288+0 records out
12288 bytes (12 kB) copied, 0,0271539 s, 453 kB/s
12288+0 records in
12288+0 records out
12288 bytes (12 kB) copied, 0,0295147 s, 416 kB/s


staf@petronella:~/libreboot/libreboot_r20160907_src$ 
</code></pre>

<p>The rom build command creates a bin directory, verify that required roms are available.</p>

<pre><code>staf@petronella:~/libreboot/libreboot_r20160907_src$ cd bin/
staf@petronella:~/libreboot/libreboot_r20160907_src/bin$ ls -l
total 4
drwxrwxr-x 23 staf staf 4096 Feb  11 15:58 grub
staf@petronella:~/libreboot/libreboot_r20160907_src/bin$ cd grub/
staf@petronella:~/libreboot/libreboot_r20160907_src/bin/grub$ ls -l
total 84
drwxrwxr-x 2 staf staf 4096 Feb  11 15:28 d510mo
drwxrwxr-x 2 staf staf 4096 Feb  11 15:29 ga-g41m-es2l
drwxrwxr-x 2 staf staf 4096 Feb  11 15:30 kcma-d8
drwxrwxr-x 2 staf staf 4096 Feb  11 15:31 kgpe-d16
drwxrwxr-x 2 staf staf 4096 Feb  11 15:32 macbook21
drwxrwxr-x 2 staf staf 4096 Feb  11 15:33 qemu_i440fx_piix4
drwxrwxr-x 2 staf staf 4096 Feb  11 15:34 qemu_q35_ich9
drwxrwxr-x 2 staf staf 4096 Feb  11 15:59 r400_16mb
drwxrwxr-x 2 staf staf 4096 Feb  11 15:59 r400_4mb
drwxrwxr-x 2 staf staf 4096 Feb  11 15:59 r400_8mb
drwxrwxr-x 2 staf staf 4096 Feb  11 15:59 t400_16mb
drwxrwxr-x 2 staf staf 4096 Feb  11 15:59 t400_4mb
drwxrwxr-x 2 staf staf 4096 Feb  11 15:59 t400_8mb
drwxrwxr-x 2 staf staf 4096 Feb  11 15:59 t500_16mb
drwxrwxr-x 2 staf staf 4096 Feb  11 15:59 t500_4mb
drwxrwxr-x 2 staf staf 4096 Feb  11 15:59 t500_8mb
drwxrwxr-x 2 staf staf 4096 Feb  11 15:58 t60
drwxrwxr-x 2 staf staf 4096 Feb  11 15:59 x200_16mb
drwxrwxr-x 2 staf staf 4096 Feb  11 15:58 x200_4mb
drwxrwxr-x 2 staf staf 4096 Feb  11 15:58 x200_8mb
drwxrwxr-x 2 staf staf 4096 Feb  11 15:58 x60
staf@petronella:~/libreboot/libreboot_r20160907_src/bin/grub$ 
</code></pre>

<pre><code>staf@petronella:~/libreboot/libreboot_r20160907_src/bin/grub$ cd x60
staf@petronella:~/libreboot/libreboot_r20160907_src/bin/grub/x60$ ls -l
total 40960
-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_deqwertz_txtmode.rom
-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_deqwertz_vesafb.rom
-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_esqwerty_txtmode.rom
-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_esqwerty_vesafb.rom
-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_frazerty_txtmode.rom
-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_frazerty_vesafb.rom
-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_frdvbepo_txtmode.rom
-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_frdvbepo_vesafb.rom
-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_itqwerty_txtmode.rom
-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_itqwerty_vesafb.rom
-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_svenska_txtmode.rom
-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_svenska_vesafb.rom
-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_ukdvorak_txtmode.rom
-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_ukdvorak_vesafb.rom
-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_ukqwerty_txtmode.rom
-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_ukqwerty_vesafb.rom
-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_usdvorak_txtmode.rom
-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_usdvorak_vesafb.rom
-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_usqwerty_txtmode.rom
-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_usqwerty_vesafb.rom
</code></pre>

<h1>Libreboot Installation</h1>

<h2>Backup</h2>

<p>Backups are important. We&rsquo;ll first backup the orginal proprietary <a href="https://en.wikipedia.org/wiki/BIOS">BIOS</a> before we free the laptop and install a <a href="https://en.wikipedia.org/wiki/Free_software">Free Software firmware</a></p>

<p>The documentation that I found (see Links below) describes that the backup has 2 step flashrom_lenovobios_sst &amp; flashrom_lenovobios_macronix.</p>

<p>The flashrom_lenovobios_macronix command fails on my Laptop/Table but I decided to continue with the installation since I didn&rsquo;t pay a lot for the laptop on ebay.be.</p>

<pre><code>staf@petronella:~/libreboot/libreboot_r20160907_src$ sudo flashrom/flashrom_lenovobios_sst -p internal -r factory.bin
[sudo] password for staf: 
flashrom v0.9.9-unknown on Linux 3.13.0-108-lowlatency (x86_64)
flashrom is free software, get the source code at https://flashrom.org

Calibrating delay loop... OK.
Found chipset "Intel ICH7M".
Enabling flash write... WARNING: SPI Configuration Lockdown activated.
OK.
Found SST flash chip "SST25VF016B" (2048 kB, SPI) mapped at physical address 0x00000000ffe00000.
Reading flash... done.
staf@petronella:~/libreboot/libreboot_r20160907_src$ 
</code></pre>

<pre><code>staf@petronella:~/libreboot/libreboot_r20160907_src/flashrom$ sudo ./flashrom_lenovobios_macronix -p internal -r factory.bin
flashrom v0.9.9-unknown on Linux 3.13.0-108-lowlatency (x86_64)
flashrom is free software, get the source code at https://flashrom.org

Calibrating delay loop... OK.
Found chipset "Intel ICH7M".
Enabling flash write... WARNING: SPI Configuration Lockdown activated.
OK.
No EEPROM/flash device found.
Note: flashrom can never write if the flash chip isn't found automatically.
staf@petronella:~/libreboot/libreboot_r20160907_src/flashrom$ 
</code></pre>

<h2>Install the rom</h2>

<pre><code>staf@petronella:~/libreboot/libreboot_r20160907_src$ sudo ./flash i945lenovo_firstflash bin/grub/x
x200_16mb/ x200_4mb/  x200_8mb/  x60/       
staf@petronella:~/libreboot/libreboot_r20160907_src$ sudo ./flash i945lenovo_firstflash bin/grub/x60/x60_
x60_deqwertz_txtmode.rom  x60_frazerty_txtmode.rom  x60_itqwerty_txtmode.rom  x60_ukdvorak_txtmode.rom  x60_usdvorak_txtmode.rom
x60_deqwertz_vesafb.rom   x60_frazerty_vesafb.rom   x60_itqwerty_vesafb.rom   x60_ukdvorak_vesafb.rom   x60_usdvorak_vesafb.rom
x60_esqwerty_txtmode.rom  x60_frdvbepo_txtmode.rom  x60_svenska_txtmode.rom   x60_ukqwerty_txtmode.rom  x60_usqwerty_txtmode.rom
x60_esqwerty_vesafb.rom   x60_frdvbepo_vesafb.rom   x60_svenska_vesafb.rom    x60_ukqwerty_vesafb.rom   x60_usqwerty_vesafb.rom
staf@petronella:~/libreboot/libreboot_r20160907_src$ sudo ./flash i945lenovo_firstflash bin/grub/x60/x60_us
x60_usdvorak_txtmode.rom  x60_usdvorak_vesafb.rom   x60_usqwerty_txtmode.rom  x60_usqwerty_vesafb.rom   
staf@petronella:~/libreboot/libreboot_r20160907_src$ sudo ./flash i945lenovo_firstflash bin/grub/x60/x60_usqwerty_vesafb.rom 
[sudo] password for staf: 
Mode selected: i945lenovo_firstflash
bucts utility version 'withoutgit'
Using LPC bridge 8086:27b9 at 0000:1f.00
Current BUC.TS=0 - 128kb address range 0xFFFE0000-0xFFFFFFFF is untranslated
Updated BUC.TS=1 - 64kb address ranges at 0xFFFE0000 and 0xFFFF0000 are swapped
flashrom v0.9.9-unknown on Linux 3.13.0-108-lowlatency (x86_64)
flashrom is free software, get the source code at https://flashrom.org

Calibrating delay loop... OK.
Found chipset "Intel ICH7M".
Enabling flash write... WARNING: SPI Configuration Lockdown activated.
OK.
Found SST flash chip "SST25VF016B" (2048 kB, SPI) mapped at physical address 0x00000000ffe00000.
Reading old flash chip contents... done.
Erasing and writing flash chip... spi_block_erase_20 failed during command execution at address 0x0
Reading current flash chip contents... done. Looking for another erase function.
spi_block_erase_52 failed during command execution at address 0x0
Reading current flash chip contents... done. Looking for another erase function.
Transaction error!
spi_block_erase_d8 failed during command execution at address 0x1f0000
Reading current flash chip contents... done. Looking for another erase function.
spi_chip_erase_60 failed during command execution
Reading current flash chip contents... done. Looking for another erase function.
spi_chip_erase_c7 failed during command execution
Looking for another erase function.
No usable erase functions left.
FAILED!
Uh oh. Erase/write failed. Checking if anything has changed.
Reading current flash chip contents... done.
Apparently at least some data has changed.
Your flash chip is in an unknown state.
Get help on IRC at chat.freenode.net (channel #flashrom) or
mail flashrom@flashrom.org with the subject "FAILED: &lt;your board name&gt;"!
-------------------------------------------------------------------------------
DO NOT REBOOT OR POWEROFF!
flashrom v0.9.9-unknown on Linux 3.13.0-108-lowlatency (x86_64)
flashrom is free software, get the source code at https://flashrom.org

Calibrating delay loop... OK.
Found chipset "Intel ICH7M".
Enabling flash write... WARNING: SPI Configuration Lockdown activated.
OK.
No EEPROM/flash device found.
Note: flashrom can never write if the flash chip isn't found automatically.
staf@petronella:~/libreboot/libreboot_r20160907_src$ 
</code></pre>

<p>Power down your system</p>

<pre><code>staf@petronella:~/libreboot/libreboot_r20160907_src$ sudo poweroff

Broadcast message from staf@petronella
        (/dev/pts/7) at 16:11 ...

The system is going down for power off NOW!
staf@petronella:~/libreboot/libreboot_r20160907_src$ Connection to petronella closed by remote host.
Connection to petronella closed.
[staf@vicky ~]$ 
</code></pre>

<p>Wait 2 minutes and boot the system again. If you&rsquo;re lucky the system will boot with the Free Libreboot firmware.
Logon the system again and continue with the secondflash phase</p>

<pre><code>[staf@vicky ~]$ ssh petronella 
C_GetAttributeValue failed: 18
no such identity: /home/staf/.ssh/id_rsa: No such file or directory
no such identity: /home/staf/.ssh/id_dsa: No such file or directory
no such identity: /home/staf/.ssh/id_ecdsa: No such file or directory
no such identity: /home/staf/.ssh/id_ed25519: No such file or directory
staf@petronella's password: 
Welcome to Trisquel GNU/Linux 7.0, Belenos (GNU/Linux 3.13.0-108-lowlatency x86_64)
   ___        ___               ___        ___       ___        ___        ___
  /\  \      /\  \      ___    /\  \      /\  \     /\__\      /\  \      /\__\
  \ \  \    /  \  \    /\  \  /  \  \    /  \  \   / /  /     /  \  \    / /  /
   \ \  \  / /\ \  \   \ \  \/ /\ \  \  / /\ \  \ / /  /     / /\ \  \  / /  /
   /  \  \/  \ \ \  \  /  \__\ \ \ \  \/ /  \ \  \ /  /  ___/  \ \ \  \/ /  /
  / /\ \__\/\ \ \ \__\/ /\/__/\ \ \ \__\/__/ \ \__\__/  /\__\/\ \ \ \__\/__/
 / /  \/__/_|  \/ /  / /  /\ \ \ \ \/__/\  \ / /  /  \ / /  /\ \ \ \/__/\  \
/ /  /      | |  /  / /__/  \ \ \ \__\ \ \/\/ /  / \  / /  /\ \ \ \__\ \ \  \
\/__/       | |\/__/\ \__\   \ \/ /  /  \    /  / \ \/ /  /  \ \ \/__/  \ \  \
            | |  |   \/__/    \  /  /    \  /  /   \  /  /    \ \__\     \ \__\
             \|__|             \/__/      \/__/     \/__/      \/__/      \/__/

Welcome to Trisquel GNU/Linux
Documentation: http://trisquel.info/wiki/

Last login: Sat Feb 11 15:43:11 2017 from 192.168.1.10
staf@petronella:~$ cd libreboot/libreboot
libreboot/               libreboot_r20160907_src/ 
staf@petronella:~$ cd libreboot/libreboot_r20160907_src/
staf@petronella:~/libreboot/libreboot_r20160907_src$  ./flash i945lenovo_secondflash bin/grub/x60/x60_usqwerty_vesafb.rom 
This script must be run as root
staf@petronella:~/libreboot/libreboot_r20160907_src$ ^C libreboot/libreboot_r20160907_src/
staf@petronella:~/libreboot/libreboot_r20160907_src$ sudo ./flash i945lenovo_secondflash bin/grub/x60/x60_usqwerty_vesafb.rom
[sudo] password for staf: 
Mode selected: i945lenovo_secondflash
flashrom v0.9.9-unknown on Linux 3.13.0-108-lowlatency (x86_64)
flashrom is free software, get the source code at https://flashrom.org

Calibrating delay loop... OK.
coreboot table found at 0xcbe9f000.
Found chipset "Intel ICH7M".
Enabling flash write... OK.
Found SST flash chip "SST25VF016B" (2048 kB, SPI) mapped at physical address 0x00000000ffe00000.
Reading old flash chip contents... done.
Erasing and writing flash chip... Erase/write done.
Verifying flash... VERIFIED.
bucts utility version 'withoutgit'
Using LPC bridge 8086:27b9 at 0000:1f.00
Current BUC.TS=1 - 64kb address ranges at 0xFFFE0000 and 0xFFFF0000 are swapped
Updated BUC.TS=0 - 128kb address range 0xFFFE0000-0xFFFFFFFF is untranslated
staf@petronella:~/libreboot/libreboot_r20160907_src$ 
</code></pre>

<p>The installation is completed! Reboot our system and enjoy your Free As In Freedom Laptop.</p>

<p><img class="centre" src="/images/x60_free.jpg" width="750" height="853" title="&ldquo;Thinkpad x60 open&rdquo;" ></p>

<p style="font-style: italic;">
Have fun
</p>


<h1>Links</h1>

<ul>
<li><a href="https://www.libreboot.org"><a href="https://www.libreboot.org">https://www.libreboot.org</a></a></li>
<li><a href="https://libreboot.org/docs/install/#rom"><a href="https://libreboot.org/docs/install/#rom">https://libreboot.org/docs/install/#rom</a></a></li>
<li><a href="https://www.coreboot.org/Board:lenovo/x60/Installation"><a href="https://www.coreboot.org/Board:lenovo/x60/Installation">https://www.coreboot.org/Board:lenovo/x60/Installation</a></a></li>
<li><a href="http://www.linuxjournal.com/content/libreboot-x60-part-ii-installation"><a href="http://www.linuxjournal.com/content/libreboot-x60-part-ii-installation">http://www.linuxjournal.com/content/libreboot-x60-part-ii-installation</a></a></li>
</ul>

]]></content>
  </entry>
  
</feed>
