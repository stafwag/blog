
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Bacula on FreeBSD (Part 2 Bacula Catalog Over SSL ) - stafwag Blog</title>
  <meta name="author" content="staf wagemakers">

  
  <meta name="description" content="Bacula on FreeBSD (Part 2 Bacula Catalog Over SSL ) Sep 9th, 2017 10:27 am In my previous post, I setup on my PostgresSQL FreeBSD jail, In this post &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://stafwag.github.io/blog/blog/2017/09/09/bacula-on-freebsd-part2/">
  <link href="/blog/favicon.png" rel="icon">
  <link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/blog/atom.xml" rel="alternate" title="stafwag Blog" type="application/atom+xml">
  <script src="/blog/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/blog/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37258385-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/blog/">stafwag Blog</a></h1>
  
    <h2>staf wagemakers blog</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/blog/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="stafwag.github.io/blog">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/">Blog</a></li>
  <li><a href="/blog/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Bacula on FreeBSD (Part 2 Bacula Catalog Over SSL )</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-09-09T10:27:03+02:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>10:27 am</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p><img class="right" src="/blog/images/postgressl.png" width="300" height="300" title="&#34;PostgreSSL&#34;" alt="&#34;PostgreSSL&#34;"></p>

<p>In my previous <a href="http://stafwag.github.io/blog/blog/2017/08/06/bacula-on-freebsd:w_part1/">post</a>, I setup on my <a href="https://www.postgresql.org/">PostgresSQL</a> <a href="https://en.wikipedia.org/wiki/FreeBSD_jail">FreeBSD jail</a>, In this post we continue with the bacaula server.</p>

<p>In this post we will continue with the database connection (Catalog) we&rsquo;ll go the extra <del>mile</del> 1,609344 km and encrypt the catalog connection with ssl. Why? <strong><em>We encrypt.. because we can!</em></strong></p>

<h1>Bacula Components</h1>

<ul>
<li><p><strong>Bacula Director</strong> <br />
The Bacula Director is daemon that runs in the backgroud that control all backup operations.</p></li>
<li><p><strong>Bacula Console</strong> <br />
The Bacula console is an administrator program that allows an system administrator to control the Bacula director.</p></li>
<li><p><strong>Bacula File</strong> <br />
The Bacula File is a backup client install on the backup client.</p></li>
<li><p><strong>Bacula Storage</strong> <br />
The backup media.</p></li>
<li><p><strong>Catalog</strong> <br />
The Catalog is the index of the backups. Bacula supports three types of index databases mySQL ( <a href="https://mariadb.org/">mariaDB</a>), <a href="https://www.postgresql.org/">PostgreSQL</a> and <a href="https://sqlite.org/">SQLite</a></p></li>
<li><p><strong>Bacula monitor</strong> <br />
A Bacula monitor service is a program that allows the system administrator to cerify the status of the bacula Directors, Bacula File Daemons and Bacula Storage Daemons.</p></li>
</ul>


<h1>Bacula Server</h1>

<h2>Jail</h2>

<h3>Create the Bacula Server Jail</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # ezjail-admin create stafbacula "em0|192.168.1.52"
</span><span class='line'>Warning: Some services already seem to be listening on all IP, (including 192.168.1.52)
</span><span class='line'>  This may cause some confusion, here they are:
</span><span class='line'>root     ntpd       754   20 udp6   *:123                 *:*
</span><span class='line'>root     ntpd       754   21 udp4   *:123                 *:*
</span><span class='line'>root     rpc.statd  717   4  udp6   *:846                 *:*
</span><span class='line'>root     rpc.statd  717   5  tcp6   *:846                 *:*
</span><span class='line'>root     rpc.statd  717   6  udp4   *:846                 *:*
</span><span class='line'>root     rpc.statd  717   7  tcp4   *:846                 *:*
</span><span class='line'>root     nfsd       713   5  tcp4   *:2049                *:*
</span><span class='line'>root     nfsd       713   6  tcp6   *:2049                *:*
</span><span class='line'>root     mountd     707   5  udp6   *:823                 *:*
</span><span class='line'>root     mountd     707   6  tcp6   *:823                 *:*
</span><span class='line'>root     mountd     707   7  udp4   *:823                 *:*
</span><span class='line'>root     mountd     707   8  tcp4   *:823                 *:*
</span><span class='line'>root     rpcbind    676   6  udp6   *:111                 *:*
</span><span class='line'>root     rpcbind    676   7  udp6   *:779                 *:*
</span><span class='line'>root     rpcbind    676   8  tcp6   *:111                 *:*
</span><span class='line'>root     rpcbind    676   9  udp4   *:111                 *:*
</span><span class='line'>root     rpcbind    676   10 udp4   *:768                 *:*
</span><span class='line'>root     rpcbind    676   11 tcp4   *:111                 *:*
</span><span class='line'>root     syslogd    656   6  udp6   *:514                 *:*
</span><span class='line'>root     syslogd    656   7  udp4   *:514                 *:*
</span><span class='line'>root@rataplan:~ # </span></code></pre></td></tr></table></div></figure>


<h3>Start the jail</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # ezjail-admin start stafbacula
</span><span class='line'>Starting jails: stafbacula.
</span><span class='line'>/etc/rc.d/jail: WARNING: Per-jail configuration via jail_* variables  is obsolete.  Please consider migrating to /etc/jail.conf.
</span><span class='line'>root@rataplan:~ # </span></code></pre></td></tr></table></div></figure>


<h3>Open the console</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # ezjail-admin console stafbacula
</span><span class='line'>FreeBSD 11.1-RELEASE-p1 (GENERIC) #0: Wed Sep  9 11:55:48 UTC 2017
</span><span class='line'>
</span><span class='line'>Welcome to FreeBSD!
</span><span class='line'>
</span><span class='line'>Release Notes, Errata: https://www.FreeBSD.org/releases/
</span><span class='line'>Security Advisories:   https://www.FreeBSD.org/security/
</span><span class='line'>FreeBSD Handbook:      https://www.FreeBSD.org/handbook/
</span><span class='line'>FreeBSD FAQ:           https://www.FreeBSD.org/faq/
</span><span class='line'>Questions List: https://lists.FreeBSD.org/mailman/listinfo/freebsd-questions/
</span><span class='line'>FreeBSD Forums:        https://forums.FreeBSD.org/
</span><span class='line'>
</span><span class='line'>Documents installed with the system are in the /usr/local/share/doc/freebsd/
</span><span class='line'>directory, or can be installed later with:  pkg install en-freebsd-doc
</span><span class='line'>For other languages, replace "en" with a language code like de or fr.
</span><span class='line'>
</span><span class='line'>Show the version of FreeBSD installed:  freebsd-version ; uname -a
</span><span class='line'>Please include that output and any error messages when posting questions.
</span><span class='line'>Introduction to manual pages:  man man
</span><span class='line'>FreeBSD directory layout:      man hier
</span><span class='line'>
</span><span class='line'>Edit /etc/motd to change this login announcement.
</span><span class='line'>root@stafbacula:~ # </span></code></pre></td></tr></table></div></figure>


<h2>Bacula installation</h2>

<h3>Install pkg</h3>

<p>Set up dns</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafbacula:~ # vi /etc/resolv.conf</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>nameserver 192.168.1.1</span></code></pre></td></tr></table></div></figure>


<p>Bootstrap pkg</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafbacula:~ # pkg
</span><span class='line'>The package management tool is not yet installed on your system.
</span><span class='line'>Do you want to fetch and install it now? [y/N]: y
</span><span class='line'>Bootstrapping pkg from pkg+http://pkg.FreeBSD.org/FreeBSD:11:amd64/quarterly, please wait...
</span><span class='line'>Verifying signature with trusted certificate pkg.freebsd.org.2013102301... done
</span><span class='line'>[stafbacula] Installing pkg-1.10.1...
</span><span class='line'>[stafbacula] Extracting pkg-1.10.1: 100%
</span><span class='line'>pkg: not enough arguments
</span><span class='line'>Usage: pkg [-v] [-d] [-l] [-N] [-j &lt;jail name or id&gt;|-c &lt;chroot path&gt;|-r &lt;rootdir&gt;] [-C &lt;configuration file&gt;] [-R &lt;repo config dir&gt;] [-o var=value] [-4|-6] &lt;command&gt; [&lt;args&gt;]
</span><span class='line'>
</span><span class='line'>For more information on available commands and options see 'pkg help'.
</span><span class='line'>root@stafbacula:~ # </span></code></pre></td></tr></table></div></figure>


<p>Install the bacula server package</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafbacula:~ # pkg install bacula-server
</span><span class='line'>Updating FreeBSD repository catalogue...
</span><span class='line'>FreeBSD repository is up to date.
</span><span class='line'>All repositories are up to date.
</span><span class='line'>Updating database digests format: 100%
</span><span class='line'>The following 8 package(s) will be affected (of 0 checked):
</span><span class='line'>
</span><span class='line'>New packages to be INSTALLED:
</span><span class='line'>        bacula-server: 7.4.7_1
</span><span class='line'>        bacula-client: 7.4.7_1
</span><span class='line'>        readline: 7.0.3
</span><span class='line'>        indexinfo: 0.2.6
</span><span class='line'>        gettext-runtime: 0.19.8.1_1
</span><span class='line'>        lzo2: 2.10_1
</span><span class='line'>        postgresql95-client: 9.5.7_1
</span><span class='line'>        perl5: 5.24.1_1
</span><span class='line'>
</span><span class='line'>Number of packages to be installed: 8
</span><span class='line'>
</span><span class='line'>The process will require 69 MiB more space.
</span><span class='line'>17 MiB to be downloaded.
</span><span class='line'>
</span><span class='line'>Proceed with this action? [y/N]: y
</span><span class='line'>[stafbacula] [1/8] Fetching bacula-server-7.4.7_1.txz: 100%  678 KiB 694.6kB/s    00:01    
</span><span class='line'>[stafbacula] [2/8] Fetching bacula-client-7.4.7_1.txz: 100%  286 KiB 292.8kB/s    00:01    
</span><span class='line'>[stafbacula] [3/8] Fetching readline-7.0.3.txz: 100%  334 KiB 342.4kB/s    00:01    
</span><span class='line'>[stafbacula] [4/8] Fetching indexinfo-0.2.6.txz: 100%    5 KiB   5.3kB/s    00:01    
</span><span class='line'>[stafbacula] [5/8] Fetching gettext-runtime-0.19.8.1_1.txz: 100%  148 KiB 151.1kB/s    00:01    
</span><span class='line'>[stafbacula] [6/8] Fetching lzo2-2.10_1.txz: 100%  113 KiB 115.4kB/s    00:01    
</span><span class='line'>[stafbacula] [7/8] Fetching postgresql95-client-9.5.7_1.txz: 100%    2 MiB 772.9kB/s    00:03    
</span><span class='line'>[stafbacula] [8/8] Fetching perl5-5.24.1_1.txz: 100%   13 MiB 874.0kB/s    00:16    
</span><span class='line'>Checking integrity... done (0 conflicting)
</span><span class='line'>[stafbacula] [1/8] Installing indexinfo-0.2.6...
</span><span class='line'>[stafbacula] [1/8] Extracting indexinfo-0.2.6: 100%
</span><span class='line'>[stafbacula] [2/8] Installing readline-7.0.3...
</span><span class='line'>[stafbacula] [2/8] Extracting readline-7.0.3: 100%
</span><span class='line'>[stafbacula] [3/8] Installing gettext-runtime-0.19.8.1_1...
</span><span class='line'>[stafbacula] [3/8] Extracting gettext-runtime-0.19.8.1_1: 100%
</span><span class='line'>[stafbacula] [4/8] Installing lzo2-2.10_1...
</span><span class='line'>[stafbacula] [4/8] Extracting lzo2-2.10_1: 100%
</span><span class='line'>[stafbacula] [5/8] Installing perl5-5.24.1_1...
</span><span class='line'>[stafbacula] [5/8] Extracting perl5-5.24.1_1: 100%
</span><span class='line'>[stafbacula] [6/8] Installing bacula-client-7.4.7_1...
</span><span class='line'>===&gt; Creating groups.
</span><span class='line'>Creating group 'bacula' with gid '910'.
</span><span class='line'>===&gt; Creating users
</span><span class='line'>Creating user 'bacula' with uid '910'.
</span><span class='line'>[stafbacula] [6/8] Extracting bacula-client-7.4.7_1: 100%
</span><span class='line'>[stafbacula] [7/8] Installing postgresql95-client-9.5.7_1...
</span><span class='line'>[stafbacula] [7/8] Extracting postgresql95-client-9.5.7_1: 100%
</span><span class='line'>[stafbacula] [8/8] Installing bacula-server-7.4.7_1...
</span><span class='line'>===&gt; Creating groups.
</span><span class='line'>Using existing group 'bacula'.
</span><span class='line'>===&gt; Creating users
</span><span class='line'>Using existing user 'bacula'.
</span><span class='line'>[stafbacula] Extracting bacula-server-7.4.7_1: 100%
</span><span class='line'>Message from perl5-5.24.1_1:
</span><span class='line'>The /usr/bin/perl symlink has been removed starting with Perl 5.20.
</span><span class='line'>For shebangs, you should either use:
</span><span class='line'>
</span><span class='line'>#!/usr/local/bin/perl
</span><span class='line'>
</span><span class='line'>or
</span><span class='line'>
</span><span class='line'>#!/usr/bin/env perl
</span><span class='line'>
</span><span class='line'>The first one will only work if you have a /usr/local/bin/perl,
</span><span class='line'>the second will work as long as perl is in PATH.
</span><span class='line'>Message from bacula-client-7.4.7_1:
</span><span class='line'>################################################################################
</span><span class='line'>
</span><span class='line'>NOTE:
</span><span class='line'>Sample files are installed in /usr/local/etc/bacula:
</span><span class='line'>
</span><span class='line'>  bconsole.conf.sample, bacula-fd.conf.sample
</span><span class='line'>
</span><span class='line'>################################################################################
</span><span class='line'>Message from postgresql95-client-9.5.7_1:
</span><span class='line'>The PostgreSQL port has a collection of "side orders":
</span><span class='line'>
</span><span class='line'>postgresql-docs
</span><span class='line'>  For all of the html documentation
</span><span class='line'>
</span><span class='line'>p5-Pg
</span><span class='line'>  A perl5 API for client access to PostgreSQL databases.
</span><span class='line'>
</span><span class='line'>postgresql-tcltk
</span><span class='line'>  If you want tcl/tk client support.
</span><span class='line'>
</span><span class='line'>postgresql-jdbc
</span><span class='line'>  For Java JDBC support.
</span><span class='line'>
</span><span class='line'>postgresql-odbc
</span><span class='line'>  For client access from unix applications using ODBC as access
</span><span class='line'>  method. Not needed to access unix PostgreSQL servers from Win32
</span><span class='line'>  using ODBC. See below.
</span><span class='line'>
</span><span class='line'>ruby-postgres, py-PyGreSQL
</span><span class='line'>  For client access to PostgreSQL databases using the ruby & python
</span><span class='line'>  languages.
</span><span class='line'>
</span><span class='line'>postgresql-plperl, postgresql-pltcl & postgresql-plruby
</span><span class='line'>  For using perl5, tcl & ruby as procedural languages.
</span><span class='line'>
</span><span class='line'>postgresql-contrib
</span><span class='line'>  Lots of contributed utilities, postgresql functions and
</span><span class='line'>  datatypes. There you find pg_standby, pgcrypto and many other cool
</span><span class='line'>  things.
</span><span class='line'>
</span><span class='line'>etc...
</span><span class='line'>Message from bacula-server-7.4.7_1:
</span><span class='line'>###############################################################################
</span><span class='line'>
</span><span class='line'>bacula server was installed
</span><span class='line'>
</span><span class='line'>An auto-changer manipulation script based on FreeBSDs
</span><span class='line'>chio command is included and installed at
</span><span class='line'>
</span><span class='line'>  /usr/local/sbin/chio-bacula
</span><span class='line'>
</span><span class='line'>Please have a look at it if you want to use an
</span><span class='line'>autochanger. You have to configure the usage in
</span><span class='line'>
</span><span class='line'>  /usr/local/etc/bacula/bacula-dir.conf
</span><span class='line'>
</span><span class='line'>Take care of correct permissions for changer and
</span><span class='line'>tape device (e.g. /dev/ch0 and /dev/n[r]sa0) i.e.
</span><span class='line'>they must be accessible by user bacula.
</span><span class='line'>
</span><span class='line'>Due to lack of some features in the FreeBSD tape driver
</span><span class='line'>implementation you MUST add some OS dependent options to
</span><span class='line'>the bacula-sd.conf file:
</span><span class='line'>
</span><span class='line'>  Hardware End of Medium = no;
</span><span class='line'>  Backward Space Record  = no;
</span><span class='line'>  Backward Space File    = no;
</span><span class='line'>
</span><span class='line'>With 2 filemarks at EOT (see man mt):
</span><span class='line'>  Fast Forward Space File = no;
</span><span class='line'>  BSF at EOM = yes;
</span><span class='line'>  TWO EOF    = yes;
</span><span class='line'>
</span><span class='line'>With 1 filemarks at EOT (see man mt):
</span><span class='line'>  Fast Forward Space File = yes;
</span><span class='line'>  BSF at EOM = no;
</span><span class='line'>  TWO EOF   = no;
</span><span class='line'>
</span><span class='line'>NOTE: YOU CAN SWITCH EOT model ONLY when starting
</span><span class='line'>      from scratch with EMPTY tapes.
</span><span class='line'>
</span><span class='line'>It is also important that all the scripts accessed
</span><span class='line'>by RunBeforeJob and RunAfterJob will be executed by
</span><span class='line'>the user bacula.  Check your permissions.
</span><span class='line'>
</span><span class='line'>For USB support read the bacula manual. It could be necessary
</span><span class='line'>to configure/compile a new kernel.
</span><span class='line'>
</span><span class='line'>Look at /usr/local/share/bacula/update_bacula_tables for
</span><span class='line'>database update procedure. Details can be found in the
</span><span class='line'>ReleaseNotes
</span><span class='line'>
</span><span class='line'>If you are using sqlite you need to run the make_sqlite_tables script as
</span><span class='line'>the bacula user. Do this using 'sudo su -m bacula'.
</span><span class='line'>
</span><span class='line'>################################################################################
</span><span class='line'>root@stafbacula:~ # </span></code></pre></td></tr></table></div></figure>


<h1>Initialize the bacula catalog</h1>

<p>We&rsquo;ll have a postgreSQL server running in a FreeBSD jail as our catalog (see <a href="http://stafwag.github.io/blog/blog/2017/08/06/bacula-on-freebsd:w_part1/"><a href="http://stafwag.github.io/blog/blog/2017/08/06/bacula-on-freebsd:w_part1/">http://stafwag.github.io/blog/blog/2017/08/06/bacula-on-freebsd:w_part1/</a></a> howto install PostgreSQL into a FreeBSD jail).</p>

<h2>PostgreSQL setup</h2>

<p>The setup below describes howto configure the PostgreSQL catalog with certificate and username/password authentication. This might be overkill the bacula server runs on the same physical host so no data is going out on the network. But I wanted to setup the database conneection as secure as possible and will reuse this setup for my other database connection. We&rsquo;ll setup a &ldquo;self signed&rdquo; root ca for now, but I replace this with my own CA in further.</p>

<h3>PostgreSQL authentication methods</h3>

<p>PostgreSQL support a lot of authentication methods you&rsquo;ll find a description of the supported of the support authentication methods below (without too much details):</p>

<ul>
<li><strong>Trust Authentication</strong> <br />
With trust authentication the postgreSQL trust the connection from the remote host, this is the default for localhost host connection and &ldquo;socket&rdquo; connections.
<br />&nbsp;<br /></li>
<li><strong>Password Authentication</strong> <br />
Authentication with login/password
<br />&nbsp;<br /></li>
<li><strong>GSSAPI Authentication</strong> <br />
Authentication with the <a href="https://en.wikipedia.org/wiki/Generic_Security_Services_Application_Program_Interface">Generic Security Services Application Program Interface</a>
<br />&nbsp;<br /></li>
<li><strong>SSPI Authentication</strong> <br />
Authentication with the <a href="https://en.wikipedia.org/wiki/Security_Support_Provider_Interface"">Security Support Provider Interface</a> - SSPI is a proprietary variant of GSSAPI with extensions and very Windows-specific data types -
<br />&nbsp;<br /></li>
<li><strong>Kerberos Authentication</strong> <br />
Authentication using the <a href="https://en.wikipedia.org/wiki/Kerberos_(protocol)">Kerberos protocol</a>
<br />&nbsp;<br /></li>
<li><strong>Ident Authentication</strong> <br />
Authentication using the <a href="https://en.wikipedia.org/wiki/Ident_protocol">ident protocol</a>
<br />&nbsp;<br /></li>
<li><strong>Peer Authentication</strong> <br />
Authentication using the <a href="https://www.freebsd.org/cgi/man.cgi?query=getpeereid">getpeereid()</a> kernel function, only supported for local connection on BSD, MacOS and GNU/Linux.
<br />&nbsp;<br /></li>
<li><strong>LDAP Authentication</strong> <br />
<a href="https://en.wikipedia.org/wiki/Lightweight_Directory_Access_Protocol">LDAP</a> authentication.</a>
<br />&nbsp;<br /></li>
<li><strong>RADIUS Authentication</strong> <br />
<a href="https://en.wikipedia.org/wiki/RADIUS">Radius</a> authentication.
<br />&nbsp;<br /></li>
<li><strong>Certificate Authentication</strong> <br />
Authentication with a <a href="https://en.wikipedia.org/wiki/Public_key_infrastructure">PKI certificate</a>.
<br />&nbsp;<br /></li>
<li><strong>PAM Authentication</strong> <br />
<a href="https://en.wikipedia.org/wiki/Pluggable_authentication_module">PAM</a> based authentication</a>
<br />&nbsp;<br />
<br />&nbsp;<br />
I wanted to use password authentication over ssl with a client certificate.
The bacula documents isn&rsquo;t very clear on howto configure it. After a quick lot at the bacula source code it should be supported, so let&rsquo;s give it a try&hellip;</li>
</ul>


<h3>Configure the PostgreSQL jail</h3>

<h4>Allow network connections</h4>

<p>Logon the postgreSQL server jail move to the postgreSQL data directory and edit postgresql.conf to allow TCP/IP connections.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafdb:/var/db/postgres/data96 # pwd
</span><span class='line'>/var/db/postgres/data96
</span><span class='line'>root@stafdb:/var/db/postgres/data96 # vim postgresql.conf</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># - Connection Settings -
</span><span class='line'>
</span><span class='line'>listen_addresses = '192.168.1.51'               # what IP address(es) to listen on;
</span><span class='line'># listen_addresses = 'localhost'                # what IP address(es) to listen on;
</span><span class='line'>                                        # comma-separated list of addresses;
</span><span class='line'>                                        # defaults to 'localhost'; use '*' for all
</span><span class='line'>                                        # (change requires restart)
</span><span class='line'>#port = 5432                            # (change requires restart)
</span></code></pre></td></tr></table></div></figure>


<h4>SSL encryption</h4>

<p>It&rsquo;s always a good idea to encrypt your connections.</p>

<h5>SSL Server setup</h5>

<h6>Umask</h6>

<p>set the umask to prevent somebody can read you private key.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafdb:/var/db/postgres/data96 # su - postgres
</span><span class='line'>$ umask 077 
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h6>Create a private key</h6>

<p>Create a private key without encrypting it.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl genrsa -out server.key 4096
</span><span class='line'>Generating RSA private key, 4096 bit long modulus
</span><span class='line'>........................................................................................................................................................................................................................++
</span><span class='line'>......++
</span><span class='line'>e is 65537 (0x10001)
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h6>Create a self-signed certificate</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ openssl req -new -key server.key -days 3650 -out server.crt -x509 -subj '/C=BE/ST=Flanders/L=Antwerp/O=stafnet/CN=stafdb'
</span><span class='line'>$ ls -ltr                                                                                               total 23
</span><span class='line'>-rw-------   1 postgres  postgres  3247 Sep  9 11:47 server.key
</span><span class='line'>-rw-------   1 postgres  postgres  1964 Sep  9 11:52 server.crt
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h6>Root ca</h6>

<p>We created a self signed certificate so the server certificate is our trusted ca root.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ln -s server.crt root.crt
</span><span class='line'>$ ls -ltr
</span><span class='line'>total 24
</span><span class='line'>-rw-------   1 postgres  postgres  3247 Sep  9 11:47 server.key
</span><span class='line'>-rw-------   1 postgres  postgres  1964 Sep  9 11:52 server.crt
</span><span class='line'>lrwx------   1 postgres  postgres    10 Sep  9 11:53 root.crt -&gt; server.crt
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h6>Enable ssl</h6>

<p>Edit postgresql.conf and  update the ssl setting</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vi postgresql.conf
</span></code></pre></td></tr></table></div></figure>


<p>By default ssl_ca_file is not set but this directive is required so don&rsquo;t forget to set it.
We disable the 3DES ciphers they&rsquo;re obsolete&hellip; We don&rsquo;t speficy a crl for now.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#authentication_timeout = 1min          # 1s-600s
</span><span class='line'>ssl = on                                # (change requires restart)
</span><span class='line'>ssl_ciphers = 'HIGH:MEDIUM:!3DES:!aNULL' # allowed SSL ciphers
</span><span class='line'>                                        # (change requires restart)
</span><span class='line'>ssl_prefer_server_ciphers = on          # (change requires restart)
</span><span class='line'>#ssl_ecdh_curve = 'prime256v1'          # (change requires restart)
</span><span class='line'>ssl_cert_file = 'server.crt'            # (change requires restart)
</span><span class='line'>ssl_key_file = 'server.key'             # (change requires restart)
</span><span class='line'>ssl_ca_file = 'root.crt'                        # (change requires restart)
</span><span class='line'>#ssl_crl_file = ''                      # (change requires restart)
</span><span class='line'>#password_encryption = on</span></code></pre></td></tr></table></div></figure>


<h5>SSL Client setup</h5>

<h6>Become bacula</h6>

<p>Logon to the bacula jail and become the bacula user. We use &ldquo;su -m &hellip;&rdquo; to logon to the locked daemon account, this will take over the root environment.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # ezjail-admin console stafbacula
</span><span class='line'>Last login: Wed Sep  9 09:33:16 on pts/0
</span><span class='line'>FreeBSD 11.1-RELEASE-p1 (GENERIC) #0: Wed Sep  9 11:55:48 UTC 2017
</span><span class='line'>
</span><span class='line'>Welcome to FreeBSD!
</span><span class='line'>
</span><span class='line'>Release Notes, Errata: https://www.FreeBSD.org/releases/
</span><span class='line'>Security Advisories:   https://www.FreeBSD.org/security/
</span><span class='line'>FreeBSD Handbook:      https://www.FreeBSD.org/handbook/
</span><span class='line'>FreeBSD FAQ:           https://www.FreeBSD.org/faq/
</span><span class='line'>Questions List: https://lists.FreeBSD.org/mailman/listinfo/freebsd-questions/
</span><span class='line'>FreeBSD Forums:        https://forums.FreeBSD.org/
</span><span class='line'>
</span><span class='line'>Documents installed with the system are in the /usr/local/share/doc/freebsd/
</span><span class='line'>directory, or can be installed later with:  pkg install en-freebsd-doc
</span><span class='line'>For other languages, replace "en" with a language code like de or fr.
</span><span class='line'>
</span><span class='line'>Show the version of FreeBSD installed:  freebsd-version ; uname -a
</span><span class='line'>Please include that output and any error messages when posting questions.
</span><span class='line'>Introduction to manual pages:  man man
</span><span class='line'>FreeBSD directory layout:      man hier
</span><span class='line'>
</span><span class='line'>Edit /etc/motd to change this login announcement.
</span><span class='line'>You have new mail.
</span><span class='line'>root@stafbacula:~ # su -m bacula -c "/bin/sh"
</span><span class='line'>$ id
</span><span class='line'>uid=910(bacula) gid=910(bacula) groups=910(bacula)
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h6>umask</h6>

<p>Set the umask to prevent somebody can read you private key.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ umask 077
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h6>move to the bacula home directory</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat /etc/passwd | grep bacula
</span><span class='line'>bacula:*:910:910:Bacula Daemon:/var/db/bacula:/usr/sbin/nologin
</span><span class='line'>$ cd /var/db/bacula</span></code></pre></td></tr></table></div></figure>


<h6>create the .postges directory</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir .postgres
</span><span class='line'>$ ls -la
</span><span class='line'>total 12
</span><span class='line'>drwxrwx---   3 bacula  bacula   3 Sep  9 09:41 .
</span><span class='line'>drwxr-xr-x  14 root    wheel   18 Sep  9 14:41 ..
</span><span class='line'>drwx------   2 bacula  bacula   2 Sep  9 09:41 .postgres
</span><span class='line'>$ cd .postgres/
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h6>Create a private key</h6>

<p>We took over the root evironment therefor we need to set the RANDFILE variable to randfile in the bacula home directory.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ pwd
</span><span class='line'>/var/db/bacula/.postgres
</span><span class='line'>$ export RANDFILE=/var/db/bacula/.rnd
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<p>Create the private key.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ openssl genrsa -out `hostname`.key 4096
</span><span class='line'>Generating RSA private key, 4096 bit long modulus
</span><span class='line'>..........++
</span><span class='line'>.......................................................++
</span><span class='line'>e is 65537 (0x10001)
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h6>Create the client csr</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ openssl req -new -key stafbacula.key -out stafbacula.csr -subj '/C=BE/ST=Flanders/L=Antwerp/O=stafnet/CN=stafbacula'
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h6>Create the client certifocate</h6>

<p>Logon to the postgreSQL jail as postgres and sign the client csr.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[postgres@stafdb ~/data96]$ openssl x509 -req -in stafbacula.csr -CAcreateserial -CA root.crt -CAkey server.key -out stafbacula.crt 
</span><span class='line'>Signature ok
</span><span class='line'>subject=/C=BE/ST=Flanders/L=Antwerp/O=stafnet/CN=stafbacula
</span><span class='line'>Getting CA Private Key
</span><span class='line'>[postgres@stafdb ~/data96]$ 
</span></code></pre></td></tr></table></div></figure>


<h5>Copy the client certificate and the trusted root certificate to bacula jail</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ uname -a
</span><span class='line'>FreeBSD stafbacula 11.1-RELEASE-p1 FreeBSD 11.1-RELEASE-p1 #0: Wed Sep  9 11:55:48 UTC 2017     root@amd64-builder.daemonology.net:/usr/obj/usr/src/sys/GENERIC  amd64
</span><span class='line'>$ pwd
</span><span class='line'>/var/db/bacula/.postgres
</span><span class='line'>$ ls -ltr
</span><span class='line'>total 24
</span><span class='line'>-rw-------  1 bacula  bacula  3243 Sep  9 09:47 stafbacula.key
</span><span class='line'>-rw-------  1 bacula  bacula  1679 Sep  9 09:54 stafbacula.csr
</span><span class='line'>-rw-------  1 bacula  bacula  1964 Sep  9 10:04 root.crt
</span><span class='line'>-rw-------  1 bacula  bacula  1850 Sep  9 10:06 stafbacula.crt
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h4>Host file on the bacula jail</h4>

<p>The hostname of the posgresql jail has to match with the CN of the server certificate. So we&rsquo;ll add the hostname to /etc/hosts</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafbacula:~ # vi /etc/hosts</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>192.168.1.51    stafdb</span></code></pre></td></tr></table></div></figure>


<h2>Setup the bacula database</h2>

<h4>Create the bacula database user</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[postgres@stafdb ~/data96]$ id
</span><span class='line'>uid=770(postgres) gid=770(postgres) groups=770(postgres)
</span><span class='line'>[postgres@stafdb ~/data96]$ psql postgres
</span><span class='line'>psql (9.6.3)
</span><span class='line'>Type "help" for help.
</span><span class='line'>
</span><span class='line'>postgres=# create user bacula WITH PASSWORD 'xxxxxx';
</span><span class='line'>CREATE ROLE
</span><span class='line'>postgres=# </span></code></pre></td></tr></table></div></figure>


<p>To update the user password;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>postgres=# alter user bacula PASSWORD 'yyyyyyy';
</span><span class='line'>ALTER ROLE
</span><span class='line'>postgres=# </span></code></pre></td></tr></table></div></figure>


<p>You can view the new permissions in the pg_user table or by execute the \du (describe user shortcut), by default the user has minimal permissions.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>postgres=# select * from pg_user where usename = 'bacula';
</span><span class='line'> usename | usesysid | usecreatedb | usesuper | userepl | usebypassrls |  passwd  | valuntil | useconfig 
</span><span class='line'>---------+----------+-------------+----------+---------+--------------+----------+----------+-----------
</span><span class='line'> bacula  |    16386 | f           | f        | f       | f            | ******** |          | 
</span><span class='line'>(1 row)
</span><span class='line'>
</span><span class='line'>postgres=# 
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>postgres=# \du
</span><span class='line'>                                   List of roles
</span><span class='line'> Role name |                         Attributes                         | Member of 
</span><span class='line'>-----------+------------------------------------------------------------+-----------
</span><span class='line'> bacula    |                                                            | {}
</span><span class='line'> postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS | {}
</span><span class='line'>
</span><span class='line'>postgres=# </span></code></pre></td></tr></table></div></figure>


<h3>Allow the bacula user to create databases</h3>

<p>The bacula database script will try to create the bacula catalog database.
We&rsquo;ll allow the bacula user to create databases,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>postgres=# alter user bacula CREATEDB;
</span><span class='line'>ALTER ROLE
</span><span class='line'>postgres=# select * from pg_user where usename = 'bacula';
</span><span class='line'> usename | usesysid | usecreatedb | usesuper | userepl | usebypassrls |  passwd  | valuntil | useconfig 
</span><span class='line'>---------+----------+-------------+----------+---------+--------------+----------+----------+-----------
</span><span class='line'> bacula  |    16386 | t           | f        | f       | f            | ******** |          | 
</span><span class='line'>(1 row)
</span><span class='line'>
</span><span class='line'>postgres=# \du
</span><span class='line'>                                   List of roles
</span><span class='line'> Role name |                         Attributes                         | Member of 
</span><span class='line'>-----------+------------------------------------------------------------+-----------
</span><span class='line'> bacula    | Create DB                                                  | {}
</span><span class='line'> postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS | {}
</span><span class='line'>
</span><span class='line'>postgres=# </span></code></pre></td></tr></table></div></figure>


<h3>Create the bacula database</h3>

<p>We&rsquo;ll create a bacula database so we can verify the database connection from the bacula user to the bacula database.</p>

<p>Create a new bacula database</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>postgres=# create database bacula;
</span><span class='line'>CREATE DATABASE
</span><span class='line'>postgres=# </span></code></pre></td></tr></table></div></figure>


<p>Grant all permissions to the bacula user</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>postgres=# grant ALL on DATABASE bacula to bacula;
</span><span class='line'>GRANT
</span><span class='line'>postgres=# </span></code></pre></td></tr></table></div></figure>


<h2>Update pg_hba</h2>

<p>The pg_hba.conf configuration controls the <strong>H</strong>ost <strong>B</strong>ased <strong>A</strong>ccess to your postgreSQL database(s).</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[postgres@stafdb ~/data96]$ pwd
</span><span class='line'>/var/db/postgres/data96
</span><span class='line'>[postgres@stafdb ~/data96]$ id
</span><span class='line'>uid=770(postgres) gid=770(postgres) groups=770(postgres)
</span><span class='line'>[postgres@stafdb ~/data96]$ vi pg_hba.conf </span></code></pre></td></tr></table></div></figure>


<p>And add the next lines;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># TYPE  DATABASE        USER            ADDRESS                 METHOD
</span><span class='line'>hostssl bacula          bacula          192.168.1.52/32         md5 clientcert=1
</span><span class='line'>hostssl template0       bacula          192.168.1.52/32         md5 clientcert=1
</span><span class='line'>hostssl template1       bacula          192.168.1.52/32         md5 clientcert=1
</span><span class='line'>hostssl postgres        bacula          192.168.1.52/32         md5 clientcert=1</span></code></pre></td></tr></table></div></figure>


<p>Our bacula jail <strong><em>192.168.1.52</em></strong> only needs to have to the <strong><em>bacula</em></strong> database with the <strong><em>bacula</em></strong> user over ssl <strong><em>hostssl</em></strong> passwords will be send as a <strong><em>md5</em></strong> hash and a client certificate is required <strong><em>clientcert=1</em></strong>.</p>

<p>We could also used the <strong><em>cert</em></strong> method and <strong><em>map</em></strong> the client certificate to postgresql user so we could authenticate with the client certificate only&hellip;</p>

<p>We allow access to the template* and the postgres database because it&rsquo;s required for the bacula database xcreate script. We can remove them ( only allow access to the bacula database ) after the catalog database is created.</p>

<h2>Restart postgresql</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafdb:/var/db/postgres/data96 # service postgresql restart
</span><span class='line'>DEBUG:  postgres: PostmasterMain: initial environment dump:
</span><span class='line'>DEBUG:  -----------------------------------------
</span><span class='line'>DEBUG:          LC_TIME=C
</span><span class='line'>DEBUG:          LC_NUMERIC=C
</span><span class='line'>DEBUG:          LC_MONETARY=C
</span><span class='line'>DEBUG:          LC_MESSAGES=C
</span><span class='line'>DEBUG:          LC_CTYPE=C
</span><span class='line'>DEBUG:          LC_COLLATE=C
</span><span class='line'>DEBUG:          MAIL=/var/mail/postgres
</span><span class='line'>DEBUG:          PGLOCALEDIR=/usr/local/share/locale
</span><span class='line'>DEBUG:          PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin:/var/db/postgres/bin
</span><span class='line'>DEBUG:          PGDATA=/var/db/postgres/data96
</span><span class='line'>DEBUG:          PWD=/var/db/postgres
</span><span class='line'>DEBUG:          PGSYSCONFDIR=/usr/local/etc/postgresql
</span><span class='line'>DEBUG:          HOME=/var/db/postgres
</span><span class='line'>DEBUG:          USER=postgres
</span><span class='line'>DEBUG:          SHELL=/bin/sh
</span><span class='line'>DEBUG:          PG_GRANDPARENT_PID=79045
</span><span class='line'>DEBUG:          BLOCKSIZE=K
</span><span class='line'>DEBUG:  -----------------------------------------
</span><span class='line'>LOG:  could not create IPv6 socket: Protocol not supported
</span><span class='line'>LOG:  could not bind IPv4 socket: Address already in use
</span><span class='line'>HINT:  Is another postmaster already running on port 5432? If not, wait a few seconds and retry.
</span><span class='line'>WARNING:  could not create listen socket for "192.168.1.51"
</span><span class='line'>DEBUG:  invoking IpcMemoryCreate(size=148480000)
</span><span class='line'>DEBUG:  SlruScanDirectory invoking callback on pg_notify/0000
</span><span class='line'>DEBUG:  removing file "pg_notify/0000"
</span><span class='line'>DEBUG:  dynamic shared memory system will support 288 segments
</span><span class='line'>DEBUG:  created dynamic shared memory control segment 773439544 (2316 bytes)
</span><span class='line'>DEBUG:  max_safe_fds = 984, usable_fds = 1000, already_open = 6
</span><span class='line'>LOG:  ending log output to stderr
</span><span class='line'>HINT:  Future log output will go to log destination "syslog".
</span><span class='line'>DEBUG:  CommitTransaction
</span><span class='line'>DEBUG:  name: unnamed; blockState:       STARTED; state: INPROGR, xid/subid/cid: 0/1/0, nestlvl: 1, children: 
</span><span class='line'>root@stafdb:/var/db/postgres/data96 #
</span></code></pre></td></tr></table></div></figure>


<h2>Test the database connection</h2>

<h3>Verify</h3>

<p>Verify the database connection for the bacula jail. See <a href="https://www.postgresql.org/docs/9.6/static/libpq-connect.html"><a href="https://www.postgresql.org/docs/9.6/static/libpq-connect.html">https://www.postgresql.org/docs/9.6/static/libpq-connect.html</a></a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[bacula@stafbacula /var/db/bacula/.postgres]$ psql "sslmode=verify-full host=stafdb dbname=bacula sslcert=`pwd`/postgresql.crt sslkey=`pwd`/postgresql.key sslrootcert=`pwd`/root.crt"
</span><span class='line'>Password:
</span><span class='line'>DEBUG:  CommitTransaction
</span><span class='line'>DEBUG:  name: unnamed; blockState:       STARTED; state: INPROGR, xid/subid/cid: 0/1/0, nestlvl: 1, children:
</span><span class='line'>psql (9.5.7, server 9.6.3)
</span><span class='line'>WARNING: psql major version 9.5, server major version 9.6.
</span><span class='line'>         Some psql features might not work.
</span><span class='line'>SSL connection (protocol: TLSv1.2, cipher: ECDHE-RSA-AES256-GCM-SHA384, bits: 256, compression: off)
</span><span class='line'>Type "help" for help.
</span><span class='line'>bacula=&gt;</span></code></pre></td></tr></table></div></figure>


<h3>Create environment script</h3>

<p>Bacula comes with a few scripts to popilate the catalog we will create an &ldquo;environment&rdquo; script to setup the required environment variabeles to connect to the database. <a href="https://www.postgresql.org/docs/9.6/static/libpq-envars.html"><a href="https://www.postgresql.org/docs/9.6/static/libpq-envars.html">https://www.postgresql.org/docs/9.6/static/libpq-envars.html</a></a> gives an overview of PostgreSQL environment variabeles.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[bacula@stafbacula /var/db/bacula]$ vi psql_env.sh</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>PGHOST=stafdb
</span><span class='line'>PGUSER=bacula
</span><span class='line'>PGSSLMODE=verify-full
</span><span class='line'>PGSSLCERT=/var/db/bacula/.postgres/postgresql.crt
</span><span class='line'>PGSSLKEY=/var/db/bacula/.postgres/postgresql.key
</span><span class='line'>PGSSLROOTCERT=/var/db/bacula/.postgres/root.crt
</span><span class='line'>
</span><span class='line'>export PGHOST
</span><span class='line'>export PGUSER
</span><span class='line'>export PGSSLMODE
</span><span class='line'>export PGSSLCERT
</span><span class='line'>export PGSSLKEY
</span><span class='line'>export PGSSLROOTCERT</span></code></pre></td></tr></table></div></figure>


<p>Test the environment script</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafbacula:~ # su -m bacula -c /bin/sh
</span><span class='line'>$ . /var/db/bacula/psql_env.sh
</span><span class='line'>$ psql bacula
</span><span class='line'>Password: 
</span><span class='line'>DEBUG:  CommitTransaction
</span><span class='line'>DEBUG:  name: unnamed; blockState:       STARTED; state: INPROGR, xid/subid/cid: 0/1/0, nestlvl: 1, children: 
</span><span class='line'>psql (9.5.8, server 9.6.4)
</span><span class='line'>WARNING: psql major version 9.5, server major version 9.6.
</span><span class='line'>         Some psql features might not work.
</span><span class='line'>SSL connection (protocol: TLSv1.2, cipher: ECDHE-RSA-AES256-GCM-SHA384, bits: 256, compression: off)
</span><span class='line'>Type "help" for help.
</span><span class='line'>
</span><span class='line'>bacula=&gt; </span></code></pre></td></tr></table></div></figure>


<h2>Configure the bacula catalog</h2>

<h3>Configuration directives</h3>

<p>I found the bacula documention not very clear howto setup the catalog connection with certificate authentication - or I looked at the wrong place - so I downloaded the bacula source code ( version 7.4.7 )to verify the required directives. ./src/dird/d/dird_conf.c</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky bacula-7.4.7]$ vim ./src/dird/dird_conf.c</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/*
</span><span class='line'>   Bacula(R) - The Network Backup Solution
</span><span class='line'>
</span><span class='line'>   Copyright (C) 2000-2016 Kern Sibbald
</span><span class='line'>
</span><span class='line'>   The original author of Bacula is Kern Sibbald, with contributions
</span><span class='line'>   from many others, a complete list can be found in the file AUTHORS.
</span><span class='line'>
</span><span class='line'>   You may use this file and others of this release according to the
</span><span class='line'>   license defined in the LICENSE file, which includes the Affero General
</span><span class='line'>   Public License, v3.0 ("AGPLv3") and some additional permissions and
</span><span class='line'>   terms pursuant to its AGPLv3 Section 7.
</span><span class='line'>
</span><span class='line'>   This notice must be preserved when any source code is
</span><span class='line'>   conveyed and/or propagated.
</span><span class='line'>
</span><span class='line'>   Bacula(R) is a registered trademark of Kern Sibbald.
</span><span class='line'>*/
</span><span class='line'>
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>
</span><span class='line'>/*
</span><span class='line'> *    Catalog Resource Directives
</span><span class='line'> *
</span><span class='line'> *   name          handler     value                 code flags    default_value
</span><span class='line'> */
</span><span class='line'>static RES_ITEM cat_items[] = {
</span><span class='line'>   {"Name",     store_name,     ITEM(res_cat.hdr.name),    0, ITEM_REQUIRED, 0},
</span><span class='line'>   {"Description", store_str,   ITEM(res_cat.hdr.desc),    0, 0, 0},
</span><span class='line'>   {"dbaddress", store_str,     ITEM(res_cat.db_address),  0, 0, 0},
</span><span class='line'>   {"Address",  store_str,      ITEM(res_cat.db_address),  0, 0, 0},
</span><span class='line'>   {"DbPort",   store_pint32,   ITEM(res_cat.db_port),      0, 0, 0},
</span><span class='line'>   /* keep this password as store_str for the moment */
</span><span class='line'>   {"dbpassword", store_str,    ITEM(res_cat.db_password), 0, 0, 0},
</span><span class='line'>   {"Password", store_str,      ITEM(res_cat.db_password), 0, 0, 0},
</span><span class='line'>   {"dbuser",   store_str,      ITEM(res_cat.db_user),     0, 0, 0},
</span><span class='line'>   {"User",     store_str,      ITEM(res_cat.db_user),     0, 0, 0},
</span><span class='line'>   {"DbName",   store_str,      ITEM(res_cat.db_name),     0, ITEM_REQUIRED, 0},
</span><span class='line'>   {"dbdriver", store_str,      ITEM(res_cat.db_driver),   0, 0, 0},
</span><span class='line'>   {"DbSocket", store_str,      ITEM(res_cat.db_socket),   0, 0, 0},
</span><span class='line'>   {"dbsslkey", store_str,      ITEM(res_cat.db_ssl_key),  0, 0, 0},
</span><span class='line'>   {"dbsslcert", store_str,     ITEM(res_cat.db_ssl_cert),  0, 0, 0},
</span><span class='line'>   {"dbsslca", store_str,       ITEM(res_cat.db_ssl_ca),  0, 0, 0},
</span><span class='line'>   {"dbsslcapath", store_str,   ITEM(res_cat.db_ssl_capath),  0, 0, 0},
</span><span class='line'>   {"dbsslcipher", store_str,   ITEM(res_cat.db_ssl_cipher),  0, 0, 0},
</span><span class='line'>   /* Turned off for the moment */
</span><span class='line'>   {"MultipleConnections", store_bit, ITEM(res_cat.mult_db_connections), 0, 0, 0},
</span><span class='line'>   {"DisableBatchInsert", store_bool, ITEM(res_cat.disable_batch_insert), 0, ITEM_DEFAULT, false},
</span><span class='line'>   {NULL, NULL, {0}, 0, 0, 0}
</span><span class='line'>};
</span></code></pre></td></tr></table></div></figure>


<p>The ssl directives didn&rsquo;t seem to work with postgresql :-( If we feed the postgresql environment variables with the correct ssl settings to the bacula director it seems to work.</p>

<h2>Initialize the database</h2>

<h3>Drop the existing bacula database</h3>

<p>The bacacla create script will try to create a new bacaula database so we&rsquo;ll to drop or test database on our database server.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafdb:~ # su - postgres
</span><span class='line'>$ psql
</span><span class='line'>psql (9.6.4)
</span><span class='line'>Type "help" for help.
</span><span class='line'>
</span><span class='line'>postgres=# drop database bacula ;
</span><span class='line'>DROP DATABASE
</span><span class='line'>postgres=# \l
</span><span class='line'>                             List of databases
</span><span class='line'>   Name    |  Owner   | Encoding | Collate | Ctype |   Access privileges   
</span><span class='line'>-----------+----------+----------+---------+-------+-----------------------
</span><span class='line'> postgres  | postgres | UTF8     | C       | C     | 
</span><span class='line'> template0 | postgres | UTF8     | C       | C     | =c/postgres          +
</span><span class='line'>           |          |          |         |       | postgres=CTc/postgres
</span><span class='line'> template1 | postgres | UTF8     | C       | C     | =c/postgres          +
</span><span class='line'>           |          |          |         |       | postgres=CTc/postgres
</span><span class='line'>(3 rows)
</span><span class='line'>
</span><span class='line'>postgres=# </span></code></pre></td></tr></table></div></figure>


<h3>Create the database</h3>

<p>Logon the bacula jail and create the bacula database.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ . /var/db/bacula/psql_env.sh
</span><span class='line'>$ ./create_bacula_database
</span><span class='line'>Creating postgresql database
</span><span class='line'>Password: 
</span><span class='line'>Password: 
</span><span class='line'>CREATE DATABASE
</span><span class='line'>ALTER DATABASE
</span><span class='line'>Creation of bacula database succeeded.
</span><span class='line'>Password: 
</span><span class='line'>Password: 
</span><span class='line'>Database encoding OK</span></code></pre></td></tr></table></div></figure>


<h3>Populate the bacula tables</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ./make_bacula_tables 
</span><span class='line'>Making postgresql tables
</span><span class='line'>Password: 
</span><span class='line'>CREATE TABLE
</span><span class='line'>ALTER TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>ALTER TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE TABLE
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>INSERT 0 1
</span><span class='line'>Creation of Bacula PostgreSQL tables succeeded.
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h3>Verify</h3>

<p>Logon the bacula database and verify that the database populated.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ psql
</span><span class='line'>Password: 
</span><span class='line'>psql (9.5.8, server 9.6.4)
</span><span class='line'>WARNING: psql major version 9.5, server major version 9.6.
</span><span class='line'>         Some psql features might not work.
</span><span class='line'>SSL connection (protocol: TLSv1.2, cipher: ECDHE-RSA-AES256-GCM-SHA384, bits: 256, compression: off)
</span><span class='line'>Type "help" for help.
</span><span class='line'>
</span><span class='line'>bacula=&gt; \d
</span><span class='line'>                       List of relations
</span><span class='line'> Schema |               Name                |   Type   | Owner  
</span><span class='line'>--------+-----------------------------------+----------+--------
</span><span class='line'> public | basefiles                         | table    | bacula
</span><span class='line'> public | basefiles_baseid_seq              | sequence | bacula
</span><span class='line'> public | cdimages                          | table    | bacula
</span><span class='line'> public | client                            | table    | bacula
</span><span class='line'> public | client_clientid_seq               | sequence | bacula
</span><span class='line'> public | counters                          | table    | bacula
</span><span class='line'> public | device                            | table    | bacula
</span><span class='line'> public | device_deviceid_seq               | sequence | bacula
</span><span class='line'> public | file                              | table    | bacula
</span><span class='line'> public | file_fileid_seq                   | sequence | bacula
</span><span class='line'> public | filename                          | table    | bacula
</span><span class='line'> public | filename_filenameid_seq           | sequence | bacula
</span><span class='line'> public | fileset                           | table    | bacula
</span><span class='line'> public | fileset_filesetid_seq             | sequence | bacula
</span><span class='line'> public | job                               | table    | bacula
</span><span class='line'> public | job_jobid_seq                     | sequence | bacula
</span><span class='line'> public | jobhisto                          | table    | bacula
</span><span class='line'> public | jobmedia                          | table    | bacula
</span><span class='line'> public | jobmedia_jobmediaid_seq           | sequence | bacula
</span><span class='line'> public | location                          | table    | bacula
</span><span class='line'> public | location_locationid_seq           | sequence | bacula
</span><span class='line'> public | locationlog                       | table    | bacula
</span><span class='line'> public | locationlog_loclogid_seq          | sequence | bacula
</span><span class='line'> public | log                               | table    | bacula
</span><span class='line'> public | log_logid_seq                     | sequence | bacula
</span><span class='line'> public | media                             | table    | bacula
</span><span class='line'> public | media_mediaid_seq                 | sequence | bacula
</span><span class='line'> public | mediatype                         | table    | bacula
</span><span class='line'> public | mediatype_mediatypeid_seq         | sequence | bacula
</span><span class='line'> public | path                              | table    | bacula
</span><span class='line'> public | path_pathid_seq                   | sequence | bacula
</span><span class='line'> public | pathhierarchy                     | table    | bacula
</span><span class='line'> public | pathvisibility                    | table    | bacula
</span><span class='line'> public | pool                              | table    | bacula
</span><span class='line'> public | pool_poolid_seq                   | sequence | bacula
</span><span class='line'> public | restoreobject                     | table    | bacula
</span><span class='line'> public | restoreobject_restoreobjectid_seq | sequence | bacula
</span><span class='line'> public | snapshot                          | table    | bacula
</span><span class='line'> public | snapshot_snapshotid_seq           | sequence | bacula
</span><span class='line'>--More--(byte 2667)</span></code></pre></td></tr></table></div></figure>


<h3>Cleanup</h3>

<p>Disable the access to template? and postgres databases.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafdb:/var/db/postgres/data96 # vi pg_hba.conf</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>host    all             all             ::1/128                 trust
</span><span class='line'>hostssl bacula          bacula          192.168.1.52/32         md5 clientcert=1
</span><span class='line'># hostssl       template0       bacula          192.168.1.52/32         md5 clientcert=1
</span><span class='line'># hostssl       template1       bacula          192.168.1.52/32         md5 clientcert=1
</span><span class='line'># hostssl       postgres        bacula          192.168.1.52/32         md5 clientcert=1</span></code></pre></td></tr></table></div></figure>


<p>Reload</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafdb:/var/db/postgres/data96 # service postgresql reload
</span><span class='line'>root@stafdb:/var/db/postgres/data96 # </span></code></pre></td></tr></table></div></figure>


<p>Test it. Verify that access to the postgres database is denied from the bacula host.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ psql postgres
</span><span class='line'>psql: FATAL:  no pg_hba.conf entry for host "192.168.1.52", user "bacula", database "postgres", SSL on
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h2>Bacula catalog configuration</h2>

<h3>Update the bacula director configuration</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafbacula:/usr/local/etc/bacula # vi bacula-dir.conf</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Generic catalog service
</span><span class='line'>Catalog { 
</span><span class='line'>  Name = MyCatalog
</span><span class='line'>  dbname = "bacula"; dbuser = "bacula"; dbpassword = "********" ; dbsslkey = "/var/db/bacula/.postgres
</span><span class='line'>/postgresql.key"; dbsslcert = "/var/db/bacula/.postgres/postgresql.crt"; dbsslca= "/var/db/bacula/.postgres
</span><span class='line'>/root.crt"
</span><span class='line'>
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>Test the catalog connection</h3>

<p>bacula include a program to verify the bacula catalog &ldquo;dbcheck&rdquo;, the -c switch select the bacula director configuration file the -B switch print out the configuration.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bacula@stafbacula /usr/local]$ dbcheck -c /usr/local/etc/bacula/bacula-dir.conf -B -v
</span><span class='line'>catalog=MyCatalog
</span><span class='line'>db_name=bacula
</span><span class='line'>db_driver=
</span><span class='line'>db_user=bacula
</span><span class='line'>db_password=*******
</span><span class='line'>db_address=stafdb
</span><span class='line'>db_port=0
</span><span class='line'>db_socket=
</span><span class='line'>db_type=PostgreSQL
</span><span class='line'>working_dir=/var/db/bacula
</span><span class='line'>[bacula@stafbacula /usr/local]$ 
</span></code></pre></td></tr></table></div></figure>


<p>For some reason the ssl directives aren&rsquo;t include and the connection fails</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[bacula@stafbacula /usr/local/etc/rc.d]$ dbcheck -c /usr/local/etc/bacula/bacula-dir.conf -v
</span><span class='line'>dbcheck: Fatal Error at dbcheck.c:303 because:
</span><span class='line'>postgresql.c:271 Unable to connect to PostgreSQL server. Database=bacula User=bacula
</span><span class='line'>Possible causes: SQL server not running; password incorrect; max_connections exceeded.
</span><span class='line'>09-Sep 14:22 dbcheck: Fatal Error at dbcheck.c:303 because:
</span><span class='line'>postgresql.c:271 Unable to connect to PostgreSQL server. Database=bacula User=bacula
</span><span class='line'>Possible causes: SQL server not running; password incorrect; max_connections exceeded.
</span><span class='line'>[bacula@stafbacula /usr/local/etc/rc.d]$ 
</span></code></pre></td></tr></table></div></figure>


<p>On our postgres host we get the error message that the bacula host tries to connect without SSL.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>oot@stafdb:/var/db/postgres/data96 # tail -f /var/log/messages
</span><span class='line'>Sep  9 14:22:10 stafdb postgres[14183]: [10-1] FATAL:  connection requires a valid client certificate
</span><span class='line'>Sep  9 14:22:10 stafdb postgres[14184]: [10-1] FATAL:  no pg_hba.conf entry for host "192.168.1.52", user "bacula", database "bacula", SSL off
</span><span class='line'>Sep  9 14:22:15 stafdb postgres[14185]: [10-1] FATAL:  connection requires a valid client certificate
</span><span class='line'>Sep  9 14:22:15 stafdb postgres[14186]: [10-1] FATAL:  no pg_hba.conf entry for host "192.168.1.52", user "bacula", database "bacula", SSL off
</span><span class='line'>Sep  9 14:22:20 stafdb postgres[14187]: [10-1] FATAL:  connection requires a valid client certificate
</span><span class='line'>Sep  9 14:22:20 stafdb postgres[14188]: [10-1] FATAL:  no pg_hba.conf entry for host "192.168.1.52", user "bacula", database "bacula", SSL off
</span><span class='line'>Sep  9 14:22:25 stafdb postgres[14190]: [10-1] FATAL:  connection requires a valid client certificate
</span><span class='line'>Sep  9 14:22:25 stafdb postgres[14191]: [10-1] FATAL:  no pg_hba.conf entry for host "192.168.1.52", user "bacula", database "bacula", SSL off
</span><span class='line'>Sep  9 14:22:30 stafdb postgres[14193]: [10-1] FATAL:  connection requires a valid client certificate
</span><span class='line'>Sep  9 14:22:30 stafdb postgres[14194]: [10-1] FATAL:  no pg_hba.conf entry for host "192.168.1.52", user "bacula", database "bacula", SSL off</span></code></pre></td></tr></table></div></figure>


<p>When set the postgresql varialables with the correct ssl settings the connnection works fine.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[bacula@stafbacula /usr/local/etc/rc.d]$ dbcheck -c /usr/local/etc/bacula/bacula-dir.conf -v
</span><span class='line'>Hello, this is the database check/correct program.
</span><span class='line'>Modify database is off. Verbose is on.
</span><span class='line'>Please select the function you want to perform.
</span><span class='line'>
</span><span class='line'>     1) Toggle modify database flag
</span><span class='line'>     2) Toggle verbose flag
</span><span class='line'>     3) Check for bad Filename records
</span><span class='line'>     4) Check for bad Path records
</span><span class='line'>     5) Check for duplicate Filename records
</span><span class='line'>     6) Check for duplicate Path records
</span><span class='line'>     7) Check for orphaned Jobmedia records
</span><span class='line'>     8) Check for orphaned File records
</span><span class='line'>     9) Check for orphaned Path records
</span><span class='line'>    10) Check for orphaned Filename records
</span><span class='line'>    11) Check for orphaned FileSet records
</span><span class='line'>    12) Check for orphaned Client records
</span><span class='line'>    13) Check for orphaned Job records
</span><span class='line'>    14) Check for all Admin records
</span><span class='line'>    15) Check for all Restore records
</span><span class='line'>    16) All (3-15)
</span><span class='line'>    17) Quit
</span><span class='line'>Select function number: 
</span></code></pre></td></tr></table></div></figure>


<h2>Bacula director</h2>

<h3>Enable the  bacula director</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafbacula:/usr/local/etc/rc.d # sysrc bacula_dir_enable=yes
</span><span class='line'>bacula_dir_enable:  -&gt; yes
</span><span class='line'>root@stafbacula:/usr/local/etc/rc.d # 
</span></code></pre></td></tr></table></div></figure>


<h4>Create the bacula.log</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafbacula:/var/log # touch /var/log/bacula.log
</span><span class='line'>root@stafbacula:/var/log # chown bacula:bacula /var/log/bacula.log</span></code></pre></td></tr></table></div></figure>


<h4>Include the postgreSQL ssl settings in the bacula director startup script</h4>

<p>Update the bacula-dir startup sript to include the ssl settings.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Add the following lines to /etc/rc.conf.local or /etc/rc.conf
</span><span class='line'># to enable this service:
</span><span class='line'>#
</span><span class='line'># bacula_dir_enable  (bool):   Set to NO by default.
</span><span class='line'>#                Set it to YES to enable bacula_dir.
</span><span class='line'># bacula_dir_flags (params):   Set params used to start bacula_dir.
</span><span class='line'>#
</span><span class='line'>
</span><span class='line'>. /etc/rc.subr
</span><span class='line'>. /var/db/bacula/psql_env.sh
</span></code></pre></td></tr></table></div></figure>


<h3>bconsole access</h3>

<p>To test that the catalog works correctly with the director we need to setup bconsole access.
Open the bacula director configuration file.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@stafbacula /usr/local/etc/bacula]# vim bacula-dir.conf</span></code></pre></td></tr></table></div></figure>


<p>And defined and Password</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Director {                            # define myself
</span><span class='line'>  Name = MyBaculaDirector
</span><span class='line'>  DIRport = 9101                # where we listen for UA connections
</span><span class='line'>  QueryFile = "/usr/local/share/bacula/query.sql"
</span><span class='line'>  WorkingDirectory = "/var/db/bacula"
</span><span class='line'>  PidDirectory = "/var/run"
</span><span class='line'>  Maximum Concurrent Jobs = 20
</span><span class='line'>  Password = "*******"         # Console password
</span><span class='line'>  Messages = Daemon
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Open the bconsole configuration file</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@stafbacula /usr/local/etc/bacula]# vi bconsole.conf</span></code></pre></td></tr></table></div></figure>


<p>and setup the same password</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Bacula User Agent (or Console) Configuration File
</span><span class='line'>#
</span><span class='line'># Copyright (C) 2000-2015 Kern Sibbald
</span><span class='line'># License: BSD 2-Clause; see file LICENSE-FOSS
</span><span class='line'>#
</span><span class='line'>
</span><span class='line'>Director {
</span><span class='line'>  Name = MyBaculaDirector
</span><span class='line'>  DIRport = 9101
</span><span class='line'>  address = localhost
</span><span class='line'>  Password = "*****"
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<h3>Start the director &amp; test</h3>

<p>Start the bacula-dir service</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafbacula /usr/local/etc/bacula]# service bacula-dir start
</span><span class='line'>Starting bacula_dir.
</span><span class='line'>[root@stafbacula /usr/local/etc/bacula]# ps aux | grep -i bacula 
</span><span class='line'>bacula 14416  0.0  0.1 51424 6588  -  SsJ  14:40   0:00.12 /usr/local/sbin/bacula-dir -u bacula -g bacula 
</span><span class='line'>root   14420  0.0  0.0 14796 1968  0  R+J  14:40   0:00.00 grep -i bacula
</span><span class='line'>root   13530  0.0  0.0  8300 1596  2  I+J  13:47   0:00.00 tail -f /var/log/bacula.log
</span><span class='line'>[root@stafbacula /usr/local/etc/bacula]#
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>And test the console access</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bacula@stafbacula:/usr/local/etc/bacula % bconsole
</span><span class='line'>Connecting to Director localhost:9101
</span><span class='line'>1000 OK: 102 MyBaculaDirector Version: 7.4.7 (16 March 2017)
</span><span class='line'>Enter a period to cancel a command.
</span><span class='line'>*version
</span><span class='line'>MyBaculaDirector Version: 7.4.7 (16 March 2017) amd64-portbld-freebsd11.0 freebsd 11.0-RELEASE-p12 
</span><span class='line'>You have messages.
</span><span class='line'>*</span></code></pre></td></tr></table></div></figure>


<p>In a next blog post we&rsquo;ll continue with the bacula configuration.</p>

<p style="font-style: italic;">
Have fun!
</p>


<h1>Links</h1>

<ul>
<li>bacula manual: <a href="http://www.bacula.org/9.0.x-manuals/en/main/"><a href="http://www.bacula.org/9.0.x-manuals/en/main/">http://www.bacula.org/9.0.x-manuals/en/main/</a></a></li>
<li><a href="https://dan.langille.org/2015/01/10/bacula-on-freebsd-with-zfs/"><a href="https://dan.langille.org/2015/01/10/bacula-on-freebsd-with-zfs/">https://dan.langille.org/2015/01/10/bacula-on-freebsd-with-zfs/</a></a></li>
</ul>

</div>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog_actrikel -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4659298941528586"
     data-ad-slot="7394058542"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">staf wagemakers</span></span>

      




<time class='entry-date' datetime='2017-09-09T10:27:03+02:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>10:27 am</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/blog/categories/backup/'>backup,</a>, <a class='category' href='/blog/blog/categories/bacula/'>bacula,</a>, <a class='category' href='/blog/blog/categories/freebsd/'>freebsd,</a>, <a class='category' href='/blog/blog/categories/postgresql/'>postgresql,</a>, <a class='category' href='/blog/blog/categories/ssl/'>ssl</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://stafwag.github.io/blog/blog/2017/09/09/bacula-on-freebsd-part2/" data-via="" data-counturl="http://stafwag.github.io/blog/blog/2017/09/09/bacula-on-freebsd-part2/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
  <span style="overflow: hidden; text-overflow: ellipsis;white-space: nowrap;">
    <script src="//platform.linkedin.com/in.js" type="text/javascript">
    lang: en_US
  </script>
  <script type="IN/Share" data-url="http://stafwag.github.io/blog/blog/2017/09/09/bacula-on-freebsd-part2/" data-counter="right"></script>
  </snap>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/blog/2017/08/06/bacula-on-freebsd:w_part1/" title="Previous Post: Bacula on FreeBSD (part 1 PostgresSQL in a jail)">&laquo; Bacula on FreeBSD (part 1 PostgresSQL in a jail)</a>
      
      
        <a class="basic-alignment right" href="/blog/blog/2017/09/16/20-core-dual-processor-jenkins-build-workstation/" title="Next Post: 20 core Dual Processor jenkins build workstation">20 core Dual Processor jenkins build workstation &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>


</div>

<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <p><a href="http://www.wagemakers.be">http://www.wagemakers.be</a></p>
  <p><a href="http://www.linkedin.com/in/stafwagemakers">LinkedIn profile</a></p>
  <p><a href="https://google.com/+StafWagemakers">Google Plus profile</a></p>
<!-- Place this tag where you want the widget to render. -->
<div class="g-person" data-width="180" data-href="http://google.com/+StafWagemakers" data-showtagline="false" data-showcoverphoto="false" data-rel="author"></div>

<!-- Place this tag after the last widget tag. -->
<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
</section>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/blog/2017/09/16/20-core-dual-processor-jenkins-build-workstation/">20 Core Dual Processor Jenkins Build Workstation</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2017/09/09/bacula-on-freebsd-part2/">Bacula on FreeBSD (Part 2 Bacula Catalog Over SSL )</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2017/08/06/bacula-on-freebsd:w_part1/">Bacula on FreeBSD (Part 1 PostgresSQL in a Jail)</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2017/05/25/install-parabola-gnu-slash-linux-on-an-encrypted-btrfs-logical-volume/">Install Parabola GNU/Linux on an Encrypted Btrfs Logical Volume</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2017/02/11/how-to-install-libreboot-on-a-thinkpad-x60/">How to Install Libreboot on a ThinkPad X60</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/stafwag">@stafwag</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'stafwag',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/blog/javascripts/github.js" type="text/javascript"> </script>
</section>





<hr />
<br />
<br />
<br />
<br />
<script type="text/javascript"><!--
google_ad_client = "ca-pub-4659298941528586";
/* blogads_right */
google_ad_slot = "8839948148";
google_ad_width = 160;
google_ad_height = 600;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - staf wagemakers -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'stafwag';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://stafwag.github.io/blog/blog/2017/09/09/bacula-on-freebsd-part2/';
        var disqus_url = 'http://stafwag.github.io/blog/blog/2017/09/09/bacula-on-freebsd-part2/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
