
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>stafwag Blog</title>
  <meta name="author" content="staf wagemakers">

  
  <meta name="description" content="Howto Use Centos Cloud Images With Cloud-init on KVM/libvirtd Mar 3rd, 2019 9:55 am Images versus unattended setup Old-school Unattended setup In a &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="https://stafwag.github.io/blog/">
  <link href="/blog/favicon.png" rel="icon">
  <link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/blog/atom.xml" rel="alternate" title="stafwag Blog" type="application/atom+xml">
  <script src="/blog/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/blog/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37258385-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/blog/">stafwag Blog</a></h1>
  
    <h2>staf wagemakers blog</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/blog/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="stafwag.github.io/blog">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/">Blog</a></li>
  <li><a href="/blog/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2019/03/03/howto-use-centos-cloud-images-with-cloud-init/">Howto Use Centos Cloud Images With Cloud-init on KVM/libvirtd</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-03-03T09:55:55+01:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2019</span></span> <span class='time'>9:55 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>Images versus unattended setup</h1>

<h2>Old-school</h2>

<h3>Unattended setup</h3>

<p>In a traditional environment, systems are installed from a CDROM. The configuration is executed by the system administrator through the installer. This soon becomes a borning and unpractical task when we need to set up a lot of systems also it is important  that systems are configured in same - and hopefully correct - way.</p>

<p>In a traditional environment, this can be automated by booting via BOOTP/PXE boot and configured is by a system that &ldquo;feeds&rdquo; the installer. Examples are:</p>

<ul>
<li><a href="https://en.wikipedia.org/wiki/JumpStart_(Solaris">Solaris Jumpstart</a></li>
<li><a href="https://en.wikipedia.org/wiki/Kickstart_(Linux">Redhat Kickstart</a>)</li>
<li><a href="https://wiki.debian.org/DebianInstaller/Preseed">DebianInstaller Preseed</a></li>
<li><a href="https://en.wikipedia.org/wiki/YaST#AutoYaST">Suse Autoyast</a></li>
<li>&hellip;</li>
</ul>


<h2>Cloud &amp; co</h2>

<h3>Cloud-init</h3>

<p>In a cloud environment, we use images to install systems. The system automation is generally done by <a href="https://cloud-init.io/">cloud-init</a>. Cloud-init was originally developed for Ubuntu GNU/Linux on the Amazon EC2 cloud. It has become the de facto installation configuration tool for most Unix like systems on most cloud environments.</p>

<p>Cloud-init uses a YAML file to configure the system.</p>

<h3>Images</h3>

<p>Most GNU/Linux distributions provide images that can be used to provision a new system.
You can find the complete list on the OpenStack website</p>

<p><a href="https://docs.openstack.org/image-guide/obtain-images.html">https://docs.openstack.org/image-guide/obtain-images.html</a></p>

<p>The OpenStack documentation also describes how you can create your own base images in the <a href="https://docs.openstack.org/image-guide/">OpenStack Virtual Machine Image Guide</a></p>

<h1>Use a centos cloud image with libvirtd</h1>

<h2>Download the cloud image</h2>

<h3>Download</h3>

<p>Download the latest &ldquo;GenericCloud&rdquo; centos 7 cloud image and sha256sum.txt.asc sha256sum.txt from:</p>

<p><a href="https://cloud.centos.org/centos/7/images/">https://cloud.centos.org/centos/7/images/</a></p>

<h3>Verify</h3>

<p>You should verify your download - as always against a trusted signing key -</p>

<p>On a centos 7 system, the public gpg is already installed at <code>/etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7</code></p>

<h4>Verify the fingerprint</h4>

<p>Execute</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@centos7 iso]$ gpg --with-fingerprint /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7
</span><span class='line'>pub  4096R/F4A80EB5 2014-06-23 CentOS-7 Key (CentOS 7 Official Signing Key) &lt;security@centos.org&gt;
</span><span class='line'>      Key fingerprint = 6341 AB27 53D7 8A78 A7C2  7BB1 24C6 A8A7 F4A8 0EB5
</span><span class='line'>[staf@centos7 iso]$ gpg --with-fingerprint /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7</span></code></pre></td></tr></table></div></figure>


<p>and verify the fingerprint, the fingerprints that are used by centos are listed at:</p>

<p><a href="https://www.centos.org/keys/">https://www.centos.org/keys/</a></p>

<h4>Import key</h4>

<p>Import the pub centos gpg key:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@centos7 iso]$ gpg --import /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7
</span><span class='line'>gpg: key F4A80EB5: public key "CentOS-7 Key (CentOS 7 Official Signing Key) &lt;security@centos.org&gt;" imported
</span><span class='line'>gpg: Total number processed: 1
</span><span class='line'>gpg:               imported: 1  (RSA: 1)
</span><span class='line'>[staf@centos7 iso]$ </span></code></pre></td></tr></table></div></figure>


<p>List the trusted gpg key:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@centos7 iso]$ gpg --list-keys
</span><span class='line'>/home/staf/.gnupg/pubring.gpg
</span><span class='line'>-----------------------------
</span><span class='line'>pub   4096R/F4A80EB5 2014-06-23
</span><span class='line'>uid                  CentOS-7 Key (CentOS 7 Official Signing Key) &lt;security@centos.org&gt;
</span><span class='line'>
</span><span class='line'>[staf@centos7 iso]$ gpg --list-keys
</span></code></pre></td></tr></table></div></figure>


<h4>Verify the sha256sum file</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@centos7 iso]$ gpg --verify sha256sum.txt.asc
</span><span class='line'>gpg: Signature made Thu 31 Jan 2019 04:28:30 PM CET using RSA key ID F4A80EB5
</span><span class='line'>gpg: Good signature from "CentOS-7 Key (CentOS 7 Official Signing Key) &lt;security@centos.org&gt;"
</span><span class='line'>gpg: WARNING: This key is not certified with a trusted signature!
</span><span class='line'>gpg:          There is no indication that the signature belongs to the owner.
</span><span class='line'>Primary key fingerprint: 6341 AB27 53D7 8A78 A7C2  7BB1 24C6 A8A7 F4A8 0EB5
</span><span class='line'>[staf@centos7 iso]$ </span></code></pre></td></tr></table></div></figure>


<p>The key fingerprint must match the one of RPM-GPG-KEY-CentOS-7.</p>

<h4>Verify the iso file</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@centos7 iso]$ xz -d CentOS-7-x86_64-GenericCloud-1901.qcow2.xz
</span><span class='line'>[staf@centos7 iso]$ sha256sum -c sha256sum.txt.asc 2&gt;&1 | grep OK
</span><span class='line'>CentOS-7-x86_64-GenericCloud-1901.qcow2: OK
</span><span class='line'>[staf@centos7 iso]$ </span></code></pre></td></tr></table></div></figure>


<h2>Image</h2>

<h3>info</h3>

<p>The image we download is a normal qcow2 image, we can see the image information with <code>qemu-info</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@centos7 iso]# qemu-img info CentOS-7-x86_64-GenericCloud-1901.qcow2
</span><span class='line'>image: CentOS-7-x86_64-GenericCloud-1901.qcow2
</span><span class='line'>file format: qcow2
</span><span class='line'>virtual size: 8.0G (8589934592 bytes)
</span><span class='line'>disk size: 895M
</span><span class='line'>cluster_size: 65536
</span><span class='line'>Format specific information:
</span><span class='line'>    compat: 0.10
</span><span class='line'>[root@centos7 iso]# </span></code></pre></td></tr></table></div></figure>


<h3>Copy &amp; resize</h3>

<p>The default image is small - 8GB - we might be using the image to provision other systems so it better to leave it untouched.</p>

<p>Copy the image to the location where we&rsquo;ll run the virtual system.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@centos7 iso]# cp -v CentOS-7-x86_64-GenericCloud-1901.qcow2 /var/lib/libvirt/images/tst/tst.qcow2
</span><span class='line'>'CentOS-7-x86_64-GenericCloud-1901.qcow2' -&gt; '/var/lib/libvirt/images/tst/tst.qcow2'
</span><span class='line'>[root@centos7 iso]# </span></code></pre></td></tr></table></div></figure>


<p>and resize it to the required size:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@centos7 iso]# cd /var/lib/libvirt/images/tst
</span><span class='line'>[root@centos7 tst]# qemu-img resize tst.qcow2 20G
</span><span class='line'>Image resized.
</span><span class='line'>[root@centos7 tst]# </span></code></pre></td></tr></table></div></figure>


<h2>cloud-init</h2>

<p>We&rsquo;ll create a simple cloud-init configuration file and generate an iso image with <code>cloud-localds</code>. This iso image holds the cloud-init configuration and will be used to setup the system during the bootstrap.</p>

<h3>Install cloud-utils</h3>

<p><span style="color:red"><strong> It&rsquo;s important to NOT install cloud-init on your KVM host machine. </strong></span> This creates a cloud-init service that runs during the boot and tries to reconfigure your host. Something that you probably don&rsquo;t want on your KVM hypervisor host.</p>

<p>The cloud-util package has all the tool we need to convert the cloud-init configuration files to an iso image.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@centos7 tst]# yum install -y cloud-utils
</span><span class='line'>Loaded plugins: fastestmirror, langpacks
</span><span class='line'>Loading mirror speeds from cached hostfile
</span><span class='line'> * base: centos.cu.be
</span><span class='line'> * extras: centos.cu.be
</span><span class='line'> * updates: centos.mirror.ate.info
</span><span class='line'>Resolving Dependencies
</span><span class='line'>--&gt; Running transaction check
</span><span class='line'>---&gt; Package cloud-utils.x86_64 0:0.27-20.el7.centos will be installed
</span><span class='line'>--&gt; Processing Dependency: python-paramiko for package: cloud-utils-0.27-20.el7.centos.x86_64
</span><span class='line'>--&gt; Processing Dependency: euca2ools for package: cloud-utils-0.27-20.el7.centos.x86_64
</span><span class='line'>--&gt; Processing Dependency: cloud-utils-growpart for package: cloud-utils-0.27-20.el7.centos.x86_64
</span><span class='line'>--&gt; Running transaction check
</span><span class='line'>---&gt; Package cloud-utils-growpart.noarch 0:0.29-2.el7 will be installed
</span><span class='line'>---&gt; Package euca2ools.noarch 0:2.1.4-1.el7.centos will be installed
</span><span class='line'>--&gt; Processing Dependency: python-boto &gt;= 2.13.3-1 for package: euca2ools-2.1.4-1.el7.centos.noarch
</span><span class='line'>--&gt; Processing Dependency: m2crypto for package: euca2ools-2.1.4-1.el7.centos.noarch
</span><span class='line'>---&gt; Package python-paramiko.noarch 0:2.1.1-9.el7 will be installed
</span><span class='line'>--&gt; Running transaction check
</span><span class='line'>---&gt; Package m2crypto.x86_64 0:0.21.1-17.el7 will be installed
</span><span class='line'>---&gt; Package python-boto.noarch 0:2.25.0-2.el7.centos will be installed
</span><span class='line'>--&gt; Finished Dependency Resolution
</span><span class='line'>
</span><span class='line'>Dependencies Resolved
</span><span class='line'>
</span><span class='line'>=======================================================================================
</span><span class='line'> Package                    Arch         Version                   Repository     Size
</span><span class='line'>=======================================================================================
</span><span class='line'>Installing:
</span><span class='line'> cloud-utils                x86_64       0.27-20.el7.centos        extras         43 k
</span><span class='line'>Installing for dependencies:
</span><span class='line'> cloud-utils-growpart       noarch       0.29-2.el7                base           26 k
</span><span class='line'> euca2ools                  noarch       2.1.4-1.el7.centos        extras        319 k
</span><span class='line'> m2crypto                   x86_64       0.21.1-17.el7             base          429 k
</span><span class='line'> python-boto                noarch       2.25.0-2.el7.centos       extras        1.5 M
</span><span class='line'> python-paramiko            noarch       2.1.1-9.el7               updates       269 k
</span><span class='line'>
</span><span class='line'>Transaction Summary
</span><span class='line'>=======================================================================================
</span><span class='line'>Install  1 Package (+5 Dependent packages)
</span><span class='line'>
</span><span class='line'>Total download size: 2.5 M
</span><span class='line'>Installed size: 12 M
</span><span class='line'>Downloading packages:
</span><span class='line'>(1/6): cloud-utils-growpart-0.29-2.el7.noarch.rpm               |  26 kB  00:00:01     
</span><span class='line'>(2/6): cloud-utils-0.27-20.el7.centos.x86_64.rpm                |  43 kB  00:00:01     
</span><span class='line'>(3/6): euca2ools-2.1.4-1.el7.centos.noarch.rpm                  | 319 kB  00:00:01     
</span><span class='line'>(4/6): m2crypto-0.21.1-17.el7.x86_64.rpm                        | 429 kB  00:00:01     
</span><span class='line'>(5/6): python-boto-2.25.0-2.el7.centos.noarch.rpm               | 1.5 MB  00:00:02     
</span><span class='line'>(6/6): python-paramiko-2.1.1-9.el7.noarch.rpm                   | 269 kB  00:00:03     
</span><span class='line'>---------------------------------------------------------------------------------------
</span><span class='line'>Total                                                     495 kB/s | 2.5 MB  00:05     
</span><span class='line'>Running transaction check
</span><span class='line'>Running transaction test
</span><span class='line'>Transaction test succeeded
</span><span class='line'>Running transaction
</span><span class='line'>  Installing : python-boto-2.25.0-2.el7.centos.noarch                              1/6 
</span><span class='line'>  Installing : python-paramiko-2.1.1-9.el7.noarch                                  2/6 
</span><span class='line'>  Installing : cloud-utils-growpart-0.29-2.el7.noarch                              3/6 
</span><span class='line'>  Installing : m2crypto-0.21.1-17.el7.x86_64                                       4/6 
</span><span class='line'>  Installing : euca2ools-2.1.4-1.el7.centos.noarch                                 5/6 
</span><span class='line'>  Installing : cloud-utils-0.27-20.el7.centos.x86_64                               6/6 
</span><span class='line'>  Verifying  : m2crypto-0.21.1-17.el7.x86_64                                       1/6 
</span><span class='line'>  Verifying  : cloud-utils-growpart-0.29-2.el7.noarch                              2/6 
</span><span class='line'>  Verifying  : python-paramiko-2.1.1-9.el7.noarch                                  3/6 
</span><span class='line'>  Verifying  : python-boto-2.25.0-2.el7.centos.noarch                              4/6 
</span><span class='line'>  Verifying  : euca2ools-2.1.4-1.el7.centos.noarch                                 5/6 
</span><span class='line'>  Verifying  : cloud-utils-0.27-20.el7.centos.x86_64                               6/6 
</span><span class='line'>
</span><span class='line'>Installed:
</span><span class='line'>  cloud-utils.x86_64 0:0.27-20.el7.centos                                                                                                                                     
</span><span class='line'>
</span><span class='line'>Dependency Installed:
</span><span class='line'>  cloud-utils-growpart.noarch 0:0.29-2.el7      euca2ools.noarch 0:2.1.4-1.el7.centos      m2crypto.x86_64 0:0.21.1-17.el7      python-boto.noarch 0:2.25.0-2.el7.centos     
</span><span class='line'>  python-paramiko.noarch 0:2.1.1-9.el7         
</span><span class='line'>
</span><span class='line'>Complete!
</span><span class='line'>[root@centos7 tst]# </span></code></pre></td></tr></table></div></figure>


<h3>Cloud-init configuration</h3>

<p>A complete overview of cloud-init configuration directives is available at <a href="https://cloudinit.readthedocs.io/en/latest/">https://cloudinit.readthedocs.io/en/latest/</a>.</p>

<p>We&rsquo;ll create a cloud-init configuration file to update all the packages - which is always a good idea - and to add a user to the system.</p>

<p>A cloud-init configuration file has to start with <code>#cloud-config</code>, remember this is YAML so only use spaces&hellip;</p>

<p>We&rsquo;ll create a password hash that we&rsquo;ll put into your cloud-init configuration, it&rsquo;s also possible to use a plain-text password in the configuration with <code>chpasswd</code> or to set the password for the default user. But it&rsquo;s better to use a hash so nobody can see the password. Keep in mind that is still possible to brute-force the password hash.</p>

<p>Some GNU/Linux distributions have the <code>mkpasswd</code> utility this is not available on centos. The <code>mkpasswd</code> utility is part of the <code>expect</code> package and is something else&hellip;</p>

<p>I used a python one-liner to generate the SHA512 password hash</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>python -c 'import crypt,getpass; print(crypt.crypt(getpass.getpass(), crypt.mksalt(crypt.METHOD_SHA512)))'</span></code></pre></td></tr></table></div></figure>


<p>Execute the one-liner and type in your password:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@centos7 ~]$ python -c 'import crypt,getpass; print(crypt.crypt(getpass.getpass(), crypt.mksalt(crypt.METHOD_SHA512)))'
</span><span class='line'>Password: 
</span><span class='line'>&lt;your hash&gt;
</span><span class='line'>[staf@centos7 ~]$ </span></code></pre></td></tr></table></div></figure>


<p>Create config.yaml - replace <code>&lt;your_user&gt;</code>, <code>&lt;your_hash&gt;</code>, <code>&lt;your_ssh_pub_key&gt;</code> -  with your data:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#cloud-config
</span><span class='line'>package_upgrade: true
</span><span class='line'>users:
</span><span class='line'>  - name: &lt;your_user&gt;
</span><span class='line'>    groups: wheel
</span><span class='line'>    lock_passwd: false
</span><span class='line'>    passwd: &lt;your_passord_hash&gt;
</span><span class='line'>    shell: /bin/bash
</span><span class='line'>    sudo: ['ALL=(ALL) NOPASSWD:ALL']
</span><span class='line'>    ssh-authorized-keys:
</span><span class='line'>      - &lt;your_public_ssh_key&gt;</span></code></pre></td></tr></table></div></figure>


<p>And generate the configuration iso image:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@centos7 tst]# cloud-localds config.iso config.yaml
</span><span class='line'>wrote config.iso with filesystem=iso9660 and diskformat=raw
</span><span class='line'>[root@centos7 tst]# </span></code></pre></td></tr></table></div></figure>


<h3>Create the virtual system</h3>

<p>Libvirt has predefined definitions for operating systems. You can query the predefined operation systems with the <code>osinfo-query os</code> command.</p>

<p>We use centos 7, we use <code>osinfo-query os</code> to find the correct definition.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@centos7 tst]# osinfo-query  os | grep -i centos7
</span><span class='line'> centos7.0            | CentOS 7.0                                         | 7.0      | http://centos.org/centos/7.0            
</span><span class='line'>[root@centos7 tst]# </span></code></pre></td></tr></table></div></figure>


<p>Create the virtual system:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>virt-install \
</span><span class='line'>  --memory 2048 \
</span><span class='line'>  --vcpus 2 \
</span><span class='line'>  --name tst \
</span><span class='line'>  --disk /var/lib/libvirt/images/tst/tst.qcow2,device=disk \
</span><span class='line'>  --disk /var/lib/libvirt/images/tst/config.iso,device=cdrom \
</span><span class='line'>  --os-type Linux \
</span><span class='line'>  --os-variant centos7.0 \
</span><span class='line'>  --virt-type kvm \
</span><span class='line'>  --graphics none \
</span><span class='line'>  --network default \
</span><span class='line'>  --import</span></code></pre></td></tr></table></div></figure>


<p>The default escape key - to get out the console is ^[  ( Ctrl + [ )</p>

<p><strong><em> Have fun! </em></strong></p>

<h1>Links</h1>

<ul>
<li><a href="https://wiki.centos.org/Download/Verify">https://wiki.centos.org/Download/Verify</a></li>
<li><a href="https://www.theurbanpenguin.com/using-cloud-images-in-kvm/">https://www.theurbanpenguin.com/using-cloud-images-in-kvm/</a></li>
<li><a href="https://docs.openstack.org/image-guide/">https://docs.openstack.org/image-guide/</a></li>
<li><a href="https://unix.stackexchange.com/questions/52108/how-to-create-sha512-password-hashes-on-command-line#76337">https://unix.stackexchange.com/questions/52108/how-to-create-sha512-password-hashes-on-command-line#76337</a></li>
</ul>

</div>
  
  

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog_actrikel -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4659298941528586"
     data-ad-slot="7394058542"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2019/02/10/how-to-install-libreboot-on-a-thinkspad-w500/">How to Install Libreboot on a ThinkPad W500</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-02-10T17:49:46+01:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>5:49 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="/blog/images/libreboot_w500_with_pi.jpg"><img src="/blog/images/libreboot_w500_with_pi.jpg" class="right" width="500" height="333" alt="w500 and pi" /></a></p>

<p>I got a <a href="https://en.wikipedia.org/wiki/ThinkPad_W_series#W500">Lenovo Thinkpad W500</a> from <a href="http://www.2dehands.be">www.2dehands.be</a> for a nice price.</p>

<p>Actually, I got it a couple of months back but I didn&rsquo;t have time to play with it and it took some time to get some parts from <a href="https://www.aliexpress.com">Aliexpress</a>.</p>

<p> The Thinkpad W500 is probably the most powerful system that is compatible with <a href="https://www.libreboot.org">Libreboot</a>, it has a nice high-resolution display with a 1920 x 1200 resolution which is even a higher screen resolution than the <a href="https://en.wikipedia.org/wiki/1080p">Full HD resolution</a> used on most new laptops today.</p>

<h1>Security</h1>

<p>Keep in mind that the <a href="https://en.wikipedia.org/wiki/Intel_Core#Core_2_Duo">core duo CPU</a> does not get <a href="https://www.extremetech.com/computing/266884-intel-wont-patch-older-cpus-to-resolve-spectre-flaws">microcode updates from Intel</a> for <a href="https://en.wikipedia.org/wiki/Meltdown_(security_vulnerability">spectre and meltdown</a>. There is no solution (currently) for <a href="https://nvd.nist.gov/vuln/detail/CVE-2018-3640">spectre 3a - Rogue   System Register Read - CVE-2018-3640</a> and <a href="https://nvd.nist.gov/vuln/detail/CVE-2018-3639"> Spectre 4 - Speculative Store Bypass CVE-2018-3639</a> without a microcode update.</p>

<p><a href="https://en.wikipedia.org/wiki/Binary_blob">Binary blobs</a> are bad. Having a closed source binary-only piece of software on your system is not only unacceptable for <a href="https://en.wikipedia.org/wiki/Free_software_movement">Free Software activists</a> it also makes it more difficult to review what it really does and makes it more difficult to review it for security concerns.</p>

<p>Having your system vulnerable is also a bad thing of course. Can&rsquo;t wait to get a computer system with an open CPU architecture like <a href="https://en.wikipedia.org/wiki/RISC-V">RISC-V</a>.</p>

<h1>Preparation</h1>

<h2>Thinkpad</h2>

<h3>MAC address</h3>

<p>Your MAC address is stored in your BIOS since you&rsquo;ll overwite the BIOS with Libreboot we need to have the MAC address. Your MAC address is written on Laptop however I recommend to boot from GNU/Linux and copy/paste it from the <code>ifconfig</code> or the <code>ip a</code> command.</p>

<h3>EC update</h3>

<p>It&rsquo;s recommended to update your current BIOS to get the latest <a href="https://libreboot.org/faq.html#ec-embedded-controller-firmware">EC firmware</a>. My system has a CDROM drive I updated the BIOS with a CDROM.</p>

<h2>Prepare the Raspberry-pi</h2>

<p>It isn&rsquo;t possible to flash the BIOS with software only on a Lenovo W500/T500, it&rsquo;s required to put a clip on your BIOS chip and flash the new BIOS with <a href="https://www.flashrom.org/">flashrom</a>. I used a <a href="https://www.raspberrypi.org/products/raspberry-pi-1-model-b-plus/">Raspberry Pi 1 model B</a> with <a href="https://www.raspberrypi.org/downloads/raspbian/">Raspbian</a> to flash Libreboot .</p>

<h3>Enable the SPI port</h3>

<p>The <a href="https://en.wikipedia.org/wiki/Serial_Peripheral_Interface">SPI port</a> isn&rsquo;t enabled by default on Raspbian, so we&rsquo;ll need to enable it.</p>

<p>Open <code>/boot/config.txt</code> in your favorite text editor.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@raspberrypi:~# cd /boot/
</span><span class='line'>root@raspberrypi:/boot# ls
</span><span class='line'>bcm2708-rpi-0-w.dtb     bcm2710-rpi-3-b.dtb       config.txt     fixup_x.dat       LICENSE.oracle  start_x.elf
</span><span class='line'>bcm2708-rpi-b.dtb       bcm2710-rpi-3-b-plus.dtb  COPYING.linux  issue.txt         overlays
</span><span class='line'>bcm2708-rpi-b-plus.dtb  bcm2710-rpi-cm3.dtb       fixup_cd.dat   kernel7.img       start_cd.elf
</span><span class='line'>bcm2708-rpi-cm.dtb      bootcode.bin              fixup.dat      kernel.img        start_db.elf
</span><span class='line'>bcm2709-rpi-2-b.dtb     cmdline.txt               fixup_db.dat   LICENCE.broadcom  start.elf
</span><span class='line'>root@raspberrypi:/boot# vi config.txt </span></code></pre></td></tr></table></div></figure>


<p>uncomment <code>dtparam=spi=on</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Uncomment some or all of these to enable the optional hardware interfaces
</span><span class='line'>#dtparam=i2c_arm=on
</span><span class='line'>#dtparam=i2s=on
</span><span class='line'>dtparam=spi=on</span></code></pre></td></tr></table></div></figure>


<p>After a  reboot of the raspberry-pi the SPI interface <code>/dev/spidev*</code> will be available.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@raspberrypi:~# ls -l /dev/spidev*
</span><span class='line'>crw-rw---- 1 root spi 153, 0 Jan 26 20:08 /dev/spidev0.0
</span><span class='line'>crw-rw---- 1 root spi 153, 1 Jan 26 20:08 /dev/spidev0.1
</span><span class='line'>root@raspberrypi:~# </span></code></pre></td></tr></table></div></figure>


<h3>Install the required software</h3>

<h4>git</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~ $ sudo apt install git
</span><span class='line'>Reading package lists... Done
</span><span class='line'>Building dependency tree       
</span><span class='line'>Reading state information... Done
</span><span class='line'>The following additional packages will be installed:
</span><span class='line'>  git-man liberror-perl
</span><span class='line'>Suggested packages:
</span><span class='line'>  git-daemon-run | git-daemon-sysvinit git-doc git-el git-email git-gui gitk gitweb git-arch git-cvs
</span><span class='line'>  git-mediawiki git-svn
</span><span class='line'>The following NEW packages will be installed:
</span><span class='line'>  git git-man liberror-perl
</span><span class='line'>0 upgraded, 3 newly installed, 0 to remove and 0 not upgraded.
</span><span class='line'>Need to get 4,849 kB of archives.
</span><span class='line'>After this operation, 26.4 MB of additional disk space will be used.
</span><span class='line'>Do you want to continue? [Y/n] y
</span><span class='line'>Get:1 http://mirror.nl.leaseweb.net/raspbian/raspbian stretch/main armhf liberror-perl all 0.17024-1 [26.9 kB]
</span><span class='line'>Get:2 http://mirror.nl.leaseweb.net/raspbian/raspbian stretch/main armhf git-man all 1:2.11.0-3+deb9u4 [1,433 kB]
</span><span class='line'>Get:3 http://mirror.nl.leaseweb.net/raspbian/raspbian stretch/main armhf git armhf 1:2.11.0-3+deb9u4 [3,390 kB]
</span><span class='line'>Fetched 4,849 kB in 3s (1,517 kB/s)
</span><span class='line'>Selecting previously unselected package liberror-perl.
</span><span class='line'>(Reading database ... 35178 files and directories currently installed.)
</span><span class='line'>Preparing to unpack .../liberror-perl_0.17024-1_all.deb ...
</span><span class='line'>Unpacking liberror-perl (0.17024-1) ...
</span><span class='line'>Selecting previously unselected package git-man.
</span><span class='line'>Preparing to unpack .../git-man_1%3a2.11.0-3+deb9u4_all.deb ...
</span><span class='line'>Unpacking git-man (1:2.11.0-3+deb9u4) ...
</span><span class='line'>Selecting previously unselected package git.
</span><span class='line'>Preparing to unpack .../git_1%3a2.11.0-3+deb9u4_armhf.deb ...
</span><span class='line'>Unpacking git (1:2.11.0-3+deb9u4) ...
</span><span class='line'>Setting up git-man (1:2.11.0-3+deb9u4) ...
</span><span class='line'>Setting up liberror-perl (0.17024-1) ...
</span><span class='line'>Processing triggers for man-db (2.7.6.1-2) ...
</span><span class='line'>Setting up git (1:2.11.0-3+deb9u4) ...
</span><span class='line'>pi@raspberrypi:~ $ </span></code></pre></td></tr></table></div></figure>


<h4>flashrom</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@raspberrypi:~# apt install flashrom
</span><span class='line'>Reading package lists... Done
</span><span class='line'>Building dependency tree       
</span><span class='line'>Reading state information... Done
</span><span class='line'>The following additional packages will be installed:
</span><span class='line'>  libftdi1-2 libpci3
</span><span class='line'>The following NEW packages will be installed:
</span><span class='line'>  flashrom libftdi1-2 libpci3
</span><span class='line'>0 upgraded, 3 newly installed, 0 to remove and 0 not upgraded.
</span><span class='line'>Need to get 454 kB of archives.
</span><span class='line'>After this operation, 843 kB of additional disk space will be used.
</span><span class='line'>Do you want to continue? [Y/n] y
</span><span class='line'>Get:1 http://mirror.nl.leaseweb.net/raspbian/raspbian stretch/main armhf libpci3 armhf 1:3.5.2-1 [50.9 kB]
</span><span class='line'>Get:2 http://mirror.nl.leaseweb.net/raspbian/raspbian stretch/main armhf libftdi1-2 armhf 1.3-2 [26.8 kB]
</span><span class='line'>Get:3 http://mirror.nl.leaseweb.net/raspbian/raspbian stretch/main armhf flashrom armhf 0.9.9+r1954-1 [377 kB]
</span><span class='line'>Fetched 454 kB in 4s (108 kB/s)   
</span><span class='line'>Selecting previously unselected package libpci3:armhf.
</span><span class='line'>(Reading database ... 34656 files and directories currently installed.)
</span><span class='line'>Preparing to unpack .../libpci3_1%3a3.5.2-1_armhf.deb ...
</span><span class='line'>Unpacking libpci3:armhf (1:3.5.2-1) ...
</span><span class='line'>Selecting previously unselected package libftdi1-2:armhf.
</span><span class='line'>Preparing to unpack .../libftdi1-2_1.3-2_armhf.deb ...
</span><span class='line'>Unpacking libftdi1-2:armhf (1.3-2) ...
</span><span class='line'>Selecting previously unselected package flashrom.
</span><span class='line'>Preparing to unpack .../flashrom_0.9.9+r1954-1_armhf.deb ...
</span><span class='line'>Unpacking flashrom (0.9.9+r1954-1) ...
</span><span class='line'>Setting up libftdi1-2:armhf (1.3-2) ...
</span><span class='line'>Processing triggers for libc-bin (2.24-11+deb9u3) ...
</span><span class='line'>Processing triggers for man-db (2.7.6.1-2) ...
</span><span class='line'>Setting up libpci3:armhf (1:3.5.2-1) ...
</span><span class='line'>Setting up flashrom (0.9.9+r1954-1) ...
</span><span class='line'>Processing triggers for libc-bin (2.24-11+deb9u3) ...
</span><span class='line'>root@raspberrypi:~# </span></code></pre></td></tr></table></div></figure>


<h1>Wiring</h1>

<h2>Wire diagram</h2>

<p>It&rsquo;s useful to get correct flash chip specs, I used a magnifying loupe and a photo camera to get my chip type. After searching the internet I found a very nice blog post from <a href="https://p1trson.blogspot.com">p1trson</a> <a href="https://p1trson.blogspot.com/2017/01/journey-to-freedom-part-ii.html">https://p1trson.blogspot.com/2017/01/journey-to-freedom-part-ii.html</a> about flashing Libreboot on a Thinkpad T400 with the same Flash chip, I used his wiring diagram. Thanks P1trson!</p>

<p><a href="/blog/images/w500_flashchip.jpg"><img src="/blog/images/w500_flashchip.jpg" width="250" height="177" alt="w500 and pi" /> </a>
<a href="/blog/images/pin_layout2.jpg"><img src="/blog/images/pin_layout2.jpg" width="500" height="172" alt="pin layout" /> </a></p>

<h2>Power off &amp; wiring</h2>

<p>Power off your raspberry-pi and wire your flash clip to the raspberry-pi with the above diagram.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@raspberrypi:~# poweroff
</span><span class='line'>Connection to pi2 closed by remote host.
</span><span class='line'>Connection to pi2 closed.
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h1>flashing</h1>

<h2>test</h2>

<p>Test the connection to your flash chip with <code>flashrom</code>. I needed to specify the <code>spispeed=512</code> to get the connection established.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@raspberrypi:~# flashrom -p linux_spi:dev=/dev/spidev0.0,spispeed=512 
</span><span class='line'>flashrom v0.9.9-r1954 on Linux 4.14.79+ (armv6l)
</span><span class='line'>flashrom is free software, get the source code at https://flashrom.org
</span><span class='line'>
</span><span class='line'>Calibrating delay loop... OK.
</span><span class='line'>Found Macronix flash chip "MX25L6405" (8192 kB, SPI) on linux_spi.
</span><span class='line'>Found Macronix flash chip "MX25L6405D" (8192 kB, SPI) on linux_spi.
</span><span class='line'>Found Macronix flash chip "MX25L6406E/MX25L6408E" (8192 kB, SPI) on linux_spi.
</span><span class='line'>Found Macronix flash chip "MX25L6436E/MX25L6445E/MX25L6465E/MX25L6473E" (8192 kB, SPI) on linux_spi.
</span><span class='line'>Multiple flash chip definitions match the detected chip(s): "MX25L6405", "MX25L6405D", "MX25L6406E/MX25L6408E", "MX25L6436E/MX25L6445E/MX25L6465E/MX25L6473E"
</span><span class='line'>Please specify which chip definition to use with the -c &lt;chipname&gt; option.
</span><span class='line'>root@raspberrypi:~# </span></code></pre></td></tr></table></div></figure>


<h2>read old bios</h2>

<h3>read</h3>

<p>Read the original flash twice</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~ $ sudo flashrom -c "MX25L6405D" -p linux_spi:dev=/dev/spidev0.0,spispeed=512 -r w500bios.rom
</span><span class='line'>flashrom v0.9.9-r1954 on Linux 4.14.79+ (armv6l)
</span><span class='line'>flashrom is free software, get the source code at https://flashrom.org
</span><span class='line'>
</span><span class='line'>Calibrating delay loop... OK.
</span><span class='line'>Found Macronix flash chip "MX25L6405D" (8192 kB, SPI) on linux_spi.
</span><span class='line'>Reading flash... done.
</span><span class='line'>pi@raspberrypi:~ $ ls
</span><span class='line'>flashrom  test.rom  w500bios.rom
</span><span class='line'>pi@raspberrypi:~ $ sudo flashrom -c "MX25L6405D" -p linux_spi:dev=/dev/spidev0.0,spispeed=512 -r w500bios2.rom
</span><span class='line'>flashrom v0.9.9-r1954 on Linux 4.14.79+ (armv6l)
</span><span class='line'>flashrom is free software, get the source code at https://flashrom.org
</span><span class='line'>
</span><span class='line'>Calibrating delay loop... OK.
</span><span class='line'>Found Macronix flash chip "MX25L6405D" (8192 kB, SPI) on linux_spi.
</span><span class='line'>Reading flash... done.
</span><span class='line'>pi@raspberrypi:~ $ </span></code></pre></td></tr></table></div></figure>


<h3>compare</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~ $ sha1sum w500bios*.rom
</span><span class='line'>d23effea7312dbc0f2aabe1ca1387e1d047d7334  w500bios2.rom
</span><span class='line'>d23effea7312dbc0f2aabe1ca1387e1d047d7334  w500bios.rom
</span><span class='line'>pi@raspberrypi:~ $ </span></code></pre></td></tr></table></div></figure>


<h3>store</h3>

<p>Store your original BIOS image to a safe place. Might be useful if need to restore it&hellip;</p>

<h3>Flash libreboot</h3>

<h4>Download &amp; verify</h4>

<p>I created <code>~/libreboot</code> directory on my raspberry-pi to store all the downloads.</p>

<h5>Download</h5>

<p>Download the libreboot version that matches your laptop with SHA512SUMS and SHA512SUMS.sig.</p>

<p><a href="https://libreboot.org/download.html">https://libreboot.org/download.html</a></p>

<h5>Verify</h5>

<p>It always a good idea to verify the gpg signature&hellip;</p>

<p>Download the gpg key</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~ $ gpg --recv-keys 0x969A979505E8C5B2
</span><span class='line'>gpg: failed to start the dirmngr '/usr/bin/dirmngr': No such file or directory
</span><span class='line'>gpg: connecting dirmngr at '/run/user/1000/gnupg/S.dirmngr' failed: No such file or directory
</span><span class='line'>gpg: keyserver receive failed: No dirmngr</span></code></pre></td></tr></table></div></figure>


<p>I needed to install dirmgr separately on my Raspbian installation.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~ $ sudo apt-get install dirmngr
</span><span class='line'>Reading package lists... Done
</span><span class='line'>Building dependency tree       
</span><span class='line'>Reading state information... Done
</span><span class='line'>Suggested packages:
</span><span class='line'>  dbus-user-session pinentry-gnome3 tor
</span><span class='line'>The following NEW packages will be installed:
</span><span class='line'>  dirmngr
</span><span class='line'>0 upgraded, 1 newly installed, 0 to remove and 0 not upgraded.
</span><span class='line'>Need to get 547 kB of archives.
</span><span class='line'>After this operation, 963 kB of additional disk space will be used.
</span><span class='line'>Get:1 http://mirror.nl.leaseweb.net/raspbian/raspbian stretch/main armhf dirmngr armhf 2.1.18-8~deb9u3 [547 kB]
</span><span class='line'>Fetched 547 kB in 9s (58.3 kB/s)         
</span><span class='line'>Selecting previously unselected package dirmngr.
</span><span class='line'>(Reading database ... 36051 files and directories currently installed.)
</span><span class='line'>Preparing to unpack .../dirmngr_2.1.18-8~deb9u3_armhf.deb ...
</span><span class='line'>Unpacking dirmngr (2.1.18-8~deb9u3) ...
</span><span class='line'>Processing triggers for man-db (2.7.6.1-2) ...
</span><span class='line'>Setting up dirmngr (2.1.18-8~deb9u3) ...
</span><span class='line'>pi@raspberrypi:~ $ </span></code></pre></td></tr></table></div></figure>


<p>Try it again&hellip;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~ $ gpg --recv-keys 0x969A979505E8C5B2
</span><span class='line'>key 969A979505E8C5B2:
</span><span class='line'>1 signature not checked due to a missing key
</span><span class='line'>gpg: /home/pi/.gnupg/trustdb.gpg: trustdb created
</span><span class='line'>gpg: key 969A979505E8C5B2: public key "Leah Rowe (Libreboot signing key) &lt;info@minifree.org&gt;" imported
</span><span class='line'>gpg: no ultimately trusted keys found
</span><span class='line'>gpg: Total number processed: 1
</span><span class='line'>gpg:               imported: 1
</span><span class='line'>pi@raspberrypi:~ $ 
</span></code></pre></td></tr></table></div></figure>


<p>Verify the signature of the checksum file&hellip;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~ $ gpg --verify SHA512SUMS.sig 
</span><span class='line'>gpg: assuming signed data in 'SHA512SUMS'
</span><span class='line'>gpg: Signature made Wed 07 Sep 2016 23:15:17 BST
</span><span class='line'>gpg:                using RSA key 969A979505E8C5B2
</span><span class='line'>gpg: Good signature from "Leah Rowe (Libreboot signing key) &lt;info@minifree.org&gt;" [unknown]
</span><span class='line'>gpg: WARNING: This key is not certified with a trusted signature!
</span><span class='line'>gpg:          There is no indication that the signature belongs to the owner.
</span><span class='line'>Primary key fingerprint: CDC9 CAE3 2CB4 B7FC 84FD  C804 969A 9795 05E8 C5B2
</span><span class='line'>pi@raspberrypi:~ $ 
</span></code></pre></td></tr></table></div></figure>


<p>Compare the checksum&hellip;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~/libreboot $ sha512sum libreboot_r20160907_grub_t500_8mb.tar.xz 
</span><span class='line'>5325aef526ab6ca359d6613609a4a2345eee47c6d194094553b53996c413431bccdc345838299b347f47bcba8896dd0a6ed3f9b4c88606ead61c3725b580983b  libreboot_r20160907_grub_t500_8mb.tar.xz
</span><span class='line'>pi@raspberrypi:~/libreboot $ grep sha512sum 5325aef526ab6ca359d6613609a4a2345eee47c6d194094553b53996c413431bccdc345838299b347f47bcba8896dd0a6ed3f9b4c88606ead61c3725b580983b
</span><span class='line'>grep: 5325aef526ab6ca359d6613609a4a2345eee47c6d194094553b53996c413431bccdc345838299b347f47bcba8896dd0a6ed3f9b4c88606ead61c3725b580983b: No such file or directory
</span><span class='line'>pi@raspberrypi:~/libreboot $ grep 5325aef526ab6ca359d6613609a4a2345eee47c6d194094553b53996c413431bccdc345838299b347f47bcba8896dd0a6ed3f9b4c88606ead61c3725b580983b SHA512SUMS
</span><span class='line'>5325aef526ab6ca359d6613609a4a2345eee47c6d194094553b53996c413431bccdc345838299b347f47bcba8896dd0a6ed3f9b4c88606ead61c3725b580983b  ./rom/grub/libreboot_r20160907_grub_t500_8mb.tar.xz
</span><span class='line'>pi@raspberrypi:~/libreboot $ </span></code></pre></td></tr></table></div></figure>


<h5>Extract</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~/libreboot $ tar xvf libreboot_r20160907_grub_t500_8mb.tar.xz
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_deqwertz_txtmode.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_esqwerty_txtmode.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_frazerty_txtmode.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_frdvbepo_txtmode.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_itqwerty_txtmode.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_svenska_txtmode.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_ukdvorak_txtmode.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_ukqwerty_txtmode.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_usdvorak_txtmode.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_usqwerty_txtmode.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_deqwertz_vesafb.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_esqwerty_vesafb.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_frazerty_vesafb.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_frdvbepo_vesafb.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_itqwerty_vesafb.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_svenska_vesafb.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_ukdvorak_vesafb.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_ukqwerty_vesafb.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_usdvorak_vesafb.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_usqwerty_vesafb.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/ChangeLog
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/NEWS
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/version
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/versiondate
</span><span class='line'>pi@raspberrypi:~/libreboot $ </span></code></pre></td></tr></table></div></figure>


<h5>copy the image that you plan to use</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~/libreboot $ cp libreboot_r20160907_grub_t500_8mb/t500_8mb_usqwerty_vesafb.rom libreboot.rom
</span><span class='line'>pi@raspberrypi:~/libreboot $ </span></code></pre></td></tr></table></div></figure>


<h4>Change MAC</h4>

<h5>Download the libreboot util</h5>

<h6>Download</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~/libreboot $ wget https://www.mirrorservice.org/sites/libreboot.org/release/stable/20160907/libreboot_r20160907_util.tar.xz
</span><span class='line'>--2019-01-27 08:46:32--  https://www.mirrorservice.org/sites/libreboot.org/release/stable/20160907/libreboot_r20160907_util.tar.xz
</span><span class='line'>Resolving www.mirrorservice.org (www.mirrorservice.org)... 212.219.56.184, 2001:630:341:12::184
</span><span class='line'>Connecting to www.mirrorservice.org (www.mirrorservice.org)|212.219.56.184|:443... connected.
</span><span class='line'>HTTP request sent, awaiting response... 200 OK
</span><span class='line'>Length: 2458736 (2.3M) [application/x-tar]
</span><span class='line'>Saving to: libreboot_r20160907_util.tar.xz
</span><span class='line'>
</span><span class='line'>libreboot_r20160907_util.tar 100%[===========================================&gt;]   2.34M  1.65MB/s    in 1.4s    
</span><span class='line'>
</span><span class='line'>2019-01-27 08:46:34 (1.65 MB/s) - libreboot_r20160907_util.tar.xz saved [2458736/2458736]
</span><span class='line'>
</span><span class='line'>pi@raspberrypi:~/libreboot $ </span></code></pre></td></tr></table></div></figure>


<h6>Verify</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~/libreboot $ sha512sum libreboot_r20160907_util.tar.xz
</span><span class='line'>c5bfa5a06d55c61e5451e70cd8da3f430b5e06686f9a74c5a2e9fe0e9d155505867b0ca3428d85a983741146c4e024a6b0447638923423000431c98d048bd473  libreboot_r20160907_util.tar.xz
</span><span class='line'>pi@raspberrypi:~/libreboot $ grep c5bfa5a06d55c61e5451e70cd8da3f430b5e06686f9a74c5a2e9fe0e9d155505867b0ca3428d85a983741146c4e024a6b0447638923423000431c98d048bd473 SHA512SUMS
</span><span class='line'>c5bfa5a06d55c61e5451e70cd8da3f430b5e06686f9a74c5a2e9fe0e9d155505867b0ca3428d85a983741146c4e024a6b0447638923423000431c98d048bd473  ./libreboot_r20160907_util.tar.xz
</span><span class='line'>pi@raspberrypi:~/libreboot $ </span></code></pre></td></tr></table></div></figure>


<h6>Extract</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~/libreboot $ tar xvf libreboot_r20160907_util.tar.xz 
</span><span class='line'>libreboot_r20160907_util/
</span><span class='line'>libreboot_r20160907_util/bucts/
</span><span class='line'>libreboot_r20160907_util/bucts/x86_64/
</span><span class='line'>libreboot_r20160907_util/bucts/x86_64/bucts
</span><span class='line'>libreboot_r20160907_util/bucts/i686/
</span><span class='line'>libreboot_r20160907_util/bucts/i686/bucts
</span><span class='line'>libreboot_r20160907_util/flashrom/
</span><span class='line'>libreboot_r20160907_util/flashrom/x86_64/
</span><span class='line'>libreboot_r20160907_util/flashrom/x86_64/flashrom
</span><span class='line'>libreboot_r20160907_util/flashrom/x86_64/flashrom_lenovobios_sst
</span><span class='line'>libreboot_r20160907_util/flashrom/x86_64/flashrom_lenovobios_macronix
</span><span class='line'>libreboot_r20160907_util/flashrom/armv7l/
</span><span class='line'>libreboot_r20160907_util/flashrom/armv7l/flashrom
</span><span class='line'>libreboot_r20160907_util/flashrom/i686/
</span><span class='line'>libreboot_r20160907_util/flashrom/i686/flashrom
</span><span class='line'>libreboot_r20160907_util/flashrom/i686/flashrom_lenovobios_macronix
</span><span class='line'>libreboot_r20160907_util/flashrom/i686/flashrom_lenovobios_sst
</span><span class='line'>libreboot_r20160907_util/cbfstool/
</span><span class='line'>libreboot_r20160907_util/cbfstool/x86_64/
</span><span class='line'>libreboot_r20160907_util/cbfstool/x86_64/cbfstool
</span><span class='line'>libreboot_r20160907_util/cbfstool/i686/
</span><span class='line'>libreboot_r20160907_util/cbfstool/i686/cbfstool
</span><span class='line'>libreboot_r20160907_util/cbfstool/armv7l/
</span><span class='line'>libreboot_r20160907_util/cbfstool/armv7l/cbfstool
</span><span class='line'>libreboot_r20160907_util/ich9deblob/
</span><span class='line'>libreboot_r20160907_util/ich9deblob/x86_64/
</span><span class='line'>libreboot_r20160907_util/ich9deblob/x86_64/ich9deblob
</span><span class='line'>libreboot_r20160907_util/ich9deblob/x86_64/ich9gen
</span><span class='line'>libreboot_r20160907_util/ich9deblob/x86_64/demefactory
</span><span class='line'>libreboot_r20160907_util/ich9deblob/i686/
</span><span class='line'>libreboot_r20160907_util/ich9deblob/i686/ich9deblob
</span><span class='line'>libreboot_r20160907_util/ich9deblob/i686/ich9gen
</span><span class='line'>libreboot_r20160907_util/ich9deblob/i686/demefactory
</span><span class='line'>libreboot_r20160907_util/ich9deblob/armv7l/
</span><span class='line'>libreboot_r20160907_util/ich9deblob/armv7l/ich9deblob
</span><span class='line'>libreboot_r20160907_util/ich9deblob/armv7l/ich9gen
</span><span class='line'>libreboot_r20160907_util/ich9deblob/armv7l/demefactory
</span><span class='line'>libreboot_r20160907_util/nvramtool/
</span><span class='line'>libreboot_r20160907_util/nvramtool/x86_64/
</span><span class='line'>libreboot_r20160907_util/nvramtool/x86_64/nvramtool
</span><span class='line'>libreboot_r20160907_util/nvramtool/i686/
</span><span class='line'>libreboot_r20160907_util/nvramtool/i686/nvramtool
</span><span class='line'>libreboot_r20160907_util/flash
</span><span class='line'>libreboot_r20160907_util/powertop.trisquel7
</span><span class='line'>libreboot_r20160907_util/ChangeLog
</span><span class='line'>libreboot_r20160907_util/NEWS
</span><span class='line'>libreboot_r20160907_util/version
</span><span class='line'>libreboot_r20160907_util/versiondate
</span><span class='line'>pi@raspberrypi:~/libreboot $ </span></code></pre></td></tr></table></div></figure>


<h6>## find the ich9gen utility for architecture</h6>

<p>find ./libreboot_r20160907_util | grep -i ich9gen</p>

<p>To make our lives easier we will copy ich9gen binary to the directory that holds our libreboot images.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~/libreboot $ find ./libreboot_r20160907_util | grep -i ich9gen
</span><span class='line'>./libreboot_r20160907_util/ich9deblob/i686/ich9gen
</span><span class='line'>./libreboot_r20160907_util/ich9deblob/armv7l/ich9gen
</span><span class='line'>./libreboot_r20160907_util/ich9deblob/x86_64/ich9gen
</span><span class='line'>pi@raspberrypi:~/libreboot $ cp ./libreboot_r20160907_util/ich9deblob/armv7l/ich9gen .</span></code></pre></td></tr></table></div></figure>


<h6>## burn the MAC address into the rom/save</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~/libreboot $ ./ich9gen --macaddress XX:XX:XX:XX:XX:XX
</span><span class='line'>You selected to change the MAC address in the Gbe section. This has been done.
</span><span class='line'>
</span><span class='line'>The modified gbe region has also been dumped as src files: mkgbe.c, mkgbe.h
</span><span class='line'>To use these in ich9gen, place them in src/ich9gen/ and re-build ich9gen.
</span><span class='line'>
</span><span class='line'>descriptor and gbe successfully written to the file: ich9fdgbe_4m.bin
</span><span class='line'>Now do: dd if=ich9fdgbe_4m.bin of=libreboot.rom bs=1 count=12k conv=notrunc
</span><span class='line'>(in other words, add the modified descriptor+gbe to your ROM image)
</span><span class='line'>
</span><span class='line'>descriptor and gbe successfully written to the file: ich9fdgbe_8m.bin
</span><span class='line'>Now do: dd if=ich9fdgbe_8m.bin of=libreboot.rom bs=1 count=12k conv=notrunc
</span><span class='line'>(in other words, add the modified descriptor+gbe to your ROM image)
</span><span class='line'>
</span><span class='line'>descriptor and gbe successfully written to the file: ich9fdgbe_16m.bin
</span><span class='line'>Now do: dd if=ich9fdgbe_16m.bin of=libreboot.rom bs=1 count=12k conv=notrunc
</span><span class='line'>(in other words, add the modified descriptor+gbe to your ROM image)
</span><span class='line'>
</span><span class='line'>descriptor successfully written to the file: ich9fdnogbe_4m.bin
</span><span class='line'>Now do: dd if=ich9fdnogbe_4m.bin of=yourrom.rom bs=1 count=4k conv=notrunc
</span><span class='line'>(in other words, add the modified descriptor to your ROM image)
</span><span class='line'>
</span><span class='line'>descriptor successfully written to the file: ich9fdnogbe_8m.bin
</span><span class='line'>Now do: dd if=ich9fdnogbe_8m.bin of=yourrom.rom bs=1 count=4k conv=notrunc
</span><span class='line'>(in other words, add the modified descriptor to your ROM image)
</span><span class='line'>
</span><span class='line'>descriptor successfully written to the file: ich9fdnogbe_16m.bin
</span><span class='line'>Now do: dd if=ich9fdnogbe_16m.bin of=yourrom.rom bs=1 count=4k conv=notrunc
</span><span class='line'>(in other words, add the modified descriptor to your ROM image)</span></code></pre></td></tr></table></div></figure>


<p>Insert the mac into your rom</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~/libreboot $ dd if=ich9fdgbe_8m.bin of=libreboot.rom bs=12k count=1 conv=notrunc
</span><span class='line'>1+0 records in
</span><span class='line'>1+0 records out
</span><span class='line'>12288 bytes (12 kB, 12 KiB) copied, 0.00883476 s, 1.4 MB/s
</span><span class='line'>pi@raspberrypi:~/libreboot $ ls -lh libreboot.rom
</span><span class='line'>-rw-r--r-- 1 pi pi 8.0M Jan 27 09:38 libreboot.rom
</span><span class='line'>pi@raspberrypi:~/libreboot $ 
</span></code></pre></td></tr></table></div></figure>


<h6>## flash it</h6>

<p>Flash your Libreboot image to your BIOS.</p>

<p>Make sure that you get the <code>Verifying flash... VERIFIED</code> message, if you don&rsquo;t get this message try it again until you get it. I needed to do it twice&hellip;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~/libreboot $ sudo flashrom -c "MX25L6405D" -p linux_spi:dev=/dev/spidev0.0,spispeed=512 -w libreboot.rom 
</span><span class='line'>flashrom v0.9.9-r1954 on Linux 4.14.79+ (armv6l)
</span><span class='line'>flashrom is free software, get the source code at https://flashrom.org
</span><span class='line'>
</span><span class='line'>Calibrating delay loop... OK.
</span><span class='line'>Found Macronix flash chip "MX25L6405D" (8192 kB, SPI) on linux_spi.
</span><span class='line'>Reading old flash chip contents... done.
</span><span class='line'>Erasing and writing flash chip... Erase/write done.
</span><span class='line'>Verifying flash... FAILED at 0x000c9f01! Expected=0x6b, Found=0xe9, failed byte count from 0x00000000-0x007fffff: 0x2
</span><span class='line'>Your flash chip is in an unknown state.
</span><span class='line'>Please report this on IRC at chat.freenode.net (channel #flashrom) or
</span><span class='line'>mail flashrom@flashrom.org, thanks!
</span><span class='line'>pi@raspberrypi:~/libreboot $ 
</span><span class='line'>pi@raspberrypi:~/libreboot $ sudo flashrom -c "MX25L6405D" -p linux_spi:dev=/dev/spidev0.0,spispeed=512 -w libreboot.rom 
</span><span class='line'>flashrom v0.9.9-r1954 on Linux 4.14.79+ (armv6l)
</span><span class='line'>flashrom is free software, get the source code at https://flashrom.org
</span><span class='line'>
</span><span class='line'>Calibrating delay loop... OK.
</span><span class='line'>Found Macronix flash chip "MX25L6405D" (8192 kB, SPI) on linux_spi.
</span><span class='line'>Reading old flash chip contents... done.
</span><span class='line'>Erasing and writing flash chip... Erase/write done.
</span><span class='line'>Verifying flash... VERIFIED.
</span><span class='line'>pi@raspberrypi:~/libreboot $ </span></code></pre></td></tr></table></div></figure>


<h1>Almost done</h1>

<h2>GNU/Linux</h2>

<p><a href="/blog/images/w500_in_action.jpg"><img src="/blog/images/w500_in_action.jpg" width="700" height="466" alt="w500_in_action.jpg" /></a></p>

<p>I use <a href="https://www.parabola.nu/">Parabola GNU/Linux</a> on my W500.</p>

<h2>Wifi Card</h2>

<p>The intel wifi card that Lenovo uses on the W500 isn&rsquo;t supported without a binary blob. With the original Lenovo BIOS you are forced to use certified PCI card. Libreboot doesn&rsquo;t have this restriction this is another advantage of using an alternative BIOS like Libreboot or <a href="https://www.coreboot.org/">Coreboot</a> . I replaced wifi an Atheros from <a href="https://www.ebay.be">ebay</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@snuffel ~]$ sudo lspci | grep -i Atheros
</span><span class='line'>02:00.0 Network controller: Qualcomm Atheros AR93xx Wireless Network Adapter (rev 01)
</span><span class='line'>[staf@snuffel ~]$</span></code></pre></td></tr></table></div></figure>


<h2>ACPI</h2>

<p>It is recommended to load the thinkpad-acpi module. Make sure that <code>fan_control=1</code> is enabled.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@snuffel ~]$ cat /usr/lib/modprobe.d/thinkpad_acpi.conf
</span><span class='line'>options thinkpad_acpi fan_control=1
</span><span class='line'>[staf@snuffel ~]$</span></code></pre></td></tr></table></div></figure>


<p>Execute <code>modprobe thindpad_acpi</code> to load the module</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@snuffel ~]$ sudo modprobe thinkpad_acpi
</span><span class='line'>[sudo] password for staf:
</span><span class='line'>[staf@snuffel ~]$</span></code></pre></td></tr></table></div></figure>


<h2>thinkfan</h2>

<p>The Intel core duo is still a captable CPU. Even video playback in Full-HD is possible but it takes already a lot of the CPU and the temperature is increasing during the playback.</p>

<p>I installed <a href="https://github.com/vmatare/thinkfan/">thinkfan</a> with a more aggresive cooling profile to keep the CPU temperature under control.</p>

<p>Install thinkfan</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@snuffel ~]$ yay -S thinkfan
</span><span class='line'>warning: thinkfan-0.9.3-1 is up to date -- reinstalling
</span><span class='line'>resolving dependencies...
</span><span class='line'>looking for conflicting packages...
</span><span class='line'>
</span><span class='line'>Packages (1) thinkfan-0.9.3-1
</span><span class='line'>
</span><span class='line'>Total Installed Size:  0.11 MiB
</span><span class='line'>Net Upgrade Size:      0.00 MiB
</span><span class='line'>
</span><span class='line'>:: Proceed with installation? [Y/n]</span></code></pre></td></tr></table></div></figure>


<p>copy the sample configuration</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@snuffel ~]$ sudo cp /usr/share/doc/thinkfan/examples/thinkfan.conf.simple /etc/thinkfan.con</span></code></pre></td></tr></table></div></figure>


<p>Edit <code>/etc/thinkfan.conf</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(0,  0,  50)
</span><span class='line'>(1,   49, 52)
</span><span class='line'>(2,   51, 54)
</span><span class='line'>(3,   53, 56)
</span><span class='line'>(4,   55, 58)
</span><span class='line'>(5,   57, 60)
</span><span class='line'>(7,   59, 32767)</span></code></pre></td></tr></table></div></figure>


<p>Enable and start thinkfan</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@snuffel ~]$ sudo systemctl enable thinkfan
</span><span class='line'>[sudo] password for staf:
</span><span class='line'>[staf@snuffel ~]$ sudo systemctl start thinkfan
</span><span class='line'>[staf@snuffel ~]$</span></code></pre></td></tr></table></div></figure>


<p><strong><em>Have fun</em></strong></p>

<h1>Links</h1>

<ul>
<li><a href="https://libreboot.org/">https://libreboot.org/</a></li>
<li><a href="https://libreboot.org/docs/install/rpi_setup.html">https://libreboot.org/docs/install/rpi_setup.html</a></li>
<li><a href="https://libreboot.org/docs/install/t500_external.html">https://libreboot.org/docs/install/t500_external.html</a></li>
<li><a href="https://p1trson.blogspot.com/2016/">https://p1trson.blogspot.com/2016/</a></li>
<li><a href="https://www.raspberrypi-spy.co.uk/2012/06/simple-guide-to-the-rpi-gpio-header-and-pins/#prettyPhoto">https://www.raspberrypi-spy.co.uk/2012/06/simple-guide-to-the-rpi-gpio-header-and-pins/#prettyPhoto</a></li>
<li><a href="https://forums.lenovo.com/t5/ThinkPad-T400-T500-and-newer-T/t500-bios-chip-lifted-pad-issue/td-p/4205719">https://forums.lenovo.com/t5/ThinkPad-T400-T500-and-newer-T/t500-bios-chip-lifted-pad-issue/td-p/4205719</a></li>
<li><a href="https://www.raspberrypi.org/documentation/hardware/raspberrypi/spi/README.md">https://www.raspberrypi.org/documentation/hardware/raspberrypi/spi/README.md</a></li>
<li><a href="https://linuxhint.com/libreboot-t400-tutorial/">https://linuxhint.com/libreboot-t400-tutorial/</a></li>
<li><a href="https://www.enisa.europa.eu/publications/info-notes/security-vs-performance-discussion-with-the-return-of-201cspectrum201d-vulnerability">https://www.enisa.europa.eu/publications/info-notes/security-vs-performance-discussion-with-the-return-of-201cspectrum201d-vulnerability</a></li>
<li><a href="https://wiki.archlinux.org/index.php/Lenovo_ThinkPad_T420">https://wiki.archlinux.org/index.php/Lenovo_ThinkPad_T420</a></li>
</ul>

</div>
  
  

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog_actrikel -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4659298941528586"
     data-ad-slot="7394058542"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2019/01/21/settinp-up-openstack-ansible-all-in-one-on-a-centos-7-system/">Setting Up OpenStack-Ansible All-In-One on a Centos 7 System</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-01-21T19:51:32+01:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2019</span></span> <span class='time'>7:51 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img class="right" src="/blog/images/openstack-logo.png" width="150" height="150" title="&#34;openstack-logo&#34;" alt="&#34;openstack-logo&#34;"></p>

<p><a href="https://www.openstack.org/">Openstack</a> is a nice platform to deploy <a href="https://en.wikipedia.org/wiki/Cloud_computing#Infrastructure_as_a_service_.28IaaS.29">an Infrastructure as a service</a> and is a <a href="https://governance.openstack.org/tc/reference/projects/index.html">collection of projects</a> but it can be a bit difficult to setup. <a href="https://docs.openstack.org">The documentation</a> is really great if you want to setup openstack by hand and there are a few openstack distributions that makes it easier to install it.</p>

<p><a href="https://www.ansible.org">Ansible</a> is a very nice tool for system automatisation and is one that&rsquo;s easier to learn.</p>

<p><img class="left" src="/blog/images/ansible-logo-red-t.png" width="150" height="150" title="&#34;ansible-logo-red&#34;" alt="&#34;ansible-logo-red&#34;"></p>

<p>Wouldn&rsquo;t be nice if we could make the openstack installation easier with ansible? That&rsquo;s exactly what <a href="https://github.com/openstack/openstack-ansible">Openstack-Ansible</a>
 does.</p>

<p>In this blog post we&rsquo;ll setup <a href="https://docs.openstack.org/openstack-ansible/latest/user/aio/quickstart.html">&ldquo;an all-in-one&rdquo; openstack installation</a> on <a href="https://www.centos.org">Centos 7</a>. The installer will install openstack into <a href="https://linuxcontainers.org/">lxc containers</a> and it&rsquo;s nice way to learn how openstack works and how to operate it.</p>

<h1>Preparation</h1>

<h2>System requirements</h2>

<p>I use a Centos 7 virtual system running as a <a href="https://www.linux-kvm.org">KVM</a> instance with <a href="http://stafwag.github.io/blog/blog/2018/06/04/nested-virtualization-in-kvm/">nested KVM virtualasation enabled</a>. The system requiremensts
The minimun requiremenst are:</p>

<ul>
<li>8 CPU cores</li>
<li>50 GB of free diskspace</li>
<li>8GB RAM</li>
</ul>


<h2>update &hellip;.</h2>

<p>Make sure that your system is up-to-update</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@openstack ~]$ sudo yum update -y
</span><span class='line'>
</span><span class='line'>We trust you have received the usual lecture from the local System
</span><span class='line'>Administrator. It usually boils down to these three things:
</span><span class='line'>
</span><span class='line'>    #1) Respect the privacy of others.
</span><span class='line'>    #2) Think before you type.
</span><span class='line'>    #3) With great power comes great responsibility.
</span><span class='line'>
</span><span class='line'>[sudo] password for staf: 
</span><span class='line'>Loaded plugins: fastestmirror
</span><span class='line'>Loading mirror speeds from cached hostfile
</span><span class='line'> * base: distrib-coffee.ipsl.jussieu.fr
</span><span class='line'> * extras: mirror.in2p3.fr
</span><span class='line'> * updates: centos.mirror.fr.planethoster.net
</span><span class='line'>base                                                                                                                                    | 3.6 kB  00:00:00     
</span><span class='line'>extras                                                                                                                                  | 3.4 kB  00:00:00     
</span><span class='line'>updates                                                                                                                                 | 3.4 kB  00:00:00     
</span><span class='line'>No packages marked for update
</span><span class='line'>[staf@openstack ~]$ </span></code></pre></td></tr></table></div></figure>


<h2>Install git</h2>

<p>We&rsquo;ll need git to install the ansible playbooks and the Openstack-Ansible installation scripts.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@openstack ~]$ yum install git
</span><span class='line'>Loaded plugins: fastestmirror
</span><span class='line'>You need to be root to perform this command.
</span><span class='line'>[staf@openstack ~]$ sudo yum install git
</span><span class='line'>Loaded plugins: fastestmirror
</span><span class='line'>Loading mirror speeds from cached hostfile
</span><span class='line'> * base: mirror.in2p3.fr
</span><span class='line'> * extras: mirror.in2p3.fr
</span><span class='line'> * updates: centos.mirror.fr.planethoster.net
</span><span class='line'>Package git-1.8.3.1-20.el7.x86_64 already installed and latest version
</span><span class='line'>Nothing to do
</span><span class='line'>[staf@openstack ~]$ </span></code></pre></td></tr></table></div></figure>


<h2>Ansible&hellip;.</h2>

<p>This is a bit of a pitfail&hellip; The Openstack-Ansible bootstrap script will download and install his own version of ansible and create a link to <code>/usr/local/bin</code>. So <code>/usr/local/bin</code> must be in your $PATH.  Ansible shouldn&rsquo;t be installed on your system or if it is installed  it shouln&rsquo;t be executed instead of the ansible version that is builded with Openstack-Ansible.</p>

<p>On most GNU/Linux distributions have <code>/usr/local/bin</code> and <code>/usr/local/sbin</code>  is in the $PATH but not on centos, so we&rsquo;ll need to add it.</p>

<h3>Make sure that ansible insn&rsquo;t installed</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@openstack ~]$ sudo rpm -qa | grep -i ansible
</span><span class='line'>[sudo] password for staf: 
</span><span class='line'>[staf@openstack ~]$ </span></code></pre></td></tr></table></div></figure>


<h3>Update your $PATH</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@openstack ~]# export PATH=/usr/local/bin:$PATH</span></code></pre></td></tr></table></div></figure>


<p>If you want to have <code>/usr/local/bin</code> in your $PATH  update <code>/etc/profile</code>  or <code>$HOME/.profile</code></p>

<h2>ssh password authentication</h2>

<p>The ansibe playbooks will disable <code>PasswordAuthentication</code>, make sure that you login with a ssh key. - Password authentication is obsolete anyway -</p>

<h2>firewalld</h2>

<p>Firewall is enabled on Centos by default, the default iptables rules prevent communication between the openstack containers.</p>

<h3>stop and disable firewalld</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@openstack ~]# systemctl stop firewalld
</span><span class='line'>[root@openstack ~]# systemctl disable firewalld
</span><span class='line'>Removed symlink /etc/systemd/system/multi-user.target.wants/firewalld.service.
</span><span class='line'>Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service.</span></code></pre></td></tr></table></div></figure>


<h3>verify</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@openstack ~]# iptables -L
</span><span class='line'>Chain INPUT (policy ACCEPT)
</span><span class='line'>target     prot opt source               destination         
</span><span class='line'>
</span><span class='line'>Chain FORWARD (policy ACCEPT)
</span><span class='line'>target     prot opt source               destination         
</span><span class='line'>
</span><span class='line'>Chain OUTPUT (policy ACCEPT)
</span><span class='line'>target     prot opt source               destination         
</span><span class='line'>[root@openstack ~]# </span></code></pre></td></tr></table></div></figure>


<h1>Openstack installation</h1>

<p>The installation will take some time therefor it&rsquo;s recommended to use an session manager like <a href="https://github.com/tmux/tmux/">tmux</a> or <a href="https://www.gnu.org/software/screen/">GNU screen</a></p>

<h2>Bootstrap</h2>

<h3>git clone</h3>

<p>clone the <a href="https://git.openstack.org/openstack/openstack-ansible">openstack-ansible git repo</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@openstack ~]# git clone https://git.openstack.org/openstack/openstack-ansible /opt/openstack-ansible
</span><span class='line'>Cloning into '/opt/openstack-ansible'...
</span><span class='line'>remote: Counting objects: 67055, done.
</span><span class='line'>remote: Compressing objects: 100% (32165/32165), done.
</span><span class='line'>remote: Total 67055 (delta 45474), reused 52564 (delta 32073)
</span><span class='line'>Receiving objects: 100% (67055/67055), 14.60 MiB | 720.00 KiB/s, done.
</span><span class='line'>Resolving deltas: 100% (45474/45474), done.
</span><span class='line'>[root@openstack ~]# </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@openstack ~]# cd /opt/openstack-ansible
</span><span class='line'>[root@openstack openstack-ansible]# </span></code></pre></td></tr></table></div></figure>


<h3>choose you Openstack releases</h3>

<p>Openstack has release shedule about every 6 months the current stable release is <a href="https://releases.openstack.org/rocky/index.html">Rocky</a>. Every Openstack release has his own branch in the git repo. Each Openstack-Ansible release is tagged in the git repo. So either you&rsquo;ll need checkout Openstack-Ansible release tag or the bracnh. We&rsquo;ll checkout the Rocky branch.</p>

<h4>get the list of branches</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@openstack openstack-ansible]# git branch -a
</span><span class='line'>* master
</span><span class='line'>  remotes/origin/HEAD -&gt; origin/master
</span><span class='line'>  remotes/origin/master
</span><span class='line'>  remotes/origin/stable/ocata
</span><span class='line'>  remotes/origin/stable/pike
</span><span class='line'>  remotes/origin/stable/queens
</span><span class='line'>  remotes/origin/stable/rocky
</span><span class='line'>[root@openstack openstack-ansible]# </span></code></pre></td></tr></table></div></figure>


<h5>checkout the branch</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@openstack openstack-ansible]# git checkout stable/rocky
</span><span class='line'>Branch stable/rocky set up to track remote branch stable/rocky from origin.
</span><span class='line'>Switched to a new branch 'stable/rocky'
</span><span class='line'>[root@openstack openstack-ansible]# 
</span></code></pre></td></tr></table></div></figure>


<h3>Bootstrap ansible</h3>

<p>Execute <code>scripts/bootstrap-ansible.sh</code> this will install the required packages and ansible playbooks.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@openstack openstack-ansible]# scripts/bootstrap-ansible.sh
</span><span class='line'>+ export HTTP_PROXY=
</span><span class='line'>+ HTTP_PROXY=
</span><span class='line'>+ export HTTPS_PROXY=
</span><span class='line'>+ HTTPS_PROXY=
</span><span class='line'>+ export ANSIBLE_PACKAGE=ansible==2.5.14
</span><span class='line'>+ ANSIBLE_PACKAGE=ansible==2.5.14
</span><span class='line'>+ export ANSIBLE_ROLE_FILE=ansible-role-requirements.yml
</span><span class='line'>+ ANSIBLE_ROLE_FILE=ansible-role-requirements.yml
</span><span class='line'>+ export SSH_DIR=/root/.ssh
</span><span class='line'>+ SSH_DIR=/root/.ssh
</span><span class='line'>+ export DEBIAN_FRONTEND=noninteractive
</span><span class='line'>+ DEBIAN_FRONTEND=noninteractive
</span><span class='line'>&lt;SNIP&gt;
</span><span class='line'>+ unset ANSIBLE_LIBRARY
</span><span class='line'>+ unset ANSIBLE_LOOKUP_PLUGINS
</span><span class='line'>+ unset ANSIBLE_FILTER_PLUGINS
</span><span class='line'>+ unset ANSIBLE_ACTION_PLUGINS
</span><span class='line'>+ unset ANSIBLE_CALLBACK_PLUGINS
</span><span class='line'>+ unset ANSIBLE_CALLBACK_WHITELIST
</span><span class='line'>+ unset ANSIBLE_TEST_PLUGINS
</span><span class='line'>+ unset ANSIBLE_VARS_PLUGINS
</span><span class='line'>+ unset ANSIBLE_STRATEGY_PLUGINS
</span><span class='line'>+ unset ANSIBLE_CONFIG
</span><span class='line'>+ '[' false == true ']'
</span><span class='line'>+ echo 'System is bootstrapped and ready for use.'
</span><span class='line'>System is bootstrapped and ready for use.
</span><span class='line'>[root@openstack openstack-ansible]# </span></code></pre></td></tr></table></div></figure>


<h4>Verify</h4>

<p> <code>scripts/bootstrap-ansible</code> created <code>/opt/ansible-runtime</code> and create amd updated <code>//usr/local/bin</code> with a few links.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@openstack openstack-ansible]# ls -ld /opt/*
</span><span class='line'>drwxr-xr-x.  5 root root   56 Jan 12 11:42 /opt/ansible-runtime
</span><span class='line'>drwxr-xr-x. 14 root root 4096 Jan 12 11:43 /opt/openstack-ansible
</span><span class='line'>[root@openstack openstack-ansible]# ls -ltr /usr/local/bin/
</span><span class='line'>total 8
</span><span class='line'>lrwxrwxrwx. 1 root root   32 Jan 12 11:43 ansible -&gt; /usr/local/bin/openstack-ansible
</span><span class='line'>lrwxrwxrwx. 1 root root   39 Jan 12 11:43 ansible-config -&gt; /opt/ansible-runtime/bin/ansible-config
</span><span class='line'>lrwxrwxrwx. 1 root root   43 Jan 12 11:43 ansible-connection -&gt; /opt/ansible-runtime/bin/ansible-connection
</span><span class='line'>lrwxrwxrwx. 1 root root   40 Jan 12 11:43 ansible-console -&gt; /opt/ansible-runtime/bin/ansible-console
</span><span class='line'>lrwxrwxrwx. 1 root root   39 Jan 12 11:43 ansible-galaxy -&gt; /opt/ansible-runtime/bin/ansible-galaxy
</span><span class='line'>lrwxrwxrwx. 1 root root   36 Jan 12 11:43 ansible-doc -&gt; /opt/ansible-runtime/bin/ansible-doc
</span><span class='line'>lrwxrwxrwx. 1 root root   42 Jan 12 11:43 ansible-inventory -&gt; /opt/ansible-runtime/bin/ansible-inventory
</span><span class='line'>lrwxrwxrwx. 1 root root   32 Jan 12 11:43 ansible-playbook -&gt; /usr/local/bin/openstack-ansible
</span><span class='line'>lrwxrwxrwx. 1 root root   37 Jan 12 11:43 ansible-pull -&gt; /opt/ansible-runtime/bin/ansible-pull
</span><span class='line'>lrwxrwxrwx. 1 root root   38 Jan 12 11:43 ansible-vault -&gt; /opt/ansible-runtime/bin/ansible-vault
</span><span class='line'>-rw-r--r--. 1 root root 3169 Jan 12 11:43 openstack-ansible.rc
</span><span class='line'>-rwxr-xr-x. 1 root root 2638 Jan 12 11:43 openstack-ansible</span></code></pre></td></tr></table></div></figure>


<p>Verify that ansible command is one that&rsquo;s installed bu the Openstack-Ansible bootstrap script.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@openstack openstack-ansible]# which ansible
</span><span class='line'>/usr/local/bin/ansible</span></code></pre></td></tr></table></div></figure>


<h3>Bootstrap AIO</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@openstack openstack-ansible]# scripts/bootstrap-aio.sh
</span><span class='line'>+ export BOOTSTRAP_OPTS=
</span><span class='line'>+ BOOTSTRAP_OPTS=
</span><span class='line'>+++ dirname scripts/bootstrap-aio.sh
</span><span class='line'>++ readlink -f scripts/..
</span><span class='line'>+ export OSA_CLONE_DIR=/opt/openstack-ansible
</span><span class='line'>TASK [Gathering Facts] *****************************************************************************************************
</span><span class='line'>ok: [localhost]
</span><span class='line'>
</span><span class='line'>TASK [sshd : Set OS dependent variables] ***********************************************************************************
</span><span class='line'>ok: [localhost] =&gt; (item=/etc/ansible/roles/sshd/vars/RedHat_7.yml)
</span><span class='line'>
</span><span class='line'>TASK [sshd : OS is supported] **********************************************************************************************
</span><span class='line'>ok: [localhost] =&gt; {
</span><span class='line'>    "changed": false, 
</span><span class='line'>    "msg": "All assertions passed"
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>TASK [sshd : Install ssh packages] 
</span><span class='line'>&lt;SNIP&gt;
</span><span class='line'>EXIT NOTICE [Playbook execution success] **************************************
</span><span class='line'>===============================================================================
</span><span class='line'>+ popd
</span><span class='line'>/opt/openstack-ansible
</span><span class='line'>+ unset ANSIBLE_INVENTORY
</span><span class='line'>+ unset ANSIBLE_VARS_PLUGINS
</span><span class='line'>+ unset HOST_VARS_PATH
</span><span class='line'>+ unset GROUP_VARS_PATH
</span><span class='line'>[root@openstack openstack-ansible]# </span></code></pre></td></tr></table></div></figure>


<h3>Run the playbooks</h3>

<p>We&rsquo;ll to run a few playbooks to setup the containers and our Openstack environment.</p>

<p>Move to the openstack-ansible playbook directory.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@aio1 ~]# cd /opt/openstack-ansible/playbooks/
</span><span class='line'>[root@aio1 playbooks]# pwd
</span><span class='line'>/opt/openstack-ansible/playbooks
</span><span class='line'>[root@aio1 playbooks]# </span></code></pre></td></tr></table></div></figure>


<p>and exexcute the playbooks.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@openstack playbooks]# openstack-ansible setup-hosts.yml
</span><span class='line'>[root@openstack playbooks]# openstack-ansible setup-infrastructure.yml
</span><span class='line'>[root@aio1 playbooks]# openstack-ansible setup-openstack.yml</span></code></pre></td></tr></table></div></figure>


<p>If all goes well your openstack installation is completed.</p>

<p>You can verify the openstack containers with <code>lxc-ls</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@aio1 playbooks]# lxc-ls --fancy
</span><span class='line'>NAME                                   STATE   AUTOSTART GROUPS            IPV4                                           IPV6 
</span><span class='line'>aio1_cinder_api_container-c211b759     RUNNING 1         onboot, openstack 10.255.255.43, 172.29.237.244, 172.29.244.190  -    
</span><span class='line'>aio1_galera_container-9a90cbd9         RUNNING 1         onboot, openstack 10.255.255.50, 172.29.239.126                  -    
</span><span class='line'>aio1_glance_container-c05aab79         RUNNING 1         onboot, openstack 10.255.255.218, 172.29.236.160, 172.29.247.238 -    
</span><span class='line'>aio1_horizon_container-81943ba2        RUNNING 1         onboot, openstack 10.255.255.160, 172.29.237.37                  -    
</span><span class='line'>aio1_keystone_container-a5859104       RUNNING 1         onboot, openstack 10.255.255.40, 172.29.236.95                   -    
</span><span class='line'>aio1_memcached_container-ab998d0e      RUNNING 1         onboot, openstack 10.255.255.175, 172.29.239.49                  -    
</span><span class='line'>aio1_neutron_server_container-439aeb90 RUNNING 1         onboot, openstack 10.255.255.137, 172.29.239.13                  -    
</span><span class='line'>aio1_nova_api_container-c83e5ef0       RUNNING 1         onboot, openstack 10.255.255.216, 172.29.236.52                  -    
</span><span class='line'>aio1_rabbit_mq_container-4fd792fb      RUNNING 1         onboot, openstack 10.255.255.2, 172.29.239.62                    -    
</span><span class='line'>aio1_repo_container-b39d88a1           RUNNING 1         onboot, openstack 10.255.255.227, 172.29.237.146                 -    
</span><span class='line'>aio1_utility_container-fff0b6df        RUNNING 1         onboot, openstack 10.255.255.117, 172.29.237.82                  -    
</span><span class='line'>[root@aio1 playbooks]# </span></code></pre></td></tr></table></div></figure>


<h3>Find the correct ip address</h3>

<p>You should see horizon running with netstat</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@aio1 ~]# netstat -pan | grep -i 443
</span><span class='line'>tcp        0      0 172.29.236.100:443      0.0.0.0:*               LISTEN      12908/haproxy       
</span><span class='line'>tcp        0      0 192.168.122.23:443      0.0.0.0:*               LISTEN      12908/haproxy       
</span><span class='line'>unix  3      [ ]         STREAM     CONNECTED     73443    31134/tmux           
</span><span class='line'>unix  2      [ ]         DGRAM                    1244303  23435/rsyslogd       
</span><span class='line'>[root@aio1 ~]# </span></code></pre></td></tr></table></div></figure>


<h2>Logon to the openstack GUI (Horizon)</h2>

<h3>Password&hellip;</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@aio1 ~]# grep keystone_auth_admin_password /etc/openstack_deploy/user_secrets.yml</span></code></pre></td></tr></table></div></figure>


<p><img class="center" src="/blog/images/openstack-ansible-aio-login.png" width="782" height="723" title="&#34;openstack-ansible-aio-login.png&#34;" alt="&#34;openstack-ansible-aio-login.png&#34;"></p>

<p><strong><em> Have fun </em></strong></p>

<h1>Links</h1>

<ul>
<li><a href="https://docs.openstack.org/openstack-ansible/latest/user/aio/quickstart.html">https://docs.openstack.org/openstack-ansible/latest/user/aio/quickstart.html</a></li>
<li><a href="https://docs.openstack.org/project-deploy-guide/openstack-ansible/queens/deploymenthost.html">https://docs.openstack.org/project-deploy-guide/openstack-ansible/queens/deploymenthost.html</a></li>
<li><a href="https://bugs.launchpad.net/openstack-ansible/+bug/1792050">https://bugs.launchpad.net/openstack-ansible/+bug/1792050</a></li>
<li><a href="https://docs.openstack.org/openstack-ansible-security/latest/auto_controls-all.html">https://docs.openstack.org/openstack-ansible-security/latest/auto_controls-all.html</a></li>
<li><a href="https://blog.christophersmart.com/2016/08/09/setting-up-openstack-ansible-all-in-one-behind-a-proxy/">https://blog.christophersmart.com/2016/08/09/setting-up-openstack-ansible-all-in-one-behind-a-proxy/</a></li>
</ul>

</div>
  
  

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog_actrikel -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4659298941528586"
     data-ad-slot="7394058542"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2019/01/02/best-wishes-2019/">Best Wishes 2019</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-01-02T20:36:31+01:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2019</span></span> <span class='time'>8:36 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="/blog/images/2019.jpg"><img src="/blog/images/2019.jpg" class="left" width="500" height="511" alt="2019" /> </a></p>
</div>
  
  

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog_actrikel -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4659298941528586"
     data-ad-slot="7394058542"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2018/12/09/configure-dns-tls-on-opnsense/">How to Configure DNS-over-TLS on OPNsense</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-12-09T08:11:38+01:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>8:11 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>DNS-over-TLS</h1>

<p>In my <a href="https://stafwag.github.io/blog/blog/2018/09/09/dns-privacy-with-stubby-part1-gnulinux/">previous blog posts</a> we configured <a href="https://dnsprivacy.org/wiki/display/DP/DNS+Privacy+Daemon+-+Stubby">Stubby </a> on GNU/Linux and FreeBSD.</p>

<p><img class="right" src="/blog/images/Logo_OPNsense.jpg" width="300" height="85" title="&#34;Logo_OPNsense.jpg&#34;" alt="&#34;Logo_OPNsense.jpg&#34;"></p>

<p>In this blog article we&rsquo;ll configure <a href="https://en.wikipedia.org/wiki/DNS_over_TLS">DNS-over-TLS</a> with <a href="https://nlnetlabs.nl/projects/unbound/about/">Unbound</a> on <a href="https://opnsense.org/">OPNsense</a>. Both <a href="https://nlnetlabs.nl/projects/getdns/">Stubby</a> and <a href="https://nlnetlabs.nl/projects/unbound/about/">Unbound</a> are written by <a href="https://nlnet.nl/">NLnet</a>.</p>

<h2>DNS resolvers</h2>

<p>Stubby is a small dns resolver to encrypt your dns traffic, which makes it perfect to increase end-user privacy. Stubby can be integrated into existing dns setups.</p>

<p><a href="http://http://www.thekelleys.org.uk/dnsmasq/doc.html">DNSmasq</a> is small dns resolver that can cache dns queries and forward dns traffic to other dns servers.</p>

<p>Unbound is fast validating, caching DNS resolver that supports DNS-over-TLS.
Unbound or dnsmaq are not full feature dns servers like <a href="https://www.isc.org/downloads/bind/">BIND</a>.</p>

<p>The main difference beteen Unbound and DNSmasq is that Unbound can talk the the <a href="https://www.iana.org/domains/root/servers">root servers</a> directly while dnsmasq always needs to forward your dns queries to another dns server - your ISP dns server or a public dns servicve like (<a href="https://www.quad9.net/">Quad9</a>, <a href="https://1.1.1.1/">cloudfare</a>, <a href="https://developers.google.com/speed/public-dns/">google</a>, &hellip;) -</p>

<p>Unbound has build-in support for DNS-over-TLS. DNSmasq needs an external DNS-over-TLS resolver like Stubby.</p>

<h2>Which one to use?</h2>

<p>It depends - as always -, Stubby can integrating easily in existing dns setups like dnsmasq. Unbound is one package that does it all and is more feature rich compared to DNSmasq.</p>

<h1>OPNsense</h1>

<p>I use <a href="https://opnsense.org/">OPNsense</a> as my firewall. Unbound is the default dns resolver on OPNsense so it makes (OPN)sense to use Unbound.</p>

<h2>Choose your upstream DNS service</h2>

<p>There&rsquo;re a few public DNS providers that supports DNS-over-tls the best known are <a href="https://www.quad9.net/">Quad9</a>, <a href="https://1.1.1.1/">cloudfare</a>. Quad9 will block malicious domains on the default dns servers 9.9.9.9/149.112.112.10 while 9.9.9.10 has no security blocklist.</p>

<p>In this article we&rsquo;ll use Quad9 but you could also with cloudfare or another dns provider that you trust and has support for DNS-over-tls.</p>

<h2>Enable DNS-over-TLS</h2>

<p><a href="/blog/images/opnsense_enable_dns_tls.png"><img src="/blog/images/opnsense_enable_dns_tls.png" class="left" width="300" height="458" alt="opnsense_enable_dns_tls.png" /> </a></p>

<p>You need to configure your firewall to use your upstream dns provider. You also want to make sure your isp dns servers aren&rsquo;t used.</p>

<h3>Sniffing</h3>

<p> If you snif the DNS traffic on your firewall <code>tcpdump -i wan_interface udp port 53</code> you&rsquo;ll see that the DNS traffic is unencrypted.</p>

<h3>Configuration</h3>

<p>To enable DNS-over-TLS we&rsquo;ll need to reconfigure unbound.</p>

<p>Go to <strong> [ Services ] -> [Unbound DNS ] -> [General] </strong>
And copy/paste the setting below</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>server:
</span><span class='line'>forward-zone:
</span><span class='line'>name: "."
</span><span class='line'>forward-ssl-upstream: yes
</span><span class='line'>forward-addr: 9.9.9.9@853
</span><span class='line'>forward-addr: 149.112.112.112@853</span></code></pre></td></tr></table></div></figure>


<p>to <strong> Custom options </strong> these settings will reconfigure Unbound to forward the dns for the upstream dns servers Quad9 over ssl.</p>

<h3>Verify</h3>

<p>If you snif the udp  traffic on you firewall  with <code>tcpdump -i wan_interface udp port 53</code> you&rsquo;ll not see any unencrypted traffic anymore - unless not all your clients are configured to use your firewall as the dns server -.</p>

<p>If your snif TCP PORT 853 <code>tcpdump -i vr1 tcp port 853</code> we&rsquo;ll see your encrypted dns-over-tls traffic.</p>

<h2>General DNS settings</h2>

<p>You also want to make sure that your firewall isn&rsquo;t configure to use an unecrypted DNS server.</p>

<p><a href="/blog/images/opnsense_set_dns.png"><img src="/blog/images/opnsense_set_dns.png" class="right" width="300" height="693" alt="opnsense_set_dns.png" /> </a></p>

<h3>Configuration</h3>

<p>Go to <strong>[ system ] -> [ settings ] -> [ general ]</strong> and set the dns servers also make sure that <strong> [ ] Allow DNS server list to be overridden by DHCP/PPP on WAN </strong> is unchecked.</p>

<h3>Verify</h3>

<p>You can verify the configuration by logging on to your firewall over ssh and reviewing the contents of /etc/resolv.conf.</p>

<p><strong><em> Have fun! </em></strong></p>

<h1>Links</h1>

<ul>
<li><a href="https://nlnetlabs.nl/projects/unbound/">https://nlnetlabs.nl/projects/unbound/</a></li>
<li><a href="https://forum.opnsense.org/index.php?topic=7814.0">https://forum.opnsense.org/index.php?topic=7814.0</a></li>
<li><a href="https://news.ycombinator.com/item?id=17944423">https://news.ycombinator.com/item?id=17944423</a></li>
<li>[<a href="https://forum.opnsense.org/index.php?topic=9197.msg41265#msg41265">https://forum.opnsense.org/index.php?topic=9197.msg41265#msg41265</a>](<a href="https://forum.opnsense.org/index.php?topic=9197.msg41265#msg41265">https://forum.opnsense.org/index.php?topic=9197.msg41265#msg41265</a></li>
<li><a href="https://www.netgate.com/blog/dns-over-tls-with-pfsense.html">https://www.netgate.com/blog/dns-over-tls-with-pfsense.html</a></li>
<li><a href="https://forum.opnsense.org/index.php?topic=9197.msg41265#msg41265">https://forum.opnsense.org/index.php?topic=9197.msg41265#msg41265</a></li>
<li><a href="https://www.quad9.net/faq/">https://www.quad9.net/faq/</a></li>
</ul>

</div>
  
  

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog_actrikel -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4659298941528586"
     data-ad-slot="7394058542"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2018/10/07/dns-privacy-with-stubby-part-2-freebsd/">DNS Privacy With Stubby (Part 2 FreeBSD)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-10-07T09:06:05+02:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>7</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>9:06 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>FreeBSD</h1>

<p><a href="https://stafwag.github.io/blog/blog/2018/09/09/dns-privacy-with-stubby-part1-gnulinux/">In my previous blog article</a> we install on GNU/Linux which is my main desktop operation system. <a href="https://stafwag.github.io/blog/blog/2012/12/16/running-freebsd-9.0-on-asus-c60m1-i-motherboard/">My NAS</a> and the services that are required to be always running are on <a href="https://www.freebsd.org">FreeBSD</a>.</p>

<p>In this arcticle we will setup Stubby - the DNS Privacy Daemon - on FreeBSD.</p>

<h2>Jails</h2>

<p>FreeBSD jails are verify nice to keep services separated in a secure way.</p>

<h3>ezjail</h3>

<p><a href="https://erdgeist.org/arts/software/ezjail/">ezjail</a> is a very nice tool for managing FreeBSD jails.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # pkg install ezjail</span></code></pre></td></tr></table></div></figure>


<h3>To loopback or not to loopback&hellip;.</h3>

<p>The loopback ip address is mapped to the jail ip address on FreeBSD by default.
There are two options</p>

<ul>
<li>use the jail ip address, make sure that you setup a firewall rule if you want disable traffic from external.</li>
<li>use a cloned loopback interface; keep in mind that with a cloned interface this interface is shared between your jails.</li>
</ul>


<p>We&rsquo;ll use the jail ip address.</p>

<h4>create the jail</h4>

<p>We create a new jail and we assign the cloned loop interface with a loopback ip address - this loopback ip address must be unique for each for each jail - and outside interface and ip address.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # ezjail-admin create stafdns 're0|192.168.1.53'</span></code></pre></td></tr></table></div></figure>


<h4>start the jail</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:/usr/local/etc/ezjail # ezjail-admin start stafdns
</span><span class='line'>Starting jails: stafdns.
</span><span class='line'>/etc/rc.d/jail: WARNING: Per-jail configuration via jail_* variables  is obsolete.  Please consider migrating to /etc/jail.conf.
</span><span class='line'>root@rataplan:/usr/local/etc/ezjail #</span></code></pre></td></tr></table></div></figure>


<h4>console login and install pkg</h4>

<p>Logon to the jail and install pkg we might need to configure a dns server or use a proxy sever to install pkg.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:/usr/local/etc/ezjail # ezjail-admin console stafdns
</span><span class='line'>root@stafdns:~ # echo "nameserver 9.9.9.9" &gt; /etc/resolv.conf
</span><span class='line'>root@stafdns:~ # pkg
</span><span class='line'>The package management tool is not yet installed on your system.
</span><span class='line'>Do you want to fetch and install it now? [y/N]: y
</span><span class='line'>Bootstrapping pkg from pkg+http://pkg.FreeBSD.org/FreeBSD:11:amd64/quarterly, please wait...
</span><span class='line'>Verifying signature with trusted certificate pkg.freebsd.org.2013102301... done
</span><span class='line'>[stafdns] Installing pkg-1.10.5_1...
</span><span class='line'>[stafdns] Extracting pkg-1.10.5_1: 100%
</span><span class='line'>pkg: not enough arguments
</span><span class='line'>Usage: pkg [-v] [-d] [-l] [-N] [-j &lt;jail name or id&gt;|-c &lt;chroot path&gt;|-r &lt;rootdir&gt;] [-C &lt;configuration file&gt;] [-R &lt;repo config dir&gt;] [-o var=value] [-4|-6] &lt;command&gt; [&lt;args&gt;]
</span><span class='line'>
</span><span class='line'>For more information on available commands and options see 'pkg help'.
</span><span class='line'>root@stafdns:~ #
</span></code></pre></td></tr></table></div></figure>


<h2>Install stubby</h2>

<p>Stubby available in the <a href="https://www.freebsd.org/ports/">FreeBSD Ports</a> in the getdns package, &hellip;but it isn&rsquo;t installed when you install the binary package. To install stubby we need to it from source.</p>

<h3>dig</h3>

<p>To debug dns issues dig a handy tool to have&hellip;.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:/usr/ports/dns/getdns # pkg install bind-tools
</span><span class='line'>Updating FreeBSD repository catalogue...
</span><span class='line'>FreeBSD repository is up to date.
</span><span class='line'>All repositories are up to date.
</span><span class='line'>Updating database digests format: 100%
</span><span class='line'>The following 4 package(s) will be affected (of 0 checked):
</span><span class='line'>
</span><span class='line'>New packages to be INSTALLED:
</span><span class='line'>        bind-tools: 9.12.2P1
</span><span class='line'>        idnkit: 1.0_7
</span><span class='line'>        py27-ply: 3.11
</span><span class='line'>        json-c: 0.13
</span><span class='line'>
</span><span class='line'>Number of packages to be installed: 4
</span><span class='line'>
</span><span class='line'>The process will require 42 MiB more space.
</span><span class='line'>4 MiB to be downloaded.
</span><span class='line'>
</span><span class='line'>Proceed with this action? [y/N]: y</span></code></pre></td></tr></table></div></figure>


<h3>Update your ports tree</h3>

<h4>Physical system</h4>

<p>On a physical FreeBSD system execute <code>portsnap fetch</code> and <code>portsnap extract</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # portsnap fetch
</span><span class='line'>Looking up portsnap.FreeBSD.org mirrors... 6 mirrors found.
</span><span class='line'>Fetching snapshot tag from ec2-eu-west-1.portsnap.freebsd.org... done.
</span><span class='line'>Fetching snapshot metadata... done.
</span><span class='line'>Updating from Sat Sep  8 09:31:35 CEST 2018 to Sun Sep  9 09:51:49 CEST 2018.
</span><span class='line'>Fetching 4 metadata patches... done.
</span><span class='line'>Applying metadata patches... done.
</span><span class='line'>Fetching 0 metadata files... done.
</span><span class='line'>Fetching 44 patches. 
</span><span class='line'>(44/44) 100.00%  done.                                
</span><span class='line'>done.
</span><span class='line'>Applying patches... 
</span><span class='line'>done.
</span><span class='line'>Fetching 2 new ports or files... done.
</span><span class='line'>root@rataplan:~ # </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # portsnap extract
</span><span class='line'>/usr/ports/.arcconfig
</span><span class='line'>/usr/ports/.gitattributes
</span><span class='line'>/usr/ports/.gitauthors
</span><span class='line'>/usr/ports/.gitignore
</span><span class='line'>/usr/ports/.gitmessage
</span><span class='line'>/usr/ports/CHANGES
</span><span class='line'>/usr/ports/CONTRIBUTING.md
</span><span class='line'>/usr/ports/COPYRIGHT
</span><span class='line'>/usr/ports/GIDs
</span><span class='line'>/usr/ports/Keywords/desktop-file-utils.ucl
</span><span class='line'>/usr/ports/Keywords/fc.ucl
</span><span class='line'>/usr/ports/Keywords/fcfontsdir.ucl
</span><span class='line'>
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>
</span><span class='line'>/usr/ports/x11/xzoom/
</span><span class='line'>/usr/ports/x11/yad/
</span><span class='line'>/usr/ports/x11/yakuake-kde4/
</span><span class='line'>/usr/ports/x11/yakuake/
</span><span class='line'>/usr/ports/x11/yalias/
</span><span class='line'>/usr/ports/x11/yeahconsole/
</span><span class='line'>/usr/ports/x11/yelp/
</span><span class='line'>/usr/ports/x11/zenity/
</span><span class='line'>Building new INDEX files... done.</span></code></pre></td></tr></table></div></figure>


<h4>Jail</h4>

<p>I use <a href="https://erdgeist.org/arts/software/ezjail/">ezjail</a> to manage my <a href="https://www.freebsd.org/doc/handbook/jails.html">FreeBSD jails</a>. Execute the <code>ezjail-admin update -P</code> to update the ports tree inside your jails.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # ezjail-admin update -P
</span><span class='line'>Looking up portsnap.FreeBSD.org mirrors... 6 mirrors found.
</span><span class='line'>Fetching snapshot tag from ec2-eu-west-1.portsnap.freebsd.org... done.
</span><span class='line'>Ports tree hasn't changed since last snapshot.
</span><span class='line'>No updates needed.
</span><span class='line'>Removing old files and directories... done.
</span><span class='line'>Extracting new files:
</span><span class='line'>/usr/jails/basejail/usr/ports/archivers/py-lz4/
</span><span class='line'>/usr/jails/basejail/usr/ports/astro/wmsolar/
</span><span class='line'>/usr/jails/basejail/usr/ports/audio/musicpd/
</span><span class='line'>/usr/jails/basejail/usr/ports/biology/seaview/
</span><span class='line'>/usr/jails/basejail/usr/ports/deskutils/gsimplecal/
</span><span class='line'>/usr/jails/basejail/usr/ports/deskutils/xfce4-tumbler/
</span><span class='line'>/usr/jails/basejail/usr/ports/devel/eric6/
</span><span class='line'>/usr/jails/basejail/usr/ports/devel/es-eric6/
</span><span class='line'>/usr/jails/basejail/usr/ports/devel/ioncube/
</span><span class='line'>/usr/jails/basejail/usr/ports/devel/liblouis/
</span><span class='line'>/usr/jails/basejail/usr/ports/devel/monodevelop/
</span><span class='line'>/usr/jails/basejail/usr/ports/devel/rudeconfig/
</span><span class='line'>/usr/jails/basejail/usr/ports/emulators/ppsspp-qt5/
</span><span class='line'>/usr/jails/basejail/usr/ports/emulators/ppsspp/
</span><span class='line'>/usr/jails/basejail/usr/ports/german/eric6/
</span><span class='line'>/usr/jails/basejail/usr/ports/java/linux-oracle-jdk10/
</span><span class='line'>/usr/jails/basejail/usr/ports/java/linux-oracle-jre10/
</span><span class='line'>/usr/jails/basejail/usr/ports/java/openjdk8/
</span><span class='line'>/usr/jails/basejail/usr/ports/lang/gcc6-devel/
</span><span class='line'>/usr/jails/basejail/usr/ports/lang/gcc7-devel/
</span><span class='line'>/usr/jails/basejail/usr/ports/lang/gcc8-devel/
</span><span class='line'>/usr/jails/basejail/usr/ports/lang/gcc9-devel/
</span><span class='line'>/usr/jails/basejail/usr/ports/misc/ree/
</span><span class='line'>/usr/jails/basejail/usr/ports/net-im/psi/
</span><span class='line'>/usr/jails/basejail/usr/ports/net-mgmt/p5-Net-SNMP/
</span><span class='line'>/usr/jails/basejail/usr/ports/net/Makefile
</span><span class='line'>/usr/jails/basejail/usr/ports/net/charm/
</span><span class='line'>/usr/jails/basejail/usr/ports/net/linknx/
</span><span class='line'>/usr/jails/basejail/usr/ports/net/py-maxminddb/
</span><span class='line'>/usr/jails/basejail/usr/ports/net/py-shodan/
</span><span class='line'>/usr/jails/basejail/usr/ports/net/tcpreen/
</span><span class='line'>/usr/jails/basejail/usr/ports/ports-mgmt/pkg-devel/
</span><span class='line'>/usr/jails/basejail/usr/ports/print/ghostscript9-agpl-base/
</span><span class='line'>/usr/jails/basejail/usr/ports/russian/eric6/
</span><span class='line'>/usr/jails/basejail/usr/ports/science/Makefile
</span><span class='line'>/usr/jails/basejail/usr/ports/science/metaphysicl/
</span><span class='line'>/usr/jails/basejail/usr/ports/science/namd/
</span><span class='line'>/usr/jails/basejail/usr/ports/security/sancp/
</span><span class='line'>/usr/jails/basejail/usr/ports/security/testssl.sh/
</span><span class='line'>/usr/jails/basejail/usr/ports/textproc/scim-bridge/
</span><span class='line'>/usr/jails/basejail/usr/ports/www/orangehrm/
</span><span class='line'>/usr/jails/basejail/usr/ports/www/smarty3/
</span><span class='line'>/usr/jails/basejail/usr/ports/www/tinytinyhttpd/
</span><span class='line'>/usr/jails/basejail/usr/ports/x11-wm/spectrwm/
</span><span class='line'>/usr/jails/basejail/usr/ports/x11/plasma5-plasma-workspace/
</span><span class='line'>/usr/jails/basejail/usr/ports/x11/sddm/
</span><span class='line'>Building new INDEX files... done.
</span><span class='line'>root@rataplan:~ # </span></code></pre></td></tr></table></div></figure>


<h3>Install stubby</h3>

<p>Go to the getdns ports directory</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/root # cd /usr/ports/dns/getdns/
</span><span class='line'>root@stafproxy:/usr/ports/dns/getdns # make config</span></code></pre></td></tr></table></div></figure>


<p>and run <code>make config</code> select <code>[ ] STUBBY    Build with Stubby DNS/TLS resolver</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> getdns-1.4.2 
</span><span class='line'>  
</span><span class='line'> +[x] DOCS      Build and/or install documentation                          
</span><span class='line'> +[ ] LIBEV     Build with libev extension                                  
</span><span class='line'> +[ ] LIBEVENT  Build with libevent extension                               
</span><span class='line'> +[ ] LIBUV     Build with libuv extension                                  
</span><span class='line'> +[x] STUBBY    Build with Stubby DNS/TLS resolver                          
</span><span class='line'>  
</span><span class='line'>
</span><span class='line'>                       &lt;  OK  &gt;            &lt;Cancel&gt;                           
</span><span class='line'></span></code></pre></td></tr></table></div></figure>


<p>run <code>make</code> and accept the defaults.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/ports/dns/getdns # make
</span><span class='line'>===&gt;  License BSD3CLAUSE accepted by the user
</span><span class='line'>===&gt;   getdns-1.4.2 depends on file: /usr/local/sbin/pkg - found
</span><span class='line'>=&gt; getdns-1.4.2.tar.gz doesn't seem to exist in /var/ports/distfiles/.
</span><span class='line'>=&gt; Attempting to fetch https://getdnsapi.net/dist/getdns-1.4.2.tar.gz
</span><span class='line'>getdns-1.4.2.tar.gz                           100% of 1034 kB 1092 kBps 00m01s
</span><span class='line'>===&gt; Fetching all distfiles required by getdns-1.4.2 for building
</span><span class='line'>===&gt;  Extracting for getdns-1.4.2
</span><span class='line'>=&gt; SHA256 Checksum OK for getdns-1.4.2.tar.gz.
</span><span class='line'>
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>
</span><span class='line'>/usr/bin/install -c -m 644 getdns_service_sync.3 /var/ports/basejail/usr/ports/dns/getdns/work/stage/usr/local/man/man3
</span><span class='line'>/usr/bin/install -c -m 644 getdns_validate_dnssec.3 /var/ports/basejail/usr/ports/dns/getdns/work/stage/usr/local/man/man3
</span><span class='line'>/usr/bin/strip /var/ports/basejail/usr/ports/dns/getdns/work/stage/usr/local/lib/libgetdns*.so.*
</span><span class='line'>/usr/bin/strip /var/ports/basejail/usr/ports/dns/getdns/work/stage/usr/local/bin/getdns_*
</span><span class='line'>/usr/bin/strip /var/ports/basejail/usr/ports/dns/getdns/work/stage/usr/local/bin/stubby
</span><span class='line'>/bin/mv /var/ports/basejail/usr/ports/dns/getdns/work/stage/usr/local/etc/stubby/stubby.yml  /var/ports/basejail/usr/ports/dns/getdns/work/stage/usr/local/etc/stubby/stubby.yml.sample
</span><span class='line'>====&gt; Compressing man pages (compress-man)
</span><span class='line'>===&gt; Staging rc.d startup script(s)</span></code></pre></td></tr></table></div></figure>


<p>make install</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/ports/dns/getdns # make install
</span><span class='line'>===&gt;  Installing for getdns-1.4.2
</span><span class='line'>===&gt;  Checking if getdns already installed
</span><span class='line'>===&gt;   Registering installation for getdns-1.4.2
</span><span class='line'>[stafproxy] Installing getdns-1.4.2...
</span><span class='line'>***
</span><span class='line'>***  !!! IMPORTANT !!!!  libgetdns needs a DNSSEC trust anchor!
</span><span class='line'>***
</span><span class='line'>***  For the library to be able to perform DNSSEC, the root
</span><span class='line'>***  trust anchor needs to be present in presentation format
</span><span class='line'>***  in the file:
</span><span class='line'>***     /usr/local/etc/unbound/root.key
</span><span class='line'>***
</span><span class='line'>***  We recomend using unbound-anchor to retrieve and install
</span><span class='line'>***  the root trust anchor like this:
</span><span class='line'>***     su -m unbound -c /usr/local/sbin/unbound-anchor
</span><span class='line'>***
</span><span class='line'>
</span><span class='line'>===&gt; SECURITY REPORT: 
</span><span class='line'>      This port has installed the following files which may act as network
</span><span class='line'>      servers and may therefore pose a remote security risk to the system.
</span><span class='line'>/usr/local/lib/libgetdns.a(stub.o)
</span><span class='line'>/usr/local/lib/libgetdns.so.10.0.2
</span><span class='line'>/usr/local/lib/libgetdns.a(server.o)
</span><span class='line'>
</span><span class='line'>      This port has installed the following startup scripts which may cause
</span><span class='line'>      these network services to be started at boot time.
</span><span class='line'>/usr/local/etc/rc.d/stubby
</span><span class='line'>
</span><span class='line'>      If there are vulnerabilities in these programs there may be a security
</span><span class='line'>      risk to the system. FreeBSD makes no guarantee about the security of
</span><span class='line'>      ports included in the Ports Collection. Please type 'make deinstall'
</span><span class='line'>      to deinstall the port if this is a concern.
</span><span class='line'>
</span><span class='line'>      For more information, and contact details about the security
</span><span class='line'>      status of this software, see the following webpage: 
</span><span class='line'>https://getdnsapi.net/
</span><span class='line'>root@stafproxy:/usr/ports/dns/getdns # </span></code></pre></td></tr></table></div></figure>


<p>Lock the package to avoid that the package gets replaced by a getdns package without stubby.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/ports/dns/getdns # pkg lock getdns
</span><span class='line'>getdns-1.4.2: lock this package? [y/N]: y
</span><span class='line'>Locking getdns-1.4.2
</span><span class='line'>root@stafproxy:/usr/ports/dns/getdns # </span></code></pre></td></tr></table></div></figure>


<h2>Configure stubby</h2>

<h3>Enable the stubby service</h3>

<p>Use <code>sysrc</code> to enable the stubby service&hellip;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/local/etc # service stubby start
</span><span class='line'>Cannot 'start' stubby. Set stubby_enable to YES in /etc/rc.conf or use 'onestart' instead of 'start'.
</span><span class='line'>root@stafproxy:/usr/local/etc # service stubby rcvar
</span><span class='line'># stubby
</span><span class='line'>#
</span><span class='line'>stubby_enable="NO"
</span><span class='line'>#   (default: "")
</span><span class='line'>
</span><span class='line'>root@stafproxy:/usr/local/etc # sysrc stubby_enable="YES"
</span><span class='line'>stubby_enable:  -&gt; YES
</span><span class='line'>root@stafproxy:/usr/local/etc # </span></code></pre></td></tr></table></div></figure>


<h3>choose your upstream dns provider</h3>

<p>Edit the stubby.yml file and uncomment the upstream dns server that you want the use. Stubby will loadbalance the dns traffic to all configured upstream dns servers by default. This is configured with the round_robin_upstreams directive, if set to 1 the traffic is loadbalanced, if set 0 stubby will use the first configured dns server.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:/usr/local/etc # vi stubby/stubby.yml</span></code></pre></td></tr></table></div></figure>


<h3>Change the port</h3>

<p>We&rsquo;ll setup dnsmasq to cache our dns requests modify the <code>listen_addresses</code> directive and set the port 53000</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>listen_addresses:
</span><span class='line'>  - 127.0.0.1@53000
</span><span class='line'>  - 0::1@53000</span></code></pre></td></tr></table></div></figure>


<h3>Start it</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/local/etc # service stubby start
</span><span class='line'>Starting stubby.
</span><span class='line'>[07:51:37.865826] STUBBY: Read config from file /usr/local/etc/stubby/stubby.yml
</span><span class='line'>root@stafproxy:/usr/local/etc # </span></code></pre></td></tr></table></div></figure>


<h3>test it</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/root # dig @&lt;ip_of_the_jail&gt; -p 53000 www.wagemakers.be
</span><span class='line'>
</span><span class='line'>; &lt;&lt;&gt;&gt; DiG 9.8.3-P4 &lt;&lt;&gt;&gt; @127.0.0.53 -p 53000 www.wagemakers.be
</span><span class='line'>; (1 server found)
</span><span class='line'>;; global options: +cmd
</span><span class='line'>;; Got answer:
</span><span class='line'>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 56970
</span><span class='line'>;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1
</span><span class='line'>
</span><span class='line'>;; OPT PSEUDOSECTION:
</span><span class='line'>; EDNS: version: 0, flags:; udp: 4096
</span><span class='line'>;; QUESTION SECTION:
</span><span class='line'>;www.wagemakers.be.             IN      A
</span><span class='line'>
</span><span class='line'>;; ANSWER SECTION:
</span><span class='line'>www.wagemakers.be.      85181   IN      CNAME   wagemakers.be.
</span><span class='line'>wagemakers.be.          85181   IN      A       95.215.185.144
</span><span class='line'>
</span><span class='line'>;; Query time: 110 msec
</span><span class='line'>;; SERVER: 127.0.0.53#53000(127.0.0.53)
</span><span class='line'>;; WHEN: Sat Sep 22 13:16:11 2018
</span><span class='line'>;; MSG SIZE  rcvd: 119
</span></code></pre></td></tr></table></div></figure>


<h3>dnsmasq</h3>

<h4>Install dnsmasq.</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/root # pkg install dnsmasq
</span><span class='line'>Updating FreeBSD repository catalogue...
</span><span class='line'>FreeBSD repository is up to date.
</span><span class='line'>All repositories are up to date.
</span><span class='line'>The following 1 package(s) will be affected (of 0 checked):
</span><span class='line'>
</span><span class='line'>New packages to be INSTALLED:
</span><span class='line'>        dnsmasq: 2.79,1
</span><span class='line'>
</span><span class='line'>Number of packages to be installed: 1
</span><span class='line'>
</span><span class='line'>329 KiB to be downloaded.
</span><span class='line'>
</span><span class='line'>Proceed with this action? [y/N]: y
</span><span class='line'>[stafproxy] [1/1] Fetching dnsmasq-2.79,1.txz: 100%  329 KiB 336.4kB/s    00:01
</span><span class='line'>Checking integrity... done (0 conflicting)
</span><span class='line'>[stafproxy] [1/1] Installing dnsmasq-2.79,1...
</span><span class='line'>[stafproxy] [1/1] Extracting dnsmasq-2.79,1: 100%
</span><span class='line'>Message from dnsmasq-2.79,1:
</span><span class='line'>
</span><span class='line'>*** To enable dnsmasq, edit /usr/local/etc/dnsmasq.conf and
</span><span class='line'>*** set dnsmasq_enable="YES" in /etc/rc.conf[.local]
</span><span class='line'>***
</span><span class='line'>*** Further options and actions are documented inside
</span><span class='line'>*** /usr/local/etc/rc.d/dnsmasq
</span><span class='line'>root@stafproxy:/root #</span></code></pre></td></tr></table></div></figure>


<h4>Enable dnsmasq.</h4>

<p>Usae <code>sysrc</code> to enable the dnsmasq service.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/root # sysrc dnsmasq_enable="YES"
</span><span class='line'>dnsmasq_enable:  -&gt; YES
</span><span class='line'>root@stafproxy:/root #</span></code></pre></td></tr></table></div></figure>


<h4>Configure dnsmasq</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/local/etc # mv dnsmasq.conf dnsmasq.conf_org
</span><span class='line'>root@stafproxy:/usr/local/etc # vi dnsmasq.conf</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>server=&lt;ip_address_of_the_jail&gt;#53000
</span><span class='line'>listen-address=&lt;ip_address_of_the_jail&gt;
</span><span class='line'>interface=&lt;netork_interface_of_the_jail&gt;
</span><span class='line'>bind-interfaces</span></code></pre></td></tr></table></div></figure>


<h4>start dnsmasq</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/local/etc # service dnsmasq start
</span><span class='line'>Starting dnsmasq.
</span><span class='line'>root@stafproxy:/usr/local/etc #</span></code></pre></td></tr></table></div></figure>


<h4>test it</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/local/etc # dig @192.168.1.45 www.wagemakers.be
</span><span class='line'>
</span><span class='line'>; &lt;&lt;&gt;&gt; DiG 9.8.3-P4 &lt;&lt;&gt;&gt; @192.168.1.45 www.wagemakers.be
</span><span class='line'>; (1 server found)
</span><span class='line'>;; global options: +cmd
</span><span class='line'>;; Got answer:
</span><span class='line'>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 32987
</span><span class='line'>;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1
</span><span class='line'>
</span><span class='line'>;; OPT PSEUDOSECTION:
</span><span class='line'>; EDNS: version: 0, flags:; udp: 4096
</span><span class='line'>;; QUESTION SECTION:
</span><span class='line'>;www.wagemakers.be.             IN      A
</span><span class='line'>
</span><span class='line'>;; ANSWER SECTION:
</span><span class='line'>www.wagemakers.be.      86000   IN      CNAME   wagemakers.be.
</span><span class='line'>wagemakers.be.          86000   IN      A       95.215.185.144
</span><span class='line'>
</span><span class='line'>;; Query time: 308 msec
</span><span class='line'>;; SERVER: 192.168.1.45#53(192.168.1.45)
</span><span class='line'>;; WHEN: Sun Oct  7 09:16:51 2018
</span><span class='line'>;; MSG SIZE  rcvd: 119
</span><span class='line'>
</span><span class='line'>root@stafproxy:/usr/local/etc #
</span></code></pre></td></tr></table></div></figure>


<h4>Update /etc/resolv.conf</h4>

<p>Update your <code>/etc/resolv.conf</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/local/etc # vi /etc/resolv.conf</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>nameserver &lt;ip_address_of_the_jail&gt;</span></code></pre></td></tr></table></div></figure>


<p>and test it;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/local/etc # dig www.wagemakers.be
</span><span class='line'>
</span><span class='line'>; &lt;&lt;&gt;&gt; DiG 9.8.3-P4 &lt;&lt;&gt;&gt; www.wagemakers.be
</span><span class='line'>;; global options: +cmd
</span><span class='line'>;; Got answer:
</span><span class='line'>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 27629
</span><span class='line'>;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 0
</span><span class='line'>
</span><span class='line'>;; QUESTION SECTION:
</span><span class='line'>;www.wagemakers.be.             IN      A
</span><span class='line'>
</span><span class='line'>;; ANSWER SECTION:
</span><span class='line'>www.wagemakers.be.      85702   IN      CNAME   wagemakers.be.
</span><span class='line'>wagemakers.be.          85702   IN      A       95.215.185.144
</span><span class='line'>
</span><span class='line'>;; Query time: 1 msec
</span><span class='line'>;; SERVER: 192.168.1.45#53(192.168.1.45)
</span><span class='line'>;; WHEN: Sun Oct  7 09:21:49 2018
</span><span class='line'>;; MSG SIZE  rcvd: 78
</span><span class='line'>
</span><span class='line'>root@stafproxy:/usr/local/etc #</span></code></pre></td></tr></table></div></figure>


<p><strong><em> Have fun! </em></strong></p>

<h1>Links</h1>

<ul>
<li><a href="https://stafwag.github.io/blog/blog/2018/09/09/dns-privacy-with-stubby-part1-gnulinux/">https://stafwag.github.io/blog/blog/2018/09/09/dns-privacy-with-stubby-part1-gnulinux/</a></li>
<li><a href="https://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/jails-ezjail.html">https://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/jails-ezjail.html</a></li>
</ul>

</div>
  
  

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog_actrikel -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4659298941528586"
     data-ad-slot="7394058542"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2018/09/09/dns-privacy-with-stubby-part1-gnulinux/">DNS Privacy With Stubby (Part 1 GNU/Linux)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-09-09T10:30:03+02:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>10:30 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong><em> Installing and configuring an encrypted dns server is straightforward, there is no reason to use an unencrypted dns service. </em></strong></p>

<h1>DNS is not secure or private</h1>

<p>DNS traffic is insecure and runs over <a href="https://nl.wikipedia.org/wiki/User_Datagram_Protocol">UDP</a> port 53 (<a href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol">TCP</a> for <a href="https://en.wikipedia.org/wiki/DNS_zone_transfer">zone transfers</a> ) unecrypted by default.</p>

<p>This make your unencrypted DNS traffic a <strong>privacy risk</strong> and a <strong>security risk</strong>:</p>

<ul>
<li>anyone that is able to sniff your network traffic can collect a lot information from your leaking DNS traffic.</li>
<li>with a DNS spoofing attack an attacker can trick you let go to malicious website or try to intercept your email traffic.</li>
</ul>


<h1>Encrypt your dns traffic</h1>

<p>Encrypting your network traffic is always a good idea for privacy and security reasons - <strong><em> we encrypt, because we can! </em></strong> -  .
More information about dns privacy can be found at <a href="https://dnsprivacy.org/">https://dnsprivacy.org/</a></p>

<p>On this site you&rsquo;ll find also the <a href="https://dnsprivacy.org/wiki/display/DP/DNS+Privacy+Daemon+-+Stubby">DNS Privacy Daemon - Stubby</a> that let&rsquo;s you send your DNS request over TLS to an alternative DNS provider. You should use a DNS provider that you trust and has a no logging policy.  <a href="https://www.quad9.net/">quad9</a>, <a href="https://www.cloudflare.com/learning/dns/what-is-1.1.1.1/">cloudflare</a> and google dns are well-known alternative dns providers. At <a href="https://dnsprivacy.org/wiki/display/DP/DNS+Privacy+Test+Servers">https://dnsprivacy.org/wiki/display/DP/DNS+Privacy+Test+Servers</a> you can find a few other options.</p>

<p>You&rsquo;ll find my journey to setup Stubby on a few operation systems I use (or I&rsquo;m force to use) below &hellip;</p>

<h1>GNU/Linux</h1>

<h2>Arch Linux</h2>

<p>I use <a href="https://www.archlinux.org/">Arch Linux</a> on my main workstation. Stubby is already in the Arch repositories this make installation straightforward.</p>

<h3>Install stubby</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# pacman -S stubby
</span><span class='line'>resolving dependencies...
</span><span class='line'>looking for conflicting packages...
</span><span class='line'>
</span><span class='line'>Packages (5) fstrm-0.4.0-1  getdns-1.4.2-1  protobuf-c-1.3.0-3  unbound-1.7.3-4
</span><span class='line'>             stubby-0.2.3-1
</span><span class='line'>
</span><span class='line'>Total Download Size:   1.09 MiB
</span><span class='line'>Total Installed Size:  5.68 MiB
</span><span class='line'>
</span><span class='line'>:: Proceed with installation? [Y/n] 
</span><span class='line'>:: Retrieving packages...
</span><span class='line'>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span><span class='line'>                                 Dload  Upload   Total   Spent    Left  Speed
</span><span class='line'>100 88476  100 88476    0     0   403k      0 --:--:-- --:--:-- --:--:--  403k
</span><span class='line'>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span><span class='line'>                                 Dload  Upload   Total   Spent    Left  Speed
</span><span class='line'>100 62480  100 62480    0     0  1271k      0 --:--:-- --:--:-- --:--:-- 1271k
</span><span class='line'>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span><span class='line'>                                 Dload  Upload   Total   Spent    Left  Speed
</span><span class='line'>100  632k  100  632k    0     0   750k      0 --:--:-- --:--:-- --:--:--  749k
</span><span class='line'>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span><span class='line'>                                 Dload  Upload   Total   Spent    Left  Speed
</span><span class='line'>100  302k  100  302k    0     0  1615k      0 --:--:-- --:--:-- --:--:-- 1606k
</span><span class='line'>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span><span class='line'>                                 Dload  Upload   Total   Spent    Left  Speed
</span><span class='line'>100 34052  100 34052    0     0   831k      0 --:--:-- --:--:-- --:--:--  831k
</span><span class='line'>(5/5) checking keys in keyring                       [###########################] 100%
</span><span class='line'>(5/5) checking package integrity                     [###########################] 100%
</span><span class='line'>(5/5) loading package files                          [###########################] 100%
</span><span class='line'>(5/5) checking for file conflicts                    [###########################] 100%
</span><span class='line'>(5/5) checking available disk space                  [###########################] 100%
</span><span class='line'>:: Processing package changes...
</span><span class='line'>(1/5) installing fstrm                               [###########################] 100%
</span><span class='line'>(2/5) installing protobuf-c                          [###########################] 100%
</span><span class='line'>(3/5) installing unbound                             [###########################] 100%
</span><span class='line'>Optional dependencies for unbound
</span><span class='line'>    expat: unbound-anchor [installed]
</span><span class='line'>(4/5) installing getdns                              [###########################] 100%
</span><span class='line'>(5/5) installing stubby                              [###########################] 100%
</span><span class='line'>:: Running post-transaction hooks...
</span><span class='line'>(1/4) Reloading system manager configuration...
</span><span class='line'>(2/4) Creating system user accounts...
</span><span class='line'>(3/4) Creating temporary files...
</span><span class='line'>(4/4) Arming ConditionNeedsUpdate...
</span><span class='line'>[root@vicky ~]# </span></code></pre></td></tr></table></div></figure>


<h4>choose your upstream dns provider</h4>

<p>Edit the stubby.yml file and uncomment the upstream dns server that you want the use.
Stubby will loadbalance the dns traffic to all configured upstream dns servers by default.
This is configured with the <code>round_robin_upstreams</code> directive, if set to <code>1</code> the traffic is loadbalanced, if set <code>0</code> stubby will use the first configured dns server.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ sudo vi /etc/stubby/stubby.yml</span></code></pre></td></tr></table></div></figure>


<h4>enable and start stubby</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# systemctl enable stubby
</span><span class='line'>Created symlink /etc/systemd/system/multi-user.target.wants/stubby.service -&gt; /usr/lib/systemd/system/stubby.service.
</span><span class='line'>[root@vicky ~]# systemctl start stubby
</span><span class='line'>[root@vicky ~]# </span></code></pre></td></tr></table></div></figure>


<h4>test</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# dig @127.0.0.1 www.wagemakers.be
</span><span class='line'>
</span><span class='line'>; &lt;&lt;&gt;&gt; DiG 9.13.2 &lt;&lt;&gt;&gt; @127.0.0.1 www.wagemakers.be
</span><span class='line'>; (1 server found)
</span><span class='line'>;; global options: +cmd
</span><span class='line'>;; Got answer:
</span><span class='line'>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 18226
</span><span class='line'>;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1
</span><span class='line'>
</span><span class='line'>;; OPT PSEUDOSECTION:
</span><span class='line'>; EDNS: version: 0, flags:; udp: 4096
</span><span class='line'>; COOKIE: fe9d3618b821614f174436385b7acb64a4f4cc6657e14626 (good)
</span><span class='line'>;; QUESTION SECTION:
</span><span class='line'>;www.wagemakers.be.             IN      A
</span><span class='line'>
</span><span class='line'>;; ANSWER SECTION:
</span><span class='line'>www.wagemakers.be.      86000   IN      CNAME   wagemakers.be.
</span><span class='line'>wagemakers.be.          86000   IN      A       95.215.185.144
</span><span class='line'>
</span><span class='line'>;; Query time: 128 msec
</span><span class='line'>;; SERVER: 127.0.0.1#53(127.0.0.1)
</span><span class='line'>;; WHEN: Mon Aug 20 16:08:36 CEST 2018
</span><span class='line'>;; MSG SIZE  rcvd: 147
</span><span class='line'>
</span><span class='line'>[root@vicky ~]# </span></code></pre></td></tr></table></div></figure>


<h3>Local dns cache with dnsmasq</h3>

<h4>Change the stubby port.</h4>

<p>Edit /etc/stubby/stubby.yml</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# vi /etc/stubby/stubby.yml</span></code></pre></td></tr></table></div></figure>


<p>And change the port by modifing the <code>listen_addresses</code> directive</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>listen_addresses:
</span><span class='line'>  - 127.0.0.1@53000
</span><span class='line'>  - 0::1@53000</span></code></pre></td></tr></table></div></figure>


<p>restart stubby</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# systemctl restart stubby.service</span></code></pre></td></tr></table></div></figure>


<p>and verify that the dns on 127.0.0.1:53 doesn&rsquo;t work anymore.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# dig @127.0.0.1 www.wagemakers.be
</span><span class='line'>
</span><span class='line'>; &lt;&lt;&gt;&gt; DiG 9.13.2 &lt;&lt;&gt;&gt; @127.0.0.1 www.wagemakers.be
</span><span class='line'>; (1 server found)
</span><span class='line'>;; global options: +cmd
</span><span class='line'>;; connection timed out; no servers could be reached
</span><span class='line'>[root@vicky ~]# </span></code></pre></td></tr></table></div></figure>


<p>ensure that stubby does work on port 53000</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@frija etc]# dig @127.0.0.1 -p 53000 www.wagemakers.be
</span><span class='line'>
</span><span class='line'>; &lt;&lt;&gt;&gt; DiG 9.13.2 &lt;&lt;&gt;&gt; @127.0.0.1 -p 53000 www.wagemakers.be
</span><span class='line'>; (1 server found)
</span><span class='line'>;; global options: +cmd
</span><span class='line'>;; Got answer:
</span><span class='line'>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 27173
</span><span class='line'>;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1
</span><span class='line'>
</span><span class='line'>;; OPT PSEUDOSECTION:
</span><span class='line'>; EDNS: version: 0, flags:; udp: 65535
</span><span class='line'>;; QUESTION SECTION:
</span><span class='line'>;www.wagemakers.be.             IN      A
</span><span class='line'>
</span><span class='line'>;; ANSWER SECTION:
</span><span class='line'>www.wagemakers.be.      43200   IN      CNAME   wagemakers.be.
</span><span class='line'>wagemakers.be.          43200   IN      A       95.215.185.144
</span><span class='line'>
</span><span class='line'>;; Query time: 250 msec
</span><span class='line'>;; SERVER: 127.0.0.1#53000(127.0.0.1)
</span><span class='line'>;; WHEN: Tue Aug 21 13:26:37 CEST 2018
</span><span class='line'>;; MSG SIZE  rcvd: 119
</span><span class='line'>
</span><span class='line'>[root@frija etc]# </span></code></pre></td></tr></table></div></figure>


<h4>Install dnsmasq</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# pacman -S dnsmasq
</span><span class='line'>warning: dnsmasq-2.79-1 is up to date -- reinstalling
</span><span class='line'>resolving dependencies...
</span><span class='line'>looking for conflicting packages...
</span><span class='line'>
</span><span class='line'>Packages (1) dnsmasq-2.79-1
</span><span class='line'>
</span><span class='line'>Total Installed Size:  0.70 MiB
</span><span class='line'>Net Upgrade Size:      0.00 MiB
</span><span class='line'>
</span><span class='line'>:: Proceed with installation? [Y/n] y
</span><span class='line'>(1/1) checking keys in keyring                       [###########################] 100%
</span><span class='line'>(1/1) checking package integrity                     [###########################] 100%
</span><span class='line'>(1/1) loading package files                          [###########################] 100%
</span><span class='line'>(1/1) checking for file conflicts                    [###########################] 100%
</span><span class='line'>(1/1) checking available disk space                  [###########################] 100%
</span><span class='line'>:: Processing package changes...
</span><span class='line'>(1/1) reinstalling dnsmasq                           [###########################] 100%
</span><span class='line'>:: Running post-transaction hooks...
</span><span class='line'>(1/3) Reloading system manager configuration...
</span><span class='line'>(2/3) Creating system user accounts...
</span><span class='line'>(3/3) Arming ConditionNeedsUpdate...
</span><span class='line'>[root@vicky ~]# </span></code></pre></td></tr></table></div></figure>


<h4>Configure dnsmasq</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky etc]# cd /etc
</span><span class='line'>[root@vicky etc]# mv /etc/dnsmasq.conf /etc/dnsmasq.conf_org
</span><span class='line'>[root@vicky etc]# vi dnsmasq.conf</span></code></pre></td></tr></table></div></figure>


<p>It is import to configure stubby to listen the localhost interface only.
If you use Linux KVM you probably have a dns serivce running on your bridge interfaces for your virtual machines.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>server=127.0.0.1#53000
</span><span class='line'>listen-address=127.0.0.1
</span><span class='line'>interface=lo
</span><span class='line'>bind-interfaces</span></code></pre></td></tr></table></div></figure>


<h4>Start and enable dnsmasq</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# systemctl start dnsmasq
</span><span class='line'>[root@vicky ~]# systemctl enable dnsmasq
</span><span class='line'>Created symlink /etc/systemd/system/multi-user.target.wants/dnsmasq.service -&gt; /usr/lib/systemd/system/dnsmasq.service.
</span><span class='line'>[root@vicky ~]# </span></code></pre></td></tr></table></div></figure>


<h4>Reconfigure your system</h4>

<p>reconfigure your system to use dnsmasq as the dns service.</p>

<p>I use <a href="https://wiki.archlinux.org/index.php/Netctl">netctl</a> on my system. You can update the network configuration with <code>netctl</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky netctl]# netctl edit &lt;network_name&gt;
</span><span class='line'>[root@vicky netctl]# netctl restart  &lt;network_name&gt;</span></code></pre></td></tr></table></div></figure>


<p>If you networkmanager you can use <code>nmcli</code>, <code>nmtui</code> or the GUI network configuration in your desktop environment.</p>

<h2>GNU/Linux is GNU/Linux</h2>

<p>The configuration on other GNU/Linux distributions is the same as on Arch apart from the installation process.
The same method can be use if your (favorite) Linux distribution doesn&rsquo;t have a stubby package, the installation method of the required package will be different of course.</p>

<h3>Debian</h3>

<h4>Current testing release Debian &ldquo;buster&rdquo;</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt install stubby dnsmasq</span></code></pre></td></tr></table></div></figure>


<h4>Current stable Debian 9 &ldquo;strech&rdquo;</h4>

<p>Stubby in the <code>getdns-utils</code> in Debian stretch, it&rsquo;s an older version.
Therefor I ended up with building stubby from the source code.</p>

<h5>Install the required packages</h5>

<p>Install the required packages to build stubby.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@stretch:~/github$ sudo apt install build-essential git libtool autoconf libssl-dev libyaml-dev</span></code></pre></td></tr></table></div></figure>


<h5>git clone</h5>

<p>The getdns git repo;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@stretch:~/github$ git clone https://github.com/getdnsapi/getdns.git
</span><span class='line'>Cloning into 'getdns'...
</span><span class='line'>remote: Counting objects: 16154, done.
</span><span class='line'>remote: Total 16154 (delta 0), reused 0 (delta 0), pack-reused 16154
</span><span class='line'>Receiving objects: 100% (16154/16154), 9.72 MiB | 1.13 MiB/s, done.
</span><span class='line'>Resolving deltas: 100% (12413/12413), done.
</span><span class='line'>staf@stretch:~/github$ </span></code></pre></td></tr></table></div></figure>


<h5>checkout the latest stable release</h5>

<p>Verify the lastest release tag. The current stable release 1.4.2</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@stretch:~/github/getdns$ git tag
</span><span class='line'>TNW2015
</span><span class='line'>list
</span><span class='line'>v0.1.0
</span><span class='line'>v0.1.1
</span><span class='line'>v0.1.2
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>v1.4.0
</span><span class='line'>v1.4.0-rc1
</span><span class='line'>v1.4.1
</span><span class='line'>v1.4.1-rc1
</span><span class='line'>v1.4.2
</span><span class='line'>v1.4.2-rc1
</span><span class='line'>staf@stretch:~/github/getdns$ </span></code></pre></td></tr></table></div></figure>


<p>checkout the latest stable release.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@stretch:~/github/getdns$ git checkout v1.4.2
</span><span class='line'>Note: checking out 'v1.4.2'.
</span><span class='line'>
</span><span class='line'>You are in 'detached HEAD' state. You can look around, make experimental
</span><span class='line'>changes and commit them, and you can discard any commits you make in this
</span><span class='line'>state without impacting any branches by performing another checkout.
</span><span class='line'>
</span><span class='line'>If you want to create a new branch to retain commits you create, you may
</span><span class='line'>do so (now or later) by using -b with the checkout command again. Example:
</span><span class='line'>
</span><span class='line'>  git checkout -b &lt;new-branch-name&gt;
</span><span class='line'>
</span><span class='line'>HEAD is now at e481273... Last minute update
</span><span class='line'>staf@stretch:~/github/getdns$ </span></code></pre></td></tr></table></div></figure>


<h5>build it&hellip;</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@stretch:~/github/getdns$ git submodule update --init
</span><span class='line'>staf@stretch:~/github/getdns$ libtoolize -ci
</span><span class='line'>staf@stretch:~/github/getdns$ autoreconf -fi
</span><span class='line'>staf@stretch:~/github/getdns$ mkdir build
</span><span class='line'>staf@stretch:~/github/getdns$ cd build/
</span><span class='line'>staf@stretch:~/github/getdns/build$ ../configure --prefix=/usr/local --without-libidn --without-libidn2 --enable-stub-only --with-stubby
</span><span class='line'>staf@stretch:~/github/getdns/build$ make</span></code></pre></td></tr></table></div></figure>


<h5>make install</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@stretch:~/github/getdns/build$ sudo make install
</span><span class='line'>[sudo] password for staf: 
</span><span class='line'>cd src && make install
</span><span class='line'>make[1]: Entering directory '/home/staf/github/getdns/build/src'
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>make[1]: Leaving directory '/home/staf/github/getdns/build/doc'
</span><span class='line'>***
</span><span class='line'>***  !!! IMPORTANT !!!!
</span><span class='line'>***
</span><span class='line'>***  From release 1.2.0, getdns comes with built-in DNSSEC
</span><span class='line'>***  trust anchor management.  External trust anchor management,
</span><span class='line'>***  for example with unbound-anchor, is no longer necessary
</span><span class='line'>***  and no longer recommended.
</span><span class='line'>***
</span><span class='line'>***  Previously installed trust anchors, in the default location -
</span><span class='line'>***
</span><span class='line'>***        /usr/local/etc/unbound/getdns-root.key
</span><span class='line'>***
</span><span class='line'>***  - will be preferred and used for DNSSEC validation, however
</span><span class='line'>***  getdns will fallback to trust-anchors obtained via built-in
</span><span class='line'>***  trust anchor management when the anchors from the default
</span><span class='line'>***  location fail to validate the root DNSKEY rrset.
</span><span class='line'>***
</span><span class='line'>***  To prevent expired DNSSEC trust anchors to be used for
</span><span class='line'>***  validation, we strongly recommend removing the trust anchors
</span><span class='line'>***  on the default location when there is no active external
</span><span class='line'>***  trust anchor management keeping it up-to-date.
</span><span class='line'>***
</span><span class='line'>staf@stretch:~/github/getdns/build$ sudo make install</span></code></pre></td></tr></table></div></figure>


<h5>systemd service</h5>

<p>Stubby comes with a systemd service definition. Copy it to the correct location.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@stretch:~/github/getdns/build$ cd ..
</span><span class='line'>staf@stretch:~/github/getdns$ cd stubby/systemd/
</span><span class='line'>staf@stretch:~/github/getdns/stubby/systemd$ sudo cp stubby.service /lib/systemd/system/</span></code></pre></td></tr></table></div></figure>


<p>Update the path to /usr/local</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@stretch:~/github/getdns/stubby/systemd$ sudo vi /lib/systemd/system/stubby.service</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[Unit]
</span><span class='line'>Description=stubby DNS resolver
</span><span class='line'>
</span><span class='line'>[Service]
</span><span class='line'>User=stubby
</span><span class='line'>DynamicUser=yes
</span><span class='line'>CacheDirectory=stubby
</span><span class='line'>WorkingDirectory=/var/cache/stubby
</span><span class='line'>ExecStart=/usr/local/bin/stubby
</span><span class='line'>AmbientCapabilities=CAP_NET_BIND_SERVICE
</span><span class='line'>CapabilityBoundingSet=CAP_NET_BIND_SERVICE
</span><span class='line'>
</span><span class='line'>[Install]
</span><span class='line'>WantedBy=multi-user.target</span></code></pre></td></tr></table></div></figure>


<p>And create the stubby working directory</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stretch:~# mkdir /var/cache/stubby</span></code></pre></td></tr></table></div></figure>


<h4>ldconfig</h4>

<p>update your library cache</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@stretch:~/github/getdns/stubby/systemd$ sudo ldconfig -v</span></code></pre></td></tr></table></div></figure>


<h4>Update the configuration</h4>

<p>Edit the stubby.yml configuration file.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@stretch:~/github/getdns/stubby/systemd$ sudo nvi /usr/local/etc/stubby/stubby.yml</span></code></pre></td></tr></table></div></figure>


<p>Update the port where stubby will listen to and select the upstream dns service you want to use.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>listen_addresses:
</span><span class='line'>  - 127.0.0.1@53000
</span><span class='line'>  - 0::1@53000</span></code></pre></td></tr></table></div></figure>


<h4>start and test</h4>

<p>Start stubby&hellip;.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@stretch:~/github/getdns/stubby/systemd$ sudo systemctl list-unit-files | grep -i stubby
</span><span class='line'>stubby.service                              disabled
</span><span class='line'>staf@stretch:~/github/getdns/stubby/systemd$ sudo systemctl enable stubby
</span><span class='line'>Created symlink /etc/systemd/system/multi-user.target.wants/stubby.service /lib/systemd/system/stubby.service.
</span><span class='line'>staf@stretch:~/github/getdns/stubby/systemd$ sudo systemctl start stubby
</span><span class='line'>staf@stretch:~/github/getdns/stubby/systemd$ </span></code></pre></td></tr></table></div></figure>


<p>and test it</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stretch:~# dig @127.0.0.1 -p 53000 www.wagemakers.be
</span><span class='line'>
</span><span class='line'>; &lt;&lt;&gt;&gt; DiG 9.10.3-P4-Debian &lt;&lt;&gt;&gt; @127.0.0.1 -p 53000 www.wagemakers.be
</span><span class='line'>; (1 server found)
</span><span class='line'>;; global options: +cmd
</span><span class='line'>;; Got answer:
</span><span class='line'>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 17510
</span><span class='line'>;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1
</span><span class='line'>
</span><span class='line'>;; OPT PSEUDOSECTION:
</span><span class='line'>; EDNS: version: 0, flags:; udp: 4096
</span><span class='line'>;; QUESTION SECTION:
</span><span class='line'>;www.wagemakers.be.             IN      A
</span><span class='line'>
</span><span class='line'>;; ANSWER SECTION:
</span><span class='line'>www.wagemakers.be.      49704   IN      CNAME   wagemakers.be.
</span><span class='line'>wagemakers.be.          81815   IN      A       95.215.185.144
</span><span class='line'>
</span><span class='line'>;; Query time: 72 msec
</span><span class='line'>;; SERVER: 127.0.0.1#53000(127.0.0.1)
</span><span class='line'>;; WHEN: Sun Sep 02 10:33:53 CEST 2018
</span><span class='line'>;; MSG SIZE  rcvd: 119
</span><span class='line'>
</span><span class='line'>root@stretch:~# </span></code></pre></td></tr></table></div></figure>


<h4>dnsmasq</h4>

<p>Install dnsmasq</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stretch:/etc# apt-get install dnsmasq</span></code></pre></td></tr></table></div></figure>


<p>Configure dnsmasq</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stretch:/etc# mv dnsmasq.conf dnsmasq.conf_org
</span><span class='line'>root@stretch:/etc# vi dnsmasq.conf</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>server=127.0.0.1#53000
</span><span class='line'>listen-address=127.0.0.1
</span><span class='line'>interface=lo
</span><span class='line'>bind-interfaces</span></code></pre></td></tr></table></div></figure>


<p>Enable and start it&hellip;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stretch:/etc# systemctl enable dnsmasq
</span><span class='line'>Synchronizing state of dnsmasq.service with SysV service script with /lib/systemd/systemd-sysv-install.
</span><span class='line'>Executing: /lib/systemd/systemd-sysv-install enable dnsmasq
</span><span class='line'>root@stretch:/etc# systemctl restart dnsmasq</span></code></pre></td></tr></table></div></figure>


<p>Verify</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stretch:/etc# dig @127.0.0.1 www.wagemakers.be
</span><span class='line'>
</span><span class='line'>; &lt;&lt;&gt;&gt; DiG 9.10.3-P4-Debian &lt;&lt;&gt;&gt; @127.0.0.1 www.wagemakers.be
</span><span class='line'>; (1 server found)
</span><span class='line'>;; global options: +cmd
</span><span class='line'>;; Got answer:
</span><span class='line'>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 57295
</span><span class='line'>;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1
</span><span class='line'>
</span><span class='line'>;; OPT PSEUDOSECTION:
</span><span class='line'>; EDNS: version: 0, flags:; udp: 4096
</span><span class='line'>;; QUESTION SECTION:
</span><span class='line'>;www.wagemakers.be.             IN      A
</span><span class='line'>
</span><span class='line'>;; ANSWER SECTION:
</span><span class='line'>www.wagemakers.be.      48645   IN      CNAME   wagemakers.be.
</span><span class='line'>wagemakers.be.          80756   IN      A       95.215.185.144
</span><span class='line'>
</span><span class='line'>;; Query time: 72 msec
</span><span class='line'>;; SERVER: 127.0.0.1#53(127.0.0.1)
</span><span class='line'>;; WHEN: Sun Sep 02 10:51:32 CEST 2018
</span><span class='line'>;; MSG SIZE  rcvd: 119
</span><span class='line'>
</span><span class='line'>root@stretch:/etc# </span></code></pre></td></tr></table></div></figure>


<p>reconfigure you system to use dnsmasq&hellip;.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stretch:/etc# nvi resolv.conf</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>nameserver 127.0.0.1</span></code></pre></td></tr></table></div></figure>


<p><strong><em>Have fun!</em></strong></p>

<h2>Links</h2>

<ul>
<li><a href="https://dnsprivacy.org">https://dnsprivacy.org</a></li>
<li><a href="https://wiki.archlinux.org/index.php/Stubby">https://wiki.archlinux.org/index.php/Stubby</a></li>
</ul>

</div>
  
  

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog_actrikel -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4659298941528586"
     data-ad-slot="7394058542"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2018/07/01/migrate-a-windows-vmware-vrtual-machine-to-kvm/">Migrate a Windows Vmware Virtual Machine to Linux KVM</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-07-01T10:49:41+02:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>1</span><span class='date-suffix'>st</span>, <span class='date-year'>2018</span></span> <span class='time'>10:49 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://www.linux-kvm.org">Linux KVM</a> is getting more and more useable for desktop virtualization thanks to the the <a href="https://www.linux-kvm.org/page/Virtio">virtio</a> and <a href="https://www.linux-kvm.org/page/SPICE">QXL/SPICE</a> drivers.</p>

<p>Most Linux distributes have the virtio &amp; QXL drivers you might need to install the spice-vdagent.</p>

<p>On Windows you can download and install the virtio and QXL drivers.</p>

<p>Using the virtio drivers will improve your guest system performance and your virtualization experience.</p>

<h2>Convert the disk image</h2>

<h3>merge the vmware disk images&hellip;</h3>

<p>If you use split disk images on vmware ( or vmware player ) migrate them to a single disk images with the vmware-vdiskmanager command.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vmware-vdiskmanager -r mywin.vmdk -t 0 /tmp/mywin._combined.vmdk
</span><span class='line'>Creating disk '/var/lib/libvirt/images/tmp/mywin._combined.vmdk'
</span><span class='line'>  Convert: 100% done.
</span><span class='line'>Virtual disk conversion successful.
</span><span class='line'>$</span></code></pre></td></tr></table></div></figure>


<h3>convert the vmdk  image to qcow2</h3>

<p>Convert the VMDK disk image to qcow2</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky vboxes]$ qemu-img convert -f vmdk -O qcow2 mywin._combined.vmdk mywin.qcow2</span></code></pre></td></tr></table></div></figure>


<h3>mv</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky vboxes]$ sudo mv mywin_combined.qcow2 /var/lib/libvirt/images/
</span><span class='line'>[sudo] password for staf: 
</span></code></pre></td></tr></table></div></figure>


<h2>Import the disk image to KVM</h2>

<p>We&rsquo;ll inport the disk image with <code>virt-install</code> it&rsquo;s also posible to import the images with <code>virt-manager</code> if you prefer a graphical interface or or just being lazy :-)</p>

<h2>Available os options</h2>

<p>To list the supported operation system you can use the <code>osinfo-query os</code> command</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ osinfo-query os | head
</span><span class='line'> Short ID             | Name                                               | Version  | ID                                      
</span><span class='line'>----------------------+----------------------------------------------------+----------+-----------------------------------------
</span><span class='line'> alpinelinux3.5       | Alpine Linux 3.5                                   | 3.5      | http://alpinelinux.org/alpinelinux/3.5  
</span><span class='line'> alpinelinux3.6       | Alpine Linux 3.6                                   | 3.6      | http://alpinelinux.org/alpinelinux/3.6  
</span><span class='line'> alpinelinux3.7       | Alpine Linux 3.7                                   | 3.7      | http://alpinelinux.org/alpinelinux/3.7  
</span><span class='line'> altlinux1.0          | Mandrake RE Spring 2001                            | 1.0      | http://altlinux.org/altlinux/1.0        
</span><span class='line'> altlinux2.0          | ALT Linux 2.0                                      | 2.0      | http://altlinux.org/altlinux/2.0        
</span><span class='line'> altlinux2.2          | ALT Linux 2.2                                      | 2.2      | http://altlinux.org/altlinux/2.2        
</span><span class='line'> altlinux2.4          | ALT Linux 2.4                                      | 2.4      | http://altlinux.org/altlinux/2.4        
</span><span class='line'> altlinux3.0          | ALT Linux 3.0                                      | 3.0      | http://altlinux.org/altlinux/3.0        </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ osinfo-query os |  grep -i windows
</span><span class='line'> win1.0               | Microsoft Windows 1.0                              | 1.0      | http://microsoft.com/win/1.0            
</span><span class='line'> win10                | Microsoft Windows 10                               | 10.0     | http://microsoft.com/win/10             
</span><span class='line'> win2.0               | Microsoft Windows 2.0                              | 2.0      | http://microsoft.com/win/2.0            
</span><span class='line'> win2.1               | Microsoft Windows 2.1                              | 2.1      | http://microsoft.com/win/2.1            
</span><span class='line'> win2k                | Microsoft Windows 2000                             | 5.0      | http://microsoft.com/win/2k             
</span><span class='line'> win2k12              | Microsoft Windows Server 2012                      | 6.3      | http://microsoft.com/win/2k12           
</span><span class='line'> win2k12r2            | Microsoft Windows Server 2012 R2                   | 6.3      | http://microsoft.com/win/2k12r2         
</span><span class='line'> win2k16              | Microsoft Windows Server 2016                      | 10.0     | http://microsoft.com/win/2k16           
</span><span class='line'> win2k3               | Microsoft Windows Server 2003                      | 5.2      | http://microsoft.com/win/2k3            
</span><span class='line'> win2k3r2             | Microsoft Windows Server 2003 R2                   | 5.2      | http://microsoft.com/win/2k3r2          
</span><span class='line'> win2k8               | Microsoft Windows Server 2008                      | 6.0      | http://microsoft.com/win/2k8            
</span><span class='line'> win2k8r2             | Microsoft Windows Server 2008 R2                   | 6.1      | http://microsoft.com/win/2k8r2          
</span><span class='line'> win3.1               | Microsoft Windows 3.1                              | 3.1      | http://microsoft.com/win/3.1            
</span><span class='line'> win7                 | Microsoft Windows 7                                | 6.1      | http://microsoft.com/win/7              
</span><span class='line'> win8                 | Microsoft Windows 8                                | 6.2      | http://microsoft.com/win/8              
</span><span class='line'> win8.1               | Microsoft Windows 8.1                              | 6.3      | http://microsoft.com/win/8.1            
</span><span class='line'> win95                | Microsoft Windows 95                               | 4.0      | http://microsoft.com/win/95             
</span><span class='line'> win98                | Microsoft Windows 98                               | 4.1      | http://microsoft.com/win/98             
</span><span class='line'> winme                | Microsoft Windows Millennium Edition               | 4.9      | http://microsoft.com/win/me             
</span><span class='line'> winnt3.1             | Microsoft Windows NT Server 3.1                    | 3.1      | http://microsoft.com/winnt/3.1          
</span><span class='line'> winnt3.5             | Microsoft Windows NT Server 3.5                    | 3.5      | http://microsoft.com/winnt/3.5          
</span><span class='line'> winnt3.51            | Microsoft Windows NT Server 3.51                   | 3.51     | http://microsoft.com/winnt/3.51         
</span><span class='line'> winnt4.0             | Microsoft Windows NT Server 4.0                    | 4.0      | http://microsoft.com/winnt/4.0          
</span><span class='line'> winvista             | Microsoft Windows Vista                            | 6.0      | http://microsoft.com/win/vista          
</span><span class='line'> winxp                | Microsoft Windows XP                               | 5.1      | http://microsoft.com/win/xp             
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h3>import</h3>

<p>We need to import the disk image as IDE device since we don&rsquo;t have the virtio driver in our windows disk image (yet).</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# virt-install --name "mywin" --ram 8192 --cpu host --os-variant win10 --vcpu 8 --disk /var/lib/libvirt/images/mywin_combined.qcow2,bus=ide --network bridge=virbr0 --import
</span><span class='line'>
</span><span class='line'>Starting install...
</span><span class='line'>
</span><span class='line'>(virt-viewer:3361): GSpice-WARNING **: 16:49:26.546: Warning no automount-inhibiting implementation available
</span></code></pre></td></tr></table></div></figure>


<h2>Install the virtio drivers and QXL graphics drivers</h2>

<h3>Get them&hellip;</h3>

<h4>Type of virtio drivers</h4>

<p>The following virtio windows drivers are available.</p>

<ul>
<li>block (disk drivers)</li>
<li>network</li>
<li>baloon ((dynamic memory management)</li>
</ul>


<p>The fedoraproject provides pre compiled iso images containig all the virtio drivers and installation images for
windows XP.</p>

<h4>ISO contents</h4>

<ul>
<li>NetKVM/ - Virtio network driver</li>
<li>viostor/ - Virtio block driver</li>
<li>vioscsi/ - Virtio Small Computer System Interface (SCSI) driver</li>
<li>viorng/ - Virtio RNG driver</li>
<li>vioser/ - Virtio serial driver</li>
<li>Balloon/ - Virtio memory balloon driver</li>
<li>qxl/ - QXL graphics driver for Windows 7 and earlier. (build virtio-win-0.1.103-1 and later)</li>
<li>qxldod/ - QXL graphics driver for Windows 8 and later. (build virtio-win-0.1.103-2 and later)</li>
<li>pvpanic/ - QEMU pvpanic device driver (build virtio-win-0.1.103-2 and later)</li>
<li>guest-agent/ - QEMU Guest Agent 32bit and 64bit MSI installers</li>
<li>qemupciserial/ - QEMU PCI serial device driver</li>
<li>*.vfd VFD floppy images for using during install of Windows XP</li>
</ul>


<h4>Download</h4>

<p>The virtio windows driver images are available from
<a href="https://docs.fedoraproject.org/quick-docs/en-US/creating-windows-virtual-machines-using-virtio-drivers.html">https://docs.fedoraproject.org/quick-docs/en-US/creating-windows-virtual-machines-using-virtio-drivers.html</a></p>

<p>I use arch linux and download virtio-win AUR package with pacaur. You can download the images directly or use the installation packages for your Linux distribution.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ pacaur -S virtio-win
</span><span class='line'>:: Package virtio-win not found in repositories, trying AUR...
</span><span class='line'>:: resolving dependencies...
</span><span class='line'>:: looking for inter-conflicts...
</span><span class='line'>
</span><span class='line'>AUR Packages  (1) virtio-win-0.1.149.2-1  
</span><span class='line'>
</span><span class='line'>:: Proceed with installation? [Y/n] 
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>  -&gt; Compressing package...
</span><span class='line'>==&gt; Leaving fakeroot environment.
</span><span class='line'>==&gt; Finished making: virtio-win 0.1.149.2-1 (Sat Jun 16 20:00:22 2018)
</span><span class='line'>==&gt; Cleaning up...
</span><span class='line'>:: Installing virtio-win package(s)...
</span><span class='line'>loading packages...
</span><span class='line'>resolving dependencies...
</span><span class='line'>looking for conflicting packages...
</span><span class='line'>
</span><span class='line'>Packages (1) virtio-win-0.1.149.2-1
</span><span class='line'>
</span><span class='line'>Total Installed Size:  314.84 MiB
</span><span class='line'>
</span><span class='line'>:: Proceed with installation? [Y/n] 
</span><span class='line'>(1/1) checking keys in keyring                                         [#######################################] 100%
</span><span class='line'>(1/1) checking package integrity                                       [#######################################] 100%
</span><span class='line'>(1/1) loading package files                                            [#######################################] 100%
</span><span class='line'>(1/1) checking for file conflicts                                      [#######################################] 100%
</span><span class='line'>(1/1) checking available disk space                                    [#######################################] 100%
</span><span class='line'>:: Processing package changes...
</span><span class='line'>(1/1) installing virtio-win                                            [#######################################] 100%
</span><span class='line'>Optional dependencies for virtio-win
</span><span class='line'>    qemu [installed]
</span><span class='line'>:: Running post-transaction hooks...
</span><span class='line'>(1/1) Arming ConditionNeedsUpdate...
</span><span class='line'>[staf@vicky ~]$ ls -l /var/li</span></code></pre></td></tr></table></div></figure>


<p>This install virtio images to <code>/usr/share/virtio/</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$  ls -l /usr/share/virtio/
</span><span class='line'>total 321308
</span><span class='line'>-rw-r--r-- 1 root root 324233216 Jun 16 19:58 virtio-win.iso
</span><span class='line'>-rw-r--r-- 1 root root   2949120 Jun 16 19:58 virtio-win_x86_32.vfd
</span><span class='line'>-rw-r--r-- 1 root root   2949120 Jun 16 19:58 virtio-win_x86_64.vfd
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<p><code>virtio-win.iso</code> is the ISO cdrom image containing all the drivers.</p>

<h2>Installation</h2>

<h3>mount the iso image</h3>

<p><img src="/blog/images/virto_windows_install/mount_cdrom_000.png" width="816" height="689" title="&#34;mount_cdrom_000.png&#34;" alt="&#34;mount_cdrom_000.png&#34;"></p>

<p>Make sure that the cdrom is mounted in windows.</p>

<p><img src="/blog/images/virto_windows_install/cdrom_mounted_000.png" width="798" height="605" title="&#34;mount_cdrom_000.png&#34;" alt="&#34;mount_cdrom_000.png&#34;"></p>

<h3>Install</h3>

<h4>Open Device Manager</h4>

<p>Open device Manager in the control panel or type <code>devmgmt.msc</code> on the command prompt.</p>

<p><img src="/blog/images/virto_windows_install/devmgmt_msc_000.png" width="835" height="728" title="&#34;mount_cdrom_000.png&#34;" alt="&#34;mount_cdrom_000.png&#34;"></p>

<h4>Update the drivers</h4>

<ul>
<li>balloon, the balloon driver affects the PCI device</li>
<li>vioserial, affects the PCI simple communication controler</li>
<li>NetKVM, the network driver affects the Network adapters.</li>
<li>viostor, the block driver affects the Disk drives.</li>
</ul>


<h5>Update the PCI drivers</h5>

<p>In windows 10 the <strong>PCI device</strong> and the <strong>PCI Simple Communications Controller</strong> have the missing driver icon.
Right click on the <strong>PCI device</strong> and select <strong>update driver</strong> -> click on <strong>Browse my computer for driver software</strong>
Specify the cdrom as the search location and click <strong>Next</strong>, this will install the Balloon driver.</p>

<p>Do the same for the <strong>PCI Simple Communications Controller</strong> this will install the &ldquo;VirtIO Serial Driver&rdquo;</p>

<p><img src="/blog/images/virto_windows_install/update_pci_000.png" width="790" height="586" title="&#34;update_pci_000.png&#34;" alt="&#34;update_pci_000.png&#34;">
<img src="/blog/images/virto_windows_install/update_pci_001.png" width="792" height="594" title="&#34;update_pci_001.png&#34;" alt="&#34;update_pci_001.png&#34;">
<img src="/blog/images/virto_windows_install/update_pci_002.png" width="792" height="577" title="&#34;update_pci_002.png&#34;" alt="&#34;update_pci_002.png&#34;">
<img src="/blog/images/virto_windows_install/update_pci_003.png" width="788" height="578" title="&#34;update_pci_003.png&#34;" alt="&#34;update_pci_003.png&#34;"></p>

<h5>install the VioStor driver</h5>

<p>Add a temporary disk to the virtual machine and use <strong>VirtIO</strong> as the <strong>Bus Type</strong>
In the <strong>Device Manager</strong> you&rsquo;ll get a new device <strong>SCSI Controller</strong> right click it and update the driver.
This will install the <strong>Red Hat VirtIO SCSI controller</strong></p>

<p><img src="/blog/images/virto_windows_install/install_viostor_000.png" width="552" height="567" title="&#34;install_viostor_000.png&#34;" alt="&#34;install_viostor_000.png&#34;">
<img src="/blog/images/virto_windows_install/install_viostor_001.png" width="786" height="576" title="&#34;install_viostor_001.png&#34;" alt="&#34;install_viostor_001.png&#34;">
<img src="/blog/images/virto_windows_install/install_viostor_002.png" width="622" height="461" title="&#34;install_viostor_002.png&#34;" alt="&#34;install_viostor_002.png&#34;"></p>

<p>Go to the device settings of your virtual machine and change the <strong>Disk bus</strong> to <strong>VirtIO</strong>
and shutdown you virtual machine.</p>

<p><img src="/blog/images/virto_windows_install/install_viostor_003.png" width="705" height="689" title="&#34;install_viostor_003.png&#34;" alt="&#34;install_viostor_003.png&#34;"></p>

<p>You can remove the temporary disk now or leave it if you can find some use for it&hellip;</p>

<p>Make sure that you disk is selected as the bootable device.</p>

<p><img src="/blog/images/virto_windows_install/install_viostor_004.png" width="885" height="689" title="&#34;install_viostor_004.png&#34;" alt="&#34;install_viostor_004.png&#34;"></p>

<p>Start the virtual machine and make sure that the system is bootable.</p>

<h6>install the netKVM driver</h6>

<p>Update the <strong>Device model</strong> to <strong>virtio</strong>.</p>

<p><img src="/blog/images/virto_windows_install/use_virtio_net_000.png" width="699" height="689" title="&#34;use_virtio_net_000.png&#34;" alt="&#34;use_virtio_net_000.png&#34;"></p>

<p>Start <code>devmgmt.msc</code> and update the driver as we did before&hellip;.</p>

<p><img src="/blog/images/virto_windows_install/install_netkvm_000.png" width="809" height="737" title="&#34;install_netkvm_000.png&#34;" alt="&#34;install_netkvm_000.png&#34;">
<img src="/blog/images/virto_windows_install/install_netkvm_001.png" width="788" height="586" title="&#34;install_netkvm_001.png&#34;" alt="&#34;install_netkvm_001.png&#34;"></p>

<p>And verify that you network card works correctly.</p>

<p><img src="/blog/images/virto_windows_install/install_netkvm_002.png" width="902" height="645" title="&#34;install_netkvm_002.png&#34;" alt="&#34;install_netkvm_002.png&#34;"></p>

<h6>install the QXL graphical driver</h6>

<p>Update the <strong>Microsoft Basic Display Adapter</strong></p>

<p><img src="/blog/images/virto_windows_install/install_qxl_000.png" width="792" height="581" title="&#34;install_qxl_000.png&#34;" alt="&#34;install_qxl_000.png&#34;">
<img src="/blog/images/virto_windows_install/install_qxl_001.png" width="788" height="582" title="&#34;install_qxl_001.png&#34;" alt="&#34;install_qxl_001.png&#34;">
<img src="/blog/images/virto_windows_install/install_qxl_002.png" width="863" height="597" title="&#34;install_qxl_002.png&#34;" alt="&#34;install_qxl_002.png&#34;"></p>

<p>After the installation you can change the the display resolution.</p>

<p><img src="/blog/images/virto_windows_install/install_qxl_003.png" width="812" height="651" title="&#34;install_qxl_003.png&#34;" alt="&#34;install_qxl_003.png&#34;"></p>

<p>If you want to use higher screen resolutions you need to <a href="https://stafwag.github.io/blog/blog/2018/04/22/high-screen-resolution-on-a-kvm-virtual-machine-with-qxl/">increase the video ram</a></p>

<p><strong><em>Have fun!</em></strong></p>

<h2>Links</h2>

<ul>
<li><a href="https://raymii.org/s/articles/virt-install_introduction_and_copy_paste_distro_install_commands.html">https://raymii.org/s/articles/virt-install_introduction_and_copy_paste_distro_install_commands.html</a></li>
<li><a href="http://bart.vanhauwaert.org/hints/installing-win10-on-KVM.html">http://bart.vanhauwaert.org/hints/installing-win10-on-KVM.html</a></li>
<li><a href="https://docs.fedoraproject.org/quick-docs/en-US/creating-windows-virtual-machines-using-virtio-drivers.html">https://docs.fedoraproject.org/quick-docs/en-US/creating-windows-virtual-machines-using-virtio-drivers.html</a></li>
<li><a href="https://pve.proxmox.com/wiki/Windows_VirtIO_Drivers">https://pve.proxmox.com/wiki/Windows_VirtIO_Drivers</a></li>
<li><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/virtualization_host_configuration_and_guest_installation_guide/form-virtualization_host_configuration_and_guest_installation_guide-para_virtualized_drivers-mounting_the_image_with_virt_manager">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/virtualization_host_configuration_and_guest_installation_guide/form-virtualization_host_configuration_and_guest_installation_guide-para_virtualized_drivers-mounting_the_image_with_virt_manager</a></li>
</ul>

</div>
  
  

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog_actrikel -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4659298941528586"
     data-ad-slot="7394058542"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2018/06/04/nested-virtualization-in-kvm/">Nested Virtualization in KVM</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-06-04T19:58:06+02:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>4</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>7:58 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>KVM</h2>

<p><a href="https://www.linux-kvm.org">Kernel-based Virtual Machine (KVM)</a> has become the defacto hypervisor on GNU/Linux systems it works with great performance as it utilizes the CPU virtualization extensions <a href="https://en.wikipedia.org/wiki/X86_virtualization#Intel_virtualization_(VT-x)">Inetl VT-x</a> or <a href="https://en.wikipedia.org/wiki/X86_virtualization#AMD_virtualization_(AMD-V)">AMD-V</a>). KVM doesn&rsquo;t emulate hardware but uses <a href="https://www.qemu.org/">QEMU</a> for this.</p>

<h2>Nested Virtual guest</h2>

<p>It&rsquo;s possible to use nested virtualization this make it possible to run a hypervisor inside a KVM virtual machine.</p>

<h2>Enabling nested virtualization in KVM</h2>

<h3>Verify</h3>

<p>To verify if nested virtualization is enabled on your system can check /sys/module/kvm_intel/parameters/nested on Intal systems or /sys/module/kvm_amd/parameters/nested</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@frija ~]$ cat /sys/module/kvm_intel/parameters/nested
</span><span class='line'>N
</span><span class='line'>[staf@frija ~]$ </span></code></pre></td></tr></table></div></figure>


<h3>Enable</h3>

<h4>Shutdown all virtual machines</h4>

<p>Make sure that there no virtual machines running.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@frija ~]# virsh 
</span><span class='line'>Welcome to virsh, the virtualization interactive terminal.
</span><span class='line'>
</span><span class='line'>Type:  'help' for help with commands
</span><span class='line'>       'quit' to quit
</span><span class='line'>
</span><span class='line'>virsh # list
</span><span class='line'> Id    Name                           State
</span><span class='line'>----------------------------------------------------
</span><span class='line'>
</span><span class='line'>virsh # </span></code></pre></td></tr></table></div></figure>


<p></p>

<h4>Unload KVM</h4>

<p>Unload the KVM kernel module.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@frija ~]# modprobe -r kvm_intel
</span><span class='line'>[root@frija ~]# </span></code></pre></td></tr></table></div></figure>


<h4>Load KVM and activate nested</h4>

<p>Reload the KVM with the nested feature enabled.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@frija ~]# modprobe kvm_intel nested=1
</span><span class='line'>[root@frija ~]# </span></code></pre></td></tr></table></div></figure>


<p>Verify</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@frija ~]# cat /sys/module/kvm_intel/parameters/nested
</span><span class='line'>Y
</span><span class='line'>[root@frija ~]# </span></code></pre></td></tr></table></div></figure>


<p>To enable the nested feature permanently create /etc/modprobe.d/kvm_intel.conf</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@frija ~]# vi /etc/modprobe.d/kvm_intel.conf</span></code></pre></td></tr></table></div></figure>


<p>and enable the nested option.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>options kvm_intel nested=1</span></code></pre></td></tr></table></div></figure>


<h2>Enabling nested virtialization in the virtual machine</h2>

<p>When you logon to a virtual machine and verify the virtualization extensions on the cpu the flags aren&rsquo;t available.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@centos7 ~]$ cat /proc/cpuinfo | grep  -i -E "vmx|svm"
</span><span class='line'>[staf@centos7 ~]$ </span></code></pre></td></tr></table></div></figure>


<p>To enable nested virtualization in a vritual machine you can</p>

<ul>
<li>start <code>virsh</code> and and edit the the virtual machine and change the CPU line to <code>&lt;cpu mode='host-model' check='partial'/&gt;</code></li>
<li>Open virt-manager and select <strong>Copy host CPU configuration</strong> on the CPU configuration</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@frija ~]# virsh 
</span><span class='line'>Welcome to virsh, the virtualization interactive terminal.
</span><span class='line'>
</span><span class='line'>Type:  'help' for help with commands
</span><span class='line'>       'quit' to quit
</span><span class='line'>
</span><span class='line'>virsh # list
</span><span class='line'> Id    Name                           State
</span><span class='line'>----------------------------------------------------
</span><span class='line'> 1     centos7.0                      running
</span><span class='line'>
</span><span class='line'>virsh # edit centos7.0 </span></code></pre></td></tr></table></div></figure>


<p>Change the cpu settings</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  &lt;features&gt;
</span><span class='line'>    &lt;acpi/&gt;
</span><span class='line'>    &lt;apic/&gt;
</span><span class='line'>    &lt;vmport state='off'/&gt;
</span><span class='line'>  &lt;/features&gt;
</span><span class='line'>  &lt;cpu mode='host-model' check='partial'&gt;
</span><span class='line'>    &lt;model fallback='allow'/&gt;
</span><span class='line'>  &lt;/cpu&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Shutdown the virtual machine</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>virsh # reboot centos7.0 
</span><span class='line'>Domain centos7.0 is being rebooted
</span><span class='line'>
</span><span class='line'>virsh # 
</span></code></pre></td></tr></table></div></figure>


<p>Start the virtual machine</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>virsh # start centos7.0  
</span><span class='line'>Domain centos7.0 started</span></code></pre></td></tr></table></div></figure>


<p>Verify that the <code>feature policies</code> on the cpu are updated.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>virsh # dumpxml centos7.0 </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> &lt;cpu mode='custom' match='exact' check='full'&gt;
</span><span class='line'>    &lt;model fallback='forbid'&gt;Haswell-noTSX-IBRS&lt;/model&gt;
</span><span class='line'>    &lt;vendor&gt;Intel&lt;/vendor&gt;
</span><span class='line'>    &lt;feature policy='require' name='vme'/&gt;
</span><span class='line'>    &lt;feature policy='require' name='ss'/&gt;
</span><span class='line'>    &lt;feature policy='require' name='f16c'/&gt;
</span><span class='line'>    &lt;feature policy='require' name='rdrand'/&gt;
</span><span class='line'>    &lt;feature policy='require' name='hypervisor'/&gt;
</span><span class='line'>    &lt;feature policy='require' name='arat'/&gt;
</span><span class='line'>    &lt;feature policy='require' name='tsc_adjust'/&gt;
</span><span class='line'>    &lt;feature policy='require' name='xsaveopt'/&gt;
</span><span class='line'>    &lt;feature policy='require' name='pdpe1gb'/&gt;
</span><span class='line'>    &lt;feature policy='require' name='abm'/&gt;
</span><span class='line'>    &lt;feature policy='require' name='ibpb'/&gt;
</span><span class='line'> &lt;/cpu&gt;</span></code></pre></td></tr></table></div></figure>


<p>Logon to the virtual machine and verify the cpu flags;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@centos7 ~]$ cat /proc/cpuinfo | grep -i vmx
</span><span class='line'>flags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss syscall nx pdpe1gb rdtscp lm constant_tsc rep_good nopl xtopology eagerfpu pni pclmulqdq vmx ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm tpr_shadow vnmi flexpriority ept vpid fsgsbase tsc_adjust bmi1 avx2 smep bmi2 erms invpcid xsaveopt ibpb ibrs arat spec_ctrl
</span><span class='line'>flags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss syscall nx pdpe1gb rdtscp lm constant_tsc rep_good nopl xtopology eagerfpu pni pclmulqdq vmx ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm tpr_shadow vnmi flexpriority ept vpid fsgsbase tsc_adjust bmi1 avx2 smep bmi2 erms invpcid xsaveopt ibpb ibrs arat spec_ctrl
</span><span class='line'>[staf@centos7 ~]$ cat /proc/cpuinfo | grep  -i "vmx|svm"
</span><span class='line'>[staf@centos7 ~]$ cat /proc/cpuinfo | grep  -i -E "vmx|svm"
</span><span class='line'>flags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss syscall nx pdpe1gb rdtscp lm constant_tsc rep_good nopl xtopology eagerfpu pni pclmulqdq vmx ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm tpr_shadow vnmi flexpriority ept vpid fsgsbase tsc_adjust bmi1 avx2 smep bmi2 erms invpcid xsaveopt ibpb ibrs arat spec_ctrl
</span><span class='line'>flags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss syscall nx pdpe1gb rdtscp lm constant_tsc rep_good nopl xtopology eagerfpu pni pclmulqdq vmx ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm tpr_shadow vnmi flexpriority ept vpid fsgsbase tsc_adjust bmi1 avx2 smep bmi2 erms invpcid xsaveopt ibpb ibrs arat spec_ctrl</span></code></pre></td></tr></table></div></figure>


<p>Execute the <code>virt-host-validate</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@centos7 ~]$ virt-host-validate
</span><span class='line'>  QEMU: Checking for hardware virtualization                                 : PASS
</span><span class='line'>  QEMU: Checking if device /dev/kvm exists                                   : PASS
</span><span class='line'>  QEMU: Checking if device /dev/kvm is accessible                            : PASS
</span><span class='line'>  QEMU: Checking if device /dev/vhost-net exists                             : PASS
</span><span class='line'>  QEMU: Checking if device /dev/net/tun exists                               : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'memory' controller support                      : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'memory' controller mount-point                  : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'cpu' controller support                         : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'cpu' controller mount-point                     : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'cpuacct' controller support                     : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'cpuacct' controller mount-point                 : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'cpuset' controller support                      : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'cpuset' controller mount-point                  : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'devices' controller support                     : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'devices' controller mount-point                 : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'blkio' controller support                       : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'blkio' controller mount-point                   : PASS
</span><span class='line'>  QEMU: Checking for device assignment IOMMU support                         : WARN (No ACPI DMAR table found, IOMMU either disabled in BIOS or not supported by this hardware platform)
</span><span class='line'>   LXC: Checking for Linux &gt;= 2.6.26                                         : PASS
</span><span class='line'>   LXC: Checking for namespace ipc                                           : PASS
</span><span class='line'>   LXC: Checking for namespace mnt                                           : PASS
</span><span class='line'>   LXC: Checking for namespace pid                                           : PASS
</span><span class='line'>   LXC: Checking for namespace uts                                           : PASS
</span><span class='line'>   LXC: Checking for namespace net                                           : PASS
</span><span class='line'>   LXC: Checking for namespace user                                          : PASS
</span><span class='line'>   LXC: Checking for cgroup 'memory' controller support                      : PASS
</span><span class='line'>   LXC: Checking for cgroup 'memory' controller mount-point                  : PASS
</span><span class='line'>   LXC: Checking for cgroup 'cpu' controller support                         : PASS
</span><span class='line'>   LXC: Checking for cgroup 'cpu' controller mount-point                     : PASS
</span><span class='line'>   LXC: Checking for cgroup 'cpuacct' controller support                     : PASS
</span><span class='line'>   LXC: Checking for cgroup 'cpuacct' controller mount-point                 : PASS
</span><span class='line'>   LXC: Checking for cgroup 'cpuset' controller support                      : PASS
</span><span class='line'>   LXC: Checking for cgroup 'cpuset' controller mount-point                  : PASS
</span><span class='line'>   LXC: Checking for cgroup 'devices' controller support                     : PASS
</span><span class='line'>   LXC: Checking for cgroup 'devices' controller mount-point                 : PASS
</span><span class='line'>   LXC: Checking for cgroup 'blkio' controller support                       : PASS
</span><span class='line'>   LXC: Checking for cgroup 'blkio' controller mount-point                   : PASS
</span><span class='line'>   LXC: Checking if device /sys/fs/fuse/connections exists                   : FAIL (Load the 'fuse' module to enable /proc/ overrides)
</span><span class='line'>[staf@centos7 ~]$ </span></code></pre></td></tr></table></div></figure>


<p><strong><em>Have fun</em></strong></p>

<h2>Links</h2>

<ul>
<li><a href="https://docs.fedoraproject.org/quick-docs/en-US/using-nested-virtualization-in-kvm.html"><a href="https://docs.fedoraproject.org/quick-docs/en-US/using-nested-virtualization-in-kvm.html">https://docs.fedoraproject.org/quick-docs/en-US/using-nested-virtualization-in-kvm.html</a></a></li>
<li><a href="https://wiki.archlinux.org/index.php/KVM#Nested_virtualization"><a href="https://wiki.archlinux.org/index.php/KVM#Nested_virtualization">https://wiki.archlinux.org/index.php/KVM#Nested_virtualization</a></a></li>
<li><a href="https://www.linux-kvm.org/page/Nested_Guests"><a href="https://www.linux-kvm.org/page/Nested_Guests">https://www.linux-kvm.org/page/Nested_Guests</a></a></li>
</ul>

</div>
  
  

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog_actrikel -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4659298941528586"
     data-ad-slot="7394058542"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2018/05/11/32-bits-matters/">32 Bits Matters!</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-05-11T09:08:17+02:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>11</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>9:08 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img class="right" src="/blog/images/32bits_opnsense.jpg" width="500" height="411" title="&#34;32bits_opnsense.jpg&#34;" alt="&#34;32bits_opnsense.jpg&#34;"></p>

<h3>pfsense 2.3</h3>

<p>My firewall is a <a href="https://pcengines.ch/">pcengines</a> <a href="https://pcengines.ch/alix2d13.htm">alix</a>.</p>

<p>It was running <a href="https://www.pfsense.org">pfsense</a> and was quite happy about it. Pfsense dropped support for 32 bits in their <a href="https://doc.pfsense.org/index.php/Does_pfSense_support_64_bit_systems">pfsense 2.4 release</a>.</p>

<p>This would left me with a unsupported firewall which was one of the reasons to use pfsense instead of a closed source commercial router.</p>

<p>I could have moved to a new firewall like the <a href="https://pcengines.ch/apu.htm">pcengines apu</a> but there is no reason to replace hardware that works fine.</p>

<p>The nice thing about opensource software is that we&rsquo;ve options to choose from if software doesn&rsquo;t match your usecase we&rsquo;ve other options to choose from.</p>

<h3>OPNsense</h3>

<p>So I decided to give <a href="https://opnsense.org/">opnsense</a> a try. OPNsense is a fork of pfsense, both are a fork of <a href="https://m0n0.ch/wall/index.php">m0n0wall</a>.</p>

<p><img class="left" src="/blog/images/opnsense_swapspace.png" width="500" height="584" title="&#34;opnsense_swapspace.png&#34;" alt="&#34;opnsense_swapspace.png&#34;"></p>

<h4>swapspace</h4>

<p>My firewall only has 256 MB of memory which is a bit low even for a firewall.</p>

<p>The OPNsense developers made it very easy to add swapspace from the GUI. To add swap space go to [ System ] > [ Miscellaneous ] and activate the [ Add a 2 GB swap file to the system ] checkbox.</p>

<p>I&rsquo;m verify satisfied with the upgrade from pfsense to OPNsense, OPNsense has a new release very month which is nice to get the latest security updates and it&rsquo;s possible to audit the systems for security updates from the GUI.</p>

<p><img class="right" src="/blog/images/duckdns_icon.png" width="150" height="150" title="&#34;duckdns&#34;" alt="&#34;duckdns&#34;"></p>

<h3>DuckDns</h3>

<p>I move my ADSL with a fixed ip address to a VDSL line with a dynamic ip address so I was looking a good free dynamic dns provider and settled with <a href="https://www.duckdns.org/">duckdns</a>.</p>

<p><strong><em> Have fun </em></strong></p>
</div>
  
  

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog_actrikel -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4659298941528586"
     data-ad-slot="7394058542"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/posts/2">&larr; Older</a>
    
    <a href="/blog/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <p><a href="http://www.wagemakers.be">http://www.wagemakers.be</a></p>
  <p><a href="http://www.linkedin.com/in/stafwagemakers">LinkedIn profile</a></p>
  <p><a href="https://google.com/+StafWagemakers">Google Plus profile</a></p>
<!-- Place this tag where you want the widget to render. -->
<div class="g-person" data-width="180" data-href="http://google.com/+StafWagemakers" data-showtagline="false" data-showcoverphoto="false" data-rel="author"></div>

<!-- Place this tag after the last widget tag. -->
<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
</section>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/blog/2019/03/03/howto-use-centos-cloud-images-with-cloud-init/">Howto Use Centos Cloud Images With Cloud-init on KVM/libvirtd</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2019/02/10/how-to-install-libreboot-on-a-thinkspad-w500/">How to Install Libreboot on a ThinkPad W500</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2019/01/21/settinp-up-openstack-ansible-all-in-one-on-a-centos-7-system/">Setting Up OpenStack-Ansible All-In-One on a Centos 7 System</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2019/01/02/best-wishes-2019/">Best Wishes 2019</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2018/12/09/configure-dns-tls-on-opnsense/">How to Configure DNS-over-TLS on OPNsense</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/stafwag">@stafwag</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'stafwag',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/blog/javascripts/github.js" type="text/javascript"> </script>
</section>





<hr />
<br />
<br />
<br />
<br />
<script type="text/javascript"><!--
google_ad_client = "ca-pub-4659298941528586";
/* blogads_right */
google_ad_slot = "8839948148";
google_ad_width = 160;
google_ad_height = 600;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2019 - staf wagemakers -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'stafwag';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
