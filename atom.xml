<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[stafwag Blog]]></title>
  <link href="https://stafwag.github.io/blog/atom.xml" rel="self"/>
  <link href="https://stafwag.github.io/blog/"/>
  <updated>2019-05-21T19:16:01+02:00</updated>
  <id>https://stafwag.github.io/blog/</id>
  <author>
    <name><![CDATA[staf wagemakers]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[OPNsense Upgrade Failed: Out of Inodes]]></title>
    <link href="https://stafwag.github.io/blog/blog/2019/05/21/opnsense-out-of-inodes/"/>
    <updated>2019-05-21T19:20:37+02:00</updated>
    <id>https://stafwag.github.io/blog/blog/2019/05/21/opnsense-out-of-inodes</id>
    <content type="html"><![CDATA[<p><a href="https://stafwag.github.io/blog/images/opnsense_out_of_inodes.jpg"><img src="https://stafwag.github.io/blog/images/opnsense_out_of_inodes.jpg" class="left" width="500" height="382" alt="opnsense with no inodes" /></a></p>

<p>I use <a href="https://opnsense.org/">OPNsense</a> as <a href="http://stafwag.github.io/blog/blog/2018/05/11/32-bits-matters/">my firewall</a> on a <a href="https://pcengines.ch/">Pcengines</a> <a href="https://pcengines.ch/alix2d13.htm">Alix</a>.</p>

<p>The primary reason is to have a firewall that will be always up-to-update, unlike most commercial customer grade firewalls that are only supported for a few years. Having a firewall that runs opensource software - it&rsquo;s based on <a href="https://www.freebsd.org">FreeBSD</a> - also make it easier to review and to verify that there are no <a href="https://en.wikipedia.org/wiki/Backdoor_(computing)">back doors</a>.</p>

<p>When I tried to upgrade it to the latest release - 19.1.7 - the upgrade failed because the filesystem ran out of inodes. There is already <a href="https://forum.opnsense.org/index.php?topic=12639.15">a topic</a> about this at the <a href="https://forum.opnsense.org/index.php?topic=12639.15">OPNsense forum</a> and <a href="https://github.com/opnsense/tools/commit/0657a0ae479b4">a fix available</a> for the upcoming nano OPNsense images.</p>

<p>But this will only resolve the issue when a new image becomes available and would require a reinstallation of the firewall.</p>

<p>Unlike <a href="https://en.wikipedia.org/wiki/Ext2">ext2/&frac34;</a> or <a href="https://en.wikipedia.org/wiki/Silicon_Graphics">Sgi</a>&rsquo;s <a href="https://en.wikipedia.org/wiki/XFS">XFS</a> on <a href="https://www.gnu.org/">GNU</a>/<a href="https://www.kernel.org/">Linux</a>, it isn&rsquo;t possible to increase the number of inodes on a <a href="https://en.wikipedia.org/wiki/Unix_File_System">UFS filesystem</a> on <a href="https://www.freebsd.org/">FreeBSD</a>.</p>

<p>To resolve the upgrade issue I created a backup of the existing filesystem, created a new filesystem with enough inodes, and restored the backup.</p>

<p>You&rsquo;ll find my journey of fixing the out of inodes issue below all commands are executed on a FreeBSD system. Hopefully this useful for someone.</p>

<h1>Fixing the out of inodes</h1>

<p>I connected the OPNsense <a href="https://en.wikipedia.org/wiki/CompactFlash">CF disk </a> to a USB cardreader on a FreeBSD virtual system.</p>

<h2>Find the disk</h2>

<p>Find the CF disk I use <code>gpart show</code> as this will also display the disk labels etc.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@freebsd:~ # gpart show
</span><span class='line'>=&gt;      40  41942960  vtbd0  GPT  (20G)
</span><span class='line'>        40      1024      1  freebsd-boot  (512K)
</span><span class='line'>      1064       984         - free -  (492K)
</span><span class='line'>      2048   4194304      2  freebsd-swap  (2.0G)
</span><span class='line'>   4196352  37744640      3  freebsd-zfs  (18G)
</span><span class='line'>  41940992      2008         - free -  (1.0M)
</span><span class='line'>
</span><span class='line'>=&gt;      0  7847280  da0  BSD  (3.7G)
</span><span class='line'>        0  7847280    1  freebsd-ufs  (3.7G)
</span><span class='line'>
</span><span class='line'>=&gt;      0  7847280  ufsid/5a6b137a11c4f909  BSD  (3.7G)
</span><span class='line'>        0  7847280                       1  freebsd-ufs  (3.7G)
</span><span class='line'>
</span><span class='line'>=&gt;      0  7847280  ufs/OPNsense_Nano  BSD  (3.7G)
</span><span class='line'>        0  7847280                  1  freebsd-ufs  (3.7G)
</span><span class='line'>
</span><span class='line'>root@freebsd:~ # </span></code></pre></td></tr></table></div></figure>


<h2>Backup</h2>

<p>Create a backup with the old-school <code>dd</code>, just in case.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@freebsd:~ # dd if=/dev/da0 of=/home/staf/opnsense.dd bs=4M status=progress
</span><span class='line'>  4013948928 bytes (4014 MB, 3828 MiB) transferred 415.226s, 9667 kB/s
</span><span class='line'>957+1 records in
</span><span class='line'>957+1 records out
</span><span class='line'>4017807360 bytes transferred in 415.634273 secs (9666689 bytes/sec)
</span><span class='line'>root@freebsd:~ # </span></code></pre></td></tr></table></div></figure>


<h3>mount</h3>

<p>Verify that we can mount the filesystem.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@freebsd:/ # mount /dev/da0a /mnt
</span><span class='line'>root@freebsd:/ # cd /mnt
</span><span class='line'>root@freebsd:/mnt # ls
</span><span class='line'>.cshrc                          dev                             net
</span><span class='line'>.probe.for.install.media        entropy                         proc
</span><span class='line'>.profile                        etc                             rescue
</span><span class='line'>.rnd                            home                            root
</span><span class='line'>COPYRIGHT                       lib                             sbin
</span><span class='line'>bin                             libexec                         sys
</span><span class='line'>boot                            lost+found                      tmp
</span><span class='line'>boot.config                     media                           usr
</span><span class='line'>conf                            mnt                             var
</span><span class='line'>root@freebsd:/mnt # cd ..
</span><span class='line'>root@freebsd:/ #  df -i /mnt
</span><span class='line'>Filesystem 1K-blocks    Used   Avail Capacity iused ifree %iused  Mounted on
</span><span class='line'>/dev/da0a    3916903 1237690 2365861    34%   38203  6595   85%   /mnt
</span><span class='line'>root@freebsd:/ # </span></code></pre></td></tr></table></div></figure>


<h3>umount</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@freebsd:/ # umount /mnt</span></code></pre></td></tr></table></div></figure>


<h3>dump</h3>

<p>We&rsquo;ll a create a backup with <code>dump</code>, we&rsquo;ll use this backup to restore it again after we created a new filesystem with enough inodes.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@freebsd:/ # dump 0uaf /home/staf/opensense.dump /dev/da0a
</span><span class='line'>  DUMP: Date of this level 0 dump: Sun May 19 10:43:56 2019
</span><span class='line'>  DUMP: Date of last level 0 dump: the epoch
</span><span class='line'>  DUMP: Dumping /dev/da0a to /home/staf/opensense.dump
</span><span class='line'>  DUMP: mapping (Pass I) [regular files]
</span><span class='line'>  DUMP: mapping (Pass II) [directories]
</span><span class='line'>  DUMP: estimated 1264181 tape blocks.
</span><span class='line'>  DUMP: dumping (Pass III) [directories]
</span><span class='line'>  DUMP: dumping (Pass IV) [regular files]
</span><span class='line'>  DUMP: 16.21% done, finished in 0:25 at Sun May 19 11:14:51 2019
</span><span class='line'>  DUMP: 33.27% done, finished in 0:20 at Sun May 19 11:14:03 2019
</span><span class='line'>  DUMP: 49.65% done, finished in 0:15 at Sun May 19 11:14:12 2019
</span><span class='line'>  DUMP: 66.75% done, finished in 0:09 at Sun May 19 11:13:57 2019
</span><span class='line'>  DUMP: 84.20% done, finished in 0:04 at Sun May 19 11:13:41 2019
</span><span class='line'>  DUMP: 99.99% done, finished soon
</span><span class='line'>  DUMP: DUMP: 1267205 tape blocks on 1 volume
</span><span class='line'>  DUMP: finished in 1800 seconds, throughput 704 KBytes/sec
</span><span class='line'>  DUMP: level 0 dump on Sun May 19 10:43:56 2019
</span><span class='line'>  DUMP: Closing /home/staf/opensense.dump
</span><span class='line'>  DUMP: DUMP IS DONE
</span><span class='line'>root@freebsd:/ # </span></code></pre></td></tr></table></div></figure>


<h2>newfs</h2>

<p>According to the <a href="https://www.freebsd.org/cgi/man.cgi?newfs(8)">newfs manpage</a>:
We can specify the inode density with the <code>-i</code> option. A lower number will give use more inodes.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@freebsd:/ # newfs -i 1 /dev/da0a
</span><span class='line'>density increased from 1 to 4096
</span><span class='line'>/dev/da0a: 3831.7MB (7847280 sectors) block size 32768, fragment size 4096
</span><span class='line'>        using 8 cylinder groups of 479.00MB, 15328 blks, 122624 inodes.
</span><span class='line'>super-block backups (for fsck_ffs -b #) at:
</span><span class='line'> 192, 981184, 1962176, 2943168, 3924160, 4905152, 5886144, 6867136
</span><span class='line'>root@freebsd:/ # </span></code></pre></td></tr></table></div></figure>


<h2>mount and verify</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@freebsd:/ # mount /dev/da0a /mnt
</span><span class='line'>root@freebsd:/ # df -i
</span><span class='line'>Filesystem         1K-blocks    Used    Avail Capacity iused    ifree %iused  Mounted on
</span><span class='line'>zroot/ROOT/default  14562784 1819988 12742796    12%   29294 25485592    0%   /
</span><span class='line'>devfs                      1       1        0   100%       0        0  100%   /dev
</span><span class='line'>zroot/tmp           12742884      88 12742796     0%      11 25485592    0%   /tmp
</span><span class='line'>zroot/usr/home      14522868 1780072 12742796    12%      17 25485592    0%   /usr/home
</span><span class='line'>zroot/usr/ports     13473616  730820 12742796     5%  178143 25485592    1%   /usr/ports
</span><span class='line'>zroot/usr/src       13442804  700008 12742796     5%   84122 25485592    0%   /usr/src
</span><span class='line'>zroot/var/audit     12742884      88 12742796     0%       9 25485592    0%   /var/audit
</span><span class='line'>zroot/var/crash     12742884      88 12742796     0%       8 25485592    0%   /var/crash
</span><span class='line'>zroot/var/log       12742932     136 12742796     0%      21 25485592    0%   /var/log
</span><span class='line'>zroot/var/mail      12742884      88 12742796     0%       8 25485592    0%   /var/mail
</span><span class='line'>zroot/var/tmp       12742884      88 12742796     0%       8 25485592    0%   /var/tmp
</span><span class='line'>zroot               12742884      88 12742796     0%       7 25485592    0%   /zroot
</span><span class='line'>/dev/da0a            3677780       8  3383552     0%       2   980988    0%   /mnt
</span><span class='line'>root@freebsd:/ # </span></code></pre></td></tr></table></div></figure>


<h2>restore</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@freebsd:/mnt # restore rf /home/staf/opensense.dump
</span><span class='line'>root@freebsd:/mnt # </span></code></pre></td></tr></table></div></figure>


<h2>verify</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@freebsd:/mnt # df -ih /mnt
</span><span class='line'>Filesystem    Size    Used   Avail Capacity iused ifree %iused  Mounted on
</span><span class='line'>/dev/da0a     3.5G    1.2G    2.0G    39%     38k  943k    4%   /mnt
</span><span class='line'>root@freebsd:/mnt # </span></code></pre></td></tr></table></div></figure>


<h2>Label</h2>

<p>The installation had a <code>OPNsense_Nano</code> label, underscores are not allowed anymore in label name on FreeBSD 12.
So I used OPNsense instead, we&rsquo;ll update <code>/etc/fstab</code> with the new label name.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@freebsd:~ # tunefs -L OPNsense /dev/da0a
</span><span class='line'>root@freebsd:~ # gpart show
</span><span class='line'>=&gt;      40  41942960  vtbd0  GPT  (20G)
</span><span class='line'>        40      1024      1  freebsd-boot  (512K)
</span><span class='line'>      1064       984         - free -  (492K)
</span><span class='line'>      2048   4194304      2  freebsd-swap  (2.0G)
</span><span class='line'>   4196352  37744640      3  freebsd-zfs  (18G)
</span><span class='line'>  41940992      2008         - free -  (1.0M)
</span><span class='line'>
</span><span class='line'>=&gt;      0  7847280  da0  BSD  (3.7G)
</span><span class='line'>        0  7847280    1  freebsd-ufs  (3.7G)
</span><span class='line'>
</span><span class='line'>=&gt;      0  7847280  ufsid/5ce123f5836f7018  BSD  (3.7G)
</span><span class='line'>        0  7847280                       1  freebsd-ufs  (3.7G)
</span><span class='line'>
</span><span class='line'>=&gt;      0  7847280  ufs/OPNsense  BSD  (3.7G)
</span><span class='line'>        0  7847280             1  freebsd-ufs  (3.7G)
</span><span class='line'>
</span><span class='line'>root@freebsd:~ # </span></code></pre></td></tr></table></div></figure>


<h2>update /etc/fstab</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@freebsd:~ # mount /dev/da0a /mnt
</span><span class='line'>root@freebsd:~ # cd /mnt
</span><span class='line'>root@freebsd:/mnt # cd etc
</span><span class='line'>root@freebsd:/mnt/etc # vi fstab </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Device                Mountpoint      FStype  Options         Dump    Pass#
</span><span class='line'>/dev/ufs/OPNsense       /               ufs     rw              1       1</span></code></pre></td></tr></table></div></figure>


<h2>umount</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@freebsd:/mnt/etc # cd
</span><span class='line'>root@freebsd:~ # umount /mnt
</span><span class='line'>root@freebsd:~ # </span></code></pre></td></tr></table></div></figure>


<h2>test</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>              ______  _____  _____                         
</span><span class='line'>             /  __  |/ ___ |/ __  |                        
</span><span class='line'>             | |  | | |__/ | |  | |___  ___ _ __  ___  ___ 
</span><span class='line'>             | |  | |  ___/| |  | / __|/ _ \ '_ \/ __|/ _ \
</span><span class='line'>             | |__| | |    | |  | \__ \  __/ | | \__ \  __/
</span><span class='line'>             |_____/|_|    |_| /__|___/\___|_| |_|___/\___|
</span><span class='line'>
</span><span class='line'> +=========================================+     @@@@@@@@@@@@@@@@@@@@@@@@@@@@
</span><span class='line'> |                                         |   @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
</span><span class='line'> |  1. Boot Multi User [Enter]             |   @@@@@                    @@@@@
</span><span class='line'> |  2. Boot [S]ingle User                  |       @@@@@            @@@@@    
</span><span class='line'> |  3. [Esc]ape to loader prompt           |    @@@@@@@@@@@       @@@@@@@@@@@
</span><span class='line'> |  4. Reboot                              |         \\\\\         /////     
</span><span class='line'> |                                         |   ))))))))))))       (((((((((((
</span><span class='line'> |  Options:                               |         /////         \\\\\     
</span><span class='line'> |  5. [K]ernel: kernel (1 of 2)           |    @@@@@@@@@@@       @@@@@@@@@@@
</span><span class='line'> |  6. Configure Boot [O]ptions...         |       @@@@@            @@@@@    
</span><span class='line'> |                                         |   @@@@@                    @@@@@
</span><span class='line'> |                                         |   @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
</span><span class='line'> |                                         |   @@@@@@@@@@@@@@@@@@@@@@@@@@@@  
</span><span class='line'> +=========================================+                                  
</span><span class='line'>                                             19.1  ``Inspiring Iguana''   
</span><span class='line'>
</span><span class='line'>/boot/kernel/kernel text=0x1406faf data=0xf2af4+0x2abeec syms=[0x4+0xf9f50+0x4+0x1910f5]
</span><span class='line'>/boot/entropy size=0x1000
</span><span class='line'>/boot/kernel/carp.ko text=0x7f90 data=0x374+0x74 syms=[0x4+0xeb0+0x4+0xf40]
</span><span class='line'>/boot/kernel/if_bridge.ko text=0x7b74 data=0x364+0x3c syms=[0x4+0x1020+0x4+0x125f]
</span><span class='line'>loading required module 'bridgestp'
</span><span class='line'>/boot/kernel/bridgestp.ko text=0x4878 data=0xe0+0x18 syms=[0x4+0x6c0+0x4+0x65c]
</span><span class='line'>/boot/kernel/if_enc.ko text=0x1198 data=0x2b8+0x8 syms=[0x4+0x690+0x4+0x813]
</span><span class='line'>/boot/kernel/if_gre.ko text=0x31d8 data=0x278+0x30 syms=[0x4+0xa30+0x4+0xab8]
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>Root file system: /dev/ufs/OPNsense
</span><span class='line'>Sun May 19 10:28:00 UTC 2019
</span><span class='line'>
</span><span class='line'>*** OPNsense.stafnet: OPNsense 19.1.6 (i386/OpenSSL) ***
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>
</span><span class='line'> HTTPS: SHA256 E8 9F B2 8B BE F9 D7 2D 00 AD D3 D5 60 E3 77 53
</span><span class='line'>           3D AC AB 81 38 E4 D2 75 9E 04 F9 33 FF 76 92 28
</span><span class='line'> SSH:   SHA256 FbjqnefrisCXn8odvUSsM8HtzNNs+9xR/mGFMqHXjfs (ECDSA)
</span><span class='line'> SSH:   SHA256 B6R7GRL/ucRL3JKbHL1OGsdpHRDyotYukc77jgmIJjQ (ED25519)
</span><span class='line'> SSH:   SHA256 8BOmgp8lSFF4okrOUmL4YK60hk7LTg2N08Hifgvlq04 (RSA)
</span><span class='line'>
</span><span class='line'>FreeBSD/i386 (OPNsense.stafnet) (ttyu0)
</span><span class='line'>
</span><span class='line'>login: </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@OPNsense:~ # df -ih
</span><span class='line'>Filesystem           Size    Used   Avail Capacity iused ifree %iused  Mounted on
</span><span class='line'>/dev/ufs/OPNsense    3.5G    1.2G    2.0G    39%     38k  943k    4%   /
</span><span class='line'>devfs                1.0K    1.0K      0B   100%       0     0  100%   /dev
</span><span class='line'>tmpfs                307M     15M    292M     5%     203  2.1G    0%   /var
</span><span class='line'>tmpfs                292M     88K    292M     0%      27  2.1G    0%   /tmp
</span><span class='line'>devfs                1.0K    1.0K      0B   100%       0     0  100%   /var/unbound/dev
</span><span class='line'>devfs                1.0K    1.0K      0B   100%       0     0  100%   /var/dhcpd/dev
</span><span class='line'>root@OPNsense:~ # 
</span><span class='line'>CTRL-A Z for help | 115200 8N1 | NOR | Minicom 2.7.1 | VT102 | Offline | ttyUSB0                                    </span></code></pre></td></tr></table></div></figure>


<h2>update</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>login: root
</span><span class='line'>Password:
</span><span class='line'>----------------------------------------------
</span><span class='line'>|      Hello, this is OPNsense 19.1          |         @@@@@@@@@@@@@@@
</span><span class='line'>|                                            |        @@@@         @@@@
</span><span class='line'>| Website:      https://opnsense.org/        |         @@@\\\   ///@@@
</span><span class='line'>| Handbook:     https://docs.opnsense.org/   |       ))))))))   ((((((((
</span><span class='line'>| Forums:       https://forum.opnsense.org/  |         @@@///   \\\@@@
</span><span class='line'>| Lists:        https://lists.opnsense.org/  |        @@@@         @@@@
</span><span class='line'>| Code:         https://github.com/opnsense  |         @@@@@@@@@@@@@@@
</span><span class='line'>----------------------------------------------
</span><span class='line'>
</span><span class='line'>*** OPNsense.stafnet: OPNsense 19.1.6 (i386/OpenSSL) ***
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>
</span><span class='line'> HTTPS: SHA256 E8 9F B2 8B BE F9 D7 2D 00 AD D3 D5 60 E3 77 53
</span><span class='line'>               3D AC AB 81 38 E4 D2 75 9E 04 F9 33 FF 76 92 28
</span><span class='line'> SSH:   SHA256 FbjqnefrisCXn8odvUSsM8HtzNNs+9xR/mGFMqHXjfs (ECDSA)
</span><span class='line'> SSH:   SHA256 B6R7GRL/ucRL3JKbHL1OGsdpHRDyotYukc77jgmIJjQ (ED25519)
</span><span class='line'> SSH:   SHA256 8BOmgp8lSFF4okrOUmL4YK60hk7LTg2N08Hifgvlq04 (RSA)
</span><span class='line'>
</span><span class='line'>  0) Logout                              7) Ping host
</span><span class='line'>  1) Assign interfaces                   8) Shell
</span><span class='line'>  2) Set interface IP address            9) pfTop
</span><span class='line'>  3) Reset the root password            10) Firewall log
</span><span class='line'>  4) Reset to factory defaults          11) Reload all services
</span><span class='line'>  5) Power off system                   12) Update from console
</span><span class='line'>  6) Reboot system                      13) Restore a backup
</span><span class='line'>
</span><span class='line'>Enter an option: 12
</span><span class='line'>
</span><span class='line'>Fetching change log information, please wait... done
</span><span class='line'>
</span><span class='line'>This will automatically fetch all available updates, apply them,
</span><span class='line'>and reboot if necessary.
</span><span class='line'>
</span><span class='line'>This update requires a reboot.
</span><span class='line'>
</span><span class='line'>Proceed with this action? [y/N]: y 
</span></code></pre></td></tr></table></div></figure>


<p><strong><em> Have fun! </em></strong></p>

<h1>Links</h1>

<ul>
<li><a href="https://forum.opnsense.org/index.php?topic=12639.15">https://forum.opnsense.org/index.php?topic=12639.15</a></li>
<li><a href="https://forums.freebsd.org/threads/ufs-backup.185/">https://forums.freebsd.org/threads/ufs-backup.185/</a></li>
<li><a href="https://www.freebsd.org/doc/handbook/geom-glabel.html">https://www.freebsd.org/doc/handbook/geom-glabel.html</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Building Your Own Docker Base Images (Part 3: Yum)]]></title>
    <link href="https://stafwag.github.io/blog/blog/2019/05/12/building-your-own-docker-base-images-part-3-yum/"/>
    <updated>2019-05-12T10:06:11+02:00</updated>
    <id>https://stafwag.github.io/blog/blog/2019/05/12/building-your-own-docker-base-images-part-3-yum</id>
    <content type="html"><![CDATA[<p><img class="right" src="https://stafwag.github.io/blog/images/fedora_logo_small.png" width="140" height="140" title="&#34;fedora_logo_small.png&#34;" alt="&#34;fedora_logo_small.png&#34;"></p>

<p>In my previous two posts (<a href="https://stafwag.github.io/blog/blog/2019/04/22/building-your-own-docker-images_part1/">1</a>,
<a href="https://stafwag.github.io/blog/blog/2019/04/22/building-your-own-docker-images_part1/">2</a> ), we created Docker <a href="https://www.debian.org/">Debian</a> and
 <a href="https://www.archlinux.org/">Arch</a>-based images from scratch for the <a href="https://en.wikipedia.org/wiki/Intel_80386">i386 architecture</a>.</p>

<p>In this blog post - last one in this series - we&rsquo;ll do the same for <a href="https://en.wikipedia.org/wiki/Yum_(software)">yum</a> based distributions like <a href="https://www.centos.org/">CentOS</a> and <a href="https://getfedora.org/">Fedora</a>.</p>

<p>Building your own Docker base images isn&rsquo;t difficult and let you trust your distribution Gpg signing keys instead of the <a href="https://hub.docker.com/">docker hub</a>. As explained in <a href="http://stafwag.github.io/blog/blog/2019/04/22/building-your-own-docker-images_part1/">the first blog post</a>. The mkimage scripts in the contrib directory of the <a href="https://mobyproject.org/">Moby project</a> git repository is a good place to start if you want to build own docker images.</p>

<p><img class="left" src="https://stafwag.github.io/blog/images/centos_logo_small.png" width="267" height="79" title="&#34;centos_logo_small.png&#34;" alt="&#34;centos_logo_small.png&#34;"></p>

<p>Fedora is one of the GNU/Linux distributions that supports 32 bits systems. Centos has a <a href="https://wiki.centos.org/SpecialInterestGroup">Special Interest Groups</a>
 to support <a href="https://wiki.centos.org/SpecialInterestGroup/AltArch">alternative architectures</a>.
 <a href="https://wiki.centos.org/SpecialInterestGroup/AltArch">The Alternative Architecture SIG</a> create installation images for power, i386, armhfp (arm v732 bits)
 and aarch64 (arm v8 64-bit).</p>

<h1>Centos</h1>

<p>In this blog post, we will create centos based docker images. The procedure to create Fedora images is the same.</p>

<h2>Clone moby</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@centos386 github]$ git clone https://github.com/moby/moby
</span><span class='line'>Cloning into 'moby'...
</span><span class='line'>remote: Enumerating objects: 7, done.
</span><span class='line'>remote: Counting objects: 100% (7/7), done.
</span><span class='line'>remote: Compressing objects: 100% (7/7), done.
</span><span class='line'>remote: Total 269517 (delta 0), reused 1 (delta 0), pack-reused 269510
</span><span class='line'>Receiving objects: 100% (269517/269517), 139.16 MiB | 3.07 MiB/s, done.
</span><span class='line'>Resolving deltas: 100% (182765/182765), done.
</span><span class='line'>[staf@centos386 github]$ </span></code></pre></td></tr></table></div></figure>


<h2>Go to the contrib directory</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@centos386 github]$ cd moby/contrib/
</span><span class='line'>[staf@centos386 contrib]$ </span></code></pre></td></tr></table></div></figure>


<h2>mkimage-yum.sh</h2>

<p>When you run <code>mkimage-yum.sh</code> you get the usage message.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@centos386 contrib]$ ./mkimage-yum.sh 
</span><span class='line'>mkimage-yum.sh [OPTIONS] &lt;name&gt;
</span><span class='line'>OPTIONS:
</span><span class='line'>  -p "&lt;packages&gt;"  The list of packages to install in the container.
</span><span class='line'>                   The default is blank. Can use multiple times.
</span><span class='line'>  -g "&lt;groups&gt;"    The groups of packages to install in the container.
</span><span class='line'>                   The default is "Core". Can use multiple times.
</span><span class='line'>  -y &lt;yumconf&gt;     The path to the yum config to install packages from. The
</span><span class='line'>                   default is /etc/yum.conf for Centos/RHEL and /etc/dnf/dnf.conf for Fedora
</span><span class='line'>  -t &lt;tag&gt;         Specify Tag information.
</span><span class='line'>                   default is reffered at /etc/{redhat,system}-release
</span><span class='line'>[staf@centos386 contrib]$</span></code></pre></td></tr></table></div></figure>


<h2>build the image</h2>

<p>The <code>mkimage-yum.sh</code> script will use /etc/yum.conf or /etc/dnf.conf to build the image. <code>mkimage-yum.sh &lt;name&gt;</code> will create the image with name.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@centos386 contrib]$ sudo ./mkimage-yum.sh centos
</span><span class='line'>[sudo] password for staf: 
</span><span class='line'>+ mkdir -m 755 /tmp/mkimage-yum.sh.LeZQNh/dev
</span><span class='line'>+ mknod -m 600 /tmp/mkimage-yum.sh.LeZQNh/dev/console c 5 1
</span><span class='line'>+ mknod -m 600 /tmp/mkimage-yum.sh.LeZQNh/dev/initctl p
</span><span class='line'>+ mknod -m 666 /tmp/mkimage-yum.sh.LeZQNh/dev/full c 1 7
</span><span class='line'>+ mknod -m 666 /tmp/mkimage-yum.sh.LeZQNh/dev/null c 1 3
</span><span class='line'>+ mknod -m 666 /tmp/mkimage-yum.sh.LeZQNh/dev/ptmx c 5 2
</span><span class='line'>+ mknod -m 666 /tmp/mkimage-yum.sh.LeZQNh/dev/random c 1 8
</span><span class='line'>+ mknod -m 666 /tmp/mkimage-yum.sh.LeZQNh/dev/tty c 5 0
</span><span class='line'>+ mknod -m 666 /tmp/mkimage-yum.sh.LeZQNh/dev/tty0 c 4 0
</span><span class='line'>+ mknod -m 666 /tmp/mkimage-yum.sh.LeZQNh/dev/urandom c 1 9
</span><span class='line'>+ mknod -m 666 /tmp/mkimage-yum.sh.LeZQNh/dev/zero c 1 5
</span><span class='line'>+ '[' -d /etc/yum/vars ']'
</span><span class='line'>+ mkdir -p -m 755 /tmp/mkimage-yum.sh.LeZQNh/etc/yum
</span><span class='line'>+ cp -a /etc/yum/vars /tmp/mkimage-yum.sh.LeZQNh/etc/yum/
</span><span class='line'>+ [[ -n Core ]]
</span><span class='line'>+ yum -c /etc/yum.conf --installroot=/tmp/mkimage-yum.sh.LeZQNh --releasever=/ --setopt=tsflags=nodocs --setopt=group_package_types=mandatory -y groupinstall Core
</span><span class='line'>Loaded plugins: fastestmirror, langpacks
</span><span class='line'>There is no installed groups file.
</span><span class='line'>Maybe run: yum groups mark convert (see man yum)
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>+ tar --numeric-owner -c -C /tmp/mkimage-yum.sh.LeZQNh .
</span><span class='line'>+ docker import - centos:7.6.1810
</span><span class='line'>sha256:7cdb02046bff4c5065de670604fb3252b1221c4853cb4a905ca04488f44f52a8
</span><span class='line'>+ docker run -i -t --rm centos:7.6.1810 /bin/bash -c 'echo success'
</span><span class='line'>success
</span><span class='line'>+ rm -rf /tmp/mkimage-yum.sh.LeZQNh
</span><span class='line'>[staf@centos386 contrib]$</span></code></pre></td></tr></table></div></figure>


<h2>Rename</h2>

<p>A new image is created with the name centos.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@centos386 contrib]$ docker images
</span><span class='line'>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
</span><span class='line'>centos              7.6.1810            7cdb02046bff        3 minutes ago       281 MB
</span><span class='line'>[staf@centos386 contrib]$ </span></code></pre></td></tr></table></div></figure>


<p>You might want to rename to include your name or project name. You can do this by retag the image and remove the old image name.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@centos386 contrib]$ docker images
</span><span class='line'>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
</span><span class='line'>centos              7.6.1810            7cdb02046bff        20 seconds ago      281 MB
</span><span class='line'>[staf@centos386 contrib]$ docker rmi centos
</span><span class='line'>Error response from daemon: No such image: centos:latest
</span><span class='line'>[staf@centos386 contrib]$ docker images
</span><span class='line'>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
</span><span class='line'>centos              7.6.1810            7cdb02046bff        3 minutes ago       281 MB
</span><span class='line'>[staf@centos386 contrib]$ docker tag 7cdb02046bff stafwag/centos_386:7.6.1810 
</span><span class='line'>[staf@centos386 contrib]$ docker images
</span><span class='line'>REPOSITORY           TAG                 IMAGE ID            CREATED             SIZE
</span><span class='line'>centos               7.6.1810            7cdb02046bff        7 minutes ago       281 MB
</span><span class='line'>stafwag/centos_386   7.6.1810            7cdb02046bff        7 minutes ago       281 MB
</span><span class='line'>[staf@centos386 contrib]$ docker rmi centos:7.6.1810
</span><span class='line'>Untagged: centos:7.6.1810
</span><span class='line'>[staf@centos386 contrib]$ docker images
</span><span class='line'>REPOSITORY           TAG                 IMAGE ID            CREATED             SIZE
</span><span class='line'>stafwag/centos_386   7.6.1810            7cdb02046bff        8 minutes ago       281 MB
</span><span class='line'>[staf@centos386 contrib]$ </span></code></pre></td></tr></table></div></figure>


<h2>Test</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@centos386 contrib]$ docker run -it --rm stafwag/centos_386:7.6.1810 /bin/sh
</span><span class='line'>sh-4.2# yum update -y
</span><span class='line'>Loaded plugins: fastestmirror
</span><span class='line'>Determining fastest mirrors
</span><span class='line'> * base: mirror.usenet.farm
</span><span class='line'> * extras: mirror.usenet.farm
</span><span class='line'> * updates: mirror.usenet.farm
</span><span class='line'>base                                                                                                                   | 3.6 kB  00:00:00     
</span><span class='line'>extras                                                                                                                 | 2.9 kB  00:00:00     
</span><span class='line'>updates                                                                                                                | 2.9 kB  00:00:00     
</span><span class='line'>(1/4): updates/7/i386/primary_db                                                                                       | 2.5 MB  00:00:00     
</span><span class='line'>(2/4): extras/7/i386/primary_db                                                                                        | 157 kB  00:00:01     
</span><span class='line'>(3/4): base/7/i386/group_gz                                                                                            | 166 kB  00:00:01     
</span><span class='line'>(4/4): base/7/i386/primary_db                                                                                          | 4.6 MB  00:00:02     
</span><span class='line'>No packages marked for update
</span><span class='line'>sh-4.2# </span></code></pre></td></tr></table></div></figure>


<p><strong><em> Have fun! </em></strong></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Building Your Own Docker Images (Part2: Arch GNU/Linux & Co)]]></title>
    <link href="https://stafwag.github.io/blog/blog/2019/05/05/building-your-own-docker-images-part2/"/>
    <updated>2019-05-05T11:03:05+02:00</updated>
    <id>https://stafwag.github.io/blog/blog/2019/05/05/building-your-own-docker-images-part2</id>
    <content type="html"><![CDATA[<p>In <a href="https://stafwag.github.io/blog/blog/2019/04/22/building-your-own-docker-images_part1/">my previous post</a>, we started with creating <a href="https://www.debian.org/">Debian</a> based docker images from scratch for the <a href="https://en.wikipedia.org/wiki/Intel_80386">i386 architecture</a>.</p>

<p>In this blog post, we&rsquo;ll create Arch GNU/Linux based images.</p>

<h1>Arch GNU/Linux</h1>

<p><a href="https://www.archlinux.org/">Arch Linux</a> stopped supporting i386 systems. When you want to run Archlinux on an i386 system there is a community maintained <a href="https://archlinux32.org/">Archlinux32</a> project and the <a href="https://en.wikipedia.org/wiki/Free_software">Free software</a> version <a href="https://www.parabola.nu/">Parabola GNU/Linux-libre</a>.</p>

<p>For the <a href="https://en.wikipedia.org/wiki/ARM_architecture">arm architecture</a>, there is <a href="https://archlinuxarm.org/">Archlinux Arm</a> project that I <a href="https://stafwag.github.io/blog/blog/2015/12/26/running-docker-on-arm/">used</a>.</p>

<h2>mkimage-arch.sh in moby</h2>

<p>I used <code>mkimage-arch.sh</code> from the <a href="https://mobyproject.org/">Moby/Docker project</a> in the past, but it failed when
I tried it this time&hellip;</p>

<p>I created a small patch to fix it and created <a href="https://github.com/moby/moby/pull/39165">a pull request</a>.
Till the issue is resolved, you can use the version in my <a href="https://github.com/stafwag/moby/blob/">cloned git repository</a>.</p>

<h2>Build the docker image</h2>

<h3>Install the required packages</h3>

<p>Make sure that your system is up-to-date.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@archlinux32 contrib]$ sudo pacman -Syu</span></code></pre></td></tr></table></div></figure>


<p>Install the required packages.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@archlinux32 contrib]$ sudo pacman -S arch-install-scripts expect wget</span></code></pre></td></tr></table></div></figure>


<p></p>

<h3>Directory</h3>

<p>Create a directory that will hold the image data.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@archlinux32 ~]$ mkdir -p dockerbuild/archlinux32
</span><span class='line'>[staf@archlinux32 ~]$ cd dockerbuild/archlinux32
</span><span class='line'>[staf@archlinux32 archlinux32]$ </span></code></pre></td></tr></table></div></figure>


<h3>Get mkimage-arch.sh</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@archlinux32 archlinux32]$ wget https://raw.githubusercontent.com/stafwag/moby/master/contrib/mkimage-arch.sh
</span><span class='line'>--2019-05-05 07:46:32--  https://raw.githubusercontent.com/stafwag/moby/master/contrib/mkimage-arch.sh
</span><span class='line'>Loaded CA certificate '/etc/ssl/certs/ca-certificates.crt'
</span><span class='line'>Resolving raw.githubusercontent.com (raw.githubusercontent.com)... 151.101.36.133
</span><span class='line'>Connecting to raw.githubusercontent.com (raw.githubusercontent.com)|151.101.36.133|:443... connected.
</span><span class='line'>HTTP request sent, awaiting response... 200 OK
</span><span class='line'>Length: 3841 (3.8K) [text/plain]
</span><span class='line'>Saving to: 'mkimage-arch.sh'
</span><span class='line'>
</span><span class='line'>mkimage-arch.sh                 100%[====================================================&gt;]   3.75K  --.-KB/s    in 0s      
</span><span class='line'>
</span><span class='line'>2019-05-05 07:46:33 (34.5 MB/s) - 'mkimage-arch.sh' saved [3841/3841]
</span><span class='line'>
</span><span class='line'>[staf@archlinux32 archlinux32]$ </span></code></pre></td></tr></table></div></figure>


<p>Make it executable.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@archlinux32 archlinux32]$ chmod +x mkimage-arch.sh
</span><span class='line'>[staf@archlinux32 archlinux32]$ </span></code></pre></td></tr></table></div></figure>


<h3>Setup your pacman.conf</h3>

<p>Copy your pacmnan.conf to the directory that holds <code>mkimage-arch.sh</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@archlinux32 contrib]$ cp /etc/pacman.conf mkimage-arch-pacman.conf
</span><span class='line'>[staf@archlinux32 contrib]$ </span></code></pre></td></tr></table></div></figure>


<h3>Build your image</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@archlinux32 archlinux32]$ TMPDIR=`pwd` sudo ./mkimage-arch.sh
</span><span class='line'>spawn pacstrap -C ./mkimage-arch-pacman.conf -c -d -G -i /var/tmp/rootfs-archlinux-wqxW0uxy8X base bash haveged pacman pacman-mirrorlist --ignore dhcpcd,diffutils,file,inetutils,iproute2,iputils,jfsutils,licenses,linux,linux-firmware,lvm2,man-db,man-pages,mdadm,nano,netctl,openresolv,pciutils,pcmciautils,psmisc,reiserfsprogs,s-nail,sysfsutils,systemd-sysvcompat,usbutils,vi,which,xfsprogs
</span><span class='line'>==&gt; Creating install root at /var/tmp/rootfs-archlinux-wqxW0uxy8X
</span><span class='line'>==&gt; Installing packages to /var/tmp/rootfs-archlinux-wqxW0uxy8X
</span><span class='line'>:: Synchronizing package databases...
</span><span class='line'> core                                              198.0 KiB   676K/s 00:00 [##########################################] 100%
</span><span class='line'> extra                                               2.4 MiB  1525K/s 00:02 [##########################################] 100%
</span><span class='line'> community                                           6.3 MiB   396K/s 00:16 [##########################################] 100%
</span><span class='line'>:: dhcpcd is in IgnorePkg/IgnoreGroup. Install anyway? [Y/n] n
</span><span class='line'>:: diffutils is in IgnorePkg/IgnoreGroup. Install anyway? [Y/n] n
</span><span class='line'>:: file is in IgnorePkg/IgnoreGroup. Install anyway? [Y/n] n
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>==&gt; WARNING: /var/tmp/rootfs-archlinux-wqxW0uxy8X is not a mountpoint. This may have undesirable side effects.
</span><span class='line'>Generating locales...
</span><span class='line'>  en_US.UTF-8... done
</span><span class='line'>Generation complete.
</span><span class='line'>tar: ./etc/pacman.d/gnupg/S.gpg-agent.ssh: socket ignored
</span><span class='line'>tar: ./etc/pacman.d/gnupg/S.gpg-agent.extra: socket ignored
</span><span class='line'>tar: ./etc/pacman.d/gnupg/S.gpg-agent: socket ignored
</span><span class='line'>tar: ./etc/pacman.d/gnupg/S.gpg-agent.browser: socket ignored
</span><span class='line'>sha256:41cd9d9163a17e702384168733a9ca1ade0c6497d4e49a2c641b3eb34251bde1
</span><span class='line'>Success.
</span><span class='line'>[staf@archlinux32 archlinux32]$ </span></code></pre></td></tr></table></div></figure>


<h3>Rename</h3>

<p>A new image is created with the name archlinux.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@archlinux32 archlinux32]$ docker images
</span><span class='line'>REPOSITORY          TAG                 IMAGE ID            CREATED              SIZE
</span><span class='line'>archlinux           latest              18e74c4d823c        About a minute ago   472MB
</span><span class='line'>[staf@archlinux32 archlinux32]$ </span></code></pre></td></tr></table></div></figure>


<p>You might want to rename it. You can do this by retag the image and remove the old image name.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@archlinux32 archlinux32]$ docker images
</span><span class='line'>REPOSITORY          TAG                 IMAGE ID            CREATED              SIZE
</span><span class='line'>archlinux           latest              18e74c4d823c        About a minute ago   472MB
</span><span class='line'>[staf@archlinux32 archlinux32]$ docker tag stafwag/archlinux:386 18e74c4d823c
</span><span class='line'>Error response from daemon: No such image: stafwag/archlinux:386
</span><span class='line'>[staf@archlinux32 archlinux32]$ docker tag 18e74c4d823c stafwag/archlinux:386             
</span><span class='line'>[staf@archlinux32 archlinux32]$ docker images
</span><span class='line'>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
</span><span class='line'>archlinux           latest              18e74c4d823c        3 minutes ago       472MB
</span><span class='line'>stafwag/archlinux   386                 18e74c4d823c        3 minutes ago       472MB
</span><span class='line'>[staf@archlinux32 archlinux32]$ docker rmi archlinux
</span><span class='line'>Untagged: archlinux:latest
</span><span class='line'>[staf@archlinux32 archlinux32]$ docker images
</span><span class='line'>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
</span><span class='line'>stafwag/archlinux   386                 18e74c4d823c        3 minutes ago       472MB
</span><span class='line'>[staf@archlinux32 archlinux32]$ </span></code></pre></td></tr></table></div></figure>


<h3>Test</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@archlinux32 archlinux32]$ docker run --rm -it stafwag/archlinux:386 /bin/sh
</span><span class='line'>sh-5.0# pacman -Syu
</span><span class='line'>:: Synchronizing package databases...
</span><span class='line'> core is up to date
</span><span class='line'> extra is up to date
</span><span class='line'> community is up to date
</span><span class='line'>:: Starting full system upgrade...
</span><span class='line'> there is nothing to do
</span><span class='line'>sh-5.0# </span></code></pre></td></tr></table></div></figure>


<p><strong><em> Have fun! </em></strong></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Building Your Own Docker Base Images (Part 1: Debian GNU/Linux & Co)]]></title>
    <link href="https://stafwag.github.io/blog/blog/2019/04/22/building-your-own-docker-images_part1/"/>
    <updated>2019-04-22T10:36:01+02:00</updated>
    <id>https://stafwag.github.io/blog/blog/2019/04/22/building-your-own-docker-images_part1</id>
    <content type="html"><![CDATA[<p>I was using <a href="https://stafwag.github.io/blog/blog/2015/12/26/running-docker-on-arm/">docker on an Odroid U3</a>, but my Odroid stopped working. I switched to another system that is i386 only.</p>

<p>You&rsquo;ll find my journey to build docker images for i386 below.</p>

<h1>Reasons to build your own docker images</h1>

<p>If you want to use <a href="https://www.docker.com/">docker</a> you can start with docker images on the <a href="https://hub.docker.com/">docker registry</a>.
There are several reasons to build your own base images.</p>

<ul>
<li><h2>Security</h2></li>
</ul>


<p>The first reason is security, docker images are not signed by default.</p>

<p>Anyone can upload docker images to the public docker hub with bugs or malicious code.</p>

<p>There are &ldquo;official&rdquo; docker images available at <a href="https://docs.docker.com/docker-hub/official_images/">https://docs.docker.com/docker-hub/official_images/</a> when you execute a <code>docker search</code>  the official docker images are tagged on the official column and are also signed by Docker. To only allow signed docker images you need to set the <code>DOCKER_CONTENT_TRUST=1</code> environment variable. - This should be the default IMHO -</p>

<p>There is one distinction, the &ldquo;official&rdquo; docker images are signed by the &ldquo;Repo admin&rdquo; of the Docker hub, not by the official GNU/Linux distribution project.
If you want to trust the official project instead of the Docker repo admin you can resolve this building your own images.</p>

<ul>
<li><h2>Support other architectures</h2></li>
</ul>


<p>Docker images are generally built for <a href="https://en.wikipedia.org/wiki/X86-64">AMD64 architecture</a>. If you want to use other architectures - <a href="https://en.wikipedia.org/wiki/ARM_architecture">ARM</a>, <a href="https://en.wikipedia.org/wiki/Power.org#Power_Architecture">Power</a>, <a href="https://en.wikipedia.org/wiki/SPARC">SPARC</a> or even <a href="https://en.wikipedia.org/wiki/Intel_80386">i386</a> - you&rsquo;ll find some images on the Docker hub but these are usually not Official docker images.</p>

<ul>
<li><h2>Control</h2></li>
</ul>


<p>When you build your own images, you have more control over what goes or not goes into the image.</p>

<h1>Building your own docker base images</h1>

<p>There are several ways to build your own docker images.</p>

<p>The <a href="https://mobyproject.org/">Mobyproject</a> is Docker&rsquo;s development project - a bit like what Fedora is to RedHat -.
The Moby project has a few scripts that help you to create docker base images and is also a good start if you want to review how to build your own images.</p>

<h1>GNU/Linux distributions</h1>

<p>I build the images on the same GNU/Linux distribution (e.g. The debian images are build on a Debian system) to get the correct gpg keys.</p>

<h2>Debian GNU/Linux &amp; Co</h2>

<p>Debian GNU/Linux makes it very easy to build your own Docker base images. Only debootstrap is required.
I&rsquo;ll use the moby script to the Debian base image and debootstrap to build an i386 docker Ubuntu 18.04 image.</p>

<p>Ubuntu doesn&rsquo;t support i386 officially but includes the i386 userland so it&rsquo;s possible to build i386 Docker images.</p>

<h3>Clone moby</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@whale:~/github$ git clone https://github.com/moby/moby
</span><span class='line'>Cloning into 'moby'...
</span><span class='line'>remote: Enumerating objects: 265639, done.
</span><span class='line'>remote: Total 265639 (delta 0), reused 0 (delta 0), pack-reused 265640
</span><span class='line'>Receiving objects: 99% (265640/265640), 137.75 MiB | 3.05 MiB/s, done.
</span><span class='line'>Resolving deltas: 99% (179885/179885), done.
</span><span class='line'>Checking out files: 99% (5508/5508), done.
</span><span class='line'>staf@whale:~/github$ </span></code></pre></td></tr></table></div></figure>


<h3>Make sure that debootstrap is installed</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@whale:~/github/moby/contrib$ sudo apt install debootstrap
</span><span class='line'>[sudo] password for staf: 
</span><span class='line'>Reading package lists... Done
</span><span class='line'>Building dependency tree       
</span><span class='line'>Reading state information... Done
</span><span class='line'>debootstrap is already the newest version (1.0.114).
</span><span class='line'>debootstrap set to manually installed.
</span><span class='line'>0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
</span><span class='line'>staf@whale:~/github/moby/contrib$ </span></code></pre></td></tr></table></div></figure>


<h3>The Moby way</h3>

<h4>Go to the contrib directory</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@whale:~/github$ cd moby/contrib/
</span><span class='line'>staf@whale:~/github/moby/contrib$ </span></code></pre></td></tr></table></div></figure>


<h4>mkimage.sh</h4>

<p> <code>mkimage.sh --help</code> gives you more details howto use the script.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@whale:~/github/moby/contrib$ ./mkimage.sh --help
</span><span class='line'>usage: mkimage.sh [-d dir] [-t tag] [--compression algo| --no-compression] script [script-args]
</span><span class='line'>   ie: mkimage.sh -t someuser/debian debootstrap --variant=minbase jessie
</span><span class='line'>       mkimage.sh -t someuser/ubuntu debootstrap --include=ubuntu-minimal --components=main,universe trusty
</span><span class='line'>       mkimage.sh -t someuser/busybox busybox-static
</span><span class='line'>       mkimage.sh -t someuser/centos:5 rinse --distribution centos-5
</span><span class='line'>       mkimage.sh -t someuser/mageia:4 mageia-urpmi --version=4
</span><span class='line'>       mkimage.sh -t someuser/mageia:4 mageia-urpmi --version=4 --mirror=http://somemirror/
</span><span class='line'>staf@whale:~/github/moby/contrib$ </span></code></pre></td></tr></table></div></figure>


<h4>build the image</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@whale:~/github/moby/contrib$ sudo ./mkimage.sh -t stafwag/debian_i386:stretch debootstrap --variant=minbase stretch
</span><span class='line'>[sudo] password for staf: 
</span><span class='line'>+ mkdir -p /var/tmp/docker-mkimage.dY9y9apEoK/rootfs
</span><span class='line'>+ debootstrap --variant=minbase stretch /var/tmp/docker-mkimage.dY9y9apEoK/rootfs
</span><span class='line'>I: Target architecture can be executed
</span><span class='line'>I: Retrieving InRelease 
</span><span class='line'>I: Retrieving Release 
</span><span class='line'>I: Retrieving Release.gpg 
</span><span class='line'>I: Checking Release signature
</span><span class='line'>I: Valid Release signature (key id 067E3C456BAE240ACEE88F6FEF0F382A1A7B6500)
</span><span class='line'>I: Retrieving Packages 
</span><span class='line'>&lt;snip&gt;</span></code></pre></td></tr></table></div></figure>


<h4>Test</h4>

<p>Verify that images is imported.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@whale:~/github/moby/contrib$ docker images
</span><span class='line'>REPOSITORY            TAG                 IMAGE ID            CREATED              SIZE
</span><span class='line'>stafwag/debian_i386   stretch             cb96d1663079        About a minute ago   97.6MB
</span><span class='line'>staf@whale:~/github/moby/contrib$ </span></code></pre></td></tr></table></div></figure>


<p>Run a test docker instance</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@whale:~/github/moby/contrib$ docker run -t -i --rm stafwag/debian_i386:stretch /bin/sh
</span><span class='line'># cat /etc/debian_version 
</span><span class='line'>9.8
</span><span class='line'># </span></code></pre></td></tr></table></div></figure>


<h3>The debootstrap way</h3>

<h4>Make sure that debootstrap is installed</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@ubuntu184:~/github/moby$ sudo apt install debootstrap
</span><span class='line'>Reading package lists... Done
</span><span class='line'>Building dependency tree       
</span><span class='line'>Reading state information... Done
</span><span class='line'>Suggested packages:
</span><span class='line'>  ubuntu-archive-keyring
</span><span class='line'>The following NEW packages will be installed:
</span><span class='line'>  debootstrap
</span><span class='line'>0 upgraded, 1 newly installed, 0 to remove and 0 not upgraded.
</span><span class='line'>Need to get 35,7 kB of archives.
</span><span class='line'>After this operation, 270 kB of additional disk space will be used.
</span><span class='line'>Get:1 http://be.archive.ubuntu.com/ubuntu bionic-updates/main amd64 debootstrap all 1.0.95ubuntu0.3 [35,7 kB]
</span><span class='line'>Fetched 35,7 kB in 0s (85,9 kB/s)    
</span><span class='line'>Selecting previously unselected package debootstrap.
</span><span class='line'>(Reading database ... 163561 files and directories currently installed.)
</span><span class='line'>Preparing to unpack .../debootstrap_1.0.95ubuntu0.3_all.deb ...
</span><span class='line'>Unpacking debootstrap (1.0.95ubuntu0.3) ...
</span><span class='line'>Processing triggers for man-db (2.8.3-2ubuntu0.1) ...
</span><span class='line'>Setting up debootstrap (1.0.95ubuntu0.3) ...
</span><span class='line'>staf@ubuntu184:~/github/moby$ </span></code></pre></td></tr></table></div></figure>


<h4>bootsrap</h4>

<p>Create a directory that will hold the chrooted operating system.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@ubuntu184:~$ mkdir -p dockerbuild/ubuntu
</span><span class='line'>staf@ubuntu184:~/dockerbuild/ubuntu$ </span></code></pre></td></tr></table></div></figure>


<p>Bootstrap.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@ubuntu184:~/dockerbuild/ubuntu$ sudo debootstrap --verbose --include=iputils-ping --arch i386 bionic ./chroot-bionic http://ftp.ubuntu.com/ubuntu/
</span><span class='line'>I: Retrieving InRelease 
</span><span class='line'>I: Checking Release signature
</span><span class='line'>I: Valid Release signature (key id 790BC7277767219C42C86F933B4FE6ACC0B21F32)
</span><span class='line'>I: Validating Packages 
</span><span class='line'>I: Resolving dependencies of required packages...
</span><span class='line'>I: Resolving dependencies of base packages...
</span><span class='line'>I: Checking component main on http://ftp.ubuntu.com/ubuntu...
</span><span class='line'>I: Retrieving adduser 3.116ubuntu1
</span><span class='line'>I: Validating adduser 3.116ubuntu1
</span><span class='line'>I: Retrieving apt 1.6.1
</span><span class='line'>I: Validating apt 1.6.1
</span><span class='line'>I: Retrieving apt-utils 1.6.1
</span><span class='line'>I: Validating apt-utils 1.6.1
</span><span class='line'>I: Retrieving base-files 10.1ubuntu2
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>I: Configuring python3-yaml...
</span><span class='line'>I: Configuring python3-dbus...
</span><span class='line'>I: Configuring apt-utils...
</span><span class='line'>I: Configuring netplan.io...
</span><span class='line'>I: Configuring nplan...
</span><span class='line'>I: Configuring networkd-dispatcher...
</span><span class='line'>I: Configuring kbd...
</span><span class='line'>I: Configuring console-setup-linux...
</span><span class='line'>I: Configuring console-setup...
</span><span class='line'>I: Configuring ubuntu-minimal...
</span><span class='line'>I: Configuring libc-bin...
</span><span class='line'>I: Configuring systemd...
</span><span class='line'>I: Configuring ca-certificates...
</span><span class='line'>I: Configuring initramfs-tools...
</span><span class='line'>I: Base system installed successfully.</span></code></pre></td></tr></table></div></figure>


<h4>Customize</h4>

<p>You can customize your installation before it goes into the image. One thing that you should customize is include update in the image.</p>

<p>Update <code>/etc/resolve.conf</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@ubuntu184:~/dockerbuild/ubuntu$ sudo vi chroot-bionic/etc/resolv.conf</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>nameserver 9.9.9.9</span></code></pre></td></tr></table></div></figure>


<p>Update <code>/etc/apt/sources.list</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@ubuntu184:~/dockerbuild/ubuntu$ sudo vi chroot-bionic/etc/apt/sources.list</span></code></pre></td></tr></table></div></figure>


<p>And include the updates</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>deb http://ftp.ubuntu.com/ubuntu bionic main
</span><span class='line'>deb http://security.ubuntu.com/ubuntu bionic-security main
</span><span class='line'>deb http://ftp.ubuntu.com/ubuntu/ bionic-updates main</span></code></pre></td></tr></table></div></figure>


<p>Chroot into your installation and run <code>apt-get update</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@ubuntu184:~/dockerbuild/ubuntu$ sudo chroot $PWD/chroot-bionic
</span><span class='line'>root@ubuntu184:/# apt update
</span><span class='line'>Hit:1 http://ftp.ubuntu.com/ubuntu bionic InRelease
</span><span class='line'>Get:2 http://ftp.ubuntu.com/ubuntu bionic-updates InRelease [88.7 kB]   
</span><span class='line'>Get:3 http://security.ubuntu.com/ubuntu bionic-security InRelease [88.7 kB]       
</span><span class='line'>Get:4 http://ftp.ubuntu.com/ubuntu bionic/main Translation-en [516 kB]                  
</span><span class='line'>Get:5 http://ftp.ubuntu.com/ubuntu bionic-updates/main i386 Packages [492 kB]           
</span><span class='line'>Get:6 http://ftp.ubuntu.com/ubuntu bionic-updates/main Translation-en [214 kB]          
</span><span class='line'>Get:7 http://security.ubuntu.com/ubuntu bionic-security/main i386 Packages [241 kB]     
</span><span class='line'>Get:8 http://security.ubuntu.com/ubuntu bionic-security/main Translation-en [115 kB]
</span><span class='line'>Fetched 1755 kB in 1s (1589 kB/s)      
</span><span class='line'>Reading package lists... Done
</span><span class='line'>Building dependency tree... Done</span></code></pre></td></tr></table></div></figure>


<p>and <code>apt-get upgrade</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@ubuntu184:/# apt upgrade
</span><span class='line'>Reading package lists... Done
</span><span class='line'>Building dependency tree... Done
</span><span class='line'>Calculating upgrade... Done
</span><span class='line'>The following NEW packages will be installed:
</span><span class='line'>  python3-netifaces
</span><span class='line'>The following packages will be upgraded:
</span><span class='line'>  apt apt-utils base-files bsdutils busybox-initramfs console-setup console-setup-linux
</span><span class='line'>  distro-info-data dpkg e2fsprogs fdisk file gcc-8-base gpgv initramfs-tools
</span><span class='line'>  initramfs-tools-bin initramfs-tools-core keyboard-configuration kmod libapparmor1
</span><span class='line'>  libapt-inst2.0 libapt-pkg5.0 libblkid1 libcom-err2 libcryptsetup12 libdns-export1100
</span><span class='line'>  libext2fs2 libfdisk1 libgcc1 libgcrypt20 libglib2.0-0 libglib2.0-data libidn11
</span><span class='line'>  libisc-export169 libkmod2 libmagic-mgc libmagic1 libmount1 libncurses5 libncursesw5
</span><span class='line'>  libnss-systemd libpam-modules libpam-modules-bin libpam-runtime libpam-systemd
</span><span class='line'>  libpam0g libprocps6 libpython3-stdlib libpython3.6-minimal libpython3.6-stdlib
</span><span class='line'>  libseccomp2 libsmartcols1 libss2 libssl1.1 libstdc++6 libsystemd0 libtinfo5 libudev1
</span><span class='line'>  libunistring2 libuuid1 libxml2 mount ncurses-base ncurses-bin netcat-openbsd
</span><span class='line'>  netplan.io networkd-dispatcher nplan openssl perl-base procps python3 python3-gi
</span><span class='line'>  python3-minimal python3.6 python3.6-minimal systemd systemd-sysv tar tzdata
</span><span class='line'>  ubuntu-keyring ubuntu-minimal udev util-linux
</span><span class='line'>84 upgraded, 1 newly installed, 0 to remove and 0 not upgraded.
</span><span class='line'>Need to get 26.6 MB of archives.
</span><span class='line'>After this operation, 450 kB of additional disk space will be used.
</span><span class='line'>Do you want to continue? [Y/n] y
</span><span class='line'>Get:1 http://security.ubuntu.com/ubuntu bionic-security/main i386 netplan.io i386 0.40.1~18.04.4 [64.6 kB]
</span><span class='line'>Get:2 http://ftp.ubuntu.com/ubuntu bionic-updates/main i386 base-files i386 10.1ubuntu2.4 [60.3 kB]
</span><span class='line'>Get:3 http://security.ubuntu.com/ubuntu bionic-security/main i386 libapparmor1 i386 2.12-4ubuntu5.1 [32.7 kB]
</span><span class='line'>Get:4 http://security.ubuntu.com/ubuntu bionic-security/main i386 libgcrypt20 i386 1.8.1-
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>running python rtupdate hooks for python3.6...
</span><span class='line'>running python post-rtupdate hooks for python3.6...
</span><span class='line'>Setting up initramfs-tools-core (0.130ubuntu3.7) ...
</span><span class='line'>Setting up initramfs-tools (0.130ubuntu3.7) ...
</span><span class='line'>update-initramfs: deferring update (trigger activated)
</span><span class='line'>Setting up python3-gi (3.26.1-2ubuntu1) ...
</span><span class='line'>Setting up file (1:5.32-2ubuntu0.2) ...
</span><span class='line'>Setting up python3-netifaces (0.10.4-0.1build4) ...
</span><span class='line'>Processing triggers for systemd (237-3ubuntu10.20) ...
</span><span class='line'>Setting up networkd-dispatcher (1.7-0ubuntu3.3) ...
</span><span class='line'>Installing new version of config file /etc/default/networkd-dispatcher ...
</span><span class='line'>Setting up netplan.io (0.40.1~18.04.4) ...
</span><span class='line'>Setting up nplan (0.40.1~18.04.4) ...
</span><span class='line'>Setting up ubuntu-minimal (1.417.1) ...
</span><span class='line'>Processing triggers for libc-bin (2.27-3ubuntu1) ...
</span><span class='line'>Processing triggers for initramfs-tools (0.130ubuntu3.7) ...
</span><span class='line'>root@ubuntu184:/# 
</span><span class='line'>staf@ubuntu184:~/dockerbuild/ubuntu$ </span></code></pre></td></tr></table></div></figure>


<h4>Import</h4>

<p>Go to your chroot installation.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@ubuntu184:~/dockerbuild/ubuntu$ cd chroot-bionic/
</span><span class='line'>staf@ubuntu184:~/dockerbuild/ubuntu/chroot-bionic$ </span></code></pre></td></tr></table></div></figure>


<p>and import the image.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@ubuntu184:~/dockerbuild/ubuntu/chroot-bionic$ sudo tar cpf - . | docker import - stafwag/ubuntu_i386:bionic
</span><span class='line'>sha256:83560ef3c8d48b737983ab8ffa3ec3836b1239664f8998038bfe1b06772bb3c2
</span><span class='line'>staf@ubuntu184:~/dockerbuild/ubuntu/chroot-bionic$ </span></code></pre></td></tr></table></div></figure>


<h4>Test</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@ubuntu184:~/dockerbuild/ubuntu/chroot-bionic$ docker images
</span><span class='line'>REPOSITORY            TAG                 IMAGE ID            CREATED              SIZE
</span><span class='line'>stafwag/ubuntu_i386   bionic              83560ef3c8d4        About a minute ago   315MB
</span><span class='line'>staf@ubuntu184:~/dockerbuild/ubuntu/chroot-bionic$ </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@ubuntu184:~/dockerbuild/ubuntu/chroot-bionic$ docker run -it --rm stafwag/ubuntu_i386:bionic /bin/bash
</span><span class='line'>root@665cec6ee24f:/# lsb_release -a
</span><span class='line'>No LSB modules are available.
</span><span class='line'>Distributor ID: Ubuntu
</span><span class='line'>Description:    Ubuntu 18.04.2 LTS
</span><span class='line'>Release:        18.04
</span><span class='line'>Codename:       bionic
</span><span class='line'>root@665cec6ee24f:/# </span></code></pre></td></tr></table></div></figure>


<p><strong><em> Have fun! </em></strong></p>

<h1>Links</h1>

<ul>
<li><a href="https://docs.docker.com/docker-hub/official_images/">https://docs.docker.com/docker-hub/official_images/</a></li>
<li><a href="https://docs.docker.com/engine/security/trust/content_trust/">https://docs.docker.com/engine/security/trust/content_trust/</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Howto Use Centos Cloud Images With Cloud-init on KVM/libvirtd]]></title>
    <link href="https://stafwag.github.io/blog/blog/2019/03/03/howto-use-centos-cloud-images-with-cloud-init/"/>
    <updated>2019-03-03T09:55:55+01:00</updated>
    <id>https://stafwag.github.io/blog/blog/2019/03/03/howto-use-centos-cloud-images-with-cloud-init</id>
    <content type="html"><![CDATA[<h1>Images versus unattended setup</h1>

<h2>Old-school</h2>

<h3>Unattended setup</h3>

<p>In a traditional environment, systems are installed from a CDROM. The configuration is executed by the system administrator through the installer. This soon becomes a borning and unpractical task when we need to set up a lot of systems also it is important  that systems are configured in same - and hopefully correct - way.</p>

<p>In a traditional environment, this can be automated by booting via BOOTP/PXE boot and configured is by a system that &ldquo;feeds&rdquo; the installer. Examples are:</p>

<ul>
<li><a href="https://en.wikipedia.org/wiki/JumpStart_(Solaris">Solaris Jumpstart</a></li>
<li><a href="https://en.wikipedia.org/wiki/Kickstart_(Linux">Redhat Kickstart</a>)</li>
<li><a href="https://wiki.debian.org/DebianInstaller/Preseed">DebianInstaller Preseed</a></li>
<li><a href="https://en.wikipedia.org/wiki/YaST#AutoYaST">Suse Autoyast</a></li>
<li>&hellip;</li>
</ul>


<h2>Cloud &amp; co</h2>

<h3>Cloud-init</h3>

<p>In a cloud environment, we use images to install systems. The system automation is generally done by <a href="https://cloud-init.io/">cloud-init</a>. Cloud-init was originally developed for Ubuntu GNU/Linux on the Amazon EC2 cloud. It has become the de facto installation configuration tool for most Unix like systems on most cloud environments.</p>

<p>Cloud-init uses a YAML file to configure the system.</p>

<h3>Images</h3>

<p>Most GNU/Linux distributions provide images that can be used to provision a new system.
You can find the complete list on the OpenStack website</p>

<p><a href="https://docs.openstack.org/image-guide/obtain-images.html">https://docs.openstack.org/image-guide/obtain-images.html</a></p>

<p>The OpenStack documentation also describes how you can create your own base images in the <a href="https://docs.openstack.org/image-guide/">OpenStack Virtual Machine Image Guide</a></p>

<h1>Use a centos cloud image with libvirtd</h1>

<h2>Download the cloud image</h2>

<h3>Download</h3>

<p>Download the latest &ldquo;GenericCloud&rdquo; centos 7 cloud image and sha256sum.txt.asc sha256sum.txt from:</p>

<p><a href="https://cloud.centos.org/centos/7/images/">https://cloud.centos.org/centos/7/images/</a></p>

<h3>Verify</h3>

<p>You should verify your download - as always against a trusted signing key -</p>

<p>On a centos 7 system, the public gpg is already installed at <code>/etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7</code></p>

<h4>Verify the fingerprint</h4>

<p>Execute</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@centos7 iso]$ gpg --with-fingerprint /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7
</span><span class='line'>pub  4096R/F4A80EB5 2014-06-23 CentOS-7 Key (CentOS 7 Official Signing Key) &lt;security@centos.org&gt;
</span><span class='line'>      Key fingerprint = 6341 AB27 53D7 8A78 A7C2  7BB1 24C6 A8A7 F4A8 0EB5
</span><span class='line'>[staf@centos7 iso]$ gpg --with-fingerprint /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7</span></code></pre></td></tr></table></div></figure>


<p>and verify the fingerprint, the fingerprints that are used by centos are listed at:</p>

<p><a href="https://www.centos.org/keys/">https://www.centos.org/keys/</a></p>

<h4>Import key</h4>

<p>Import the pub centos gpg key:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@centos7 iso]$ gpg --import /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7
</span><span class='line'>gpg: key F4A80EB5: public key "CentOS-7 Key (CentOS 7 Official Signing Key) &lt;security@centos.org&gt;" imported
</span><span class='line'>gpg: Total number processed: 1
</span><span class='line'>gpg:               imported: 1  (RSA: 1)
</span><span class='line'>[staf@centos7 iso]$ </span></code></pre></td></tr></table></div></figure>


<p>List the trusted gpg key:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@centos7 iso]$ gpg --list-keys
</span><span class='line'>/home/staf/.gnupg/pubring.gpg
</span><span class='line'>-----------------------------
</span><span class='line'>pub   4096R/F4A80EB5 2014-06-23
</span><span class='line'>uid                  CentOS-7 Key (CentOS 7 Official Signing Key) &lt;security@centos.org&gt;
</span><span class='line'>
</span><span class='line'>[staf@centos7 iso]$ gpg --list-keys
</span></code></pre></td></tr></table></div></figure>


<h4>Verify the sha256sum file</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@centos7 iso]$ gpg --verify sha256sum.txt.asc
</span><span class='line'>gpg: Signature made Thu 31 Jan 2019 04:28:30 PM CET using RSA key ID F4A80EB5
</span><span class='line'>gpg: Good signature from "CentOS-7 Key (CentOS 7 Official Signing Key) &lt;security@centos.org&gt;"
</span><span class='line'>gpg: WARNING: This key is not certified with a trusted signature!
</span><span class='line'>gpg:          There is no indication that the signature belongs to the owner.
</span><span class='line'>Primary key fingerprint: 6341 AB27 53D7 8A78 A7C2  7BB1 24C6 A8A7 F4A8 0EB5
</span><span class='line'>[staf@centos7 iso]$ </span></code></pre></td></tr></table></div></figure>


<p>The key fingerprint must match the one of RPM-GPG-KEY-CentOS-7.</p>

<h4>Verify the iso file</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@centos7 iso]$ xz -d CentOS-7-x86_64-GenericCloud-1901.qcow2.xz
</span><span class='line'>[staf@centos7 iso]$ sha256sum -c sha256sum.txt.asc 2&gt;&1 | grep OK
</span><span class='line'>CentOS-7-x86_64-GenericCloud-1901.qcow2: OK
</span><span class='line'>[staf@centos7 iso]$ </span></code></pre></td></tr></table></div></figure>


<h2>Image</h2>

<h3>info</h3>

<p>The image we download is a normal qcow2 image, we can see the image information with <code>qemu-info</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@centos7 iso]# qemu-img info CentOS-7-x86_64-GenericCloud-1901.qcow2
</span><span class='line'>image: CentOS-7-x86_64-GenericCloud-1901.qcow2
</span><span class='line'>file format: qcow2
</span><span class='line'>virtual size: 8.0G (8589934592 bytes)
</span><span class='line'>disk size: 895M
</span><span class='line'>cluster_size: 65536
</span><span class='line'>Format specific information:
</span><span class='line'>    compat: 0.10
</span><span class='line'>[root@centos7 iso]# </span></code></pre></td></tr></table></div></figure>


<h3>Copy &amp; resize</h3>

<p>The default image is small - 8GB - we might be using the image to provision other systems so it better to leave it untouched.</p>

<p>Copy the image to the location where we&rsquo;ll run the virtual system.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@centos7 iso]# cp -v CentOS-7-x86_64-GenericCloud-1901.qcow2 /var/lib/libvirt/images/tst/tst.qcow2
</span><span class='line'>'CentOS-7-x86_64-GenericCloud-1901.qcow2' -&gt; '/var/lib/libvirt/images/tst/tst.qcow2'
</span><span class='line'>[root@centos7 iso]# </span></code></pre></td></tr></table></div></figure>


<p>and resize it to the required size:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@centos7 iso]# cd /var/lib/libvirt/images/tst
</span><span class='line'>[root@centos7 tst]# qemu-img resize tst.qcow2 20G
</span><span class='line'>Image resized.
</span><span class='line'>[root@centos7 tst]# </span></code></pre></td></tr></table></div></figure>


<h2>cloud-init</h2>

<p>We&rsquo;ll create a simple cloud-init configuration file and generate an iso image with <code>cloud-localds</code>. This iso image holds the cloud-init configuration and will be used to setup the system during the bootstrap.</p>

<h3>Install cloud-utils</h3>

<p><span style="color:red"><strong> It&rsquo;s important to NOT install cloud-init on your KVM host machine. </strong></span> This creates a cloud-init service that runs during the boot and tries to reconfigure your host. Something that you probably don&rsquo;t want on your KVM hypervisor host.</p>

<p>The cloud-util package has all the tool we need to convert the cloud-init configuration files to an iso image.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@centos7 tst]# yum install -y cloud-utils
</span><span class='line'>Loaded plugins: fastestmirror, langpacks
</span><span class='line'>Loading mirror speeds from cached hostfile
</span><span class='line'> * base: centos.cu.be
</span><span class='line'> * extras: centos.cu.be
</span><span class='line'> * updates: centos.mirror.ate.info
</span><span class='line'>Resolving Dependencies
</span><span class='line'>--&gt; Running transaction check
</span><span class='line'>---&gt; Package cloud-utils.x86_64 0:0.27-20.el7.centos will be installed
</span><span class='line'>--&gt; Processing Dependency: python-paramiko for package: cloud-utils-0.27-20.el7.centos.x86_64
</span><span class='line'>--&gt; Processing Dependency: euca2ools for package: cloud-utils-0.27-20.el7.centos.x86_64
</span><span class='line'>--&gt; Processing Dependency: cloud-utils-growpart for package: cloud-utils-0.27-20.el7.centos.x86_64
</span><span class='line'>--&gt; Running transaction check
</span><span class='line'>---&gt; Package cloud-utils-growpart.noarch 0:0.29-2.el7 will be installed
</span><span class='line'>---&gt; Package euca2ools.noarch 0:2.1.4-1.el7.centos will be installed
</span><span class='line'>--&gt; Processing Dependency: python-boto &gt;= 2.13.3-1 for package: euca2ools-2.1.4-1.el7.centos.noarch
</span><span class='line'>--&gt; Processing Dependency: m2crypto for package: euca2ools-2.1.4-1.el7.centos.noarch
</span><span class='line'>---&gt; Package python-paramiko.noarch 0:2.1.1-9.el7 will be installed
</span><span class='line'>--&gt; Running transaction check
</span><span class='line'>---&gt; Package m2crypto.x86_64 0:0.21.1-17.el7 will be installed
</span><span class='line'>---&gt; Package python-boto.noarch 0:2.25.0-2.el7.centos will be installed
</span><span class='line'>--&gt; Finished Dependency Resolution
</span><span class='line'>
</span><span class='line'>Dependencies Resolved
</span><span class='line'>
</span><span class='line'>=======================================================================================
</span><span class='line'> Package                    Arch         Version                   Repository     Size
</span><span class='line'>=======================================================================================
</span><span class='line'>Installing:
</span><span class='line'> cloud-utils                x86_64       0.27-20.el7.centos        extras         43 k
</span><span class='line'>Installing for dependencies:
</span><span class='line'> cloud-utils-growpart       noarch       0.29-2.el7                base           26 k
</span><span class='line'> euca2ools                  noarch       2.1.4-1.el7.centos        extras        319 k
</span><span class='line'> m2crypto                   x86_64       0.21.1-17.el7             base          429 k
</span><span class='line'> python-boto                noarch       2.25.0-2.el7.centos       extras        1.5 M
</span><span class='line'> python-paramiko            noarch       2.1.1-9.el7               updates       269 k
</span><span class='line'>
</span><span class='line'>Transaction Summary
</span><span class='line'>=======================================================================================
</span><span class='line'>Install  1 Package (+5 Dependent packages)
</span><span class='line'>
</span><span class='line'>Total download size: 2.5 M
</span><span class='line'>Installed size: 12 M
</span><span class='line'>Downloading packages:
</span><span class='line'>(1/6): cloud-utils-growpart-0.29-2.el7.noarch.rpm               |  26 kB  00:00:01     
</span><span class='line'>(2/6): cloud-utils-0.27-20.el7.centos.x86_64.rpm                |  43 kB  00:00:01     
</span><span class='line'>(3/6): euca2ools-2.1.4-1.el7.centos.noarch.rpm                  | 319 kB  00:00:01     
</span><span class='line'>(4/6): m2crypto-0.21.1-17.el7.x86_64.rpm                        | 429 kB  00:00:01     
</span><span class='line'>(5/6): python-boto-2.25.0-2.el7.centos.noarch.rpm               | 1.5 MB  00:00:02     
</span><span class='line'>(6/6): python-paramiko-2.1.1-9.el7.noarch.rpm                   | 269 kB  00:00:03     
</span><span class='line'>---------------------------------------------------------------------------------------
</span><span class='line'>Total                                                     495 kB/s | 2.5 MB  00:05     
</span><span class='line'>Running transaction check
</span><span class='line'>Running transaction test
</span><span class='line'>Transaction test succeeded
</span><span class='line'>Running transaction
</span><span class='line'>  Installing : python-boto-2.25.0-2.el7.centos.noarch                              1/6 
</span><span class='line'>  Installing : python-paramiko-2.1.1-9.el7.noarch                                  2/6 
</span><span class='line'>  Installing : cloud-utils-growpart-0.29-2.el7.noarch                              3/6 
</span><span class='line'>  Installing : m2crypto-0.21.1-17.el7.x86_64                                       4/6 
</span><span class='line'>  Installing : euca2ools-2.1.4-1.el7.centos.noarch                                 5/6 
</span><span class='line'>  Installing : cloud-utils-0.27-20.el7.centos.x86_64                               6/6 
</span><span class='line'>  Verifying  : m2crypto-0.21.1-17.el7.x86_64                                       1/6 
</span><span class='line'>  Verifying  : cloud-utils-growpart-0.29-2.el7.noarch                              2/6 
</span><span class='line'>  Verifying  : python-paramiko-2.1.1-9.el7.noarch                                  3/6 
</span><span class='line'>  Verifying  : python-boto-2.25.0-2.el7.centos.noarch                              4/6 
</span><span class='line'>  Verifying  : euca2ools-2.1.4-1.el7.centos.noarch                                 5/6 
</span><span class='line'>  Verifying  : cloud-utils-0.27-20.el7.centos.x86_64                               6/6 
</span><span class='line'>
</span><span class='line'>Installed:
</span><span class='line'>  cloud-utils.x86_64 0:0.27-20.el7.centos                                                                                                                                     
</span><span class='line'>
</span><span class='line'>Dependency Installed:
</span><span class='line'>  cloud-utils-growpart.noarch 0:0.29-2.el7      euca2ools.noarch 0:2.1.4-1.el7.centos      m2crypto.x86_64 0:0.21.1-17.el7      python-boto.noarch 0:2.25.0-2.el7.centos     
</span><span class='line'>  python-paramiko.noarch 0:2.1.1-9.el7         
</span><span class='line'>
</span><span class='line'>Complete!
</span><span class='line'>[root@centos7 tst]# </span></code></pre></td></tr></table></div></figure>


<h3>Cloud-init configuration</h3>

<p>A complete overview of cloud-init configuration directives is available at <a href="https://cloudinit.readthedocs.io/en/latest/">https://cloudinit.readthedocs.io/en/latest/</a>.</p>

<p>We&rsquo;ll create a cloud-init configuration file to update all the packages - which is always a good idea - and to add a user to the system.</p>

<p>A cloud-init configuration file has to start with <code>#cloud-config</code>, remember this is YAML so only use spaces&hellip;</p>

<p>We&rsquo;ll create a password hash that we&rsquo;ll put into your cloud-init configuration, it&rsquo;s also possible to use a plain-text password in the configuration with <code>chpasswd</code> or to set the password for the default user. But it&rsquo;s better to use a hash so nobody can see the password. Keep in mind that is still possible to brute-force the password hash.</p>

<p>Some GNU/Linux distributions have the <code>mkpasswd</code> utility this is not available on centos. The <code>mkpasswd</code> utility is part of the <code>expect</code> package and is something else&hellip;</p>

<p>I used a python one-liner to generate the SHA512 password hash</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>python -c 'import crypt,getpass; print(crypt.crypt(getpass.getpass(), crypt.mksalt(crypt.METHOD_SHA512)))'</span></code></pre></td></tr></table></div></figure>


<p>Execute the one-liner and type in your password:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@centos7 ~]$ python -c 'import crypt,getpass; print(crypt.crypt(getpass.getpass(), crypt.mksalt(crypt.METHOD_SHA512)))'
</span><span class='line'>Password: 
</span><span class='line'>&lt;your hash&gt;
</span><span class='line'>[staf@centos7 ~]$ </span></code></pre></td></tr></table></div></figure>


<p>Create config.yaml - replace <code>&lt;your_user&gt;</code>, <code>&lt;your_hash&gt;</code>, <code>&lt;your_ssh_pub_key&gt;</code> -  with your data:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#cloud-config
</span><span class='line'>package_upgrade: true
</span><span class='line'>users:
</span><span class='line'>  - name: &lt;your_user&gt;
</span><span class='line'>    groups: wheel
</span><span class='line'>    lock_passwd: false
</span><span class='line'>    passwd: &lt;your_passord_hash&gt;
</span><span class='line'>    shell: /bin/bash
</span><span class='line'>    sudo: ['ALL=(ALL) NOPASSWD:ALL']
</span><span class='line'>    ssh-authorized-keys:
</span><span class='line'>      - &lt;your_public_ssh_key&gt;</span></code></pre></td></tr></table></div></figure>


<p>And generate the configuration iso image:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@centos7 tst]# cloud-localds config.iso config.yaml
</span><span class='line'>wrote config.iso with filesystem=iso9660 and diskformat=raw
</span><span class='line'>[root@centos7 tst]# </span></code></pre></td></tr></table></div></figure>


<h3>Create the virtual system</h3>

<p>Libvirt has predefined definitions for operating systems. You can query the predefined operation systems with the <code>osinfo-query os</code> command.</p>

<p>We use centos 7, we use <code>osinfo-query os</code> to find the correct definition.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@centos7 tst]# osinfo-query  os | grep -i centos7
</span><span class='line'> centos7.0            | CentOS 7.0                                         | 7.0      | http://centos.org/centos/7.0            
</span><span class='line'>[root@centos7 tst]# </span></code></pre></td></tr></table></div></figure>


<p>Create the virtual system:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>virt-install \
</span><span class='line'>  --memory 2048 \
</span><span class='line'>  --vcpus 2 \
</span><span class='line'>  --name tst \
</span><span class='line'>  --disk /var/lib/libvirt/images/tst/tst.qcow2,device=disk \
</span><span class='line'>  --disk /var/lib/libvirt/images/tst/config.iso,device=cdrom \
</span><span class='line'>  --os-type Linux \
</span><span class='line'>  --os-variant centos7.0 \
</span><span class='line'>  --virt-type kvm \
</span><span class='line'>  --graphics none \
</span><span class='line'>  --network default \
</span><span class='line'>  --import</span></code></pre></td></tr></table></div></figure>


<p>The default escape key - to get out the console is ^[  ( Ctrl + [ )</p>

<p><strong><em> Have fun! </em></strong></p>

<h1>Links</h1>

<ul>
<li><a href="https://wiki.centos.org/Download/Verify">https://wiki.centos.org/Download/Verify</a></li>
<li><a href="https://www.theurbanpenguin.com/using-cloud-images-in-kvm/">https://www.theurbanpenguin.com/using-cloud-images-in-kvm/</a></li>
<li><a href="https://docs.openstack.org/image-guide/">https://docs.openstack.org/image-guide/</a></li>
<li><a href="https://unix.stackexchange.com/questions/52108/how-to-create-sha512-password-hashes-on-command-line#76337">https://unix.stackexchange.com/questions/52108/how-to-create-sha512-password-hashes-on-command-line#76337</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How to Install Libreboot on a ThinkPad W500]]></title>
    <link href="https://stafwag.github.io/blog/blog/2019/02/10/how-to-install-libreboot-on-a-thinkspad-w500/"/>
    <updated>2019-02-10T17:49:46+01:00</updated>
    <id>https://stafwag.github.io/blog/blog/2019/02/10/how-to-install-libreboot-on-a-thinkspad-w500</id>
    <content type="html"><![CDATA[<p><a href="https://stafwag.github.io/blog/images/libreboot_w500_with_pi.jpg"><img src="https://stafwag.github.io/blog/images/libreboot_w500_with_pi.jpg" class="right" width="500" height="333" alt="w500 and pi" /></a></p>

<p>I got a <a href="https://en.wikipedia.org/wiki/ThinkPad_W_series#W500">Lenovo Thinkpad W500</a> from <a href="http://www.2dehands.be">www.2dehands.be</a> for a nice price.</p>

<p>Actually, I got it a couple of months back but I didn&rsquo;t have time to play with it and it took some time to get some parts from <a href="https://www.aliexpress.com">Aliexpress</a>.</p>

<p> The Thinkpad W500 is probably the most powerful system that is compatible with <a href="https://www.libreboot.org">Libreboot</a>, it has a nice high-resolution display with a 1920 x 1200 resolution which is even a higher screen resolution than the <a href="https://en.wikipedia.org/wiki/1080p">Full HD resolution</a> used on most new laptops today.</p>

<h1>Security</h1>

<p>Keep in mind that the <a href="https://en.wikipedia.org/wiki/Intel_Core#Core_2_Duo">core duo CPU</a> does not get <a href="https://www.extremetech.com/computing/266884-intel-wont-patch-older-cpus-to-resolve-spectre-flaws">microcode updates from Intel</a> for <a href="https://en.wikipedia.org/wiki/Meltdown_(security_vulnerability">spectre and meltdown</a>. There is no solution (currently) for <a href="https://nvd.nist.gov/vuln/detail/CVE-2018-3640">spectre 3a - Rogue   System Register Read - CVE-2018-3640</a> and <a href="https://nvd.nist.gov/vuln/detail/CVE-2018-3639"> Spectre 4 - Speculative Store Bypass CVE-2018-3639</a> without a microcode update.</p>

<p><a href="https://en.wikipedia.org/wiki/Binary_blob">Binary blobs</a> are bad. Having a closed source binary-only piece of software on your system is not only unacceptable for <a href="https://en.wikipedia.org/wiki/Free_software_movement">Free Software activists</a> it also makes it more difficult to review what it really does and makes it more difficult to review it for security concerns.</p>

<p>Having your system vulnerable is also a bad thing of course. Can&rsquo;t wait to get a computer system with an open CPU architecture like <a href="https://en.wikipedia.org/wiki/RISC-V">RISC-V</a>.</p>

<h1>Preparation</h1>

<h2>Thinkpad</h2>

<h3>MAC address</h3>

<p>Your MAC address is stored in your BIOS since you&rsquo;ll overwite the BIOS with Libreboot we need to have the MAC address. Your MAC address is written on Laptop however I recommend to boot from GNU/Linux and copy/paste it from the <code>ifconfig</code> or the <code>ip a</code> command.</p>

<h3>EC update</h3>

<p>It&rsquo;s recommended to update your current BIOS to get the latest <a href="https://libreboot.org/faq.html#ec-embedded-controller-firmware">EC firmware</a>. My system has a CDROM drive I updated the BIOS with a CDROM.</p>

<h2>Prepare the Raspberry-pi</h2>

<p>It isn&rsquo;t possible to flash the BIOS with software only on a Lenovo W500/T500, it&rsquo;s required to put a clip on your BIOS chip and flash the new BIOS with <a href="https://www.flashrom.org/">flashrom</a>. I used a <a href="https://www.raspberrypi.org/products/raspberry-pi-1-model-b-plus/">Raspberry Pi 1 model B</a> with <a href="https://www.raspberrypi.org/downloads/raspbian/">Raspbian</a> to flash Libreboot .</p>

<h3>Enable the SPI port</h3>

<p>The <a href="https://en.wikipedia.org/wiki/Serial_Peripheral_Interface">SPI port</a> isn&rsquo;t enabled by default on Raspbian, so we&rsquo;ll need to enable it.</p>

<p>Open <code>/boot/config.txt</code> in your favorite text editor.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@raspberrypi:~# cd /boot/
</span><span class='line'>root@raspberrypi:/boot# ls
</span><span class='line'>bcm2708-rpi-0-w.dtb     bcm2710-rpi-3-b.dtb       config.txt     fixup_x.dat       LICENSE.oracle  start_x.elf
</span><span class='line'>bcm2708-rpi-b.dtb       bcm2710-rpi-3-b-plus.dtb  COPYING.linux  issue.txt         overlays
</span><span class='line'>bcm2708-rpi-b-plus.dtb  bcm2710-rpi-cm3.dtb       fixup_cd.dat   kernel7.img       start_cd.elf
</span><span class='line'>bcm2708-rpi-cm.dtb      bootcode.bin              fixup.dat      kernel.img        start_db.elf
</span><span class='line'>bcm2709-rpi-2-b.dtb     cmdline.txt               fixup_db.dat   LICENCE.broadcom  start.elf
</span><span class='line'>root@raspberrypi:/boot# vi config.txt </span></code></pre></td></tr></table></div></figure>


<p>uncomment <code>dtparam=spi=on</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Uncomment some or all of these to enable the optional hardware interfaces
</span><span class='line'>#dtparam=i2c_arm=on
</span><span class='line'>#dtparam=i2s=on
</span><span class='line'>dtparam=spi=on</span></code></pre></td></tr></table></div></figure>


<p>After a  reboot of the raspberry-pi the SPI interface <code>/dev/spidev*</code> will be available.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@raspberrypi:~# ls -l /dev/spidev*
</span><span class='line'>crw-rw---- 1 root spi 153, 0 Jan 26 20:08 /dev/spidev0.0
</span><span class='line'>crw-rw---- 1 root spi 153, 1 Jan 26 20:08 /dev/spidev0.1
</span><span class='line'>root@raspberrypi:~# </span></code></pre></td></tr></table></div></figure>


<h3>Install the required software</h3>

<h4>git</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~ $ sudo apt install git
</span><span class='line'>Reading package lists... Done
</span><span class='line'>Building dependency tree       
</span><span class='line'>Reading state information... Done
</span><span class='line'>The following additional packages will be installed:
</span><span class='line'>  git-man liberror-perl
</span><span class='line'>Suggested packages:
</span><span class='line'>  git-daemon-run | git-daemon-sysvinit git-doc git-el git-email git-gui gitk gitweb git-arch git-cvs
</span><span class='line'>  git-mediawiki git-svn
</span><span class='line'>The following NEW packages will be installed:
</span><span class='line'>  git git-man liberror-perl
</span><span class='line'>0 upgraded, 3 newly installed, 0 to remove and 0 not upgraded.
</span><span class='line'>Need to get 4,849 kB of archives.
</span><span class='line'>After this operation, 26.4 MB of additional disk space will be used.
</span><span class='line'>Do you want to continue? [Y/n] y
</span><span class='line'>Get:1 http://mirror.nl.leaseweb.net/raspbian/raspbian stretch/main armhf liberror-perl all 0.17024-1 [26.9 kB]
</span><span class='line'>Get:2 http://mirror.nl.leaseweb.net/raspbian/raspbian stretch/main armhf git-man all 1:2.11.0-3+deb9u4 [1,433 kB]
</span><span class='line'>Get:3 http://mirror.nl.leaseweb.net/raspbian/raspbian stretch/main armhf git armhf 1:2.11.0-3+deb9u4 [3,390 kB]
</span><span class='line'>Fetched 4,849 kB in 3s (1,517 kB/s)
</span><span class='line'>Selecting previously unselected package liberror-perl.
</span><span class='line'>(Reading database ... 35178 files and directories currently installed.)
</span><span class='line'>Preparing to unpack .../liberror-perl_0.17024-1_all.deb ...
</span><span class='line'>Unpacking liberror-perl (0.17024-1) ...
</span><span class='line'>Selecting previously unselected package git-man.
</span><span class='line'>Preparing to unpack .../git-man_1%3a2.11.0-3+deb9u4_all.deb ...
</span><span class='line'>Unpacking git-man (1:2.11.0-3+deb9u4) ...
</span><span class='line'>Selecting previously unselected package git.
</span><span class='line'>Preparing to unpack .../git_1%3a2.11.0-3+deb9u4_armhf.deb ...
</span><span class='line'>Unpacking git (1:2.11.0-3+deb9u4) ...
</span><span class='line'>Setting up git-man (1:2.11.0-3+deb9u4) ...
</span><span class='line'>Setting up liberror-perl (0.17024-1) ...
</span><span class='line'>Processing triggers for man-db (2.7.6.1-2) ...
</span><span class='line'>Setting up git (1:2.11.0-3+deb9u4) ...
</span><span class='line'>pi@raspberrypi:~ $ </span></code></pre></td></tr></table></div></figure>


<h4>flashrom</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@raspberrypi:~# apt install flashrom
</span><span class='line'>Reading package lists... Done
</span><span class='line'>Building dependency tree       
</span><span class='line'>Reading state information... Done
</span><span class='line'>The following additional packages will be installed:
</span><span class='line'>  libftdi1-2 libpci3
</span><span class='line'>The following NEW packages will be installed:
</span><span class='line'>  flashrom libftdi1-2 libpci3
</span><span class='line'>0 upgraded, 3 newly installed, 0 to remove and 0 not upgraded.
</span><span class='line'>Need to get 454 kB of archives.
</span><span class='line'>After this operation, 843 kB of additional disk space will be used.
</span><span class='line'>Do you want to continue? [Y/n] y
</span><span class='line'>Get:1 http://mirror.nl.leaseweb.net/raspbian/raspbian stretch/main armhf libpci3 armhf 1:3.5.2-1 [50.9 kB]
</span><span class='line'>Get:2 http://mirror.nl.leaseweb.net/raspbian/raspbian stretch/main armhf libftdi1-2 armhf 1.3-2 [26.8 kB]
</span><span class='line'>Get:3 http://mirror.nl.leaseweb.net/raspbian/raspbian stretch/main armhf flashrom armhf 0.9.9+r1954-1 [377 kB]
</span><span class='line'>Fetched 454 kB in 4s (108 kB/s)   
</span><span class='line'>Selecting previously unselected package libpci3:armhf.
</span><span class='line'>(Reading database ... 34656 files and directories currently installed.)
</span><span class='line'>Preparing to unpack .../libpci3_1%3a3.5.2-1_armhf.deb ...
</span><span class='line'>Unpacking libpci3:armhf (1:3.5.2-1) ...
</span><span class='line'>Selecting previously unselected package libftdi1-2:armhf.
</span><span class='line'>Preparing to unpack .../libftdi1-2_1.3-2_armhf.deb ...
</span><span class='line'>Unpacking libftdi1-2:armhf (1.3-2) ...
</span><span class='line'>Selecting previously unselected package flashrom.
</span><span class='line'>Preparing to unpack .../flashrom_0.9.9+r1954-1_armhf.deb ...
</span><span class='line'>Unpacking flashrom (0.9.9+r1954-1) ...
</span><span class='line'>Setting up libftdi1-2:armhf (1.3-2) ...
</span><span class='line'>Processing triggers for libc-bin (2.24-11+deb9u3) ...
</span><span class='line'>Processing triggers for man-db (2.7.6.1-2) ...
</span><span class='line'>Setting up libpci3:armhf (1:3.5.2-1) ...
</span><span class='line'>Setting up flashrom (0.9.9+r1954-1) ...
</span><span class='line'>Processing triggers for libc-bin (2.24-11+deb9u3) ...
</span><span class='line'>root@raspberrypi:~# </span></code></pre></td></tr></table></div></figure>


<h1>Wiring</h1>

<h2>Wire diagram</h2>

<p>It&rsquo;s useful to get correct flash chip specs, I used a magnifying loupe and a photo camera to get my chip type. After searching the internet I found a very nice blog post from <a href="https://p1trson.blogspot.com">p1trson</a> <a href="https://p1trson.blogspot.com/2017/01/journey-to-freedom-part-ii.html">https://p1trson.blogspot.com/2017/01/journey-to-freedom-part-ii.html</a> about flashing Libreboot on a Thinkpad T400 with the same Flash chip, I used his wiring diagram. Thanks P1trson!</p>

<p><a href="https://stafwag.github.io/blog/images/w500_flashchip.jpg"><img src="https://stafwag.github.io/blog/images/w500_flashchip.jpg" width="250" height="177" alt="w500 and pi" /> </a>
<a href="https://stafwag.github.io/blog/images/pin_layout2.jpg"><img src="https://stafwag.github.io/blog/images/pin_layout2.jpg" width="500" height="172" alt="pin layout" /> </a></p>

<h2>Power off &amp; wiring</h2>

<p>Power off your raspberry-pi and wire your flash clip to the raspberry-pi with the above diagram.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@raspberrypi:~# poweroff
</span><span class='line'>Connection to pi2 closed by remote host.
</span><span class='line'>Connection to pi2 closed.
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h1>flashing</h1>

<h2>test</h2>

<p>Test the connection to your flash chip with <code>flashrom</code>. I needed to specify the <code>spispeed=512</code> to get the connection established.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@raspberrypi:~# flashrom -p linux_spi:dev=/dev/spidev0.0,spispeed=512 
</span><span class='line'>flashrom v0.9.9-r1954 on Linux 4.14.79+ (armv6l)
</span><span class='line'>flashrom is free software, get the source code at https://flashrom.org
</span><span class='line'>
</span><span class='line'>Calibrating delay loop... OK.
</span><span class='line'>Found Macronix flash chip "MX25L6405" (8192 kB, SPI) on linux_spi.
</span><span class='line'>Found Macronix flash chip "MX25L6405D" (8192 kB, SPI) on linux_spi.
</span><span class='line'>Found Macronix flash chip "MX25L6406E/MX25L6408E" (8192 kB, SPI) on linux_spi.
</span><span class='line'>Found Macronix flash chip "MX25L6436E/MX25L6445E/MX25L6465E/MX25L6473E" (8192 kB, SPI) on linux_spi.
</span><span class='line'>Multiple flash chip definitions match the detected chip(s): "MX25L6405", "MX25L6405D", "MX25L6406E/MX25L6408E", "MX25L6436E/MX25L6445E/MX25L6465E/MX25L6473E"
</span><span class='line'>Please specify which chip definition to use with the -c &lt;chipname&gt; option.
</span><span class='line'>root@raspberrypi:~# </span></code></pre></td></tr></table></div></figure>


<h2>read old bios</h2>

<h3>read</h3>

<p>Read the original flash twice</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~ $ sudo flashrom -c "MX25L6405D" -p linux_spi:dev=/dev/spidev0.0,spispeed=512 -r w500bios.rom
</span><span class='line'>flashrom v0.9.9-r1954 on Linux 4.14.79+ (armv6l)
</span><span class='line'>flashrom is free software, get the source code at https://flashrom.org
</span><span class='line'>
</span><span class='line'>Calibrating delay loop... OK.
</span><span class='line'>Found Macronix flash chip "MX25L6405D" (8192 kB, SPI) on linux_spi.
</span><span class='line'>Reading flash... done.
</span><span class='line'>pi@raspberrypi:~ $ ls
</span><span class='line'>flashrom  test.rom  w500bios.rom
</span><span class='line'>pi@raspberrypi:~ $ sudo flashrom -c "MX25L6405D" -p linux_spi:dev=/dev/spidev0.0,spispeed=512 -r w500bios2.rom
</span><span class='line'>flashrom v0.9.9-r1954 on Linux 4.14.79+ (armv6l)
</span><span class='line'>flashrom is free software, get the source code at https://flashrom.org
</span><span class='line'>
</span><span class='line'>Calibrating delay loop... OK.
</span><span class='line'>Found Macronix flash chip "MX25L6405D" (8192 kB, SPI) on linux_spi.
</span><span class='line'>Reading flash... done.
</span><span class='line'>pi@raspberrypi:~ $ </span></code></pre></td></tr></table></div></figure>


<h3>compare</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~ $ sha1sum w500bios*.rom
</span><span class='line'>d23effea7312dbc0f2aabe1ca1387e1d047d7334  w500bios2.rom
</span><span class='line'>d23effea7312dbc0f2aabe1ca1387e1d047d7334  w500bios.rom
</span><span class='line'>pi@raspberrypi:~ $ </span></code></pre></td></tr></table></div></figure>


<h3>store</h3>

<p>Store your original BIOS image to a safe place. Might be useful if need to restore it&hellip;</p>

<h3>Flash libreboot</h3>

<h4>Download &amp; verify</h4>

<p>I created <code>~/libreboot</code> directory on my raspberry-pi to store all the downloads.</p>

<h5>Download</h5>

<p>Download the libreboot version that matches your laptop with SHA512SUMS and SHA512SUMS.sig.</p>

<p><a href="https://libreboot.org/download.html">https://libreboot.org/download.html</a></p>

<h5>Verify</h5>

<p>It always a good idea to verify the gpg signature&hellip;</p>

<p>Download the gpg key</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~ $ gpg --recv-keys 0x969A979505E8C5B2
</span><span class='line'>gpg: failed to start the dirmngr '/usr/bin/dirmngr': No such file or directory
</span><span class='line'>gpg: connecting dirmngr at '/run/user/1000/gnupg/S.dirmngr' failed: No such file or directory
</span><span class='line'>gpg: keyserver receive failed: No dirmngr</span></code></pre></td></tr></table></div></figure>


<p>I needed to install dirmgr separately on my Raspbian installation.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~ $ sudo apt-get install dirmngr
</span><span class='line'>Reading package lists... Done
</span><span class='line'>Building dependency tree       
</span><span class='line'>Reading state information... Done
</span><span class='line'>Suggested packages:
</span><span class='line'>  dbus-user-session pinentry-gnome3 tor
</span><span class='line'>The following NEW packages will be installed:
</span><span class='line'>  dirmngr
</span><span class='line'>0 upgraded, 1 newly installed, 0 to remove and 0 not upgraded.
</span><span class='line'>Need to get 547 kB of archives.
</span><span class='line'>After this operation, 963 kB of additional disk space will be used.
</span><span class='line'>Get:1 http://mirror.nl.leaseweb.net/raspbian/raspbian stretch/main armhf dirmngr armhf 2.1.18-8~deb9u3 [547 kB]
</span><span class='line'>Fetched 547 kB in 9s (58.3 kB/s)         
</span><span class='line'>Selecting previously unselected package dirmngr.
</span><span class='line'>(Reading database ... 36051 files and directories currently installed.)
</span><span class='line'>Preparing to unpack .../dirmngr_2.1.18-8~deb9u3_armhf.deb ...
</span><span class='line'>Unpacking dirmngr (2.1.18-8~deb9u3) ...
</span><span class='line'>Processing triggers for man-db (2.7.6.1-2) ...
</span><span class='line'>Setting up dirmngr (2.1.18-8~deb9u3) ...
</span><span class='line'>pi@raspberrypi:~ $ </span></code></pre></td></tr></table></div></figure>


<p>Try it again&hellip;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~ $ gpg --recv-keys 0x969A979505E8C5B2
</span><span class='line'>key 969A979505E8C5B2:
</span><span class='line'>1 signature not checked due to a missing key
</span><span class='line'>gpg: /home/pi/.gnupg/trustdb.gpg: trustdb created
</span><span class='line'>gpg: key 969A979505E8C5B2: public key "Leah Rowe (Libreboot signing key) &lt;info@minifree.org&gt;" imported
</span><span class='line'>gpg: no ultimately trusted keys found
</span><span class='line'>gpg: Total number processed: 1
</span><span class='line'>gpg:               imported: 1
</span><span class='line'>pi@raspberrypi:~ $ 
</span></code></pre></td></tr></table></div></figure>


<p>Verify the signature of the checksum file&hellip;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~ $ gpg --verify SHA512SUMS.sig 
</span><span class='line'>gpg: assuming signed data in 'SHA512SUMS'
</span><span class='line'>gpg: Signature made Wed 07 Sep 2016 23:15:17 BST
</span><span class='line'>gpg:                using RSA key 969A979505E8C5B2
</span><span class='line'>gpg: Good signature from "Leah Rowe (Libreboot signing key) &lt;info@minifree.org&gt;" [unknown]
</span><span class='line'>gpg: WARNING: This key is not certified with a trusted signature!
</span><span class='line'>gpg:          There is no indication that the signature belongs to the owner.
</span><span class='line'>Primary key fingerprint: CDC9 CAE3 2CB4 B7FC 84FD  C804 969A 9795 05E8 C5B2
</span><span class='line'>pi@raspberrypi:~ $ 
</span></code></pre></td></tr></table></div></figure>


<p>Compare the checksum&hellip;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~/libreboot $ sha512sum libreboot_r20160907_grub_t500_8mb.tar.xz 
</span><span class='line'>5325aef526ab6ca359d6613609a4a2345eee47c6d194094553b53996c413431bccdc345838299b347f47bcba8896dd0a6ed3f9b4c88606ead61c3725b580983b  libreboot_r20160907_grub_t500_8mb.tar.xz
</span><span class='line'>pi@raspberrypi:~/libreboot $ grep sha512sum 5325aef526ab6ca359d6613609a4a2345eee47c6d194094553b53996c413431bccdc345838299b347f47bcba8896dd0a6ed3f9b4c88606ead61c3725b580983b
</span><span class='line'>grep: 5325aef526ab6ca359d6613609a4a2345eee47c6d194094553b53996c413431bccdc345838299b347f47bcba8896dd0a6ed3f9b4c88606ead61c3725b580983b: No such file or directory
</span><span class='line'>pi@raspberrypi:~/libreboot $ grep 5325aef526ab6ca359d6613609a4a2345eee47c6d194094553b53996c413431bccdc345838299b347f47bcba8896dd0a6ed3f9b4c88606ead61c3725b580983b SHA512SUMS
</span><span class='line'>5325aef526ab6ca359d6613609a4a2345eee47c6d194094553b53996c413431bccdc345838299b347f47bcba8896dd0a6ed3f9b4c88606ead61c3725b580983b  ./rom/grub/libreboot_r20160907_grub_t500_8mb.tar.xz
</span><span class='line'>pi@raspberrypi:~/libreboot $ </span></code></pre></td></tr></table></div></figure>


<h5>Extract</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~/libreboot $ tar xvf libreboot_r20160907_grub_t500_8mb.tar.xz
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_deqwertz_txtmode.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_esqwerty_txtmode.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_frazerty_txtmode.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_frdvbepo_txtmode.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_itqwerty_txtmode.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_svenska_txtmode.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_ukdvorak_txtmode.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_ukqwerty_txtmode.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_usdvorak_txtmode.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_usqwerty_txtmode.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_deqwertz_vesafb.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_esqwerty_vesafb.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_frazerty_vesafb.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_frdvbepo_vesafb.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_itqwerty_vesafb.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_svenska_vesafb.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_ukdvorak_vesafb.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_ukqwerty_vesafb.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_usdvorak_vesafb.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/t500_8mb_usqwerty_vesafb.rom
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/ChangeLog
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/NEWS
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/version
</span><span class='line'>libreboot_r20160907_grub_t500_8mb/versiondate
</span><span class='line'>pi@raspberrypi:~/libreboot $ </span></code></pre></td></tr></table></div></figure>


<h5>copy the image that you plan to use</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~/libreboot $ cp libreboot_r20160907_grub_t500_8mb/t500_8mb_usqwerty_vesafb.rom libreboot.rom
</span><span class='line'>pi@raspberrypi:~/libreboot $ </span></code></pre></td></tr></table></div></figure>


<h4>Change MAC</h4>

<h5>Download the libreboot util</h5>

<h6>Download</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~/libreboot $ wget https://www.mirrorservice.org/sites/libreboot.org/release/stable/20160907/libreboot_r20160907_util.tar.xz
</span><span class='line'>--2019-01-27 08:46:32--  https://www.mirrorservice.org/sites/libreboot.org/release/stable/20160907/libreboot_r20160907_util.tar.xz
</span><span class='line'>Resolving www.mirrorservice.org (www.mirrorservice.org)... 212.219.56.184, 2001:630:341:12::184
</span><span class='line'>Connecting to www.mirrorservice.org (www.mirrorservice.org)|212.219.56.184|:443... connected.
</span><span class='line'>HTTP request sent, awaiting response... 200 OK
</span><span class='line'>Length: 2458736 (2.3M) [application/x-tar]
</span><span class='line'>Saving to: libreboot_r20160907_util.tar.xz
</span><span class='line'>
</span><span class='line'>libreboot_r20160907_util.tar 100%[===========================================&gt;]   2.34M  1.65MB/s    in 1.4s    
</span><span class='line'>
</span><span class='line'>2019-01-27 08:46:34 (1.65 MB/s) - libreboot_r20160907_util.tar.xz saved [2458736/2458736]
</span><span class='line'>
</span><span class='line'>pi@raspberrypi:~/libreboot $ </span></code></pre></td></tr></table></div></figure>


<h6>Verify</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~/libreboot $ sha512sum libreboot_r20160907_util.tar.xz
</span><span class='line'>c5bfa5a06d55c61e5451e70cd8da3f430b5e06686f9a74c5a2e9fe0e9d155505867b0ca3428d85a983741146c4e024a6b0447638923423000431c98d048bd473  libreboot_r20160907_util.tar.xz
</span><span class='line'>pi@raspberrypi:~/libreboot $ grep c5bfa5a06d55c61e5451e70cd8da3f430b5e06686f9a74c5a2e9fe0e9d155505867b0ca3428d85a983741146c4e024a6b0447638923423000431c98d048bd473 SHA512SUMS
</span><span class='line'>c5bfa5a06d55c61e5451e70cd8da3f430b5e06686f9a74c5a2e9fe0e9d155505867b0ca3428d85a983741146c4e024a6b0447638923423000431c98d048bd473  ./libreboot_r20160907_util.tar.xz
</span><span class='line'>pi@raspberrypi:~/libreboot $ </span></code></pre></td></tr></table></div></figure>


<h6>Extract</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~/libreboot $ tar xvf libreboot_r20160907_util.tar.xz 
</span><span class='line'>libreboot_r20160907_util/
</span><span class='line'>libreboot_r20160907_util/bucts/
</span><span class='line'>libreboot_r20160907_util/bucts/x86_64/
</span><span class='line'>libreboot_r20160907_util/bucts/x86_64/bucts
</span><span class='line'>libreboot_r20160907_util/bucts/i686/
</span><span class='line'>libreboot_r20160907_util/bucts/i686/bucts
</span><span class='line'>libreboot_r20160907_util/flashrom/
</span><span class='line'>libreboot_r20160907_util/flashrom/x86_64/
</span><span class='line'>libreboot_r20160907_util/flashrom/x86_64/flashrom
</span><span class='line'>libreboot_r20160907_util/flashrom/x86_64/flashrom_lenovobios_sst
</span><span class='line'>libreboot_r20160907_util/flashrom/x86_64/flashrom_lenovobios_macronix
</span><span class='line'>libreboot_r20160907_util/flashrom/armv7l/
</span><span class='line'>libreboot_r20160907_util/flashrom/armv7l/flashrom
</span><span class='line'>libreboot_r20160907_util/flashrom/i686/
</span><span class='line'>libreboot_r20160907_util/flashrom/i686/flashrom
</span><span class='line'>libreboot_r20160907_util/flashrom/i686/flashrom_lenovobios_macronix
</span><span class='line'>libreboot_r20160907_util/flashrom/i686/flashrom_lenovobios_sst
</span><span class='line'>libreboot_r20160907_util/cbfstool/
</span><span class='line'>libreboot_r20160907_util/cbfstool/x86_64/
</span><span class='line'>libreboot_r20160907_util/cbfstool/x86_64/cbfstool
</span><span class='line'>libreboot_r20160907_util/cbfstool/i686/
</span><span class='line'>libreboot_r20160907_util/cbfstool/i686/cbfstool
</span><span class='line'>libreboot_r20160907_util/cbfstool/armv7l/
</span><span class='line'>libreboot_r20160907_util/cbfstool/armv7l/cbfstool
</span><span class='line'>libreboot_r20160907_util/ich9deblob/
</span><span class='line'>libreboot_r20160907_util/ich9deblob/x86_64/
</span><span class='line'>libreboot_r20160907_util/ich9deblob/x86_64/ich9deblob
</span><span class='line'>libreboot_r20160907_util/ich9deblob/x86_64/ich9gen
</span><span class='line'>libreboot_r20160907_util/ich9deblob/x86_64/demefactory
</span><span class='line'>libreboot_r20160907_util/ich9deblob/i686/
</span><span class='line'>libreboot_r20160907_util/ich9deblob/i686/ich9deblob
</span><span class='line'>libreboot_r20160907_util/ich9deblob/i686/ich9gen
</span><span class='line'>libreboot_r20160907_util/ich9deblob/i686/demefactory
</span><span class='line'>libreboot_r20160907_util/ich9deblob/armv7l/
</span><span class='line'>libreboot_r20160907_util/ich9deblob/armv7l/ich9deblob
</span><span class='line'>libreboot_r20160907_util/ich9deblob/armv7l/ich9gen
</span><span class='line'>libreboot_r20160907_util/ich9deblob/armv7l/demefactory
</span><span class='line'>libreboot_r20160907_util/nvramtool/
</span><span class='line'>libreboot_r20160907_util/nvramtool/x86_64/
</span><span class='line'>libreboot_r20160907_util/nvramtool/x86_64/nvramtool
</span><span class='line'>libreboot_r20160907_util/nvramtool/i686/
</span><span class='line'>libreboot_r20160907_util/nvramtool/i686/nvramtool
</span><span class='line'>libreboot_r20160907_util/flash
</span><span class='line'>libreboot_r20160907_util/powertop.trisquel7
</span><span class='line'>libreboot_r20160907_util/ChangeLog
</span><span class='line'>libreboot_r20160907_util/NEWS
</span><span class='line'>libreboot_r20160907_util/version
</span><span class='line'>libreboot_r20160907_util/versiondate
</span><span class='line'>pi@raspberrypi:~/libreboot $ </span></code></pre></td></tr></table></div></figure>


<h6>## find the ich9gen utility for architecture</h6>

<p>find ./libreboot_r20160907_util | grep -i ich9gen</p>

<p>To make our lives easier we will copy ich9gen binary to the directory that holds our libreboot images.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~/libreboot $ find ./libreboot_r20160907_util | grep -i ich9gen
</span><span class='line'>./libreboot_r20160907_util/ich9deblob/i686/ich9gen
</span><span class='line'>./libreboot_r20160907_util/ich9deblob/armv7l/ich9gen
</span><span class='line'>./libreboot_r20160907_util/ich9deblob/x86_64/ich9gen
</span><span class='line'>pi@raspberrypi:~/libreboot $ cp ./libreboot_r20160907_util/ich9deblob/armv7l/ich9gen .</span></code></pre></td></tr></table></div></figure>


<h6>## burn the MAC address into the rom/save</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~/libreboot $ ./ich9gen --macaddress XX:XX:XX:XX:XX:XX
</span><span class='line'>You selected to change the MAC address in the Gbe section. This has been done.
</span><span class='line'>
</span><span class='line'>The modified gbe region has also been dumped as src files: mkgbe.c, mkgbe.h
</span><span class='line'>To use these in ich9gen, place them in src/ich9gen/ and re-build ich9gen.
</span><span class='line'>
</span><span class='line'>descriptor and gbe successfully written to the file: ich9fdgbe_4m.bin
</span><span class='line'>Now do: dd if=ich9fdgbe_4m.bin of=libreboot.rom bs=1 count=12k conv=notrunc
</span><span class='line'>(in other words, add the modified descriptor+gbe to your ROM image)
</span><span class='line'>
</span><span class='line'>descriptor and gbe successfully written to the file: ich9fdgbe_8m.bin
</span><span class='line'>Now do: dd if=ich9fdgbe_8m.bin of=libreboot.rom bs=1 count=12k conv=notrunc
</span><span class='line'>(in other words, add the modified descriptor+gbe to your ROM image)
</span><span class='line'>
</span><span class='line'>descriptor and gbe successfully written to the file: ich9fdgbe_16m.bin
</span><span class='line'>Now do: dd if=ich9fdgbe_16m.bin of=libreboot.rom bs=1 count=12k conv=notrunc
</span><span class='line'>(in other words, add the modified descriptor+gbe to your ROM image)
</span><span class='line'>
</span><span class='line'>descriptor successfully written to the file: ich9fdnogbe_4m.bin
</span><span class='line'>Now do: dd if=ich9fdnogbe_4m.bin of=yourrom.rom bs=1 count=4k conv=notrunc
</span><span class='line'>(in other words, add the modified descriptor to your ROM image)
</span><span class='line'>
</span><span class='line'>descriptor successfully written to the file: ich9fdnogbe_8m.bin
</span><span class='line'>Now do: dd if=ich9fdnogbe_8m.bin of=yourrom.rom bs=1 count=4k conv=notrunc
</span><span class='line'>(in other words, add the modified descriptor to your ROM image)
</span><span class='line'>
</span><span class='line'>descriptor successfully written to the file: ich9fdnogbe_16m.bin
</span><span class='line'>Now do: dd if=ich9fdnogbe_16m.bin of=yourrom.rom bs=1 count=4k conv=notrunc
</span><span class='line'>(in other words, add the modified descriptor to your ROM image)</span></code></pre></td></tr></table></div></figure>


<p>Insert the mac into your rom</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~/libreboot $ dd if=ich9fdgbe_8m.bin of=libreboot.rom bs=12k count=1 conv=notrunc
</span><span class='line'>1+0 records in
</span><span class='line'>1+0 records out
</span><span class='line'>12288 bytes (12 kB, 12 KiB) copied, 0.00883476 s, 1.4 MB/s
</span><span class='line'>pi@raspberrypi:~/libreboot $ ls -lh libreboot.rom
</span><span class='line'>-rw-r--r-- 1 pi pi 8.0M Jan 27 09:38 libreboot.rom
</span><span class='line'>pi@raspberrypi:~/libreboot $ 
</span></code></pre></td></tr></table></div></figure>


<h6>## flash it</h6>

<p>Flash your Libreboot image to your BIOS.</p>

<p>Make sure that you get the <code>Verifying flash... VERIFIED</code> message, if you don&rsquo;t get this message try it again until you get it. I needed to do it twice&hellip;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pi@raspberrypi:~/libreboot $ sudo flashrom -c "MX25L6405D" -p linux_spi:dev=/dev/spidev0.0,spispeed=512 -w libreboot.rom 
</span><span class='line'>flashrom v0.9.9-r1954 on Linux 4.14.79+ (armv6l)
</span><span class='line'>flashrom is free software, get the source code at https://flashrom.org
</span><span class='line'>
</span><span class='line'>Calibrating delay loop... OK.
</span><span class='line'>Found Macronix flash chip "MX25L6405D" (8192 kB, SPI) on linux_spi.
</span><span class='line'>Reading old flash chip contents... done.
</span><span class='line'>Erasing and writing flash chip... Erase/write done.
</span><span class='line'>Verifying flash... FAILED at 0x000c9f01! Expected=0x6b, Found=0xe9, failed byte count from 0x00000000-0x007fffff: 0x2
</span><span class='line'>Your flash chip is in an unknown state.
</span><span class='line'>Please report this on IRC at chat.freenode.net (channel #flashrom) or
</span><span class='line'>mail flashrom@flashrom.org, thanks!
</span><span class='line'>pi@raspberrypi:~/libreboot $ 
</span><span class='line'>pi@raspberrypi:~/libreboot $ sudo flashrom -c "MX25L6405D" -p linux_spi:dev=/dev/spidev0.0,spispeed=512 -w libreboot.rom 
</span><span class='line'>flashrom v0.9.9-r1954 on Linux 4.14.79+ (armv6l)
</span><span class='line'>flashrom is free software, get the source code at https://flashrom.org
</span><span class='line'>
</span><span class='line'>Calibrating delay loop... OK.
</span><span class='line'>Found Macronix flash chip "MX25L6405D" (8192 kB, SPI) on linux_spi.
</span><span class='line'>Reading old flash chip contents... done.
</span><span class='line'>Erasing and writing flash chip... Erase/write done.
</span><span class='line'>Verifying flash... VERIFIED.
</span><span class='line'>pi@raspberrypi:~/libreboot $ </span></code></pre></td></tr></table></div></figure>


<h1>Almost done</h1>

<h2>GNU/Linux</h2>

<p><a href="https://stafwag.github.io/blog/images/w500_in_action.jpg"><img src="https://stafwag.github.io/blog/images/w500_in_action.jpg" width="700" height="466" alt="w500_in_action.jpg" /></a></p>

<p>I use <a href="https://www.parabola.nu/">Parabola GNU/Linux</a> on my W500.</p>

<h2>Wifi Card</h2>

<p>The intel wifi card that Lenovo uses on the W500 isn&rsquo;t supported without a binary blob. With the original Lenovo BIOS you are forced to use certified PCI card. Libreboot doesn&rsquo;t have this restriction this is another advantage of using an alternative BIOS like Libreboot or <a href="https://www.coreboot.org/">Coreboot</a> . I replaced wifi an Atheros from <a href="https://www.ebay.be">ebay</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@snuffel ~]$ sudo lspci | grep -i Atheros
</span><span class='line'>02:00.0 Network controller: Qualcomm Atheros AR93xx Wireless Network Adapter (rev 01)
</span><span class='line'>[staf@snuffel ~]$</span></code></pre></td></tr></table></div></figure>


<h2>ACPI</h2>

<p>It is recommended to load the thinkpad-acpi module. Make sure that <code>fan_control=1</code> is enabled.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@snuffel ~]$ cat /usr/lib/modprobe.d/thinkpad_acpi.conf
</span><span class='line'>options thinkpad_acpi fan_control=1
</span><span class='line'>[staf@snuffel ~]$</span></code></pre></td></tr></table></div></figure>


<p>Execute <code>modprobe thindpad_acpi</code> to load the module</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@snuffel ~]$ sudo modprobe thinkpad_acpi
</span><span class='line'>[sudo] password for staf:
</span><span class='line'>[staf@snuffel ~]$</span></code></pre></td></tr></table></div></figure>


<h2>thinkfan</h2>

<p>The Intel core duo is still a captable CPU. Even video playback in Full-HD is possible but it takes already a lot of the CPU and the temperature is increasing during the playback.</p>

<p>I installed <a href="https://github.com/vmatare/thinkfan/">thinkfan</a> with a more aggresive cooling profile to keep the CPU temperature under control.</p>

<p>Install thinkfan</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@snuffel ~]$ yay -S thinkfan
</span><span class='line'>warning: thinkfan-0.9.3-1 is up to date -- reinstalling
</span><span class='line'>resolving dependencies...
</span><span class='line'>looking for conflicting packages...
</span><span class='line'>
</span><span class='line'>Packages (1) thinkfan-0.9.3-1
</span><span class='line'>
</span><span class='line'>Total Installed Size:  0.11 MiB
</span><span class='line'>Net Upgrade Size:      0.00 MiB
</span><span class='line'>
</span><span class='line'>:: Proceed with installation? [Y/n]</span></code></pre></td></tr></table></div></figure>


<p>copy the sample configuration</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@snuffel ~]$ sudo cp /usr/share/doc/thinkfan/examples/thinkfan.conf.simple /etc/thinkfan.con</span></code></pre></td></tr></table></div></figure>


<p>Edit <code>/etc/thinkfan.conf</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(0,  0,  50)
</span><span class='line'>(1,   49, 52)
</span><span class='line'>(2,   51, 54)
</span><span class='line'>(3,   53, 56)
</span><span class='line'>(4,   55, 58)
</span><span class='line'>(5,   57, 60)
</span><span class='line'>(7,   59, 32767)</span></code></pre></td></tr></table></div></figure>


<p>Enable and start thinkfan</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@snuffel ~]$ sudo systemctl enable thinkfan
</span><span class='line'>[sudo] password for staf:
</span><span class='line'>[staf@snuffel ~]$ sudo systemctl start thinkfan
</span><span class='line'>[staf@snuffel ~]$</span></code></pre></td></tr></table></div></figure>


<p><strong><em>Have fun</em></strong></p>

<h1>Links</h1>

<ul>
<li><a href="https://libreboot.org/">https://libreboot.org/</a></li>
<li><a href="https://libreboot.org/docs/install/rpi_setup.html">https://libreboot.org/docs/install/rpi_setup.html</a></li>
<li><a href="https://libreboot.org/docs/install/t500_external.html">https://libreboot.org/docs/install/t500_external.html</a></li>
<li><a href="https://p1trson.blogspot.com/2016/">https://p1trson.blogspot.com/2016/</a></li>
<li><a href="https://www.raspberrypi-spy.co.uk/2012/06/simple-guide-to-the-rpi-gpio-header-and-pins/#prettyPhoto">https://www.raspberrypi-spy.co.uk/2012/06/simple-guide-to-the-rpi-gpio-header-and-pins/#prettyPhoto</a></li>
<li><a href="https://forums.lenovo.com/t5/ThinkPad-T400-T500-and-newer-T/t500-bios-chip-lifted-pad-issue/td-p/4205719">https://forums.lenovo.com/t5/ThinkPad-T400-T500-and-newer-T/t500-bios-chip-lifted-pad-issue/td-p/4205719</a></li>
<li><a href="https://www.raspberrypi.org/documentation/hardware/raspberrypi/spi/README.md">https://www.raspberrypi.org/documentation/hardware/raspberrypi/spi/README.md</a></li>
<li><a href="https://linuxhint.com/libreboot-t400-tutorial/">https://linuxhint.com/libreboot-t400-tutorial/</a></li>
<li><a href="https://www.enisa.europa.eu/publications/info-notes/security-vs-performance-discussion-with-the-return-of-201cspectrum201d-vulnerability">https://www.enisa.europa.eu/publications/info-notes/security-vs-performance-discussion-with-the-return-of-201cspectrum201d-vulnerability</a></li>
<li><a href="https://wiki.archlinux.org/index.php/Lenovo_ThinkPad_T420">https://wiki.archlinux.org/index.php/Lenovo_ThinkPad_T420</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Setting Up OpenStack-Ansible All-In-One on a Centos 7 System]]></title>
    <link href="https://stafwag.github.io/blog/blog/2019/01/21/settinp-up-openstack-ansible-all-in-one-on-a-centos-7-system/"/>
    <updated>2019-01-21T19:51:32+01:00</updated>
    <id>https://stafwag.github.io/blog/blog/2019/01/21/settinp-up-openstack-ansible-all-in-one-on-a-centos-7-system</id>
    <content type="html"><![CDATA[<p><img class="right" src="https://stafwag.github.io/blog/images/openstack-logo.png" width="150" height="150" title="&#34;openstack-logo&#34;" alt="&#34;openstack-logo&#34;"></p>

<p><a href="https://www.openstack.org/">Openstack</a> is a nice platform to deploy <a href="https://en.wikipedia.org/wiki/Cloud_computing#Infrastructure_as_a_service_.28IaaS.29">an Infrastructure as a service</a> and is a <a href="https://governance.openstack.org/tc/reference/projects/index.html">collection of projects</a> but it can be a bit difficult to setup. <a href="https://docs.openstack.org">The documentation</a> is really great if you want to setup openstack by hand and there are a few openstack distributions that makes it easier to install it.</p>

<p><a href="https://www.ansible.org">Ansible</a> is a very nice tool for system automatisation and is one that&rsquo;s easier to learn.</p>

<p><img class="left" src="https://stafwag.github.io/blog/images/ansible-logo-red-t.png" width="150" height="150" title="&#34;ansible-logo-red&#34;" alt="&#34;ansible-logo-red&#34;"></p>

<p>Wouldn&rsquo;t be nice if we could make the openstack installation easier with ansible? That&rsquo;s exactly what <a href="https://github.com/openstack/openstack-ansible">Openstack-Ansible</a>
 does.</p>

<p>In this blog post we&rsquo;ll setup <a href="https://docs.openstack.org/openstack-ansible/latest/user/aio/quickstart.html">&ldquo;an all-in-one&rdquo; openstack installation</a> on <a href="https://www.centos.org">Centos 7</a>. The installer will install openstack into <a href="https://linuxcontainers.org/">lxc containers</a> and it&rsquo;s nice way to learn how openstack works and how to operate it.</p>

<h1>Preparation</h1>

<h2>System requirements</h2>

<p>I use a Centos 7 virtual system running as a <a href="https://www.linux-kvm.org">KVM</a> instance with <a href="http://stafwag.github.io/blog/blog/2018/06/04/nested-virtualization-in-kvm/">nested KVM virtualasation enabled</a>. The system requiremensts
The minimun requiremenst are:</p>

<ul>
<li>8 CPU cores</li>
<li>50 GB of free diskspace</li>
<li>8GB RAM</li>
</ul>


<h2>update &hellip;.</h2>

<p>Make sure that your system is up-to-update</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@openstack ~]$ sudo yum update -y
</span><span class='line'>
</span><span class='line'>We trust you have received the usual lecture from the local System
</span><span class='line'>Administrator. It usually boils down to these three things:
</span><span class='line'>
</span><span class='line'>    #1) Respect the privacy of others.
</span><span class='line'>    #2) Think before you type.
</span><span class='line'>    #3) With great power comes great responsibility.
</span><span class='line'>
</span><span class='line'>[sudo] password for staf: 
</span><span class='line'>Loaded plugins: fastestmirror
</span><span class='line'>Loading mirror speeds from cached hostfile
</span><span class='line'> * base: distrib-coffee.ipsl.jussieu.fr
</span><span class='line'> * extras: mirror.in2p3.fr
</span><span class='line'> * updates: centos.mirror.fr.planethoster.net
</span><span class='line'>base                                                                                                                                    | 3.6 kB  00:00:00     
</span><span class='line'>extras                                                                                                                                  | 3.4 kB  00:00:00     
</span><span class='line'>updates                                                                                                                                 | 3.4 kB  00:00:00     
</span><span class='line'>No packages marked for update
</span><span class='line'>[staf@openstack ~]$ </span></code></pre></td></tr></table></div></figure>


<h2>Install git</h2>

<p>We&rsquo;ll need git to install the ansible playbooks and the Openstack-Ansible installation scripts.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@openstack ~]$ yum install git
</span><span class='line'>Loaded plugins: fastestmirror
</span><span class='line'>You need to be root to perform this command.
</span><span class='line'>[staf@openstack ~]$ sudo yum install git
</span><span class='line'>Loaded plugins: fastestmirror
</span><span class='line'>Loading mirror speeds from cached hostfile
</span><span class='line'> * base: mirror.in2p3.fr
</span><span class='line'> * extras: mirror.in2p3.fr
</span><span class='line'> * updates: centos.mirror.fr.planethoster.net
</span><span class='line'>Package git-1.8.3.1-20.el7.x86_64 already installed and latest version
</span><span class='line'>Nothing to do
</span><span class='line'>[staf@openstack ~]$ </span></code></pre></td></tr></table></div></figure>


<h2>Ansible&hellip;.</h2>

<p>This is a bit of a pitfail&hellip; The Openstack-Ansible bootstrap script will download and install his own version of ansible and create a link to <code>/usr/local/bin</code>. So <code>/usr/local/bin</code> must be in your $PATH.  Ansible shouldn&rsquo;t be installed on your system or if it is installed  it shouln&rsquo;t be executed instead of the ansible version that is builded with Openstack-Ansible.</p>

<p>On most GNU/Linux distributions have <code>/usr/local/bin</code> and <code>/usr/local/sbin</code>  is in the $PATH but not on centos, so we&rsquo;ll need to add it.</p>

<h3>Make sure that ansible insn&rsquo;t installed</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@openstack ~]$ sudo rpm -qa | grep -i ansible
</span><span class='line'>[sudo] password for staf: 
</span><span class='line'>[staf@openstack ~]$ </span></code></pre></td></tr></table></div></figure>


<h3>Update your $PATH</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@openstack ~]# export PATH=/usr/local/bin:$PATH</span></code></pre></td></tr></table></div></figure>


<p>If you want to have <code>/usr/local/bin</code> in your $PATH  update <code>/etc/profile</code>  or <code>$HOME/.profile</code></p>

<h2>ssh password authentication</h2>

<p>The ansibe playbooks will disable <code>PasswordAuthentication</code>, make sure that you login with a ssh key. - Password authentication is obsolete anyway -</p>

<h2>firewalld</h2>

<p>Firewall is enabled on Centos by default, the default iptables rules prevent communication between the openstack containers.</p>

<h3>stop and disable firewalld</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@openstack ~]# systemctl stop firewalld
</span><span class='line'>[root@openstack ~]# systemctl disable firewalld
</span><span class='line'>Removed symlink /etc/systemd/system/multi-user.target.wants/firewalld.service.
</span><span class='line'>Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service.</span></code></pre></td></tr></table></div></figure>


<h3>verify</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@openstack ~]# iptables -L
</span><span class='line'>Chain INPUT (policy ACCEPT)
</span><span class='line'>target     prot opt source               destination         
</span><span class='line'>
</span><span class='line'>Chain FORWARD (policy ACCEPT)
</span><span class='line'>target     prot opt source               destination         
</span><span class='line'>
</span><span class='line'>Chain OUTPUT (policy ACCEPT)
</span><span class='line'>target     prot opt source               destination         
</span><span class='line'>[root@openstack ~]# </span></code></pre></td></tr></table></div></figure>


<h1>Openstack installation</h1>

<p>The installation will take some time therefor it&rsquo;s recommended to use an session manager like <a href="https://github.com/tmux/tmux/">tmux</a> or <a href="https://www.gnu.org/software/screen/">GNU screen</a></p>

<h2>Bootstrap</h2>

<h3>git clone</h3>

<p>clone the <a href="https://git.openstack.org/openstack/openstack-ansible">openstack-ansible git repo</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@openstack ~]# git clone https://git.openstack.org/openstack/openstack-ansible /opt/openstack-ansible
</span><span class='line'>Cloning into '/opt/openstack-ansible'...
</span><span class='line'>remote: Counting objects: 67055, done.
</span><span class='line'>remote: Compressing objects: 100% (32165/32165), done.
</span><span class='line'>remote: Total 67055 (delta 45474), reused 52564 (delta 32073)
</span><span class='line'>Receiving objects: 100% (67055/67055), 14.60 MiB | 720.00 KiB/s, done.
</span><span class='line'>Resolving deltas: 100% (45474/45474), done.
</span><span class='line'>[root@openstack ~]# </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@openstack ~]# cd /opt/openstack-ansible
</span><span class='line'>[root@openstack openstack-ansible]# </span></code></pre></td></tr></table></div></figure>


<h3>choose you Openstack releases</h3>

<p>Openstack has release shedule about every 6 months the current stable release is <a href="https://releases.openstack.org/rocky/index.html">Rocky</a>. Every Openstack release has his own branch in the git repo. Each Openstack-Ansible release is tagged in the git repo. So either you&rsquo;ll need checkout Openstack-Ansible release tag or the bracnh. We&rsquo;ll checkout the Rocky branch.</p>

<h4>get the list of branches</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@openstack openstack-ansible]# git branch -a
</span><span class='line'>* master
</span><span class='line'>  remotes/origin/HEAD -&gt; origin/master
</span><span class='line'>  remotes/origin/master
</span><span class='line'>  remotes/origin/stable/ocata
</span><span class='line'>  remotes/origin/stable/pike
</span><span class='line'>  remotes/origin/stable/queens
</span><span class='line'>  remotes/origin/stable/rocky
</span><span class='line'>[root@openstack openstack-ansible]# </span></code></pre></td></tr></table></div></figure>


<h5>checkout the branch</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@openstack openstack-ansible]# git checkout stable/rocky
</span><span class='line'>Branch stable/rocky set up to track remote branch stable/rocky from origin.
</span><span class='line'>Switched to a new branch 'stable/rocky'
</span><span class='line'>[root@openstack openstack-ansible]# 
</span></code></pre></td></tr></table></div></figure>


<h3>Bootstrap ansible</h3>

<p>Execute <code>scripts/bootstrap-ansible.sh</code> this will install the required packages and ansible playbooks.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@openstack openstack-ansible]# scripts/bootstrap-ansible.sh
</span><span class='line'>+ export HTTP_PROXY=
</span><span class='line'>+ HTTP_PROXY=
</span><span class='line'>+ export HTTPS_PROXY=
</span><span class='line'>+ HTTPS_PROXY=
</span><span class='line'>+ export ANSIBLE_PACKAGE=ansible==2.5.14
</span><span class='line'>+ ANSIBLE_PACKAGE=ansible==2.5.14
</span><span class='line'>+ export ANSIBLE_ROLE_FILE=ansible-role-requirements.yml
</span><span class='line'>+ ANSIBLE_ROLE_FILE=ansible-role-requirements.yml
</span><span class='line'>+ export SSH_DIR=/root/.ssh
</span><span class='line'>+ SSH_DIR=/root/.ssh
</span><span class='line'>+ export DEBIAN_FRONTEND=noninteractive
</span><span class='line'>+ DEBIAN_FRONTEND=noninteractive
</span><span class='line'>&lt;SNIP&gt;
</span><span class='line'>+ unset ANSIBLE_LIBRARY
</span><span class='line'>+ unset ANSIBLE_LOOKUP_PLUGINS
</span><span class='line'>+ unset ANSIBLE_FILTER_PLUGINS
</span><span class='line'>+ unset ANSIBLE_ACTION_PLUGINS
</span><span class='line'>+ unset ANSIBLE_CALLBACK_PLUGINS
</span><span class='line'>+ unset ANSIBLE_CALLBACK_WHITELIST
</span><span class='line'>+ unset ANSIBLE_TEST_PLUGINS
</span><span class='line'>+ unset ANSIBLE_VARS_PLUGINS
</span><span class='line'>+ unset ANSIBLE_STRATEGY_PLUGINS
</span><span class='line'>+ unset ANSIBLE_CONFIG
</span><span class='line'>+ '[' false == true ']'
</span><span class='line'>+ echo 'System is bootstrapped and ready for use.'
</span><span class='line'>System is bootstrapped and ready for use.
</span><span class='line'>[root@openstack openstack-ansible]# </span></code></pre></td></tr></table></div></figure>


<h4>Verify</h4>

<p> <code>scripts/bootstrap-ansible</code> created <code>/opt/ansible-runtime</code> and create amd updated <code>//usr/local/bin</code> with a few links.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@openstack openstack-ansible]# ls -ld /opt/*
</span><span class='line'>drwxr-xr-x.  5 root root   56 Jan 12 11:42 /opt/ansible-runtime
</span><span class='line'>drwxr-xr-x. 14 root root 4096 Jan 12 11:43 /opt/openstack-ansible
</span><span class='line'>[root@openstack openstack-ansible]# ls -ltr /usr/local/bin/
</span><span class='line'>total 8
</span><span class='line'>lrwxrwxrwx. 1 root root   32 Jan 12 11:43 ansible -&gt; /usr/local/bin/openstack-ansible
</span><span class='line'>lrwxrwxrwx. 1 root root   39 Jan 12 11:43 ansible-config -&gt; /opt/ansible-runtime/bin/ansible-config
</span><span class='line'>lrwxrwxrwx. 1 root root   43 Jan 12 11:43 ansible-connection -&gt; /opt/ansible-runtime/bin/ansible-connection
</span><span class='line'>lrwxrwxrwx. 1 root root   40 Jan 12 11:43 ansible-console -&gt; /opt/ansible-runtime/bin/ansible-console
</span><span class='line'>lrwxrwxrwx. 1 root root   39 Jan 12 11:43 ansible-galaxy -&gt; /opt/ansible-runtime/bin/ansible-galaxy
</span><span class='line'>lrwxrwxrwx. 1 root root   36 Jan 12 11:43 ansible-doc -&gt; /opt/ansible-runtime/bin/ansible-doc
</span><span class='line'>lrwxrwxrwx. 1 root root   42 Jan 12 11:43 ansible-inventory -&gt; /opt/ansible-runtime/bin/ansible-inventory
</span><span class='line'>lrwxrwxrwx. 1 root root   32 Jan 12 11:43 ansible-playbook -&gt; /usr/local/bin/openstack-ansible
</span><span class='line'>lrwxrwxrwx. 1 root root   37 Jan 12 11:43 ansible-pull -&gt; /opt/ansible-runtime/bin/ansible-pull
</span><span class='line'>lrwxrwxrwx. 1 root root   38 Jan 12 11:43 ansible-vault -&gt; /opt/ansible-runtime/bin/ansible-vault
</span><span class='line'>-rw-r--r--. 1 root root 3169 Jan 12 11:43 openstack-ansible.rc
</span><span class='line'>-rwxr-xr-x. 1 root root 2638 Jan 12 11:43 openstack-ansible</span></code></pre></td></tr></table></div></figure>


<p>Verify that ansible command is one that&rsquo;s installed bu the Openstack-Ansible bootstrap script.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@openstack openstack-ansible]# which ansible
</span><span class='line'>/usr/local/bin/ansible</span></code></pre></td></tr></table></div></figure>


<h3>Bootstrap AIO</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@openstack openstack-ansible]# scripts/bootstrap-aio.sh
</span><span class='line'>+ export BOOTSTRAP_OPTS=
</span><span class='line'>+ BOOTSTRAP_OPTS=
</span><span class='line'>+++ dirname scripts/bootstrap-aio.sh
</span><span class='line'>++ readlink -f scripts/..
</span><span class='line'>+ export OSA_CLONE_DIR=/opt/openstack-ansible
</span><span class='line'>TASK [Gathering Facts] *****************************************************************************************************
</span><span class='line'>ok: [localhost]
</span><span class='line'>
</span><span class='line'>TASK [sshd : Set OS dependent variables] ***********************************************************************************
</span><span class='line'>ok: [localhost] =&gt; (item=/etc/ansible/roles/sshd/vars/RedHat_7.yml)
</span><span class='line'>
</span><span class='line'>TASK [sshd : OS is supported] **********************************************************************************************
</span><span class='line'>ok: [localhost] =&gt; {
</span><span class='line'>    "changed": false, 
</span><span class='line'>    "msg": "All assertions passed"
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>TASK [sshd : Install ssh packages] 
</span><span class='line'>&lt;SNIP&gt;
</span><span class='line'>EXIT NOTICE [Playbook execution success] **************************************
</span><span class='line'>===============================================================================
</span><span class='line'>+ popd
</span><span class='line'>/opt/openstack-ansible
</span><span class='line'>+ unset ANSIBLE_INVENTORY
</span><span class='line'>+ unset ANSIBLE_VARS_PLUGINS
</span><span class='line'>+ unset HOST_VARS_PATH
</span><span class='line'>+ unset GROUP_VARS_PATH
</span><span class='line'>[root@openstack openstack-ansible]# </span></code></pre></td></tr></table></div></figure>


<h3>Run the playbooks</h3>

<p>We&rsquo;ll to run a few playbooks to setup the containers and our Openstack environment.</p>

<p>Move to the openstack-ansible playbook directory.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@aio1 ~]# cd /opt/openstack-ansible/playbooks/
</span><span class='line'>[root@aio1 playbooks]# pwd
</span><span class='line'>/opt/openstack-ansible/playbooks
</span><span class='line'>[root@aio1 playbooks]# </span></code></pre></td></tr></table></div></figure>


<p>and exexcute the playbooks.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@openstack playbooks]# openstack-ansible setup-hosts.yml
</span><span class='line'>[root@openstack playbooks]# openstack-ansible setup-infrastructure.yml
</span><span class='line'>[root@aio1 playbooks]# openstack-ansible setup-openstack.yml</span></code></pre></td></tr></table></div></figure>


<p>If all goes well your openstack installation is completed.</p>

<p>You can verify the openstack containers with <code>lxc-ls</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@aio1 playbooks]# lxc-ls --fancy
</span><span class='line'>NAME                                   STATE   AUTOSTART GROUPS            IPV4                                           IPV6 
</span><span class='line'>aio1_cinder_api_container-c211b759     RUNNING 1         onboot, openstack 10.255.255.43, 172.29.237.244, 172.29.244.190  -    
</span><span class='line'>aio1_galera_container-9a90cbd9         RUNNING 1         onboot, openstack 10.255.255.50, 172.29.239.126                  -    
</span><span class='line'>aio1_glance_container-c05aab79         RUNNING 1         onboot, openstack 10.255.255.218, 172.29.236.160, 172.29.247.238 -    
</span><span class='line'>aio1_horizon_container-81943ba2        RUNNING 1         onboot, openstack 10.255.255.160, 172.29.237.37                  -    
</span><span class='line'>aio1_keystone_container-a5859104       RUNNING 1         onboot, openstack 10.255.255.40, 172.29.236.95                   -    
</span><span class='line'>aio1_memcached_container-ab998d0e      RUNNING 1         onboot, openstack 10.255.255.175, 172.29.239.49                  -    
</span><span class='line'>aio1_neutron_server_container-439aeb90 RUNNING 1         onboot, openstack 10.255.255.137, 172.29.239.13                  -    
</span><span class='line'>aio1_nova_api_container-c83e5ef0       RUNNING 1         onboot, openstack 10.255.255.216, 172.29.236.52                  -    
</span><span class='line'>aio1_rabbit_mq_container-4fd792fb      RUNNING 1         onboot, openstack 10.255.255.2, 172.29.239.62                    -    
</span><span class='line'>aio1_repo_container-b39d88a1           RUNNING 1         onboot, openstack 10.255.255.227, 172.29.237.146                 -    
</span><span class='line'>aio1_utility_container-fff0b6df        RUNNING 1         onboot, openstack 10.255.255.117, 172.29.237.82                  -    
</span><span class='line'>[root@aio1 playbooks]# </span></code></pre></td></tr></table></div></figure>


<h3>Find the correct ip address</h3>

<p>You should see horizon running with netstat</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@aio1 ~]# netstat -pan | grep -i 443
</span><span class='line'>tcp        0      0 172.29.236.100:443      0.0.0.0:*               LISTEN      12908/haproxy       
</span><span class='line'>tcp        0      0 192.168.122.23:443      0.0.0.0:*               LISTEN      12908/haproxy       
</span><span class='line'>unix  3      [ ]         STREAM     CONNECTED     73443    31134/tmux           
</span><span class='line'>unix  2      [ ]         DGRAM                    1244303  23435/rsyslogd       
</span><span class='line'>[root@aio1 ~]# </span></code></pre></td></tr></table></div></figure>


<h2>Logon to the openstack GUI (Horizon)</h2>

<h3>Password&hellip;</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@aio1 ~]# grep keystone_auth_admin_password /etc/openstack_deploy/user_secrets.yml</span></code></pre></td></tr></table></div></figure>


<p><img class="center" src="https://stafwag.github.io/blog/images/openstack-ansible-aio-login.png" width="782" height="723" title="&#34;openstack-ansible-aio-login.png&#34;" alt="&#34;openstack-ansible-aio-login.png&#34;"></p>

<p><strong><em> Have fun </em></strong></p>

<h1>Links</h1>

<ul>
<li><a href="https://docs.openstack.org/openstack-ansible/latest/user/aio/quickstart.html">https://docs.openstack.org/openstack-ansible/latest/user/aio/quickstart.html</a></li>
<li><a href="https://docs.openstack.org/project-deploy-guide/openstack-ansible/queens/deploymenthost.html">https://docs.openstack.org/project-deploy-guide/openstack-ansible/queens/deploymenthost.html</a></li>
<li><a href="https://bugs.launchpad.net/openstack-ansible/+bug/1792050">https://bugs.launchpad.net/openstack-ansible/+bug/1792050</a></li>
<li><a href="https://docs.openstack.org/openstack-ansible-security/latest/auto_controls-all.html">https://docs.openstack.org/openstack-ansible-security/latest/auto_controls-all.html</a></li>
<li><a href="https://blog.christophersmart.com/2016/08/09/setting-up-openstack-ansible-all-in-one-behind-a-proxy/">https://blog.christophersmart.com/2016/08/09/setting-up-openstack-ansible-all-in-one-behind-a-proxy/</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Best Wishes 2019]]></title>
    <link href="https://stafwag.github.io/blog/blog/2019/01/02/best-wishes-2019/"/>
    <updated>2019-01-02T20:36:31+01:00</updated>
    <id>https://stafwag.github.io/blog/blog/2019/01/02/best-wishes-2019</id>
    <content type="html"><![CDATA[<p><a href="https://stafwag.github.io/blog/images/2019.jpg"><img src="https://stafwag.github.io/blog/images/2019.jpg" class="left" width="500" height="511" alt="2019" /> </a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How to Configure DNS-over-TLS on OPNsense]]></title>
    <link href="https://stafwag.github.io/blog/blog/2018/12/09/configure-dns-tls-on-opnsense/"/>
    <updated>2018-12-09T08:11:38+01:00</updated>
    <id>https://stafwag.github.io/blog/blog/2018/12/09/configure-dns-tls-on-opnsense</id>
    <content type="html"><![CDATA[<h1>DNS-over-TLS</h1>

<p>In my <a href="https://stafwag.github.io/blog/blog/2018/09/09/dns-privacy-with-stubby-part1-gnulinux/">previous blog posts</a> we configured <a href="https://dnsprivacy.org/wiki/display/DP/DNS+Privacy+Daemon+-+Stubby">Stubby </a> on GNU/Linux and FreeBSD.</p>

<p><img class="right" src="https://stafwag.github.io/blog/images/Logo_OPNsense.jpg" width="300" height="85" title="&#34;Logo_OPNsense.jpg&#34;" alt="&#34;Logo_OPNsense.jpg&#34;"></p>

<p>In this blog article we&rsquo;ll configure <a href="https://en.wikipedia.org/wiki/DNS_over_TLS">DNS-over-TLS</a> with <a href="https://nlnetlabs.nl/projects/unbound/about/">Unbound</a> on <a href="https://opnsense.org/">OPNsense</a>. Both <a href="https://nlnetlabs.nl/projects/getdns/">Stubby</a> and <a href="https://nlnetlabs.nl/projects/unbound/about/">Unbound</a> are written by <a href="https://nlnet.nl/">NLnet</a>.</p>

<h2>DNS resolvers</h2>

<p>Stubby is a small dns resolver to encrypt your dns traffic, which makes it perfect to increase end-user privacy. Stubby can be integrated into existing dns setups.</p>

<p><a href="http://http://www.thekelleys.org.uk/dnsmasq/doc.html">DNSmasq</a> is small dns resolver that can cache dns queries and forward dns traffic to other dns servers.</p>

<p>Unbound is fast validating, caching DNS resolver that supports DNS-over-TLS.
Unbound or dnsmaq are not full feature dns servers like <a href="https://www.isc.org/downloads/bind/">BIND</a>.</p>

<p>The main difference beteen Unbound and DNSmasq is that Unbound can talk the the <a href="https://www.iana.org/domains/root/servers">root servers</a> directly while dnsmasq always needs to forward your dns queries to another dns server - your ISP dns server or a public dns servicve like (<a href="https://www.quad9.net/">Quad9</a>, <a href="https://1.1.1.1/">cloudfare</a>, <a href="https://developers.google.com/speed/public-dns/">google</a>, &hellip;) -</p>

<p>Unbound has build-in support for DNS-over-TLS. DNSmasq needs an external DNS-over-TLS resolver like Stubby.</p>

<h2>Which one to use?</h2>

<p>It depends - as always -, Stubby can integrating easily in existing dns setups like dnsmasq. Unbound is one package that does it all and is more feature rich compared to DNSmasq.</p>

<h1>OPNsense</h1>

<p>I use <a href="https://opnsense.org/">OPNsense</a> as my firewall. Unbound is the default dns resolver on OPNsense so it makes (OPN)sense to use Unbound.</p>

<h2>Choose your upstream DNS service</h2>

<p>There&rsquo;re a few public DNS providers that supports DNS-over-tls the best known are <a href="https://www.quad9.net/">Quad9</a>, <a href="https://1.1.1.1/">cloudfare</a>. Quad9 will block malicious domains on the default dns servers 9.9.9.9/149.112.112.10 while 9.9.9.10 has no security blocklist.</p>

<p>In this article we&rsquo;ll use Quad9 but you could also with cloudfare or another dns provider that you trust and has support for DNS-over-tls.</p>

<h2>Enable DNS-over-TLS</h2>

<p><a href="https://stafwag.github.io/blog/images/opnsense_enable_dns_tls.png"><img src="https://stafwag.github.io/blog/images/opnsense_enable_dns_tls.png" class="left" width="300" height="458" alt="opnsense_enable_dns_tls.png" /> </a></p>

<p>You need to configure your firewall to use your upstream dns provider. You also want to make sure your isp dns servers aren&rsquo;t used.</p>

<h3>Sniffing</h3>

<p> If you snif the DNS traffic on your firewall <code>tcpdump -i wan_interface udp port 53</code> you&rsquo;ll see that the DNS traffic is unencrypted.</p>

<h3>Configuration</h3>

<p>To enable DNS-over-TLS we&rsquo;ll need to reconfigure unbound.</p>

<p>Go to <strong> [ Services ] -> [Unbound DNS ] -> [General] </strong>
And copy/paste the setting below</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>server:
</span><span class='line'>forward-zone:
</span><span class='line'>name: "."
</span><span class='line'>forward-ssl-upstream: yes
</span><span class='line'>forward-addr: 9.9.9.9@853
</span><span class='line'>forward-addr: 149.112.112.112@853</span></code></pre></td></tr></table></div></figure>


<p>to <strong> Custom options </strong> these settings will reconfigure Unbound to forward the dns for the upstream dns servers Quad9 over ssl.</p>

<h3>Verify</h3>

<p>If you snif the udp  traffic on you firewall  with <code>tcpdump -i wan_interface udp port 53</code> you&rsquo;ll not see any unencrypted traffic anymore - unless not all your clients are configured to use your firewall as the dns server -.</p>

<p>If your snif TCP PORT 853 <code>tcpdump -i vr1 tcp port 853</code> we&rsquo;ll see your encrypted dns-over-tls traffic.</p>

<h2>General DNS settings</h2>

<p>You also want to make sure that your firewall isn&rsquo;t configure to use an unecrypted DNS server.</p>

<p><a href="https://stafwag.github.io/blog/images/opnsense_set_dns.png"><img src="https://stafwag.github.io/blog/images/opnsense_set_dns.png" class="right" width="300" height="693" alt="opnsense_set_dns.png" /> </a></p>

<h3>Configuration</h3>

<p>Go to <strong>[ system ] -> [ settings ] -> [ general ]</strong> and set the dns servers also make sure that <strong> [ ] Allow DNS server list to be overridden by DHCP/PPP on WAN </strong> is unchecked.</p>

<h3>Verify</h3>

<p>You can verify the configuration by logging on to your firewall over ssh and reviewing the contents of /etc/resolv.conf.</p>

<p><strong><em> Have fun! </em></strong></p>

<h1>Links</h1>

<ul>
<li><a href="https://nlnetlabs.nl/projects/unbound/">https://nlnetlabs.nl/projects/unbound/</a></li>
<li><a href="https://forum.opnsense.org/index.php?topic=7814.0">https://forum.opnsense.org/index.php?topic=7814.0</a></li>
<li><a href="https://news.ycombinator.com/item?id=17944423">https://news.ycombinator.com/item?id=17944423</a></li>
<li>[<a href="https://forum.opnsense.org/index.php?topic=9197.msg41265#msg41265">https://forum.opnsense.org/index.php?topic=9197.msg41265#msg41265</a>](<a href="https://forum.opnsense.org/index.php?topic=9197.msg41265#msg41265">https://forum.opnsense.org/index.php?topic=9197.msg41265#msg41265</a></li>
<li><a href="https://www.netgate.com/blog/dns-over-tls-with-pfsense.html">https://www.netgate.com/blog/dns-over-tls-with-pfsense.html</a></li>
<li><a href="https://forum.opnsense.org/index.php?topic=9197.msg41265#msg41265">https://forum.opnsense.org/index.php?topic=9197.msg41265#msg41265</a></li>
<li><a href="https://www.quad9.net/faq/">https://www.quad9.net/faq/</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[DNS Privacy With Stubby (Part 2 FreeBSD)]]></title>
    <link href="https://stafwag.github.io/blog/blog/2018/10/07/dns-privacy-with-stubby-part-2-freebsd/"/>
    <updated>2018-10-07T09:06:05+02:00</updated>
    <id>https://stafwag.github.io/blog/blog/2018/10/07/dns-privacy-with-stubby-part-2-freebsd</id>
    <content type="html"><![CDATA[<h1>FreeBSD</h1>

<p><a href="https://stafwag.github.io/blog/blog/2018/09/09/dns-privacy-with-stubby-part1-gnulinux/">In my previous blog article</a> we install on GNU/Linux which is my main desktop operation system. <a href="https://stafwag.github.io/blog/blog/2012/12/16/running-freebsd-9.0-on-asus-c60m1-i-motherboard/">My NAS</a> and the services that are required to be always running are on <a href="https://www.freebsd.org">FreeBSD</a>.</p>

<p>In this arcticle we will setup Stubby - the DNS Privacy Daemon - on FreeBSD.</p>

<h2>Jails</h2>

<p>FreeBSD jails are verify nice to keep services separated in a secure way.</p>

<h3>ezjail</h3>

<p><a href="https://erdgeist.org/arts/software/ezjail/">ezjail</a> is a very nice tool for managing FreeBSD jails.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # pkg install ezjail</span></code></pre></td></tr></table></div></figure>


<h3>To loopback or not to loopback&hellip;.</h3>

<p>The loopback ip address is mapped to the jail ip address on FreeBSD by default.
There are two options</p>

<ul>
<li>use the jail ip address, make sure that you setup a firewall rule if you want disable traffic from external.</li>
<li>use a cloned loopback interface; keep in mind that with a cloned interface this interface is shared between your jails.</li>
</ul>


<p>We&rsquo;ll use the jail ip address.</p>

<h4>create the jail</h4>

<p>We create a new jail and we assign the cloned loop interface with a loopback ip address - this loopback ip address must be unique for each for each jail - and outside interface and ip address.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # ezjail-admin create stafdns 're0|192.168.1.53'</span></code></pre></td></tr></table></div></figure>


<h4>start the jail</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:/usr/local/etc/ezjail # ezjail-admin start stafdns
</span><span class='line'>Starting jails: stafdns.
</span><span class='line'>/etc/rc.d/jail: WARNING: Per-jail configuration via jail_* variables  is obsolete.  Please consider migrating to /etc/jail.conf.
</span><span class='line'>root@rataplan:/usr/local/etc/ezjail #</span></code></pre></td></tr></table></div></figure>


<h4>console login and install pkg</h4>

<p>Logon to the jail and install pkg we might need to configure a dns server or use a proxy sever to install pkg.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:/usr/local/etc/ezjail # ezjail-admin console stafdns
</span><span class='line'>root@stafdns:~ # echo "nameserver 9.9.9.9" &gt; /etc/resolv.conf
</span><span class='line'>root@stafdns:~ # pkg
</span><span class='line'>The package management tool is not yet installed on your system.
</span><span class='line'>Do you want to fetch and install it now? [y/N]: y
</span><span class='line'>Bootstrapping pkg from pkg+http://pkg.FreeBSD.org/FreeBSD:11:amd64/quarterly, please wait...
</span><span class='line'>Verifying signature with trusted certificate pkg.freebsd.org.2013102301... done
</span><span class='line'>[stafdns] Installing pkg-1.10.5_1...
</span><span class='line'>[stafdns] Extracting pkg-1.10.5_1: 100%
</span><span class='line'>pkg: not enough arguments
</span><span class='line'>Usage: pkg [-v] [-d] [-l] [-N] [-j &lt;jail name or id&gt;|-c &lt;chroot path&gt;|-r &lt;rootdir&gt;] [-C &lt;configuration file&gt;] [-R &lt;repo config dir&gt;] [-o var=value] [-4|-6] &lt;command&gt; [&lt;args&gt;]
</span><span class='line'>
</span><span class='line'>For more information on available commands and options see 'pkg help'.
</span><span class='line'>root@stafdns:~ #
</span></code></pre></td></tr></table></div></figure>


<h2>Install stubby</h2>

<p>Stubby available in the <a href="https://www.freebsd.org/ports/">FreeBSD Ports</a> in the getdns package, &hellip;but it isn&rsquo;t installed when you install the binary package. To install stubby we need to it from source.</p>

<h3>dig</h3>

<p>To debug dns issues dig a handy tool to have&hellip;.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:/usr/ports/dns/getdns # pkg install bind-tools
</span><span class='line'>Updating FreeBSD repository catalogue...
</span><span class='line'>FreeBSD repository is up to date.
</span><span class='line'>All repositories are up to date.
</span><span class='line'>Updating database digests format: 100%
</span><span class='line'>The following 4 package(s) will be affected (of 0 checked):
</span><span class='line'>
</span><span class='line'>New packages to be INSTALLED:
</span><span class='line'>        bind-tools: 9.12.2P1
</span><span class='line'>        idnkit: 1.0_7
</span><span class='line'>        py27-ply: 3.11
</span><span class='line'>        json-c: 0.13
</span><span class='line'>
</span><span class='line'>Number of packages to be installed: 4
</span><span class='line'>
</span><span class='line'>The process will require 42 MiB more space.
</span><span class='line'>4 MiB to be downloaded.
</span><span class='line'>
</span><span class='line'>Proceed with this action? [y/N]: y</span></code></pre></td></tr></table></div></figure>


<h3>Update your ports tree</h3>

<h4>Physical system</h4>

<p>On a physical FreeBSD system execute <code>portsnap fetch</code> and <code>portsnap extract</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # portsnap fetch
</span><span class='line'>Looking up portsnap.FreeBSD.org mirrors... 6 mirrors found.
</span><span class='line'>Fetching snapshot tag from ec2-eu-west-1.portsnap.freebsd.org... done.
</span><span class='line'>Fetching snapshot metadata... done.
</span><span class='line'>Updating from Sat Sep  8 09:31:35 CEST 2018 to Sun Sep  9 09:51:49 CEST 2018.
</span><span class='line'>Fetching 4 metadata patches... done.
</span><span class='line'>Applying metadata patches... done.
</span><span class='line'>Fetching 0 metadata files... done.
</span><span class='line'>Fetching 44 patches. 
</span><span class='line'>(44/44) 100.00%  done.                                
</span><span class='line'>done.
</span><span class='line'>Applying patches... 
</span><span class='line'>done.
</span><span class='line'>Fetching 2 new ports or files... done.
</span><span class='line'>root@rataplan:~ # </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # portsnap extract
</span><span class='line'>/usr/ports/.arcconfig
</span><span class='line'>/usr/ports/.gitattributes
</span><span class='line'>/usr/ports/.gitauthors
</span><span class='line'>/usr/ports/.gitignore
</span><span class='line'>/usr/ports/.gitmessage
</span><span class='line'>/usr/ports/CHANGES
</span><span class='line'>/usr/ports/CONTRIBUTING.md
</span><span class='line'>/usr/ports/COPYRIGHT
</span><span class='line'>/usr/ports/GIDs
</span><span class='line'>/usr/ports/Keywords/desktop-file-utils.ucl
</span><span class='line'>/usr/ports/Keywords/fc.ucl
</span><span class='line'>/usr/ports/Keywords/fcfontsdir.ucl
</span><span class='line'>
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>
</span><span class='line'>/usr/ports/x11/xzoom/
</span><span class='line'>/usr/ports/x11/yad/
</span><span class='line'>/usr/ports/x11/yakuake-kde4/
</span><span class='line'>/usr/ports/x11/yakuake/
</span><span class='line'>/usr/ports/x11/yalias/
</span><span class='line'>/usr/ports/x11/yeahconsole/
</span><span class='line'>/usr/ports/x11/yelp/
</span><span class='line'>/usr/ports/x11/zenity/
</span><span class='line'>Building new INDEX files... done.</span></code></pre></td></tr></table></div></figure>


<h4>Jail</h4>

<p>I use <a href="https://erdgeist.org/arts/software/ezjail/">ezjail</a> to manage my <a href="https://www.freebsd.org/doc/handbook/jails.html">FreeBSD jails</a>. Execute the <code>ezjail-admin update -P</code> to update the ports tree inside your jails.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # ezjail-admin update -P
</span><span class='line'>Looking up portsnap.FreeBSD.org mirrors... 6 mirrors found.
</span><span class='line'>Fetching snapshot tag from ec2-eu-west-1.portsnap.freebsd.org... done.
</span><span class='line'>Ports tree hasn't changed since last snapshot.
</span><span class='line'>No updates needed.
</span><span class='line'>Removing old files and directories... done.
</span><span class='line'>Extracting new files:
</span><span class='line'>/usr/jails/basejail/usr/ports/archivers/py-lz4/
</span><span class='line'>/usr/jails/basejail/usr/ports/astro/wmsolar/
</span><span class='line'>/usr/jails/basejail/usr/ports/audio/musicpd/
</span><span class='line'>/usr/jails/basejail/usr/ports/biology/seaview/
</span><span class='line'>/usr/jails/basejail/usr/ports/deskutils/gsimplecal/
</span><span class='line'>/usr/jails/basejail/usr/ports/deskutils/xfce4-tumbler/
</span><span class='line'>/usr/jails/basejail/usr/ports/devel/eric6/
</span><span class='line'>/usr/jails/basejail/usr/ports/devel/es-eric6/
</span><span class='line'>/usr/jails/basejail/usr/ports/devel/ioncube/
</span><span class='line'>/usr/jails/basejail/usr/ports/devel/liblouis/
</span><span class='line'>/usr/jails/basejail/usr/ports/devel/monodevelop/
</span><span class='line'>/usr/jails/basejail/usr/ports/devel/rudeconfig/
</span><span class='line'>/usr/jails/basejail/usr/ports/emulators/ppsspp-qt5/
</span><span class='line'>/usr/jails/basejail/usr/ports/emulators/ppsspp/
</span><span class='line'>/usr/jails/basejail/usr/ports/german/eric6/
</span><span class='line'>/usr/jails/basejail/usr/ports/java/linux-oracle-jdk10/
</span><span class='line'>/usr/jails/basejail/usr/ports/java/linux-oracle-jre10/
</span><span class='line'>/usr/jails/basejail/usr/ports/java/openjdk8/
</span><span class='line'>/usr/jails/basejail/usr/ports/lang/gcc6-devel/
</span><span class='line'>/usr/jails/basejail/usr/ports/lang/gcc7-devel/
</span><span class='line'>/usr/jails/basejail/usr/ports/lang/gcc8-devel/
</span><span class='line'>/usr/jails/basejail/usr/ports/lang/gcc9-devel/
</span><span class='line'>/usr/jails/basejail/usr/ports/misc/ree/
</span><span class='line'>/usr/jails/basejail/usr/ports/net-im/psi/
</span><span class='line'>/usr/jails/basejail/usr/ports/net-mgmt/p5-Net-SNMP/
</span><span class='line'>/usr/jails/basejail/usr/ports/net/Makefile
</span><span class='line'>/usr/jails/basejail/usr/ports/net/charm/
</span><span class='line'>/usr/jails/basejail/usr/ports/net/linknx/
</span><span class='line'>/usr/jails/basejail/usr/ports/net/py-maxminddb/
</span><span class='line'>/usr/jails/basejail/usr/ports/net/py-shodan/
</span><span class='line'>/usr/jails/basejail/usr/ports/net/tcpreen/
</span><span class='line'>/usr/jails/basejail/usr/ports/ports-mgmt/pkg-devel/
</span><span class='line'>/usr/jails/basejail/usr/ports/print/ghostscript9-agpl-base/
</span><span class='line'>/usr/jails/basejail/usr/ports/russian/eric6/
</span><span class='line'>/usr/jails/basejail/usr/ports/science/Makefile
</span><span class='line'>/usr/jails/basejail/usr/ports/science/metaphysicl/
</span><span class='line'>/usr/jails/basejail/usr/ports/science/namd/
</span><span class='line'>/usr/jails/basejail/usr/ports/security/sancp/
</span><span class='line'>/usr/jails/basejail/usr/ports/security/testssl.sh/
</span><span class='line'>/usr/jails/basejail/usr/ports/textproc/scim-bridge/
</span><span class='line'>/usr/jails/basejail/usr/ports/www/orangehrm/
</span><span class='line'>/usr/jails/basejail/usr/ports/www/smarty3/
</span><span class='line'>/usr/jails/basejail/usr/ports/www/tinytinyhttpd/
</span><span class='line'>/usr/jails/basejail/usr/ports/x11-wm/spectrwm/
</span><span class='line'>/usr/jails/basejail/usr/ports/x11/plasma5-plasma-workspace/
</span><span class='line'>/usr/jails/basejail/usr/ports/x11/sddm/
</span><span class='line'>Building new INDEX files... done.
</span><span class='line'>root@rataplan:~ # </span></code></pre></td></tr></table></div></figure>


<h3>Install stubby</h3>

<p>Go to the getdns ports directory</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/root # cd /usr/ports/dns/getdns/
</span><span class='line'>root@stafproxy:/usr/ports/dns/getdns # make config</span></code></pre></td></tr></table></div></figure>


<p>and run <code>make config</code> select <code>[ ] STUBBY    Build with Stubby DNS/TLS resolver</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>┌─────────────────────────────── getdns-1.4.2 ─────────────────────────────────┐
</span><span class='line'>│ ┌──────────────────────────────────────────────────────────────────────────┐ │
</span><span class='line'>│ │+[x] DOCS      Build and/or install documentation                         │ │
</span><span class='line'>│ │+[ ] LIBEV     Build with libev extension                                 │ │
</span><span class='line'>│ │+[ ] LIBEVENT  Build with libevent extension                              │ │
</span><span class='line'>│ │+[ ] LIBUV     Build with libuv extension                                 │ │
</span><span class='line'>│ │+[x] STUBBY    Build with Stubby DNS/TLS resolver                         │ │
</span><span class='line'>│ └──────────────────────────────────────────────────────────────────────────┘ │
</span><span class='line'>├──────────────────────────────────────────────────────────────────────────────┤
</span><span class='line'>│                       &lt;  OK  &gt;            &lt;Cancel&gt;                           │
</span><span class='line'>└──────────────────────────────────────────────────────────────────────────────┘</span></code></pre></td></tr></table></div></figure>


<p>run <code>make</code> and accept the defaults.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/ports/dns/getdns # make
</span><span class='line'>===&gt;  License BSD3CLAUSE accepted by the user
</span><span class='line'>===&gt;   getdns-1.4.2 depends on file: /usr/local/sbin/pkg - found
</span><span class='line'>=&gt; getdns-1.4.2.tar.gz doesn't seem to exist in /var/ports/distfiles/.
</span><span class='line'>=&gt; Attempting to fetch https://getdnsapi.net/dist/getdns-1.4.2.tar.gz
</span><span class='line'>getdns-1.4.2.tar.gz                           100% of 1034 kB 1092 kBps 00m01s
</span><span class='line'>===&gt; Fetching all distfiles required by getdns-1.4.2 for building
</span><span class='line'>===&gt;  Extracting for getdns-1.4.2
</span><span class='line'>=&gt; SHA256 Checksum OK for getdns-1.4.2.tar.gz.
</span><span class='line'>
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>
</span><span class='line'>/usr/bin/install -c -m 644 getdns_service_sync.3 /var/ports/basejail/usr/ports/dns/getdns/work/stage/usr/local/man/man3
</span><span class='line'>/usr/bin/install -c -m 644 getdns_validate_dnssec.3 /var/ports/basejail/usr/ports/dns/getdns/work/stage/usr/local/man/man3
</span><span class='line'>/usr/bin/strip /var/ports/basejail/usr/ports/dns/getdns/work/stage/usr/local/lib/libgetdns*.so.*
</span><span class='line'>/usr/bin/strip /var/ports/basejail/usr/ports/dns/getdns/work/stage/usr/local/bin/getdns_*
</span><span class='line'>/usr/bin/strip /var/ports/basejail/usr/ports/dns/getdns/work/stage/usr/local/bin/stubby
</span><span class='line'>/bin/mv /var/ports/basejail/usr/ports/dns/getdns/work/stage/usr/local/etc/stubby/stubby.yml  /var/ports/basejail/usr/ports/dns/getdns/work/stage/usr/local/etc/stubby/stubby.yml.sample
</span><span class='line'>====&gt; Compressing man pages (compress-man)
</span><span class='line'>===&gt; Staging rc.d startup script(s)</span></code></pre></td></tr></table></div></figure>


<p>make install</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/ports/dns/getdns # make install
</span><span class='line'>===&gt;  Installing for getdns-1.4.2
</span><span class='line'>===&gt;  Checking if getdns already installed
</span><span class='line'>===&gt;   Registering installation for getdns-1.4.2
</span><span class='line'>[stafproxy] Installing getdns-1.4.2...
</span><span class='line'>***
</span><span class='line'>***  !!! IMPORTANT !!!!  libgetdns needs a DNSSEC trust anchor!
</span><span class='line'>***
</span><span class='line'>***  For the library to be able to perform DNSSEC, the root
</span><span class='line'>***  trust anchor needs to be present in presentation format
</span><span class='line'>***  in the file:
</span><span class='line'>***     /usr/local/etc/unbound/root.key
</span><span class='line'>***
</span><span class='line'>***  We recomend using unbound-anchor to retrieve and install
</span><span class='line'>***  the root trust anchor like this:
</span><span class='line'>***     su -m unbound -c /usr/local/sbin/unbound-anchor
</span><span class='line'>***
</span><span class='line'>
</span><span class='line'>===&gt; SECURITY REPORT: 
</span><span class='line'>      This port has installed the following files which may act as network
</span><span class='line'>      servers and may therefore pose a remote security risk to the system.
</span><span class='line'>/usr/local/lib/libgetdns.a(stub.o)
</span><span class='line'>/usr/local/lib/libgetdns.so.10.0.2
</span><span class='line'>/usr/local/lib/libgetdns.a(server.o)
</span><span class='line'>
</span><span class='line'>      This port has installed the following startup scripts which may cause
</span><span class='line'>      these network services to be started at boot time.
</span><span class='line'>/usr/local/etc/rc.d/stubby
</span><span class='line'>
</span><span class='line'>      If there are vulnerabilities in these programs there may be a security
</span><span class='line'>      risk to the system. FreeBSD makes no guarantee about the security of
</span><span class='line'>      ports included in the Ports Collection. Please type 'make deinstall'
</span><span class='line'>      to deinstall the port if this is a concern.
</span><span class='line'>
</span><span class='line'>      For more information, and contact details about the security
</span><span class='line'>      status of this software, see the following webpage: 
</span><span class='line'>https://getdnsapi.net/
</span><span class='line'>root@stafproxy:/usr/ports/dns/getdns # </span></code></pre></td></tr></table></div></figure>


<p>Lock the package to avoid that the package gets replaced by a getdns package without stubby.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/ports/dns/getdns # pkg lock getdns
</span><span class='line'>getdns-1.4.2: lock this package? [y/N]: y
</span><span class='line'>Locking getdns-1.4.2
</span><span class='line'>root@stafproxy:/usr/ports/dns/getdns # </span></code></pre></td></tr></table></div></figure>


<h2>Configure stubby</h2>

<h3>Enable the stubby service</h3>

<p>Use <code>sysrc</code> to enable the stubby service&hellip;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/local/etc # service stubby start
</span><span class='line'>Cannot 'start' stubby. Set stubby_enable to YES in /etc/rc.conf or use 'onestart' instead of 'start'.
</span><span class='line'>root@stafproxy:/usr/local/etc # service stubby rcvar
</span><span class='line'># stubby
</span><span class='line'>#
</span><span class='line'>stubby_enable="NO"
</span><span class='line'>#   (default: "")
</span><span class='line'>
</span><span class='line'>root@stafproxy:/usr/local/etc # sysrc stubby_enable="YES"
</span><span class='line'>stubby_enable:  -&gt; YES
</span><span class='line'>root@stafproxy:/usr/local/etc # </span></code></pre></td></tr></table></div></figure>


<h3>choose your upstream dns provider</h3>

<p>Edit the stubby.yml file and uncomment the upstream dns server that you want the use. Stubby will loadbalance the dns traffic to all configured upstream dns servers by default. This is configured with the round_robin_upstreams directive, if set to 1 the traffic is loadbalanced, if set 0 stubby will use the first configured dns server.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:/usr/local/etc # vi stubby/stubby.yml</span></code></pre></td></tr></table></div></figure>


<h3>Change the port</h3>

<p>We&rsquo;ll setup dnsmasq to cache our dns requests modify the <code>listen_addresses</code> directive and set the port 53000</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>listen_addresses:
</span><span class='line'>  - 127.0.0.1@53000
</span><span class='line'>  - 0::1@53000</span></code></pre></td></tr></table></div></figure>


<h3>Start it</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/local/etc # service stubby start
</span><span class='line'>Starting stubby.
</span><span class='line'>[07:51:37.865826] STUBBY: Read config from file /usr/local/etc/stubby/stubby.yml
</span><span class='line'>root@stafproxy:/usr/local/etc # </span></code></pre></td></tr></table></div></figure>


<h3>test it</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/root # dig @&lt;ip_of_the_jail&gt; -p 53000 www.wagemakers.be
</span><span class='line'>
</span><span class='line'>; &lt;&lt;&gt;&gt; DiG 9.8.3-P4 &lt;&lt;&gt;&gt; @127.0.0.53 -p 53000 www.wagemakers.be
</span><span class='line'>; (1 server found)
</span><span class='line'>;; global options: +cmd
</span><span class='line'>;; Got answer:
</span><span class='line'>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 56970
</span><span class='line'>;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1
</span><span class='line'>
</span><span class='line'>;; OPT PSEUDOSECTION:
</span><span class='line'>; EDNS: version: 0, flags:; udp: 4096
</span><span class='line'>;; QUESTION SECTION:
</span><span class='line'>;www.wagemakers.be.             IN      A
</span><span class='line'>
</span><span class='line'>;; ANSWER SECTION:
</span><span class='line'>www.wagemakers.be.      85181   IN      CNAME   wagemakers.be.
</span><span class='line'>wagemakers.be.          85181   IN      A       95.215.185.144
</span><span class='line'>
</span><span class='line'>;; Query time: 110 msec
</span><span class='line'>;; SERVER: 127.0.0.53#53000(127.0.0.53)
</span><span class='line'>;; WHEN: Sat Sep 22 13:16:11 2018
</span><span class='line'>;; MSG SIZE  rcvd: 119
</span></code></pre></td></tr></table></div></figure>


<h3>dnsmasq</h3>

<h4>Install dnsmasq.</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/root # pkg install dnsmasq
</span><span class='line'>Updating FreeBSD repository catalogue...
</span><span class='line'>FreeBSD repository is up to date.
</span><span class='line'>All repositories are up to date.
</span><span class='line'>The following 1 package(s) will be affected (of 0 checked):
</span><span class='line'>
</span><span class='line'>New packages to be INSTALLED:
</span><span class='line'>        dnsmasq: 2.79,1
</span><span class='line'>
</span><span class='line'>Number of packages to be installed: 1
</span><span class='line'>
</span><span class='line'>329 KiB to be downloaded.
</span><span class='line'>
</span><span class='line'>Proceed with this action? [y/N]: y
</span><span class='line'>[stafproxy] [1/1] Fetching dnsmasq-2.79,1.txz: 100%  329 KiB 336.4kB/s    00:01
</span><span class='line'>Checking integrity... done (0 conflicting)
</span><span class='line'>[stafproxy] [1/1] Installing dnsmasq-2.79,1...
</span><span class='line'>[stafproxy] [1/1] Extracting dnsmasq-2.79,1: 100%
</span><span class='line'>Message from dnsmasq-2.79,1:
</span><span class='line'>
</span><span class='line'>*** To enable dnsmasq, edit /usr/local/etc/dnsmasq.conf and
</span><span class='line'>*** set dnsmasq_enable="YES" in /etc/rc.conf[.local]
</span><span class='line'>***
</span><span class='line'>*** Further options and actions are documented inside
</span><span class='line'>*** /usr/local/etc/rc.d/dnsmasq
</span><span class='line'>root@stafproxy:/root #</span></code></pre></td></tr></table></div></figure>


<h4>Enable dnsmasq.</h4>

<p>Usae <code>sysrc</code> to enable the dnsmasq service.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/root # sysrc dnsmasq_enable="YES"
</span><span class='line'>dnsmasq_enable:  -&gt; YES
</span><span class='line'>root@stafproxy:/root #</span></code></pre></td></tr></table></div></figure>


<h4>Configure dnsmasq</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/local/etc # mv dnsmasq.conf dnsmasq.conf_org
</span><span class='line'>root@stafproxy:/usr/local/etc # vi dnsmasq.conf</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>server=&lt;ip_address_of_the_jail&gt;#53000
</span><span class='line'>listen-address=&lt;ip_address_of_the_jail&gt;
</span><span class='line'>interface=&lt;netork_interface_of_the_jail&gt;
</span><span class='line'>bind-interfaces</span></code></pre></td></tr></table></div></figure>


<h4>start dnsmasq</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/local/etc # service dnsmasq start
</span><span class='line'>Starting dnsmasq.
</span><span class='line'>root@stafproxy:/usr/local/etc #</span></code></pre></td></tr></table></div></figure>


<h4>test it</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/local/etc # dig @192.168.1.45 www.wagemakers.be
</span><span class='line'>
</span><span class='line'>; &lt;&lt;&gt;&gt; DiG 9.8.3-P4 &lt;&lt;&gt;&gt; @192.168.1.45 www.wagemakers.be
</span><span class='line'>; (1 server found)
</span><span class='line'>;; global options: +cmd
</span><span class='line'>;; Got answer:
</span><span class='line'>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 32987
</span><span class='line'>;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1
</span><span class='line'>
</span><span class='line'>;; OPT PSEUDOSECTION:
</span><span class='line'>; EDNS: version: 0, flags:; udp: 4096
</span><span class='line'>;; QUESTION SECTION:
</span><span class='line'>;www.wagemakers.be.             IN      A
</span><span class='line'>
</span><span class='line'>;; ANSWER SECTION:
</span><span class='line'>www.wagemakers.be.      86000   IN      CNAME   wagemakers.be.
</span><span class='line'>wagemakers.be.          86000   IN      A       95.215.185.144
</span><span class='line'>
</span><span class='line'>;; Query time: 308 msec
</span><span class='line'>;; SERVER: 192.168.1.45#53(192.168.1.45)
</span><span class='line'>;; WHEN: Sun Oct  7 09:16:51 2018
</span><span class='line'>;; MSG SIZE  rcvd: 119
</span><span class='line'>
</span><span class='line'>root@stafproxy:/usr/local/etc #
</span></code></pre></td></tr></table></div></figure>


<h4>Update /etc/resolv.conf</h4>

<p>Update your <code>/etc/resolv.conf</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/local/etc # vi /etc/resolv.conf</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>nameserver &lt;ip_address_of_the_jail&gt;</span></code></pre></td></tr></table></div></figure>


<p>and test it;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/local/etc # dig www.wagemakers.be
</span><span class='line'>
</span><span class='line'>; &lt;&lt;&gt;&gt; DiG 9.8.3-P4 &lt;&lt;&gt;&gt; www.wagemakers.be
</span><span class='line'>;; global options: +cmd
</span><span class='line'>;; Got answer:
</span><span class='line'>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 27629
</span><span class='line'>;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 0
</span><span class='line'>
</span><span class='line'>;; QUESTION SECTION:
</span><span class='line'>;www.wagemakers.be.             IN      A
</span><span class='line'>
</span><span class='line'>;; ANSWER SECTION:
</span><span class='line'>www.wagemakers.be.      85702   IN      CNAME   wagemakers.be.
</span><span class='line'>wagemakers.be.          85702   IN      A       95.215.185.144
</span><span class='line'>
</span><span class='line'>;; Query time: 1 msec
</span><span class='line'>;; SERVER: 192.168.1.45#53(192.168.1.45)
</span><span class='line'>;; WHEN: Sun Oct  7 09:21:49 2018
</span><span class='line'>;; MSG SIZE  rcvd: 78
</span><span class='line'>
</span><span class='line'>root@stafproxy:/usr/local/etc #</span></code></pre></td></tr></table></div></figure>


<p><strong><em> Have fun! </em></strong></p>

<h1>Links</h1>

<ul>
<li><a href="https://stafwag.github.io/blog/blog/2018/09/09/dns-privacy-with-stubby-part1-gnulinux/">https://stafwag.github.io/blog/blog/2018/09/09/dns-privacy-with-stubby-part1-gnulinux/</a></li>
<li><a href="https://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/jails-ezjail.html">https://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/jails-ezjail.html</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[DNS Privacy With Stubby (Part 1 GNU/Linux)]]></title>
    <link href="https://stafwag.github.io/blog/blog/2018/09/09/dns-privacy-with-stubby-part1-gnulinux/"/>
    <updated>2018-09-09T10:30:03+02:00</updated>
    <id>https://stafwag.github.io/blog/blog/2018/09/09/dns-privacy-with-stubby-part1-gnulinux</id>
    <content type="html"><![CDATA[<p><strong><em> Installing and configuring an encrypted dns server is straightforward, there is no reason to use an unencrypted dns service. </em></strong></p>

<h1>DNS is not secure or private</h1>

<p>DNS traffic is insecure and runs over <a href="https://nl.wikipedia.org/wiki/User_Datagram_Protocol">UDP</a> port 53 (<a href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol">TCP</a> for <a href="https://en.wikipedia.org/wiki/DNS_zone_transfer">zone transfers</a> ) unecrypted by default.</p>

<p>This make your unencrypted DNS traffic a <strong>privacy risk</strong> and a <strong>security risk</strong>:</p>

<ul>
<li>anyone that is able to sniff your network traffic can collect a lot information from your leaking DNS traffic.</li>
<li>with a DNS spoofing attack an attacker can trick you let go to malicious website or try to intercept your email traffic.</li>
</ul>


<h1>Encrypt your dns traffic</h1>

<p>Encrypting your network traffic is always a good idea for privacy and security reasons - <strong><em> we encrypt, because we can! </em></strong> -  .
More information about dns privacy can be found at <a href="https://dnsprivacy.org/">https://dnsprivacy.org/</a></p>

<p>On this site you&rsquo;ll find also the <a href="https://dnsprivacy.org/wiki/display/DP/DNS+Privacy+Daemon+-+Stubby">DNS Privacy Daemon - Stubby</a> that let&rsquo;s you send your DNS request over TLS to an alternative DNS provider. You should use a DNS provider that you trust and has a no logging policy.  <a href="https://www.quad9.net/">quad9</a>, <a href="https://www.cloudflare.com/learning/dns/what-is-1.1.1.1/">cloudflare</a> and google dns are well-known alternative dns providers. At <a href="https://dnsprivacy.org/wiki/display/DP/DNS+Privacy+Test+Servers">https://dnsprivacy.org/wiki/display/DP/DNS+Privacy+Test+Servers</a> you can find a few other options.</p>

<p>You&rsquo;ll find my journey to setup Stubby on a few operation systems I use (or I&rsquo;m force to use) below &hellip;</p>

<h1>GNU/Linux</h1>

<h2>Arch Linux</h2>

<p>I use <a href="https://www.archlinux.org/">Arch Linux</a> on my main workstation. Stubby is already in the Arch repositories this make installation straightforward.</p>

<h3>Install stubby</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# pacman -S stubby
</span><span class='line'>resolving dependencies...
</span><span class='line'>looking for conflicting packages...
</span><span class='line'>
</span><span class='line'>Packages (5) fstrm-0.4.0-1  getdns-1.4.2-1  protobuf-c-1.3.0-3  unbound-1.7.3-4
</span><span class='line'>             stubby-0.2.3-1
</span><span class='line'>
</span><span class='line'>Total Download Size:   1.09 MiB
</span><span class='line'>Total Installed Size:  5.68 MiB
</span><span class='line'>
</span><span class='line'>:: Proceed with installation? [Y/n] 
</span><span class='line'>:: Retrieving packages...
</span><span class='line'>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span><span class='line'>                                 Dload  Upload   Total   Spent    Left  Speed
</span><span class='line'>100 88476  100 88476    0     0   403k      0 --:--:-- --:--:-- --:--:--  403k
</span><span class='line'>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span><span class='line'>                                 Dload  Upload   Total   Spent    Left  Speed
</span><span class='line'>100 62480  100 62480    0     0  1271k      0 --:--:-- --:--:-- --:--:-- 1271k
</span><span class='line'>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span><span class='line'>                                 Dload  Upload   Total   Spent    Left  Speed
</span><span class='line'>100  632k  100  632k    0     0   750k      0 --:--:-- --:--:-- --:--:--  749k
</span><span class='line'>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span><span class='line'>                                 Dload  Upload   Total   Spent    Left  Speed
</span><span class='line'>100  302k  100  302k    0     0  1615k      0 --:--:-- --:--:-- --:--:-- 1606k
</span><span class='line'>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span><span class='line'>                                 Dload  Upload   Total   Spent    Left  Speed
</span><span class='line'>100 34052  100 34052    0     0   831k      0 --:--:-- --:--:-- --:--:--  831k
</span><span class='line'>(5/5) checking keys in keyring                       [###########################] 100%
</span><span class='line'>(5/5) checking package integrity                     [###########################] 100%
</span><span class='line'>(5/5) loading package files                          [###########################] 100%
</span><span class='line'>(5/5) checking for file conflicts                    [###########################] 100%
</span><span class='line'>(5/5) checking available disk space                  [###########################] 100%
</span><span class='line'>:: Processing package changes...
</span><span class='line'>(1/5) installing fstrm                               [###########################] 100%
</span><span class='line'>(2/5) installing protobuf-c                          [###########################] 100%
</span><span class='line'>(3/5) installing unbound                             [###########################] 100%
</span><span class='line'>Optional dependencies for unbound
</span><span class='line'>    expat: unbound-anchor [installed]
</span><span class='line'>(4/5) installing getdns                              [###########################] 100%
</span><span class='line'>(5/5) installing stubby                              [###########################] 100%
</span><span class='line'>:: Running post-transaction hooks...
</span><span class='line'>(1/4) Reloading system manager configuration...
</span><span class='line'>(2/4) Creating system user accounts...
</span><span class='line'>(3/4) Creating temporary files...
</span><span class='line'>(4/4) Arming ConditionNeedsUpdate...
</span><span class='line'>[root@vicky ~]# </span></code></pre></td></tr></table></div></figure>


<h4>choose your upstream dns provider</h4>

<p>Edit the stubby.yml file and uncomment the upstream dns server that you want the use.
Stubby will loadbalance the dns traffic to all configured upstream dns servers by default.
This is configured with the <code>round_robin_upstreams</code> directive, if set to <code>1</code> the traffic is loadbalanced, if set <code>0</code> stubby will use the first configured dns server.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ sudo vi /etc/stubby/stubby.yml</span></code></pre></td></tr></table></div></figure>


<h4>enable and start stubby</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# systemctl enable stubby
</span><span class='line'>Created symlink /etc/systemd/system/multi-user.target.wants/stubby.service -&gt; /usr/lib/systemd/system/stubby.service.
</span><span class='line'>[root@vicky ~]# systemctl start stubby
</span><span class='line'>[root@vicky ~]# </span></code></pre></td></tr></table></div></figure>


<h4>test</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# dig @127.0.0.1 www.wagemakers.be
</span><span class='line'>
</span><span class='line'>; &lt;&lt;&gt;&gt; DiG 9.13.2 &lt;&lt;&gt;&gt; @127.0.0.1 www.wagemakers.be
</span><span class='line'>; (1 server found)
</span><span class='line'>;; global options: +cmd
</span><span class='line'>;; Got answer:
</span><span class='line'>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 18226
</span><span class='line'>;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1
</span><span class='line'>
</span><span class='line'>;; OPT PSEUDOSECTION:
</span><span class='line'>; EDNS: version: 0, flags:; udp: 4096
</span><span class='line'>; COOKIE: fe9d3618b821614f174436385b7acb64a4f4cc6657e14626 (good)
</span><span class='line'>;; QUESTION SECTION:
</span><span class='line'>;www.wagemakers.be.             IN      A
</span><span class='line'>
</span><span class='line'>;; ANSWER SECTION:
</span><span class='line'>www.wagemakers.be.      86000   IN      CNAME   wagemakers.be.
</span><span class='line'>wagemakers.be.          86000   IN      A       95.215.185.144
</span><span class='line'>
</span><span class='line'>;; Query time: 128 msec
</span><span class='line'>;; SERVER: 127.0.0.1#53(127.0.0.1)
</span><span class='line'>;; WHEN: Mon Aug 20 16:08:36 CEST 2018
</span><span class='line'>;; MSG SIZE  rcvd: 147
</span><span class='line'>
</span><span class='line'>[root@vicky ~]# </span></code></pre></td></tr></table></div></figure>


<h3>Local dns cache with dnsmasq</h3>

<h4>Change the stubby port.</h4>

<p>Edit /etc/stubby/stubby.yml</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# vi /etc/stubby/stubby.yml</span></code></pre></td></tr></table></div></figure>


<p>And change the port by modifing the <code>listen_addresses</code> directive</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>listen_addresses:
</span><span class='line'>  - 127.0.0.1@53000
</span><span class='line'>  - 0::1@53000</span></code></pre></td></tr></table></div></figure>


<p>restart stubby</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# systemctl restart stubby.service</span></code></pre></td></tr></table></div></figure>


<p>and verify that the dns on 127.0.0.1:53 doesn&rsquo;t work anymore.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# dig @127.0.0.1 www.wagemakers.be
</span><span class='line'>
</span><span class='line'>; &lt;&lt;&gt;&gt; DiG 9.13.2 &lt;&lt;&gt;&gt; @127.0.0.1 www.wagemakers.be
</span><span class='line'>; (1 server found)
</span><span class='line'>;; global options: +cmd
</span><span class='line'>;; connection timed out; no servers could be reached
</span><span class='line'>[root@vicky ~]# </span></code></pre></td></tr></table></div></figure>


<p>ensure that stubby does work on port 53000</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@frija etc]# dig @127.0.0.1 -p 53000 www.wagemakers.be
</span><span class='line'>
</span><span class='line'>; &lt;&lt;&gt;&gt; DiG 9.13.2 &lt;&lt;&gt;&gt; @127.0.0.1 -p 53000 www.wagemakers.be
</span><span class='line'>; (1 server found)
</span><span class='line'>;; global options: +cmd
</span><span class='line'>;; Got answer:
</span><span class='line'>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 27173
</span><span class='line'>;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1
</span><span class='line'>
</span><span class='line'>;; OPT PSEUDOSECTION:
</span><span class='line'>; EDNS: version: 0, flags:; udp: 65535
</span><span class='line'>;; QUESTION SECTION:
</span><span class='line'>;www.wagemakers.be.             IN      A
</span><span class='line'>
</span><span class='line'>;; ANSWER SECTION:
</span><span class='line'>www.wagemakers.be.      43200   IN      CNAME   wagemakers.be.
</span><span class='line'>wagemakers.be.          43200   IN      A       95.215.185.144
</span><span class='line'>
</span><span class='line'>;; Query time: 250 msec
</span><span class='line'>;; SERVER: 127.0.0.1#53000(127.0.0.1)
</span><span class='line'>;; WHEN: Tue Aug 21 13:26:37 CEST 2018
</span><span class='line'>;; MSG SIZE  rcvd: 119
</span><span class='line'>
</span><span class='line'>[root@frija etc]# </span></code></pre></td></tr></table></div></figure>


<h4>Install dnsmasq</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# pacman -S dnsmasq
</span><span class='line'>warning: dnsmasq-2.79-1 is up to date -- reinstalling
</span><span class='line'>resolving dependencies...
</span><span class='line'>looking for conflicting packages...
</span><span class='line'>
</span><span class='line'>Packages (1) dnsmasq-2.79-1
</span><span class='line'>
</span><span class='line'>Total Installed Size:  0.70 MiB
</span><span class='line'>Net Upgrade Size:      0.00 MiB
</span><span class='line'>
</span><span class='line'>:: Proceed with installation? [Y/n] y
</span><span class='line'>(1/1) checking keys in keyring                       [###########################] 100%
</span><span class='line'>(1/1) checking package integrity                     [###########################] 100%
</span><span class='line'>(1/1) loading package files                          [###########################] 100%
</span><span class='line'>(1/1) checking for file conflicts                    [###########################] 100%
</span><span class='line'>(1/1) checking available disk space                  [###########################] 100%
</span><span class='line'>:: Processing package changes...
</span><span class='line'>(1/1) reinstalling dnsmasq                           [###########################] 100%
</span><span class='line'>:: Running post-transaction hooks...
</span><span class='line'>(1/3) Reloading system manager configuration...
</span><span class='line'>(2/3) Creating system user accounts...
</span><span class='line'>(3/3) Arming ConditionNeedsUpdate...
</span><span class='line'>[root@vicky ~]# </span></code></pre></td></tr></table></div></figure>


<h4>Configure dnsmasq</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky etc]# cd /etc
</span><span class='line'>[root@vicky etc]# mv /etc/dnsmasq.conf /etc/dnsmasq.conf_org
</span><span class='line'>[root@vicky etc]# vi dnsmasq.conf</span></code></pre></td></tr></table></div></figure>


<p>It is import to configure stubby to listen the localhost interface only.
If you use Linux KVM you probably have a dns serivce running on your bridge interfaces for your virtual machines.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>server=127.0.0.1#53000
</span><span class='line'>listen-address=127.0.0.1
</span><span class='line'>interface=lo
</span><span class='line'>bind-interfaces</span></code></pre></td></tr></table></div></figure>


<h4>Start and enable dnsmasq</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# systemctl start dnsmasq
</span><span class='line'>[root@vicky ~]# systemctl enable dnsmasq
</span><span class='line'>Created symlink /etc/systemd/system/multi-user.target.wants/dnsmasq.service -&gt; /usr/lib/systemd/system/dnsmasq.service.
</span><span class='line'>[root@vicky ~]# </span></code></pre></td></tr></table></div></figure>


<h4>Reconfigure your system</h4>

<p>reconfigure your system to use dnsmasq as the dns service.</p>

<p>I use <a href="https://wiki.archlinux.org/index.php/Netctl">netctl</a> on my system. You can update the network configuration with <code>netctl</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky netctl]# netctl edit &lt;network_name&gt;
</span><span class='line'>[root@vicky netctl]# netctl restart  &lt;network_name&gt;</span></code></pre></td></tr></table></div></figure>


<p>If you networkmanager you can use <code>nmcli</code>, <code>nmtui</code> or the GUI network configuration in your desktop environment.</p>

<h2>GNU/Linux is GNU/Linux</h2>

<p>The configuration on other GNU/Linux distributions is the same as on Arch apart from the installation process.
The same method can be use if your (favorite) Linux distribution doesn&rsquo;t have a stubby package, the installation method of the required package will be different of course.</p>

<h3>Debian</h3>

<h4>Current testing release Debian &ldquo;buster&rdquo;</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt install stubby dnsmasq</span></code></pre></td></tr></table></div></figure>


<h4>Current stable Debian 9 &ldquo;strech&rdquo;</h4>

<p>Stubby in the <code>getdns-utils</code> in Debian stretch, it&rsquo;s an older version.
Therefor I ended up with building stubby from the source code.</p>

<h5>Install the required packages</h5>

<p>Install the required packages to build stubby.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@stretch:~/github$ sudo apt install build-essential git libtool autoconf libssl-dev libyaml-dev</span></code></pre></td></tr></table></div></figure>


<h5>git clone</h5>

<p>The getdns git repo;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@stretch:~/github$ git clone https://github.com/getdnsapi/getdns.git
</span><span class='line'>Cloning into 'getdns'...
</span><span class='line'>remote: Counting objects: 16154, done.
</span><span class='line'>remote: Total 16154 (delta 0), reused 0 (delta 0), pack-reused 16154
</span><span class='line'>Receiving objects: 100% (16154/16154), 9.72 MiB | 1.13 MiB/s, done.
</span><span class='line'>Resolving deltas: 100% (12413/12413), done.
</span><span class='line'>staf@stretch:~/github$ </span></code></pre></td></tr></table></div></figure>


<h5>checkout the latest stable release</h5>

<p>Verify the lastest release tag. The current stable release 1.4.2</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@stretch:~/github/getdns$ git tag
</span><span class='line'>TNW2015
</span><span class='line'>list
</span><span class='line'>v0.1.0
</span><span class='line'>v0.1.1
</span><span class='line'>v0.1.2
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>v1.4.0
</span><span class='line'>v1.4.0-rc1
</span><span class='line'>v1.4.1
</span><span class='line'>v1.4.1-rc1
</span><span class='line'>v1.4.2
</span><span class='line'>v1.4.2-rc1
</span><span class='line'>staf@stretch:~/github/getdns$ </span></code></pre></td></tr></table></div></figure>


<p>checkout the latest stable release.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@stretch:~/github/getdns$ git checkout v1.4.2
</span><span class='line'>Note: checking out 'v1.4.2'.
</span><span class='line'>
</span><span class='line'>You are in 'detached HEAD' state. You can look around, make experimental
</span><span class='line'>changes and commit them, and you can discard any commits you make in this
</span><span class='line'>state without impacting any branches by performing another checkout.
</span><span class='line'>
</span><span class='line'>If you want to create a new branch to retain commits you create, you may
</span><span class='line'>do so (now or later) by using -b with the checkout command again. Example:
</span><span class='line'>
</span><span class='line'>  git checkout -b &lt;new-branch-name&gt;
</span><span class='line'>
</span><span class='line'>HEAD is now at e481273... Last minute update
</span><span class='line'>staf@stretch:~/github/getdns$ </span></code></pre></td></tr></table></div></figure>


<h5>build it&hellip;</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@stretch:~/github/getdns$ git submodule update --init
</span><span class='line'>staf@stretch:~/github/getdns$ libtoolize -ci
</span><span class='line'>staf@stretch:~/github/getdns$ autoreconf -fi
</span><span class='line'>staf@stretch:~/github/getdns$ mkdir build
</span><span class='line'>staf@stretch:~/github/getdns$ cd build/
</span><span class='line'>staf@stretch:~/github/getdns/build$ ../configure --prefix=/usr/local --without-libidn --without-libidn2 --enable-stub-only --with-stubby
</span><span class='line'>staf@stretch:~/github/getdns/build$ make</span></code></pre></td></tr></table></div></figure>


<h5>make install</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@stretch:~/github/getdns/build$ sudo make install
</span><span class='line'>[sudo] password for staf: 
</span><span class='line'>cd src && make install
</span><span class='line'>make[1]: Entering directory '/home/staf/github/getdns/build/src'
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>make[1]: Leaving directory '/home/staf/github/getdns/build/doc'
</span><span class='line'>***
</span><span class='line'>***  !!! IMPORTANT !!!!
</span><span class='line'>***
</span><span class='line'>***  From release 1.2.0, getdns comes with built-in DNSSEC
</span><span class='line'>***  trust anchor management.  External trust anchor management,
</span><span class='line'>***  for example with unbound-anchor, is no longer necessary
</span><span class='line'>***  and no longer recommended.
</span><span class='line'>***
</span><span class='line'>***  Previously installed trust anchors, in the default location -
</span><span class='line'>***
</span><span class='line'>***        /usr/local/etc/unbound/getdns-root.key
</span><span class='line'>***
</span><span class='line'>***  - will be preferred and used for DNSSEC validation, however
</span><span class='line'>***  getdns will fallback to trust-anchors obtained via built-in
</span><span class='line'>***  trust anchor management when the anchors from the default
</span><span class='line'>***  location fail to validate the root DNSKEY rrset.
</span><span class='line'>***
</span><span class='line'>***  To prevent expired DNSSEC trust anchors to be used for
</span><span class='line'>***  validation, we strongly recommend removing the trust anchors
</span><span class='line'>***  on the default location when there is no active external
</span><span class='line'>***  trust anchor management keeping it up-to-date.
</span><span class='line'>***
</span><span class='line'>staf@stretch:~/github/getdns/build$ sudo make install</span></code></pre></td></tr></table></div></figure>


<h5>systemd service</h5>

<p>Stubby comes with a systemd service definition. Copy it to the correct location.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@stretch:~/github/getdns/build$ cd ..
</span><span class='line'>staf@stretch:~/github/getdns$ cd stubby/systemd/
</span><span class='line'>staf@stretch:~/github/getdns/stubby/systemd$ sudo cp stubby.service /lib/systemd/system/</span></code></pre></td></tr></table></div></figure>


<p>Update the path to /usr/local</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@stretch:~/github/getdns/stubby/systemd$ sudo vi /lib/systemd/system/stubby.service</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[Unit]
</span><span class='line'>Description=stubby DNS resolver
</span><span class='line'>
</span><span class='line'>[Service]
</span><span class='line'>User=stubby
</span><span class='line'>DynamicUser=yes
</span><span class='line'>CacheDirectory=stubby
</span><span class='line'>WorkingDirectory=/var/cache/stubby
</span><span class='line'>ExecStart=/usr/local/bin/stubby
</span><span class='line'>AmbientCapabilities=CAP_NET_BIND_SERVICE
</span><span class='line'>CapabilityBoundingSet=CAP_NET_BIND_SERVICE
</span><span class='line'>
</span><span class='line'>[Install]
</span><span class='line'>WantedBy=multi-user.target</span></code></pre></td></tr></table></div></figure>


<p>And create the stubby working directory</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stretch:~# mkdir /var/cache/stubby</span></code></pre></td></tr></table></div></figure>


<h4>ldconfig</h4>

<p>update your library cache</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@stretch:~/github/getdns/stubby/systemd$ sudo ldconfig -v</span></code></pre></td></tr></table></div></figure>


<h4>Update the configuration</h4>

<p>Edit the stubby.yml configuration file.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@stretch:~/github/getdns/stubby/systemd$ sudo nvi /usr/local/etc/stubby/stubby.yml</span></code></pre></td></tr></table></div></figure>


<p>Update the port where stubby will listen to and select the upstream dns service you want to use.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>listen_addresses:
</span><span class='line'>  - 127.0.0.1@53000
</span><span class='line'>  - 0::1@53000</span></code></pre></td></tr></table></div></figure>


<h4>start and test</h4>

<p>Start stubby&hellip;.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@stretch:~/github/getdns/stubby/systemd$ sudo systemctl list-unit-files | grep -i stubby
</span><span class='line'>stubby.service                              disabled
</span><span class='line'>staf@stretch:~/github/getdns/stubby/systemd$ sudo systemctl enable stubby
</span><span class='line'>Created symlink /etc/systemd/system/multi-user.target.wants/stubby.service /lib/systemd/system/stubby.service.
</span><span class='line'>staf@stretch:~/github/getdns/stubby/systemd$ sudo systemctl start stubby
</span><span class='line'>staf@stretch:~/github/getdns/stubby/systemd$ </span></code></pre></td></tr></table></div></figure>


<p>and test it</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stretch:~# dig @127.0.0.1 -p 53000 www.wagemakers.be
</span><span class='line'>
</span><span class='line'>; &lt;&lt;&gt;&gt; DiG 9.10.3-P4-Debian &lt;&lt;&gt;&gt; @127.0.0.1 -p 53000 www.wagemakers.be
</span><span class='line'>; (1 server found)
</span><span class='line'>;; global options: +cmd
</span><span class='line'>;; Got answer:
</span><span class='line'>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 17510
</span><span class='line'>;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1
</span><span class='line'>
</span><span class='line'>;; OPT PSEUDOSECTION:
</span><span class='line'>; EDNS: version: 0, flags:; udp: 4096
</span><span class='line'>;; QUESTION SECTION:
</span><span class='line'>;www.wagemakers.be.             IN      A
</span><span class='line'>
</span><span class='line'>;; ANSWER SECTION:
</span><span class='line'>www.wagemakers.be.      49704   IN      CNAME   wagemakers.be.
</span><span class='line'>wagemakers.be.          81815   IN      A       95.215.185.144
</span><span class='line'>
</span><span class='line'>;; Query time: 72 msec
</span><span class='line'>;; SERVER: 127.0.0.1#53000(127.0.0.1)
</span><span class='line'>;; WHEN: Sun Sep 02 10:33:53 CEST 2018
</span><span class='line'>;; MSG SIZE  rcvd: 119
</span><span class='line'>
</span><span class='line'>root@stretch:~# </span></code></pre></td></tr></table></div></figure>


<h4>dnsmasq</h4>

<p>Install dnsmasq</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stretch:/etc# apt-get install dnsmasq</span></code></pre></td></tr></table></div></figure>


<p>Configure dnsmasq</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stretch:/etc# mv dnsmasq.conf dnsmasq.conf_org
</span><span class='line'>root@stretch:/etc# vi dnsmasq.conf</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>server=127.0.0.1#53000
</span><span class='line'>listen-address=127.0.0.1
</span><span class='line'>interface=lo
</span><span class='line'>bind-interfaces</span></code></pre></td></tr></table></div></figure>


<p>Enable and start it&hellip;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stretch:/etc# systemctl enable dnsmasq
</span><span class='line'>Synchronizing state of dnsmasq.service with SysV service script with /lib/systemd/systemd-sysv-install.
</span><span class='line'>Executing: /lib/systemd/systemd-sysv-install enable dnsmasq
</span><span class='line'>root@stretch:/etc# systemctl restart dnsmasq</span></code></pre></td></tr></table></div></figure>


<p>Verify</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stretch:/etc# dig @127.0.0.1 www.wagemakers.be
</span><span class='line'>
</span><span class='line'>; &lt;&lt;&gt;&gt; DiG 9.10.3-P4-Debian &lt;&lt;&gt;&gt; @127.0.0.1 www.wagemakers.be
</span><span class='line'>; (1 server found)
</span><span class='line'>;; global options: +cmd
</span><span class='line'>;; Got answer:
</span><span class='line'>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 57295
</span><span class='line'>;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1
</span><span class='line'>
</span><span class='line'>;; OPT PSEUDOSECTION:
</span><span class='line'>; EDNS: version: 0, flags:; udp: 4096
</span><span class='line'>;; QUESTION SECTION:
</span><span class='line'>;www.wagemakers.be.             IN      A
</span><span class='line'>
</span><span class='line'>;; ANSWER SECTION:
</span><span class='line'>www.wagemakers.be.      48645   IN      CNAME   wagemakers.be.
</span><span class='line'>wagemakers.be.          80756   IN      A       95.215.185.144
</span><span class='line'>
</span><span class='line'>;; Query time: 72 msec
</span><span class='line'>;; SERVER: 127.0.0.1#53(127.0.0.1)
</span><span class='line'>;; WHEN: Sun Sep 02 10:51:32 CEST 2018
</span><span class='line'>;; MSG SIZE  rcvd: 119
</span><span class='line'>
</span><span class='line'>root@stretch:/etc# </span></code></pre></td></tr></table></div></figure>


<p>reconfigure you system to use dnsmasq&hellip;.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stretch:/etc# nvi resolv.conf</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>nameserver 127.0.0.1</span></code></pre></td></tr></table></div></figure>


<p><strong><em>Have fun!</em></strong></p>

<h2>Links</h2>

<ul>
<li><a href="https://dnsprivacy.org">https://dnsprivacy.org</a></li>
<li><a href="https://wiki.archlinux.org/index.php/Stubby">https://wiki.archlinux.org/index.php/Stubby</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Migrate a Windows Vmware Virtual Machine to Linux KVM]]></title>
    <link href="https://stafwag.github.io/blog/blog/2018/07/01/migrate-a-windows-vmware-vrtual-machine-to-kvm/"/>
    <updated>2018-07-01T10:49:41+02:00</updated>
    <id>https://stafwag.github.io/blog/blog/2018/07/01/migrate-a-windows-vmware-vrtual-machine-to-kvm</id>
    <content type="html"><![CDATA[<p><a href="https://www.linux-kvm.org">Linux KVM</a> is getting more and more useable for desktop virtualization thanks to the the <a href="https://www.linux-kvm.org/page/Virtio">virtio</a> and <a href="https://www.linux-kvm.org/page/SPICE">QXL/SPICE</a> drivers.</p>

<p>Most Linux distributes have the virtio &amp; QXL drivers you might need to install the spice-vdagent.</p>

<p>On Windows you can download and install the virtio and QXL drivers.</p>

<p>Using the virtio drivers will improve your guest system performance and your virtualization experience.</p>

<h2>Convert the disk image</h2>

<h3>merge the vmware disk images&hellip;</h3>

<p>If you use split disk images on vmware ( or vmware player ) migrate them to a single disk images with the vmware-vdiskmanager command.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vmware-vdiskmanager -r mywin.vmdk -t 0 /tmp/mywin._combined.vmdk
</span><span class='line'>Creating disk '/var/lib/libvirt/images/tmp/mywin._combined.vmdk'
</span><span class='line'>  Convert: 100% done.
</span><span class='line'>Virtual disk conversion successful.
</span><span class='line'>$</span></code></pre></td></tr></table></div></figure>


<h3>convert the vmdk  image to qcow2</h3>

<p>Convert the VMDK disk image to qcow2</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky vboxes]$ qemu-img convert -f vmdk -O qcow2 mywin._combined.vmdk mywin.qcow2</span></code></pre></td></tr></table></div></figure>


<h3>mv</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky vboxes]$ sudo mv mywin_combined.qcow2 /var/lib/libvirt/images/
</span><span class='line'>[sudo] password for staf: 
</span></code></pre></td></tr></table></div></figure>


<h2>Import the disk image to KVM</h2>

<p>We&rsquo;ll inport the disk image with <code>virt-install</code> it&rsquo;s also posible to import the images with <code>virt-manager</code> if you prefer a graphical interface or or just being lazy :-)</p>

<h2>Available os options</h2>

<p>To list the supported operation system you can use the <code>osinfo-query os</code> command</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ osinfo-query os | head
</span><span class='line'> Short ID             | Name                                               | Version  | ID                                      
</span><span class='line'>----------------------+----------------------------------------------------+----------+-----------------------------------------
</span><span class='line'> alpinelinux3.5       | Alpine Linux 3.5                                   | 3.5      | http://alpinelinux.org/alpinelinux/3.5  
</span><span class='line'> alpinelinux3.6       | Alpine Linux 3.6                                   | 3.6      | http://alpinelinux.org/alpinelinux/3.6  
</span><span class='line'> alpinelinux3.7       | Alpine Linux 3.7                                   | 3.7      | http://alpinelinux.org/alpinelinux/3.7  
</span><span class='line'> altlinux1.0          | Mandrake RE Spring 2001                            | 1.0      | http://altlinux.org/altlinux/1.0        
</span><span class='line'> altlinux2.0          | ALT Linux 2.0                                      | 2.0      | http://altlinux.org/altlinux/2.0        
</span><span class='line'> altlinux2.2          | ALT Linux 2.2                                      | 2.2      | http://altlinux.org/altlinux/2.2        
</span><span class='line'> altlinux2.4          | ALT Linux 2.4                                      | 2.4      | http://altlinux.org/altlinux/2.4        
</span><span class='line'> altlinux3.0          | ALT Linux 3.0                                      | 3.0      | http://altlinux.org/altlinux/3.0        </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ osinfo-query os |  grep -i windows
</span><span class='line'> win1.0               | Microsoft Windows 1.0                              | 1.0      | http://microsoft.com/win/1.0            
</span><span class='line'> win10                | Microsoft Windows 10                               | 10.0     | http://microsoft.com/win/10             
</span><span class='line'> win2.0               | Microsoft Windows 2.0                              | 2.0      | http://microsoft.com/win/2.0            
</span><span class='line'> win2.1               | Microsoft Windows 2.1                              | 2.1      | http://microsoft.com/win/2.1            
</span><span class='line'> win2k                | Microsoft Windows 2000                             | 5.0      | http://microsoft.com/win/2k             
</span><span class='line'> win2k12              | Microsoft Windows Server 2012                      | 6.3      | http://microsoft.com/win/2k12           
</span><span class='line'> win2k12r2            | Microsoft Windows Server 2012 R2                   | 6.3      | http://microsoft.com/win/2k12r2         
</span><span class='line'> win2k16              | Microsoft Windows Server 2016                      | 10.0     | http://microsoft.com/win/2k16           
</span><span class='line'> win2k3               | Microsoft Windows Server 2003                      | 5.2      | http://microsoft.com/win/2k3            
</span><span class='line'> win2k3r2             | Microsoft Windows Server 2003 R2                   | 5.2      | http://microsoft.com/win/2k3r2          
</span><span class='line'> win2k8               | Microsoft Windows Server 2008                      | 6.0      | http://microsoft.com/win/2k8            
</span><span class='line'> win2k8r2             | Microsoft Windows Server 2008 R2                   | 6.1      | http://microsoft.com/win/2k8r2          
</span><span class='line'> win3.1               | Microsoft Windows 3.1                              | 3.1      | http://microsoft.com/win/3.1            
</span><span class='line'> win7                 | Microsoft Windows 7                                | 6.1      | http://microsoft.com/win/7              
</span><span class='line'> win8                 | Microsoft Windows 8                                | 6.2      | http://microsoft.com/win/8              
</span><span class='line'> win8.1               | Microsoft Windows 8.1                              | 6.3      | http://microsoft.com/win/8.1            
</span><span class='line'> win95                | Microsoft Windows 95                               | 4.0      | http://microsoft.com/win/95             
</span><span class='line'> win98                | Microsoft Windows 98                               | 4.1      | http://microsoft.com/win/98             
</span><span class='line'> winme                | Microsoft Windows Millennium Edition               | 4.9      | http://microsoft.com/win/me             
</span><span class='line'> winnt3.1             | Microsoft Windows NT Server 3.1                    | 3.1      | http://microsoft.com/winnt/3.1          
</span><span class='line'> winnt3.5             | Microsoft Windows NT Server 3.5                    | 3.5      | http://microsoft.com/winnt/3.5          
</span><span class='line'> winnt3.51            | Microsoft Windows NT Server 3.51                   | 3.51     | http://microsoft.com/winnt/3.51         
</span><span class='line'> winnt4.0             | Microsoft Windows NT Server 4.0                    | 4.0      | http://microsoft.com/winnt/4.0          
</span><span class='line'> winvista             | Microsoft Windows Vista                            | 6.0      | http://microsoft.com/win/vista          
</span><span class='line'> winxp                | Microsoft Windows XP                               | 5.1      | http://microsoft.com/win/xp             
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h3>import</h3>

<p>We need to import the disk image as IDE device since we don&rsquo;t have the virtio driver in our windows disk image (yet).</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# virt-install --name "mywin" --ram 8192 --cpu host --os-variant win10 --vcpu 8 --disk /var/lib/libvirt/images/mywin_combined.qcow2,bus=ide --network bridge=virbr0 --import
</span><span class='line'>
</span><span class='line'>Starting install...
</span><span class='line'>
</span><span class='line'>(virt-viewer:3361): GSpice-WARNING **: 16:49:26.546: Warning no automount-inhibiting implementation available
</span></code></pre></td></tr></table></div></figure>


<h2>Install the virtio drivers and QXL graphics drivers</h2>

<h3>Get them&hellip;</h3>

<h4>Type of virtio drivers</h4>

<p>The following virtio windows drivers are available.</p>

<ul>
<li>block (disk drivers)</li>
<li>network</li>
<li>baloon ((dynamic memory management)</li>
</ul>


<p>The fedoraproject provides pre compiled iso images containig all the virtio drivers and installation images for
windows XP.</p>

<h4>ISO contents</h4>

<ul>
<li>NetKVM/ - Virtio network driver</li>
<li>viostor/ - Virtio block driver</li>
<li>vioscsi/ - Virtio Small Computer System Interface (SCSI) driver</li>
<li>viorng/ - Virtio RNG driver</li>
<li>vioser/ - Virtio serial driver</li>
<li>Balloon/ - Virtio memory balloon driver</li>
<li>qxl/ - QXL graphics driver for Windows 7 and earlier. (build virtio-win-0.1.103-1 and later)</li>
<li>qxldod/ - QXL graphics driver for Windows 8 and later. (build virtio-win-0.1.103-2 and later)</li>
<li>pvpanic/ - QEMU pvpanic device driver (build virtio-win-0.1.103-2 and later)</li>
<li>guest-agent/ - QEMU Guest Agent 32bit and 64bit MSI installers</li>
<li>qemupciserial/ - QEMU PCI serial device driver</li>
<li>*.vfd VFD floppy images for using during install of Windows XP</li>
</ul>


<h4>Download</h4>

<p>The virtio windows driver images are available from
<a href="https://docs.fedoraproject.org/quick-docs/en-US/creating-windows-virtual-machines-using-virtio-drivers.html">https://docs.fedoraproject.org/quick-docs/en-US/creating-windows-virtual-machines-using-virtio-drivers.html</a></p>

<p>I use arch linux and download virtio-win AUR package with pacaur. You can download the images directly or use the installation packages for your Linux distribution.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ pacaur -S virtio-win
</span><span class='line'>:: Package virtio-win not found in repositories, trying AUR...
</span><span class='line'>:: resolving dependencies...
</span><span class='line'>:: looking for inter-conflicts...
</span><span class='line'>
</span><span class='line'>AUR Packages  (1) virtio-win-0.1.149.2-1  
</span><span class='line'>
</span><span class='line'>:: Proceed with installation? [Y/n] 
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>  -&gt; Compressing package...
</span><span class='line'>==&gt; Leaving fakeroot environment.
</span><span class='line'>==&gt; Finished making: virtio-win 0.1.149.2-1 (Sat Jun 16 20:00:22 2018)
</span><span class='line'>==&gt; Cleaning up...
</span><span class='line'>:: Installing virtio-win package(s)...
</span><span class='line'>loading packages...
</span><span class='line'>resolving dependencies...
</span><span class='line'>looking for conflicting packages...
</span><span class='line'>
</span><span class='line'>Packages (1) virtio-win-0.1.149.2-1
</span><span class='line'>
</span><span class='line'>Total Installed Size:  314.84 MiB
</span><span class='line'>
</span><span class='line'>:: Proceed with installation? [Y/n] 
</span><span class='line'>(1/1) checking keys in keyring                                         [#######################################] 100%
</span><span class='line'>(1/1) checking package integrity                                       [#######################################] 100%
</span><span class='line'>(1/1) loading package files                                            [#######################################] 100%
</span><span class='line'>(1/1) checking for file conflicts                                      [#######################################] 100%
</span><span class='line'>(1/1) checking available disk space                                    [#######################################] 100%
</span><span class='line'>:: Processing package changes...
</span><span class='line'>(1/1) installing virtio-win                                            [#######################################] 100%
</span><span class='line'>Optional dependencies for virtio-win
</span><span class='line'>    qemu [installed]
</span><span class='line'>:: Running post-transaction hooks...
</span><span class='line'>(1/1) Arming ConditionNeedsUpdate...
</span><span class='line'>[staf@vicky ~]$ ls -l /var/li</span></code></pre></td></tr></table></div></figure>


<p>This install virtio images to <code>/usr/share/virtio/</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$  ls -l /usr/share/virtio/
</span><span class='line'>total 321308
</span><span class='line'>-rw-r--r-- 1 root root 324233216 Jun 16 19:58 virtio-win.iso
</span><span class='line'>-rw-r--r-- 1 root root   2949120 Jun 16 19:58 virtio-win_x86_32.vfd
</span><span class='line'>-rw-r--r-- 1 root root   2949120 Jun 16 19:58 virtio-win_x86_64.vfd
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<p><code>virtio-win.iso</code> is the ISO cdrom image containing all the drivers.</p>

<h2>Installation</h2>

<h3>mount the iso image</h3>

<p><img src="https://stafwag.github.io/blog/images/virto_windows_install/mount_cdrom_000.png" width="816" height="689" title="&#34;mount_cdrom_000.png&#34;" alt="&#34;mount_cdrom_000.png&#34;"></p>

<p>Make sure that the cdrom is mounted in windows.</p>

<p><img src="https://stafwag.github.io/blog/images/virto_windows_install/cdrom_mounted_000.png" width="798" height="605" title="&#34;mount_cdrom_000.png&#34;" alt="&#34;mount_cdrom_000.png&#34;"></p>

<h3>Install</h3>

<h4>Open Device Manager</h4>

<p>Open device Manager in the control panel or type <code>devmgmt.msc</code> on the command prompt.</p>

<p><img src="https://stafwag.github.io/blog/images/virto_windows_install/devmgmt_msc_000.png" width="835" height="728" title="&#34;mount_cdrom_000.png&#34;" alt="&#34;mount_cdrom_000.png&#34;"></p>

<h4>Update the drivers</h4>

<ul>
<li>balloon, the balloon driver affects the PCI device</li>
<li>vioserial, affects the PCI simple communication controler</li>
<li>NetKVM, the network driver affects the Network adapters.</li>
<li>viostor, the block driver affects the Disk drives.</li>
</ul>


<h5>Update the PCI drivers</h5>

<p>In windows 10 the <strong>PCI device</strong> and the <strong>PCI Simple Communications Controller</strong> have the missing driver icon.
Right click on the <strong>PCI device</strong> and select <strong>update driver</strong> -> click on <strong>Browse my computer for driver software</strong>
Specify the cdrom as the search location and click <strong>Next</strong>, this will install the Balloon driver.</p>

<p>Do the same for the <strong>PCI Simple Communications Controller</strong> this will install the &ldquo;VirtIO Serial Driver&rdquo;</p>

<p><img src="https://stafwag.github.io/blog/images/virto_windows_install/update_pci_000.png" width="790" height="586" title="&#34;update_pci_000.png&#34;" alt="&#34;update_pci_000.png&#34;">
<img src="https://stafwag.github.io/blog/images/virto_windows_install/update_pci_001.png" width="792" height="594" title="&#34;update_pci_001.png&#34;" alt="&#34;update_pci_001.png&#34;">
<img src="https://stafwag.github.io/blog/images/virto_windows_install/update_pci_002.png" width="792" height="577" title="&#34;update_pci_002.png&#34;" alt="&#34;update_pci_002.png&#34;">
<img src="https://stafwag.github.io/blog/images/virto_windows_install/update_pci_003.png" width="788" height="578" title="&#34;update_pci_003.png&#34;" alt="&#34;update_pci_003.png&#34;"></p>

<h5>install the VioStor driver</h5>

<p>Add a temporary disk to the virtual machine and use <strong>VirtIO</strong> as the <strong>Bus Type</strong>
In the <strong>Device Manager</strong> you&rsquo;ll get a new device <strong>SCSI Controller</strong> right click it and update the driver.
This will install the <strong>Red Hat VirtIO SCSI controller</strong></p>

<p><img src="https://stafwag.github.io/blog/images/virto_windows_install/install_viostor_000.png" width="552" height="567" title="&#34;install_viostor_000.png&#34;" alt="&#34;install_viostor_000.png&#34;">
<img src="https://stafwag.github.io/blog/images/virto_windows_install/install_viostor_001.png" width="786" height="576" title="&#34;install_viostor_001.png&#34;" alt="&#34;install_viostor_001.png&#34;">
<img src="https://stafwag.github.io/blog/images/virto_windows_install/install_viostor_002.png" width="622" height="461" title="&#34;install_viostor_002.png&#34;" alt="&#34;install_viostor_002.png&#34;"></p>

<p>Go to the device settings of your virtual machine and change the <strong>Disk bus</strong> to <strong>VirtIO</strong>
and shutdown you virtual machine.</p>

<p><img src="https://stafwag.github.io/blog/images/virto_windows_install/install_viostor_003.png" width="705" height="689" title="&#34;install_viostor_003.png&#34;" alt="&#34;install_viostor_003.png&#34;"></p>

<p>You can remove the temporary disk now or leave it if you can find some use for it&hellip;</p>

<p>Make sure that you disk is selected as the bootable device.</p>

<p><img src="https://stafwag.github.io/blog/images/virto_windows_install/install_viostor_004.png" width="885" height="689" title="&#34;install_viostor_004.png&#34;" alt="&#34;install_viostor_004.png&#34;"></p>

<p>Start the virtual machine and make sure that the system is bootable.</p>

<h6>install the netKVM driver</h6>

<p>Update the <strong>Device model</strong> to <strong>virtio</strong>.</p>

<p><img src="https://stafwag.github.io/blog/images/virto_windows_install/use_virtio_net_000.png" width="699" height="689" title="&#34;use_virtio_net_000.png&#34;" alt="&#34;use_virtio_net_000.png&#34;"></p>

<p>Start <code>devmgmt.msc</code> and update the driver as we did before&hellip;.</p>

<p><img src="https://stafwag.github.io/blog/images/virto_windows_install/install_netkvm_000.png" width="809" height="737" title="&#34;install_netkvm_000.png&#34;" alt="&#34;install_netkvm_000.png&#34;">
<img src="https://stafwag.github.io/blog/images/virto_windows_install/install_netkvm_001.png" width="788" height="586" title="&#34;install_netkvm_001.png&#34;" alt="&#34;install_netkvm_001.png&#34;"></p>

<p>And verify that you network card works correctly.</p>

<p><img src="https://stafwag.github.io/blog/images/virto_windows_install/install_netkvm_002.png" width="902" height="645" title="&#34;install_netkvm_002.png&#34;" alt="&#34;install_netkvm_002.png&#34;"></p>

<h6>install the QXL graphical driver</h6>

<p>Update the <strong>Microsoft Basic Display Adapter</strong></p>

<p><img src="https://stafwag.github.io/blog/images/virto_windows_install/install_qxl_000.png" width="792" height="581" title="&#34;install_qxl_000.png&#34;" alt="&#34;install_qxl_000.png&#34;">
<img src="https://stafwag.github.io/blog/images/virto_windows_install/install_qxl_001.png" width="788" height="582" title="&#34;install_qxl_001.png&#34;" alt="&#34;install_qxl_001.png&#34;">
<img src="https://stafwag.github.io/blog/images/virto_windows_install/install_qxl_002.png" width="863" height="597" title="&#34;install_qxl_002.png&#34;" alt="&#34;install_qxl_002.png&#34;"></p>

<p>After the installation you can change the the display resolution.</p>

<p><img src="https://stafwag.github.io/blog/images/virto_windows_install/install_qxl_003.png" width="812" height="651" title="&#34;install_qxl_003.png&#34;" alt="&#34;install_qxl_003.png&#34;"></p>

<p>If you want to use higher screen resolutions you need to <a href="https://stafwag.github.io/blog/blog/2018/04/22/high-screen-resolution-on-a-kvm-virtual-machine-with-qxl/">increase the video ram</a></p>

<p><strong><em>Have fun!</em></strong></p>

<h2>Links</h2>

<ul>
<li><a href="https://raymii.org/s/articles/virt-install_introduction_and_copy_paste_distro_install_commands.html">https://raymii.org/s/articles/virt-install_introduction_and_copy_paste_distro_install_commands.html</a></li>
<li><a href="http://bart.vanhauwaert.org/hints/installing-win10-on-KVM.html">http://bart.vanhauwaert.org/hints/installing-win10-on-KVM.html</a></li>
<li><a href="https://docs.fedoraproject.org/quick-docs/en-US/creating-windows-virtual-machines-using-virtio-drivers.html">https://docs.fedoraproject.org/quick-docs/en-US/creating-windows-virtual-machines-using-virtio-drivers.html</a></li>
<li><a href="https://pve.proxmox.com/wiki/Windows_VirtIO_Drivers">https://pve.proxmox.com/wiki/Windows_VirtIO_Drivers</a></li>
<li><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/virtualization_host_configuration_and_guest_installation_guide/form-virtualization_host_configuration_and_guest_installation_guide-para_virtualized_drivers-mounting_the_image_with_virt_manager">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/virtualization_host_configuration_and_guest_installation_guide/form-virtualization_host_configuration_and_guest_installation_guide-para_virtualized_drivers-mounting_the_image_with_virt_manager</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Nested Virtualization in KVM]]></title>
    <link href="https://stafwag.github.io/blog/blog/2018/06/04/nested-virtualization-in-kvm/"/>
    <updated>2018-06-04T19:58:06+02:00</updated>
    <id>https://stafwag.github.io/blog/blog/2018/06/04/nested-virtualization-in-kvm</id>
    <content type="html"><![CDATA[<h2>KVM</h2>

<p><a href="https://www.linux-kvm.org">Kernel-based Virtual Machine (KVM)</a> has become the defacto hypervisor on GNU/Linux systems it works with great performance as it utilizes the CPU virtualization extensions <a href="https://en.wikipedia.org/wiki/X86_virtualization#Intel_virtualization_(VT-x)">Inetl VT-x</a> or <a href="https://en.wikipedia.org/wiki/X86_virtualization#AMD_virtualization_(AMD-V)">AMD-V</a>). KVM doesn&rsquo;t emulate hardware but uses <a href="https://www.qemu.org/">QEMU</a> for this.</p>

<h2>Nested Virtual guest</h2>

<p>It&rsquo;s possible to use nested virtualization this make it possible to run a hypervisor inside a KVM virtual machine.</p>

<h2>Enabling nested virtualization in KVM</h2>

<h3>Verify</h3>

<p>To verify if nested virtualization is enabled on your system can check /sys/module/kvm_intel/parameters/nested on Intal systems or /sys/module/kvm_amd/parameters/nested</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@frija ~]$ cat /sys/module/kvm_intel/parameters/nested
</span><span class='line'>N
</span><span class='line'>[staf@frija ~]$ </span></code></pre></td></tr></table></div></figure>


<h3>Enable</h3>

<h4>Shutdown all virtual machines</h4>

<p>Make sure that there no virtual machines running.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@frija ~]# virsh 
</span><span class='line'>Welcome to virsh, the virtualization interactive terminal.
</span><span class='line'>
</span><span class='line'>Type:  'help' for help with commands
</span><span class='line'>       'quit' to quit
</span><span class='line'>
</span><span class='line'>virsh # list
</span><span class='line'> Id    Name                           State
</span><span class='line'>----------------------------------------------------
</span><span class='line'>
</span><span class='line'>virsh # </span></code></pre></td></tr></table></div></figure>


<p></p>

<h4>Unload KVM</h4>

<p>Unload the KVM kernel module.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@frija ~]# modprobe -r kvm_intel
</span><span class='line'>[root@frija ~]# </span></code></pre></td></tr></table></div></figure>


<h4>Load KVM and activate nested</h4>

<p>Reload the KVM with the nested feature enabled.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@frija ~]# modprobe kvm_intel nested=1
</span><span class='line'>[root@frija ~]# </span></code></pre></td></tr></table></div></figure>


<p>Verify</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@frija ~]# cat /sys/module/kvm_intel/parameters/nested
</span><span class='line'>Y
</span><span class='line'>[root@frija ~]# </span></code></pre></td></tr></table></div></figure>


<p>To enable the nested feature permanently create /etc/modprobe.d/kvm_intel.conf</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@frija ~]# vi /etc/modprobe.d/kvm_intel.conf</span></code></pre></td></tr></table></div></figure>


<p>and enable the nested option.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>options kvm_intel nested=1</span></code></pre></td></tr></table></div></figure>


<h2>Enabling nested virtialization in the virtual machine</h2>

<p>When you logon to a virtual machine and verify the virtualization extensions on the cpu the flags aren&rsquo;t available.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@centos7 ~]$ cat /proc/cpuinfo | grep  -i -E "vmx|svm"
</span><span class='line'>[staf@centos7 ~]$ </span></code></pre></td></tr></table></div></figure>


<p>To enable nested virtualization in a vritual machine you can</p>

<ul>
<li>start <code>virsh</code> and and edit the the virtual machine and change the CPU line to <code>&lt;cpu mode='host-model' check='partial'/&gt;</code></li>
<li>Open virt-manager and select <strong>Copy host CPU configuration</strong> on the CPU configuration</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@frija ~]# virsh 
</span><span class='line'>Welcome to virsh, the virtualization interactive terminal.
</span><span class='line'>
</span><span class='line'>Type:  'help' for help with commands
</span><span class='line'>       'quit' to quit
</span><span class='line'>
</span><span class='line'>virsh # list
</span><span class='line'> Id    Name                           State
</span><span class='line'>----------------------------------------------------
</span><span class='line'> 1     centos7.0                      running
</span><span class='line'>
</span><span class='line'>virsh # edit centos7.0 </span></code></pre></td></tr></table></div></figure>


<p>Change the cpu settings</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  &lt;features&gt;
</span><span class='line'>    &lt;acpi/&gt;
</span><span class='line'>    &lt;apic/&gt;
</span><span class='line'>    &lt;vmport state='off'/&gt;
</span><span class='line'>  &lt;/features&gt;
</span><span class='line'>  &lt;cpu mode='host-model' check='partial'&gt;
</span><span class='line'>    &lt;model fallback='allow'/&gt;
</span><span class='line'>  &lt;/cpu&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Shutdown the virtual machine</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>virsh # reboot centos7.0 
</span><span class='line'>Domain centos7.0 is being rebooted
</span><span class='line'>
</span><span class='line'>virsh # 
</span></code></pre></td></tr></table></div></figure>


<p>Start the virtual machine</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>virsh # start centos7.0  
</span><span class='line'>Domain centos7.0 started</span></code></pre></td></tr></table></div></figure>


<p>Verify that the <code>feature policies</code> on the cpu are updated.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>virsh # dumpxml centos7.0 </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> &lt;cpu mode='custom' match='exact' check='full'&gt;
</span><span class='line'>    &lt;model fallback='forbid'&gt;Haswell-noTSX-IBRS&lt;/model&gt;
</span><span class='line'>    &lt;vendor&gt;Intel&lt;/vendor&gt;
</span><span class='line'>    &lt;feature policy='require' name='vme'/&gt;
</span><span class='line'>    &lt;feature policy='require' name='ss'/&gt;
</span><span class='line'>    &lt;feature policy='require' name='f16c'/&gt;
</span><span class='line'>    &lt;feature policy='require' name='rdrand'/&gt;
</span><span class='line'>    &lt;feature policy='require' name='hypervisor'/&gt;
</span><span class='line'>    &lt;feature policy='require' name='arat'/&gt;
</span><span class='line'>    &lt;feature policy='require' name='tsc_adjust'/&gt;
</span><span class='line'>    &lt;feature policy='require' name='xsaveopt'/&gt;
</span><span class='line'>    &lt;feature policy='require' name='pdpe1gb'/&gt;
</span><span class='line'>    &lt;feature policy='require' name='abm'/&gt;
</span><span class='line'>    &lt;feature policy='require' name='ibpb'/&gt;
</span><span class='line'> &lt;/cpu&gt;</span></code></pre></td></tr></table></div></figure>


<p>Logon to the virtual machine and verify the cpu flags;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@centos7 ~]$ cat /proc/cpuinfo | grep -i vmx
</span><span class='line'>flags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss syscall nx pdpe1gb rdtscp lm constant_tsc rep_good nopl xtopology eagerfpu pni pclmulqdq vmx ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm tpr_shadow vnmi flexpriority ept vpid fsgsbase tsc_adjust bmi1 avx2 smep bmi2 erms invpcid xsaveopt ibpb ibrs arat spec_ctrl
</span><span class='line'>flags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss syscall nx pdpe1gb rdtscp lm constant_tsc rep_good nopl xtopology eagerfpu pni pclmulqdq vmx ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm tpr_shadow vnmi flexpriority ept vpid fsgsbase tsc_adjust bmi1 avx2 smep bmi2 erms invpcid xsaveopt ibpb ibrs arat spec_ctrl
</span><span class='line'>[staf@centos7 ~]$ cat /proc/cpuinfo | grep  -i "vmx|svm"
</span><span class='line'>[staf@centos7 ~]$ cat /proc/cpuinfo | grep  -i -E "vmx|svm"
</span><span class='line'>flags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss syscall nx pdpe1gb rdtscp lm constant_tsc rep_good nopl xtopology eagerfpu pni pclmulqdq vmx ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm tpr_shadow vnmi flexpriority ept vpid fsgsbase tsc_adjust bmi1 avx2 smep bmi2 erms invpcid xsaveopt ibpb ibrs arat spec_ctrl
</span><span class='line'>flags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss syscall nx pdpe1gb rdtscp lm constant_tsc rep_good nopl xtopology eagerfpu pni pclmulqdq vmx ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm tpr_shadow vnmi flexpriority ept vpid fsgsbase tsc_adjust bmi1 avx2 smep bmi2 erms invpcid xsaveopt ibpb ibrs arat spec_ctrl</span></code></pre></td></tr></table></div></figure>


<p>Execute the <code>virt-host-validate</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@centos7 ~]$ virt-host-validate
</span><span class='line'>  QEMU: Checking for hardware virtualization                                 : PASS
</span><span class='line'>  QEMU: Checking if device /dev/kvm exists                                   : PASS
</span><span class='line'>  QEMU: Checking if device /dev/kvm is accessible                            : PASS
</span><span class='line'>  QEMU: Checking if device /dev/vhost-net exists                             : PASS
</span><span class='line'>  QEMU: Checking if device /dev/net/tun exists                               : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'memory' controller support                      : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'memory' controller mount-point                  : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'cpu' controller support                         : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'cpu' controller mount-point                     : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'cpuacct' controller support                     : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'cpuacct' controller mount-point                 : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'cpuset' controller support                      : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'cpuset' controller mount-point                  : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'devices' controller support                     : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'devices' controller mount-point                 : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'blkio' controller support                       : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'blkio' controller mount-point                   : PASS
</span><span class='line'>  QEMU: Checking for device assignment IOMMU support                         : WARN (No ACPI DMAR table found, IOMMU either disabled in BIOS or not supported by this hardware platform)
</span><span class='line'>   LXC: Checking for Linux &gt;= 2.6.26                                         : PASS
</span><span class='line'>   LXC: Checking for namespace ipc                                           : PASS
</span><span class='line'>   LXC: Checking for namespace mnt                                           : PASS
</span><span class='line'>   LXC: Checking for namespace pid                                           : PASS
</span><span class='line'>   LXC: Checking for namespace uts                                           : PASS
</span><span class='line'>   LXC: Checking for namespace net                                           : PASS
</span><span class='line'>   LXC: Checking for namespace user                                          : PASS
</span><span class='line'>   LXC: Checking for cgroup 'memory' controller support                      : PASS
</span><span class='line'>   LXC: Checking for cgroup 'memory' controller mount-point                  : PASS
</span><span class='line'>   LXC: Checking for cgroup 'cpu' controller support                         : PASS
</span><span class='line'>   LXC: Checking for cgroup 'cpu' controller mount-point                     : PASS
</span><span class='line'>   LXC: Checking for cgroup 'cpuacct' controller support                     : PASS
</span><span class='line'>   LXC: Checking for cgroup 'cpuacct' controller mount-point                 : PASS
</span><span class='line'>   LXC: Checking for cgroup 'cpuset' controller support                      : PASS
</span><span class='line'>   LXC: Checking for cgroup 'cpuset' controller mount-point                  : PASS
</span><span class='line'>   LXC: Checking for cgroup 'devices' controller support                     : PASS
</span><span class='line'>   LXC: Checking for cgroup 'devices' controller mount-point                 : PASS
</span><span class='line'>   LXC: Checking for cgroup 'blkio' controller support                       : PASS
</span><span class='line'>   LXC: Checking for cgroup 'blkio' controller mount-point                   : PASS
</span><span class='line'>   LXC: Checking if device /sys/fs/fuse/connections exists                   : FAIL (Load the 'fuse' module to enable /proc/ overrides)
</span><span class='line'>[staf@centos7 ~]$ </span></code></pre></td></tr></table></div></figure>


<p><strong><em>Have fun</em></strong></p>

<h2>Links</h2>

<ul>
<li><a href="https://docs.fedoraproject.org/quick-docs/en-US/using-nested-virtualization-in-kvm.html"><a href="https://docs.fedoraproject.org/quick-docs/en-US/using-nested-virtualization-in-kvm.html">https://docs.fedoraproject.org/quick-docs/en-US/using-nested-virtualization-in-kvm.html</a></a></li>
<li><a href="https://wiki.archlinux.org/index.php/KVM#Nested_virtualization"><a href="https://wiki.archlinux.org/index.php/KVM#Nested_virtualization">https://wiki.archlinux.org/index.php/KVM#Nested_virtualization</a></a></li>
<li><a href="https://www.linux-kvm.org/page/Nested_Guests"><a href="https://www.linux-kvm.org/page/Nested_Guests">https://www.linux-kvm.org/page/Nested_Guests</a></a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[32 Bits Matters!]]></title>
    <link href="https://stafwag.github.io/blog/blog/2018/05/11/32-bits-matters/"/>
    <updated>2018-05-11T09:08:17+02:00</updated>
    <id>https://stafwag.github.io/blog/blog/2018/05/11/32-bits-matters</id>
    <content type="html"><![CDATA[<p><img class="right" src="https://stafwag.github.io/blog/images/32bits_opnsense.jpg" width="500" height="411" title="&#34;32bits_opnsense.jpg&#34;" alt="&#34;32bits_opnsense.jpg&#34;"></p>

<h3>pfsense 2.3</h3>

<p>My firewall is a <a href="https://pcengines.ch/">pcengines</a> <a href="https://pcengines.ch/alix2d13.htm">alix</a>.</p>

<p>It was running <a href="https://www.pfsense.org">pfsense</a> and was quite happy about it. Pfsense dropped support for 32 bits in their <a href="https://doc.pfsense.org/index.php/Does_pfSense_support_64_bit_systems">pfsense 2.4 release</a>.</p>

<p>This would left me with a unsupported firewall which was one of the reasons to use pfsense instead of a closed source commercial router.</p>

<p>I could have moved to a new firewall like the <a href="https://pcengines.ch/apu.htm">pcengines apu</a> but there is no reason to replace hardware that works fine.</p>

<p>The nice thing about opensource software is that we&rsquo;ve options to choose from if software doesn&rsquo;t match your usecase we&rsquo;ve other options to choose from.</p>

<h3>OPNsense</h3>

<p>So I decided to give <a href="https://opnsense.org/">opnsense</a> a try. OPNsense is a fork of pfsense, both are a fork of <a href="https://m0n0.ch/wall/index.php">m0n0wall</a>.</p>

<p><img class="left" src="https://stafwag.github.io/blog/images/opnsense_swapspace.png" width="500" height="584" title="&#34;opnsense_swapspace.png&#34;" alt="&#34;opnsense_swapspace.png&#34;"></p>

<h4>swapspace</h4>

<p>My firewall only has 256 MB of memory which is a bit low even for a firewall.</p>

<p>The OPNsense developers made it very easy to add swapspace from the GUI. To add swap space go to [ System ] > [ Miscellaneous ] and activate the [ Add a 2 GB swap file to the system ] checkbox.</p>

<p>I&rsquo;m verify satisfied with the upgrade from pfsense to OPNsense, OPNsense has a new release very month which is nice to get the latest security updates and it&rsquo;s possible to audit the systems for security updates from the GUI.</p>

<p><img class="right" src="https://stafwag.github.io/blog/images/duckdns_icon.png" width="150" height="150" title="&#34;duckdns&#34;" alt="&#34;duckdns&#34;"></p>

<h3>DuckDns</h3>

<p>I move my ADSL with a fixed ip address to a VDSL line with a dynamic ip address so I was looking a good free dynamic dns provider and settled with <a href="https://www.duckdns.org/">duckdns</a>.</p>

<p><strong><em> Have fun </em></strong></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How to Start DLM Monitoring on a VDSL Line in Belgium]]></title>
    <link href="https://stafwag.github.io/blog/blog/2018/04/27/how-to-start-dlm-monitoring-on-a-vdsl-line-in-belgium/"/>
    <updated>2018-04-27T12:28:55+02:00</updated>
    <id>https://stafwag.github.io/blog/blog/2018/04/27/how-to-start-dlm-monitoring-on-a-vdsl-line-in-belgium</id>
    <content type="html"><![CDATA[<p>In Belgium/Flanders we have two main internet line providers;</p>

<ul>
<li><a href="https://www.telnet.be">telenet</a> the cablenet network provider.</li>
<li><a href="https://www.proximus.be">proximus</a> is the telephone network provider.</li>
</ul>


<p>On telephone network there are alternative internet providers but they use the network
of proximus.</p>

<p>I switched my internet connection from ADSL to VDSL and switched to a new provider ( <a href="https://www.edpnet.be">edpnet</a>).
The internet speed was below the expectations and my modem reported errors on the line. After fixing the internal phone cabbeling in my appartment I wanted the retrigger the <a href="https://www.edpnet.be/en/support/ordering/internet/what-is-dlm-(dynamic-line-management).html">DLM</a> monitoring.</p>

<p>The process is explained in the this post <a href="https://userbase.be/forum/viewtopic.php?t=48767"><a href="https://userbase.be/forum/viewtopic.php?t=48767">https://userbase.be/forum/viewtopic.php?t=48767</a></a> at <a href="https://userbase.be">usebase.be</a></p>

<p>To start the DLM monitoring in Belgium you need to call 0800 22 424 and type in your line number. If you don&rsquo;t have a proximus phone number the line number is not the same as your phone number. To get your line number you need to connect an analog phone to our line and call 1924 this will read aloud your line number.</p>

<p><strong><em> Have fun </em></strong></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[High Screen Resolution on a KVM Virtual Machine With QXL]]></title>
    <link href="https://stafwag.github.io/blog/blog/2018/04/22/high-screen-resolution-on-a-kvm-virtual-machine-with-qxl/"/>
    <updated>2018-04-22T10:04:46+02:00</updated>
    <id>https://stafwag.github.io/blog/blog/2018/04/22/high-screen-resolution-on-a-kvm-virtual-machine-with-qxl</id>
    <content type="html"><![CDATA[<p>When you create an new virtual KVM virtual system the video ram is limited to 16MB by default to use a higer screen resolution you need
to increase the video ram. The available resolution reported by the virtual screen may also not include the resolution that you want to
utilize.</p>

<p>You&rsquo;ll find my journey to enable higher screen resolutions in my KVM (qemu) virtual systems below.</p>

<h2>Ubuntu 16.04</h2>

<p>There is an issue with Ubuntu 16.04 and the latest HWE kernel <a href="https://wiki.ubuntu.com/Kernel/LTSEnablementStack"><a href="https://wiki.ubuntu.com/Kernel/LTSEnablementStack">https://wiki.ubuntu.com/Kernel/LTSEnablementStack</a></a>. Even a full HD resultion (1920 x 1080 ) if you have the latest HWE kernel on your system.</p>

<p>To resolve this issue your can uninstall the latest kernel or install the LTS kernel.</p>

<h4>Install the LTS Kernel</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@ubuntu:~$ sudo apt-get install linux-generic-lts-xenial
</span><span class='line'>Reading package lists... Done
</span><span class='line'>Building dependency tree       
</span><span class='line'>Reading state information... Done
</span><span class='line'>The following additional packages will be installed:
</span><span class='line'>  linux-generic linux-headers-4.4.0-119 linux-headers-4.4.0-119-generic linux-headers-generic
</span><span class='line'>  linux-image-4.4.0-119-generic linux-image-extra-4.4.0-119-generic linux-image-generic
</span><span class='line'>Suggested packages:
</span><span class='line'>  fdutils linux-doc-4.4.0 | linux-source-4.4.0 linux-tools
</span><span class='line'>The following NEW packages will be installed:
</span><span class='line'>  linux-generic linux-generic-lts-xenial linux-headers-4.4.0-119 linux-headers-4.4.0-119-generic
</span><span class='line'>  linux-headers-generic linux-image-4.4.0-119-generic linux-image-extra-4.4.0-119-generic linux-image-generic
</span><span class='line'>0 upgraded, 8 newly installed, 0 to remove and 0 not upgraded.
</span><span class='line'>Need to get 69,3 MB of archives.
</span><span class='line'>After this operation, 301 MB of additional disk space will be used.
</span><span class='line'>Do you want to continue? [Y/n] 
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>Setting up linux-image-generic (4.4.0.119.125) ...
</span><span class='line'>Setting up linux-headers-4.4.0-119 (4.4.0-119.143) ...
</span><span class='line'>Setting up linux-headers-4.4.0-119-generic (4.4.0-119.143) ...
</span><span class='line'>Setting up linux-headers-generic (4.4.0.119.125) ...
</span><span class='line'>Setting up linux-generic (4.4.0.119.125) ...
</span><span class='line'>Setting up linux-generic-lts-xenial (4.4.0.119.125) ...
</span><span class='line'>staf@ubuntu:~$ </span></code></pre></td></tr></table></div></figure>


<h4>Remove the HWE kernel</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@ubuntu:~$ sudo apt-get purge linux-image-4.13*
</span><span class='line'>Reading package lists... Done
</span><span class='line'>Building dependency tree       
</span><span class='line'>Reading state information... Done
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>done
</span><span class='line'>The link /vmlinuz.old is a damaged link
</span><span class='line'>Removing symbolic link vmlinuz.old 
</span><span class='line'> you may need to re-run your boot loader[grub]
</span><span class='line'>The link /initrd.img.old is a damaged link
</span><span class='line'>Removing symbolic link initrd.img.old 
</span><span class='line'> you may need to re-run your boot loader[grub]
</span><span class='line'>Purging configuration files for linux-image-4.13.0-38-generic (4.13.0-38.43~16.04.1) ...
</span><span class='line'>Examining /etc/kernel/postrm.d .
</span><span class='line'>run-parts: executing /etc/kernel/postrm.d/initramfs-tools 4.13.0-38-generic /boot/vmlinuz-4.13.0-38-generic
</span><span class='line'>run-parts: executing /etc/kernel/postrm.d/zz-update-grub 4.13.0-38-generic /boot/vmlinuz-4.13.0-38-generic</span></code></pre></td></tr></table></div></figure>


<h4>Cleanup</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@ubuntu:~$ sudo apt autoremove
</span><span class='line'>Reading package lists... Done
</span><span class='line'>Building dependency tree       
</span><span class='line'>Reading state information... Done
</span><span class='line'>The following packages will be REMOVED:
</span><span class='line'>  linux-headers-4.13.0-36 linux-headers-4.13.0-36-generic linux-headers-generic-hwe-16.04
</span><span class='line'>0 upgraded, 0 newly installed, 3 to remove and 0 not upgraded.
</span><span class='line'>After this operation, 83,1 MB disk space will be freed.
</span><span class='line'>Do you want to continue? [Y/n] 
</span><span class='line'>(Reading database ... 234149 files and directories currently installed.)
</span><span class='line'>Removing linux-headers-4.13.0-36-generic (4.13.0-36.40~16.04.1) ...
</span><span class='line'>Removing linux-headers-4.13.0-36 (4.13.0-36.40~16.04.1) ...
</span><span class='line'>Removing linux-headers-generic-hwe-16.04 (4.13.0.38.57) ...
</span><span class='line'>staf@ubuntu:~$ </span></code></pre></td></tr></table></div></figure>


<h4>Reboot</h4>

<p>After a reboot higher resolutions are possible on ubuntu 16.04</p>

<h1>Increase the video RAM</h1>

<h2>Required video ram</h2>

<p>When you create a new KVM virtual machine it has 16MB of video RAM.
Below you&rsquo;ll the calculation for the required video RAM for a 4k resolution ( 3840 x 2160 ).</p>

<p>3840 x 2160 = 8294400 <br/>
8294400 x 32 = 265420800 <br/ >
265420800 / 8 = 33177600 <br />
33177600 / (1024*1024) = 31.640625 MB</p>

<p>So 32 MB video ram is enough for a 4k resolution, to take some overhead into account we&rsquo;ll increase the video ram to 64 MB.</p>

<h2>list the domains</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[swagemakers@staflaptop ~]$ sudo virsh
</span><span class='line'>Welcome to virsh, the virtualization interactive terminal.
</span><span class='line'>
</span><span class='line'>Type:  'help' for help with commands
</span><span class='line'>       'quit' to quit
</span><span class='line'>
</span><span class='line'>virsh # list --all
</span><span class='line'> Id    Name                           State
</span><span class='line'>----------------------------------------------------
</span><span class='line'> -     centos7.0                      shut off
</span><span class='line'> -     debian                         shut off
</span><span class='line'> -     fedora27                       shut off
</span><span class='line'>
</span><span class='line'>virsh # </span></code></pre></td></tr></table></div></figure>


<h4>edit the domain settings</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>virsh # edit --domain debian</span></code></pre></td></tr></table></div></figure>


<h5>update the memory settings</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;video&gt;
</span><span class='line'>  &lt;model type='qxl' ram='65536' vram='65536' vgamem='16384' heads='1' primary='yes'/&gt;
</span><span class='line'>  &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x0'/&gt;
</span><span class='line'>&lt;/video&gt;
</span><span class='line'>&lt;redirdev bus='usb' type='spicevmc'&gt;
</span></code></pre></td></tr></table></div></figure>


<p>to</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;video&gt;
</span><span class='line'>  &lt;model type='qxl' ram='65536' vram='65536' vgamem='65536' heads='1' primary='yes'/&gt;
</span><span class='line'>  &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x0'/&gt;
</span><span class='line'>&lt;/video&gt;</span></code></pre></td></tr></table></div></figure>


<h4>xrandr</h4>

<p>Even with the additional RAM higer resolution aren&rsquo;t possible (yet), the virtual screen doesn&rsquo;t report the higer screen resolution. It&rsquo;s possible to add the higher screen resolution with xrandr.</p>

<h5>display current settings</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@debian:~$ xrandr 
</span><span class='line'>Screen 0: minimum 320 x 200, current 1920 x 1080, maximum 8192 x 8192
</span><span class='line'>Virtual-0 connected primary 1920x1080+0+0 0mm x 0mm
</span><span class='line'>   1024x768      59.95 +
</span><span class='line'>   1920x1200     59.95  
</span><span class='line'>   1920x1080     60.00* 
</span><span class='line'>   1600x1200     59.95  
</span><span class='line'>   1680x1050     60.00  
</span><span class='line'>   1400x1050     60.00  
</span><span class='line'>   1280x1024     59.95  
</span><span class='line'>   1440x900      59.99  
</span><span class='line'>   1280x960      59.99  
</span><span class='line'>   1280x854      59.95  
</span><span class='line'>   1280x800      59.96  
</span><span class='line'>   1280x720      59.97  
</span><span class='line'>   1152x768      59.95  
</span><span class='line'>   800x600       59.96  
</span><span class='line'>   848x480       59.94  
</span><span class='line'>   720x480       59.94  
</span><span class='line'>   640x480       59.94  
</span><span class='line'>Virtual-1 disconnected
</span><span class='line'>Virtual-2 disconnected
</span><span class='line'>Virtual-3 disconnected
</span><span class='line'>staf@debian:~$ </span></code></pre></td></tr></table></div></figure>


<h6>get the modeline</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@debian:~$ cvt 2560 1440 
</span><span class='line'># 2560x1440 59.96 Hz (CVT 3.69M9) hsync: 89.52 kHz; pclk: 312.25 MHz
</span><span class='line'>Modeline "2560x1440_60.00"  312.25  2560 2752 3024 3488  1440 1443 1448 1493 -hsync +vsync
</span><span class='line'>staf@debian:~$ </span></code></pre></td></tr></table></div></figure>


<h6># create the new mode line</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@debian:~$ xrandr --newmode "2560x1440_60.00"  312.25  2560 2752 3024 3488  1440 1443 1448 1493 -hsync +vsync
</span><span class='line'>staf@debian:~$ </span></code></pre></td></tr></table></div></figure>


<h6># add the mode to your screen</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@debian:~$ xrandr --addmode Virtual-0 2560x1440_60.00
</span><span class='line'>staf@debian:~$ </span></code></pre></td></tr></table></div></figure>


<h6># use the new mode</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@debian:~$ xrandr --output Virtual-0 --mode 2560x1440_60.00
</span><span class='line'>staf@debian:~$ </span></code></pre></td></tr></table></div></figure>


<h6>## 4k</h6>

<p>To use a 4k resolution you can use the commands</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@debian:~$  cvt 3840 2160
</span><span class='line'># 3840x2160 59.98 Hz (CVT 8.29M9) hsync: 134.18 kHz; pclk: 712.75 MHz
</span><span class='line'>Modeline "3840x2160_60.00"  712.75  3840 4160 4576 5312  2160 2163 2168 2237 -hsync +vsync
</span><span class='line'>staf@mydevolo:~$ xrandr --newmode "3840x2160_60.00"  712.75  3840 4160 4576 5312  2160 2163 2168 2237 -hsync +vsync
</span><span class='line'>staf@mydevolo:~$ xrandr --addmode Virtual-0 3840x2160_60.00
</span><span class='line'>staf@mydevolo:~$ xrandr --output Virtual-0 --mode 3840x2160_60.00
</span><span class='line'>staf@mydevolo:~$ </span></code></pre></td></tr></table></div></figure>


<h2>Add the new screen resolution permanently</h2>

<h3>Debian &amp; Co</h3>

<p>Create a monitor configuration file in /usr/share/X11/xorg.conf.d</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@mydevolo:/usr/share/X11/xorg.conf.d# vi 10-monitor.conf</span></code></pre></td></tr></table></div></figure>


<p>And add the modeline fgor your screen resolution.
With the Option &ldquo;PreferredMode&rdquo; you can set the prferred resolution.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>section "Monitor"
</span><span class='line'>    Identifier "Virtual-0 "
</span><span class='line'>    Modeline "2560x1440_60.00"  312.25  2560 2752 3024 3488  1440 1443 1448 1493 -hsync +vsync
</span><span class='line'>    Modeline "3840x2160_60.00"  712.75  3840 4160 4576 5312  2160 2163 2168 2237 -hsync +vsync
</span><span class='line'>    Option "PreferredMode" "2560x1440_60.00"
</span><span class='line'>EndSection</span></code></pre></td></tr></table></div></figure>


<h3>Other GNU/Linux distros</h3>

<p>Most other GNU/Linux distribution use /etc/X11/xorg.conf.d/</p>

<p><strong><em> Have fun </em></strong></p>

<h1>Links</h1>

<ul>
<li><a href="https://wiki.archlinux.org/index.php/xrandr"><a href="https://wiki.archlinux.org/index.php/xrandr">https://wiki.archlinux.org/index.php/xrandr</a></a></li>
<li><a href="https://askubuntu.com/questions/994449/ubuntu-16-04-kvm-qxl-guest-cant-change-resolution"><a href="https://askubuntu.com/questions/994449/ubuntu-16-04-kvm-qxl-guest-cant-change-resolution">https://askubuntu.com/questions/994449/ubuntu-16-04-kvm-qxl-guest-cant-change-resolution</a></a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Postfix Smarthost With Authentication]]></title>
    <link href="https://stafwag.github.io/blog/blog/2018/03/04/postfix-smarthost-with-authentication/"/>
    <updated>2018-03-04T08:05:29+01:00</updated>
    <id>https://stafwag.github.io/blog/blog/2018/03/04/postfix-smarthost-with-authentication</id>
    <content type="html"><![CDATA[<p><img class="right" src="https://stafwag.github.io/blog/images/postfix.png" width="400" height="266" title="&#34;postfix&#34;" alt="&#34;postfix&#34;"></p>

<p>I used the relay host of my internet provider but this was causing issues since my email was getting mark as <a href="https://en.wikipedia.org/wiki/Email_spam">SPAM</a> in <a href="https://en.wikipedia.org/wiki/Gmail">gmail</a>.
<br />&nbsp;<br />
It was already on my to-do list to move my outgoing mail to my mail provider also to make it easier to move to another <a href="https://en.wikipedia.org/wiki/Internet_service_provider">ISP</a> or to implement <a href="https://en.wikipedia.org/wiki/Sender_Policy_Framework">SPF</a> but was not on the top of my to-do list.
<br />&nbsp;<br />
My email provider requires authentication, so I needed to reconfigure postfix in my FreeBSD mail jail to use a relay host with authentication.</p>

<h3>Install postfix-sasl</h3>

<p>To use authentication with postfix the postfix-sasl package is required.
If postfix is already installed it&rsquo;ll be replace by postfix-sasl.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafmail:/root # pkg install postfix-sasl</span></code></pre></td></tr></table></div></figure>


<h3>Configuration</h3>

<h4>Update the relay host</h4>

<h4>main.cf</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>relayhost = [smtp.mailprovider.domain]:465
</span><span class='line'>smtp_use_tls=yes
</span><span class='line'>smtp_sasl_auth_enable = yes
</span><span class='line'>smtp_sasl_password_maps = hash:/usr/local/etc/postfix/relay_pass
</span><span class='line'>smtp_sasl_security_options =
</span><span class='line'>smtp_tls_wrappermode = yes
</span><span class='line'>smtp_tls_security_level = encrypt</span></code></pre></td></tr></table></div></figure>


<h4>relay_pass</h4>

<p>The credentials are in the relay_pass file the password is in the file as plain-text so we
it with the correct file permissions.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafmail:/usr/local/etc/postfix # touch relay_pass
</span><span class='line'>root@stafmail:/usr/local/etc/postfix # chmod 600 relay_pass
</span><span class='line'>root@stafmail:/usr/local/etc/postfix # vi relay_pass</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[smtp.mailprovider.domain]:465 user:password</span></code></pre></td></tr></table></div></figure>


<h4>Create the hash file.</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafmail:/usr/local/etc/postfix # postmap relay_pass</span></code></pre></td></tr></table></div></figure>


<h4>Verify the file permissions.</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafmail:/usr/local/etc/postfix # ls -l relay_pass*
</span><span class='line'>-rw-------  1 root  wheel      60 Feb 23 22:43 relay_pass
</span><span class='line'>-rw-------  1 root  wheel  131072 Feb 23 22:43 relay_pass.db
</span><span class='line'>root@stafmail:/usr/local/etc/postfix # </span></code></pre></td></tr></table></div></figure>


<h4>Restart</h4>

<p>We replaced postfix with postfix-sasl a restart is required.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafmail:/usr/local/etc/postfix # /usr/local/etc/rc.d/postfix restart</span></code></pre></td></tr></table></div></figure>


<p><strong><em> Have fun </em></strong></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Update Your CPU Microcode on Arch Linux]]></title>
    <link href="https://stafwag.github.io/blog/blog/2018/02/10/update-your-cpu-microcodeon-arch-linux/"/>
    <updated>2018-02-10T08:33:01+01:00</updated>
    <id>https://stafwag.github.io/blog/blog/2018/02/10/update-your-cpu-microcodeon-arch-linux</id>
    <content type="html"><![CDATA[<h1>Meltdown &amp; spectre</h1>

<p>With Meldown <a href="https://nvd.nist.gov/vuln/detail/CVE-2017-5754"><a href="https://nvd.nist.gov/vuln/detail/CVE-2017-5754">https://nvd.nist.gov/vuln/detail/CVE-2017-5754</a></a>, Spectre Variant 1 <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5753"><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5753">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5753</a></a> and Spectre Variant 2 <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5753"><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5753">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5753</a></a> out in the wild there is a lot of confusing going about updating microcode.</p>

<p>There is a &ldquo;Spectre &amp; Meltdown Checker&rdquo; available at <a href="https://github.com/speed47/spectre-meltdown-checker"><a href="https://github.com/speed47/spectre-meltdown-checker">https://github.com/speed47/spectre-meltdown-checker</a></a></p>

<p>Usage is very easy just clone the git repository and run the script.</p>

<h1>Microcode</h1>

<p>Microcode isn&rsquo;t uploaded to the CPU but loaded during the boot strap of the CPU.
Normally the BIOS upload the microcode to the CPU but this can also be done by the by the bootloader, or the operating system kernel.</p>

<h2>Grub</h2>

<p>Normally you get an updated bios for your motherboard or computer vendor to get new microcode for your CPU.</p>

<p>But when your vendor hasn&rsquo;t released a new Bios yet or when you are using old hardware you might not get a new BIOS with updated microcode.</p>

<p>Lucky microcode can also loaded by bootloader this way you can get new microcode without a BIOS update if the new microcode cuase issues you disable it in the bootloader.</p>

<p>The process for Arch Linux is describe at the Arch Wiki <a href="https://wiki.archlinux.org/index.php/Microcode"><a href="https://wiki.archlinux.org/index.php/Microcode">https://wiki.archlinux.org/index.php/Microcode</a></a></p>

<p>You&rsquo;ll find journey how to update the microcode on my Arch GNU/Linux system below.</p>

<h3>Current microcode</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@frija ~]$ dmesg | grep -i microcode
</span><span class='line'>[    2.102649] microcode: sig=0x40661, pf=0x20, revision=0xa
</span><span class='line'>[    2.102981] microcode: Microcode Update Driver: v2.01 &lt;tigran@aivazian.fsnet.co.uk&gt;, Peter Oruba
</span><span class='line'>[staf@frija ~]$ </span></code></pre></td></tr></table></div></figure>


<h3>Install intel-ucode</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# pacman -Syy intel-ucode
</span><span class='line'>:: Synchronizing package databases...
</span><span class='line'> core                     126.8 KiB  12.4M/s 00:00 [######################] 100%
</span><span class='line'> extra                   1629.4 KiB  11.4M/s 00:00 [######################] 100%
</span><span class='line'> community                  4.1 MiB  11.0M/s 00:00 [######################] 100%
</span><span class='line'> multilib                 167.2 KiB  8.16M/s 00:00 [######################] 100%
</span><span class='line'>resolving dependencies...
</span><span class='line'>looking for conflicting packages...
</span><span class='line'>
</span><span class='line'>Packages (1) intel-ucode-20180108-1
</span><span class='line'>
</span><span class='line'>Total Download Size:   1.12 MiB
</span><span class='line'>Total Installed Size:  1.55 MiB
</span><span class='line'>
</span><span class='line'>:: Proceed with installation? [Y/n] y
</span><span class='line'>:: Retrieving packages...
</span><span class='line'> intel-ucode-2018010...  1145.0 KiB   916K/s 00:01 [######################] 100%
</span><span class='line'>(1/1) checking keys in keyring                     [######################] 100%
</span><span class='line'>(1/1) checking package integrity                   [######################] 100%
</span><span class='line'>(1/1) loading package files                        [######################] 100%
</span><span class='line'>(1/1) checking for file conflicts                  [######################] 100%
</span><span class='line'>(1/1) checking available disk space                [######################] 100%
</span><span class='line'>:: Processing package changes...
</span><span class='line'>(1/1) installing intel-ucode                       [######################] 100%
</span><span class='line'>:: Running post-transaction hooks...
</span><span class='line'>(1/1) Arming ConditionNeedsUpdate...
</span><span class='line'>[root@vicky ~]# </span></code></pre></td></tr></table></div></figure>


<h3>Verify the available microcode for your CPU</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@frija ~]$ yaourt  iucode-tool
</span><span class='line'>1 aur/iucode-tool 2.2-1 (59) (4.87)
</span><span class='line'>    Tool to manipulate Intel® IA-32/X86-64 microcode bundles
</span><span class='line'>==&gt; Enter n° of packages to be installed (e.g., 1 2 3 or 1-3)
</span><span class='line'>==&gt; ----------------------------------------------------------
</span><span class='line'>==&gt; 1
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>==&gt; Downloading iucode-tool PKGBUILD from AUR...
</span><span class='line'>x .SRCINFO
</span><span class='line'>x PKGBUILD
</span><span class='line'>oxe commented on 2017-10-01 17:50          
</span><span class='line'>issue with pgp key and have tried various times and not sure what I might be doing wrong but why do you have so many self-signed sigs?
</span><span class='line'>
</span><span class='line'>gpg --keyserver hkps.pool.sks-keyservers.net  --recv-keys C467A717507BBAFED3C160920BD9E81139CB4807
</span><span class='line'>
</span><span class='line'>uid  Henrique de Moraes Holschuh hmh@debian.org
</span><span class='line'>sig!3        0BD9E81139CB4807 2012-06-26  [self-signature]
</span><span class='line'>uid  Henrique de Moraes Holschuh hmh@hmh.eng.br
</span><span class='line'>sig!3        0BD9E81139CB4807 2012-06-26  [self-signature]
</span><span class='line'>sub  A4B9D9AFC03142CD
</span><span class='line'>sig!         0BD9E81139CB4807 2012-06-26  [self-signature]
</span><span class='line'>sub  981C05C79F47CF26
</span><span class='line'>sig!         0BD9E81139CB4807 2012-06-26  [self-signature]
</span><span class='line'>sub  9137FBD3DE6F0A93
</span><span class='line'>sig!         0BD9E81139CB4807 2014-03-23  [self-signature]
</span><span class='line'>sub  FFDB99C00EABDE2E
</span><span class='line'>sig!         0BD9E81139CB4807 2014-03-23  [self-signature]
</span><span class='line'>sub  FE11BFA68B158E98
</span><span class='line'>sig!         0BD9E81139CB4807 2016-03-26  [self-signature]
</span><span class='line'>sub  A4B1618F7F267286
</span><span class='line'>sig!         0BD9E81139CB4807 2016-03-26  [self-signature]
</span><span class='line'>key 0BD9E81139CB4807:
</span><span class='line'>6 duplicate signatures removed
</span><span class='line'>45 signatures not checked due to missing keys
</span><span class='line'>gpg: key 0BD9E81139CB4807: "Henrique de Moraes Holschuh hmh@hmh.eng.br" not changed
</span><span class='line'>gpg: Total number processed: 1
</span><span class='line'>gpg:              unchanged: 1
</span><span class='line'>
</span><span class='line'>please advise
</span><span class='line'>
</span><span class='line'>progandy commented on 2017-10-01 18:19             
</span><span class='line'>@oxe: I am not Henrique, so I don't know what he did with his key that it looks this strange, but it doesn't affect the package. The build works, and the signature is properly validated.
</span><span class='line'>
</span><span class='line'>Cbhihe commented on 2017-10-10 19:12           
</span><span class='line'>Hi:
</span><span class='line'>During install with '$ makepkg -sric ' I got: a PGP signature error: 
</span><span class='line'>
</span><span class='line'>A simplified output follows because I am typing (not copy/pasting) this on a different box than the one (4.13.4.-1-ARCH) where the install took place:
</span><span class='line'>
</span><span class='line'>== making package: iucode-tool 2.2-1 (Tue Oct 10...2017)
</span><span class='line'>== Checking runtime dependencies...
</span><span class='line'>== Checking buildtime dependencies...
</span><span class='line'>== Retrieving sources...
</span><span class='line'>downloads ok [...]
</span><span class='line'>== Validating source files with sha256sums...
</span><span class='line'>passed [...]
</span><span class='line'>== Verifying source files with gpg...
</span><span class='line'>iucode-tool_2.2.tar.xz ... FAILED (unknown public key FE11BFA68B158E98)
</span><span class='line'>== ERROR: One or more PGP signatures could not be verified !
</span><span class='line'>
</span><span class='line'>Can you explain that unknown PGP public key error ? 
</span><span class='line'>Is it a problem on my side ? 
</span><span class='line'>Please advise. I will be waiting for your response before I actually execute that code. Cheers.
</span><span class='line'>
</span><span class='line'>progandy commented on 2017-10-13 15:28             
</span><span class='line'>@Cbhihe: I did not have time and then forgot, sorry. Still, it should be obvious from the previous comments that you need to import the key in your gpg keyring with gpg, as described in the wiki for makepkg [1],[2]
</span><span class='line'>
</span><span class='line'>gpg --recv-keys FE11BFA68B158E98
</span><span class='line'>or
</span><span class='line'>gpg --recv-keys C467A717507BBAFED3C160920BD9E81139CB4807
</span><span class='line'>or
</span><span class='line'>gpg --keyserver hkps.pool.sks-keyservers.net --recv-keys C467A717507BBAFED3C160920BD9E81139CB4807
</span><span class='line'>
</span><span class='line'>[1]: https://wiki.archlinux.org/index.php/Makepkg#Signature_checking
</span><span class='line'>[2]: https://wiki.archlinux.org/index.php/GnuPG#Use_a_keyserver
</span><span class='line'>
</span><span class='line'>Cbhihe commented on 2017-10-14 17:40           
</span><span class='line'>Thank you. Yes it WAS obvious and I had tried 
</span><span class='line'>gpg --recv-keys FE11BFA68B158E98
</span><span class='line'>already, but for some reason I do not get, either the keyring did not register correctly or I screwed up something, or both. 
</span><span class='line'>
</span><span class='line'>I have reinstalled the Gnome keyring, re-imported my saved signatures and  
</span><span class='line'>gpg --keyserver hkps.pool.sks-keyservers.net --recv-keys C467A717507BBAFED3C160920BD9E81139CB4807
</span><span class='line'>worked this time. :-)
</span><span class='line'>Cheers.
</span><span class='line'>
</span><span class='line'>iucode-tool 2.2-1  (2017-09-13 07:49)
</span><span class='line'>( Unsupported package: Potentially dangerous ! )
</span><span class='line'>==&gt; Edit PKGBUILD ? [Y/n] ("A" to abort)
</span><span class='line'>==&gt; ------------------------------------
</span><span class='line'>==&gt; n
</span><span class='line'>
</span><span class='line'>==&gt; iucode-tool dependencies:
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>==&gt; Continue building iucode-tool ? [Y/n]
</span><span class='line'>==&gt; -------------------------------------
</span><span class='line'>==&gt; 
</span><span class='line'>
</span><span class='line'>==&gt; Building and installing package
</span><span class='line'>==&gt; Making package: iucode-tool 2.2-1 (Sun Jan 21 12:48:37 CET 2018)
</span><span class='line'>==&gt; Checking runtime dependencies...
</span><span class='line'>==&gt; Checking buildtime dependencies...
</span><span class='line'>==&gt; Retrieving sources...
</span><span class='line'>  -&gt; Downloading iucode-tool_2.2.tar.xz...
</span><span class='line'>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span><span class='line'>                                 Dload  Upload   Total   Spent    Left  Speed
</span><span class='line'>100  146k  100  146k    0     0  74948      0  0:00:02  0:00:02 --:--:-- 63193
</span><span class='line'>  -&gt; Downloading iucode-tool_2.2.tar.xz.asc...
</span><span class='line'>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span><span class='line'>                                 Dload  Upload   Total   Spent    Left  Speed
</span><span class='line'>100   833  100   833    0     0    833      0  0:00:01  0:00:01 --:--:--   478
</span><span class='line'>==&gt; Validating source files with sha256sums...
</span><span class='line'>    iucode-tool_2.2.tar.xz ... Passed
</span><span class='line'>    iucode-tool_2.2.tar.xz.asc ... Skipped
</span><span class='line'>==&gt; Verifying source file signatures with gpg...
</span><span class='line'>    iucode-tool_2.2.tar.xz ... Passed
</span><span class='line'>==&gt; Extracting sources...
</span><span class='line'>  -&gt; Extracting iucode-tool_2.2.tar.xz with bsdtar
</span><span class='line'>==&gt; Starting build()...
</span><span class='line'>checking build system type... x86_64-pc-linux-gnu
</span><span class='line'>checking host system type... x86_64-pc-linux-gnu
</span><span class='line'>checking for a BSD-compatible install... /usr/bin/install -c
</span><span class='line'>checking whether build environment is sane... yes
</span><span class='line'>checking for a thread-safe mkdir -p... /usr/bin/mkdir -p
</span><span class='line'>checking for gawk... gawk
</span><span class='line'>checking whether make sets $(MAKE)... yes
</span><span class='line'>checking whether make supports nested variables... yes
</span><span class='line'>checking whether configure.ac should try to override CFLAGS... no
</span><span class='line'>checking whether configure.ac should try to override LDFLAGS... no
</span><span class='line'>checking for style of include used by make... GNU
</span><span class='line'>checking for gcc... gcc
</span><span class='line'>checking whether the C compiler works... yes
</span><span class='line'>checking for C compiler default output file name... a.out
</span><span class='line'>checking for suffix of executables... 
</span><span class='line'>checking whether we are cross compiling... no
</span><span class='line'>checking for suffix of object files... o
</span><span class='line'>checking whether we are using the GNU C compiler... yes
</span><span class='line'>checking whether gcc accepts -g... yes
</span><span class='line'>checking for gcc option to accept ISO C89... none needed
</span><span class='line'>checking whether gcc understands -c and -o together... yes
</span><span class='line'>checking dependency style of gcc... gcc3
</span><span class='line'>checking how to run the C preprocessor... gcc -E
</span><span class='line'>checking for grep that handles long lines and -e... /usr/bin/grep
</span><span class='line'>checking for egrep... /usr/bin/grep -E
</span><span class='line'>checking for ANSI C header files... yes
</span><span class='line'>checking for sys/types.h... yes
</span><span class='line'>checking for sys/stat.h... yes
</span><span class='line'>checking for stdlib.h... yes
</span><span class='line'>checking for string.h... yes
</span><span class='line'>checking for memory.h... yes
</span><span class='line'>checking for strings.h... yes
</span><span class='line'>checking for inttypes.h... yes
</span><span class='line'>checking for stdint.h... yes
</span><span class='line'>checking for unistd.h... yes
</span><span class='line'>checking minix/config.h usability... no
</span><span class='line'>checking minix/config.h presence... no
</span><span class='line'>checking for minix/config.h... no
</span><span class='line'>checking whether it is safe to define __EXTENSIONS__... yes
</span><span class='line'>checking for gcc... (cached) gcc
</span><span class='line'>checking whether we are using the GNU C compiler... (cached) yes
</span><span class='line'>checking whether gcc accepts -g... (cached) yes
</span><span class='line'>checking for gcc option to accept ISO C89... (cached) none needed
</span><span class='line'>checking whether gcc understands -c and -o together... (cached) yes
</span><span class='line'>checking dependency style of gcc... (cached) gcc3
</span><span class='line'>checking for ANSI C header files... (cached) yes
</span><span class='line'>checking fcntl.h usability... yes
</span><span class='line'>checking fcntl.h presence... yes
</span><span class='line'>checking for fcntl.h... yes
</span><span class='line'>checking for stdint.h... (cached) yes
</span><span class='line'>checking for stdlib.h... (cached) yes
</span><span class='line'>checking for string.h... (cached) yes
</span><span class='line'>checking for unistd.h... (cached) yes
</span><span class='line'>checking time.h usability... yes
</span><span class='line'>checking time.h presence... yes
</span><span class='line'>checking for time.h... yes
</span><span class='line'>checking cpuid.h usability... yes
</span><span class='line'>checking cpuid.h presence... yes
</span><span class='line'>checking for cpuid.h... yes
</span><span class='line'>checking whether byte ordering is bigendian... no
</span><span class='line'>checking for inline... inline
</span><span class='line'>checking for int32_t... yes
</span><span class='line'>checking for size_t... yes
</span><span class='line'>checking for ssize_t... yes
</span><span class='line'>checking for uint16_t... yes
</span><span class='line'>checking for uint32_t... yes
</span><span class='line'>checking for uint8_t... yes
</span><span class='line'>checking for stdlib.h... (cached) yes
</span><span class='line'>checking for GNU libc compatible malloc... yes
</span><span class='line'>checking for stdlib.h... (cached) yes
</span><span class='line'>checking for GNU libc compatible realloc... yes
</span><span class='line'>checking whether lstat correctly handles trailing slash... yes
</span><span class='line'>checking whether stat accepts an empty string... no
</span><span class='line'>checking for memset... yes
</span><span class='line'>checking for strcasecmp... yes
</span><span class='line'>checking for strdup... yes
</span><span class='line'>checking for strerror... yes
</span><span class='line'>checking for strrchr... yes
</span><span class='line'>checking for strtoul... yes
</span><span class='line'>checking for timegm... yes
</span><span class='line'>checking for library containing argp_parse... none required
</span><span class='line'>checking for special C compiler options needed for large files... no
</span><span class='line'>checking for _FILE_OFFSET_BITS value needed for large files... no
</span><span class='line'>checking for flockfile... yes
</span><span class='line'>checking for fgets_unlocked... yes
</span><span class='line'>configure: project-wide base CPPFLAGS: -D_FORTIFY_SOURCE=2
</span><span class='line'>configure: project-wide base CFLAGS:   -march=x86-64 -mtune=generic -O2 -pipe -fstack-protector-strong -fno-plt
</span><span class='line'>configure: project-wide base LDFLAGS:  -Wl,-O1,--sort-common,--as-needed,-z,relro,-z,now
</span><span class='line'>checking that generated files are newer than configure... done
</span><span class='line'>configure: creating ./config.status
</span><span class='line'>config.status: creating Makefile
</span><span class='line'>config.status: creating iucode_tool.8
</span><span class='line'>config.status: creating iucode_tool_config.h
</span><span class='line'>config.status: executing depfiles commands
</span><span class='line'>make  all-am
</span><span class='line'>make[1]: Entering directory '/home/staf/tmp/yaourt-tmp-staf/aur-iucode-tool/src/iucode-tool-2.2'
</span><span class='line'>gcc -DHAVE_CONFIG_H -I.   -D_FORTIFY_SOURCE=2  -march=x86-64 -mtune=generic -O2 -pipe -fstack-protector-strong -fno-plt -MT intel_microcode.o -MD -MP -MF .deps/intel_microcode.Tpo -c -o intel_microcode.o intel_microcode.c
</span><span class='line'>gcc -DHAVE_CONFIG_H -I.   -D_FORTIFY_SOURCE=2  -march=x86-64 -mtune=generic -O2 -pipe -fstack-protector-strong -fno-plt -MT iucode_tool.o -MD -MP -MF .deps/iucode_tool.Tpo -c -o iucode_tool.o iucode_tool.c
</span><span class='line'>mv -f .deps/intel_microcode.Tpo .deps/intel_microcode.Po
</span><span class='line'>mv -f .deps/iucode_tool.Tpo .deps/iucode_tool.Po
</span><span class='line'>gcc  -march=x86-64 -mtune=generic -O2 -pipe -fstack-protector-strong -fno-plt  -Wl,-O1,--sort-common,--as-needed,-z,relro,-z,now -o iucode_tool intel_microcode.o iucode_tool.o  
</span><span class='line'>make[1]: Leaving directory '/home/staf/tmp/yaourt-tmp-staf/aur-iucode-tool/src/iucode-tool-2.2'
</span><span class='line'>==&gt; Entering fakeroot environment...
</span><span class='line'>==&gt; Starting package()...
</span><span class='line'>make[1]: Entering directory '/home/staf/tmp/yaourt-tmp-staf/aur-iucode-tool/src/iucode-tool-2.2'
</span><span class='line'> /usr/bin/mkdir -p '/home/staf/tmp/yaourt-tmp-staf/aur-iucode-tool/pkg/iucode-tool//usr/bin'
</span><span class='line'> /usr/bin/mkdir -p '/home/staf/tmp/yaourt-tmp-staf/aur-iucode-tool/pkg/iucode-tool//usr/share/man/man8'
</span><span class='line'>  /usr/bin/install -c iucode_tool '/home/staf/tmp/yaourt-tmp-staf/aur-iucode-tool/pkg/iucode-tool//usr/bin'
</span><span class='line'> /usr/bin/install -c -m 644 iucode_tool.8 '/home/staf/tmp/yaourt-tmp-staf/aur-iucode-tool/pkg/iucode-tool//usr/share/man/man8'
</span><span class='line'>make[1]: Leaving directory '/home/staf/tmp/yaourt-tmp-staf/aur-iucode-tool/src/iucode-tool-2.2'
</span><span class='line'>==&gt; Tidying install...
</span><span class='line'>  -&gt; Removing libtool files...
</span><span class='line'>  -&gt; Purging unwanted files...
</span><span class='line'>  -&gt; Removing static library files...
</span><span class='line'>  -&gt; Stripping unneeded symbols from binaries and libraries...
</span><span class='line'>  -&gt; Compressing man and info pages...
</span><span class='line'>==&gt; Checking for packaging issue...
</span><span class='line'>==&gt; Creating package "iucode-tool"...
</span><span class='line'>  -&gt; Generating .PKGINFO file...
</span><span class='line'>  -&gt; Generating .BUILDINFO file...
</span><span class='line'>  -&gt; Generating .MTREE file...
</span><span class='line'>  -&gt; Compressing package...
</span><span class='line'>==&gt; Leaving fakeroot environment.
</span><span class='line'>==&gt; Finished making: iucode-tool 2.2-1 (Sun Jan 21 12:48:44 CET 2018)
</span><span class='line'>==&gt; Cleaning up...
</span><span class='line'>
</span><span class='line'>==&gt; Continue installing iucode-tool ? [Y/n]
</span><span class='line'>==&gt; [v]iew package contents [c]heck package with namcap
</span><span class='line'>==&gt; ---------------------------------------------------
</span><span class='line'>==&gt; y
</span><span class='line'>
</span><span class='line'>loading packages...
</span><span class='line'>resolving dependencies...
</span><span class='line'>looking for conflicting packages...
</span><span class='line'>
</span><span class='line'>Packages (1) iucode-tool-2.2-1
</span><span class='line'>
</span><span class='line'>Total Installed Size:  0.06 MiB
</span><span class='line'>
</span><span class='line'>:: Proceed with installation? [Y/n] y
</span><span class='line'>(1/1) checking keys in keyring                                   [####################################] 100%
</span><span class='line'>(1/1) checking package integrity                                 [####################################] 100%
</span><span class='line'>(1/1) loading package files                                      [####################################] 100%
</span><span class='line'>(1/1) checking for file conflicts                                [####################################] 100%
</span><span class='line'>(1/1) checking available disk space                              [####################################] 100%
</span><span class='line'>:: Processing package changes...
</span><span class='line'>(1/1) installing iucode-tool                                     [####################################] 100%
</span><span class='line'>ldconfig: File /usr/lib/libmlt.so.6.4.0 is empty, not checked.
</span><span class='line'>ldconfig: File /usr/lib/libmlt++.so.6.4.0 is empty, not checked.
</span><span class='line'>ldconfig: File /usr/lib32/libmng.so.2 is empty, not checked.
</span><span class='line'>ldconfig: File /usr/lib32/libmng.so is empty, not checked.
</span><span class='line'>ldconfig: File /usr/lib32/libmng.so.2.0.2 is empty, not checked.
</span><span class='line'>:: Running post-transaction hooks...
</span><span class='line'>(1/1) Arming ConditionNeedsUpdate...
</span><span class='line'>[staf@frija ~]$ </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@frija ~]# bsdtar -Oxf /boot/intel-ucode.img | iucode_tool -tb -lS - 
</span><span class='line'>iucode_tool: system has processor(s) with signature 0x00040661
</span><span class='line'>microcode bundle 1: (stdin)
</span><span class='line'>selected microcodes:
</span><span class='line'>  001/143: sig 0x00040661, pf_mask 0x32, 2017-11-20, rev 0x0018, size 25600
</span><span class='line'>[root@frija ~]# </span></code></pre></td></tr></table></div></figure>


<h3>Recreate grub.cfg</h3>

<p>grub-mkconfig will detect the microcode and add it the grub configuration.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# grub-mkconfig -o /boot/grub/grub.cfg
</span><span class='line'>Generating grub configuration file ...
</span><span class='line'>Found linux image: /boot/vmlinuz-linux-lts
</span><span class='line'>Found initrd image(s) in /boot: intel-ucode.img initramfs-linux-lts.img
</span><span class='line'>Found fallback initrd image(s) in /boot: intel-ucode.img initramfs-linux-lts-fallback.img
</span><span class='line'>Found linux image: /boot/vmlinuz-linux-hardened
</span><span class='line'>Found initrd image(s) in /boot: intel-ucode.img initramfs-linux-hardened.img
</span><span class='line'>Found fallback initrd image(s) in /boot: intel-ucode.img initramfs-linux-hardened-fallback.img
</span><span class='line'>Found linux image: /boot/vmlinuz-linux-ck
</span><span class='line'>Found initrd image(s) in /boot: intel-ucode.img initramfs-linux-ck.img
</span><span class='line'>Found fallback initrd image(s) in /boot: intel-ucode.img initramfs-linux-ck-fallback.img
</span><span class='line'>Found linux image: /boot/vmlinuz-linux
</span><span class='line'>Found initrd image(s) in /boot: intel-ucode.img initramfs-linux.img
</span><span class='line'>Found fallback initrd image(s) in /boot: intel-ucode.img initramfs-linux-fallback.img
</span><span class='line'>done
</span><span class='line'>[root@vicky ~]# </span></code></pre></td></tr></table></div></figure>


<p>When take a look at the newly created grub.cfg you see that microcode image is added to the initrd image.
If you new micro code cause issue you can just remove the entry in grub configuration</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# cat /boot/grub/grub.cfg | grep initrd
</span><span class='line'>  initrd  /__active/rootvol/boot/intel-ucode.img /__active/rootvol/boot/initramfs-linux-lts.img
</span><span class='line'>  initrd  /__active/rootvol/boot/intel-ucode.img /__active/rootvol/boot/initramfs-linux-lts-fallback.img
</span><span class='line'>  initrd  /__active/rootvol/boot/intel-ucode.img /__active/rootvol/boot/initramfs-linux-hardened.img
</span><span class='line'>  initrd  /__active/rootvol/boot/intel-ucode.img /__active/rootvol/boot/initramfs-linux-hardened-fallback.img
</span><span class='line'>  initrd  /__active/rootvol/boot/intel-ucode.img /__active/rootvol/boot/initramfs-linux-ck.img
</span><span class='line'>  initrd  /__active/rootvol/boot/intel-ucode.img /__active/rootvol/boot/initramfs-linux-ck-fallback.img
</span><span class='line'>  initrd  /__active/rootvol/boot/intel-ucode.img /__active/rootvol/boot/initramfs-linux.img
</span><span class='line'>  initrd  /__active/rootvol/boot/intel-ucode.img /__active/rootvol/boot/initramfs-linux-fallback.img
</span><span class='line'>[root@vicky ~]# 
</span></code></pre></td></tr></table></div></figure>


<h2>Reboot your system and verify</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@frija ~]$ dmesg | grep -i microcode
</span><span class='line'>[    0.000000] microcode: microcode updated early to revision 0x18, date = 2017-11-20
</span><span class='line'>[    1.852726] microcode: sig=0x40661, pf=0x20, revision=0x18
</span><span class='line'>[    1.853029] microcode: Microcode Update Driver: v2.2.
</span><span class='line'>[staf@frija ~]$ </span></code></pre></td></tr></table></div></figure>


<p><strong><em>Have fun</em></strong></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Bacula on FreeBSD (Part 3 Storage Setup)]]></title>
    <link href="https://stafwag.github.io/blog/blog/2017/12/27/bacula-on-freebsd-part3/"/>
    <updated>2017-12-27T11:25:25+01:00</updated>
    <id>https://stafwag.github.io/blog/blog/2017/12/27/bacula-on-freebsd-part3</id>
    <content type="html"><![CDATA[<p><img class="right" src="https://stafwag.github.io/blog/images/bacula_setup.jpg" width="500" height="416" title="&#34;bacula setup&#34;" alt="&#34;bacula setup&#34;"></p>

<p>I finally got the time to continue with my <a href="https://blog.bacula.org/">bacula</a> backup setup. See my previous posts about the start of my bacula setup.</p>

<ul>
<li><a href="http://stafwag.github.io/blog/blog/2017/08/06/bacula-on-freebsd:w_part1/">bacula on freebsd_part 1</a></li>
<li><a href="http://stafwag.github.io/blog/blog/2017/09/09/bacula-on-freebsd-part2/">bacula on freebsd part 2</a></li>
</ul>


<h1>Storage setup</h1>

<p>I created a new zfs pool &ldquo;bigpool&rdquo; with some old harddisks I probably need to replace them with bigger harddisk in the further.</p>

<h2>zfs filesystem</h2>

<p>First we create a zfs filesystem for our bacula storage.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # zfs create bigpool/bacula
</span><span class='line'>root@rataplan:~ # </span></code></pre></td></tr></table></div></figure>


<h2>delegate to jail</h2>

<h3>jailed</h3>

<p>We want to use the zfs dataset in the bacula jail so we need to delegate the control to the dataset into the bacula jail.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # zfs set jailed=on bigpool/bacula
</span><span class='line'>root@rataplan:~ # zfs jail stafbacula bigpool/bacula</span></code></pre></td></tr></table></div></figure>


<h3>verify</h3>

<p>When we logon to the jail we see that the zfs dateset is available.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # ezjail-admin console stafbacula
</span><span class='line'>Last login: Wed Dec 27 10:52:27 on pts/2
</span><span class='line'>FreeBSD 11.1-RELEASE-p4 (GENERIC) #0: Tue Nov 14 06:12:40 UTC 2017
</span><span class='line'>
</span><span class='line'>Welcome to FreeBSD!
</span><span class='line'>
</span><span class='line'>Release Notes, Errata: https://www.FreeBSD.org/releases/
</span><span class='line'>Security Advisories:   https://www.FreeBSD.org/security/
</span><span class='line'>FreeBSD Handbook:      https://www.FreeBSD.org/handbook/
</span><span class='line'>FreeBSD FAQ:           https://www.FreeBSD.org/faq/
</span><span class='line'>Questions List: https://lists.FreeBSD.org/mailman/listinfo/freebsd-questions/
</span><span class='line'>FreeBSD Forums:        https://forums.FreeBSD.org/
</span><span class='line'>
</span><span class='line'>Documents installed with the system are in the /usr/local/share/doc/freebsd/
</span><span class='line'>directory, or can be installed later with:  pkg install en-freebsd-doc
</span><span class='line'>For other languages, replace "en" with a language code like de or fr.
</span><span class='line'>
</span><span class='line'>Show the version of FreeBSD installed:  freebsd-version ; uname -a
</span><span class='line'>Please include that output and any error messages when posting questions.
</span><span class='line'>Introduction to manual pages:  man man
</span><span class='line'>FreeBSD directory layout:      man hier
</span><span class='line'>
</span><span class='line'>Edit /etc/motd to change this login announcement.
</span><span class='line'>You have new mail.
</span><span class='line'>root@stafbacula:~ # zfs list
</span><span class='line'>NAME             USED  AVAIL  REFER  MOUNTPOINT
</span><span class='line'>bigpool         1.14M   433G    23K  /bigpool
</span><span class='line'>bigpool/bacula    23K   433G    23K  /bigpool/bacula
</span><span class='line'>root@stafbacula:~ # </span></code></pre></td></tr></table></div></figure>


<p>When we restart the jail we see that the dataset isn&rsquo;t available anymore in the jail</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafbacula:~ # logout
</span><span class='line'>root@rataplan:~ # /usr/local/etc/rc.d/ezjail restart stafbacula
</span><span class='line'>Stopping jails: stafbacula.
</span><span class='line'>Starting jails: stafbacula.
</span><span class='line'>/etc/rc.d/jail: WARNING: Per-jail configuration via jail_* variables  is obsolete.  Please consider migrating to /etc/jail.conf.
</span><span class='line'>root@rataplan:~ # ezjail-admin console stafbacula
</span><span class='line'>Last login: Wed Dec 27 10:58:33 on pts/2
</span><span class='line'>FreeBSD 11.1-RELEASE-p4 (GENERIC) #0: Tue Nov 14 06:12:40 UTC 2017
</span><span class='line'>
</span><span class='line'>Welcome to FreeBSD!
</span><span class='line'>
</span><span class='line'>Release Notes, Errata: https://www.FreeBSD.org/releases/
</span><span class='line'>Security Advisories:   https://www.FreeBSD.org/security/
</span><span class='line'>FreeBSD Handbook:      https://www.FreeBSD.org/handbook/
</span><span class='line'>FreeBSD FAQ:           https://www.FreeBSD.org/faq/
</span><span class='line'>Questions List: https://lists.FreeBSD.org/mailman/listinfo/freebsd-questions/
</span><span class='line'>FreeBSD Forums:        https://forums.FreeBSD.org/
</span><span class='line'>
</span><span class='line'>Documents installed with the system are in the /usr/local/share/doc/freebsd/
</span><span class='line'>directory, or can be installed later with:  pkg install en-freebsd-doc
</span><span class='line'>For other languages, replace "en" with a language code like de or fr.
</span><span class='line'>
</span><span class='line'>Show the version of FreeBSD installed:  freebsd-version ; uname -a
</span><span class='line'>Please include that output and any error messages when posting questions.
</span><span class='line'>Introduction to manual pages:  man man
</span><span class='line'>FreeBSD directory layout:      man hier
</span><span class='line'>
</span><span class='line'>Edit /etc/motd to change this login announcement.
</span><span class='line'>You have new mail.
</span><span class='line'>root@stafbacula:~ # zfs list
</span><span class='line'>no datasets available
</span><span class='line'>root@stafbacula:~ # </span></code></pre></td></tr></table></div></figure>


<h3>make persistent</h3>

<h4>enable zfs in the jail</h4>

<p>When the jail is booted it need to bring the zfs filesystem online. We need to add <code>zfs_enable=YES</code> to the jail rc.conf</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # vi /usr/jails/stafbacula/etc/rc.conf</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bacula_dir="start"
</span><span class='line'>bacula_dir_enable="yes"
</span><span class='line'>zfs_enable="YES"</span></code></pre></td></tr></table></div></figure>


<h4>update the ezjail configuration</h4>

<p>ezjail needs to jail the zfs dataset to the jail when it&rsquo;s start the jail.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # vi /usr/local/etc/ezjail/stafbacula</span></code></pre></td></tr></table></div></figure>


<p>We need to add the dataset to the jail&rsquo;s zfs_datasets. By default a jail isn&rsquo;t allowed to mount the zfs dataset so need to update jail&rsquo;s parmeters.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>export jail_stafbacula_zfs_datasets="bigpool/bacula"
</span><span class='line'>export jail_stafbacula_parameters="enforce_statfs=0 allow.mount=1 allow.mount.zfs=1 allow.mount.procfs=1 allow.mount.devfs=1"
</span></code></pre></td></tr></table></div></figure>


<p>Restart the jail and verify that the zfs filesystem is available inside the jail</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # ezjail-admin restart stafbacula
</span><span class='line'>Stopping jails: stafbacula.
</span><span class='line'>Starting jails: stafbacula.
</span><span class='line'>/etc/rc.d/jail: WARNING: Per-jail configuration via jail_* variables  is obsolete.  Please consider migrating to /etc/jail.conf.
</span><span class='line'>root@rataplan:~ # </span></code></pre></td></tr></table></div></figure>


<p>Verify that dataset is mounted</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # ezjail-admin console stafbacula
</span><span class='line'>Last login: Wed Dec 27 11:36:04 on pts/2
</span><span class='line'>FreeBSD 11.1-RELEASE-p4 (GENERIC) #0: Tue Nov 14 06:12:40 UTC 2017
</span><span class='line'>
</span><span class='line'>Welcome to FreeBSD!
</span><span class='line'>
</span><span class='line'>Release Notes, Errata: https://www.FreeBSD.org/releases/
</span><span class='line'>Security Advisories:   https://www.FreeBSD.org/security/
</span><span class='line'>FreeBSD Handbook:      https://www.FreeBSD.org/handbook/
</span><span class='line'>FreeBSD FAQ:           https://www.FreeBSD.org/faq/
</span><span class='line'>Questions List: https://lists.FreeBSD.org/mailman/listinfo/freebsd-questions/
</span><span class='line'>FreeBSD Forums:        https://forums.FreeBSD.org/
</span><span class='line'>
</span><span class='line'>Documents installed with the system are in the /usr/local/share/doc/freebsd/
</span><span class='line'>directory, or can be installed later with:  pkg install en-freebsd-doc
</span><span class='line'>For other languages, replace "en" with a language code like de or fr.
</span><span class='line'>
</span><span class='line'>Show the version of FreeBSD installed:  freebsd-version ; uname -a
</span><span class='line'>Please include that output and any error messages when posting questions.
</span><span class='line'>Introduction to manual pages:  man man
</span><span class='line'>FreeBSD directory layout:      man hier
</span><span class='line'>
</span><span class='line'>Edit /etc/motd to change this login announcement.
</span><span class='line'>You have new mail.
</span><span class='line'>root@stafbacula:~ # zfs list
</span><span class='line'>NAME             USED  AVAIL  REFER  MOUNTPOINT
</span><span class='line'>bigpool         1.14M   433G    23K  /bigpool
</span><span class='line'>bigpool/bacula    23K   433G    23K  /bigpool/bacula
</span><span class='line'>root@stafbacula:~ # df -h /bigpool/bacula
</span><span class='line'>Filesystem                    Size    Used   Avail Capacity  Mounted on
</span><span class='line'>zroot/usr/jails/stafbacula    2.6T    618M    2.6T     0%    /usr/jails/stafbacula
</span><span class='line'>root@stafbacula:~ # </span></code></pre></td></tr></table></div></figure>


<h1>Links</h1>

<ul>
<li><a href="http://www.allanjude.com/blog/2013-10-05_poudriere_jail"><a href="http://www.allanjude.com/blog/2013-10-05_poudriere_jail">http://www.allanjude.com/blog/2013-10-05_poudriere_jail</a></a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Model-m Tux Update...]]></title>
    <link href="https://stafwag.github.io/blog/blog/2017/10/20/model-m-tux-update-dot-dot-dot/"/>
    <updated>2017-10-20T17:27:41+02:00</updated>
    <id>https://stafwag.github.io/blog/blog/2017/10/20/model-m-tux-update-dot-dot-dot</id>
    <content type="html"><![CDATA[<p><img class="right" src="https://stafwag.github.io/blog/images/modelm_tux_only.jpg" width="400" height="266" title="&#34;modelm_tux_only.jpg&#34;" alt="&#34;modelm_tux_only.jpg&#34;"></p>

<p>I own a <a href="https://en.wikipedia.org/wiki/Unicomp">Unicomp</a> <a herf="https://en.wikipedia.org/wiki/Model_M_keyboard">model-m keyboard</a>. The keyboard has a nice key feel but it has windows super key(s).</p>

<p><br /></p>

<p>I don&rsquo;t use super key(s), and would prefer to have a keyboard without it.  But when it has super keys  I&rsquo;d rather have it without the windows logo on it so it was time  to replace them with <a href="http://www.keyboardco.com/product/unicomp-gray-linux-tux-keyset.asp">the tux version</a></p>

<h3>Pictures</h3>

<p><a href="https://stafwag.github.io/blog/images/modelm_tux_package.jpg"><img src="https://stafwag.github.io/blog/images/modelm_tux_package.jpg" height="250" width="375" alt="modelm_tux_package.jpg" /></a>
<a href="https://stafwag.github.io/blog/images/modelm_all_keys.jpg"><img src="https://stafwag.github.io/blog/images/modelm_all_keys.jpg" height="250" width="375" alt="modelm_all_keys.jpg" /></a>
<a href="https://stafwag.github.io/blog/images/modelm_tux_only.jpg"><img src="https://stafwag.github.io/blog/images/modelm_tux_only.jpg" height="250" width="375" alt="modelm_tux_only.jpg" /></a>
<a href="https://stafwag.github.io/blog/images/modelm_with_tux_keys.jpg"><img src="https://stafwag.github.io/blog/images/modelm_with_tux_keys.jpg" height="250" width="375" alt="modelm_with_tux_keys.jpg" /></a></p>
]]></content>
  </entry>
  
</feed>
