<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[stafwag Blog]]></title>
  <link href="https://stafwag.github.io/blog/atom.xml" rel="self"/>
  <link href="https://stafwag.github.io/blog/"/>
  <updated>2018-06-04T20:22:17+02:00</updated>
  <id>https://stafwag.github.io/blog/</id>
  <author>
    <name><![CDATA[staf wagemakers]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Nested Virtualization in KVM]]></title>
    <link href="https://stafwag.github.io/blog/blog/2018/06/04/nested-virtualization-in-kvm/"/>
    <updated>2018-06-04T19:58:06+02:00</updated>
    <id>https://stafwag.github.io/blog/blog/2018/06/04/nested-virtualization-in-kvm</id>
    <content type="html"><![CDATA[<h2>KVM</h2>

<p><a href="https://www.linux-kvm.org">Kernel-based Virtual Machine (KVM)</a> has become the defacto hypervisor on GNU/Linux systems it works with great performance as it utilizes the CPU virtualization extensions <a href="https://en.wikipedia.org/wiki/X86_virtualization#Intel_virtualization_(VT-x)">Inetl VT-x</a> or <a href="https://en.wikipedia.org/wiki/X86_virtualization#AMD_virtualization_(AMD-V)">AMD-V</a>). KVM doesn&rsquo;t emulate hardware but uses <a href="https://www.qemu.org/">QEMU</a> for this.</p>

<h2>Nested Virtual guest</h2>

<p>It&rsquo;s possible to use nested virtualization this make it possible to run a hypervisor inside a KVM virtual machine.</p>

<h2>Enabling nested virtualization in KVM</h2>

<h3>Verify</h3>

<p>To verify if nested virtualization is enabled on your system can check /sys/module/kvm_intel/parameters/nested on Intal systems or /sys/module/kvm_amd/parameters/nested</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@frija ~]$ cat /sys/module/kvm_intel/parameters/nested
</span><span class='line'>N
</span><span class='line'>[staf@frija ~]$ </span></code></pre></td></tr></table></div></figure>


<h3>Enable</h3>

<h4>Shutdown all virtual machines</h4>

<p>Make sure that there no virtual machines running.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@frija ~]# virsh 
</span><span class='line'>Welcome to virsh, the virtualization interactive terminal.
</span><span class='line'>
</span><span class='line'>Type:  'help' for help with commands
</span><span class='line'>       'quit' to quit
</span><span class='line'>
</span><span class='line'>virsh # list
</span><span class='line'> Id    Name                           State
</span><span class='line'>----------------------------------------------------
</span><span class='line'>
</span><span class='line'>virsh # </span></code></pre></td></tr></table></div></figure>


<p></p>

<h4>Unload KVM</h4>

<p>Unload the KVM kernel module.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@frija ~]# modprobe -r kvm_intel
</span><span class='line'>[root@frija ~]# </span></code></pre></td></tr></table></div></figure>


<h4>Load KVM and activate nested</h4>

<p>Reload the KVM with the nested feature enabled.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@frija ~]# modprobe kvm_intel nested=1
</span><span class='line'>[root@frija ~]# </span></code></pre></td></tr></table></div></figure>


<p>Verify</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@frija ~]# cat /sys/module/kvm_intel/parameters/nested
</span><span class='line'>Y
</span><span class='line'>[root@frija ~]# </span></code></pre></td></tr></table></div></figure>


<p>To enable the nested feature permanently create /etc/modprobe.d/kvm.conf</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@frija ~]# vi /etc/modprobe.d/kvm.conf</span></code></pre></td></tr></table></div></figure>


<p>and enable the nested option.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>options kvm_intel nested=1</span></code></pre></td></tr></table></div></figure>


<h2>Enabling nested virtialization in the virtual machine</h2>

<p>When you logon to a virtual machine and verify the virtualization extensions on the cpu the flags aren&rsquo;t available.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@centos7 ~]$ cat /proc/cpuinfo | grep  -i -E "vmx|svm"
</span><span class='line'>[staf@centos7 ~]$ </span></code></pre></td></tr></table></div></figure>


<p>To enable nested virtualization in a vritual machine you can</p>

<ul>
<li>start <code>virsh</code> and and edit the the virtual machine and change the CPU line to <code>&lt;cpu mode='host-model' check='partial'/&gt;</code></li>
<li>Open virt-manager and select <strong>Copy host CPU configuration</strong> on the CPU configuration</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@frija ~]# virsh 
</span><span class='line'>Welcome to virsh, the virtualization interactive terminal.
</span><span class='line'>
</span><span class='line'>Type:  'help' for help with commands
</span><span class='line'>       'quit' to quit
</span><span class='line'>
</span><span class='line'>virsh # list
</span><span class='line'> Id    Name                           State
</span><span class='line'>----------------------------------------------------
</span><span class='line'> 1     centos7.0                      running
</span><span class='line'>
</span><span class='line'>virsh # edit centos7.0 </span></code></pre></td></tr></table></div></figure>


<p>Change the cpu settings</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  &lt;features&gt;
</span><span class='line'>    &lt;acpi/&gt;
</span><span class='line'>    &lt;apic/&gt;
</span><span class='line'>    &lt;vmport state='off'/&gt;
</span><span class='line'>  &lt;/features&gt;
</span><span class='line'>  &lt;cpu mode='host-model' check='partial'&gt;
</span><span class='line'>    &lt;model fallback='allow'/&gt;
</span><span class='line'>  &lt;/cpu&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Shutdown the virtual machine</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>virsh # reboot centos7.0 
</span><span class='line'>Domain centos7.0 is being rebooted
</span><span class='line'>
</span><span class='line'>virsh # 
</span></code></pre></td></tr></table></div></figure>


<p>Start the virtual machine</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>virsh # start centos7.0  
</span><span class='line'>Domain centos7.0 started</span></code></pre></td></tr></table></div></figure>


<p>Verify that the <code>feature policies</code> on the cpu are updated.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>virsh # dumpxml centos7.0 </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> &lt;cpu mode='custom' match='exact' check='full'&gt;
</span><span class='line'>    &lt;model fallback='forbid'&gt;Haswell-noTSX-IBRS&lt;/model&gt;
</span><span class='line'>    &lt;vendor&gt;Intel&lt;/vendor&gt;
</span><span class='line'>    &lt;feature policy='require' name='vme'/&gt;
</span><span class='line'>    &lt;feature policy='require' name='ss'/&gt;
</span><span class='line'>    &lt;feature policy='require' name='f16c'/&gt;
</span><span class='line'>    &lt;feature policy='require' name='rdrand'/&gt;
</span><span class='line'>    &lt;feature policy='require' name='hypervisor'/&gt;
</span><span class='line'>    &lt;feature policy='require' name='arat'/&gt;
</span><span class='line'>    &lt;feature policy='require' name='tsc_adjust'/&gt;
</span><span class='line'>    &lt;feature policy='require' name='xsaveopt'/&gt;
</span><span class='line'>    &lt;feature policy='require' name='pdpe1gb'/&gt;
</span><span class='line'>    &lt;feature policy='require' name='abm'/&gt;
</span><span class='line'>    &lt;feature policy='require' name='ibpb'/&gt;
</span><span class='line'> &lt;/cpu&gt;</span></code></pre></td></tr></table></div></figure>


<p>Logon to the virtual machine and verify the cpu flags;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@centos7 ~]$ cat /proc/cpuinfo | grep -i vmx
</span><span class='line'>flags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss syscall nx pdpe1gb rdtscp lm constant_tsc rep_good nopl xtopology eagerfpu pni pclmulqdq vmx ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm tpr_shadow vnmi flexpriority ept vpid fsgsbase tsc_adjust bmi1 avx2 smep bmi2 erms invpcid xsaveopt ibpb ibrs arat spec_ctrl
</span><span class='line'>flags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss syscall nx pdpe1gb rdtscp lm constant_tsc rep_good nopl xtopology eagerfpu pni pclmulqdq vmx ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm tpr_shadow vnmi flexpriority ept vpid fsgsbase tsc_adjust bmi1 avx2 smep bmi2 erms invpcid xsaveopt ibpb ibrs arat spec_ctrl
</span><span class='line'>[staf@centos7 ~]$ cat /proc/cpuinfo | grep  -i "vmx|svm"
</span><span class='line'>[staf@centos7 ~]$ cat /proc/cpuinfo | grep  -i -E "vmx|svm"
</span><span class='line'>flags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss syscall nx pdpe1gb rdtscp lm constant_tsc rep_good nopl xtopology eagerfpu pni pclmulqdq vmx ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm tpr_shadow vnmi flexpriority ept vpid fsgsbase tsc_adjust bmi1 avx2 smep bmi2 erms invpcid xsaveopt ibpb ibrs arat spec_ctrl
</span><span class='line'>flags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss syscall nx pdpe1gb rdtscp lm constant_tsc rep_good nopl xtopology eagerfpu pni pclmulqdq vmx ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm tpr_shadow vnmi flexpriority ept vpid fsgsbase tsc_adjust bmi1 avx2 smep bmi2 erms invpcid xsaveopt ibpb ibrs arat spec_ctrl</span></code></pre></td></tr></table></div></figure>


<p>Execute the <code>virt-host-validate</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@centos7 ~]$ virt-host-validate
</span><span class='line'>  QEMU: Checking for hardware virtualization                                 : PASS
</span><span class='line'>  QEMU: Checking if device /dev/kvm exists                                   : PASS
</span><span class='line'>  QEMU: Checking if device /dev/kvm is accessible                            : PASS
</span><span class='line'>  QEMU: Checking if device /dev/vhost-net exists                             : PASS
</span><span class='line'>  QEMU: Checking if device /dev/net/tun exists                               : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'memory' controller support                      : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'memory' controller mount-point                  : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'cpu' controller support                         : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'cpu' controller mount-point                     : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'cpuacct' controller support                     : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'cpuacct' controller mount-point                 : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'cpuset' controller support                      : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'cpuset' controller mount-point                  : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'devices' controller support                     : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'devices' controller mount-point                 : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'blkio' controller support                       : PASS
</span><span class='line'>  QEMU: Checking for cgroup 'blkio' controller mount-point                   : PASS
</span><span class='line'>  QEMU: Checking for device assignment IOMMU support                         : WARN (No ACPI DMAR table found, IOMMU either disabled in BIOS or not supported by this hardware platform)
</span><span class='line'>   LXC: Checking for Linux &gt;= 2.6.26                                         : PASS
</span><span class='line'>   LXC: Checking for namespace ipc                                           : PASS
</span><span class='line'>   LXC: Checking for namespace mnt                                           : PASS
</span><span class='line'>   LXC: Checking for namespace pid                                           : PASS
</span><span class='line'>   LXC: Checking for namespace uts                                           : PASS
</span><span class='line'>   LXC: Checking for namespace net                                           : PASS
</span><span class='line'>   LXC: Checking for namespace user                                          : PASS
</span><span class='line'>   LXC: Checking for cgroup 'memory' controller support                      : PASS
</span><span class='line'>   LXC: Checking for cgroup 'memory' controller mount-point                  : PASS
</span><span class='line'>   LXC: Checking for cgroup 'cpu' controller support                         : PASS
</span><span class='line'>   LXC: Checking for cgroup 'cpu' controller mount-point                     : PASS
</span><span class='line'>   LXC: Checking for cgroup 'cpuacct' controller support                     : PASS
</span><span class='line'>   LXC: Checking for cgroup 'cpuacct' controller mount-point                 : PASS
</span><span class='line'>   LXC: Checking for cgroup 'cpuset' controller support                      : PASS
</span><span class='line'>   LXC: Checking for cgroup 'cpuset' controller mount-point                  : PASS
</span><span class='line'>   LXC: Checking for cgroup 'devices' controller support                     : PASS
</span><span class='line'>   LXC: Checking for cgroup 'devices' controller mount-point                 : PASS
</span><span class='line'>   LXC: Checking for cgroup 'blkio' controller support                       : PASS
</span><span class='line'>   LXC: Checking for cgroup 'blkio' controller mount-point                   : PASS
</span><span class='line'>   LXC: Checking if device /sys/fs/fuse/connections exists                   : FAIL (Load the 'fuse' module to enable /proc/ overrides)
</span><span class='line'>[staf@centos7 ~]$ </span></code></pre></td></tr></table></div></figure>


<p><strong><em>Have fun</em></strong></p>

<h2>Links</h2>

<ul>
<li><a href="https://docs.fedoraproject.org/quick-docs/en-US/using-nested-virtualization-in-kvm.html"><a href="https://docs.fedoraproject.org/quick-docs/en-US/using-nested-virtualization-in-kvm.html">https://docs.fedoraproject.org/quick-docs/en-US/using-nested-virtualization-in-kvm.html</a></a></li>
<li><a href="https://wiki.archlinux.org/index.php/KVM#Nested_virtualization"><a href="https://wiki.archlinux.org/index.php/KVM#Nested_virtualization">https://wiki.archlinux.org/index.php/KVM#Nested_virtualization</a></a></li>
<li><a href="https://www.linux-kvm.org/page/Nested_Guests"><a href="https://www.linux-kvm.org/page/Nested_Guests">https://www.linux-kvm.org/page/Nested_Guests</a></a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[32 Bits Matters!]]></title>
    <link href="https://stafwag.github.io/blog/blog/2018/05/11/32-bits-matters/"/>
    <updated>2018-05-11T09:08:17+02:00</updated>
    <id>https://stafwag.github.io/blog/blog/2018/05/11/32-bits-matters</id>
    <content type="html"><![CDATA[<p><img class="right" src="https://stafwag.github.io/blog/images/32bits_opnsense.jpg" width="500" height="411" title="&#34;32bits_opnsense.jpg&#34;" alt="&#34;32bits_opnsense.jpg&#34;"></p>

<h3>pfsense 2.3</h3>

<p>My firewall is a <a href="https://pcengines.ch/">pcengines</a> <a href="https://pcengines.ch/alix2d13.htm">alix</a>.</p>

<p>It was running <a href="https://www.pfsense.org">pfsense</a> and was quite happy about it. Pfsense dropped support for 32 bits in their <a href="https://doc.pfsense.org/index.php/Does_pfSense_support_64_bit_systems">pfsense 2.4 release</a>.</p>

<p>This would left me with a unsupported firewall which was one of the reasons to use pfsense instead of a closed source commercial router.</p>

<p>I could have moved to a new firewall like the <a href="https://pcengines.ch/apu.htm">pcengines apu</a> but there is no reason to replace hardware that works fine.</p>

<p>The nice thing about opensource software is that we&rsquo;ve options to choose from if software doesn&rsquo;t match your usecase we&rsquo;ve other options to choose from.</p>

<h3>OPNsense</h3>

<p>So I decided to give <a href="https://opnsense.org/">opnsense</a> a try. OPNsense is a fork of pfsense, both are a fork of <a href="https://m0n0.ch/wall/index.php">m0n0wall</a>.</p>

<p><img class="left" src="https://stafwag.github.io/blog/images/opnsense_swapspace.png" width="500" height="584" title="&#34;opnsense_swapspace.png&#34;" alt="&#34;opnsense_swapspace.png&#34;"></p>

<h4>swapspace</h4>

<p>My firewall only has 256 MB of memory which is a bit low even for a firewall.</p>

<p>The OPNsense developers made it very easy to add swapspace from the GUI. To add swap space go to [ System ] > [ Miscellaneous ] and activate the [ Add a 2 GB swap file to the system ] checkbox.</p>

<p>I&rsquo;m verify satisfied with the upgrade from pfsense to OPNsense, OPNsense has a new release very month which is nice to get the latest security updates and it&rsquo;s possible to audit the systems for security updates from the GUI.</p>

<p><img class="right" src="https://stafwag.github.io/blog/images/duckdns_icon.png" width="150" height="150" title="&#34;duckdns&#34;" alt="&#34;duckdns&#34;"></p>

<h3>DuckDns</h3>

<p>I move my ADSL with a fixed ip address to a VDSL line with a dynamic ip address so I was looking a good free dynamic dns provider and settled with <a href="https://www.duckdns.org/">duckdns</a>.</p>

<p><strong><em> Have fun </em></strong></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How to Start DLM Monitoring on a VDSL Line in Belgium]]></title>
    <link href="https://stafwag.github.io/blog/blog/2018/04/27/how-to-start-dlm-monitoring-on-a-vdsl-line-in-belgium/"/>
    <updated>2018-04-27T12:28:55+02:00</updated>
    <id>https://stafwag.github.io/blog/blog/2018/04/27/how-to-start-dlm-monitoring-on-a-vdsl-line-in-belgium</id>
    <content type="html"><![CDATA[<p>In Belgium/Flanders we have two main internet line providers;</p>

<ul>
<li><a href="https://www.telnet.be">telenet</a> the cablenet network provider.</li>
<li><a href="https://www.proximus.be">proximus</a> is the telephone network provider.</li>
</ul>


<p>On telephone network there are alternative internet providers but they use the network
of proximus.</p>

<p>I switched my internet connection from ADSL to VDSL and switched to a new provider ( <a href="https://www.edpnet.be">edpnet</a>).
The internet speed was below the expectations and my modem reported errors on the line. After fixing the internal phone cabbeling in my appartment I wanted the retrigger the <a href="https://www.edpnet.be/en/support/ordering/internet/what-is-dlm-(dynamic-line-management).html">DLM</a> monitoring.</p>

<p>The process is explained in the this post <a href="https://userbase.be/forum/viewtopic.php?t=48767"><a href="https://userbase.be/forum/viewtopic.php?t=48767">https://userbase.be/forum/viewtopic.php?t=48767</a></a> at <a href="https://userbase.be">usebase.be</a></p>

<p>To start the DLM monitoring in Belgium you need to call 0800 22 424 and type in your line number. If you don&rsquo;t have a proximus phone number the line number is not the same as your phone number. To get your line number you need to connect an analog phone to our line and call 1924 this will read aloud your line number.</p>

<p><strong><em> Have fun </em></strong></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[High Screen Resolution on a KVM Virtual Machine With QXL]]></title>
    <link href="https://stafwag.github.io/blog/blog/2018/04/22/high-screen-resolution-on-a-kvm-virtual-machine-with-qxl/"/>
    <updated>2018-04-22T10:04:46+02:00</updated>
    <id>https://stafwag.github.io/blog/blog/2018/04/22/high-screen-resolution-on-a-kvm-virtual-machine-with-qxl</id>
    <content type="html"><![CDATA[<p>When you create an new virtual KVM virtual system the video ram is limited to 16MB by default to use a higer screen resolution you need
to increase the video ram. The available resolution reported by the virtual screen may also not include the resolution that you want to
utilize.</p>

<p>You&rsquo;ll find my journey to enable higher screen resolutions in my KVM (qemu) virtual systems below.</p>

<h2>Ubuntu 16.04</h2>

<p>There is an issue with Ubuntu 16.04 and the latest HWE kernel <a href="https://wiki.ubuntu.com/Kernel/LTSEnablementStack"><a href="https://wiki.ubuntu.com/Kernel/LTSEnablementStack">https://wiki.ubuntu.com/Kernel/LTSEnablementStack</a></a>. Even a full HD resultion (1920 x 1080 ) if you have the latest HWE kernel on your system.</p>

<p>To resolve this issue your can uninstall the latest kernel or install the LTS kernel.</p>

<h4>Install the LTS Kernel</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@ubuntu:~$ sudo apt-get install linux-generic-lts-xenial
</span><span class='line'>Reading package lists... Done
</span><span class='line'>Building dependency tree       
</span><span class='line'>Reading state information... Done
</span><span class='line'>The following additional packages will be installed:
</span><span class='line'>  linux-generic linux-headers-4.4.0-119 linux-headers-4.4.0-119-generic linux-headers-generic
</span><span class='line'>  linux-image-4.4.0-119-generic linux-image-extra-4.4.0-119-generic linux-image-generic
</span><span class='line'>Suggested packages:
</span><span class='line'>  fdutils linux-doc-4.4.0 | linux-source-4.4.0 linux-tools
</span><span class='line'>The following NEW packages will be installed:
</span><span class='line'>  linux-generic linux-generic-lts-xenial linux-headers-4.4.0-119 linux-headers-4.4.0-119-generic
</span><span class='line'>  linux-headers-generic linux-image-4.4.0-119-generic linux-image-extra-4.4.0-119-generic linux-image-generic
</span><span class='line'>0 upgraded, 8 newly installed, 0 to remove and 0 not upgraded.
</span><span class='line'>Need to get 69,3 MB of archives.
</span><span class='line'>After this operation, 301 MB of additional disk space will be used.
</span><span class='line'>Do you want to continue? [Y/n] 
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>Setting up linux-image-generic (4.4.0.119.125) ...
</span><span class='line'>Setting up linux-headers-4.4.0-119 (4.4.0-119.143) ...
</span><span class='line'>Setting up linux-headers-4.4.0-119-generic (4.4.0-119.143) ...
</span><span class='line'>Setting up linux-headers-generic (4.4.0.119.125) ...
</span><span class='line'>Setting up linux-generic (4.4.0.119.125) ...
</span><span class='line'>Setting up linux-generic-lts-xenial (4.4.0.119.125) ...
</span><span class='line'>staf@ubuntu:~$ </span></code></pre></td></tr></table></div></figure>


<h4>Remove the HWE kernel</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@ubuntu:~$ sudo apt-get purge linux-image-4.13*
</span><span class='line'>Reading package lists... Done
</span><span class='line'>Building dependency tree       
</span><span class='line'>Reading state information... Done
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>done
</span><span class='line'>The link /vmlinuz.old is a damaged link
</span><span class='line'>Removing symbolic link vmlinuz.old 
</span><span class='line'> you may need to re-run your boot loader[grub]
</span><span class='line'>The link /initrd.img.old is a damaged link
</span><span class='line'>Removing symbolic link initrd.img.old 
</span><span class='line'> you may need to re-run your boot loader[grub]
</span><span class='line'>Purging configuration files for linux-image-4.13.0-38-generic (4.13.0-38.43~16.04.1) ...
</span><span class='line'>Examining /etc/kernel/postrm.d .
</span><span class='line'>run-parts: executing /etc/kernel/postrm.d/initramfs-tools 4.13.0-38-generic /boot/vmlinuz-4.13.0-38-generic
</span><span class='line'>run-parts: executing /etc/kernel/postrm.d/zz-update-grub 4.13.0-38-generic /boot/vmlinuz-4.13.0-38-generic</span></code></pre></td></tr></table></div></figure>


<h4>Cleanup</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@ubuntu:~$ sudo apt autoremove
</span><span class='line'>Reading package lists... Done
</span><span class='line'>Building dependency tree       
</span><span class='line'>Reading state information... Done
</span><span class='line'>The following packages will be REMOVED:
</span><span class='line'>  linux-headers-4.13.0-36 linux-headers-4.13.0-36-generic linux-headers-generic-hwe-16.04
</span><span class='line'>0 upgraded, 0 newly installed, 3 to remove and 0 not upgraded.
</span><span class='line'>After this operation, 83,1 MB disk space will be freed.
</span><span class='line'>Do you want to continue? [Y/n] 
</span><span class='line'>(Reading database ... 234149 files and directories currently installed.)
</span><span class='line'>Removing linux-headers-4.13.0-36-generic (4.13.0-36.40~16.04.1) ...
</span><span class='line'>Removing linux-headers-4.13.0-36 (4.13.0-36.40~16.04.1) ...
</span><span class='line'>Removing linux-headers-generic-hwe-16.04 (4.13.0.38.57) ...
</span><span class='line'>staf@ubuntu:~$ </span></code></pre></td></tr></table></div></figure>


<h4>Reboot</h4>

<p>After a reboot higher resolutions are possible on ubuntu 16.04</p>

<h1>Increase the video RAM</h1>

<h2>Required video ram</h2>

<p>When you create a new KVM virtual machine it has 16MB of video RAM.
Below you&rsquo;ll the calculation for the required video RAM for a 4k resolution ( 3840 x 2160 ).</p>

<p>3840 x 2160 = 8294400 <br/>
8294400 x 32 = 265420800 <br/ >
265420800 / 8 = 33177600 <br />
33177600 / (1024*1024) = 31.640625 MB</p>

<p>So 32 MB video ram is enough for a 4k resolution, to take some overhead into account we&rsquo;ll increase the video ram to 64 MB.</p>

<h2>list the domains</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[swagemakers@staflaptop ~]$ sudo virsh
</span><span class='line'>Welcome to virsh, the virtualization interactive terminal.
</span><span class='line'>
</span><span class='line'>Type:  'help' for help with commands
</span><span class='line'>       'quit' to quit
</span><span class='line'>
</span><span class='line'>virsh # list --all
</span><span class='line'> Id    Name                           State
</span><span class='line'>----------------------------------------------------
</span><span class='line'> -     centos7.0                      shut off
</span><span class='line'> -     debian                         shut off
</span><span class='line'> -     fedora27                       shut off
</span><span class='line'>
</span><span class='line'>virsh # </span></code></pre></td></tr></table></div></figure>


<h4>edit the domain settings</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>virsh # edit --domain debian</span></code></pre></td></tr></table></div></figure>


<h5>update the memory settings</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;video&gt;
</span><span class='line'>  &lt;model type='qxl' ram='65536' vram='65536' vgamem='16384' heads='1' primary='yes'/&gt;
</span><span class='line'>  &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x0'/&gt;
</span><span class='line'>&lt;/video&gt;
</span><span class='line'>&lt;redirdev bus='usb' type='spicevmc'&gt;
</span></code></pre></td></tr></table></div></figure>


<p>to</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;video&gt;
</span><span class='line'>  &lt;model type='qxl' ram='65536' vram='65536' vgamem='65536' heads='1' primary='yes'/&gt;
</span><span class='line'>  &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x0'/&gt;
</span><span class='line'>&lt;/video&gt;</span></code></pre></td></tr></table></div></figure>


<h4>xrandr</h4>

<p>Even with the additional RAM higer resolution aren&rsquo;t possible (yet), the virtual screen doesn&rsquo;t report the higer screen resolution. It&rsquo;s possible to add the higher screen resolution with xrandr.</p>

<h5>display current settings</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@debian:~$ xrandr 
</span><span class='line'>Screen 0: minimum 320 x 200, current 1920 x 1080, maximum 8192 x 8192
</span><span class='line'>Virtual-0 connected primary 1920x1080+0+0 0mm x 0mm
</span><span class='line'>   1024x768      59.95 +
</span><span class='line'>   1920x1200     59.95  
</span><span class='line'>   1920x1080     60.00* 
</span><span class='line'>   1600x1200     59.95  
</span><span class='line'>   1680x1050     60.00  
</span><span class='line'>   1400x1050     60.00  
</span><span class='line'>   1280x1024     59.95  
</span><span class='line'>   1440x900      59.99  
</span><span class='line'>   1280x960      59.99  
</span><span class='line'>   1280x854      59.95  
</span><span class='line'>   1280x800      59.96  
</span><span class='line'>   1280x720      59.97  
</span><span class='line'>   1152x768      59.95  
</span><span class='line'>   800x600       59.96  
</span><span class='line'>   848x480       59.94  
</span><span class='line'>   720x480       59.94  
</span><span class='line'>   640x480       59.94  
</span><span class='line'>Virtual-1 disconnected
</span><span class='line'>Virtual-2 disconnected
</span><span class='line'>Virtual-3 disconnected
</span><span class='line'>staf@debian:~$ </span></code></pre></td></tr></table></div></figure>


<h6>get the modeline</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@debian:~$ cvt 2560 1440 
</span><span class='line'># 2560x1440 59.96 Hz (CVT 3.69M9) hsync: 89.52 kHz; pclk: 312.25 MHz
</span><span class='line'>Modeline "2560x1440_60.00"  312.25  2560 2752 3024 3488  1440 1443 1448 1493 -hsync +vsync
</span><span class='line'>staf@debian:~$ </span></code></pre></td></tr></table></div></figure>


<h6># create the new mode line</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@debian:~$ xrandr --newmode "2560x1440_60.00"  312.25  2560 2752 3024 3488  1440 1443 1448 1493 -hsync +vsync
</span><span class='line'>staf@debian:~$ </span></code></pre></td></tr></table></div></figure>


<h6># add the mode to your screen</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@debian:~$ xrandr --addmode Virtual-0 2560x1440_60.00
</span><span class='line'>staf@debian:~$ </span></code></pre></td></tr></table></div></figure>


<h6># use the new mode</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@debian:~$ xrandr --output Virtual-0 --mode 2560x1440_60.00
</span><span class='line'>staf@debian:~$ </span></code></pre></td></tr></table></div></figure>


<h6>## 4k</h6>

<p>To use a 4k resolution you can use the commands</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@debian:~$  cvt 3840 2160
</span><span class='line'># 3840x2160 59.98 Hz (CVT 8.29M9) hsync: 134.18 kHz; pclk: 712.75 MHz
</span><span class='line'>Modeline "3840x2160_60.00"  712.75  3840 4160 4576 5312  2160 2163 2168 2237 -hsync +vsync
</span><span class='line'>staf@mydevolo:~$ xrandr --newmode "3840x2160_60.00"  712.75  3840 4160 4576 5312  2160 2163 2168 2237 -hsync +vsync
</span><span class='line'>staf@mydevolo:~$ xrandr --addmode Virtual-0 3840x2160_60.00
</span><span class='line'>staf@mydevolo:~$ xrandr --output Virtual-0 --mode 3840x2160_60.00
</span><span class='line'>staf@mydevolo:~$ </span></code></pre></td></tr></table></div></figure>


<h2>Add the new screen resolution permanently</h2>

<h3>Debian &amp; Co</h3>

<p>Create a monitor configuration file in /usr/share/X11/xorg.conf.d</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@mydevolo:/usr/share/X11/xorg.conf.d# vi 10-monitor.conf</span></code></pre></td></tr></table></div></figure>


<p>And add the modeline fgor your screen resolution.
With the Option &ldquo;PreferredMode&rdquo; you can set the prferred resolution.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>section "Monitor"
</span><span class='line'>    Identifier "Virtual-0 "
</span><span class='line'>    Modeline "2560x1440_60.00"  312.25  2560 2752 3024 3488  1440 1443 1448 1493 -hsync +vsync
</span><span class='line'>    Modeline "3840x2160_60.00"  712.75  3840 4160 4576 5312  2160 2163 2168 2237 -hsync +vsync
</span><span class='line'>    Option "PreferredMode" "2560x1440_60.00"
</span><span class='line'>EndSection</span></code></pre></td></tr></table></div></figure>


<h3>Other GNU/Linux distros</h3>

<p>Most other GNU/Linux distribution use /etc/X11/xorg.conf.d/</p>

<p><strong><em> Have fun </em></strong></p>

<h1>Links</h1>

<ul>
<li><a href="https://wiki.archlinux.org/index.php/xrandr"><a href="https://wiki.archlinux.org/index.php/xrandr">https://wiki.archlinux.org/index.php/xrandr</a></a></li>
<li><a href="https://askubuntu.com/questions/994449/ubuntu-16-04-kvm-qxl-guest-cant-change-resolution"><a href="https://askubuntu.com/questions/994449/ubuntu-16-04-kvm-qxl-guest-cant-change-resolution">https://askubuntu.com/questions/994449/ubuntu-16-04-kvm-qxl-guest-cant-change-resolution</a></a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Postfix Smarthost With Authentication]]></title>
    <link href="https://stafwag.github.io/blog/blog/2018/03/04/postfix-smarthost-with-authentication/"/>
    <updated>2018-03-04T08:05:29+01:00</updated>
    <id>https://stafwag.github.io/blog/blog/2018/03/04/postfix-smarthost-with-authentication</id>
    <content type="html"><![CDATA[<p><img class="right" src="https://stafwag.github.io/blog/images/postfix.png" width="400" height="266" title="&#34;postfix&#34;" alt="&#34;postfix&#34;"></p>

<p>I used the relay host of my internet provider but this was causing issues since my email was getting mark as <a href="https://en.wikipedia.org/wiki/Email_spam">SPAM</a> in <a href="https://en.wikipedia.org/wiki/Gmail">gmail</a>.
<br />&nbsp;<br />
It was already on my to-do list to move my outgoing mail to my mail provider also to make it easier to move to another <a href="https://en.wikipedia.org/wiki/Internet_service_provider">ISP</a> or to implement <a href="https://en.wikipedia.org/wiki/Sender_Policy_Framework">SPF</a> but was not on the top of my to-do list.
<br />&nbsp;<br />
My email provider requires authentication, so I needed to reconfigure postfix in my FreeBSD mail jail to use a relay host with authentication.</p>

<h3>Install postfix-sasl</h3>

<p>To use authentication with postfix the postfix-sasl package is required.
If postfix is already installed it&rsquo;ll be replace by postfix-sasl.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafmail:/root # pkg install postfix-sasl</span></code></pre></td></tr></table></div></figure>


<h3>Configuration</h3>

<h4>Update the relay host</h4>

<h4>main.cf</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>relayhost = [smtp.mailprovider.domain]:465
</span><span class='line'>smtp_use_tls=yes
</span><span class='line'>smtp_sasl_auth_enable = yes
</span><span class='line'>smtp_sasl_password_maps = hash:/usr/local/etc/postfix/relay_pass
</span><span class='line'>smtp_sasl_security_options =
</span><span class='line'>smtp_tls_wrappermode = yes
</span><span class='line'>smtp_tls_security_level = encrypt</span></code></pre></td></tr></table></div></figure>


<h4>relay_pass</h4>

<p>The credentials are in the relay_pass file the password is in the file as plain-text so we
it with the correct file permissions.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafmail:/usr/local/etc/postfix # touch relay_pass
</span><span class='line'>root@stafmail:/usr/local/etc/postfix # chmod 600 relay_pass
</span><span class='line'>root@stafmail:/usr/local/etc/postfix # vi relay_pass</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[smtp.mailprovider.domain]:465 user:password</span></code></pre></td></tr></table></div></figure>


<h4>Create the hash file.</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafmail:/usr/local/etc/postfix # postmap relay_pass</span></code></pre></td></tr></table></div></figure>


<h4>Verify the file permissions.</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafmail:/usr/local/etc/postfix # ls -l relay_pass*
</span><span class='line'>-rw-------  1 root  wheel      60 Feb 23 22:43 relay_pass
</span><span class='line'>-rw-------  1 root  wheel  131072 Feb 23 22:43 relay_pass.db
</span><span class='line'>root@stafmail:/usr/local/etc/postfix # </span></code></pre></td></tr></table></div></figure>


<h4>Restart</h4>

<p>We replaced postfix with postfix-sasl a restart is required.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafmail:/usr/local/etc/postfix # /usr/local/etc/rc.d/postfix restart</span></code></pre></td></tr></table></div></figure>


<p><strong><em> Have fun </em></strong></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Update Your CPU Microcode on Arch Linux]]></title>
    <link href="https://stafwag.github.io/blog/blog/2018/02/10/update-your-cpu-microcodeon-arch-linux/"/>
    <updated>2018-02-10T08:33:01+01:00</updated>
    <id>https://stafwag.github.io/blog/blog/2018/02/10/update-your-cpu-microcodeon-arch-linux</id>
    <content type="html"><![CDATA[<h1>Meltdown &amp; spectre</h1>

<p>With Meldown <a href="https://nvd.nist.gov/vuln/detail/CVE-2017-5754"><a href="https://nvd.nist.gov/vuln/detail/CVE-2017-5754">https://nvd.nist.gov/vuln/detail/CVE-2017-5754</a></a>, Spectre Variant 1 <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5753"><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5753">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5753</a></a> and Spectre Variant 2 <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5753"><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5753">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5753</a></a> out in the wild there is a lot of confusing going about updating microcode.</p>

<p>There is a &ldquo;Spectre &amp; Meltdown Checker&rdquo; available at <a href="https://github.com/speed47/spectre-meltdown-checker"><a href="https://github.com/speed47/spectre-meltdown-checker">https://github.com/speed47/spectre-meltdown-checker</a></a></p>

<p>Usage is very easy just clone the git repository and run the script.</p>

<h1>Microcode</h1>

<p>Microcode isn&rsquo;t uploaded to the CPU but loaded during the boot strap of the CPU.
Normally the BIOS upload the microcode to the CPU but this can also be done by the by the bootloader, or the operating system kernel.</p>

<h2>Grub</h2>

<p>Normally you get an updated bios for your motherboard or computer vendor to get new microcode for your CPU.</p>

<p>But when your vendor hasn&rsquo;t released a new Bios yet or when you are using old hardware you might not get a new BIOS with updated microcode.</p>

<p>Lucky microcode can also loaded by bootloader this way you can get new microcode without a BIOS update if the new microcode cuase issues you disable it in the bootloader.</p>

<p>The process for Arch Linux is describe at the Arch Wiki <a href="https://wiki.archlinux.org/index.php/Microcode"><a href="https://wiki.archlinux.org/index.php/Microcode">https://wiki.archlinux.org/index.php/Microcode</a></a></p>

<p>You&rsquo;ll find journey how to update the microcode on my Arch GNU/Linux system below.</p>

<h3>Current microcode</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@frija ~]$ dmesg | grep -i microcode
</span><span class='line'>[    2.102649] microcode: sig=0x40661, pf=0x20, revision=0xa
</span><span class='line'>[    2.102981] microcode: Microcode Update Driver: v2.01 &lt;tigran@aivazian.fsnet.co.uk&gt;, Peter Oruba
</span><span class='line'>[staf@frija ~]$ </span></code></pre></td></tr></table></div></figure>


<h3>Install intel-ucode</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# pacman -Syy intel-ucode
</span><span class='line'>:: Synchronizing package databases...
</span><span class='line'> core                     126.8 KiB  12.4M/s 00:00 [######################] 100%
</span><span class='line'> extra                   1629.4 KiB  11.4M/s 00:00 [######################] 100%
</span><span class='line'> community                  4.1 MiB  11.0M/s 00:00 [######################] 100%
</span><span class='line'> multilib                 167.2 KiB  8.16M/s 00:00 [######################] 100%
</span><span class='line'>resolving dependencies...
</span><span class='line'>looking for conflicting packages...
</span><span class='line'>
</span><span class='line'>Packages (1) intel-ucode-20180108-1
</span><span class='line'>
</span><span class='line'>Total Download Size:   1.12 MiB
</span><span class='line'>Total Installed Size:  1.55 MiB
</span><span class='line'>
</span><span class='line'>:: Proceed with installation? [Y/n] y
</span><span class='line'>:: Retrieving packages...
</span><span class='line'> intel-ucode-2018010...  1145.0 KiB   916K/s 00:01 [######################] 100%
</span><span class='line'>(1/1) checking keys in keyring                     [######################] 100%
</span><span class='line'>(1/1) checking package integrity                   [######################] 100%
</span><span class='line'>(1/1) loading package files                        [######################] 100%
</span><span class='line'>(1/1) checking for file conflicts                  [######################] 100%
</span><span class='line'>(1/1) checking available disk space                [######################] 100%
</span><span class='line'>:: Processing package changes...
</span><span class='line'>(1/1) installing intel-ucode                       [######################] 100%
</span><span class='line'>:: Running post-transaction hooks...
</span><span class='line'>(1/1) Arming ConditionNeedsUpdate...
</span><span class='line'>[root@vicky ~]# </span></code></pre></td></tr></table></div></figure>


<h3>Verify the available microcode for your CPU</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@frija ~]$ yaourt  iucode-tool
</span><span class='line'>1 aur/iucode-tool 2.2-1 (59) (4.87)
</span><span class='line'>    Tool to manipulate Intel® IA-32/X86-64 microcode bundles
</span><span class='line'>==&gt; Enter n° of packages to be installed (e.g., 1 2 3 or 1-3)
</span><span class='line'>==&gt; ----------------------------------------------------------
</span><span class='line'>==&gt; 1
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>==&gt; Downloading iucode-tool PKGBUILD from AUR...
</span><span class='line'>x .SRCINFO
</span><span class='line'>x PKGBUILD
</span><span class='line'>oxe commented on 2017-10-01 17:50          
</span><span class='line'>issue with pgp key and have tried various times and not sure what I might be doing wrong but why do you have so many self-signed sigs?
</span><span class='line'>
</span><span class='line'>gpg --keyserver hkps.pool.sks-keyservers.net  --recv-keys C467A717507BBAFED3C160920BD9E81139CB4807
</span><span class='line'>
</span><span class='line'>uid  Henrique de Moraes Holschuh hmh@debian.org
</span><span class='line'>sig!3        0BD9E81139CB4807 2012-06-26  [self-signature]
</span><span class='line'>uid  Henrique de Moraes Holschuh hmh@hmh.eng.br
</span><span class='line'>sig!3        0BD9E81139CB4807 2012-06-26  [self-signature]
</span><span class='line'>sub  A4B9D9AFC03142CD
</span><span class='line'>sig!         0BD9E81139CB4807 2012-06-26  [self-signature]
</span><span class='line'>sub  981C05C79F47CF26
</span><span class='line'>sig!         0BD9E81139CB4807 2012-06-26  [self-signature]
</span><span class='line'>sub  9137FBD3DE6F0A93
</span><span class='line'>sig!         0BD9E81139CB4807 2014-03-23  [self-signature]
</span><span class='line'>sub  FFDB99C00EABDE2E
</span><span class='line'>sig!         0BD9E81139CB4807 2014-03-23  [self-signature]
</span><span class='line'>sub  FE11BFA68B158E98
</span><span class='line'>sig!         0BD9E81139CB4807 2016-03-26  [self-signature]
</span><span class='line'>sub  A4B1618F7F267286
</span><span class='line'>sig!         0BD9E81139CB4807 2016-03-26  [self-signature]
</span><span class='line'>key 0BD9E81139CB4807:
</span><span class='line'>6 duplicate signatures removed
</span><span class='line'>45 signatures not checked due to missing keys
</span><span class='line'>gpg: key 0BD9E81139CB4807: "Henrique de Moraes Holschuh hmh@hmh.eng.br" not changed
</span><span class='line'>gpg: Total number processed: 1
</span><span class='line'>gpg:              unchanged: 1
</span><span class='line'>
</span><span class='line'>please advise
</span><span class='line'>
</span><span class='line'>progandy commented on 2017-10-01 18:19             
</span><span class='line'>@oxe: I am not Henrique, so I don't know what he did with his key that it looks this strange, but it doesn't affect the package. The build works, and the signature is properly validated.
</span><span class='line'>
</span><span class='line'>Cbhihe commented on 2017-10-10 19:12           
</span><span class='line'>Hi:
</span><span class='line'>During install with '$ makepkg -sric ' I got: a PGP signature error: 
</span><span class='line'>
</span><span class='line'>A simplified output follows because I am typing (not copy/pasting) this on a different box than the one (4.13.4.-1-ARCH) where the install took place:
</span><span class='line'>
</span><span class='line'>== making package: iucode-tool 2.2-1 (Tue Oct 10...2017)
</span><span class='line'>== Checking runtime dependencies...
</span><span class='line'>== Checking buildtime dependencies...
</span><span class='line'>== Retrieving sources...
</span><span class='line'>downloads ok [...]
</span><span class='line'>== Validating source files with sha256sums...
</span><span class='line'>passed [...]
</span><span class='line'>== Verifying source files with gpg...
</span><span class='line'>iucode-tool_2.2.tar.xz ... FAILED (unknown public key FE11BFA68B158E98)
</span><span class='line'>== ERROR: One or more PGP signatures could not be verified !
</span><span class='line'>
</span><span class='line'>Can you explain that unknown PGP public key error ? 
</span><span class='line'>Is it a problem on my side ? 
</span><span class='line'>Please advise. I will be waiting for your response before I actually execute that code. Cheers.
</span><span class='line'>
</span><span class='line'>progandy commented on 2017-10-13 15:28             
</span><span class='line'>@Cbhihe: I did not have time and then forgot, sorry. Still, it should be obvious from the previous comments that you need to import the key in your gpg keyring with gpg, as described in the wiki for makepkg [1],[2]
</span><span class='line'>
</span><span class='line'>gpg --recv-keys FE11BFA68B158E98
</span><span class='line'>or
</span><span class='line'>gpg --recv-keys C467A717507BBAFED3C160920BD9E81139CB4807
</span><span class='line'>or
</span><span class='line'>gpg --keyserver hkps.pool.sks-keyservers.net --recv-keys C467A717507BBAFED3C160920BD9E81139CB4807
</span><span class='line'>
</span><span class='line'>[1]: https://wiki.archlinux.org/index.php/Makepkg#Signature_checking
</span><span class='line'>[2]: https://wiki.archlinux.org/index.php/GnuPG#Use_a_keyserver
</span><span class='line'>
</span><span class='line'>Cbhihe commented on 2017-10-14 17:40           
</span><span class='line'>Thank you. Yes it WAS obvious and I had tried 
</span><span class='line'>gpg --recv-keys FE11BFA68B158E98
</span><span class='line'>already, but for some reason I do not get, either the keyring did not register correctly or I screwed up something, or both. 
</span><span class='line'>
</span><span class='line'>I have reinstalled the Gnome keyring, re-imported my saved signatures and  
</span><span class='line'>gpg --keyserver hkps.pool.sks-keyservers.net --recv-keys C467A717507BBAFED3C160920BD9E81139CB4807
</span><span class='line'>worked this time. :-)
</span><span class='line'>Cheers.
</span><span class='line'>
</span><span class='line'>iucode-tool 2.2-1  (2017-09-13 07:49)
</span><span class='line'>( Unsupported package: Potentially dangerous ! )
</span><span class='line'>==&gt; Edit PKGBUILD ? [Y/n] ("A" to abort)
</span><span class='line'>==&gt; ------------------------------------
</span><span class='line'>==&gt; n
</span><span class='line'>
</span><span class='line'>==&gt; iucode-tool dependencies:
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>==&gt; Continue building iucode-tool ? [Y/n]
</span><span class='line'>==&gt; -------------------------------------
</span><span class='line'>==&gt; 
</span><span class='line'>
</span><span class='line'>==&gt; Building and installing package
</span><span class='line'>==&gt; Making package: iucode-tool 2.2-1 (Sun Jan 21 12:48:37 CET 2018)
</span><span class='line'>==&gt; Checking runtime dependencies...
</span><span class='line'>==&gt; Checking buildtime dependencies...
</span><span class='line'>==&gt; Retrieving sources...
</span><span class='line'>  -&gt; Downloading iucode-tool_2.2.tar.xz...
</span><span class='line'>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span><span class='line'>                                 Dload  Upload   Total   Spent    Left  Speed
</span><span class='line'>100  146k  100  146k    0     0  74948      0  0:00:02  0:00:02 --:--:-- 63193
</span><span class='line'>  -&gt; Downloading iucode-tool_2.2.tar.xz.asc...
</span><span class='line'>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span><span class='line'>                                 Dload  Upload   Total   Spent    Left  Speed
</span><span class='line'>100   833  100   833    0     0    833      0  0:00:01  0:00:01 --:--:--   478
</span><span class='line'>==&gt; Validating source files with sha256sums...
</span><span class='line'>    iucode-tool_2.2.tar.xz ... Passed
</span><span class='line'>    iucode-tool_2.2.tar.xz.asc ... Skipped
</span><span class='line'>==&gt; Verifying source file signatures with gpg...
</span><span class='line'>    iucode-tool_2.2.tar.xz ... Passed
</span><span class='line'>==&gt; Extracting sources...
</span><span class='line'>  -&gt; Extracting iucode-tool_2.2.tar.xz with bsdtar
</span><span class='line'>==&gt; Starting build()...
</span><span class='line'>checking build system type... x86_64-pc-linux-gnu
</span><span class='line'>checking host system type... x86_64-pc-linux-gnu
</span><span class='line'>checking for a BSD-compatible install... /usr/bin/install -c
</span><span class='line'>checking whether build environment is sane... yes
</span><span class='line'>checking for a thread-safe mkdir -p... /usr/bin/mkdir -p
</span><span class='line'>checking for gawk... gawk
</span><span class='line'>checking whether make sets $(MAKE)... yes
</span><span class='line'>checking whether make supports nested variables... yes
</span><span class='line'>checking whether configure.ac should try to override CFLAGS... no
</span><span class='line'>checking whether configure.ac should try to override LDFLAGS... no
</span><span class='line'>checking for style of include used by make... GNU
</span><span class='line'>checking for gcc... gcc
</span><span class='line'>checking whether the C compiler works... yes
</span><span class='line'>checking for C compiler default output file name... a.out
</span><span class='line'>checking for suffix of executables... 
</span><span class='line'>checking whether we are cross compiling... no
</span><span class='line'>checking for suffix of object files... o
</span><span class='line'>checking whether we are using the GNU C compiler... yes
</span><span class='line'>checking whether gcc accepts -g... yes
</span><span class='line'>checking for gcc option to accept ISO C89... none needed
</span><span class='line'>checking whether gcc understands -c and -o together... yes
</span><span class='line'>checking dependency style of gcc... gcc3
</span><span class='line'>checking how to run the C preprocessor... gcc -E
</span><span class='line'>checking for grep that handles long lines and -e... /usr/bin/grep
</span><span class='line'>checking for egrep... /usr/bin/grep -E
</span><span class='line'>checking for ANSI C header files... yes
</span><span class='line'>checking for sys/types.h... yes
</span><span class='line'>checking for sys/stat.h... yes
</span><span class='line'>checking for stdlib.h... yes
</span><span class='line'>checking for string.h... yes
</span><span class='line'>checking for memory.h... yes
</span><span class='line'>checking for strings.h... yes
</span><span class='line'>checking for inttypes.h... yes
</span><span class='line'>checking for stdint.h... yes
</span><span class='line'>checking for unistd.h... yes
</span><span class='line'>checking minix/config.h usability... no
</span><span class='line'>checking minix/config.h presence... no
</span><span class='line'>checking for minix/config.h... no
</span><span class='line'>checking whether it is safe to define __EXTENSIONS__... yes
</span><span class='line'>checking for gcc... (cached) gcc
</span><span class='line'>checking whether we are using the GNU C compiler... (cached) yes
</span><span class='line'>checking whether gcc accepts -g... (cached) yes
</span><span class='line'>checking for gcc option to accept ISO C89... (cached) none needed
</span><span class='line'>checking whether gcc understands -c and -o together... (cached) yes
</span><span class='line'>checking dependency style of gcc... (cached) gcc3
</span><span class='line'>checking for ANSI C header files... (cached) yes
</span><span class='line'>checking fcntl.h usability... yes
</span><span class='line'>checking fcntl.h presence... yes
</span><span class='line'>checking for fcntl.h... yes
</span><span class='line'>checking for stdint.h... (cached) yes
</span><span class='line'>checking for stdlib.h... (cached) yes
</span><span class='line'>checking for string.h... (cached) yes
</span><span class='line'>checking for unistd.h... (cached) yes
</span><span class='line'>checking time.h usability... yes
</span><span class='line'>checking time.h presence... yes
</span><span class='line'>checking for time.h... yes
</span><span class='line'>checking cpuid.h usability... yes
</span><span class='line'>checking cpuid.h presence... yes
</span><span class='line'>checking for cpuid.h... yes
</span><span class='line'>checking whether byte ordering is bigendian... no
</span><span class='line'>checking for inline... inline
</span><span class='line'>checking for int32_t... yes
</span><span class='line'>checking for size_t... yes
</span><span class='line'>checking for ssize_t... yes
</span><span class='line'>checking for uint16_t... yes
</span><span class='line'>checking for uint32_t... yes
</span><span class='line'>checking for uint8_t... yes
</span><span class='line'>checking for stdlib.h... (cached) yes
</span><span class='line'>checking for GNU libc compatible malloc... yes
</span><span class='line'>checking for stdlib.h... (cached) yes
</span><span class='line'>checking for GNU libc compatible realloc... yes
</span><span class='line'>checking whether lstat correctly handles trailing slash... yes
</span><span class='line'>checking whether stat accepts an empty string... no
</span><span class='line'>checking for memset... yes
</span><span class='line'>checking for strcasecmp... yes
</span><span class='line'>checking for strdup... yes
</span><span class='line'>checking for strerror... yes
</span><span class='line'>checking for strrchr... yes
</span><span class='line'>checking for strtoul... yes
</span><span class='line'>checking for timegm... yes
</span><span class='line'>checking for library containing argp_parse... none required
</span><span class='line'>checking for special C compiler options needed for large files... no
</span><span class='line'>checking for _FILE_OFFSET_BITS value needed for large files... no
</span><span class='line'>checking for flockfile... yes
</span><span class='line'>checking for fgets_unlocked... yes
</span><span class='line'>configure: project-wide base CPPFLAGS: -D_FORTIFY_SOURCE=2
</span><span class='line'>configure: project-wide base CFLAGS:   -march=x86-64 -mtune=generic -O2 -pipe -fstack-protector-strong -fno-plt
</span><span class='line'>configure: project-wide base LDFLAGS:  -Wl,-O1,--sort-common,--as-needed,-z,relro,-z,now
</span><span class='line'>checking that generated files are newer than configure... done
</span><span class='line'>configure: creating ./config.status
</span><span class='line'>config.status: creating Makefile
</span><span class='line'>config.status: creating iucode_tool.8
</span><span class='line'>config.status: creating iucode_tool_config.h
</span><span class='line'>config.status: executing depfiles commands
</span><span class='line'>make  all-am
</span><span class='line'>make[1]: Entering directory '/home/staf/tmp/yaourt-tmp-staf/aur-iucode-tool/src/iucode-tool-2.2'
</span><span class='line'>gcc -DHAVE_CONFIG_H -I.   -D_FORTIFY_SOURCE=2  -march=x86-64 -mtune=generic -O2 -pipe -fstack-protector-strong -fno-plt -MT intel_microcode.o -MD -MP -MF .deps/intel_microcode.Tpo -c -o intel_microcode.o intel_microcode.c
</span><span class='line'>gcc -DHAVE_CONFIG_H -I.   -D_FORTIFY_SOURCE=2  -march=x86-64 -mtune=generic -O2 -pipe -fstack-protector-strong -fno-plt -MT iucode_tool.o -MD -MP -MF .deps/iucode_tool.Tpo -c -o iucode_tool.o iucode_tool.c
</span><span class='line'>mv -f .deps/intel_microcode.Tpo .deps/intel_microcode.Po
</span><span class='line'>mv -f .deps/iucode_tool.Tpo .deps/iucode_tool.Po
</span><span class='line'>gcc  -march=x86-64 -mtune=generic -O2 -pipe -fstack-protector-strong -fno-plt  -Wl,-O1,--sort-common,--as-needed,-z,relro,-z,now -o iucode_tool intel_microcode.o iucode_tool.o  
</span><span class='line'>make[1]: Leaving directory '/home/staf/tmp/yaourt-tmp-staf/aur-iucode-tool/src/iucode-tool-2.2'
</span><span class='line'>==&gt; Entering fakeroot environment...
</span><span class='line'>==&gt; Starting package()...
</span><span class='line'>make[1]: Entering directory '/home/staf/tmp/yaourt-tmp-staf/aur-iucode-tool/src/iucode-tool-2.2'
</span><span class='line'> /usr/bin/mkdir -p '/home/staf/tmp/yaourt-tmp-staf/aur-iucode-tool/pkg/iucode-tool//usr/bin'
</span><span class='line'> /usr/bin/mkdir -p '/home/staf/tmp/yaourt-tmp-staf/aur-iucode-tool/pkg/iucode-tool//usr/share/man/man8'
</span><span class='line'>  /usr/bin/install -c iucode_tool '/home/staf/tmp/yaourt-tmp-staf/aur-iucode-tool/pkg/iucode-tool//usr/bin'
</span><span class='line'> /usr/bin/install -c -m 644 iucode_tool.8 '/home/staf/tmp/yaourt-tmp-staf/aur-iucode-tool/pkg/iucode-tool//usr/share/man/man8'
</span><span class='line'>make[1]: Leaving directory '/home/staf/tmp/yaourt-tmp-staf/aur-iucode-tool/src/iucode-tool-2.2'
</span><span class='line'>==&gt; Tidying install...
</span><span class='line'>  -&gt; Removing libtool files...
</span><span class='line'>  -&gt; Purging unwanted files...
</span><span class='line'>  -&gt; Removing static library files...
</span><span class='line'>  -&gt; Stripping unneeded symbols from binaries and libraries...
</span><span class='line'>  -&gt; Compressing man and info pages...
</span><span class='line'>==&gt; Checking for packaging issue...
</span><span class='line'>==&gt; Creating package "iucode-tool"...
</span><span class='line'>  -&gt; Generating .PKGINFO file...
</span><span class='line'>  -&gt; Generating .BUILDINFO file...
</span><span class='line'>  -&gt; Generating .MTREE file...
</span><span class='line'>  -&gt; Compressing package...
</span><span class='line'>==&gt; Leaving fakeroot environment.
</span><span class='line'>==&gt; Finished making: iucode-tool 2.2-1 (Sun Jan 21 12:48:44 CET 2018)
</span><span class='line'>==&gt; Cleaning up...
</span><span class='line'>
</span><span class='line'>==&gt; Continue installing iucode-tool ? [Y/n]
</span><span class='line'>==&gt; [v]iew package contents [c]heck package with namcap
</span><span class='line'>==&gt; ---------------------------------------------------
</span><span class='line'>==&gt; y
</span><span class='line'>
</span><span class='line'>loading packages...
</span><span class='line'>resolving dependencies...
</span><span class='line'>looking for conflicting packages...
</span><span class='line'>
</span><span class='line'>Packages (1) iucode-tool-2.2-1
</span><span class='line'>
</span><span class='line'>Total Installed Size:  0.06 MiB
</span><span class='line'>
</span><span class='line'>:: Proceed with installation? [Y/n] y
</span><span class='line'>(1/1) checking keys in keyring                                   [####################################] 100%
</span><span class='line'>(1/1) checking package integrity                                 [####################################] 100%
</span><span class='line'>(1/1) loading package files                                      [####################################] 100%
</span><span class='line'>(1/1) checking for file conflicts                                [####################################] 100%
</span><span class='line'>(1/1) checking available disk space                              [####################################] 100%
</span><span class='line'>:: Processing package changes...
</span><span class='line'>(1/1) installing iucode-tool                                     [####################################] 100%
</span><span class='line'>ldconfig: File /usr/lib/libmlt.so.6.4.0 is empty, not checked.
</span><span class='line'>ldconfig: File /usr/lib/libmlt++.so.6.4.0 is empty, not checked.
</span><span class='line'>ldconfig: File /usr/lib32/libmng.so.2 is empty, not checked.
</span><span class='line'>ldconfig: File /usr/lib32/libmng.so is empty, not checked.
</span><span class='line'>ldconfig: File /usr/lib32/libmng.so.2.0.2 is empty, not checked.
</span><span class='line'>:: Running post-transaction hooks...
</span><span class='line'>(1/1) Arming ConditionNeedsUpdate...
</span><span class='line'>[staf@frija ~]$ </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@frija ~]# bsdtar -Oxf /boot/intel-ucode.img | iucode_tool -tb -lS - 
</span><span class='line'>iucode_tool: system has processor(s) with signature 0x00040661
</span><span class='line'>microcode bundle 1: (stdin)
</span><span class='line'>selected microcodes:
</span><span class='line'>  001/143: sig 0x00040661, pf_mask 0x32, 2017-11-20, rev 0x0018, size 25600
</span><span class='line'>[root@frija ~]# </span></code></pre></td></tr></table></div></figure>


<h3>Recreate grub.cfg</h3>

<p>grub-mkconfig will detect the microcode and add it the grub configuration.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# grub-mkconfig -o /boot/grub/grub.cfg
</span><span class='line'>Generating grub configuration file ...
</span><span class='line'>Found linux image: /boot/vmlinuz-linux-lts
</span><span class='line'>Found initrd image(s) in /boot: intel-ucode.img initramfs-linux-lts.img
</span><span class='line'>Found fallback initrd image(s) in /boot: intel-ucode.img initramfs-linux-lts-fallback.img
</span><span class='line'>Found linux image: /boot/vmlinuz-linux-hardened
</span><span class='line'>Found initrd image(s) in /boot: intel-ucode.img initramfs-linux-hardened.img
</span><span class='line'>Found fallback initrd image(s) in /boot: intel-ucode.img initramfs-linux-hardened-fallback.img
</span><span class='line'>Found linux image: /boot/vmlinuz-linux-ck
</span><span class='line'>Found initrd image(s) in /boot: intel-ucode.img initramfs-linux-ck.img
</span><span class='line'>Found fallback initrd image(s) in /boot: intel-ucode.img initramfs-linux-ck-fallback.img
</span><span class='line'>Found linux image: /boot/vmlinuz-linux
</span><span class='line'>Found initrd image(s) in /boot: intel-ucode.img initramfs-linux.img
</span><span class='line'>Found fallback initrd image(s) in /boot: intel-ucode.img initramfs-linux-fallback.img
</span><span class='line'>done
</span><span class='line'>[root@vicky ~]# </span></code></pre></td></tr></table></div></figure>


<p>When take a look at the newly created grub.cfg you see that microcode image is added to the initrd image.
If you new micro code cause issue you can just remove the entry in grub configuration</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# cat /boot/grub/grub.cfg | grep initrd
</span><span class='line'>  initrd  /__active/rootvol/boot/intel-ucode.img /__active/rootvol/boot/initramfs-linux-lts.img
</span><span class='line'>  initrd  /__active/rootvol/boot/intel-ucode.img /__active/rootvol/boot/initramfs-linux-lts-fallback.img
</span><span class='line'>  initrd  /__active/rootvol/boot/intel-ucode.img /__active/rootvol/boot/initramfs-linux-hardened.img
</span><span class='line'>  initrd  /__active/rootvol/boot/intel-ucode.img /__active/rootvol/boot/initramfs-linux-hardened-fallback.img
</span><span class='line'>  initrd  /__active/rootvol/boot/intel-ucode.img /__active/rootvol/boot/initramfs-linux-ck.img
</span><span class='line'>  initrd  /__active/rootvol/boot/intel-ucode.img /__active/rootvol/boot/initramfs-linux-ck-fallback.img
</span><span class='line'>  initrd  /__active/rootvol/boot/intel-ucode.img /__active/rootvol/boot/initramfs-linux.img
</span><span class='line'>  initrd  /__active/rootvol/boot/intel-ucode.img /__active/rootvol/boot/initramfs-linux-fallback.img
</span><span class='line'>[root@vicky ~]# 
</span></code></pre></td></tr></table></div></figure>


<h2>Reboot your system and verify</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@frija ~]$ dmesg | grep -i microcode
</span><span class='line'>[    0.000000] microcode: microcode updated early to revision 0x18, date = 2017-11-20
</span><span class='line'>[    1.852726] microcode: sig=0x40661, pf=0x20, revision=0x18
</span><span class='line'>[    1.853029] microcode: Microcode Update Driver: v2.2.
</span><span class='line'>[staf@frija ~]$ </span></code></pre></td></tr></table></div></figure>


<p><strong><em>Have fun</em></strong></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Bacula on FreeBSD (Part 3 Storage Setup)]]></title>
    <link href="https://stafwag.github.io/blog/blog/2017/12/27/bacula-on-freebsd-part3/"/>
    <updated>2017-12-27T11:25:25+01:00</updated>
    <id>https://stafwag.github.io/blog/blog/2017/12/27/bacula-on-freebsd-part3</id>
    <content type="html"><![CDATA[<p><img class="right" src="https://stafwag.github.io/blog/images/bacula_setup.jpg" width="500" height="416" title="&#34;bacula setup&#34;" alt="&#34;bacula setup&#34;"></p>

<p>I finally got the time to continue with my <a href="https://blog.bacula.org/">bacula</a> backup setup. See my previous posts about the start of my bacula setup.</p>

<ul>
<li><a href="http://stafwag.github.io/blog/blog/2017/08/06/bacula-on-freebsd:w_part1/">bacula on freebsd_part 1</a></li>
<li><a href="http://stafwag.github.io/blog/blog/2017/09/09/bacula-on-freebsd-part2/">bacula on freebsd part 2</a></li>
</ul>


<h1>Storage setup</h1>

<p>I created a new zfs pool &ldquo;bigpool&rdquo; with some old harddisks I probably need to replace them with bigger harddisk in the further.</p>

<h2>zfs filesystem</h2>

<p>First we create a zfs filesystem for our bacula storage.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # zfs create bigpool/bacula
</span><span class='line'>root@rataplan:~ # </span></code></pre></td></tr></table></div></figure>


<h2>delegate to jail</h2>

<h3>jailed</h3>

<p>We want to use the zfs dataset in the bacula jail so we need to delegate the control to the dataset into the bacula jail.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # zfs set jailed=on bigpool/bacula
</span><span class='line'>root@rataplan:~ # zfs jail stafbacula bigpool/bacula</span></code></pre></td></tr></table></div></figure>


<h3>verify</h3>

<p>When we logon to the jail we see that the zfs dateset is available.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # ezjail-admin console stafbacula
</span><span class='line'>Last login: Wed Dec 27 10:52:27 on pts/2
</span><span class='line'>FreeBSD 11.1-RELEASE-p4 (GENERIC) #0: Tue Nov 14 06:12:40 UTC 2017
</span><span class='line'>
</span><span class='line'>Welcome to FreeBSD!
</span><span class='line'>
</span><span class='line'>Release Notes, Errata: https://www.FreeBSD.org/releases/
</span><span class='line'>Security Advisories:   https://www.FreeBSD.org/security/
</span><span class='line'>FreeBSD Handbook:      https://www.FreeBSD.org/handbook/
</span><span class='line'>FreeBSD FAQ:           https://www.FreeBSD.org/faq/
</span><span class='line'>Questions List: https://lists.FreeBSD.org/mailman/listinfo/freebsd-questions/
</span><span class='line'>FreeBSD Forums:        https://forums.FreeBSD.org/
</span><span class='line'>
</span><span class='line'>Documents installed with the system are in the /usr/local/share/doc/freebsd/
</span><span class='line'>directory, or can be installed later with:  pkg install en-freebsd-doc
</span><span class='line'>For other languages, replace "en" with a language code like de or fr.
</span><span class='line'>
</span><span class='line'>Show the version of FreeBSD installed:  freebsd-version ; uname -a
</span><span class='line'>Please include that output and any error messages when posting questions.
</span><span class='line'>Introduction to manual pages:  man man
</span><span class='line'>FreeBSD directory layout:      man hier
</span><span class='line'>
</span><span class='line'>Edit /etc/motd to change this login announcement.
</span><span class='line'>You have new mail.
</span><span class='line'>root@stafbacula:~ # zfs list
</span><span class='line'>NAME             USED  AVAIL  REFER  MOUNTPOINT
</span><span class='line'>bigpool         1.14M   433G    23K  /bigpool
</span><span class='line'>bigpool/bacula    23K   433G    23K  /bigpool/bacula
</span><span class='line'>root@stafbacula:~ # </span></code></pre></td></tr></table></div></figure>


<p>When we restart the jail we see that the dataset isn&rsquo;t available anymore in the jail</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafbacula:~ # logout
</span><span class='line'>root@rataplan:~ # /usr/local/etc/rc.d/ezjail restart stafbacula
</span><span class='line'>Stopping jails: stafbacula.
</span><span class='line'>Starting jails: stafbacula.
</span><span class='line'>/etc/rc.d/jail: WARNING: Per-jail configuration via jail_* variables  is obsolete.  Please consider migrating to /etc/jail.conf.
</span><span class='line'>root@rataplan:~ # ezjail-admin console stafbacula
</span><span class='line'>Last login: Wed Dec 27 10:58:33 on pts/2
</span><span class='line'>FreeBSD 11.1-RELEASE-p4 (GENERIC) #0: Tue Nov 14 06:12:40 UTC 2017
</span><span class='line'>
</span><span class='line'>Welcome to FreeBSD!
</span><span class='line'>
</span><span class='line'>Release Notes, Errata: https://www.FreeBSD.org/releases/
</span><span class='line'>Security Advisories:   https://www.FreeBSD.org/security/
</span><span class='line'>FreeBSD Handbook:      https://www.FreeBSD.org/handbook/
</span><span class='line'>FreeBSD FAQ:           https://www.FreeBSD.org/faq/
</span><span class='line'>Questions List: https://lists.FreeBSD.org/mailman/listinfo/freebsd-questions/
</span><span class='line'>FreeBSD Forums:        https://forums.FreeBSD.org/
</span><span class='line'>
</span><span class='line'>Documents installed with the system are in the /usr/local/share/doc/freebsd/
</span><span class='line'>directory, or can be installed later with:  pkg install en-freebsd-doc
</span><span class='line'>For other languages, replace "en" with a language code like de or fr.
</span><span class='line'>
</span><span class='line'>Show the version of FreeBSD installed:  freebsd-version ; uname -a
</span><span class='line'>Please include that output and any error messages when posting questions.
</span><span class='line'>Introduction to manual pages:  man man
</span><span class='line'>FreeBSD directory layout:      man hier
</span><span class='line'>
</span><span class='line'>Edit /etc/motd to change this login announcement.
</span><span class='line'>You have new mail.
</span><span class='line'>root@stafbacula:~ # zfs list
</span><span class='line'>no datasets available
</span><span class='line'>root@stafbacula:~ # </span></code></pre></td></tr></table></div></figure>


<h3>make persistent</h3>

<h4>enable zfs in the jail</h4>

<p>When the jail is booted it need to bring the zfs filesystem online. We need to add <code>zfs_enable=YES</code> to the jail rc.conf</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # vi /usr/jails/stafbacula/etc/rc.conf</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bacula_dir="start"
</span><span class='line'>bacula_dir_enable="yes"
</span><span class='line'>zfs_enable="YES"</span></code></pre></td></tr></table></div></figure>


<h4>update the ezjail configuration</h4>

<p>ezjail needs to jail the zfs dataset to the jail when it&rsquo;s start the jail.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # vi /usr/local/etc/ezjail/stafbacula</span></code></pre></td></tr></table></div></figure>


<p>We need to add the dataset to the jail&rsquo;s zfs_datasets. By default a jail isn&rsquo;t allowed to mount the zfs dataset so need to update jail&rsquo;s parmeters.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>export jail_stafbacula_zfs_datasets="bigpool/bacula"
</span><span class='line'>export jail_stafbacula_parameters="enforce_statfs=0 allow.mount=1 allow.mount.zfs=1 allow.mount.procfs=1 allow.mount.devfs=1"
</span></code></pre></td></tr></table></div></figure>


<p>Restart the jail and verify that the zfs filesystem is available inside the jail</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # ezjail-admin restart stafbacula
</span><span class='line'>Stopping jails: stafbacula.
</span><span class='line'>Starting jails: stafbacula.
</span><span class='line'>/etc/rc.d/jail: WARNING: Per-jail configuration via jail_* variables  is obsolete.  Please consider migrating to /etc/jail.conf.
</span><span class='line'>root@rataplan:~ # </span></code></pre></td></tr></table></div></figure>


<p>Verify that dataset is mounted</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # ezjail-admin console stafbacula
</span><span class='line'>Last login: Wed Dec 27 11:36:04 on pts/2
</span><span class='line'>FreeBSD 11.1-RELEASE-p4 (GENERIC) #0: Tue Nov 14 06:12:40 UTC 2017
</span><span class='line'>
</span><span class='line'>Welcome to FreeBSD!
</span><span class='line'>
</span><span class='line'>Release Notes, Errata: https://www.FreeBSD.org/releases/
</span><span class='line'>Security Advisories:   https://www.FreeBSD.org/security/
</span><span class='line'>FreeBSD Handbook:      https://www.FreeBSD.org/handbook/
</span><span class='line'>FreeBSD FAQ:           https://www.FreeBSD.org/faq/
</span><span class='line'>Questions List: https://lists.FreeBSD.org/mailman/listinfo/freebsd-questions/
</span><span class='line'>FreeBSD Forums:        https://forums.FreeBSD.org/
</span><span class='line'>
</span><span class='line'>Documents installed with the system are in the /usr/local/share/doc/freebsd/
</span><span class='line'>directory, or can be installed later with:  pkg install en-freebsd-doc
</span><span class='line'>For other languages, replace "en" with a language code like de or fr.
</span><span class='line'>
</span><span class='line'>Show the version of FreeBSD installed:  freebsd-version ; uname -a
</span><span class='line'>Please include that output and any error messages when posting questions.
</span><span class='line'>Introduction to manual pages:  man man
</span><span class='line'>FreeBSD directory layout:      man hier
</span><span class='line'>
</span><span class='line'>Edit /etc/motd to change this login announcement.
</span><span class='line'>You have new mail.
</span><span class='line'>root@stafbacula:~ # zfs list
</span><span class='line'>NAME             USED  AVAIL  REFER  MOUNTPOINT
</span><span class='line'>bigpool         1.14M   433G    23K  /bigpool
</span><span class='line'>bigpool/bacula    23K   433G    23K  /bigpool/bacula
</span><span class='line'>root@stafbacula:~ # df -h /bigpool/bacula
</span><span class='line'>Filesystem                    Size    Used   Avail Capacity  Mounted on
</span><span class='line'>zroot/usr/jails/stafbacula    2.6T    618M    2.6T     0%    /usr/jails/stafbacula
</span><span class='line'>root@stafbacula:~ # </span></code></pre></td></tr></table></div></figure>


<h1>Links</h1>

<ul>
<li><a href="http://www.allanjude.com/blog/2013-10-05_poudriere_jail"><a href="http://www.allanjude.com/blog/2013-10-05_poudriere_jail">http://www.allanjude.com/blog/2013-10-05_poudriere_jail</a></a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Model-m Tux Update...]]></title>
    <link href="https://stafwag.github.io/blog/blog/2017/10/20/model-m-tux-update-dot-dot-dot/"/>
    <updated>2017-10-20T17:27:41+02:00</updated>
    <id>https://stafwag.github.io/blog/blog/2017/10/20/model-m-tux-update-dot-dot-dot</id>
    <content type="html"><![CDATA[<p><img class="right" src="https://stafwag.github.io/blog/images/modelm_tux_only.jpg" width="400" height="266" title="&#34;modelm_tux_only.jpg&#34;" alt="&#34;modelm_tux_only.jpg&#34;"></p>

<p>I own a <a href="https://en.wikipedia.org/wiki/Unicomp">Unicomp</a> <a herf="https://en.wikipedia.org/wiki/Model_M_keyboard">model-m keyboard</a>. The keyboard has a nice key feel but it has windows super key(s).</p>

<p><br /></p>

<p>I don&rsquo;t use super key(s), and would prefer to have a keyboard without it.  But when it has super keys  I&rsquo;d rather have it without the windows logo on it so it was time  to replace them with <a href="http://www.keyboardco.com/product/unicomp-gray-linux-tux-keyset.asp">the tux version</a></p>

<h3>Pictures</h3>

<p><a href="https://stafwag.github.io/blog/images/modelm_tux_package.jpg"><img src="https://stafwag.github.io/blog/images/modelm_tux_package.jpg" height="250" width="375" alt="modelm_tux_package.jpg" /></a>
<a href="https://stafwag.github.io/blog/images/modelm_all_keys.jpg"><img src="https://stafwag.github.io/blog/images/modelm_all_keys.jpg" height="250" width="375" alt="modelm_all_keys.jpg" /></a>
<a href="https://stafwag.github.io/blog/images/modelm_tux_only.jpg"><img src="https://stafwag.github.io/blog/images/modelm_tux_only.jpg" height="250" width="375" alt="modelm_tux_only.jpg" /></a>
<a href="https://stafwag.github.io/blog/images/modelm_with_tux_keys.jpg"><img src="https://stafwag.github.io/blog/images/modelm_with_tux_keys.jpg" height="250" width="375" alt="modelm_with_tux_keys.jpg" /></a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Jenkins Build With 20 Cores]]></title>
    <link href="https://stafwag.github.io/blog/blog/2017/09/30/jenkins-build-with-20-cores/"/>
    <updated>2017-09-30T19:18:14+02:00</updated>
    <id>https://stafwag.github.io/blog/blog/2017/09/30/jenkins-build-with-20-cores</id>
    <content type="html"><![CDATA[<p>I finally got the time to try out my jenkins build on my new <a href="http://stafwag.github.io/blog/blog/2017/09/16/20-core-dual-processor-jenkins-build-workstation/">20 Core Dual Processor Jenkins Build Workstation</a></p>

<div class="embed-video-container"><iframe src="http://www.youtube.com/embed/BNn9absXkE8 "></iframe></div>


<p>I&rsquo;m able to run all test on multiple operation systems now. I still need to review this setup and perhaps move some tests to <a href="https://www.docker.io">docker</a> instead of the virtual machines to save some memory. &hellip;but this jenkins setup was configured before docker was a thing.</p>

<p><strong><em>Have fun</em></strong></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[20 Core Dual Processor Jenkins Build Workstation]]></title>
    <link href="https://stafwag.github.io/blog/blog/2017/09/16/20-core-dual-processor-jenkins-build-workstation/"/>
    <updated>2017-09-16T14:29:51+02:00</updated>
    <id>https://stafwag.github.io/blog/blog/2017/09/16/20-core-dual-processor-jenkins-build-workstation</id>
    <content type="html"><![CDATA[<p><img class="left" src="https://stafwag.github.io/blog/images/201709_xeon_cpu_side.jpg" width="400" height="388" title="&#34;Xeon CPU Side&#34;" alt="&#34;Xeon CPU Side&#34;"></p>

<p><br /></p>

<p>My jenkins builds are taking too long mainly due the lack of memory. I mainly use jenkins to verify that my software work on different operation systems (GNU/Linux distributions / *BSD / Solaris).</p>

<p>Looking for a solution that is still affordable I ended up with building a dual Xeon workstation. CPU and memory comes from <a href="http://www.ebay.be">www.ebay.be</a></p>

<p><br />&nbsp;<br />
<br /></p>

<h3>Part list:</h3>

<ul>
<li><strong>CPU:</strong> 2 * <a href="http://ark.intel.com/products/75272/Intel-Xeon-Processor-E5-2660-v2-25M-Cache-2_20-GHz">Intel Xeon E5-2660v2</a> This CPU has 10 cores and 20 thread, so I get 40 threads.</li>
<li><strong>Motherboard:</strong> <a href="http://www.asrockrack.com/general/productdetail.asp?Model=EP2C602-4L/D16#Specifications">Asrock EP2C602-4L/D16</a> I choose this motherboard because it has a lot of DIMM slots so I can upgrade the memory in the further. Downside is that layout is SSI EEB that limits the case choose.</li>
<li><strong>Memory:</strong> 4 * SAMSUNG M393B2G70BH0-CK0 16GB which gives me 64 GB <a href="https://en.wikipedia.org/wiki/ECC_memory">ECC memory</a></li>
<li><strong>CPU Cooler</strong> 2 * <a href="http://www.thermaltake.com/products-model.aspx?id=C_00002470">Thermaltake Water 3.0 Performer C</a> For the first I used watercooling mainly because I wanted to make sure that the cooling will not block the access to the DIMM slots.</li>
<li><strong>PSU:</strong> <a href="https://seasonic.com/product/focus-plus-750-gold/">Seasonic FOCUS Plus 750 Gold</a> I needed a power supply with 2 * 8 pins CPU connectors.</li>
<li><strong>Case:</strong> <a href="http://www.phanteks.com/Enthoo-Pro.html">Phanteks Enthoo Pro</a> This case supports SSI EEB and is not too expensive.</li>
</ul>


<h3>Pictures</h3>

<p><a href="https://stafwag.github.io/blog/images/201709_xeon_cpu_side.jpg"><img src="https://stafwag.github.io/blog/images/201709_xeon_cpu_side.jpg" height="291" width="300" alt="Xeon CPU side" /></a>
<a href="https://stafwag.github.io/blog/images/201709_xeon_hd_side.jpg"><img src="https://stafwag.github.io/blog/images/201709_xeon_hd_side.jpg" height="291" width="317" alt="Xeon CPU side" /></a>
<a href="https://stafwag.github.io/blog/images/201709_xeon_front_side.jpg"><img src="https://stafwag.github.io/blog/images/201709_xeon_front_side.jpg" height="291" width="151" alt="Xeon CPU side" /></a></p>

<p><strong><em>Still need to verify if jenkins works on this system :-) </em></strong></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Bacula on FreeBSD (Part 2 Bacula Catalog Over SSL )]]></title>
    <link href="https://stafwag.github.io/blog/blog/2017/09/09/bacula-on-freebsd-part2/"/>
    <updated>2017-09-09T10:27:03+02:00</updated>
    <id>https://stafwag.github.io/blog/blog/2017/09/09/bacula-on-freebsd-part2</id>
    <content type="html"><![CDATA[<p><img class="right" src="https://stafwag.github.io/blog/images/postgressl.png" width="300" height="300" title="&#34;PostgreSSL&#34;" alt="&#34;PostgreSSL&#34;"></p>

<p>In my previous <a href="http://stafwag.github.io/blog/blog/2017/08/06/bacula-on-freebsd:w_part1/">post</a>, I setup on my <a href="https://www.postgresql.org/">PostgresSQL</a> <a href="https://en.wikipedia.org/wiki/FreeBSD_jail">FreeBSD jail</a>, In this post we continue with the bacaula server.</p>

<p>In this post we will continue with the database connection (Catalog) we&rsquo;ll go the extra <del>mile</del> 1,609344 km and encrypt the catalog connection with ssl. Why? <strong><em>We encrypt.. because we can!</em></strong></p>

<h1>Bacula Components</h1>

<ul>
<li><p><strong>Bacula Director</strong> <br />
The Bacula Director is daemon that runs in the backgroud that control all backup operations.</p></li>
<li><p><strong>Bacula Console</strong> <br />
The Bacula console is an administrator program that allows an system administrator to control the Bacula director.</p></li>
<li><p><strong>Bacula File</strong> <br />
The Bacula File is a backup client install on the backup client.</p></li>
<li><p><strong>Bacula Storage</strong> <br />
The backup media.</p></li>
<li><p><strong>Catalog</strong> <br />
The Catalog is the index of the backups. Bacula supports three types of index databases mySQL ( <a href="https://mariadb.org/">mariaDB</a>), <a href="https://www.postgresql.org/">PostgreSQL</a> and <a href="https://sqlite.org/">SQLite</a></p></li>
<li><p><strong>Bacula monitor</strong> <br />
A Bacula monitor service is a program that allows the system administrator to cerify the status of the bacula Directors, Bacula File Daemons and Bacula Storage Daemons.</p></li>
</ul>


<h1>Bacula Server</h1>

<h2>Jail</h2>

<h3>Create the Bacula Server Jail</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # ezjail-admin create stafbacula "em0|192.168.1.52"
</span><span class='line'>Warning: Some services already seem to be listening on all IP, (including 192.168.1.52)
</span><span class='line'>  This may cause some confusion, here they are:
</span><span class='line'>root     ntpd       754   20 udp6   *:123                 *:*
</span><span class='line'>root     ntpd       754   21 udp4   *:123                 *:*
</span><span class='line'>root     rpc.statd  717   4  udp6   *:846                 *:*
</span><span class='line'>root     rpc.statd  717   5  tcp6   *:846                 *:*
</span><span class='line'>root     rpc.statd  717   6  udp4   *:846                 *:*
</span><span class='line'>root     rpc.statd  717   7  tcp4   *:846                 *:*
</span><span class='line'>root     nfsd       713   5  tcp4   *:2049                *:*
</span><span class='line'>root     nfsd       713   6  tcp6   *:2049                *:*
</span><span class='line'>root     mountd     707   5  udp6   *:823                 *:*
</span><span class='line'>root     mountd     707   6  tcp6   *:823                 *:*
</span><span class='line'>root     mountd     707   7  udp4   *:823                 *:*
</span><span class='line'>root     mountd     707   8  tcp4   *:823                 *:*
</span><span class='line'>root     rpcbind    676   6  udp6   *:111                 *:*
</span><span class='line'>root     rpcbind    676   7  udp6   *:779                 *:*
</span><span class='line'>root     rpcbind    676   8  tcp6   *:111                 *:*
</span><span class='line'>root     rpcbind    676   9  udp4   *:111                 *:*
</span><span class='line'>root     rpcbind    676   10 udp4   *:768                 *:*
</span><span class='line'>root     rpcbind    676   11 tcp4   *:111                 *:*
</span><span class='line'>root     syslogd    656   6  udp6   *:514                 *:*
</span><span class='line'>root     syslogd    656   7  udp4   *:514                 *:*
</span><span class='line'>root@rataplan:~ # </span></code></pre></td></tr></table></div></figure>


<h3>Start the jail</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # ezjail-admin start stafbacula
</span><span class='line'>Starting jails: stafbacula.
</span><span class='line'>/etc/rc.d/jail: WARNING: Per-jail configuration via jail_* variables  is obsolete.  Please consider migrating to /etc/jail.conf.
</span><span class='line'>root@rataplan:~ # </span></code></pre></td></tr></table></div></figure>


<h3>Open the console</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # ezjail-admin console stafbacula
</span><span class='line'>FreeBSD 11.1-RELEASE-p1 (GENERIC) #0: Wed Sep  9 11:55:48 UTC 2017
</span><span class='line'>
</span><span class='line'>Welcome to FreeBSD!
</span><span class='line'>
</span><span class='line'>Release Notes, Errata: https://www.FreeBSD.org/releases/
</span><span class='line'>Security Advisories:   https://www.FreeBSD.org/security/
</span><span class='line'>FreeBSD Handbook:      https://www.FreeBSD.org/handbook/
</span><span class='line'>FreeBSD FAQ:           https://www.FreeBSD.org/faq/
</span><span class='line'>Questions List: https://lists.FreeBSD.org/mailman/listinfo/freebsd-questions/
</span><span class='line'>FreeBSD Forums:        https://forums.FreeBSD.org/
</span><span class='line'>
</span><span class='line'>Documents installed with the system are in the /usr/local/share/doc/freebsd/
</span><span class='line'>directory, or can be installed later with:  pkg install en-freebsd-doc
</span><span class='line'>For other languages, replace "en" with a language code like de or fr.
</span><span class='line'>
</span><span class='line'>Show the version of FreeBSD installed:  freebsd-version ; uname -a
</span><span class='line'>Please include that output and any error messages when posting questions.
</span><span class='line'>Introduction to manual pages:  man man
</span><span class='line'>FreeBSD directory layout:      man hier
</span><span class='line'>
</span><span class='line'>Edit /etc/motd to change this login announcement.
</span><span class='line'>root@stafbacula:~ # </span></code></pre></td></tr></table></div></figure>


<h2>Bacula installation</h2>

<h3>Install pkg</h3>

<p>Set up dns</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafbacula:~ # vi /etc/resolv.conf</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>nameserver 192.168.1.1</span></code></pre></td></tr></table></div></figure>


<p>Bootstrap pkg</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafbacula:~ # pkg
</span><span class='line'>The package management tool is not yet installed on your system.
</span><span class='line'>Do you want to fetch and install it now? [y/N]: y
</span><span class='line'>Bootstrapping pkg from pkg+http://pkg.FreeBSD.org/FreeBSD:11:amd64/quarterly, please wait...
</span><span class='line'>Verifying signature with trusted certificate pkg.freebsd.org.2013102301... done
</span><span class='line'>[stafbacula] Installing pkg-1.10.1...
</span><span class='line'>[stafbacula] Extracting pkg-1.10.1: 100%
</span><span class='line'>pkg: not enough arguments
</span><span class='line'>Usage: pkg [-v] [-d] [-l] [-N] [-j &lt;jail name or id&gt;|-c &lt;chroot path&gt;|-r &lt;rootdir&gt;] [-C &lt;configuration file&gt;] [-R &lt;repo config dir&gt;] [-o var=value] [-4|-6] &lt;command&gt; [&lt;args&gt;]
</span><span class='line'>
</span><span class='line'>For more information on available commands and options see 'pkg help'.
</span><span class='line'>root@stafbacula:~ # </span></code></pre></td></tr></table></div></figure>


<p>Install the bacula server package</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafbacula:~ # pkg install bacula-server
</span><span class='line'>Updating FreeBSD repository catalogue...
</span><span class='line'>FreeBSD repository is up to date.
</span><span class='line'>All repositories are up to date.
</span><span class='line'>Updating database digests format: 100%
</span><span class='line'>The following 8 package(s) will be affected (of 0 checked):
</span><span class='line'>
</span><span class='line'>New packages to be INSTALLED:
</span><span class='line'>        bacula-server: 7.4.7_1
</span><span class='line'>        bacula-client: 7.4.7_1
</span><span class='line'>        readline: 7.0.3
</span><span class='line'>        indexinfo: 0.2.6
</span><span class='line'>        gettext-runtime: 0.19.8.1_1
</span><span class='line'>        lzo2: 2.10_1
</span><span class='line'>        postgresql95-client: 9.5.7_1
</span><span class='line'>        perl5: 5.24.1_1
</span><span class='line'>
</span><span class='line'>Number of packages to be installed: 8
</span><span class='line'>
</span><span class='line'>The process will require 69 MiB more space.
</span><span class='line'>17 MiB to be downloaded.
</span><span class='line'>
</span><span class='line'>Proceed with this action? [y/N]: y
</span><span class='line'>[stafbacula] [1/8] Fetching bacula-server-7.4.7_1.txz: 100%  678 KiB 694.6kB/s    00:01    
</span><span class='line'>[stafbacula] [2/8] Fetching bacula-client-7.4.7_1.txz: 100%  286 KiB 292.8kB/s    00:01    
</span><span class='line'>[stafbacula] [3/8] Fetching readline-7.0.3.txz: 100%  334 KiB 342.4kB/s    00:01    
</span><span class='line'>[stafbacula] [4/8] Fetching indexinfo-0.2.6.txz: 100%    5 KiB   5.3kB/s    00:01    
</span><span class='line'>[stafbacula] [5/8] Fetching gettext-runtime-0.19.8.1_1.txz: 100%  148 KiB 151.1kB/s    00:01    
</span><span class='line'>[stafbacula] [6/8] Fetching lzo2-2.10_1.txz: 100%  113 KiB 115.4kB/s    00:01    
</span><span class='line'>[stafbacula] [7/8] Fetching postgresql95-client-9.5.7_1.txz: 100%    2 MiB 772.9kB/s    00:03    
</span><span class='line'>[stafbacula] [8/8] Fetching perl5-5.24.1_1.txz: 100%   13 MiB 874.0kB/s    00:16    
</span><span class='line'>Checking integrity... done (0 conflicting)
</span><span class='line'>[stafbacula] [1/8] Installing indexinfo-0.2.6...
</span><span class='line'>[stafbacula] [1/8] Extracting indexinfo-0.2.6: 100%
</span><span class='line'>[stafbacula] [2/8] Installing readline-7.0.3...
</span><span class='line'>[stafbacula] [2/8] Extracting readline-7.0.3: 100%
</span><span class='line'>[stafbacula] [3/8] Installing gettext-runtime-0.19.8.1_1...
</span><span class='line'>[stafbacula] [3/8] Extracting gettext-runtime-0.19.8.1_1: 100%
</span><span class='line'>[stafbacula] [4/8] Installing lzo2-2.10_1...
</span><span class='line'>[stafbacula] [4/8] Extracting lzo2-2.10_1: 100%
</span><span class='line'>[stafbacula] [5/8] Installing perl5-5.24.1_1...
</span><span class='line'>[stafbacula] [5/8] Extracting perl5-5.24.1_1: 100%
</span><span class='line'>[stafbacula] [6/8] Installing bacula-client-7.4.7_1...
</span><span class='line'>===&gt; Creating groups.
</span><span class='line'>Creating group 'bacula' with gid '910'.
</span><span class='line'>===&gt; Creating users
</span><span class='line'>Creating user 'bacula' with uid '910'.
</span><span class='line'>[stafbacula] [6/8] Extracting bacula-client-7.4.7_1: 100%
</span><span class='line'>[stafbacula] [7/8] Installing postgresql95-client-9.5.7_1...
</span><span class='line'>[stafbacula] [7/8] Extracting postgresql95-client-9.5.7_1: 100%
</span><span class='line'>[stafbacula] [8/8] Installing bacula-server-7.4.7_1...
</span><span class='line'>===&gt; Creating groups.
</span><span class='line'>Using existing group 'bacula'.
</span><span class='line'>===&gt; Creating users
</span><span class='line'>Using existing user 'bacula'.
</span><span class='line'>[stafbacula] Extracting bacula-server-7.4.7_1: 100%
</span><span class='line'>Message from perl5-5.24.1_1:
</span><span class='line'>The /usr/bin/perl symlink has been removed starting with Perl 5.20.
</span><span class='line'>For shebangs, you should either use:
</span><span class='line'>
</span><span class='line'>#!/usr/local/bin/perl
</span><span class='line'>
</span><span class='line'>or
</span><span class='line'>
</span><span class='line'>#!/usr/bin/env perl
</span><span class='line'>
</span><span class='line'>The first one will only work if you have a /usr/local/bin/perl,
</span><span class='line'>the second will work as long as perl is in PATH.
</span><span class='line'>Message from bacula-client-7.4.7_1:
</span><span class='line'>################################################################################
</span><span class='line'>
</span><span class='line'>NOTE:
</span><span class='line'>Sample files are installed in /usr/local/etc/bacula:
</span><span class='line'>
</span><span class='line'>  bconsole.conf.sample, bacula-fd.conf.sample
</span><span class='line'>
</span><span class='line'>################################################################################
</span><span class='line'>Message from postgresql95-client-9.5.7_1:
</span><span class='line'>The PostgreSQL port has a collection of "side orders":
</span><span class='line'>
</span><span class='line'>postgresql-docs
</span><span class='line'>  For all of the html documentation
</span><span class='line'>
</span><span class='line'>p5-Pg
</span><span class='line'>  A perl5 API for client access to PostgreSQL databases.
</span><span class='line'>
</span><span class='line'>postgresql-tcltk
</span><span class='line'>  If you want tcl/tk client support.
</span><span class='line'>
</span><span class='line'>postgresql-jdbc
</span><span class='line'>  For Java JDBC support.
</span><span class='line'>
</span><span class='line'>postgresql-odbc
</span><span class='line'>  For client access from unix applications using ODBC as access
</span><span class='line'>  method. Not needed to access unix PostgreSQL servers from Win32
</span><span class='line'>  using ODBC. See below.
</span><span class='line'>
</span><span class='line'>ruby-postgres, py-PyGreSQL
</span><span class='line'>  For client access to PostgreSQL databases using the ruby & python
</span><span class='line'>  languages.
</span><span class='line'>
</span><span class='line'>postgresql-plperl, postgresql-pltcl & postgresql-plruby
</span><span class='line'>  For using perl5, tcl & ruby as procedural languages.
</span><span class='line'>
</span><span class='line'>postgresql-contrib
</span><span class='line'>  Lots of contributed utilities, postgresql functions and
</span><span class='line'>  datatypes. There you find pg_standby, pgcrypto and many other cool
</span><span class='line'>  things.
</span><span class='line'>
</span><span class='line'>etc...
</span><span class='line'>Message from bacula-server-7.4.7_1:
</span><span class='line'>###############################################################################
</span><span class='line'>
</span><span class='line'>bacula server was installed
</span><span class='line'>
</span><span class='line'>An auto-changer manipulation script based on FreeBSDs
</span><span class='line'>chio command is included and installed at
</span><span class='line'>
</span><span class='line'>  /usr/local/sbin/chio-bacula
</span><span class='line'>
</span><span class='line'>Please have a look at it if you want to use an
</span><span class='line'>autochanger. You have to configure the usage in
</span><span class='line'>
</span><span class='line'>  /usr/local/etc/bacula/bacula-dir.conf
</span><span class='line'>
</span><span class='line'>Take care of correct permissions for changer and
</span><span class='line'>tape device (e.g. /dev/ch0 and /dev/n[r]sa0) i.e.
</span><span class='line'>they must be accessible by user bacula.
</span><span class='line'>
</span><span class='line'>Due to lack of some features in the FreeBSD tape driver
</span><span class='line'>implementation you MUST add some OS dependent options to
</span><span class='line'>the bacula-sd.conf file:
</span><span class='line'>
</span><span class='line'>  Hardware End of Medium = no;
</span><span class='line'>  Backward Space Record  = no;
</span><span class='line'>  Backward Space File    = no;
</span><span class='line'>
</span><span class='line'>With 2 filemarks at EOT (see man mt):
</span><span class='line'>  Fast Forward Space File = no;
</span><span class='line'>  BSF at EOM = yes;
</span><span class='line'>  TWO EOF    = yes;
</span><span class='line'>
</span><span class='line'>With 1 filemarks at EOT (see man mt):
</span><span class='line'>  Fast Forward Space File = yes;
</span><span class='line'>  BSF at EOM = no;
</span><span class='line'>  TWO EOF   = no;
</span><span class='line'>
</span><span class='line'>NOTE: YOU CAN SWITCH EOT model ONLY when starting
</span><span class='line'>      from scratch with EMPTY tapes.
</span><span class='line'>
</span><span class='line'>It is also important that all the scripts accessed
</span><span class='line'>by RunBeforeJob and RunAfterJob will be executed by
</span><span class='line'>the user bacula.  Check your permissions.
</span><span class='line'>
</span><span class='line'>For USB support read the bacula manual. It could be necessary
</span><span class='line'>to configure/compile a new kernel.
</span><span class='line'>
</span><span class='line'>Look at /usr/local/share/bacula/update_bacula_tables for
</span><span class='line'>database update procedure. Details can be found in the
</span><span class='line'>ReleaseNotes
</span><span class='line'>
</span><span class='line'>If you are using sqlite you need to run the make_sqlite_tables script as
</span><span class='line'>the bacula user. Do this using 'sudo su -m bacula'.
</span><span class='line'>
</span><span class='line'>################################################################################
</span><span class='line'>root@stafbacula:~ # </span></code></pre></td></tr></table></div></figure>


<h1>Initialize the bacula catalog</h1>

<p>We&rsquo;ll have a postgreSQL server running in a FreeBSD jail as our catalog (see <a href="http://stafwag.github.io/blog/blog/2017/08/06/bacula-on-freebsd:w_part1/"><a href="http://stafwag.github.io/blog/blog/2017/08/06/bacula-on-freebsd:w_part1/">http://stafwag.github.io/blog/blog/2017/08/06/bacula-on-freebsd:w_part1/</a></a> howto install PostgreSQL into a FreeBSD jail).</p>

<h2>PostgreSQL setup</h2>

<p>The setup below describes howto configure the PostgreSQL catalog with certificate and username/password authentication. This might be overkill the bacula server runs on the same physical host so no data is going out on the network. But I wanted to setup the database conneection as secure as possible and will reuse this setup for my other database connection. We&rsquo;ll setup a &ldquo;self signed&rdquo; root ca for now, but I replace this with my own CA in further.</p>

<h3>PostgreSQL authentication methods</h3>

<p>PostgreSQL support a lot of authentication methods you&rsquo;ll find a description of the supported of the support authentication methods below (without too much details):</p>

<ul>
<li><strong>Trust Authentication</strong> <br />
With trust authentication the postgreSQL trust the connection from the remote host, this is the default for localhost host connection and &ldquo;socket&rdquo; connections.
<br />&nbsp;<br /></li>
<li><strong>Password Authentication</strong> <br />
Authentication with login/password
<br />&nbsp;<br /></li>
<li><strong>GSSAPI Authentication</strong> <br />
Authentication with the <a href="https://en.wikipedia.org/wiki/Generic_Security_Services_Application_Program_Interface">Generic Security Services Application Program Interface</a>
<br />&nbsp;<br /></li>
<li><strong>SSPI Authentication</strong> <br />
Authentication with the <a href="https://en.wikipedia.org/wiki/Security_Support_Provider_Interface"">Security Support Provider Interface</a> - SSPI is a proprietary variant of GSSAPI with extensions and very Windows-specific data types -
<br />&nbsp;<br /></li>
<li><strong>Kerberos Authentication</strong> <br />
Authentication using the <a href="https://en.wikipedia.org/wiki/Kerberos_(protocol)">Kerberos protocol</a>
<br />&nbsp;<br /></li>
<li><strong>Ident Authentication</strong> <br />
Authentication using the <a href="https://en.wikipedia.org/wiki/Ident_protocol">ident protocol</a>
<br />&nbsp;<br /></li>
<li><strong>Peer Authentication</strong> <br />
Authentication using the <a href="https://www.freebsd.org/cgi/man.cgi?query=getpeereid">getpeereid()</a> kernel function, only supported for local connection on BSD, MacOS and GNU/Linux.
<br />&nbsp;<br /></li>
<li><strong>LDAP Authentication</strong> <br />
<a href="https://en.wikipedia.org/wiki/Lightweight_Directory_Access_Protocol">LDAP</a> authentication.</a>
<br />&nbsp;<br /></li>
<li><strong>RADIUS Authentication</strong> <br />
<a href="https://en.wikipedia.org/wiki/RADIUS">Radius</a> authentication.
<br />&nbsp;<br /></li>
<li><strong>Certificate Authentication</strong> <br />
Authentication with a <a href="https://en.wikipedia.org/wiki/Public_key_infrastructure">PKI certificate</a>.
<br />&nbsp;<br /></li>
<li><strong>PAM Authentication</strong> <br />
<a href="https://en.wikipedia.org/wiki/Pluggable_authentication_module">PAM</a> based authentication</a>
<br />&nbsp;<br />
<br />&nbsp;<br />
I wanted to use password authentication over ssl with a client certificate.
The bacula documents isn&rsquo;t very clear on howto configure it. After a quick lot at the bacula source code it should be supported, so let&rsquo;s give it a try&hellip;</li>
</ul>


<h3>Configure the PostgreSQL jail</h3>

<h4>Allow network connections</h4>

<p>Logon the postgreSQL server jail move to the postgreSQL data directory and edit postgresql.conf to allow TCP/IP connections.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafdb:/var/db/postgres/data96 # pwd
</span><span class='line'>/var/db/postgres/data96
</span><span class='line'>root@stafdb:/var/db/postgres/data96 # vim postgresql.conf</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># - Connection Settings -
</span><span class='line'>
</span><span class='line'>listen_addresses = '192.168.1.51'               # what IP address(es) to listen on;
</span><span class='line'># listen_addresses = 'localhost'                # what IP address(es) to listen on;
</span><span class='line'>                                        # comma-separated list of addresses;
</span><span class='line'>                                        # defaults to 'localhost'; use '*' for all
</span><span class='line'>                                        # (change requires restart)
</span><span class='line'>#port = 5432                            # (change requires restart)
</span></code></pre></td></tr></table></div></figure>


<h4>SSL encryption</h4>

<p>It&rsquo;s always a good idea to encrypt your connections.</p>

<h5>SSL Server setup</h5>

<h6>Umask</h6>

<p>set the umask to prevent somebody can read you private key.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafdb:/var/db/postgres/data96 # su - postgres
</span><span class='line'>$ umask 077 
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h6>Create a private key</h6>

<p>Create a private key without encrypting it.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl genrsa -out server.key 4096
</span><span class='line'>Generating RSA private key, 4096 bit long modulus
</span><span class='line'>........................................................................................................................................................................................................................++
</span><span class='line'>......++
</span><span class='line'>e is 65537 (0x10001)
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h6>Create a self-signed certificate</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ openssl req -new -key server.key -days 3650 -out server.crt -x509 -subj '/C=BE/ST=Flanders/L=Antwerp/O=stafnet/CN=stafdb'
</span><span class='line'>$ ls -ltr                                                                                               total 23
</span><span class='line'>-rw-------   1 postgres  postgres  3247 Sep  9 11:47 server.key
</span><span class='line'>-rw-------   1 postgres  postgres  1964 Sep  9 11:52 server.crt
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h6>Root ca</h6>

<p>We created a self signed certificate so the server certificate is our trusted ca root.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ln -s server.crt root.crt
</span><span class='line'>$ ls -ltr
</span><span class='line'>total 24
</span><span class='line'>-rw-------   1 postgres  postgres  3247 Sep  9 11:47 server.key
</span><span class='line'>-rw-------   1 postgres  postgres  1964 Sep  9 11:52 server.crt
</span><span class='line'>lrwx------   1 postgres  postgres    10 Sep  9 11:53 root.crt -&gt; server.crt
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h6>Enable ssl</h6>

<p>Edit postgresql.conf and  update the ssl setting</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vi postgresql.conf
</span></code></pre></td></tr></table></div></figure>


<p>By default ssl_ca_file is not set but this directive is required so don&rsquo;t forget to set it.
We disable the 3DES ciphers they&rsquo;re obsolete&hellip; We don&rsquo;t speficy a crl for now.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#authentication_timeout = 1min          # 1s-600s
</span><span class='line'>ssl = on                                # (change requires restart)
</span><span class='line'>ssl_ciphers = 'HIGH:MEDIUM:!3DES:!aNULL' # allowed SSL ciphers
</span><span class='line'>                                        # (change requires restart)
</span><span class='line'>ssl_prefer_server_ciphers = on          # (change requires restart)
</span><span class='line'>#ssl_ecdh_curve = 'prime256v1'          # (change requires restart)
</span><span class='line'>ssl_cert_file = 'server.crt'            # (change requires restart)
</span><span class='line'>ssl_key_file = 'server.key'             # (change requires restart)
</span><span class='line'>ssl_ca_file = 'root.crt'                        # (change requires restart)
</span><span class='line'>#ssl_crl_file = ''                      # (change requires restart)
</span><span class='line'>#password_encryption = on</span></code></pre></td></tr></table></div></figure>


<h5>SSL Client setup</h5>

<h6>Become bacula</h6>

<p>Logon to the bacula jail and become the bacula user. We use &ldquo;su -m &hellip;&rdquo; to logon to the locked daemon account, this will take over the root environment.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # ezjail-admin console stafbacula
</span><span class='line'>Last login: Wed Sep  9 09:33:16 on pts/0
</span><span class='line'>FreeBSD 11.1-RELEASE-p1 (GENERIC) #0: Wed Sep  9 11:55:48 UTC 2017
</span><span class='line'>
</span><span class='line'>Welcome to FreeBSD!
</span><span class='line'>
</span><span class='line'>Release Notes, Errata: https://www.FreeBSD.org/releases/
</span><span class='line'>Security Advisories:   https://www.FreeBSD.org/security/
</span><span class='line'>FreeBSD Handbook:      https://www.FreeBSD.org/handbook/
</span><span class='line'>FreeBSD FAQ:           https://www.FreeBSD.org/faq/
</span><span class='line'>Questions List: https://lists.FreeBSD.org/mailman/listinfo/freebsd-questions/
</span><span class='line'>FreeBSD Forums:        https://forums.FreeBSD.org/
</span><span class='line'>
</span><span class='line'>Documents installed with the system are in the /usr/local/share/doc/freebsd/
</span><span class='line'>directory, or can be installed later with:  pkg install en-freebsd-doc
</span><span class='line'>For other languages, replace "en" with a language code like de or fr.
</span><span class='line'>
</span><span class='line'>Show the version of FreeBSD installed:  freebsd-version ; uname -a
</span><span class='line'>Please include that output and any error messages when posting questions.
</span><span class='line'>Introduction to manual pages:  man man
</span><span class='line'>FreeBSD directory layout:      man hier
</span><span class='line'>
</span><span class='line'>Edit /etc/motd to change this login announcement.
</span><span class='line'>You have new mail.
</span><span class='line'>root@stafbacula:~ # su -m bacula -c "/bin/sh"
</span><span class='line'>$ id
</span><span class='line'>uid=910(bacula) gid=910(bacula) groups=910(bacula)
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h6>umask</h6>

<p>Set the umask to prevent somebody can read you private key.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ umask 077
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h6>move to the bacula home directory</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat /etc/passwd | grep bacula
</span><span class='line'>bacula:*:910:910:Bacula Daemon:/var/db/bacula:/usr/sbin/nologin
</span><span class='line'>$ cd /var/db/bacula</span></code></pre></td></tr></table></div></figure>


<h6>create the .postges directory</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir .postgres
</span><span class='line'>$ ls -la
</span><span class='line'>total 12
</span><span class='line'>drwxrwx---   3 bacula  bacula   3 Sep  9 09:41 .
</span><span class='line'>drwxr-xr-x  14 root    wheel   18 Sep  9 14:41 ..
</span><span class='line'>drwx------   2 bacula  bacula   2 Sep  9 09:41 .postgres
</span><span class='line'>$ cd .postgres/
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h6>Create a private key</h6>

<p>We took over the root evironment therefor we need to set the RANDFILE variable to randfile in the bacula home directory.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ pwd
</span><span class='line'>/var/db/bacula/.postgres
</span><span class='line'>$ export RANDFILE=/var/db/bacula/.rnd
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<p>Create the private key.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ openssl genrsa -out `hostname`.key 4096
</span><span class='line'>Generating RSA private key, 4096 bit long modulus
</span><span class='line'>..........++
</span><span class='line'>.......................................................++
</span><span class='line'>e is 65537 (0x10001)
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h6>Create the client csr</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ openssl req -new -key stafbacula.key -out stafbacula.csr -subj '/C=BE/ST=Flanders/L=Antwerp/O=stafnet/CN=stafbacula'
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h6>Create the client certifocate</h6>

<p>Logon to the postgreSQL jail as postgres and sign the client csr.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[postgres@stafdb ~/data96]$ openssl x509 -req -in stafbacula.csr -CAcreateserial -CA root.crt -CAkey server.key -out stafbacula.crt 
</span><span class='line'>Signature ok
</span><span class='line'>subject=/C=BE/ST=Flanders/L=Antwerp/O=stafnet/CN=stafbacula
</span><span class='line'>Getting CA Private Key
</span><span class='line'>[postgres@stafdb ~/data96]$ 
</span></code></pre></td></tr></table></div></figure>


<h5>Copy the client certificate and the trusted root certificate to bacula jail</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ uname -a
</span><span class='line'>FreeBSD stafbacula 11.1-RELEASE-p1 FreeBSD 11.1-RELEASE-p1 #0: Wed Sep  9 11:55:48 UTC 2017     root@amd64-builder.daemonology.net:/usr/obj/usr/src/sys/GENERIC  amd64
</span><span class='line'>$ pwd
</span><span class='line'>/var/db/bacula/.postgres
</span><span class='line'>$ ls -ltr
</span><span class='line'>total 24
</span><span class='line'>-rw-------  1 bacula  bacula  3243 Sep  9 09:47 stafbacula.key
</span><span class='line'>-rw-------  1 bacula  bacula  1679 Sep  9 09:54 stafbacula.csr
</span><span class='line'>-rw-------  1 bacula  bacula  1964 Sep  9 10:04 root.crt
</span><span class='line'>-rw-------  1 bacula  bacula  1850 Sep  9 10:06 stafbacula.crt
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h4>Host file on the bacula jail</h4>

<p>The hostname of the posgresql jail has to match with the CN of the server certificate. So we&rsquo;ll add the hostname to /etc/hosts</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafbacula:~ # vi /etc/hosts</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>192.168.1.51    stafdb</span></code></pre></td></tr></table></div></figure>


<h2>Setup the bacula database</h2>

<h4>Create the bacula database user</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[postgres@stafdb ~/data96]$ id
</span><span class='line'>uid=770(postgres) gid=770(postgres) groups=770(postgres)
</span><span class='line'>[postgres@stafdb ~/data96]$ psql postgres
</span><span class='line'>psql (9.6.3)
</span><span class='line'>Type "help" for help.
</span><span class='line'>
</span><span class='line'>postgres=# create user bacula WITH PASSWORD 'xxxxxx';
</span><span class='line'>CREATE ROLE
</span><span class='line'>postgres=# </span></code></pre></td></tr></table></div></figure>


<p>To update the user password;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>postgres=# alter user bacula PASSWORD 'yyyyyyy';
</span><span class='line'>ALTER ROLE
</span><span class='line'>postgres=# </span></code></pre></td></tr></table></div></figure>


<p>You can view the new permissions in the pg_user table or by execute the \du (describe user shortcut), by default the user has minimal permissions.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>postgres=# select * from pg_user where usename = 'bacula';
</span><span class='line'> usename | usesysid | usecreatedb | usesuper | userepl | usebypassrls |  passwd  | valuntil | useconfig 
</span><span class='line'>---------+----------+-------------+----------+---------+--------------+----------+----------+-----------
</span><span class='line'> bacula  |    16386 | f           | f        | f       | f            | ******** |          | 
</span><span class='line'>(1 row)
</span><span class='line'>
</span><span class='line'>postgres=# 
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>postgres=# \du
</span><span class='line'>                                   List of roles
</span><span class='line'> Role name |                         Attributes                         | Member of 
</span><span class='line'>-----------+------------------------------------------------------------+-----------
</span><span class='line'> bacula    |                                                            | {}
</span><span class='line'> postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS | {}
</span><span class='line'>
</span><span class='line'>postgres=# </span></code></pre></td></tr></table></div></figure>


<h3>Allow the bacula user to create databases</h3>

<p>The bacula database script will try to create the bacula catalog database.
We&rsquo;ll allow the bacula user to create databases,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>postgres=# alter user bacula CREATEDB;
</span><span class='line'>ALTER ROLE
</span><span class='line'>postgres=# select * from pg_user where usename = 'bacula';
</span><span class='line'> usename | usesysid | usecreatedb | usesuper | userepl | usebypassrls |  passwd  | valuntil | useconfig 
</span><span class='line'>---------+----------+-------------+----------+---------+--------------+----------+----------+-----------
</span><span class='line'> bacula  |    16386 | t           | f        | f       | f            | ******** |          | 
</span><span class='line'>(1 row)
</span><span class='line'>
</span><span class='line'>postgres=# \du
</span><span class='line'>                                   List of roles
</span><span class='line'> Role name |                         Attributes                         | Member of 
</span><span class='line'>-----------+------------------------------------------------------------+-----------
</span><span class='line'> bacula    | Create DB                                                  | {}
</span><span class='line'> postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS | {}
</span><span class='line'>
</span><span class='line'>postgres=# </span></code></pre></td></tr></table></div></figure>


<h3>Create the bacula database</h3>

<p>We&rsquo;ll create a bacula database so we can verify the database connection from the bacula user to the bacula database.</p>

<p>Create a new bacula database</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>postgres=# create database bacula;
</span><span class='line'>CREATE DATABASE
</span><span class='line'>postgres=# </span></code></pre></td></tr></table></div></figure>


<p>Grant all permissions to the bacula user</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>postgres=# grant ALL on DATABASE bacula to bacula;
</span><span class='line'>GRANT
</span><span class='line'>postgres=# </span></code></pre></td></tr></table></div></figure>


<h2>Update pg_hba</h2>

<p>The pg_hba.conf configuration controls the <strong>H</strong>ost <strong>B</strong>ased <strong>A</strong>ccess to your postgreSQL database(s).</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[postgres@stafdb ~/data96]$ pwd
</span><span class='line'>/var/db/postgres/data96
</span><span class='line'>[postgres@stafdb ~/data96]$ id
</span><span class='line'>uid=770(postgres) gid=770(postgres) groups=770(postgres)
</span><span class='line'>[postgres@stafdb ~/data96]$ vi pg_hba.conf </span></code></pre></td></tr></table></div></figure>


<p>And add the next lines;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># TYPE  DATABASE        USER            ADDRESS                 METHOD
</span><span class='line'>hostssl bacula          bacula          192.168.1.52/32         md5 clientcert=1
</span><span class='line'>hostssl template0       bacula          192.168.1.52/32         md5 clientcert=1
</span><span class='line'>hostssl template1       bacula          192.168.1.52/32         md5 clientcert=1
</span><span class='line'>hostssl postgres        bacula          192.168.1.52/32         md5 clientcert=1</span></code></pre></td></tr></table></div></figure>


<p>Our bacula jail <strong><em>192.168.1.52</em></strong> only needs to have to the <strong><em>bacula</em></strong> database with the <strong><em>bacula</em></strong> user over ssl <strong><em>hostssl</em></strong> passwords will be send as a <strong><em>md5</em></strong> hash and a client certificate is required <strong><em>clientcert=1</em></strong>.</p>

<p>We could also used the <strong><em>cert</em></strong> method and <strong><em>map</em></strong> the client certificate to postgresql user so we could authenticate with the client certificate only&hellip;</p>

<p>We allow access to the template* and the postgres database because it&rsquo;s required for the bacula database xcreate script. We can remove them ( only allow access to the bacula database ) after the catalog database is created.</p>

<h2>Restart postgresql</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafdb:/var/db/postgres/data96 # service postgresql restart
</span><span class='line'>DEBUG:  postgres: PostmasterMain: initial environment dump:
</span><span class='line'>DEBUG:  -----------------------------------------
</span><span class='line'>DEBUG:          LC_TIME=C
</span><span class='line'>DEBUG:          LC_NUMERIC=C
</span><span class='line'>DEBUG:          LC_MONETARY=C
</span><span class='line'>DEBUG:          LC_MESSAGES=C
</span><span class='line'>DEBUG:          LC_CTYPE=C
</span><span class='line'>DEBUG:          LC_COLLATE=C
</span><span class='line'>DEBUG:          MAIL=/var/mail/postgres
</span><span class='line'>DEBUG:          PGLOCALEDIR=/usr/local/share/locale
</span><span class='line'>DEBUG:          PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin:/var/db/postgres/bin
</span><span class='line'>DEBUG:          PGDATA=/var/db/postgres/data96
</span><span class='line'>DEBUG:          PWD=/var/db/postgres
</span><span class='line'>DEBUG:          PGSYSCONFDIR=/usr/local/etc/postgresql
</span><span class='line'>DEBUG:          HOME=/var/db/postgres
</span><span class='line'>DEBUG:          USER=postgres
</span><span class='line'>DEBUG:          SHELL=/bin/sh
</span><span class='line'>DEBUG:          PG_GRANDPARENT_PID=79045
</span><span class='line'>DEBUG:          BLOCKSIZE=K
</span><span class='line'>DEBUG:  -----------------------------------------
</span><span class='line'>LOG:  could not create IPv6 socket: Protocol not supported
</span><span class='line'>LOG:  could not bind IPv4 socket: Address already in use
</span><span class='line'>HINT:  Is another postmaster already running on port 5432? If not, wait a few seconds and retry.
</span><span class='line'>WARNING:  could not create listen socket for "192.168.1.51"
</span><span class='line'>DEBUG:  invoking IpcMemoryCreate(size=148480000)
</span><span class='line'>DEBUG:  SlruScanDirectory invoking callback on pg_notify/0000
</span><span class='line'>DEBUG:  removing file "pg_notify/0000"
</span><span class='line'>DEBUG:  dynamic shared memory system will support 288 segments
</span><span class='line'>DEBUG:  created dynamic shared memory control segment 773439544 (2316 bytes)
</span><span class='line'>DEBUG:  max_safe_fds = 984, usable_fds = 1000, already_open = 6
</span><span class='line'>LOG:  ending log output to stderr
</span><span class='line'>HINT:  Future log output will go to log destination "syslog".
</span><span class='line'>DEBUG:  CommitTransaction
</span><span class='line'>DEBUG:  name: unnamed; blockState:       STARTED; state: INPROGR, xid/subid/cid: 0/1/0, nestlvl: 1, children: 
</span><span class='line'>root@stafdb:/var/db/postgres/data96 #
</span></code></pre></td></tr></table></div></figure>


<h2>Test the database connection</h2>

<h3>Verify</h3>

<p>Verify the database connection for the bacula jail. See <a href="https://www.postgresql.org/docs/9.6/static/libpq-connect.html"><a href="https://www.postgresql.org/docs/9.6/static/libpq-connect.html">https://www.postgresql.org/docs/9.6/static/libpq-connect.html</a></a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[bacula@stafbacula /var/db/bacula/.postgres]$ psql "sslmode=verify-full host=stafdb dbname=bacula sslcert=`pwd`/postgresql.crt sslkey=`pwd`/postgresql.key sslrootcert=`pwd`/root.crt"
</span><span class='line'>Password:
</span><span class='line'>DEBUG:  CommitTransaction
</span><span class='line'>DEBUG:  name: unnamed; blockState:       STARTED; state: INPROGR, xid/subid/cid: 0/1/0, nestlvl: 1, children:
</span><span class='line'>psql (9.5.7, server 9.6.3)
</span><span class='line'>WARNING: psql major version 9.5, server major version 9.6.
</span><span class='line'>         Some psql features might not work.
</span><span class='line'>SSL connection (protocol: TLSv1.2, cipher: ECDHE-RSA-AES256-GCM-SHA384, bits: 256, compression: off)
</span><span class='line'>Type "help" for help.
</span><span class='line'>bacula=&gt;</span></code></pre></td></tr></table></div></figure>


<h3>Create environment script</h3>

<p>Bacula comes with a few scripts to popilate the catalog we will create an &ldquo;environment&rdquo; script to setup the required environment variabeles to connect to the database. <a href="https://www.postgresql.org/docs/9.6/static/libpq-envars.html"><a href="https://www.postgresql.org/docs/9.6/static/libpq-envars.html">https://www.postgresql.org/docs/9.6/static/libpq-envars.html</a></a> gives an overview of PostgreSQL environment variabeles.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[bacula@stafbacula /var/db/bacula]$ vi psql_env.sh</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>PGHOST=stafdb
</span><span class='line'>PGUSER=bacula
</span><span class='line'>PGSSLMODE=verify-full
</span><span class='line'>PGSSLCERT=/var/db/bacula/.postgres/postgresql.crt
</span><span class='line'>PGSSLKEY=/var/db/bacula/.postgres/postgresql.key
</span><span class='line'>PGSSLROOTCERT=/var/db/bacula/.postgres/root.crt
</span><span class='line'>
</span><span class='line'>export PGHOST
</span><span class='line'>export PGUSER
</span><span class='line'>export PGSSLMODE
</span><span class='line'>export PGSSLCERT
</span><span class='line'>export PGSSLKEY
</span><span class='line'>export PGSSLROOTCERT</span></code></pre></td></tr></table></div></figure>


<p>Test the environment script</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafbacula:~ # su -m bacula -c /bin/sh
</span><span class='line'>$ . /var/db/bacula/psql_env.sh
</span><span class='line'>$ psql bacula
</span><span class='line'>Password: 
</span><span class='line'>DEBUG:  CommitTransaction
</span><span class='line'>DEBUG:  name: unnamed; blockState:       STARTED; state: INPROGR, xid/subid/cid: 0/1/0, nestlvl: 1, children: 
</span><span class='line'>psql (9.5.8, server 9.6.4)
</span><span class='line'>WARNING: psql major version 9.5, server major version 9.6.
</span><span class='line'>         Some psql features might not work.
</span><span class='line'>SSL connection (protocol: TLSv1.2, cipher: ECDHE-RSA-AES256-GCM-SHA384, bits: 256, compression: off)
</span><span class='line'>Type "help" for help.
</span><span class='line'>
</span><span class='line'>bacula=&gt; </span></code></pre></td></tr></table></div></figure>


<h2>Configure the bacula catalog</h2>

<h3>Configuration directives</h3>

<p>I found the bacula documention not very clear howto setup the catalog connection with certificate authentication - or I looked at the wrong place - so I downloaded the bacula source code ( version 7.4.7 )to verify the required directives. ./src/dird/d/dird_conf.c</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky bacula-7.4.7]$ vim ./src/dird/dird_conf.c</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/*
</span><span class='line'>   Bacula(R) - The Network Backup Solution
</span><span class='line'>
</span><span class='line'>   Copyright (C) 2000-2016 Kern Sibbald
</span><span class='line'>
</span><span class='line'>   The original author of Bacula is Kern Sibbald, with contributions
</span><span class='line'>   from many others, a complete list can be found in the file AUTHORS.
</span><span class='line'>
</span><span class='line'>   You may use this file and others of this release according to the
</span><span class='line'>   license defined in the LICENSE file, which includes the Affero General
</span><span class='line'>   Public License, v3.0 ("AGPLv3") and some additional permissions and
</span><span class='line'>   terms pursuant to its AGPLv3 Section 7.
</span><span class='line'>
</span><span class='line'>   This notice must be preserved when any source code is
</span><span class='line'>   conveyed and/or propagated.
</span><span class='line'>
</span><span class='line'>   Bacula(R) is a registered trademark of Kern Sibbald.
</span><span class='line'>*/
</span><span class='line'>
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>
</span><span class='line'>/*
</span><span class='line'> *    Catalog Resource Directives
</span><span class='line'> *
</span><span class='line'> *   name          handler     value                 code flags    default_value
</span><span class='line'> */
</span><span class='line'>static RES_ITEM cat_items[] = {
</span><span class='line'>   {"Name",     store_name,     ITEM(res_cat.hdr.name),    0, ITEM_REQUIRED, 0},
</span><span class='line'>   {"Description", store_str,   ITEM(res_cat.hdr.desc),    0, 0, 0},
</span><span class='line'>   {"dbaddress", store_str,     ITEM(res_cat.db_address),  0, 0, 0},
</span><span class='line'>   {"Address",  store_str,      ITEM(res_cat.db_address),  0, 0, 0},
</span><span class='line'>   {"DbPort",   store_pint32,   ITEM(res_cat.db_port),      0, 0, 0},
</span><span class='line'>   /* keep this password as store_str for the moment */
</span><span class='line'>   {"dbpassword", store_str,    ITEM(res_cat.db_password), 0, 0, 0},
</span><span class='line'>   {"Password", store_str,      ITEM(res_cat.db_password), 0, 0, 0},
</span><span class='line'>   {"dbuser",   store_str,      ITEM(res_cat.db_user),     0, 0, 0},
</span><span class='line'>   {"User",     store_str,      ITEM(res_cat.db_user),     0, 0, 0},
</span><span class='line'>   {"DbName",   store_str,      ITEM(res_cat.db_name),     0, ITEM_REQUIRED, 0},
</span><span class='line'>   {"dbdriver", store_str,      ITEM(res_cat.db_driver),   0, 0, 0},
</span><span class='line'>   {"DbSocket", store_str,      ITEM(res_cat.db_socket),   0, 0, 0},
</span><span class='line'>   {"dbsslkey", store_str,      ITEM(res_cat.db_ssl_key),  0, 0, 0},
</span><span class='line'>   {"dbsslcert", store_str,     ITEM(res_cat.db_ssl_cert),  0, 0, 0},
</span><span class='line'>   {"dbsslca", store_str,       ITEM(res_cat.db_ssl_ca),  0, 0, 0},
</span><span class='line'>   {"dbsslcapath", store_str,   ITEM(res_cat.db_ssl_capath),  0, 0, 0},
</span><span class='line'>   {"dbsslcipher", store_str,   ITEM(res_cat.db_ssl_cipher),  0, 0, 0},
</span><span class='line'>   /* Turned off for the moment */
</span><span class='line'>   {"MultipleConnections", store_bit, ITEM(res_cat.mult_db_connections), 0, 0, 0},
</span><span class='line'>   {"DisableBatchInsert", store_bool, ITEM(res_cat.disable_batch_insert), 0, ITEM_DEFAULT, false},
</span><span class='line'>   {NULL, NULL, {0}, 0, 0, 0}
</span><span class='line'>};
</span></code></pre></td></tr></table></div></figure>


<p>The ssl directives didn&rsquo;t seem to work with postgresql :-( If we feed the postgresql environment variables with the correct ssl settings to the bacula director it seems to work.</p>

<h2>Initialize the database</h2>

<h3>Drop the existing bacula database</h3>

<p>The bacacla create script will try to create a new bacaula database so we&rsquo;ll to drop or test database on our database server.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafdb:~ # su - postgres
</span><span class='line'>$ psql
</span><span class='line'>psql (9.6.4)
</span><span class='line'>Type "help" for help.
</span><span class='line'>
</span><span class='line'>postgres=# drop database bacula ;
</span><span class='line'>DROP DATABASE
</span><span class='line'>postgres=# \l
</span><span class='line'>                             List of databases
</span><span class='line'>   Name    |  Owner   | Encoding | Collate | Ctype |   Access privileges   
</span><span class='line'>-----------+----------+----------+---------+-------+-----------------------
</span><span class='line'> postgres  | postgres | UTF8     | C       | C     | 
</span><span class='line'> template0 | postgres | UTF8     | C       | C     | =c/postgres          +
</span><span class='line'>           |          |          |         |       | postgres=CTc/postgres
</span><span class='line'> template1 | postgres | UTF8     | C       | C     | =c/postgres          +
</span><span class='line'>           |          |          |         |       | postgres=CTc/postgres
</span><span class='line'>(3 rows)
</span><span class='line'>
</span><span class='line'>postgres=# </span></code></pre></td></tr></table></div></figure>


<h3>Create the database</h3>

<p>Logon the bacula jail and create the bacula database.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ . /var/db/bacula/psql_env.sh
</span><span class='line'>$ ./create_bacula_database
</span><span class='line'>Creating postgresql database
</span><span class='line'>Password: 
</span><span class='line'>Password: 
</span><span class='line'>CREATE DATABASE
</span><span class='line'>ALTER DATABASE
</span><span class='line'>Creation of bacula database succeeded.
</span><span class='line'>Password: 
</span><span class='line'>Password: 
</span><span class='line'>Database encoding OK</span></code></pre></td></tr></table></div></figure>


<h3>Populate the bacula tables</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ./make_bacula_tables 
</span><span class='line'>Making postgresql tables
</span><span class='line'>Password: 
</span><span class='line'>CREATE TABLE
</span><span class='line'>ALTER TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>ALTER TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE TABLE
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>INSERT 0 1
</span><span class='line'>Creation of Bacula PostgreSQL tables succeeded.
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h3>Verify</h3>

<p>Logon the bacula database and verify that the database populated.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ psql
</span><span class='line'>Password: 
</span><span class='line'>psql (9.5.8, server 9.6.4)
</span><span class='line'>WARNING: psql major version 9.5, server major version 9.6.
</span><span class='line'>         Some psql features might not work.
</span><span class='line'>SSL connection (protocol: TLSv1.2, cipher: ECDHE-RSA-AES256-GCM-SHA384, bits: 256, compression: off)
</span><span class='line'>Type "help" for help.
</span><span class='line'>
</span><span class='line'>bacula=&gt; \d
</span><span class='line'>                       List of relations
</span><span class='line'> Schema |               Name                |   Type   | Owner  
</span><span class='line'>--------+-----------------------------------+----------+--------
</span><span class='line'> public | basefiles                         | table    | bacula
</span><span class='line'> public | basefiles_baseid_seq              | sequence | bacula
</span><span class='line'> public | cdimages                          | table    | bacula
</span><span class='line'> public | client                            | table    | bacula
</span><span class='line'> public | client_clientid_seq               | sequence | bacula
</span><span class='line'> public | counters                          | table    | bacula
</span><span class='line'> public | device                            | table    | bacula
</span><span class='line'> public | device_deviceid_seq               | sequence | bacula
</span><span class='line'> public | file                              | table    | bacula
</span><span class='line'> public | file_fileid_seq                   | sequence | bacula
</span><span class='line'> public | filename                          | table    | bacula
</span><span class='line'> public | filename_filenameid_seq           | sequence | bacula
</span><span class='line'> public | fileset                           | table    | bacula
</span><span class='line'> public | fileset_filesetid_seq             | sequence | bacula
</span><span class='line'> public | job                               | table    | bacula
</span><span class='line'> public | job_jobid_seq                     | sequence | bacula
</span><span class='line'> public | jobhisto                          | table    | bacula
</span><span class='line'> public | jobmedia                          | table    | bacula
</span><span class='line'> public | jobmedia_jobmediaid_seq           | sequence | bacula
</span><span class='line'> public | location                          | table    | bacula
</span><span class='line'> public | location_locationid_seq           | sequence | bacula
</span><span class='line'> public | locationlog                       | table    | bacula
</span><span class='line'> public | locationlog_loclogid_seq          | sequence | bacula
</span><span class='line'> public | log                               | table    | bacula
</span><span class='line'> public | log_logid_seq                     | sequence | bacula
</span><span class='line'> public | media                             | table    | bacula
</span><span class='line'> public | media_mediaid_seq                 | sequence | bacula
</span><span class='line'> public | mediatype                         | table    | bacula
</span><span class='line'> public | mediatype_mediatypeid_seq         | sequence | bacula
</span><span class='line'> public | path                              | table    | bacula
</span><span class='line'> public | path_pathid_seq                   | sequence | bacula
</span><span class='line'> public | pathhierarchy                     | table    | bacula
</span><span class='line'> public | pathvisibility                    | table    | bacula
</span><span class='line'> public | pool                              | table    | bacula
</span><span class='line'> public | pool_poolid_seq                   | sequence | bacula
</span><span class='line'> public | restoreobject                     | table    | bacula
</span><span class='line'> public | restoreobject_restoreobjectid_seq | sequence | bacula
</span><span class='line'> public | snapshot                          | table    | bacula
</span><span class='line'> public | snapshot_snapshotid_seq           | sequence | bacula
</span><span class='line'>--More--(byte 2667)</span></code></pre></td></tr></table></div></figure>


<h3>Cleanup</h3>

<p>Disable the access to template? and postgres databases.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafdb:/var/db/postgres/data96 # vi pg_hba.conf</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>host    all             all             ::1/128                 trust
</span><span class='line'>hostssl bacula          bacula          192.168.1.52/32         md5 clientcert=1
</span><span class='line'># hostssl       template0       bacula          192.168.1.52/32         md5 clientcert=1
</span><span class='line'># hostssl       template1       bacula          192.168.1.52/32         md5 clientcert=1
</span><span class='line'># hostssl       postgres        bacula          192.168.1.52/32         md5 clientcert=1</span></code></pre></td></tr></table></div></figure>


<p>Reload</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafdb:/var/db/postgres/data96 # service postgresql reload
</span><span class='line'>root@stafdb:/var/db/postgres/data96 # </span></code></pre></td></tr></table></div></figure>


<p>Test it. Verify that access to the postgres database is denied from the bacula host.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ psql postgres
</span><span class='line'>psql: FATAL:  no pg_hba.conf entry for host "192.168.1.52", user "bacula", database "postgres", SSL on
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h2>Bacula catalog configuration</h2>

<h3>Update the bacula director configuration</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafbacula:/usr/local/etc/bacula # vi bacula-dir.conf</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Generic catalog service
</span><span class='line'>Catalog { 
</span><span class='line'>  Name = MyCatalog
</span><span class='line'>  dbname = "bacula"; dbuser = "bacula"; dbpassword = "********" ; dbsslkey = "/var/db/bacula/.postgres
</span><span class='line'>/postgresql.key"; dbsslcert = "/var/db/bacula/.postgres/postgresql.crt"; dbsslca= "/var/db/bacula/.postgres
</span><span class='line'>/root.crt"
</span><span class='line'>
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>Test the catalog connection</h3>

<p>bacula include a program to verify the bacula catalog &ldquo;dbcheck&rdquo;, the -c switch select the bacula director configuration file the -B switch print out the configuration.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bacula@stafbacula /usr/local]$ dbcheck -c /usr/local/etc/bacula/bacula-dir.conf -B -v
</span><span class='line'>catalog=MyCatalog
</span><span class='line'>db_name=bacula
</span><span class='line'>db_driver=
</span><span class='line'>db_user=bacula
</span><span class='line'>db_password=*******
</span><span class='line'>db_address=stafdb
</span><span class='line'>db_port=0
</span><span class='line'>db_socket=
</span><span class='line'>db_type=PostgreSQL
</span><span class='line'>working_dir=/var/db/bacula
</span><span class='line'>[bacula@stafbacula /usr/local]$ 
</span></code></pre></td></tr></table></div></figure>


<p>For some reason the ssl directives aren&rsquo;t include and the connection fails</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[bacula@stafbacula /usr/local/etc/rc.d]$ dbcheck -c /usr/local/etc/bacula/bacula-dir.conf -v
</span><span class='line'>dbcheck: Fatal Error at dbcheck.c:303 because:
</span><span class='line'>postgresql.c:271 Unable to connect to PostgreSQL server. Database=bacula User=bacula
</span><span class='line'>Possible causes: SQL server not running; password incorrect; max_connections exceeded.
</span><span class='line'>09-Sep 14:22 dbcheck: Fatal Error at dbcheck.c:303 because:
</span><span class='line'>postgresql.c:271 Unable to connect to PostgreSQL server. Database=bacula User=bacula
</span><span class='line'>Possible causes: SQL server not running; password incorrect; max_connections exceeded.
</span><span class='line'>[bacula@stafbacula /usr/local/etc/rc.d]$ 
</span></code></pre></td></tr></table></div></figure>


<p>On our postgres host we get the error message that the bacula host tries to connect without SSL.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>oot@stafdb:/var/db/postgres/data96 # tail -f /var/log/messages
</span><span class='line'>Sep  9 14:22:10 stafdb postgres[14183]: [10-1] FATAL:  connection requires a valid client certificate
</span><span class='line'>Sep  9 14:22:10 stafdb postgres[14184]: [10-1] FATAL:  no pg_hba.conf entry for host "192.168.1.52", user "bacula", database "bacula", SSL off
</span><span class='line'>Sep  9 14:22:15 stafdb postgres[14185]: [10-1] FATAL:  connection requires a valid client certificate
</span><span class='line'>Sep  9 14:22:15 stafdb postgres[14186]: [10-1] FATAL:  no pg_hba.conf entry for host "192.168.1.52", user "bacula", database "bacula", SSL off
</span><span class='line'>Sep  9 14:22:20 stafdb postgres[14187]: [10-1] FATAL:  connection requires a valid client certificate
</span><span class='line'>Sep  9 14:22:20 stafdb postgres[14188]: [10-1] FATAL:  no pg_hba.conf entry for host "192.168.1.52", user "bacula", database "bacula", SSL off
</span><span class='line'>Sep  9 14:22:25 stafdb postgres[14190]: [10-1] FATAL:  connection requires a valid client certificate
</span><span class='line'>Sep  9 14:22:25 stafdb postgres[14191]: [10-1] FATAL:  no pg_hba.conf entry for host "192.168.1.52", user "bacula", database "bacula", SSL off
</span><span class='line'>Sep  9 14:22:30 stafdb postgres[14193]: [10-1] FATAL:  connection requires a valid client certificate
</span><span class='line'>Sep  9 14:22:30 stafdb postgres[14194]: [10-1] FATAL:  no pg_hba.conf entry for host "192.168.1.52", user "bacula", database "bacula", SSL off</span></code></pre></td></tr></table></div></figure>


<p>When set the postgresql varialables with the correct ssl settings the connnection works fine.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[bacula@stafbacula /usr/local/etc/rc.d]$ dbcheck -c /usr/local/etc/bacula/bacula-dir.conf -v
</span><span class='line'>Hello, this is the database check/correct program.
</span><span class='line'>Modify database is off. Verbose is on.
</span><span class='line'>Please select the function you want to perform.
</span><span class='line'>
</span><span class='line'>     1) Toggle modify database flag
</span><span class='line'>     2) Toggle verbose flag
</span><span class='line'>     3) Check for bad Filename records
</span><span class='line'>     4) Check for bad Path records
</span><span class='line'>     5) Check for duplicate Filename records
</span><span class='line'>     6) Check for duplicate Path records
</span><span class='line'>     7) Check for orphaned Jobmedia records
</span><span class='line'>     8) Check for orphaned File records
</span><span class='line'>     9) Check for orphaned Path records
</span><span class='line'>    10) Check for orphaned Filename records
</span><span class='line'>    11) Check for orphaned FileSet records
</span><span class='line'>    12) Check for orphaned Client records
</span><span class='line'>    13) Check for orphaned Job records
</span><span class='line'>    14) Check for all Admin records
</span><span class='line'>    15) Check for all Restore records
</span><span class='line'>    16) All (3-15)
</span><span class='line'>    17) Quit
</span><span class='line'>Select function number: 
</span></code></pre></td></tr></table></div></figure>


<h2>Bacula director</h2>

<h3>Enable the  bacula director</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafbacula:/usr/local/etc/rc.d # sysrc bacula_dir_enable=yes
</span><span class='line'>bacula_dir_enable:  -&gt; yes
</span><span class='line'>root@stafbacula:/usr/local/etc/rc.d # 
</span></code></pre></td></tr></table></div></figure>


<h4>Create the bacula.log</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafbacula:/var/log # touch /var/log/bacula.log
</span><span class='line'>root@stafbacula:/var/log # chown bacula:bacula /var/log/bacula.log</span></code></pre></td></tr></table></div></figure>


<h4>Include the postgreSQL ssl settings in the bacula director startup script</h4>

<p>Update the bacula-dir startup sript to include the ssl settings.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Add the following lines to /etc/rc.conf.local or /etc/rc.conf
</span><span class='line'># to enable this service:
</span><span class='line'>#
</span><span class='line'># bacula_dir_enable  (bool):   Set to NO by default.
</span><span class='line'>#                Set it to YES to enable bacula_dir.
</span><span class='line'># bacula_dir_flags (params):   Set params used to start bacula_dir.
</span><span class='line'>#
</span><span class='line'>
</span><span class='line'>. /etc/rc.subr
</span><span class='line'>. /var/db/bacula/psql_env.sh
</span></code></pre></td></tr></table></div></figure>


<h3>bconsole access</h3>

<p>To test that the catalog works correctly with the director we need to setup bconsole access.
Open the bacula director configuration file.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@stafbacula /usr/local/etc/bacula]# vim bacula-dir.conf</span></code></pre></td></tr></table></div></figure>


<p>And defined and Password</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Director {                            # define myself
</span><span class='line'>  Name = MyBaculaDirector
</span><span class='line'>  DIRport = 9101                # where we listen for UA connections
</span><span class='line'>  QueryFile = "/usr/local/share/bacula/query.sql"
</span><span class='line'>  WorkingDirectory = "/var/db/bacula"
</span><span class='line'>  PidDirectory = "/var/run"
</span><span class='line'>  Maximum Concurrent Jobs = 20
</span><span class='line'>  Password = "*******"         # Console password
</span><span class='line'>  Messages = Daemon
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Open the bconsole configuration file</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@stafbacula /usr/local/etc/bacula]# vi bconsole.conf</span></code></pre></td></tr></table></div></figure>


<p>and setup the same password</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Bacula User Agent (or Console) Configuration File
</span><span class='line'>#
</span><span class='line'># Copyright (C) 2000-2015 Kern Sibbald
</span><span class='line'># License: BSD 2-Clause; see file LICENSE-FOSS
</span><span class='line'>#
</span><span class='line'>
</span><span class='line'>Director {
</span><span class='line'>  Name = MyBaculaDirector
</span><span class='line'>  DIRport = 9101
</span><span class='line'>  address = localhost
</span><span class='line'>  Password = "*****"
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<h3>Start the director &amp; test</h3>

<p>Start the bacula-dir service</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafbacula /usr/local/etc/bacula]# service bacula-dir start
</span><span class='line'>Starting bacula_dir.
</span><span class='line'>[root@stafbacula /usr/local/etc/bacula]# ps aux | grep -i bacula 
</span><span class='line'>bacula 14416  0.0  0.1 51424 6588  -  SsJ  14:40   0:00.12 /usr/local/sbin/bacula-dir -u bacula -g bacula 
</span><span class='line'>root   14420  0.0  0.0 14796 1968  0  R+J  14:40   0:00.00 grep -i bacula
</span><span class='line'>root   13530  0.0  0.0  8300 1596  2  I+J  13:47   0:00.00 tail -f /var/log/bacula.log
</span><span class='line'>[root@stafbacula /usr/local/etc/bacula]#
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>And test the console access</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bacula@stafbacula:/usr/local/etc/bacula % bconsole
</span><span class='line'>Connecting to Director localhost:9101
</span><span class='line'>1000 OK: 102 MyBaculaDirector Version: 7.4.7 (16 March 2017)
</span><span class='line'>Enter a period to cancel a command.
</span><span class='line'>*version
</span><span class='line'>MyBaculaDirector Version: 7.4.7 (16 March 2017) amd64-portbld-freebsd11.0 freebsd 11.0-RELEASE-p12 
</span><span class='line'>You have messages.
</span><span class='line'>*</span></code></pre></td></tr></table></div></figure>


<p>In a next blog post we&rsquo;ll continue with the bacula configuration.</p>

<p style="font-style: italic;">
Have fun!
</p>


<h1>Links</h1>

<ul>
<li>bacula manual: <a href="http://www.bacula.org/9.0.x-manuals/en/main/"><a href="http://www.bacula.org/9.0.x-manuals/en/main/">http://www.bacula.org/9.0.x-manuals/en/main/</a></a></li>
<li><a href="https://dan.langille.org/2015/01/10/bacula-on-freebsd-with-zfs/"><a href="https://dan.langille.org/2015/01/10/bacula-on-freebsd-with-zfs/">https://dan.langille.org/2015/01/10/bacula-on-freebsd-with-zfs/</a></a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Bacula on FreeBSD (Part 1 PostgresSQL in a Jail)]]></title>
    <link href="https://stafwag.github.io/blog/blog/2017/08/06/bacula-on-freebsd:w_part1/"/>
    <updated>2017-08-06T08:43:28+02:00</updated>
    <id>https://stafwag.github.io/blog/blog/2017/08/06/bacula-on-freebsd:w_part1</id>
    <content type="html"><![CDATA[<p>I do take backups; my current solution are couple of shell script wrapper around dump/zfs send/btrfs send/rsync which is a mess.
So decided give <a href="http://www.bacula.org/">bacula</a> a try</p>

<p>I use <a href="http://erdgeist.org/arts/software/ezjail/">ezjail</a> to manage my <a href="https://en.wikipedia.org/wiki/FreeBSD_jail">FreeBSD jails</a>. <a href="https://www.postgresql.org/">PostgresSQL</a> is my favorite database and will use this database as the backend for bacula  and will use this database as the backend for bacula. I want to move all my databases to 1 FreeBSD jail this should make the easier to create reliable database backup in the further. For this reason we&rsquo;ll setup 2 FreeBSD jails 1 for the database and 1 for bacula.</p>

<p>You&rsquo;ll find my journey of installing PostgreSQL on a FreeBSD jail. In another blog post we will continue with the installation of baccula.</p>

<h2>PostgreSQL</h2>

<h3>Jail</h3>

<h4>Create the PostgreSQL Jail</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # ezjail-admin create stafdb "em0|192.168.1.51"
</span><span class='line'>Warning: Some services already seem to be listening on all IP, (including 192.168.1.51)
</span><span class='line'>  This may cause some confusion, here they are:
</span><span class='line'>root     ntpd       754   20 udp6   *:123                 *:*
</span><span class='line'>root     ntpd       754   21 udp4   *:123                 *:*
</span><span class='line'>root     rpc.statd  717   4  udp6   *:640                 *:*
</span><span class='line'>root     rpc.statd  717   5  tcp6   *:640                 *:*
</span><span class='line'>root     rpc.statd  717   6  udp4   *:640                 *:*
</span><span class='line'>root     rpc.statd  717   7  tcp4   *:640                 *:*
</span><span class='line'>root     nfsd       713   5  tcp4   *:2049                *:*
</span><span class='line'>root     nfsd       713   6  tcp6   *:2049                *:*
</span><span class='line'>root     mountd     707   5  udp6   *:753                 *:*
</span><span class='line'>root     mountd     707   6  tcp6   *:753                 *:*
</span><span class='line'>root     mountd     707   7  udp4   *:753                 *:*
</span><span class='line'>root     mountd     707   8  tcp4   *:753                 *:*
</span><span class='line'>root     rpcbind    676   6  udp6   *:111                 *:*
</span><span class='line'>root     rpcbind    676   7  udp6   *:847                 *:*
</span><span class='line'>root     rpcbind    676   8  tcp6   *:111                 *:*
</span><span class='line'>root     rpcbind    676   9  udp4   *:111                 *:*
</span><span class='line'>root     rpcbind    676   10 udp4   *:766                 *:*
</span><span class='line'>root     rpcbind    676   11 tcp4   *:111                 *:*
</span><span class='line'>root     syslogd    657   6  udp6   *:514                 *:*
</span><span class='line'>root     syslogd    657   7  udp4   *:514                 *:*
</span><span class='line'>root@rataplan:~ # </span></code></pre></td></tr></table></div></figure>


<h4>PostgreSQL requires shared memory</h4>

<p>PostgreSQL uses shared memory it&rsquo;s required to set &ldquo;allow.sysvipc=1&rdquo; for the jail. I don&rsquo;t want to enable this globaly since this might be a security risk. Shared memory has permissions set based on the uid enabling sysvipc on a jail might cause the jail to read shared memory from the host system or another jail.</p>

<p>To enable &ldquo;allow.sysvipc=1&rdquo; a jail we can update the ezjail configuration. Ezjail keep the jail configuration in /usr/local/etc/ezjail</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # cd /usr/local/etc/ezjail
</span><span class='line'>root@rataplan:/usr/local/etc/ezjail # ls
</span><span class='line'>stafansible     staffs          stafproxy       staftestbuild
</span><span class='line'>stafdb          stafmail        stafpuppet
</span><span class='line'>root@rataplan:/usr/local/etc/ezjail # </span></code></pre></td></tr></table></div></figure>


<p>Open the database jail file and update the configuration.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:/usr/local/etc/ezjail # vi stafdb</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#
</span><span class='line'># Required to run PostgeSQL in the jail
</span><span class='line'>#
</span><span class='line'>
</span><span class='line'>export jail_stafdb_parameters="allow.sysvipc=1"</span></code></pre></td></tr></table></div></figure>


<h4>Start the database jail</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # ezjail-admin start stafdb
</span><span class='line'>Starting jails: stafdb.
</span><span class='line'>/etc/rc.d/jail: WARNING: Per-jail configuration via jail_* variables  is obsolete.  Please consider migrating to /etc/jail.conf.
</span><span class='line'>root@rataplan:~ #</span></code></pre></td></tr></table></div></figure>


<h4>Console access</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # ezjail-admin console stafdb
</span><span class='line'>FreeBSD 11.0-RELEASE-p9 (GENERIC) #0: Tue Apr 11 08:48:40 UTC 2017
</span><span class='line'>
</span><span class='line'>Welcome to FreeBSD!
</span><span class='line'>
</span><span class='line'>Release Notes, Errata: https://www.FreeBSD.org/releases/
</span><span class='line'>Security Advisories:   https://www.FreeBSD.org/security/
</span><span class='line'>FreeBSD Handbook:      https://www.FreeBSD.org/handbook/
</span><span class='line'>FreeBSD FAQ:           https://www.FreeBSD.org/faq/
</span><span class='line'>Questions List: https://lists.FreeBSD.org/mailman/listinfo/freebsd-questions/
</span><span class='line'>FreeBSD Forums:        https://forums.FreeBSD.org/
</span><span class='line'>
</span><span class='line'>Documents installed with the system are in the /usr/local/share/doc/freebsd/
</span><span class='line'>directory, or can be installed later with:  pkg install en-freebsd-doc
</span><span class='line'>For other languages, replace "en" with a language code like de or fr.
</span><span class='line'>
</span><span class='line'>Show the version of FreeBSD installed:  freebsd-version ; uname -a
</span><span class='line'>Please include that output and any error messages when posting questions.
</span><span class='line'>Introduction to manual pages:  man man
</span><span class='line'>FreeBSD directory layout:      man hier
</span><span class='line'>
</span><span class='line'>Edit /etc/motd to change this login announcement.
</span><span class='line'>root@stafdb:~ # 
</span><span class='line'>root@stafdb:~ # </span></code></pre></td></tr></table></div></figure>


<h3>ProgreSQL installation</h3>

<h4>Install pkg</h4>

<p>Set up dns</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafdb:~ # vi /etc/resolv.conf</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>nameserver 192.168.1.1</span></code></pre></td></tr></table></div></figure>


<p>Bootstrap pkg</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafdb:~ # pkg
</span><span class='line'>The package management tool is not yet installed on your system.
</span><span class='line'>Do you want to fetch and install it now? [y/N]: y
</span><span class='line'>Bootstrapping pkg from pkg+http://pkg.FreeBSD.org/FreeBSD:11:amd64/quarterly, please wait...
</span><span class='line'>Verifying signature with trusted certificate pkg.freebsd.org.2013102301... done
</span><span class='line'>[stafdb] Installing pkg-1.10.1...
</span><span class='line'>[stafdb] Extracting pkg-1.10.1: 100%
</span><span class='line'>pkg: not enough arguments
</span><span class='line'>Usage: pkg [-v] [-d] [-l] [-N] [-j &lt;jail name or id&gt;|-c &lt;chroot path&gt;|-r &lt;rootdir&gt;] [-C &lt;configuration file&gt;] [-R &lt;repo config dir&gt;] [-o var=value] [-4|-6] &lt;command&gt; [&lt;args&gt;]
</span><span class='line'>
</span><span class='line'>For more information on available commands and options see 'pkg help'.
</span><span class='line'>root@stafdb:~ # </span></code></pre></td></tr></table></div></figure>


<h4>Install PostgreSQL</h4>

<p>Search for the latest PostgreSQL server version.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafdb:~ # pkg search postgresql | grep server
</span><span class='line'>pgtcl-postgresql92-2.0.0_1     TCL extension for accessing a PostgreSQL server (PGTCL-NG)
</span><span class='line'>pgtcl-postgresql93-2.0.0_1     TCL extension for accessing a PostgreSQL server (PGTCL-NG)
</span><span class='line'>pgtcl-postgresql94-2.0.0_1     TCL extension for accessing a PostgreSQL server (PGTCL-NG)
</span><span class='line'>pgtcl-postgresql95-2.0.0_1     TCL extension for accessing a PostgreSQL server (PGTCL-NG)
</span><span class='line'>pgtcl-postgresql96-2.0.0_1     TCL extension for accessing a PostgreSQL server (PGTCL-NG)
</span><span class='line'>postgresql92-server-9.2.21_1   PostgreSQL is the most advanced open-source database available anywhere
</span><span class='line'>postgresql93-server-9.3.17_1   PostgreSQL is the most advanced open-source database available anywhere
</span><span class='line'>postgresql94-server-9.4.12_1   PostgreSQL is the most advanced open-source database available anywhere
</span><span class='line'>postgresql95-server-9.5.7_1    PostgreSQL is the most advanced open-source database available anywhere
</span><span class='line'>postgresql96-server-9.6.3_1    PostgreSQL is the most advanced open-source database available anywhere
</span><span class='line'>root@stafdb:~ # </span></code></pre></td></tr></table></div></figure>


<p>Install the PostgreSQL package.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafdb:~ # pkg install postgresql96-server
</span><span class='line'>Updating FreeBSD repository catalogue...
</span><span class='line'>FreeBSD repository is up to date.
</span><span class='line'>All repositories are up to date.
</span><span class='line'>The following 8 package(s) will be affected (of 0 checked):
</span><span class='line'>
</span><span class='line'>New packages to be INSTALLED:
</span><span class='line'>        postgresql96-server: 9.6.3_1
</span><span class='line'>        libxml2: 2.9.4
</span><span class='line'>        icu: 58.2_2,1
</span><span class='line'>        gettext-runtime: 0.19.8.1_1
</span><span class='line'>        indexinfo: 0.2.6
</span><span class='line'>        postgresql96-client: 9.6.3_2
</span><span class='line'>        perl5: 5.24.1_1
</span><span class='line'>        readline: 7.0.3
</span><span class='line'>
</span><span class='line'>Number of packages to be installed: 8
</span><span class='line'>
</span><span class='line'>The process will require 131 MiB more space.
</span><span class='line'>30 MiB to be downloaded.
</span><span class='line'>
</span><span class='line'>Proceed with this action? [y/N]: y
</span><span class='line'>[stafdb] [1/8] Fetching postgresql96-server-9.6.3_1.txz: 100%    4 MiB 357.1kB/s    00:11    
</span><span class='line'>[stafdb] [2/8] Fetching libxml2-2.9.4.txz: 100%  802 KiB 410.4kB/s    00:02    
</span><span class='line'>[stafdb] [3/8] Fetching icu-58.2_2,1.txz: 100%    9 MiB 313.3kB/s    00:30    
</span><span class='line'>[stafdb] [4/8] Fetching gettext-runtime-0.19.8.1_1.txz: 100%  147 KiB 151.0kB/s    00:01    
</span><span class='line'>[stafdb] [5/8] Fetching indexinfo-0.2.6.txz: 100%    5 KiB   5.3kB/s    00:01    
</span><span class='line'>[stafdb] [6/8] Fetching postgresql96-client-9.6.3_2.txz: 100%    2 MiB 300.0kB/s    00:08    
</span><span class='line'>[stafdb] [7/8] Fetching perl5-5.24.1_1.txz: 100%   13 MiB 341.5kB/s    00:41    
</span><span class='line'>[stafdb] [8/8] Fetching readline-7.0.3.txz: 100%  334 KiB 342.3kB/s    00:01    
</span><span class='line'>Checking integrity... done (0 conflicting)
</span><span class='line'>[stafdb] [1/8] Installing indexinfo-0.2.6...
</span><span class='line'>[stafdb] [1/8] Extracting indexinfo-0.2.6: 100%
</span><span class='line'>[stafdb] [2/8] Installing gettext-runtime-0.19.8.1_1...
</span><span class='line'>[stafdb] [2/8] Extracting gettext-runtime-0.19.8.1_1: 100%
</span><span class='line'>[stafdb] [3/8] Installing perl5-5.24.1_1...
</span><span class='line'>[stafdb] [3/8] Extracting perl5-5.24.1_1: 100%
</span><span class='line'>[stafdb] [4/8] Installing readline-7.0.3...
</span><span class='line'>[stafdb] [4/8] Extracting readline-7.0.3: 100%
</span><span class='line'>[stafdb] [5/8] Installing libxml2-2.9.4...
</span><span class='line'>[stafdb] [5/8] Extracting libxml2-2.9.4: 100%
</span><span class='line'>[stafdb] [6/8] Installing icu-58.2_2,1...
</span><span class='line'>[stafdb] [6/8] Extracting icu-58.2_2,1: 100%
</span><span class='line'>[stafdb] [7/8] Installing postgresql96-client-9.6.3_2...
</span><span class='line'>[stafdb] [7/8] Extracting postgresql96-client-9.6.3_2: 100%
</span><span class='line'>[stafdb] [8/8] Installing postgresql96-server-9.6.3_1...
</span><span class='line'>===&gt; Creating groups.
</span><span class='line'>Creating group 'postgres' with gid '770'.
</span><span class='line'>===&gt; Creating users
</span><span class='line'>Creating user 'postgres' with uid '770'.
</span><span class='line'>
</span><span class='line'>  =========== BACKUP YOUR DATA! =============
</span><span class='line'>  As always, backup your data before
</span><span class='line'>  upgrading. If the upgrade leads to a higher
</span><span class='line'>  minor revision (e.g. 8.3.x -&gt; 8.4), a dump
</span><span class='line'>  and restore of all databases is
</span><span class='line'>  required. This is *NOT* done by the port!
</span><span class='line'>  ===========================================
</span><span class='line'>[stafdb] Extracting postgresql96-server-9.6.3_1: 100%
</span><span class='line'>Message from perl5-5.24.1_1:
</span><span class='line'>The /usr/bin/perl symlink has been removed starting with Perl 5.20.
</span><span class='line'>For shebangs, you should either use:
</span><span class='line'>
</span><span class='line'>#!/usr/local/bin/perl
</span><span class='line'>
</span><span class='line'>or
</span><span class='line'>
</span><span class='line'>#!/usr/bin/env perl
</span><span class='line'>
</span><span class='line'>The first one will only work if you have a /usr/local/bin/perl,
</span><span class='line'>the second will work as long as perl is in PATH.
</span><span class='line'>Message from postgresql96-client-9.6.3_2:
</span><span class='line'>The PostgreSQL port has a collection of "side orders":
</span><span class='line'>
</span><span class='line'>postgresql-docs
</span><span class='line'>  For all of the html documentation
</span><span class='line'>
</span><span class='line'>p5-Pg
</span><span class='line'>  A perl5 API for client access to PostgreSQL databases.
</span><span class='line'>
</span><span class='line'>postgresql-tcltk 
</span><span class='line'>  If you want tcl/tk client support.
</span><span class='line'>
</span><span class='line'>postgresql-jdbc
</span><span class='line'>  For Java JDBC support.
</span><span class='line'>
</span><span class='line'>postgresql-odbc
</span><span class='line'>  For client access from unix applications using ODBC as access
</span><span class='line'>  method. Not needed to access unix PostgreSQL servers from Win32
</span><span class='line'>  using ODBC. See below.
</span><span class='line'>
</span><span class='line'>ruby-postgres, py-PyGreSQL
</span><span class='line'>  For client access to PostgreSQL databases using the ruby & python
</span><span class='line'>  languages.
</span><span class='line'>
</span><span class='line'>postgresql-plperl, postgresql-pltcl & postgresql-plruby
</span><span class='line'>  For using perl5, tcl & ruby as procedural languages.
</span><span class='line'>
</span><span class='line'>postgresql-contrib
</span><span class='line'>  Lots of contributed utilities, postgresql functions and
</span><span class='line'>  datatypes. There you find pg_standby, pgcrypto and many other cool
</span><span class='line'>  things.
</span><span class='line'>
</span><span class='line'>etc...
</span><span class='line'>Message from postgresql96-server-9.6.3_1:
</span><span class='line'>For procedural languages and postgresql functions, please note that
</span><span class='line'>you might have to update them when updating the server.
</span><span class='line'>
</span><span class='line'>If you have many tables and many clients running, consider raising
</span><span class='line'>kern.maxfiles using sysctl(8), or reconfigure your kernel
</span><span class='line'>appropriately.
</span><span class='line'>
</span><span class='line'>The port is set up to use autovacuum for new databases, but you might
</span><span class='line'>also want to vacuum and perhaps backup your database regularly. There
</span><span class='line'>is a periodic script, /usr/local/etc/periodic/daily/502.pgsql, that
</span><span class='line'>you may find useful. You can use it to backup and perform vacuum on all
</span><span class='line'>databases nightly. Per default, it performs `vacuum analyze'. See the
</span><span class='line'>script for instructions. For autovacuum settings, please review
</span><span class='line'>~pgsql/data/postgresql.conf.
</span><span class='line'>
</span><span class='line'>If you plan to access your PostgreSQL server using ODBC, please
</span><span class='line'>consider running the SQL script /usr/local/share/postgresql/odbc.sql
</span><span class='line'>to get the functions required for ODBC compliance.
</span><span class='line'>
</span><span class='line'>Please note that if you use the rc script,
</span><span class='line'>/usr/local/etc/rc.d/postgresql, to initialize the database, unicode
</span><span class='line'>(UTF-8) will be used to store character data by default.  Set
</span><span class='line'>postgresql_initdb_flags or use login.conf settings described below to
</span><span class='line'>alter this behaviour. See the start rc script for more info.
</span><span class='line'>
</span><span class='line'>To set limits, environment stuff like locale and collation and other
</span><span class='line'>things, you can set up a class in /etc/login.conf before initializing
</span><span class='line'>the database. Add something similar to this to /etc/login.conf:
</span><span class='line'>---
</span><span class='line'>postgres:\
</span><span class='line'>        :lang=en_US.UTF-8:\
</span><span class='line'>        :setenv=LC_COLLATE=C:\
</span><span class='line'>        :tc=default:
</span><span class='line'>---
</span><span class='line'>and run `cap_mkdb /etc/login.conf'.
</span><span class='line'>Then add 'postgresql_class="postgres"' to /etc/rc.conf.
</span><span class='line'>
</span><span class='line'>======================================================================
</span><span class='line'>
</span><span class='line'>To initialize the database, run
</span><span class='line'>
</span><span class='line'>  /usr/local/etc/rc.d/postgresql initdb
</span><span class='line'>
</span><span class='line'>You can then start PostgreSQL by running:
</span><span class='line'>
</span><span class='line'>  /usr/local/etc/rc.d/postgresql start
</span><span class='line'>
</span><span class='line'>For postmaster settings, see ~pgsql/data/postgresql.conf
</span><span class='line'>
</span><span class='line'>NB. FreeBSD's PostgreSQL port logs to syslog by default
</span><span class='line'>    See ~pgsql/data/postgresql.conf for more info
</span><span class='line'>
</span><span class='line'>======================================================================
</span><span class='line'>
</span><span class='line'>To run PostgreSQL at startup, add
</span><span class='line'>'postgresql_enable="YES"' to /etc/rc.conf</span></code></pre></td></tr></table></div></figure>


<p>Enable the postgresql daemon at the jail startup</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafdb:~ # sysrc postgresql_enable="YES"
</span><span class='line'>postgresql_enable:  -&gt; YES
</span><span class='line'>root@stafdb:~ # grep postgresql_enable /etc/rc.conf
</span><span class='line'>postgresql_enable="YES"
</span><span class='line'>root@stafdb:~ # </span></code></pre></td></tr></table></div></figure>


<p>Initialize the database</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafdb:~ # service postgresql initdb
</span><span class='line'>The files belonging to this database system will be owned by user "postgres".
</span><span class='line'>This user must also own the server process.
</span><span class='line'>
</span><span class='line'>The database cluster will be initialized with locale "C".
</span><span class='line'>The default text search configuration will be set to "english".
</span><span class='line'>
</span><span class='line'>Data page checksums are disabled.
</span><span class='line'>
</span><span class='line'>creating directory /var/db/postgres/data96 ... ok
</span><span class='line'>creating subdirectories ... ok
</span><span class='line'>selecting default max_connections ... 100
</span><span class='line'>selecting default shared_buffers ... 128MB
</span><span class='line'>selecting dynamic shared memory implementation ... posix
</span><span class='line'>creating configuration files ... ok
</span><span class='line'>running bootstrap script ... ok
</span><span class='line'>performing post-bootstrap initialization ... ok
</span><span class='line'>syncing data to disk ... ok
</span><span class='line'>
</span><span class='line'>WARNING: enabling "trust" authentication for local connections
</span><span class='line'>You can change this by editing pg_hba.conf or using the option -A, or
</span><span class='line'>--auth-local and --auth-host, the next time you run initdb.
</span><span class='line'>
</span><span class='line'>Success. You can now start the database server using:
</span><span class='line'>
</span><span class='line'>    /usr/local/bin/pg_ctl -D /var/db/postgres/data96 -l logfile start
</span><span class='line'>
</span><span class='line'>root@stafdb:~ # </span></code></pre></td></tr></table></div></figure>


<p>Start the database</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Droot@stafdb:~ # service postgresql start
</span><span class='line'>LOG:  could not create IPv6 socket: Protocol not supported
</span><span class='line'>LOG:  ending log output to stderr
</span><span class='line'>HINT:  Future log output will go to log destination "syslog".
</span><span class='line'>root@stafdb:~ # </span></code></pre></td></tr></table></div></figure>


<p>Verify the database</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafdb:~ # su - postgres                                                                                                   
</span><span class='line'>$ psql -l                                                                                                                       
</span><span class='line'>psql: could not connect to server: No such file or directory                                                                    
</span><span class='line'>        Is the server running locally and accepting                                                                             
</span><span class='line'>        connections on Unix domain socket "/tmp/.s.PGSQL.5432"?                                                                 
</span><span class='line'>$ ^Droot@stafdb:~ # service postgresql start
</span><span class='line'>LOG:  could not create IPv6 socket: Protocol not supported                                                                      
</span><span class='line'>LOG:  ending log output to stderr                                                                                               
</span><span class='line'>HINT:  Future log output will go to log destination "syslog".                                                                   
</span><span class='line'>root@stafdb:~ # su - postgres
</span><span class='line'>$ psql -l
</span><span class='line'>                             List of databases
</span><span class='line'>   Name    |  Owner   | Encoding | Collate | Ctype |   Access privileges   
</span><span class='line'>-----------+----------+----------+---------+-------+-----------------------
</span><span class='line'> postgres  | postgres | UTF8     | C       | C     | 
</span><span class='line'> template0 | postgres | UTF8     | C       | C     | =c/postgres          +
</span><span class='line'>           |          |          |         |       | postgres=CTc/postgres
</span><span class='line'> template1 | postgres | UTF8     | C       | C     | =c/postgres          +
</span><span class='line'>           |          |          |         |       | postgres=CTc/postgres
</span><span class='line'>(3 rows)
</span><span class='line'>
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>




<p style="font-style: italic;">
Have fun!
</p>


<h1>Links</h1>

<ul>
<li><a href="https://dan.langille.org/2015/01/10/bacula-on-freebsd-with-zfs/">https://dan.langille.org/2015/01/10/bacula-on-freebsd-with-zfs/</a></li>
<li><a href="https://cwharton.com/blog/2016/10/postgresql-and-freebsd-quick-start/">https://cwharton.com/blog/2016/10/postgresql-and-freebsd-quick-start/</a></li>
<li><a href="https://dan.langille.org/2013/07/09/fatal-could-not-create-shared-memory-segment-function-not-implemented/">https://dan.langille.org/2013/07/09/fatal-could-not-create-shared-memory-segment-function-not-implemented/</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Install Parabola GNU/Linux on an Encrypted Btrfs Logical Volume]]></title>
    <link href="https://stafwag.github.io/blog/blog/2017/05/25/install-parabola-gnu-slash-linux-on-an-encrypted-btrfs-logical-volume/"/>
    <updated>2017-05-25T09:05:38+02:00</updated>
    <id>https://stafwag.github.io/blog/blog/2017/05/25/install-parabola-gnu-slash-linux-on-an-encrypted-btrfs-logical-volume</id>
    <content type="html"><![CDATA[<p><img class="left" src="https://stafwag.github.io/blog/images/413px-Gnu10-mascot-logo_100ppi.png" width="200" height="291" title="&#34;413px-Gnu10-mascot-logo_100ppi.png&#34;" alt="&#34;413px-Gnu10-mascot-logo_100ppi.png&#34;"></p>

<p>I finally found time to complete the installation of my <a href="http://stafwag.github.io/blog/blog/2017/02/11/how-to-install-libreboot-on-a-thinkpad-x60/">Libreboot laptop</a></p>

<p>I decided to give <a href="https://www.parabola.nu/">Parabola GNU/Linux</a> a try as my daily driver to get a fully <a href="https://en.wikipedia.org/wiki/Free_software">Free Software</a> Laptop/tablet.</p>

<h2>Download the Parabola GNU/Linux iso and boot it</h2>

<p>After Parabola GNU/Linux is booted verify that you have internet access if the network card is support and dhcp is enabled on you network you should get a network address.</p>

<h2>Network access</h2>

<p>To setup the system remotely we first need to setup network to our system.</p>

<h3>Verify the interface</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>1 root@parabolaiso ~ # ip a
</span><span class='line'>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1
</span><span class='line'>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span><span class='line'>    inet 127.0.0.1/8 scope host lo
</span><span class='line'>       valid_lft forever preferred_lft forever
</span><span class='line'>    inet6 ::1/128 scope host 
</span><span class='line'>       valid_lft forever preferred_lft forever
</span><span class='line'>2: enp1s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
</span><span class='line'>    link/ether 00:16:d3:b7:3a:96 brd ff:ff:ff:ff:ff:ff
</span><span class='line'>    inet 192.168.1.11/24 brd 192.168.1.255 scope global enp1s0
</span><span class='line'>       valid_lft forever preferred_lft forever
</span><span class='line'>    inet6 fe80::e5db:c85f:4478:1f44/64 scope link 
</span><span class='line'>       valid_lft forever preferred_lft forever
</span><span class='line'>3: wlp2s0: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000
</span><span class='line'>    link/ether 00:1b:77:4d:5a:57 brd ff:ff:ff:ff:ff:ff
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h3>Verify internet access</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # ping -c 3 www.google.be
</span><span class='line'>PING www.google.be (172.217.17.67) 56(84) bytes of data.
</span><span class='line'>64 bytes from ams16s30-in-f3.1e100.net (172.217.17.67): icmp_seq=1 ttl=56 time=91.3 ms
</span><span class='line'>64 bytes from ams16s30-in-f3.1e100.net (172.217.17.67): icmp_seq=2 ttl=56 time=48.7 ms
</span><span class='line'>64 bytes from ams16s30-in-f3.1e100.net (172.217.17.67): icmp_seq=3 ttl=56 time=47.9 ms
</span><span class='line'>
</span><span class='line'>--- www.google.be ping statistics ---
</span><span class='line'>3 packets transmitted, 3 received, 0% packet loss, time 2003ms
</span><span class='line'>rtt min/avg/max/mdev = 47.998/62.714/91.366/20.264 ms
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h2>ssh access</h2>

<p>If you want to install Parabola GNU/Linux over ssh you need to assign a root passwd and start the sshd service.</p>

<h3>root password</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # passwd root
</span><span class='line'>New password: 
</span><span class='line'>Retype new password: 
</span><span class='line'>passwd: password updated successfully
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h3>create a user account</h3>

<p>Parabola doesn&rsquo;t allow remote ssh root logons. Create a new account to access the system remotely.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # useradd install
</span><span class='line'>root@parabolaiso ~ # passwd install
</span><span class='line'>New password: 
</span><span class='line'>Retype new password: 
</span><span class='line'>passwd: password updated successfully
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h3>start sshd</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # systemctl start sshd
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h3>Logon remotely</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ ssh install@petronella 
</span><span class='line'>install@petronella's password: 
</span><span class='line'>
</span><span class='line'>===============================================================================
</span><span class='line'>                                                                          
</span><span class='line'>         Parabola live media 2016.11.03                                
</span><span class='line'>                                                                          
</span><span class='line'>    To install Parabola, the system must be connected to the internet.    
</span><span class='line'>    For instructions, enter this command:                                 
</span><span class='line'>      lynx network.html                                           
</span><span class='line'>                                                                          
</span><span class='line'>    Press the number keys while holding Alt to switch virtual terminals.  
</span><span class='line'>    This allows entering commands without closing lynx.                   
</span><span class='line'>                                                                          
</span><span class='line'>===============================================================================
</span><span class='line'>
</span><span class='line'>Could not chdir to home directory /home/install: No such file or directory
</span><span class='line'>[install@parabolaiso /]$ su -
</span><span class='line'>Password: 
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h2>Partition your harddisk</h2>

<h3>Find your harddisk device name</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # lsblk -o NAME,VENDOR,MODEL,TYPE,SIZE 
</span><span class='line'>NAME                  VENDOR   MODEL            TYPE   SIZE
</span><span class='line'>loop1                                           loop   1.9G
</span><span class='line'>`-parabola_root-image                           dm     1.9G
</span><span class='line'>sdb                   ATA      OCZ-VERTEX2      disk 107.1G
</span><span class='line'>`-sdb1                                          part 107.1G
</span><span class='line'>loop2                                           loop   1.9G
</span><span class='line'>`-parabola_root-image                           dm     1.9G
</span><span class='line'>loop0                                           loop 269.7M
</span><span class='line'>sda                   Kingston DataTraveler 2.0 disk   7.2G
</span><span class='line'>|-sda2                                          part    31M
</span><span class='line'>`-sda1                                          part   613M
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h3>Overwrite it with random data</h3>

<p>Because we are creating an ecrypted filesystem it&rsquo;s a good idea to overwrite it with random data.</p>

<p>We&rsquo;ll use badblocks for this another method is to use &ldquo;dd if=/dev/random of=/dev/xxx&rdquo; the &ldquo;dd&rdquo; method is probably the best method but is a lot slower.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # badblocks -c 10240 -s -w -t random -v /dev/sdb
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Checking for bad blocks in read-write mode
</span><span class='line'>From block 0 to 112337063
</span><span class='line'>Testing with random pattern: done                                                 
</span><span class='line'>Reading and comparing: done                                                 
</span><span class='line'>Pass completed, 0 bad blocks found. (0/0/0 errors)
</span><span class='line'>badblocks -c 10240 -s -w -t random -v /dev/sdb  82.82s user 20.08s system 3% cpu 48:12.29 total
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h3>Partition the harddisk</h3>

<p>We&rsquo;ll use lvm is this setup, while it should be possible to  boot from an encrypted partition with Libreboot partition I create a small unencrypted boot partition.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # fdisk /dev/sdb
</span><span class='line'>
</span><span class='line'>Welcome to fdisk (util-linux 2.28.2).
</span><span class='line'>Changes will remain in memory only, until you decide to write them.
</span><span class='line'>Be careful before using the write command.
</span><span class='line'>
</span><span class='line'>Device does not contain a recognized partition table.
</span><span class='line'>Created a new DOS disklabel with disk identifier 0x2640923c.
</span><span class='line'>
</span><span class='line'>Command (m for help): p
</span><span class='line'>Disk /dev/sdb: 107.1 GiB, 115033153536 bytes, 224674128 sectors
</span><span class='line'>Units: sectors of 1 * 512 = 512 bytes
</span><span class='line'>Sector size (logical/physical): 512 bytes / 512 bytes
</span><span class='line'>I/O size (minimum/optimal): 512 bytes / 512 bytes
</span><span class='line'>Disklabel type: dos
</span><span class='line'>Disk identifier: 0x2640923c
</span><span class='line'>
</span><span class='line'>Command (m for help): n
</span><span class='line'>Partition type
</span><span class='line'>   p   primary (0 primary, 0 extended, 4 free)
</span><span class='line'>   e   extended (container for logical partitions)
</span><span class='line'>Select (default p): p
</span><span class='line'>Partition number (1-4, default 1): 
</span><span class='line'>First sector (2048-224674127, default 2048): 
</span><span class='line'>Last sector, +sectors or +size{K,M,G,T,P} (2048-224674127, default 224674127): +1G
</span><span class='line'>
</span><span class='line'>Created a new partition 1 of type 'Linux' and of size 1 GiB.
</span><span class='line'>
</span><span class='line'>Command (m for help): n
</span><span class='line'>Partition type
</span><span class='line'>   p   primary (1 primary, 0 extended, 3 free)
</span><span class='line'>   e   extended (container for logical partitions)
</span><span class='line'>Select (default p): p
</span><span class='line'>Partition number (2-4, default 2): 
</span><span class='line'>First sector (2099200-224674127, default 2099200): 
</span><span class='line'>Last sector, +sectors or +size{K,M,G,T,P} (2099200-224674127, default 224674127): 
</span><span class='line'>
</span><span class='line'>Created a new partition 2 of type 'Linux' and of size 106.1 GiB.
</span><span class='line'>
</span><span class='line'>Command (m for help): p
</span><span class='line'>Disk /dev/sdb: 107.1 GiB, 115033153536 bytes, 224674128 sectors
</span><span class='line'>Units: sectors of 1 * 512 = 512 bytes
</span><span class='line'>Sector size (logical/physical): 512 bytes / 512 bytes
</span><span class='line'>I/O size (minimum/optimal): 512 bytes / 512 bytes
</span><span class='line'>Disklabel type: dos
</span><span class='line'>Disk identifier: 0x2640923c
</span><span class='line'>
</span><span class='line'>Device     Boot   Start       End   Sectors   Size Id Type
</span><span class='line'>/dev/sdb1          2048   2099199   2097152     1G 83 Linux
</span><span class='line'>/dev/sdb2       2099200 224674127 222574928 106.1G 83 Linux
</span><span class='line'>
</span><span class='line'>Command (m for help): w
</span><span class='line'>The partition table has been altered.
</span><span class='line'>Calling ioctl() to re-read partition table.
</span><span class='line'>Syncing disks.
</span><span class='line'>
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h3>Encrypt the LVM physical volume</h3>

<h4>Benchmark</h4>

<p>We bechmark the encryption to decide which encryption we&rsquo;ll use.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # cryptsetup benchmark
</span><span class='line'># Tests are approximate using memory only (no storage IO).
</span><span class='line'>PBKDF2-sha1       382134 iterations per second for 256-bit key
</span><span class='line'>PBKDF2-sha256     479239 iterations per second for 256-bit key
</span><span class='line'>PBKDF2-sha512     347671 iterations per second for 256-bit key
</span><span class='line'>PBKDF2-ripemd160  319687 iterations per second for 256-bit key
</span><span class='line'>PBKDF2-whirlpool  221032 iterations per second for 256-bit key
</span><span class='line'>#  Algorithm | Key |  Encryption |  Decryption
</span><span class='line'>     aes-cbc   128b    79.1 MiB/s    93.9 MiB/s
</span><span class='line'> serpent-cbc   128b    30.0 MiB/s   112.0 MiB/s
</span><span class='line'> twofish-cbc   128b    77.5 MiB/s   102.5 MiB/s
</span><span class='line'>     aes-cbc   256b    62.7 MiB/s    71.0 MiB/s
</span><span class='line'> serpent-cbc   256b    30.0 MiB/s   111.9 MiB/s
</span><span class='line'> twofish-cbc   256b    77.5 MiB/s   102.4 MiB/s
</span><span class='line'>     aes-xts   256b    93.0 MiB/s    93.3 MiB/s
</span><span class='line'> serpent-xts   256b   100.3 MiB/s   104.5 MiB/s
</span><span class='line'> twofish-xts   256b    93.8 MiB/s    95.0 MiB/s
</span><span class='line'>     aes-xts   512b    70.5 MiB/s    70.7 MiB/s
</span><span class='line'> serpent-xts   512b   100.3 MiB/s   104.4 MiB/s
</span><span class='line'> twofish-xts   512b    93.9 MiB/s    94.9 MiB/s
</span><span class='line'>cryptsetup benchmark  3.91s user 24.02s system 99% cpu 28.093 total
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h4>Create Luks volume</h4>

<p>The serpent xts with a 512 bits keys seems to give a pretty good performance while sha256 hashing gives the best performance.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # cryptsetup luksFormat --cipher serpent-xts-plain64 --key-size 512 --hash sha256 --use-random /dev/sdb2 
</span><span class='line'>
</span><span class='line'>WARNING!
</span><span class='line'>========
</span><span class='line'>This will overwrite data on /dev/sdb2 irrevocably.
</span><span class='line'>
</span><span class='line'>Are you sure? (Type uppercase yes): YES
</span><span class='line'>Enter passphrase: 
</span><span class='line'>Verify passphrase: 
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h2>LVM setup</h2>

<h3>Create the volumes</h3>

<h4>Open the LUKS volume</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ #  cryptsetup luksOpen /dev/sdb2 pv
</span><span class='line'>Enter passphrase for /dev/sdb2: 
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<p>This create /dev/mapper/pv</p>

<h4>Create the physical volume</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # pvcreate /dev/mapper/pv                 
</span><span class='line'>  Physical volume "/dev/mapper/pv" successfully created.
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<p>Show the pv</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # pvs
</span><span class='line'>  PV             VG Fmt  Attr PSize   PFree  
</span><span class='line'>  /dev/mapper/pv    lvm2 ---  106.13g 106.13g
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h4>Create the volume group</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # vgcreate vg /dev/mapper/pv
</span><span class='line'>  Volume group "vg" successfully created
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<p>Show the created volume group</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # vgs
</span><span class='line'>  VG #PV #LV #SN Attr   VSize   VFree  
</span><span class='line'>  vg   1   0   0 wz--n- 106.13g 106.13g
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h4>Create the swap logical volume</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # lvcreate -L 4G vg -n lv_swap 
</span><span class='line'>  Logical volume "lv_swap" created.
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h4>Create the root logical volume</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # lvcreate -L 20G vg -n lv_root   
</span><span class='line'>  Logical volume "lv_root" created.
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h4>Display the create logical volumes</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # lvs
</span><span class='line'>  LV      VG Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
</span><span class='line'>  lv_root vg -wi-a----- 20.00g                                                    
</span><span class='line'>  lv_swap vg -wi-a-----  4.00g                                                    
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h3>Format the logical volumes</h3>

<h4>Create the swapspace</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # mkswap /dev/mapper/vg-lv_swap       
</span><span class='line'>Setting up swapspace version 1, size = 4 GiB (4294963200 bytes)
</span><span class='line'>no label, UUID=32f6e5d4-67a3-42e3-8a90-6ee3ae0fdaa3
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<p>And activate it;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # swapon /dev/mapper/vg-lv_swap       
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h4>Create the root filesystem</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # mkfs.btrfs /dev/mapper/vg-lv_root       
</span><span class='line'>btrfs-progs v4.8.2
</span><span class='line'>See http://btrfs.wiki.kernel.org for more information.
</span><span class='line'>
</span><span class='line'>Detected a SSD, turning off metadata duplication.  Mkfs with -m dup if you want to force metadata duplication.
</span><span class='line'>Label:              (null)
</span><span class='line'>UUID:               
</span><span class='line'>Node size:          16384
</span><span class='line'>Sector size:        4096
</span><span class='line'>Filesystem size:    20.00GiB
</span><span class='line'>Block group profiles:
</span><span class='line'>  Data:             single            8.00MiB
</span><span class='line'>  Metadata:         single            8.00MiB
</span><span class='line'>  System:           single            4.00MiB
</span><span class='line'>SSD detected:       yes
</span><span class='line'>Incompat features:  extref, skinny-metadata
</span><span class='line'>Number of devices:  1
</span><span class='line'>Devices:
</span><span class='line'>   ID        SIZE  PATH
</span><span class='line'>    1    20.00GiB  /dev/mapper/vg-lv_root
</span><span class='line'>
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h4>Create the boot filesystem</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # mkfs.ext2 /dev/sdb1 
</span><span class='line'>mke2fs 1.43.3 (04-Sep-2016)
</span><span class='line'>Discarding device blocks: done                            
</span><span class='line'>Creating filesystem with 262144 4k blocks and 65536 inodes
</span><span class='line'>Filesystem UUID: e3fd741d-d0e0-483f-a9cd-3fbd3f9d66d1
</span><span class='line'>Superblock backups stored on blocks: 
</span><span class='line'>        32768, 98304, 163840, 229376
</span><span class='line'>
</span><span class='line'>Allocating group tables: done                            
</span><span class='line'>Writing inode tables: done                            
</span><span class='line'>Writing superblocks and filesystem accounting information: done
</span><span class='line'>
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h4>Mount the filesystems</h4>

<p>Mount the root filesystem;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # 
</span><span class='line'>root@parabolaiso ~ # mount -o noatime,compress=lzo,discard,ssd,defaults /dev/mapper/vg-lv_root /mnt
</span><span class='line'>root@parabolaiso ~ # 
</span></code></pre></td></tr></table></div></figure>


<p>Create the /home and /boot directories</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # mkdir -p /mnt/{boot,home}</span></code></pre></td></tr></table></div></figure>


<p>Mount the boot filesystem</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # mount /dev/sdb1 /mnt/boot
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<p>Show;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # df -h
</span><span class='line'>Filesystem                       Size  Used Avail Use% Mounted on
</span><span class='line'>dev                              1.6G     0  1.6G   0% /dev
</span><span class='line'>run                              1.6G   26M  1.6G   2% /run
</span><span class='line'>/dev/sda1                        613M  613M     0 100% /run/parabolaiso/bootmnt
</span><span class='line'>cowspace                         2.4G  8.9M  2.4G   1% /run/parabolaiso/cowspace
</span><span class='line'>/dev/loop0                       270M  270M     0 100% /run/parabolaiso/sfs/root-image
</span><span class='line'>/dev/mapper/parabola_root-image  1.9G  885M 1003M  47% /
</span><span class='line'>tmpfs                            1.6G     0  1.6G   0% /dev/shm
</span><span class='line'>tmpfs                            1.6G     0  1.6G   0% /sys/fs/cgroup
</span><span class='line'>tmpfs                            1.6G     0  1.6G   0% /tmp
</span><span class='line'>tmpfs                            1.6G  1.6M  1.6G   1% /etc/pacman.d/gnupg
</span><span class='line'>tmpfs                            320M     0  320M   0% /run/user/0
</span><span class='line'>tmpfs                            320M     0  320M   0% /run/user/1001
</span><span class='line'>/dev/mapper/vg-lv_root            20G   17M   20G   1% /mnt
</span><span class='line'>/dev/sdb1                       1008M  1.3M  956M   1% /mnt/boot
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h2>System installation</h2>

<h3>boostrap the system</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # pacstrap /mnt base base-devel btrfs-progs
</span><span class='line'>==&gt; Creating install root at /mnt
</span><span class='line'>==&gt; Installing packages to /mnt
</span><span class='line'>:: Synchronizing package databases...
</span><span class='line'> libre                                              437.7 KiB   228K/s 00:02 [############################################] 100%
</span><span class='line'> core                                               111.1 KiB   280K/s 00:00 [############################################] 100%
</span><span class='line'> extra                                             1535.4 KiB   544K/s 00:03 [############################################] 100%
</span><span class='line'> community                                            3.6 MiB   615K/s 00:06 [############################################] 100%
</span><span class='line'> pcr                                                620.0 KiB   662K/s 00:01 [############################################] 100%
</span><span class='line'>:: There are 52 members in group base:
</span><span class='line'>:: Repository libre
</span><span class='line'>   1) filesystem  2) licenses  3) linux-libre  4) pacman  5) pacman-mirrorlist  6) systemd-sysvcompat  7) your-freedom
</span><span class='line'>:: Repository core
</span><span class='line'>   8) bash  9) bzip2  10) coreutils  11) cryptsetup  12) device-mapper  13) dhcpcd  14) diffutils  15) e2fsprogs  16) file
</span><span class='line'>   17) findutils  18) gawk  19) gcc-libs  20) gettext  21) glibc  22) grep  23) gzip  24) inetutils  25) iproute2  26) iputils
</span><span class='line'>   27) jfsutils  28) less  29) logrotate  30) lvm2  31) man-db  32) man-pages  33) mdadm  34) nano  35) netctl  36) pciutils
</span><span class='line'>   37) pcmciautils  38) perl  39) procps-ng  40) psmisc  41) reiserfsprogs  42) s-nail  43) sed  44) shadow  45) sysfsutils
</span><span class='line'>   46) tar  47) texinfo  48) usbutils  49) util-linux  50) vi  51) which  52) xfsprogs
</span><span class='line'>
</span><span class='line'>Enter a selection (default=all): </span></code></pre></td></tr></table></div></figure>


<p>&lt; snip &gt;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(2/7) Updating udev hardware database...
</span><span class='line'>(3/7) Updating system user accounts...
</span><span class='line'>(4/7) Creating temporary files...
</span><span class='line'>(5/7) Arming ConditionNeedsUpdate...
</span><span class='line'>(6/7) Updating the info directory file...
</span><span class='line'>(7/7) Rebuilding certificate stores...
</span><span class='line'>pacstrap /mnt base base-devel btrfs-progs  62.07s user 14.31s system 1% cpu 1:13:22.44 total
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h3>Generate /etc/fstab</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ #
</span><span class='line'>root@parabolaiso ~ # genfstab -U -p /mnt  &gt;&gt; /mnt/etc/fstab
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<p>review</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # cat /mnt/etc/fstab
</span><span class='line'># 
</span><span class='line'># /etc/fstab: static file system information
</span><span class='line'>#
</span><span class='line'># &lt;file system&gt; &lt;dir&gt;   &lt;type&gt;  &lt;options&gt;       &lt;dump&gt;  &lt;pass&gt;
</span><span class='line'># UUID=3731a69b-7240-4618-8e5e-4684d7e719e3
</span><span class='line'># /dev/mapper/vg-lv_root
</span><span class='line'>UUID=3731a69b-7240-4618-8e5e-4684d7e719e3       /               btrfs           rw,relatime,ssd,space_cache,subvolid=5,subvol=/0 0
</span><span class='line'>
</span><span class='line'># /dev/sdb1
</span><span class='line'>UUID=e3fd741d-d0e0-483f-a9cd-3fbd3f9d66d1       /boot           ext2            rw,relatime,block_validity,barrier,user_xattr,acl       0 2
</span><span class='line'>
</span><span class='line'># /dev/mapper/vg-lv_swap
</span><span class='line'>UUID=32f6e5d4-67a3-42e3-8a90-6ee3ae0fdaa3       none            swap            defaults        0 0
</span><span class='line'>
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h3>chroot</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # arch-chroot /mnt
</span><span class='line'>[root@parabolaiso /]# </span></code></pre></td></tr></table></div></figure>


<h3>Set the timezone</h3>

<p>Set the link for the correct timezone</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@parabolaiso /]# ln -sf /usr/share/zoneinfo/Europe/Brussels /etc/localtime
</span><span class='line'>[root@parabolaiso /]# </span></code></pre></td></tr></table></div></figure>


<p>Set the hardwareclock to UTC</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@parabolaiso /]# hwclock --systohc --utc
</span><span class='line'>[root@parabolaiso /]# </span></code></pre></td></tr></table></div></figure>


<h3>Generate the required locales</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@parabolaiso /]# vi /etc/locale.gen 
</span><span class='line'>[root@parabolaiso /]# local 
</span><span class='line'>local       locale      locale-gen  localectl   localedef   
</span><span class='line'>[root@parabolaiso /]# locale-gen
</span><span class='line'>Generating locales...
</span><span class='line'>  en_IE.UTF-8... done
</span><span class='line'>  en_IE.ISO-8859-1... done
</span><span class='line'>  en_IE.ISO-8859-15@euro... done
</span><span class='line'>  en_US.UTF-8... done
</span><span class='line'>  en_US.ISO-8859-1... done
</span><span class='line'>  nl_BE.UTF-8... done
</span><span class='line'>  nl_BE.ISO-8859-1... done
</span><span class='line'>  nl_BE.ISO-8859-15@euro... done
</span><span class='line'>Generation complete.
</span><span class='line'>[root@parabolaiso /]# </span></code></pre></td></tr></table></div></figure>


<h3>Hostname</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@parabolaiso /]# vi /etc/hostname
</span><span class='line'>[root@parabolaiso /]# </span></code></pre></td></tr></table></div></figure>


<h3>mkinitcpio</h3>

<h4>HOOKS</h4>

<p>Add &ldquo;encrypt lvm2&rdquo; to HOOKS before filesystems in /etc/mkinitcpio.conf</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@parabolaiso /]# vi /etc/mkinitcpio.conf</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>HOOKS="base udev autodetect modconf block encrypt lvm2 filesystems keyboard fsck"</span></code></pre></td></tr></table></div></figure>


<h4>Create boot image</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@parabolaiso /]#  mkinitcpio -p linux-libre
</span><span class='line'>==&gt; Building image from preset: /etc/mkinitcpio.d/linux-libre.preset: 'default'
</span><span class='line'>  -&gt; -k /boot/vmlinuz-linux-libre -c /etc/mkinitcpio.conf -g /boot/initramfs-linux-libre.img
</span><span class='line'>==&gt; Starting build: 4.10.6-gnu-1
</span><span class='line'>  -&gt; Running build hook: [base]
</span><span class='line'>  -&gt; Running build hook: [udev]
</span><span class='line'>  -&gt; Running build hook: [autodetect]
</span><span class='line'>  -&gt; Running build hook: [modconf]
</span><span class='line'>  -&gt; Running build hook: [block]
</span><span class='line'>  -&gt; Running build hook: [sd-encrypt]
</span><span class='line'>/usr/lib/initcpio/install/sd-encrypt: line 21: add_systemd_unit: command not found
</span><span class='line'>/usr/lib/initcpio/install/sd-encrypt: line 25: add_systemd_unit: command not found
</span><span class='line'>/usr/lib/initcpio/install/sd-encrypt: line 26: add_systemd_unit: command not found
</span><span class='line'>  -&gt; Running build hook: [lvm2]
</span><span class='line'>  -&gt; Running build hook: [filesystems]
</span><span class='line'>  -&gt; Running build hook: [keyboard]
</span><span class='line'>  -&gt; Running build hook: [fsck]
</span><span class='line'>==&gt; Generating module dependencies
</span><span class='line'>==&gt; Creating gzip-compressed initcpio image: /boot/initramfs-linux-libre.img
</span><span class='line'>==&gt; Image generation successful
</span><span class='line'>==&gt; Building image from preset: /etc/mkinitcpio.d/linux-libre.preset: 'fallback'
</span><span class='line'>  -&gt; -k /boot/vmlinuz-linux-libre -c /etc/mkinitcpio.conf -g /boot/initramfs-linux-libre-fallback.img -S autodetect
</span><span class='line'>==&gt; Starting build: 4.10.6-gnu-1
</span><span class='line'>  -&gt; Running build hook: [base]
</span><span class='line'>  -&gt; Running build hook: [udev]
</span><span class='line'>  -&gt; Running build hook: [modconf]
</span><span class='line'>  -&gt; Running build hook: [block]
</span><span class='line'>==&gt; WARNING: Possibly missing firmware for module: isci
</span><span class='line'>  -&gt; Running build hook: [sd-encrypt]
</span><span class='line'>/usr/lib/initcpio/install/sd-encrypt: line 21: add_systemd_unit: command not found
</span><span class='line'>/usr/lib/initcpio/install/sd-encrypt: line 25: add_systemd_unit: command not found
</span><span class='line'>/usr/lib/initcpio/install/sd-encrypt: line 26: add_systemd_unit: command not found
</span><span class='line'>  -&gt; Running build hook: [lvm2]
</span><span class='line'>  -&gt; Running build hook: [filesystems]
</span><span class='line'>  -&gt; Running build hook: [keyboard]
</span><span class='line'>  -&gt; Running build hook: [fsck]
</span><span class='line'>==&gt; Generating module dependencies
</span><span class='line'>==&gt; Creating gzip-compressed initcpio image: /boot/initramfs-linux-libre-fallback.img
</span><span class='line'>==&gt; Image generation successful
</span><span class='line'>[root@parabolaiso /]# </span></code></pre></td></tr></table></div></figure>


<h3>set the root password</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@parabolaiso /]# passwd root
</span><span class='line'>New password: 
</span><span class='line'>Retype new password: 
</span><span class='line'>passwd: password updated successfully
</span><span class='line'>[root@parabolaiso /]# </span></code></pre></td></tr></table></div></figure>


<h3>GRUB</h3>

<h4>install Grub</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@parabolaiso /]#  pacman -Sy grub
</span><span class='line'>:: Synchronizing package databases...
</span><span class='line'> libre is up to date
</span><span class='line'> core is up to date
</span><span class='line'> extra is up to date
</span><span class='line'> community is up to date
</span><span class='line'> pcr is up to date
</span><span class='line'>resolving dependencies...
</span><span class='line'>looking for conflicting packages...
</span><span class='line'>
</span><span class='line'>Packages (1) grub-1:2.02.rc2-1.parabola1
</span><span class='line'>
</span><span class='line'>Total Download Size:    6.04 MiB
</span><span class='line'>Total Installed Size:  35.87 MiB
</span><span class='line'>
</span><span class='line'>:: Proceed with installation? [Y/n] 
</span><span class='line'>:: Retrieving packages...
</span><span class='line'> grub-1:2.02.rc2-1.parabola1-x86_64                   6.0 MiB   128K/s 00:48 [############################################] 100%
</span><span class='line'>(1/1) checking keys in keyring                                               [############################################] 100%
</span><span class='line'>(1/1) checking package integrity                                             [############################################] 100%
</span><span class='line'>(1/1) loading package files                                                  [############################################] 100%
</span><span class='line'>(1/1) checking for file conflicts                                            [############################################] 100%
</span><span class='line'>(1/1) checking available disk space                                          [############################################] 100%
</span><span class='line'>:: Processing package changes...
</span><span class='line'>(1/1) installing grub                                                        [############################################] 100%
</span><span class='line'>Generating grub.cfg.example config file...
</span><span class='line'>This may fail on some machines running a custom kernel.
</span><span class='line'>done.
</span><span class='line'>Optional dependencies for grub
</span><span class='line'>    freetype2: For grub-mkfont usage
</span><span class='line'>    fuse: For grub-mount usage
</span><span class='line'>    dosfstools: For grub-mkrescue FAT FS and EFI support
</span><span class='line'>    efibootmgr: For grub-install EFI support
</span><span class='line'>    libisoburn: Provides xorriso for generating grub rescue iso using grub-mkrescue
</span><span class='line'>    os-prober: To detect other OSes when generating grub.cfg in BIOS systems
</span><span class='line'>    mtools: For grub-mkrescue FAT FS support
</span><span class='line'>:: Running post-transaction hooks...
</span><span class='line'>(1/2) Arming ConditionNeedsUpdate...
</span><span class='line'>(2/2) Updating the info directory file...
</span><span class='line'>[root@parabolaiso /]# </span></code></pre></td></tr></table></div></figure>


<h4>Install grub to your boot disk</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@parabolaiso /]# grub-install --target=i386-pc /dev/sdb
</span><span class='line'>Installing for i386-pc platform.
</span><span class='line'>Installation finished. No error reported.
</span><span class='line'>[root@parabolaiso /]# </span></code></pre></td></tr></table></div></figure>


<h4>Create grub.cfg</h4>

<p>We&rsquo;ll use the uuid for the crypted device.</p>

<h5>Get the UUID for the encrypted physical volume</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@parabolaiso /]# ls -l /dev/disk/by-uuid/
</span><span class='line'>total 0
</span><span class='line'>lrwxrwxrwx 1 root root 10 Apr  3 10:07 2016-11-03-15-52-21-00 -&gt; ../../sda1
</span><span class='line'>lrwxrwxrwx 1 root root 10 Apr  3 10:09 32f6e5d4-67a3-42e3-8a90-6ee3ae0fdaa3 -&gt; ../../dm-2
</span><span class='line'>lrwxrwxrwx 1 root root 10 Apr  3 10:09 3731a69b-7240-4618-8e5e-4684d7e719e3 -&gt; ../../dm-3
</span><span class='line'>lrwxrwxrwx 1 root root 10 Apr  3 10:07 BD3C-9D8E -&gt; ../../sda2
</span><span class='line'>lrwxrwxrwx 1 root root 10 Apr  3 10:07 e3fd741d-d0e0-483f-a9cd-3fbd3f9d66d1 -&gt; ../../sdb1
</span><span class='line'>lrwxrwxrwx 1 root root 10 Apr  3 10:09 eb600d4a-a2fd-4698-8847-14e6dc1b5e6c -&gt; ../../sdb2
</span><span class='line'>lrwxrwxrwx 1 root root 10 Apr  3 10:07 f6312bc5-7593-4b6d-8427-0cf92d9de40b -&gt; ../../dm-0
</span><span class='line'>[root@parabolaiso /]# </span></code></pre></td></tr></table></div></figure>


<h5>Update /etc/default/grub</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>GRUB_DEFAULT=0
</span><span class='line'>GRUB_TIMEOUT=5
</span><span class='line'>GRUB_DISTRIBUTOR="Parabola"
</span><span class='line'>GRUB_CMDLINE_LINUX_DEFAULT="quiet"
</span><span class='line'>GRUB_CMDLINE_LINUX="cryptdevice=/dev/disk/by-uuid/eb600d4a-a2fd-4698-8847-14e6dc1b5e6c:pv"</span></code></pre></td></tr></table></div></figure>


<h5>Generate grub.cfg</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@parabolaiso /]# grub-mkconfig -o /boot/grub/grub.cfg
</span><span class='line'>Generating grub configuration file ...
</span><span class='line'>  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
</span><span class='line'>  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
</span><span class='line'>  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
</span><span class='line'>  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
</span><span class='line'>  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
</span><span class='line'>  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
</span><span class='line'>  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
</span><span class='line'>  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
</span><span class='line'>  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
</span><span class='line'>  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
</span><span class='line'>Found linux image: /boot/vmlinuz-linux-libre
</span><span class='line'>Found initrd image: /boot/initramfs-linux-libre.img
</span><span class='line'>Found fallback initramfs image: /boot/initramfs-linux-libre-fallback.img
</span><span class='line'>  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
</span><span class='line'>  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
</span><span class='line'>done
</span><span class='line'>[root@parabolaiso /]# </span></code></pre></td></tr></table></div></figure>


<h2>Reboot</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@parabolaiso /]# exit
</span><span class='line'>root@parabolaiso ~ # umount /mnt/boot
</span><span class='line'>root@parabolaiso ~ # umount /mnt/    
</span><span class='line'>root@parabolaiso ~ # lvchange -an /dev/vg/lv_root  
</span><span class='line'>root@parabolaiso ~ # swapoff /dev/vg/lv_swap
</span><span class='line'>root@parabolaiso ~ # lvchange -an /dev/vg/lv_swap
</span><span class='line'>root@parabolaiso ~ # cryptsetup luksClose  /dev/mapper/pv
</span><span class='line'>root@parabolaiso ~ # reboot
</span><span class='line'>Connection to petronella closed by remote host.
</span><span class='line'>Connection to petronella closed.
</span><span class='line'>[staf@vicky octopress]$ </span></code></pre></td></tr></table></div></figure>


<h2>First boot</h2>

<p>If everything goes well GNU/Linux get booted, &hellip; if not. You&rsquo;ll have some fun to resolve the boot issues :-)</p>

<p style="font-style: italic;">
Have fun!
</p>


<h1>Links</h1>

<ul>
<li><a href="https://libreboot.org/docs/gnulinux/encrypted_parabola.html">https://libreboot.org/docs/gnulinux/encrypted_parabola.html</a></li>
<li><a href="http://stafwag.github.io/blog/blog/2016/08/30/arch-on-an-encrypted-btrfs-partition/">http://stafwag.github.io/blog/blog/2016/08/30/arch-on-an-encrypted-btrfs-partition/</a></li>
<li><a href="http://www.brunoparmentier.be/blog/how-to-install-arch-linux-on-an-encrypted-btrfs-partition.html">http://www.brunoparmentier.be/blog/how-to-install-arch-linux-on-an-encrypted-btrfs-partition.html</a></li>
<li><a href="http://blog.fabio.mancinelli.me/2012/12/28/Arch_Linux_on_BTRFS.html">http://blog.fabio.mancinelli.me/2012/12/28/Arch_Linux_on_BTRFS.html</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How to Install Libreboot on a ThinkPad X60]]></title>
    <link href="https://stafwag.github.io/blog/blog/2017/02/11/how-to-install-libreboot-on-a-thinkpad-x60/"/>
    <updated>2017-02-11T16:09:11+01:00</updated>
    <id>https://stafwag.github.io/blog/blog/2017/02/11/how-to-install-libreboot-on-a-thinkpad-x60</id>
    <content type="html"><![CDATA[<p><br />&nbsp;<br />
I got a <a href="https://en.wikipedia.org/wiki/ThinkPad_X_Series#X60_Tablet">ThinkPad x60 (tablet version)</a> from <a href="http://ebay.be">ebay.be</a> to install <a href="https://libreboot.org/">libreboot</a> on it.
<br />&nbsp;<br />
I tried to compile libreboot on <a href="http://www.debian">Debian</a> and <a href="https://www.parabola.nu/">Parabola</a> GNU/Linux but both failed, compling Libreboot on <a href="https://trisquel.info/">Trisquel 7</a> works fine so I&rsquo;ll use Trisquel to replace the BIOS with libreboot.
<br />&nbsp;<br />
I&rsquo;m not sure that I&rsquo;ll use Trisquel 7 as my daily driver since it is a bit outdated&hellip;
I might go with <a href="http://https://wiki.debian.org/DebianStretch">Debian Strech</a> without the non-free repositories to get a fully <a href="https://en.wikipedia.org/wiki/Free_software">Free Software</a> Laptop/tablet. I&rsquo;ll need to replace the Intel wifi adapter since this requires non-free firmware.
<br />&nbsp;<br />
You&rsquo;ll find a small howto install libreboot on a Thinkpad X60 below.
<br />&nbsp;<br /></p>

<p><img class="centre" src="https://stafwag.github.io/blog/images/x60_open.jpg" width="750" height="1050" title="&#34;Thinkpad x60 open&#34;" alt="&#34;Thinkpad x60 open&#34;"></p>

<h1>Build Libreboot</h1>

<p>The latest version of libreboot isn&rsquo;t available via a binary distribution so I decided to build it from source.</p>

<h2>Download the Libreboot source</h2>

<p>Download the latest libreboot image from <a href="https://libreboot.org/download/"><a href="https://libreboot.org/download/">https://libreboot.org/download/</a></a></p>

<h3>Download the source tarball</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot$ wget https://libreboot.org/release/stable/20160907/libreboot_r20160907_src.tar.xz
</span><span class='line'>--2017-02-11 10:24:41--  https://libreboot.org/release/stable/20160907/libreboot_r20160907_src.tar.xz
</span><span class='line'>Resolving libreboot.org (libreboot.org)... 149.56.232.100
</span><span class='line'>Connecting to libreboot.org (libreboot.org)|149.56.232.100|:443... connected.
</span><span class='line'>HTTP request sent, awaiting response... 200 OK
</span><span class='line'>Length: 438622508 (418M) [application/x-xz]
</span><span class='line'>Saving to: libreboot_r20160907_src.tar.xz
</span><span class='line'>
</span><span class='line'>100%[==========================================================&gt;] 438.622.508  541KB/s   in 18m 35s
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>2017-02-11 10:43:17 (384 KB/s) - libreboot_r20160907_src.tar.xz saved [438622508/438622508]
</span><span class='line'>
</span><span class='line'>staf@petronella:~/libreboot$ </span></code></pre></td></tr></table></div></figure>


<h3>Verify</h3>

<p>As always verify the checksums and the gpg signature, the gpg public key is available at:
<a href="https://libreboot.org/gpg/"</a><a href="https://libreboot.org/gpg/">https://libreboot.org/gpg/</a></a></p>

<h4>Download the  SHA512SUMS and SHA512SUMS.sig</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot$ wget https://libreboot.org/release/stable/20160907/SHA512SUMS                                                      
</span><span class='line'>--2017-02-11 10:52:23--  https://libreboot.org/release/stable/20160907/SHA512SUMS                                                                          
</span><span class='line'>Resolving libreboot.org (libreboot.org)... 149.56.232.100                                                                                                            
</span><span class='line'>Connecting to libreboot.org (libreboot.org)|149.56.232.100|:443... connected.                                                                                                  
</span><span class='line'>HTTP request sent, awaiting response... 200 OK                                                                                                                                 
</span><span class='line'>Length: 5112 (5,0K) [application/octet-stream]                                                                                                                                        
</span><span class='line'>Saving to: 'SHA512SUMS'                                                                                                                                                                          
</span><span class='line'>                                                                                                                                                                                                         
</span><span class='line'>100%[=====================================================================================================================================================================================================&gt;] 5.112       --.-K/s   in 0,006s  
</span><span class='line'>                                                                                                                                                                                                                          
</span><span class='line'>2017-02-11 10:52:24 (852 KB/s) - 'SHA512SUMS' saved [5112/5112]                                                                                                                                                                      
</span><span class='line'>                                                                                                                                                                                                                                             
</span><span class='line'>staf@petronella:~/libreboot$ wget https://libreboot.org/release/stable/20160907/SHA512SUMS.sig
</span><span class='line'>--2017-02-11 10:52:39--  https://libreboot.org/release/stable/20160907/SHA512SUMS.sig
</span><span class='line'>Resolving libreboot.org (libreboot.org)... 149.56.232.100
</span><span class='line'>Connecting to libreboot.org (libreboot.org)|149.56.232.100|:443... connected.
</span><span class='line'>HTTP request sent, awaiting response... 200 OK
</span><span class='line'>Length: 543 [application/pgp-signature]
</span><span class='line'>Saving to: 'SHA512SUMS.sig'
</span><span class='line'>
</span><span class='line'>100%[=====================================================================================================================================================================================================&gt;] 543         --.-K/s   in 0s      
</span><span class='line'>
</span><span class='line'>2017-02-11 10:52:39 (11,4 MB/s) - 'SHA512SUMS.sig' saved [543/543]
</span><span class='line'>
</span><span class='line'>staf@petronella:~/libreboot$ </span></code></pre></td></tr></table></div></figure>


<h4>Import the public gpg key</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot$ gpg --recv-keys 0x05E8C5B2
</span><span class='line'>gpg: directory `/home/staf/.gnupg' created
</span><span class='line'>gpg: new configuration file `/home/staf/.gnupg/gpg.conf' created
</span><span class='line'>gpg: WARNING: options in `/home/staf/.gnupg/gpg.conf' are not yet active during this run
</span><span class='line'>gpg: keyring `/home/staf/.gnupg/secring.gpg' created
</span><span class='line'>gpg: keyring `/home/staf/.gnupg/pubring.gpg' created
</span><span class='line'>gpg: no keyserver known (use option --keyserver)
</span><span class='line'>gpg: keyserver receive failed: bad URI
</span><span class='line'>staf@petronella:~/libreboot$ gpg --recv-keys 0x05E8C5B2
</span><span class='line'>gpg: requesting key 05E8C5B2 from hkp server keys.gnupg.net
</span><span class='line'>gpg: /home/staf/.gnupg/trustdb.gpg: trustdb created
</span><span class='line'>gpg: key 05E8C5B2: public key "Leah Rowe (Libreboot signing key) &lt;info@minifree.org&gt;" imported
</span><span class='line'>gpg: key 05E8C5B2: public key "Leah Rowe (Libreboot signing key) &lt;info@minifree.org&gt;" imported
</span><span class='line'>gpg: no ultimately trusted keys found
</span><span class='line'>gpg: Total number processed: 2
</span><span class='line'>gpg:               imported: 2  (RSA: 2)
</span><span class='line'>staf@petronella:~/libreboot$ </span></code></pre></td></tr></table></div></figure>


<h4>Verify the checksum file</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot$ gpg --verify SHA512SUMS.sig SHA512SUMS
</span><span class='line'>gpg: Signature made Don 08 Sep 2016 00:15:17 CEST using RSA key ID 05E8C5B2
</span><span class='line'>gpg: Good signature from "Leah Rowe (Libreboot signing key) &lt;info@minifree.org&gt;"
</span><span class='line'>gpg: WARNING: This key is not certified with a trusted signature!
</span><span class='line'>gpg:          There is no indication that the signature belongs to the owner.
</span><span class='line'>Primary key fingerprint: CDC9 CAE3 2CB4 B7FC 84FD  C804 969A 9795 05E8 C5B2
</span><span class='line'>staf@petronella:~/libreboot$ </span></code></pre></td></tr></table></div></figure>


<h4>Verify the checksum</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot$ sha512sum -c SHA512SUMS | head -2
</span><span class='line'>sha512sum: ./libreboot_r20160907_util.tar.xz: No such file or directory
</span><span class='line'>sha512sum: ./rom/depthcharge/libreboot_r20160907_depthcharge_veyron_speedy.tar.xz: No such file or directory
</span><span class='line'>sha512sum: ./rom/grub/libreboot_r20160907_grub_d510mo.tar.xz: No such file or directory
</span><span class='line'>sha512sum: ./libreboot_r20160907_src.tar.xz: OK
</span><span class='line'>./rom/grub/libreboot_r20160907_grub_ga-g41m-es2l.tar.xz./libreboot_r20160907_util.tar.xz: FAILED open or read
</span><span class='line'>: No such file or directory
</span><span class='line'>staf@petronella:~/libreboot$ </span></code></pre></td></tr></table></div></figure>


<p></p>

<h2>Build the modules</h2>

<h3>Git</h3>

<p>It&rsquo;s required to have git installed and to set the user email &amp; name if you don&rsquo;t do this the complilation will fail.</p>

<p>Install git</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot$ sudo apt-get install git
</span><span class='line'>[sudo] password for staf: 
</span><span class='line'>Reading package lists... Done
</span><span class='line'>Building dependency tree       
</span><span class='line'>Reading state information... Done
</span><span class='line'>The following extra packages will be installed:
</span><span class='line'>  git-man liberror-perl
</span><span class='line'>Suggested packages:
</span><span class='line'>  git-daemon-run git-daemon-sysvinit git-doc git-el git-email git-gui gitk
</span><span class='line'>  gitweb git-arch git-bzr git-cvs git-mediawiki git-svn
</span><span class='line'>The following NEW packages will be installed:
</span><span class='line'>  git git-man liberror-perl
</span><span class='line'>0 upgraded, 3 newly installed, 0 to remove and 0 not upgraded.
</span><span class='line'>Need to get 3.306 kB of archives.
</span><span class='line'>After this operation, 21,9 MB of additional disk space will be used.
</span><span class='line'>Do you want to continue? [Y/n] y
</span><span class='line'>Get:1 http://fr.archive.trisquel.info/trisquel/ belenos/main liberror-perl all 0.17-1.1 [21,1 kB]
</span><span class='line'>Get:2 http://fr.archive.trisquel.info/trisquel/ belenos-security/main git-man all 1:1.9.1-1ubuntu0.3 [699 kB]
</span><span class='line'>Get:3 http://fr.archive.trisquel.info/trisquel/ belenos-security/main git amd64 1:1.9.1-1ubuntu0.3 [2.586 kB]
</span><span class='line'>Fetched 3.306 kB in 4s (723 kB/s)
</span><span class='line'>Selecting previously unselected package liberror-perl.
</span><span class='line'>(Reading database ... 206214 files and directories currently installed.)
</span><span class='line'>Preparing to unpack .../liberror-perl_0.17-1.1_all.deb ...
</span><span class='line'>Unpacking liberror-perl (0.17-1.1) ...
</span><span class='line'>Selecting previously unselected package git-man.
</span><span class='line'>Preparing to unpack .../git-man_1%3a1.9.1-1ubuntu0.3_all.deb ...
</span><span class='line'>Unpacking git-man (1:1.9.1-1ubuntu0.3) ...
</span><span class='line'>Selecting previously unselected package git.
</span><span class='line'>Preparing to unpack .../git_1%3a1.9.1-1ubuntu0.3_amd64.deb ...
</span><span class='line'>Unpacking git (1:1.9.1-1ubuntu0.3) ...
</span><span class='line'>Processing triggers for man-db (2.6.7.1-1ubuntu1) ...
</span><span class='line'>Setting up liberror-perl (0.17-1.1) ...
</span><span class='line'>Setting up git-man (1:1.9.1-1ubuntu0.3) ...
</span><span class='line'>Setting up git (1:1.9.1-1ubuntu0.3) ...
</span><span class='line'>staf@petronella:~/libreboot$ </span></code></pre></td></tr></table></div></figure>


<p>Set the git username and password.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot$ git config --global user.email "staf@wagemakers.be"
</span><span class='line'>staf@petronella:~/libreboot$ git config --global user.name "staf wagemakers"
</span><span class='line'>staf@petronella:~/libreboot$ </span></code></pre></td></tr></table></div></figure>


<p></p>

<h3>Extract the source</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot$ tar xf libreboot_r20160907_src.tar.xz 
</span><span class='line'>staf@petronella:~/libreboot$ </span></code></pre></td></tr></table></div></figure>


<h3>Install the dependencies</h3>

<p>cd into the extracted directory</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot$ ls
</span><span class='line'>SHA512SUMS  SHA512SUMS.sig  libreboot_r20160907_src  libreboot_r20160907_src.tar.xz
</span><span class='line'>staf@petronella:~/libreboot$ cd libreboot_r20160907_src</span></code></pre></td></tr></table></div></figure>


<p>run dependencies trisquel7 to install the software dependencies.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ sudo ./build dependencies trisquel7
</span><span class='line'>Reading package lists... Done
</span><span class='line'>Building dependency tree       
</span><span class='line'>Reading state information... Done
</span><span class='line'>wget is already the newest version.
</span><span class='line'>0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
</span><span class='line'>Reading package lists... Done
</span><span class='line'>Building dependency tree       
</span><span class='line'>Reading state information... Done
</span><span class='line'>git is already the newest version.
</span><span class='line'>0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
</span><span class='line'>Reading package lists... Done
</span><span class='line'>Building dependency tree       
</span><span class='line'>Reading state information... Done
</span><span class='line'>The following extra packages will be installed:
</span><span class='line'>  fonts-lmodern fonts-texgyre latex-beamer latex-xcolor libintl-perl
</span><span class='line'>  liblua5.1-0 libpaper-utils libptexenc1 libruby1.9.1 libtext-unidecode-perl
</span><span class='line'>  libxml-libxml-perl libxml-namespacesupport-perl libxml-sax-base-perl
</span><span class='line'>  libxml-sax-expat-perl libxml-sax-perl libyaml-0-2 lmodern luatex pandoc-data
</span><span class='line'>  pgf prosper ps2eps ruby ruby1.9.1 tcl tcl8.6 tex-common tex-gyre
</span><span class='line'>  texlive-base texlive-binaries texlive-extra-utils texlive-font-utils</span></code></pre></td></tr></table></div></figure>


<p>&lt; snip &gt;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(Reading database ... 236394 files and directories currently installed.)
</span><span class='line'>Preparing to unpack .../lib32z1_1%3a1.2.8.dfsg-1ubuntu1_amd64.deb ...
</span><span class='line'>Unpacking lib32z1 (1:1.2.8.dfsg-1ubuntu1) ...
</span><span class='line'>Selecting previously unselected package lib32z1-dev.
</span><span class='line'>Preparing to unpack .../lib32z1-dev_1%3a1.2.8.dfsg-1ubuntu1_amd64.deb ...
</span><span class='line'>Unpacking lib32z1-dev (1:1.2.8.dfsg-1ubuntu1) ...
</span><span class='line'>Setting up lib32z1 (1:1.2.8.dfsg-1ubuntu1) ...
</span><span class='line'>Setting up lib32z1-dev (1:1.2.8.dfsg-1ubuntu1) ...
</span><span class='line'>Processing triggers for libc-bin (2.19-0ubuntu6.9) ...
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ </span></code></pre></td></tr></table></div></figure>


<h3>Build module all</h3>

<p>Build the modules by excuting build module all</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot/libreboot/libreboot_r20160907_src$ ./build module all
</span><span class='line'>Building bucts
</span><span class='line'>rm -f bucts bucts.o
</span><span class='line'>gcc  -DVERSION='"withoutgit"' -c bucts.c
</span><span class='line'>gcc -o bucts bucts.o  -lpci
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Building the utilities in coreboot
</span><span class='line'>make: Entering directory `/home/staf/libreboot/libreboot_r20160907_src/coreboot/15fca66bf08db45937ce88b950491963654805b9/15fca66bf08db45937ce88b950491963654805b9/util/cbfstool'
</span><span class='line'>    HOSTCC     cbfstool/cbfstool.o
</span><span class='line'>    HOSTCC     cbfstool/common.o
</span><span class='line'>    HOSTCC     cbfstool/compress.o
</span><span class='line'>    HOSTCC     cbfstool/cbfs_hash.o
</span><span class='line'>    HOSTCC     cbfstool/cbfs_image.o
</span><span class='line'>    HOSTCC     cbfstool/cbfs-mkstage.o
</span><span class='line'>    HOSTCC     cbfstool/cbfs-mkpayload.o
</span><span class='line'>    HOSTCC     cbfstool/elfheaders.o
</span><span class='line'>    HOSTCC     cbfstool/rmodule.o
</span><span class='line'>    HOSTCC     cbfstool/xdr.o
</span><span class='line'>    HOSTCC     cbfstool/fit.o
</span><span class='line'>    HOSTCC     cbfstool/partitioned_file.o</span></code></pre></td></tr></table></div></figure>


<p>&lt; snip &gt;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  Compile checking out/vgasrc/stdvgamodes.o
</span><span class='line'>  Compile checking out/vgasrc/stdvgaio.o
</span><span class='line'>  Compile checking out/vgasrc/clext.o
</span><span class='line'>  Compile checking out/vgasrc/bochsvga.o
</span><span class='line'>  Compile checking out/vgasrc/geodevga.o
</span><span class='line'>  Compile checking out/vgasrc/cbvga.o
</span><span class='line'>  Compiling whole program out/vgaccode16.raw.s
</span><span class='line'>  Fixup VGA rom assembler
</span><span class='line'>  Compiling (16bit) out/vgaentry.o
</span><span class='line'>  Precompiling out/vgasrc/vgalayout.lds
</span><span class='line'>  Linking out/vgarom.o
</span><span class='line'>Version: ?-20170211_123929-petronella
</span><span class='line'>  Extracting binary out/vgabios.bin.raw
</span><span class='line'>  Finalizing rom out/vgabios.bin
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ </span></code></pre></td></tr></table></div></figure>


<h2>Build the ROMS</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ ./build roms withgrub
</span><span class='line'>Building ROM images with the GRUB payload
</span><span class='line'>Creating GRUB ELF executable for configuration 'txtmode'
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Creating GRUB ELF executable for configuration 'vesafb'
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>GRUB Helper script: build ROM images for 'd510mo'
</span><span class='line'>M       3rdparty/vboot
</span><span class='line'>Switched to branch 'grub_d510mo'
</span><span class='line'>Switched to branch 'grub_d510mo'
</span><span class='line'>No submodule mapping found in .gitmodules for path '3rdparty/vboot'
</span><span class='line'>No submodule mapping found in .gitmodules for path '3rdparty/vboot'</span></code></pre></td></tr></table></div></figure>


<p>&lt; snip &gt;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>12288 bytes (12 kB) copied, 0,026113 s, 471 kB/s
</span><span class='line'>12288+0 records in
</span><span class='line'>12288+0 records out
</span><span class='line'>12288 bytes (12 kB) copied, 0,0259776 s, 473 kB/s
</span><span class='line'>12288+0 records in
</span><span class='line'>12288+0 records out
</span><span class='line'>12288 bytes (12 kB) copied, 0,0261767 s, 469 kB/s
</span><span class='line'>12288+0 records in
</span><span class='line'>12288+0 records out
</span><span class='line'>12288 bytes (12 kB) copied, 0,0261144 s, 471 kB/s
</span><span class='line'>12288+0 records in
</span><span class='line'>12288+0 records out
</span><span class='line'>12288 bytes (12 kB) copied, 0,0282761 s, 435 kB/s
</span><span class='line'>12288+0 records in
</span><span class='line'>12288+0 records out
</span><span class='line'>12288 bytes (12 kB) copied, 0,0271539 s, 453 kB/s
</span><span class='line'>12288+0 records in
</span><span class='line'>12288+0 records out
</span><span class='line'>12288 bytes (12 kB) copied, 0,0295147 s, 416 kB/s
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ </span></code></pre></td></tr></table></div></figure>


<p>The rom build command creates a bin directory, verify that required roms are available.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ cd bin/
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src/bin$ ls -l
</span><span class='line'>total 4
</span><span class='line'>drwxrwxr-x 23 staf staf 4096 Feb  11 15:58 grub
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src/bin$ cd grub/
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src/bin/grub$ ls -l
</span><span class='line'>total 84
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:28 d510mo
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:29 ga-g41m-es2l
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:30 kcma-d8
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:31 kgpe-d16
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:32 macbook21
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:33 qemu_i440fx_piix4
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:34 qemu_q35_ich9
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:59 r400_16mb
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:59 r400_4mb
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:59 r400_8mb
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:59 t400_16mb
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:59 t400_4mb
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:59 t400_8mb
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:59 t500_16mb
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:59 t500_4mb
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:59 t500_8mb
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:58 t60
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:59 x200_16mb
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:58 x200_4mb
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:58 x200_8mb
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:58 x60
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src/bin/grub$ </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src/bin/grub$ cd x60
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src/bin/grub/x60$ ls -l
</span><span class='line'>total 40960
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_deqwertz_txtmode.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_deqwertz_vesafb.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_esqwerty_txtmode.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_esqwerty_vesafb.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_frazerty_txtmode.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_frazerty_vesafb.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_frdvbepo_txtmode.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_frdvbepo_vesafb.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_itqwerty_txtmode.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_itqwerty_vesafb.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_svenska_txtmode.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_svenska_vesafb.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_ukdvorak_txtmode.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_ukdvorak_vesafb.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_ukqwerty_txtmode.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_ukqwerty_vesafb.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_usdvorak_txtmode.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_usdvorak_vesafb.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_usqwerty_txtmode.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_usqwerty_vesafb.rom</span></code></pre></td></tr></table></div></figure>


<h1>Libreboot Installation</h1>

<h2>Backup</h2>

<p>Backups are important. We&rsquo;ll first backup the orginal proprietary <a href="https://en.wikipedia.org/wiki/BIOS">BIOS</a> before we free the laptop and install a <a href="https://en.wikipedia.org/wiki/Free_software">Free Software firmware</a></p>

<p>The documentation that I found (see Links below) describes that the backup has 2 step flashrom_lenovobios_sst &amp; flashrom_lenovobios_macronix.</p>

<p>The flashrom_lenovobios_macronix command fails on my Laptop/Table but I decided to continue with the installation since I didn&rsquo;t pay a lot for the laptop on ebay.be.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ sudo flashrom/flashrom_lenovobios_sst -p internal -r factory.bin
</span><span class='line'>[sudo] password for staf: 
</span><span class='line'>flashrom v0.9.9-unknown on Linux 3.13.0-108-lowlatency (x86_64)
</span><span class='line'>flashrom is free software, get the source code at https://flashrom.org
</span><span class='line'>
</span><span class='line'>Calibrating delay loop... OK.
</span><span class='line'>Found chipset "Intel ICH7M".
</span><span class='line'>Enabling flash write... WARNING: SPI Configuration Lockdown activated.
</span><span class='line'>OK.
</span><span class='line'>Found SST flash chip "SST25VF016B" (2048 kB, SPI) mapped at physical address 0x00000000ffe00000.
</span><span class='line'>Reading flash... done.
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src/flashrom$ sudo ./flashrom_lenovobios_macronix -p internal -r factory.bin
</span><span class='line'>flashrom v0.9.9-unknown on Linux 3.13.0-108-lowlatency (x86_64)
</span><span class='line'>flashrom is free software, get the source code at https://flashrom.org
</span><span class='line'>
</span><span class='line'>Calibrating delay loop... OK.
</span><span class='line'>Found chipset "Intel ICH7M".
</span><span class='line'>Enabling flash write... WARNING: SPI Configuration Lockdown activated.
</span><span class='line'>OK.
</span><span class='line'>No EEPROM/flash device found.
</span><span class='line'>Note: flashrom can never write if the flash chip isn't found automatically.
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src/flashrom$ </span></code></pre></td></tr></table></div></figure>


<h2>Install the rom</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ sudo ./flash i945lenovo_firstflash bin/grub/x
</span><span class='line'>x200_16mb/ x200_4mb/  x200_8mb/  x60/       
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ sudo ./flash i945lenovo_firstflash bin/grub/x60/x60_
</span><span class='line'>x60_deqwertz_txtmode.rom  x60_frazerty_txtmode.rom  x60_itqwerty_txtmode.rom  x60_ukdvorak_txtmode.rom  x60_usdvorak_txtmode.rom
</span><span class='line'>x60_deqwertz_vesafb.rom   x60_frazerty_vesafb.rom   x60_itqwerty_vesafb.rom   x60_ukdvorak_vesafb.rom   x60_usdvorak_vesafb.rom
</span><span class='line'>x60_esqwerty_txtmode.rom  x60_frdvbepo_txtmode.rom  x60_svenska_txtmode.rom   x60_ukqwerty_txtmode.rom  x60_usqwerty_txtmode.rom
</span><span class='line'>x60_esqwerty_vesafb.rom   x60_frdvbepo_vesafb.rom   x60_svenska_vesafb.rom    x60_ukqwerty_vesafb.rom   x60_usqwerty_vesafb.rom
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ sudo ./flash i945lenovo_firstflash bin/grub/x60/x60_us
</span><span class='line'>x60_usdvorak_txtmode.rom  x60_usdvorak_vesafb.rom   x60_usqwerty_txtmode.rom  x60_usqwerty_vesafb.rom   
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ sudo ./flash i945lenovo_firstflash bin/grub/x60/x60_usqwerty_vesafb.rom 
</span><span class='line'>[sudo] password for staf: 
</span><span class='line'>Mode selected: i945lenovo_firstflash
</span><span class='line'>bucts utility version 'withoutgit'
</span><span class='line'>Using LPC bridge 8086:27b9 at 0000:1f.00
</span><span class='line'>Current BUC.TS=0 - 128kb address range 0xFFFE0000-0xFFFFFFFF is untranslated
</span><span class='line'>Updated BUC.TS=1 - 64kb address ranges at 0xFFFE0000 and 0xFFFF0000 are swapped
</span><span class='line'>flashrom v0.9.9-unknown on Linux 3.13.0-108-lowlatency (x86_64)
</span><span class='line'>flashrom is free software, get the source code at https://flashrom.org
</span><span class='line'>
</span><span class='line'>Calibrating delay loop... OK.
</span><span class='line'>Found chipset "Intel ICH7M".
</span><span class='line'>Enabling flash write... WARNING: SPI Configuration Lockdown activated.
</span><span class='line'>OK.
</span><span class='line'>Found SST flash chip "SST25VF016B" (2048 kB, SPI) mapped at physical address 0x00000000ffe00000.
</span><span class='line'>Reading old flash chip contents... done.
</span><span class='line'>Erasing and writing flash chip... spi_block_erase_20 failed during command execution at address 0x0
</span><span class='line'>Reading current flash chip contents... done. Looking for another erase function.
</span><span class='line'>spi_block_erase_52 failed during command execution at address 0x0
</span><span class='line'>Reading current flash chip contents... done. Looking for another erase function.
</span><span class='line'>Transaction error!
</span><span class='line'>spi_block_erase_d8 failed during command execution at address 0x1f0000
</span><span class='line'>Reading current flash chip contents... done. Looking for another erase function.
</span><span class='line'>spi_chip_erase_60 failed during command execution
</span><span class='line'>Reading current flash chip contents... done. Looking for another erase function.
</span><span class='line'>spi_chip_erase_c7 failed during command execution
</span><span class='line'>Looking for another erase function.
</span><span class='line'>No usable erase functions left.
</span><span class='line'>FAILED!
</span><span class='line'>Uh oh. Erase/write failed. Checking if anything has changed.
</span><span class='line'>Reading current flash chip contents... done.
</span><span class='line'>Apparently at least some data has changed.
</span><span class='line'>Your flash chip is in an unknown state.
</span><span class='line'>Get help on IRC at chat.freenode.net (channel #flashrom) or
</span><span class='line'>mail flashrom@flashrom.org with the subject "FAILED: &lt;your board name&gt;"!
</span><span class='line'>-------------------------------------------------------------------------------
</span><span class='line'>DO NOT REBOOT OR POWEROFF!
</span><span class='line'>flashrom v0.9.9-unknown on Linux 3.13.0-108-lowlatency (x86_64)
</span><span class='line'>flashrom is free software, get the source code at https://flashrom.org
</span><span class='line'>
</span><span class='line'>Calibrating delay loop... OK.
</span><span class='line'>Found chipset "Intel ICH7M".
</span><span class='line'>Enabling flash write... WARNING: SPI Configuration Lockdown activated.
</span><span class='line'>OK.
</span><span class='line'>No EEPROM/flash device found.
</span><span class='line'>Note: flashrom can never write if the flash chip isn't found automatically.
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ </span></code></pre></td></tr></table></div></figure>


<p>Power down your system</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ sudo poweroff
</span><span class='line'>
</span><span class='line'>Broadcast message from staf@petronella
</span><span class='line'>        (/dev/pts/7) at 16:11 ...
</span><span class='line'>
</span><span class='line'>The system is going down for power off NOW!
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ Connection to petronella closed by remote host.
</span><span class='line'>Connection to petronella closed.
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<p>Wait 2 minutes and boot the system again. If you&rsquo;re lucky the system will boot with the Free Libreboot firmware.
Logon the system again and continue with the secondflash phase</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ ssh petronella 
</span><span class='line'>C_GetAttributeValue failed: 18
</span><span class='line'>no such identity: /home/staf/.ssh/id_rsa: No such file or directory
</span><span class='line'>no such identity: /home/staf/.ssh/id_dsa: No such file or directory
</span><span class='line'>no such identity: /home/staf/.ssh/id_ecdsa: No such file or directory
</span><span class='line'>no such identity: /home/staf/.ssh/id_ed25519: No such file or directory
</span><span class='line'>staf@petronella's password: 
</span><span class='line'>Welcome to Trisquel GNU/Linux 7.0, Belenos (GNU/Linux 3.13.0-108-lowlatency x86_64)
</span><span class='line'>   ___        ___               ___        ___       ___        ___        ___
</span><span class='line'>  /\  \      /\  \      ___    /\  \      /\  \     /\__\      /\  \      /\__\
</span><span class='line'>  \ \  \    /  \  \    /\  \  /  \  \    /  \  \   / /  /     /  \  \    / /  /
</span><span class='line'>   \ \  \  / /\ \  \   \ \  \/ /\ \  \  / /\ \  \ / /  /     / /\ \  \  / /  /
</span><span class='line'>   /  \  \/  \ \ \  \  /  \__\ \ \ \  \/ /  \ \  \ /  /  ___/  \ \ \  \/ /  /
</span><span class='line'>  / /\ \__\/\ \ \ \__\/ /\/__/\ \ \ \__\/__/ \ \__\__/  /\__\/\ \ \ \__\/__/
</span><span class='line'> / /  \/__/_|  \/ /  / /  /\ \ \ \ \/__/\  \ / /  /  \ / /  /\ \ \ \/__/\  \
</span><span class='line'>/ /  /      | |  /  / /__/  \ \ \ \__\ \ \/\/ /  / \  / /  /\ \ \ \__\ \ \  \
</span><span class='line'>\/__/       | |\/__/\ \__\   \ \/ /  /  \    /  / \ \/ /  /  \ \ \/__/  \ \  \
</span><span class='line'>            | |  |   \/__/    \  /  /    \  /  /   \  /  /    \ \__\     \ \__\
</span><span class='line'>             \|__|             \/__/      \/__/     \/__/      \/__/      \/__/
</span><span class='line'>
</span><span class='line'>Welcome to Trisquel GNU/Linux
</span><span class='line'>Documentation: http://trisquel.info/wiki/
</span><span class='line'>
</span><span class='line'>Last login: Sat Feb 11 15:43:11 2017 from 192.168.1.10
</span><span class='line'>staf@petronella:~$ cd libreboot/libreboot
</span><span class='line'>libreboot/               libreboot_r20160907_src/ 
</span><span class='line'>staf@petronella:~$ cd libreboot/libreboot_r20160907_src/
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$  ./flash i945lenovo_secondflash bin/grub/x60/x60_usqwerty_vesafb.rom 
</span><span class='line'>This script must be run as root
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ ^C libreboot/libreboot_r20160907_src/
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ sudo ./flash i945lenovo_secondflash bin/grub/x60/x60_usqwerty_vesafb.rom
</span><span class='line'>[sudo] password for staf: 
</span><span class='line'>Mode selected: i945lenovo_secondflash
</span><span class='line'>flashrom v0.9.9-unknown on Linux 3.13.0-108-lowlatency (x86_64)
</span><span class='line'>flashrom is free software, get the source code at https://flashrom.org
</span><span class='line'>
</span><span class='line'>Calibrating delay loop... OK.
</span><span class='line'>coreboot table found at 0xcbe9f000.
</span><span class='line'>Found chipset "Intel ICH7M".
</span><span class='line'>Enabling flash write... OK.
</span><span class='line'>Found SST flash chip "SST25VF016B" (2048 kB, SPI) mapped at physical address 0x00000000ffe00000.
</span><span class='line'>Reading old flash chip contents... done.
</span><span class='line'>Erasing and writing flash chip... Erase/write done.
</span><span class='line'>Verifying flash... VERIFIED.
</span><span class='line'>bucts utility version 'withoutgit'
</span><span class='line'>Using LPC bridge 8086:27b9 at 0000:1f.00
</span><span class='line'>Current BUC.TS=1 - 64kb address ranges at 0xFFFE0000 and 0xFFFF0000 are swapped
</span><span class='line'>Updated BUC.TS=0 - 128kb address range 0xFFFE0000-0xFFFFFFFF is untranslated
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ </span></code></pre></td></tr></table></div></figure>


<p>The installation is completed! Reboot our system and enjoy your Free As In Freedom Laptop.</p>

<p><img class="centre" src="https://stafwag.github.io/blog/images/x60_free.jpg" width="750" height="853" title="&#34;Thinkpad x60 open&#34;" alt="&#34;Thinkpad x60 open&#34;"></p>

<p style="font-style: italic;">
Have fun
</p>


<h1>Links</h1>

<ul>
<li><a href="https://www.libreboot.org"><a href="https://www.libreboot.org">https://www.libreboot.org</a></a></li>
<li><a href="https://libreboot.org/docs/install/#rom"><a href="https://libreboot.org/docs/install/#rom">https://libreboot.org/docs/install/#rom</a></a></li>
<li><a href="https://www.coreboot.org/Board:lenovo/x60/Installation"><a href="https://www.coreboot.org/Board:lenovo/x60/Installation">https://www.coreboot.org/Board:lenovo/x60/Installation</a></a></li>
<li><a href="http://www.linuxjournal.com/content/libreboot-x60-part-ii-installation"><a href="http://www.linuxjournal.com/content/libreboot-x60-part-ii-installation">http://www.linuxjournal.com/content/libreboot-x60-part-ii-installation</a></a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Best Wishes 2017!]]></title>
    <link href="https://stafwag.github.io/blog/blog/2017/01/01/best-wishes-2017/"/>
    <updated>2017-01-01T09:43:34+01:00</updated>
    <id>https://stafwag.github.io/blog/blog/2017/01/01/best-wishes-2017</id>
    <content type="html"><![CDATA[<p><strong><em> Best Wishes 2017! </em></strong></p>

<p><img class="center" src="https://stafwag.github.io/blog/images/best_wishes_2017_scaled.jpg" width="1000" height="667" title="&#34;best_wishes_2017_scaled.jpg&#34;" alt="&#34;best_wishes_2017_scaled.jpg&#34;"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Install Arch on an Encrypted Btrfs Partition]]></title>
    <link href="https://stafwag.github.io/blog/blog/2016/08/30/arch-on-an-encrypted-btrfs-partition/"/>
    <updated>2016-08-30T08:59:00+02:00</updated>
    <id>https://stafwag.github.io/blog/blog/2016/08/30/arch-on-an-encrypted-btrfs-partition</id>
    <content type="html"><![CDATA[<p><img class="right" src="https://stafwag.github.io/blog/images/Arch-linux-logo.png" width="300" height="225" title="&#34;Arch Linux Logo&#34;" alt="&#34;Arch Linux Logo&#34;"></p>

<p>I&rsquo;m preparing to move <a href="http://stafwag.github.io/blog/blog/2013/08/25/the-benefits-of-stopping-smoking-dot-dot-dot/">my workstation</a> to <a href="https://www.archlinux.org/">arch linux</a> Before I&rsquo;ll install it on my physical workstation I did the installation on a virtual machine. I&rsquo;ll use <a href="https://btrfs.wiki.kernel.org/index.php/Main_Page">btrfs</a> as the filesystem during the installation. btrfs is a nice filesystem but it had some serious dataloss issue with <a href="https://btrfs.wiki.kernel.org/index.php/RAID56">RAID5/RAID6</a> recently.</p>

<p>btrfs might not stable enough for a production environment but it has some nice features like snapshots, send/recieve, compression etc. I use <a href="http://www.open-zfs.org/wiki/Main_Page">zfs</a> for my important date anyway.</p>

<h2>To encrypt or not to encrypt&hellip;</h2>

<p>It&rsquo;s possible to encrypt your boot partition <a href="https://www.gnu.org/software/grub/">grub</a> has support for <a href="https://en.wikipedia.org/wiki/Linux_Unified_Key_Setup">luks</a> volumes. This cause grub to ask for a password during the system startup you&rsquo;ll need to type in your password a second time during the system startup when you Linux initrd image is booted. It&rsquo;s possible to avoid this by adding a keyfile to your crypttab - which migh be considered as a security risk -.</p>

<p>In this howto we&rsquo;ll setup a single root partition to have full disk encryption. I&rsquo;m not sure I go with an encrypted boot partition during my final installation. I might just create an empty partition of 1G so I can move switch between an encrypted and an non-encrypted boot filesystem.</p>

<p><img class="left" src="https://stafwag.github.io/blog/images/arch-on-an-encrypted-btrfs-partition/00_boot.png" width="440" title="&#34;00_boot.png&#34;" alt="&#34;00_boot.png&#34;"></p>

<h2>Download the arch linux iso and boot it</h2>

<p>After arch linux is booted verify that you have internet access if the network card is support and dchp is enabled on you network you should get a network address.</p>

<h2>Network access</h2>

<p>To setup the system remotely we first need to setup network to our system.</p>

<h3>Verify the interface</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@archiso ~ # ip a
</span><span class='line'>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default 
</span><span class='line'>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span><span class='line'>    inet 127.0.0.1/8 scope host lo
</span><span class='line'>       valid_lft forever preferred_lft forever
</span><span class='line'>    inet6 ::1/128 scope host 
</span><span class='line'>       valid_lft forever preferred_lft forever
</span><span class='line'>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
</span><span class='line'>    link/ether 52:54:00:69:d4:94 brd ff:ff:ff:ff:ff:ff
</span><span class='line'>    inet 192.168.122.23/24 brd 192.168.122.255 scope global eth0
</span><span class='line'>       valid_lft forever preferred_lft forever
</span><span class='line'>    inet6 fe80::a7b:481f:2f70:e688/64 scope link 
</span><span class='line'>       valid_lft forever preferred_lft forever
</span><span class='line'>root@archiso ~ # </span></code></pre></td></tr></table></div></figure>


<h3>Verify internet access</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@archiso ~ # ping -c 3 8.8.8.8                                                                                      :(
</span><span class='line'>PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
</span><span class='line'>64 bytes from 8.8.8.8: icmp_seq=1 ttl=49 time=49.2 ms
</span><span class='line'>64 bytes from 8.8.8.8: icmp_seq=2 ttl=49 time=45.8 ms
</span><span class='line'>64 bytes from 8.8.8.8: icmp_seq=3 ttl=49 time=46.8 ms
</span><span class='line'>
</span><span class='line'>--- 8.8.8.8 ping statistics ---
</span><span class='line'>3 packets transmitted, 3 received, 0% packet loss, time 2003ms
</span><span class='line'>rtt min/avg/max/mdev = 45.896/47.329/49.201/1.406 ms
</span><span class='line'>root@archiso ~ # nslookup www.google.be
</span><span class='line'>Server:         192.168.122.1
</span><span class='line'>Address:        192.168.122.1#53
</span><span class='line'>
</span><span class='line'>Non-authoritative answer:
</span><span class='line'>Name:   www.google.be
</span><span class='line'>Address: 64.233.167.94
</span><span class='line'>
</span><span class='line'>root@archiso ~ # ping www.google.be
</span><span class='line'>PING www.google.be (64.233.167.94) 56(84) bytes of data.
</span><span class='line'>64 bytes from wl-in-f94.1e100.net (64.233.167.94): icmp_seq=1 ttl=46 time=58.7 ms
</span><span class='line'>64 bytes from wl-in-f94.1e100.net (64.233.167.94): icmp_seq=2 ttl=46 time=58.7 ms
</span><span class='line'>64 bytes from wl-in-f94.1e100.net (64.233.167.94): icmp_seq=3 ttl=46 time=58.4 ms
</span><span class='line'>^C
</span><span class='line'>--- www.google.be ping statistics ---
</span><span class='line'>3 packets transmitted, 3 received, 0% packet loss, time 2000ms
</span><span class='line'>rtt min/avg/max/mdev = 58.479/58.645/58.742/0.230 ms
</span><span class='line'>root@archiso ~ #                   
</span></code></pre></td></tr></table></div></figure>


<h2>ssh access</h2>

<p>If you want to install arch linux over ssh you need to assign a root passwd and start the sshd service.</p>

<h3>root password</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@archiso ~ # passwd root       
</span><span class='line'>Enter new UNIX password: 
</span><span class='line'>Retype new UNIX password: 
</span><span class='line'>passwd: password updated successfully
</span><span class='line'>root@archiso ~ # </span></code></pre></td></tr></table></div></figure>


<h3>start sshd</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@archiso ~ # systemctl list-unit-files -t service | grep ssh
</span><span class='line'>sshd.service                               disabled
</span><span class='line'>sshd@.service                              static  
</span><span class='line'>sshdgenkeys.service                        static  
</span><span class='line'>root@archiso ~ # systemctl start sshd                           
</span><span class='line'>root@archiso ~ #
</span></code></pre></td></tr></table></div></figure>


<h3>Logon remotely</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ ssh -l root 192.168.122.23
</span><span class='line'>root@192.168.122.23's password: 
</span><span class='line'>Last login: Tue Jun 30 09:06:00 2015 from 192.168.122.1
</span><span class='line'>root@archiso ~ # </span></code></pre></td></tr></table></div></figure>


<h2>Partition</h2>

<h3>Find your harddisk device name</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@archiso ~ # cat /proc/partitions
</span><span class='line'>major minor  #blocks  name
</span><span class='line'>
</span><span class='line'>   8        0  268435456 sda
</span><span class='line'>  11        0     759808 sr0
</span><span class='line'>   7        0     328616 loop0
</span><span class='line'>root@archiso ~ # </span></code></pre></td></tr></table></div></figure>


<h3>Overwrite it with random data</h3>

<p>Because we are creating an ecrypted filesystem it&rsquo;s a good idea to overwrite it with random data.</p>

<p>We&rsquo;ll use badblocks for this another method is to use &ldquo;dd if=/dev/random of=/dev/xxx&rdquo; the &ldquo;dd&rdquo; method is probably the best method but is a lot slower.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@archiso ~ # badblocks -c 10240 -s -w -t random -v /dev/sda
</span><span class='line'>Checking for bad blocks in read-write mode
</span><span class='line'>From block 0 to 268435455
</span><span class='line'>Testing with random pattern: done                                                 
</span><span class='line'>Reading and comparing: done                                                 
</span><span class='line'>Pass completed, 0 bad blocks found. (0/0/0 errors)
</span><span class='line'>badblocks -c 10240 -s -w -t random -v /dev/sda  49.22s user 21.72s system 3% cpu 33:48.40 total
</span><span class='line'>root@archiso ~ # </span></code></pre></td></tr></table></div></figure>


<h3>Partition the harddisk</h3>

<p>Create 3 partitions:</p>

<ul>
<li>1G /boot (we&rsquo;ll not use this during the installation - see above - )</li>
<li>32G swap</li>
<li>root btrfs partition</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@archiso ~ # fdisk /dev/sda                                
</span><span class='line'>
</span><span class='line'>Welcome to fdisk (util-linux 2.28).                                                    
</span><span class='line'>Changes will remain in memory only, until you decide to write them.
</span><span class='line'>Be careful before using the write command.
</span><span class='line'>
</span><span class='line'>Device does not contain a recognized partition table.
</span><span class='line'>Created a new DOS disklabel with disk identifier 0x7ff944e5.
</span><span class='line'>
</span><span class='line'>Command (m for help): p
</span><span class='line'>Disk /dev/sda: 256 GiB, 274877906944 bytes, 536870912 sectors
</span><span class='line'>Units: sectors of 1 * 512 = 512 bytes
</span><span class='line'>Sector size (logical/physical): 512 bytes / 512 bytes
</span><span class='line'>I/O size (minimum/optimal): 512 bytes / 512 bytes
</span><span class='line'>Disklabel type: dos
</span><span class='line'>Disk identifier: 0x7ff944e5
</span><span class='line'>
</span><span class='line'>Command (m for help): n
</span><span class='line'>Partition type
</span><span class='line'>   p   primary (0 primary, 0 extended, 4 free)
</span><span class='line'>   e   extended (container for logical partitions)
</span><span class='line'>Select (default p): p
</span><span class='line'>Partition number (1-4, default 1): 1
</span><span class='line'>First sector (2048-536870911, default 2048): +1G
</span><span class='line'>Value out of range.
</span><span class='line'>First sector (2048-536870911, default 2048): 
</span><span class='line'>Last sector, +sectors or +size{K,M,G,T,P} (2048-536870911, default 536870911): 
</span><span class='line'>Do you really want to quit? y
</span><span class='line'>1 root@archiso ~ # fdisk /dev/sda                                                   :(
</span><span class='line'>
</span><span class='line'>Welcome to fdisk (util-linux 2.28).                                                    
</span><span class='line'>Changes will remain in memory only, until you decide to write them.
</span><span class='line'>Be careful before using the write command.
</span><span class='line'>
</span><span class='line'>Device does not contain a recognized partition table.
</span><span class='line'>Created a new DOS disklabel with disk identifier 0xa806e281.
</span><span class='line'>
</span><span class='line'>Command (m for help): p
</span><span class='line'>Disk /dev/sda: 256 GiB, 274877906944 bytes, 536870912 sectors
</span><span class='line'>Units: sectors of 1 * 512 = 512 bytes
</span><span class='line'>Sector size (logical/physical): 512 bytes / 512 bytes
</span><span class='line'>I/O size (minimum/optimal): 512 bytes / 512 bytes
</span><span class='line'>Disklabel type: dos
</span><span class='line'>Disk identifier: 0xa806e281
</span><span class='line'>
</span><span class='line'>Command (m for help): n
</span><span class='line'>Partition type
</span><span class='line'>   p   primary (0 primary, 0 extended, 4 free)
</span><span class='line'>   e   extended (container for logical partitions)
</span><span class='line'>Select (default p): p
</span><span class='line'>Partition number (1-4, default 1): 1
</span><span class='line'>First sector (2048-536870911, default 2048): 
</span><span class='line'>Last sector, +sectors or +size{K,M,G,T,P} (2048-536870911, default 536870911): +1G
</span><span class='line'>
</span><span class='line'>Created a new partition 1 of type 'Linux' and of size 1 GiB.
</span><span class='line'>
</span><span class='line'>Command (m for help): n
</span><span class='line'>Partition type
</span><span class='line'>   p   primary (1 primary, 0 extended, 3 free)
</span><span class='line'>   e   extended (container for logical partitions)
</span><span class='line'>Select (default p): p
</span><span class='line'>Partition number (2-4, default 2): 
</span><span class='line'>First sector (2099200-536870911, default 2099200): 
</span><span class='line'>Last sector, +sectors or +size{K,M,G,T,P} (2099200-536870911, default 536870911): +32G
</span><span class='line'>
</span><span class='line'>Created a new partition 2 of type 'Linux' and of size 32 GiB.
</span><span class='line'>
</span><span class='line'>Command (m for help): n
</span><span class='line'>Partition type
</span><span class='line'>   p   primary (2 primary, 0 extended, 2 free)
</span><span class='line'>   e   extended (container for logical partitions)
</span><span class='line'>Select (default p): p
</span><span class='line'>Partition number (3,4, default 3): 
</span><span class='line'>First sector (69208064-536870911, default 69208064): 
</span><span class='line'>Last sector, +sectors or +size{K,M,G,T,P} (69208064-536870911, default 536870911): 
</span><span class='line'>
</span><span class='line'>Created a new partition 3 of type 'Linux' and of size 223 GiB.
</span><span class='line'>
</span><span class='line'>Command (m for help): w
</span><span class='line'>The partition table has been altered.
</span><span class='line'>Calling ioctl() to re-read partition table.
</span><span class='line'>Syncing disks.
</span><span class='line'>
</span><span class='line'>root@archiso ~ # </span></code></pre></td></tr></table></div></figure>


<h3>Format the root partition</h3>

<p>We&rsquo;ll continue with the root filesystem - we&rsquo;ll initialize the swapspace after the installation -</p>

<h4>Create the root luks volume;</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@archiso ~ # cryptsetup luksFormat --cipher aes-xts-plain64 --key-size 256 --hash sha256 --use-random /dev/sda3
</span><span class='line'>
</span><span class='line'>WARNING!
</span><span class='line'>========
</span><span class='line'>This will overwrite data on /dev/sda3 irrevocably.
</span><span class='line'>
</span><span class='line'>Are you sure? (Type uppercase yes): YES
</span><span class='line'>Enter passphrase: 
</span><span class='line'>Verify passphrase: 
</span><span class='line'>5.01s user 0.04s system 21% cpu 23.750 total
</span><span class='line'>root@archiso ~ # </span></code></pre></td></tr></table></div></figure>


<h4>Open the root luks volume</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@archiso ~ # cryptsetup luksOpen /dev/sda3 cryptroot
</span><span class='line'>Enter passphrase for /dev/sda3: 
</span><span class='line'>root@archiso ~ # </span></code></pre></td></tr></table></div></figure>


<h4>Format the root volume with btrfs</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@archiso ~ # mkfs.btrfs /dev/mapper/cryptroot
</span><span class='line'>btrfs-progs v4.6.1
</span><span class='line'>See http://btrfs.wiki.kernel.org for more information.
</span><span class='line'>
</span><span class='line'>Label:              (null)
</span><span class='line'>UUID:               cbfcc8d6-0cf9-4656-bcda-2525faeadfe6
</span><span class='line'>Node size:          16384
</span><span class='line'>Sector size:        4096
</span><span class='line'>Filesystem size:    217.00GiB
</span><span class='line'>Block group profiles:
</span><span class='line'>  Data:             single            8.00MiB
</span><span class='line'>  Metadata:         DUP               1.01GiB
</span><span class='line'>  System:           DUP              12.00MiB
</span><span class='line'>SSD detected:       no
</span><span class='line'>Incompat features:  extref, skinny-metadata
</span><span class='line'>Number of devices:  1
</span><span class='line'>Devices:
</span><span class='line'>   ID        SIZE  PATH
</span><span class='line'>    1   217.00GiB  /dev/mapper/cryptroot
</span><span class='line'>
</span><span class='line'>root@archiso ~ # </span></code></pre></td></tr></table></div></figure>


<h4>Mount the root filesystem</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@archiso ~ # mount -o noatime,compress=lzo,discard,ssd,defaults /dev/mapper/cryptroot /mnt
</span><span class='line'>root@archiso ~ # </span></code></pre></td></tr></table></div></figure>


<h4>Create the subvolumes</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@archiso ~ # cd /mnt
</span><span class='line'>root@archiso /mnt # btrfs subvolume create __active
</span><span class='line'>Create subvolume './__active'
</span><span class='line'>root@archiso /mnt # btrfs subvolume create __active/rootvol
</span><span class='line'>Create subvolume '__active/rootvol'
</span><span class='line'>root@archiso /mnt # btrfs subvolume create __active/home
</span><span class='line'>Create subvolume '__active/home'
</span><span class='line'>root@archiso /mnt # btrfs subvolume create __active/var
</span><span class='line'>Create subvolume '__active/var'
</span><span class='line'>root@archiso /mnt # btrfs subvolume create __snapshots
</span><span class='line'>Create subvolume './__snapshots'
</span><span class='line'>root@archiso /mnt #</span></code></pre></td></tr></table></div></figure>


<h4>Mount the subvolumes</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@archiso /mnt # cd 
</span><span class='line'>root@archiso ~ # umount /mnt
</span><span class='line'>root@archiso ~ # mount -o noatime,compress=lzo,discard,ssd,defaults,subvol=__active/rootvol /dev/mapper/cryptroot /mnt
</span><span class='line'>root@archiso ~ # mkdir /mnt/{home,var}
</span><span class='line'>root@archiso ~ # mount -o noatime,compress=lzo,discard,ssd,defaults,subvol=__active/home /dev/mapper/cryptroot /mnt/home
</span><span class='line'>root@archiso ~ # mount -o noatime,compress=lzo,discard,ssd,defaults,subvol=__active/var /dev/mapper/cryptroot /mnt/var
</span><span class='line'>root@archiso ~ # sync
</span><span class='line'>root@archiso ~ # </span></code></pre></td></tr></table></div></figure>


<h2>System installation</h2>

<h3>bootstrap the system</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@archiso ~ # pacstrap /mnt base base-devel btrfs-progs
</span><span class='line'>==&gt; Creating install root at /mnt
</span><span class='line'>==&gt; Installing packages to /mnt
</span><span class='line'>:: Synchronizing package databases...
</span><span class='line'> core                     119.9 KiB   652K/s 00:00 [######################] 100%
</span><span class='line'> extra                   1760.1 KiB   688K/s 00:03 [######################] 100%
</span><span class='line'> community                  3.6 MiB   906K/s 00:04 [######################] 100%
</span><span class='line'>:: There are 50 members in group base:
</span><span class='line'>:: Repository core
</span><span class='line'>   1) bash  2) bzip2  3) coreutils  4) cryptsetup  5) device-mapper  6) dhcpcd
</span><span class='line'>   7) diffutils  8) e2fsprogs  9) file  10) filesystem  11) findutils  12) gawk
</span><span class='line'>   13) gcc-libs  14) gettext  15) glibc  16) grep  17) gzip  18) inetutils
</span><span class='line'>   19) iproute2  20) iputils  21) jfsutils  22) less  23) licenses  24) linux
</span><span class='line'>   25) logrotate  26) lvm2  27) man-db  28) man-pages  29) mdadm  30) nano
</span><span class='line'>   31) netctl  32) pacman  33) pciutils  34) pcmciautils  35) perl
</span><span class='line'>   36) procps-ng  37) psmisc  38) reiserfsprogs  39) s-nail  40) sed
</span><span class='line'>   41) shadow  42) sysfsutils  43) systemd-sysvcompat  44) tar  45) texinfo
</span><span class='line'>   46) usbutils  47) util-linux  48) vi  49) which  50) xfsprogs
</span><span class='line'>
</span><span class='line'>Enter a selection (default=all): 
</span><span class='line'>:: There are 25 members in group base-devel:
</span><span class='line'>:: Repository core
</span><span class='line'>   1) autoconf  2) automake  3) binutils  4) bison  5) fakeroot  6) file
</span><span class='line'>   7) findutils  8) flex  9) gawk  10) gcc  11) gettext  12) grep  13) groff
</span><span class='line'>   14) gzip  15) libtool  16) m4  17) make  18) pacman  19) patch
</span><span class='line'>   20) pkg-config  21) sed  22) sudo  23) texinfo  24) util-linux  25) which
</span><span class='line'>
</span><span class='line'>Enter a selection (default=all): 
</span><span class='line'>warning: skipping target: file
</span><span class='line'>warning: skipping target: findutils
</span><span class='line'>warning: skipping target: gawk
</span><span class='line'>warning: skipping target: gettext
</span><span class='line'>warning: skipping target: grep
</span><span class='line'>warning: skipping target: gzip
</span><span class='line'>warning: skipping target: pacman
</span><span class='line'>warning: skipping target: sed
</span><span class='line'>warning: skipping target: texinfo
</span><span class='line'>warning: skipping target: util-linux
</span><span class='line'>warning: skipping target: which
</span><span class='line'>resolving dependencies...
</span><span class='line'>looking for conflicting packages...
</span><span class='line'>
</span><span class='line'>Packages (144) acl-2.2.52-2  archlinux-keyring-20160812-1  attr-2.4.47-1
</span><span class='line'>               ca-certificates-20160507-1  ca-certificates-cacert-20140824-3
</span><span class='line'>               ca-certificates-mozilla-3.26-1  ca-certificates-utils-20160507-1
</span><span class='line'>               cracklib-2.9.6-1  curl-7.50.1-1  db-5.3.28-3  dbus-1.10.8-1
</span><span class='line'>               expat-2.2.0-2  gc-7.4.2-4  gdbm-1.12-2  glib2-2.48.1-1
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>               procps-ng-3.3.12-1  psmisc-22.21-3  reiserfsprogs-3.6.25-1
</span><span class='line'>               s-nail-14.8.10-1  sed-4.2.2-4  shadow-4.2.1-3  sudo-1.8.17.p1-1
</span><span class='line'>               sysfsutils-2.1.0-9  systemd-sysvcompat-231-1  tar-1.29-1
</span><span class='line'>               texinfo-6.1-4  usbutils-008-1  util-linux-2.28.1-1
</span><span class='line'>               vi-1:070224-2  which-2.21-2  xfsprogs-4.7.0-1
</span><span class='line'>
</span><span class='line'>Total Download Size:   231.85 MiB
</span><span class='line'>Total Installed Size:  801.27 MiB
</span><span class='line'>
</span><span class='line'>:: Proceed with installation? [Y/n] 
</span><span class='line'>:: Retrieving packages...
</span><span class='line'> linux-api-headers-4...   810.7 KiB   891K/s 00:01 [######################] 100%
</span><span class='line'> tzdata-2016f-1-any       215.4 KiB   909K/s 00:00 [######################] 100%
</span><span class='line'> iana-etc-20160513-1-any  352.2 KiB   723K/s 00:00 [######################] 100%
</span><span class='line'> filesystem-2015.09-...     8.8 KiB   875K/s 00:00 [######################] 100%
</span><span class='line'> glibc-2.24-2-x86_64        8.1 MiB   918K/s 00:09 [######################] 100%
</span><span class='line'> gcc-libs-6.1.1-5-x86_64   14.9 MiB   899K/s 00:17 [######################] 100%
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>(144/144) installing btrfs-progs                   [######################] 100%
</span><span class='line'>:: Running post-transaction hooks...
</span><span class='line'>(1/4) Updating manpage index...
</span><span class='line'>mandb: can't set the locale; make sure $LC_* and $LANG are correct
</span><span class='line'>(2/4) Updating the info directory file...
</span><span class='line'>(3/4) Updating udev Hardware Database...
</span><span class='line'>(4/4) Rebuilding certificate stores...
</span><span class='line'>pacstrap /mnt base base-devel btrfs-progs  27.81s user 10.20s system 10% cpu 5:50.56 total
</span><span class='line'>root@archiso ~ # </span></code></pre></td></tr></table></div></figure>


<h3>Generate /etc/fstab</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@archiso ~ # genfstab -p /mnt &gt;&gt; /mnt/etc/fstab
</span><span class='line'>root@archiso ~ # vi /mnt/etc/fstab
</span><span class='line'># 
</span><span class='line'># /etc/fstab: static file system information
</span><span class='line'>#
</span><span class='line'># &lt;file system&gt; &lt;dir&gt;   &lt;type&gt;  &lt;options&gt;       &lt;dump&gt;  &lt;pass&gt;
</span><span class='line'># UUID=c8ca38de-4e58-4c7c-8f5b-c9c3f92f6a24
</span><span class='line'>/dev/mapper/cryptroot   /               btrfs           rw,noatime,compress=lzo,ssd,dis
</span><span class='line'>card,space_cache,subvolid=258,subvol=/__active/rootvol,subvol=__active/rootvol  0 0
</span><span class='line'>
</span><span class='line'># UUID=c8ca38de-4e58-4c7c-8f5b-c9c3f92f6a24
</span><span class='line'>/dev/mapper/cryptroot   /home           btrfs           rw,noatime,compress=lzo,ssd,dis
</span><span class='line'>card,space_cache,subvolid=259,subvol=/__active/home,subvol=__active/home        0 0
</span><span class='line'>
</span><span class='line'># UUID=c8ca38de-4e58-4c7c-8f5b-c9c3f92f6a24
</span><span class='line'>/dev/mapper/cryptroot   /var            btrfs           rw,noatime,compress=lzo,ssd,dis
</span><span class='line'>card,space_cache,subvolid=260,subvol=/__active/var,subvol=__active/var  0 0</span></code></pre></td></tr></table></div></figure>


<h3>chroot</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@archiso ~ # arch-chroot /mnt
</span><span class='line'>[root@archiso /]# </span></code></pre></td></tr></table></div></figure>


<h3>Set the timezone</h3>

<p>Link for timezone to /etc/localtime</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@archiso /]# ln -s /usr/share/zoneinfo/Europe/Brussels /etc/localtime
</span><span class='line'>[root@archiso /]# </span></code></pre></td></tr></table></div></figure>


<p>Set the hardwareclock to UTC</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>hwclock --systohc --utc</span></code></pre></td></tr></table></div></figure>


<h3>Generate the required locales</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@archiso /]# vi /etc/locale.gen 
</span><span class='line'>[root@archiso /]# locale-gen
</span><span class='line'>Generating locales...
</span><span class='line'>  en_IE.UTF-8... done
</span><span class='line'>  en_IE.ISO-8859-1... done
</span><span class='line'>  en_IE.ISO-8859-15@euro... done
</span><span class='line'>  en_US.UTF-8... done
</span><span class='line'>  en_US.ISO-8859-1... done
</span><span class='line'>  nl_BE.UTF-8... done
</span><span class='line'>  nl_BE.ISO-8859-1... done
</span><span class='line'>  nl_BE.ISO-8859-15@euro... done
</span><span class='line'>Generation complete.
</span><span class='line'>[root@archiso /]# </span></code></pre></td></tr></table></div></figure>


<h3>Hostname</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@archiso /]# vi /etc/hostname
</span><span class='line'>[root@archiso /]# 
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@archiso /]# vi /etc/hosts</span></code></pre></td></tr></table></div></figure>


<h3>mkinitcpio</h3>

<h4>HOOKS</h4>

<p>Add encrypt to HOOKS before filesystems in /etc/mkinitcpio.conf</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@archiso /]# vi /etc/mkinitcpio.conf </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>HOOKS="base udev autodetect modconf block encrypt filesystems keyboard fsck"</span></code></pre></td></tr></table></div></figure>


<h4>Create boot image</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@archiso /]# mkinitcpio -p linux
</span><span class='line'>==&gt; Building image from preset: /etc/mkinitcpio.d/linux.preset: 'default'
</span><span class='line'>  -&gt; -k /boot/vmlinuz-linux -c /etc/mkinitcpio.conf -g /boot/initramfs-linux.img
</span><span class='line'>==&gt; Starting build: 4.7.1-1-ARCH
</span><span class='line'>  -&gt; Running build hook: [base]
</span><span class='line'>  -&gt; Running build hook: [udev]
</span><span class='line'>  -&gt; Running build hook: [autodetect]
</span><span class='line'>  -&gt; Running build hook: [modconf]
</span><span class='line'>  -&gt; Running build hook: [block]
</span><span class='line'>  -&gt; Running build hook: [encrypt]
</span><span class='line'>  -&gt; Running build hook: [filesystems]
</span><span class='line'>  -&gt; Running build hook: [keyboard]
</span><span class='line'>  -&gt; Running build hook: [fsck]
</span><span class='line'>==&gt; Generating module dependencies
</span><span class='line'>==&gt; Creating gzip-compressed initcpio image: /boot/initramfs-linux.img
</span><span class='line'>==&gt; Image generation successful
</span><span class='line'>==&gt; Building image from preset: /etc/mkinitcpio.d/linux.preset: 'fallback'
</span><span class='line'>  -&gt; -k /boot/vmlinuz-linux -c /etc/mkinitcpio.conf -g /boot/initramfs-linux-fallback.img -S autodetect
</span><span class='line'>==&gt; Starting build: 4.7.1-1-ARCH
</span><span class='line'>  -&gt; Running build hook: [base]
</span><span class='line'>  -&gt; Running build hook: [udev]
</span><span class='line'>  -&gt; Running build hook: [modconf]
</span><span class='line'>  -&gt; Running build hook: [block]
</span><span class='line'>==&gt; WARNING: Possibly missing firmware for module: wd719x
</span><span class='line'>==&gt; WARNING: Possibly missing firmware for module: aic94xx
</span><span class='line'>  -&gt; Running build hook: [encrypt]
</span><span class='line'>  -&gt; Running build hook: [filesystems]
</span><span class='line'>  -&gt; Running build hook: [keyboard]
</span><span class='line'>  -&gt; Running build hook: [fsck]
</span><span class='line'>==&gt; Generating module dependencies
</span><span class='line'>==&gt; Creating gzip-compressed initcpio image: /boot/initramfs-linux-fallback.img
</span><span class='line'>==&gt; Image generation successful
</span><span class='line'>[root@archiso /]#</span></code></pre></td></tr></table></div></figure>


<h3>set the root password</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@archiso /]# passwd root
</span><span class='line'>New password: 
</span><span class='line'>Retype new password: 
</span><span class='line'>passwd: password updated successfully
</span><span class='line'>[root@archiso /]# </span></code></pre></td></tr></table></div></figure>


<h3>GRUB</h3>

<h4>install Grub</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@archiso /]# pacman -Sy grub
</span><span class='line'>:: Synchronizing package databases...
</span><span class='line'> core is up to date
</span><span class='line'> extra                   1760.1 KiB   917K/s 00:02 [######################] 100%
</span><span class='line'> community                  3.6 MiB   896K/s 00:04 [######################] 100%
</span><span class='line'>resolving dependencies...
</span><span class='line'>looking for conflicting packages...
</span><span class='line'>
</span><span class='line'>Packages (1) grub-1:2.02.beta3-3
</span><span class='line'>
</span><span class='line'>Total Download Size:    5.83 MiB
</span><span class='line'>Total Installed Size:  28.70 MiB
</span><span class='line'>
</span><span class='line'>:: Proceed with installation? [Y/n] y
</span><span class='line'>:: Retrieving packages...
</span><span class='line'> grub-1:2.02.beta3-3...     5.8 MiB   917K/s 00:07 [######################] 100%
</span><span class='line'>(1/1) checking keys in keyring                     [######################] 100%
</span><span class='line'>(1/1) checking package integrity                   [######################] 100%
</span><span class='line'>(1/1) loading package files                        [######################] 100%
</span><span class='line'>(1/1) checking for file conflicts                  [######################] 100%
</span><span class='line'>(1/1) checking available disk space                [######################] 100%
</span><span class='line'>:: Processing package changes...
</span><span class='line'>(1/1) installing grub                              [######################] 100%
</span><span class='line'>Generating grub.cfg.example config file...
</span><span class='line'>This may fail on some machines running a custom kernel.
</span><span class='line'>done.
</span><span class='line'>Optional dependencies for grub
</span><span class='line'>    freetype2: For grub-mkfont usage
</span><span class='line'>    fuse: For grub-mount usage
</span><span class='line'>    dosfstools: For grub-mkrescue FAT FS and EFI support
</span><span class='line'>    efibootmgr: For grub-install EFI support
</span><span class='line'>    libisoburn: Provides xorriso for generating grub rescue iso using
</span><span class='line'>    grub-mkrescue
</span><span class='line'>    os-prober: To detect other OSes when generating grub.cfg in BIOS systems
</span><span class='line'>    mtools: For grub-mkrescue FAT FS support
</span><span class='line'>:: Running post-transaction hooks...
</span><span class='line'>(1/2) Updating manpage index...
</span><span class='line'>(2/2) Updating the info directory file...
</span><span class='line'>[root@archiso /]# </span></code></pre></td></tr></table></div></figure>


<h4>Install grub to your boot disk</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@archiso /]# grub-install --target=i386-pc /dev/sda
</span><span class='line'>Installing for i386-pc platform.
</span><span class='line'>grub-install: error: attempt to install to encrypted disk without cryptodisk enabled. Set `GRUB_ENABLE_CRYPTODISK=y' in file `/etc/default/grub'.
</span><span class='line'>[root@archiso /]# 
</span></code></pre></td></tr></table></div></figure>


<h4>Enable cryptodisk</h4>

<p>Because we use an encrypted boot disk we need to enable cryptdisk support.</p>

<p>Add  GRUB_ENABLE_CRYPTODISK=y to /etc/default/grub</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@archiso /]# vi /etc/default/grub
</span><span class='line'>[root@archiso /]# 
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>GRUB_DEFAULT=0
</span><span class='line'>GRUB_TIMEOUT=5
</span><span class='line'>GRUB_DISTRIBUTOR="Arch"
</span><span class='line'>GRUB_CMDLINE_LINUX_DEFAULT="quiet"
</span><span class='line'>GRUB_CMDLINE_LINUX=""
</span><span class='line'>GRUB_ENABLE_CRYPTODISK=y</span></code></pre></td></tr></table></div></figure>


<p>And run grub-install again</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@archiso /]# grub-install --target=i386-pc /dev/sda
</span><span class='line'>Installing for i386-pc platform.
</span><span class='line'>Installation finished. No error reported.
</span><span class='line'>[root@archiso /]# </span></code></pre></td></tr></table></div></figure>


<h4>Create grub.cfg</h4>

<p>Add your encrypted root partition to GRUB_CMDLINE_LINUX= in /etc/default/grub</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>GRUB_DEFAULT=0
</span><span class='line'>GRUB_TIMEOUT=5
</span><span class='line'>GRUB_DISTRIBUTOR="Arch"
</span><span class='line'>GRUB_CMDLINE_LINUX_DEFAULT="quiet"
</span><span class='line'>GRUB_CMDLINE_LINUX=""cryptdevice=/dev/sda3:cryptroot""
</span><span class='line'>ENABLE_CRYPTODISK=y 
</span></code></pre></td></tr></table></div></figure>


<p>And generate grub.cfg</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@archiso /]# grub-mkconfig -o /boot/grub/grub.cfg
</span><span class='line'>Generating grub configuration file ...
</span><span class='line'>Found linux image: /boot/vmlinuz-linux
</span><span class='line'>Found initrd image(s) in /boot: initramfs-linux.img
</span><span class='line'>Found fallback initrd image(s) in /boot: initramfs-linux-fallback.img
</span><span class='line'>done
</span><span class='line'>[root@archiso /]# 
</span></code></pre></td></tr></table></div></figure>


<h2>Reboot</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@archiso /]# vi /boot/grub/grub.cfg
</span><span class='line'>[root@archiso /]# sync
</span><span class='line'>[root@archiso /]# reboot
</span><span class='line'>Running in chroot, ignoring request.
</span><span class='line'>[root@archiso /]# exit
</span><span class='line'>arch-chroot /mnt  9.76s user 1.37s system 0% cpu 23:13.29 total
</span><span class='line'>root@archiso ~ # reboot</span></code></pre></td></tr></table></div></figure>


<h2>Finish the installation</h2>

<h3>1st boot</h3>

<p>As mentioned before the GRUB will as for a passphrase to decrypt the boot partition.</p>

<p><img class="center" src="https://stafwag.github.io/blog/images/arch-on-an-encrypted-btrfs-partition/01_1st_boot.png" width="700" height="274" title="&#34;01_1st_boot.png&#34;" alt="&#34;01_1st_boot.png&#34;">
<img class="center" src="https://stafwag.github.io/blog/images/arch-on-an-encrypted-btrfs-partition/02_1st_grub_menu.png" width="700" height="484" title="&#34;01_1st_boot.png&#34;" alt="&#34;01_1st_boot.png&#34;"></p>

<p>You&rsquo;ll need to type it the password a secod time during the loading of initrd.</p>

<p><img class="center" src="https://stafwag.github.io/blog/images/arch-on-an-encrypted-btrfs-partition/02_1st_decrypt_root.png" width="700" height="165" title="&#34;01_1st_boot.png&#34;" alt="&#34;01_1st_boot.png&#34;"></p>

<h3>Setup swap space</h3>

<p>Update /etc/crypttab</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>swap         /dev/sda2                                    /dev/urandom            swap,
</span><span class='line'>cipher=aes-cbc-essiv:sha256,size=256</span></code></pre></td></tr></table></div></figure>


<p>reboot the system to verify that the encrypted swap partition is mapper correctly during the system startup</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# ls -l /dev/mapper/
</span><span class='line'>total 0
</span><span class='line'>crw------- 1 root root 10, 236 Aug 29 15:43 control
</span><span class='line'>lrwxrwxrwx 1 root root       7 Aug 29 15:43 cryptroot -&gt; ../dm-0
</span><span class='line'>lrwxrwxrwx 1 root root       7 Aug 29 15:43 swap -&gt; ../dm-1
</span><span class='line'>[root@vicky ~]# </span></code></pre></td></tr></table></div></figure>


<p>Create swap</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# mkswap /dev/mapper/swap 
</span><span class='line'>Setting up swapspace version 1, size = 32 GiB (34359734272 bytes)
</span><span class='line'>no label, UUID=66ea5a08-0833-4e84-8b95-f1a9c2d772b2
</span><span class='line'>[root@vicky ~]# </span></code></pre></td></tr></table></div></figure>


<p>Activate swap</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# swapon /dev/mapper/swap
</span><span class='line'>[root@vicky ~]# free
</span><span class='line'>              total        used        free      shared  buff/cache   available
</span><span class='line'>Mem:        4051236       85932     3890708         440       74596     3807084
</span><span class='line'>Swap:      33554428           0    33554428
</span><span class='line'>[root@vicky ~]# </span></code></pre></td></tr></table></div></figure>


<p>Update /etc/fstab</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/dev/mapper/swap swap                    swap    defaults,discard,pri=3        0 0 </span></code></pre></td></tr></table></div></figure>




<p style="font-style: italic;">
Have fun
</p>


<h2>Links</h2>

<ul>
<li><a href="https://wiki.archlinux.org/index.php/Installation_guide"><a href="https://wiki.archlinux.org/index.php/Installation_guide">https://wiki.archlinux.org/index.php/Installation_guide</a></a></li>
<li><a href="http://www.brunoparmentier.be/blog/how-to-install-arch-linux-on-an-encrypted-btrfs-partition.html"><a href="http://www.brunoparmentier.be/blog/how-to-install-arch-linux-on-an-encrypted-btrfs-partition.html">http://www.brunoparmentier.be/blog/how-to-install-arch-linux-on-an-encrypted-btrfs-partition.html</a></a></li>
<li><a href="http://blog.fabio.mancinelli.me/2012/12/28/Arch_Linux_on_BTRFS.html"><a href="http://blog.fabio.mancinelli.me/2012/12/28/Arch_Linux_on_BTRFS.html">http://blog.fabio.mancinelli.me/2012/12/28/Arch_Linux_on_BTRFS.html</a></a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[CGIpaf 1.3.5 Released]]></title>
    <link href="https://stafwag.github.io/blog/blog/2016/04/13/cgipaf-1-dot-3-5-released/"/>
    <updated>2016-04-13T11:00:13+02:00</updated>
    <id>https://stafwag.github.io/blog/blog/2016/04/13/cgipaf-1-dot-3-5-released</id>
    <content type="html"><![CDATA[<p>CGIpaf 1.3.5 has been released</p>

<h3>ChangeLog</h3>

<h5>version 1.3.5         ( 13 Apr 2016 )</h5>

<blockquote><ul>
<li>pwd_mkdb errors were not handled correctly on BSD</li>
<li>kyua test scripts added</li>
</ul>
</blockquote>

<p>CGIpaf 1.3.5 is  available at: <a href="http://www.wagemakers.be/english/programs/cgipaf"><a href="http://www.wagemakers.be/english/programs/cgipaf">http://www.wagemakers.be/english/programs/cgipaf</a></a></p>

<p>Download the tarball directly at:  <a href="http://www.wagemakers.be/downloads/cgipaf/"><a href="http://www.wagemakers.be/downloads/cgipaf/">http://www.wagemakers.be/downloads/cgipaf/</a></a></p>

<p>Or at the the Git repository  on github: <a href="https://github.com/stafwag/cgipaf"><a href="https://github.com/stafwag/cgipaf">https://github.com/stafwag/cgipaf</a></a></p>

<p style="font-style: italic;">
Have fun...
</p>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Thunderbird: Importing S/mime Certificate Failed]]></title>
    <link href="https://stafwag.github.io/blog/blog/2016/01/17/thunderbird-importing-s-slash-mime-certificate-failed/"/>
    <updated>2016-01-17T09:03:53+01:00</updated>
    <id>https://stafwag.github.io/blog/blog/2016/01/17/thunderbird-importing-s-slash-mime-certificate-failed</id>
    <content type="html"><![CDATA[<p><img class="left" src="https://stafwag.github.io/blog/images/thunderbird_import_smime_failed.png" width="1000" height="835" title="&#34;thunderbird smime failed&#34;" alt="&#34;thunderbird smime failed&#34;"></p>

<p>On <a href="http://kb.mozillazine.org/Getting_an_SMIME_certificate"><a href="http://kb.mozillazine.org/Getting_an_SMIME_certificate">http://kb.mozillazine.org/Getting_an_SMIME_certificate</a></a>
you get a list of free <a href="https://en.wikipedia.org/wiki/S/MIME">s/mime</a> certificate.</p>

<p>I ordered a free 30 days certificate at <a href="globalsign">globalsign</a>: <a href="https://www.globalsign.com/en/personalsign/trial/"><a href="https://www.globalsign.com/en/personalsign/trial/">https://www.globalsign.com/en/personalsign/trial/</a></a></p>

<p>The import of the <a href="https://en.wikipedia.org/wiki/PKCS_12">pkcs12</a> failed in Thunderbird with the message: &ldquo;The PKCS #12 operation failed for unknown reasons.&rdquo;</p>

<p>Searching the internet didn&rsquo;t provide a solution. To debug this issue I started to extract the private / certificate from the pkcs12 file provided by globalsign and creating a new one.</p>

<p>To execute this command I use an encrypted <a href="https://gitlab.com/cryptsetup/cryptsetup/blob/master/README.md">luks</a> volume.</p>

<h1>Create a new pkcs12 file</h1>

<h2>verifying the pkx file</h2>

<h3>password too long?</h3>

<p>The first issue was that the password of my pkx was too long by default the openssl pkcs12 command seems to have a limit of 32 characters.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky staf@wagemakers.be]$ openssl pkcs12 -in staf.pkx 
</span><span class='line'>Enter Import Password:
</span><span class='line'>Can't read Password
</span><span class='line'>[staf@vicky staf@wagemakers.be]$ </span></code></pre></td></tr></table></div></figure>


<p>Use the &ldquo;-passin pass&rdquo;, &ldquo;-passin stdin&rdquo; or &ldquo;-passin file&rdquo; argument resolves this issue. The &ldquo;-passin pass&rdquo; argument will show the password on the screen and in shell history, the &ldquo;-passin stdin&rdquo; will show your password on the screen, the &ldquo;-passin file&rdquo; will leave your password on the (hopefully encrypted) filesystem  so I went with the &ldquo;-pass file&rdquo; option.</p>

<h3>Created password file</h3>

<p>Create the file that holds your password with the corrected file permissions, you must be the only one that is able to read this file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky staf@wagemakers.be]$ touch pass
</span><span class='line'>[staf@vicky staf@wagemakers.be]$ chmod 600 pass
</span><span class='line'>[staf@vicky staf@wagemakers.be]$ vi pass</span></code></pre></td></tr></table></div></figure>


<h3>Try again</h3>

<p>With the &ldquo;-passin file&rdquo; argument we are able to the pkcs12 file.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky staf@wagemakers.be]$ openssl pkcs12 -in staf.pkx -passin file:pass
</span><span class='line'>MAC verified OK
</span><span class='line'>Bag Attributes
</span><span class='line'>    localKeyID: 9B B7 F3 7A 96 46 1F 08 28 A2 BC 2B 87 0E 53 92 29 B4 7D 7D 
</span><span class='line'>Key Attributes: &lt;No Attributes&gt;
</span><span class='line'>Enter PEM pass phrase:
</span><span class='line'>Bag Attributes
</span><span class='line'>    localKeyID: 9B B7 F3 7A 96 46 1F 08 28 A2 BC 2B 87 0E 53 92 29 B4 7D 7D 
</span><span class='line'>subject=/CN=staf@wagemakers.be/emailAddress=staf@wagemakers.be
</span><span class='line'>issuer=/C=BE/O=GlobalSign nv-sa/CN=GlobalSign PersonalSign 1 CA - SHA256 - G2
</span><span class='line'>-----BEGIN CERTIFICATE-----
</span><span class='line'>&lt;snip&gt;</span></code></pre></td></tr></table></div></figure>


<h2>Extract</h2>

<p>We&rsquo;ll extract the private key and the certificates and build a new pkcs12 file and import this pkcs12 file into thunderbird.</p>

<h3>Extract the private key</h3>

<p>The private key is encrypted with the &ldquo;bag&rdquo; so need to type it or copy/pass it&hellip;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky staf@wagemakers.be]$ openssl pkcs12 -in staf.pkx -nocerts -out key.pem -passin file:pass 
</span><span class='line'>MAC verified OK
</span><span class='line'>Enter PEM pass phrase:
</span><span class='line'>Verifying - Enter PEM pass phrase:</span></code></pre></td></tr></table></div></figure>


<h3>Extract the client certificate</h3>

<p>The client certificate isn&rsquo;t encrypted so you can leave the pem password empty.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky staf@wagemakers.be]$ openssl pkcs12 -in staf.pkx -clcerts -out staf.pem -passin file:pass 
</span><span class='line'>MAC verified OK
</span><span class='line'>
</span><span class='line'>Enter PEM pass phrase:
</span><span class='line'>[staf@vicky staf@wagemakers.be]$ </span></code></pre></td></tr></table></div></figure>


<h3>Verify the key and certificate</h3>

<p>To verify that the certificate and the private belongs together we need to verify the modulus of the key and the certificate the sha1sum should match.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@vicky staf@wagemakers.be]$ openssl rsa -in key.pem -modulus -noout | sha1sum
</span><span class='line'>Enter pass phrase for key.pem:
</span><span class='line'>1234567890123456789012345678901234567890  -
</span><span class='line'>[staf@vicky staf@wagemakers.be]$ </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky staf@wagemakers.be]$ openssl x509 -in staf.pem -modulus -noout | sha1sum
</span><span class='line'>1234567890123456789012345678901234567890  -
</span><span class='line'>[staf@vicky staf@wagemakers.be]$ </span></code></pre></td></tr></table></div></figure>


<h3>Extract the signing certificate(s)</h3>

<p>The following command extracts the ca certificates.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky staf@wagemakers.be]$ openssl pkcs12 -in staf.pkx -cacerts -out cacerts.pem -passin file:pass
</span><span class='line'>MAC verified OK
</span><span class='line'>Enter PEM pass phrase:</span></code></pre></td></tr></table></div></figure>


<h2>Create a new pkcs12 file</h2>

<p>This time we use a 32 characters password.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky staf@wagemakers.be]$ openssl pkcs12 -export -in staf.pem -inkey key.pem -certfile cacerts.pem -out staf_new.p12
</span><span class='line'>Enter pass phrase for key.pem:
</span><span class='line'>Enter Export Password:
</span><span class='line'>Verifying - Enter Export Password:</span></code></pre></td></tr></table></div></figure>


<h1>Import the the new pkcs12 file</h1>

<p><img class="right" src="https://stafwag.github.io/blog/images/thunderbird_import_smime_ok.png" width="598" height="152" title="&#34;thunderbird smime import ok&#34;" alt="&#34;thunderbird smime import ok&#34;">
Not sure what the issue was with original pkcs12 but the import works now&hellip;.
 - it might have been the 32 characters password -.   After I was able to use the signing and encryption part in thunderbird.</p>

<p><strong><em> Have fun </em></strong></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Happy New Year 2016]]></title>
    <link href="https://stafwag.github.io/blog/blog/2016/01/01/happy-new-year-2016/"/>
    <updated>2016-01-01T10:24:48+01:00</updated>
    <id>https://stafwag.github.io/blog/blog/2016/01/01/happy-new-year-2016</id>
    <content type="html"><![CDATA[<p><strong><em> Happy new year! </em></strong></p>

<p><img class="center" src="https://stafwag.github.io/blog/images/2016.jpg" width="1000" height="625" title="&#34;2016.jpg&#34;" alt="&#34;2016.jpg&#34;"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Lookat 1.4.4 Released]]></title>
    <link href="https://stafwag.github.io/blog/blog/2015/12/28/lookat-1-dot-4-4-released/"/>
    <updated>2015-12-28T15:48:50+01:00</updated>
    <id>https://stafwag.github.io/blog/blog/2015/12/28/lookat-1-dot-4-4-released</id>
    <content type="html"><![CDATA[<p> Lookat 1.4.4 is the latest stable release of Lookat/Bekijk the userfriendly file browser/viewer.</p>

<h3>ChangeLog</h3>

<ul>
<li>NetBSD support</li>
<li>OpenBSD support</li>
<li>English translation issues corrected</li>
<li>autoconf updated to 2.69</li>
<li>Corrected minor compile warnings</li>
</ul>


<h3>Lookat 1.4.4 is available at:</h3>

<p><a href="http://www.wagemakers.be/english/programs/lookat"><a href="http://www.wagemakers.be/english/programs/lookat">http://www.wagemakers.be/english/programs/lookat</a></a>
, download it directly <a href="http://www.wagemakers.be/downloads/lookat/lookat_bekijk-1.4.4.tar.gz">Download latest stable release (1.4.4)</a>.</p>

<p>Or at the Git repository at GNU savannah <a href="http://git.savannah.gnu.org/cgit/lookat.git/"><a href="http://git.savannah.gnu.org/cgit/lookat.git/">http://git.savannah.gnu.org/cgit/lookat.git/</a></a></p>

<p><strong><em> Have fun </em></strong></p>
]]></content>
  </entry>
  
</feed>
