<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[stafwag Blog]]></title>
  <link href="http://stafwag.github.io/blog/atom.xml" rel="self"/>
  <link href="http://stafwag.github.io/blog/"/>
  <updated>2017-10-01T09:32:04+02:00</updated>
  <id>http://stafwag.github.io/blog/</id>
  <author>
    <name><![CDATA[staf wagemakers]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Jenkins Build With 20 Cores]]></title>
    <link href="http://stafwag.github.io/blog/blog/2017/09/30/jenkins-build-with-20-cores/"/>
    <updated>2017-09-30T19:18:14+02:00</updated>
    <id>http://stafwag.github.io/blog/blog/2017/09/30/jenkins-build-with-20-cores</id>
    <content type="html"><![CDATA[<p>I finally got the time to try out my jenkins build on my new <a href="http://stafwag.github.io/blog/blog/2017/09/16/20-core-dual-processor-jenkins-build-workstation/">20 Core Dual Processor Jenkins Build Workstation</a></p>

<div class="embed-video-container"><iframe src="http://www.youtube.com/embed/BNn9absXkE8 "></iframe></div>


<p>I&rsquo;m able to run all test on multiple operation systems now. I still need to review this setup and perhaps move some tests to <a href="https://www.docker.io">docker</a> instead of the virtual machines to save some memory. &hellip;but this jenkins setup was configured before docker was a thing.</p>

<p><strong><em>Have fun</em></strong></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[20 Core Dual Processor Jenkins Build Workstation]]></title>
    <link href="http://stafwag.github.io/blog/blog/2017/09/16/20-core-dual-processor-jenkins-build-workstation/"/>
    <updated>2017-09-16T14:29:51+02:00</updated>
    <id>http://stafwag.github.io/blog/blog/2017/09/16/20-core-dual-processor-jenkins-build-workstation</id>
    <content type="html"><![CDATA[<p><img class="left" src="http://stafwag.github.io/blog/images/201709_xeon_cpu_side.jpg" width="400" height="388" title="&#34;Xeon CPU Side&#34;" alt="&#34;Xeon CPU Side&#34;"></p>

<p><br /></p>

<p>My jenkins builds are taking too long mainly due the lack of memory. I mainly use jenkins to verify that my software work on different operation systems (GNU/Linux distributions / *BSD / Solaris).</p>

<p>Looking for a solution that is still affordable I ended up with building a dual Xeon workstation. CPU and memory comes from <a href="http://www.ebay.be">www.ebay.be</a></p>

<p><br />&nbsp;<br />
<br /></p>

<h3>Part list:</h3>

<ul>
<li><strong>CPU:</strong> 2 * <a href="http://ark.intel.com/products/75272/Intel-Xeon-Processor-E5-2660-v2-25M-Cache-2_20-GHz">Intel Xeon E5-2660v2</a> This CPU has 10 cores and 20 thread, so I get 40 threads.</li>
<li><strong>Motherboard:</strong> <a href="http://www.asrockrack.com/general/productdetail.asp?Model=EP2C602-4L/D16#Specifications">Asrock EP2C602-4L/D16</a> I choose this motherboard because it has a lot of DIMM slots so I can upgrade the memory in the further. Downside is that layout is SSI EEB that limits the case choose.</li>
<li><strong>Memory:</strong> 4 * SAMSUNG M393B2G70BH0-CK0 16GB which gives me 64 GB <a href="https://en.wikipedia.org/wiki/ECC_memory">ECC memory</a></li>
<li><strong>CPU Cooler</strong> 2 * <a href="http://www.thermaltake.com/products-model.aspx?id=C_00002470">Thermaltake Water 3.0 Performer C</a> For the first I used watercooling mainly because I wanted to make sure that the cooling will not block the access to the DIMM slots.</li>
<li><strong>PSU:</strong> <a href="https://seasonic.com/product/focus-plus-750-gold/">Seasonic FOCUS Plus 750 Gold</a> I needed a power supply with 2 * 8 pins CPU connectors.</li>
<li><strong>Case:</strong> <a href="http://www.phanteks.com/Enthoo-Pro.html">Phanteks Enthoo Pro</a> This case supports SSI EEB and is not too expensive.</li>
</ul>


<h3>Pictures</h3>

<p><a href="http://stafwag.github.io/blog/images/201709_xeon_cpu_side.jpg"><img src="http://stafwag.github.io/blog/images/201709_xeon_cpu_side.jpg" height="291" width="300" alt="Xeon CPU side" /></a>
<a href="http://stafwag.github.io/blog/images/201709_xeon_hd_side.jpg"><img src="http://stafwag.github.io/blog/images/201709_xeon_hd_side.jpg" height="291" width="317" alt="Xeon CPU side" /></a>
<a href="http://stafwag.github.io/blog/images/201709_xeon_front_side.jpg"><img src="http://stafwag.github.io/blog/images/201709_xeon_front_side.jpg" height="291" width="151" alt="Xeon CPU side" /></a></p>

<p><strong><em>Still need to verify if jenkins works on this system :-) </em></strong></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Bacula on FreeBSD (Part 2 Bacula Catalog Over SSL )]]></title>
    <link href="http://stafwag.github.io/blog/blog/2017/09/09/bacula-on-freebsd-part2/"/>
    <updated>2017-09-09T10:27:03+02:00</updated>
    <id>http://stafwag.github.io/blog/blog/2017/09/09/bacula-on-freebsd-part2</id>
    <content type="html"><![CDATA[<p><img class="right" src="http://stafwag.github.io/blog/images/postgressl.png" width="300" height="300" title="&#34;PostgreSSL&#34;" alt="&#34;PostgreSSL&#34;"></p>

<p>In my previous <a href="http://stafwag.github.io/blog/blog/2017/08/06/bacula-on-freebsd:w_part1/">post</a>, I setup on my <a href="https://www.postgresql.org/">PostgresSQL</a> <a href="https://en.wikipedia.org/wiki/FreeBSD_jail">FreeBSD jail</a>, In this post we continue with the bacaula server.</p>

<p>In this post we will continue with the database connection (Catalog) we&rsquo;ll go the extra <del>mile</del> 1,609344 km and encrypt the catalog connection with ssl. Why? <strong><em>We encrypt.. because we can!</em></strong></p>

<h1>Bacula Components</h1>

<ul>
<li><p><strong>Bacula Director</strong> <br />
The Bacula Director is daemon that runs in the backgroud that control all backup operations.</p></li>
<li><p><strong>Bacula Console</strong> <br />
The Bacula console is an administrator program that allows an system administrator to control the Bacula director.</p></li>
<li><p><strong>Bacula File</strong> <br />
The Bacula File is a backup client install on the backup client.</p></li>
<li><p><strong>Bacula Storage</strong> <br />
The backup media.</p></li>
<li><p><strong>Catalog</strong> <br />
The Catalog is the index of the backups. Bacula supports three types of index databases mySQL ( <a href="https://mariadb.org/">mariaDB</a>), <a href="https://www.postgresql.org/">PostgreSQL</a> and <a href="https://sqlite.org/">SQLite</a></p></li>
<li><p><strong>Bacula monitor</strong> <br />
A Bacula monitor service is a program that allows the system administrator to cerify the status of the bacula Directors, Bacula File Daemons and Bacula Storage Daemons.</p></li>
</ul>


<h1>Bacula Server</h1>

<h2>Jail</h2>

<h3>Create the Bacula Server Jail</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # ezjail-admin create stafbacula "em0|192.168.1.52"
</span><span class='line'>Warning: Some services already seem to be listening on all IP, (including 192.168.1.52)
</span><span class='line'>  This may cause some confusion, here they are:
</span><span class='line'>root     ntpd       754   20 udp6   *:123                 *:*
</span><span class='line'>root     ntpd       754   21 udp4   *:123                 *:*
</span><span class='line'>root     rpc.statd  717   4  udp6   *:846                 *:*
</span><span class='line'>root     rpc.statd  717   5  tcp6   *:846                 *:*
</span><span class='line'>root     rpc.statd  717   6  udp4   *:846                 *:*
</span><span class='line'>root     rpc.statd  717   7  tcp4   *:846                 *:*
</span><span class='line'>root     nfsd       713   5  tcp4   *:2049                *:*
</span><span class='line'>root     nfsd       713   6  tcp6   *:2049                *:*
</span><span class='line'>root     mountd     707   5  udp6   *:823                 *:*
</span><span class='line'>root     mountd     707   6  tcp6   *:823                 *:*
</span><span class='line'>root     mountd     707   7  udp4   *:823                 *:*
</span><span class='line'>root     mountd     707   8  tcp4   *:823                 *:*
</span><span class='line'>root     rpcbind    676   6  udp6   *:111                 *:*
</span><span class='line'>root     rpcbind    676   7  udp6   *:779                 *:*
</span><span class='line'>root     rpcbind    676   8  tcp6   *:111                 *:*
</span><span class='line'>root     rpcbind    676   9  udp4   *:111                 *:*
</span><span class='line'>root     rpcbind    676   10 udp4   *:768                 *:*
</span><span class='line'>root     rpcbind    676   11 tcp4   *:111                 *:*
</span><span class='line'>root     syslogd    656   6  udp6   *:514                 *:*
</span><span class='line'>root     syslogd    656   7  udp4   *:514                 *:*
</span><span class='line'>root@rataplan:~ # </span></code></pre></td></tr></table></div></figure>


<h3>Start the jail</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # ezjail-admin start stafbacula
</span><span class='line'>Starting jails: stafbacula.
</span><span class='line'>/etc/rc.d/jail: WARNING: Per-jail configuration via jail_* variables  is obsolete.  Please consider migrating to /etc/jail.conf.
</span><span class='line'>root@rataplan:~ # </span></code></pre></td></tr></table></div></figure>


<h3>Open the console</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # ezjail-admin console stafbacula
</span><span class='line'>FreeBSD 11.1-RELEASE-p1 (GENERIC) #0: Wed Sep  9 11:55:48 UTC 2017
</span><span class='line'>
</span><span class='line'>Welcome to FreeBSD!
</span><span class='line'>
</span><span class='line'>Release Notes, Errata: https://www.FreeBSD.org/releases/
</span><span class='line'>Security Advisories:   https://www.FreeBSD.org/security/
</span><span class='line'>FreeBSD Handbook:      https://www.FreeBSD.org/handbook/
</span><span class='line'>FreeBSD FAQ:           https://www.FreeBSD.org/faq/
</span><span class='line'>Questions List: https://lists.FreeBSD.org/mailman/listinfo/freebsd-questions/
</span><span class='line'>FreeBSD Forums:        https://forums.FreeBSD.org/
</span><span class='line'>
</span><span class='line'>Documents installed with the system are in the /usr/local/share/doc/freebsd/
</span><span class='line'>directory, or can be installed later with:  pkg install en-freebsd-doc
</span><span class='line'>For other languages, replace "en" with a language code like de or fr.
</span><span class='line'>
</span><span class='line'>Show the version of FreeBSD installed:  freebsd-version ; uname -a
</span><span class='line'>Please include that output and any error messages when posting questions.
</span><span class='line'>Introduction to manual pages:  man man
</span><span class='line'>FreeBSD directory layout:      man hier
</span><span class='line'>
</span><span class='line'>Edit /etc/motd to change this login announcement.
</span><span class='line'>root@stafbacula:~ # </span></code></pre></td></tr></table></div></figure>


<h2>Bacula installation</h2>

<h3>Install pkg</h3>

<p>Set up dns</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafbacula:~ # vi /etc/resolv.conf</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>nameserver 192.168.1.1</span></code></pre></td></tr></table></div></figure>


<p>Bootstrap pkg</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafbacula:~ # pkg
</span><span class='line'>The package management tool is not yet installed on your system.
</span><span class='line'>Do you want to fetch and install it now? [y/N]: y
</span><span class='line'>Bootstrapping pkg from pkg+http://pkg.FreeBSD.org/FreeBSD:11:amd64/quarterly, please wait...
</span><span class='line'>Verifying signature with trusted certificate pkg.freebsd.org.2013102301... done
</span><span class='line'>[stafbacula] Installing pkg-1.10.1...
</span><span class='line'>[stafbacula] Extracting pkg-1.10.1: 100%
</span><span class='line'>pkg: not enough arguments
</span><span class='line'>Usage: pkg [-v] [-d] [-l] [-N] [-j &lt;jail name or id&gt;|-c &lt;chroot path&gt;|-r &lt;rootdir&gt;] [-C &lt;configuration file&gt;] [-R &lt;repo config dir&gt;] [-o var=value] [-4|-6] &lt;command&gt; [&lt;args&gt;]
</span><span class='line'>
</span><span class='line'>For more information on available commands and options see 'pkg help'.
</span><span class='line'>root@stafbacula:~ # </span></code></pre></td></tr></table></div></figure>


<p>Install the bacula server package</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafbacula:~ # pkg install bacula-server
</span><span class='line'>Updating FreeBSD repository catalogue...
</span><span class='line'>FreeBSD repository is up to date.
</span><span class='line'>All repositories are up to date.
</span><span class='line'>Updating database digests format: 100%
</span><span class='line'>The following 8 package(s) will be affected (of 0 checked):
</span><span class='line'>
</span><span class='line'>New packages to be INSTALLED:
</span><span class='line'>        bacula-server: 7.4.7_1
</span><span class='line'>        bacula-client: 7.4.7_1
</span><span class='line'>        readline: 7.0.3
</span><span class='line'>        indexinfo: 0.2.6
</span><span class='line'>        gettext-runtime: 0.19.8.1_1
</span><span class='line'>        lzo2: 2.10_1
</span><span class='line'>        postgresql95-client: 9.5.7_1
</span><span class='line'>        perl5: 5.24.1_1
</span><span class='line'>
</span><span class='line'>Number of packages to be installed: 8
</span><span class='line'>
</span><span class='line'>The process will require 69 MiB more space.
</span><span class='line'>17 MiB to be downloaded.
</span><span class='line'>
</span><span class='line'>Proceed with this action? [y/N]: y
</span><span class='line'>[stafbacula] [1/8] Fetching bacula-server-7.4.7_1.txz: 100%  678 KiB 694.6kB/s    00:01    
</span><span class='line'>[stafbacula] [2/8] Fetching bacula-client-7.4.7_1.txz: 100%  286 KiB 292.8kB/s    00:01    
</span><span class='line'>[stafbacula] [3/8] Fetching readline-7.0.3.txz: 100%  334 KiB 342.4kB/s    00:01    
</span><span class='line'>[stafbacula] [4/8] Fetching indexinfo-0.2.6.txz: 100%    5 KiB   5.3kB/s    00:01    
</span><span class='line'>[stafbacula] [5/8] Fetching gettext-runtime-0.19.8.1_1.txz: 100%  148 KiB 151.1kB/s    00:01    
</span><span class='line'>[stafbacula] [6/8] Fetching lzo2-2.10_1.txz: 100%  113 KiB 115.4kB/s    00:01    
</span><span class='line'>[stafbacula] [7/8] Fetching postgresql95-client-9.5.7_1.txz: 100%    2 MiB 772.9kB/s    00:03    
</span><span class='line'>[stafbacula] [8/8] Fetching perl5-5.24.1_1.txz: 100%   13 MiB 874.0kB/s    00:16    
</span><span class='line'>Checking integrity... done (0 conflicting)
</span><span class='line'>[stafbacula] [1/8] Installing indexinfo-0.2.6...
</span><span class='line'>[stafbacula] [1/8] Extracting indexinfo-0.2.6: 100%
</span><span class='line'>[stafbacula] [2/8] Installing readline-7.0.3...
</span><span class='line'>[stafbacula] [2/8] Extracting readline-7.0.3: 100%
</span><span class='line'>[stafbacula] [3/8] Installing gettext-runtime-0.19.8.1_1...
</span><span class='line'>[stafbacula] [3/8] Extracting gettext-runtime-0.19.8.1_1: 100%
</span><span class='line'>[stafbacula] [4/8] Installing lzo2-2.10_1...
</span><span class='line'>[stafbacula] [4/8] Extracting lzo2-2.10_1: 100%
</span><span class='line'>[stafbacula] [5/8] Installing perl5-5.24.1_1...
</span><span class='line'>[stafbacula] [5/8] Extracting perl5-5.24.1_1: 100%
</span><span class='line'>[stafbacula] [6/8] Installing bacula-client-7.4.7_1...
</span><span class='line'>===&gt; Creating groups.
</span><span class='line'>Creating group 'bacula' with gid '910'.
</span><span class='line'>===&gt; Creating users
</span><span class='line'>Creating user 'bacula' with uid '910'.
</span><span class='line'>[stafbacula] [6/8] Extracting bacula-client-7.4.7_1: 100%
</span><span class='line'>[stafbacula] [7/8] Installing postgresql95-client-9.5.7_1...
</span><span class='line'>[stafbacula] [7/8] Extracting postgresql95-client-9.5.7_1: 100%
</span><span class='line'>[stafbacula] [8/8] Installing bacula-server-7.4.7_1...
</span><span class='line'>===&gt; Creating groups.
</span><span class='line'>Using existing group 'bacula'.
</span><span class='line'>===&gt; Creating users
</span><span class='line'>Using existing user 'bacula'.
</span><span class='line'>[stafbacula] Extracting bacula-server-7.4.7_1: 100%
</span><span class='line'>Message from perl5-5.24.1_1:
</span><span class='line'>The /usr/bin/perl symlink has been removed starting with Perl 5.20.
</span><span class='line'>For shebangs, you should either use:
</span><span class='line'>
</span><span class='line'>#!/usr/local/bin/perl
</span><span class='line'>
</span><span class='line'>or
</span><span class='line'>
</span><span class='line'>#!/usr/bin/env perl
</span><span class='line'>
</span><span class='line'>The first one will only work if you have a /usr/local/bin/perl,
</span><span class='line'>the second will work as long as perl is in PATH.
</span><span class='line'>Message from bacula-client-7.4.7_1:
</span><span class='line'>################################################################################
</span><span class='line'>
</span><span class='line'>NOTE:
</span><span class='line'>Sample files are installed in /usr/local/etc/bacula:
</span><span class='line'>
</span><span class='line'>  bconsole.conf.sample, bacula-fd.conf.sample
</span><span class='line'>
</span><span class='line'>################################################################################
</span><span class='line'>Message from postgresql95-client-9.5.7_1:
</span><span class='line'>The PostgreSQL port has a collection of "side orders":
</span><span class='line'>
</span><span class='line'>postgresql-docs
</span><span class='line'>  For all of the html documentation
</span><span class='line'>
</span><span class='line'>p5-Pg
</span><span class='line'>  A perl5 API for client access to PostgreSQL databases.
</span><span class='line'>
</span><span class='line'>postgresql-tcltk
</span><span class='line'>  If you want tcl/tk client support.
</span><span class='line'>
</span><span class='line'>postgresql-jdbc
</span><span class='line'>  For Java JDBC support.
</span><span class='line'>
</span><span class='line'>postgresql-odbc
</span><span class='line'>  For client access from unix applications using ODBC as access
</span><span class='line'>  method. Not needed to access unix PostgreSQL servers from Win32
</span><span class='line'>  using ODBC. See below.
</span><span class='line'>
</span><span class='line'>ruby-postgres, py-PyGreSQL
</span><span class='line'>  For client access to PostgreSQL databases using the ruby & python
</span><span class='line'>  languages.
</span><span class='line'>
</span><span class='line'>postgresql-plperl, postgresql-pltcl & postgresql-plruby
</span><span class='line'>  For using perl5, tcl & ruby as procedural languages.
</span><span class='line'>
</span><span class='line'>postgresql-contrib
</span><span class='line'>  Lots of contributed utilities, postgresql functions and
</span><span class='line'>  datatypes. There you find pg_standby, pgcrypto and many other cool
</span><span class='line'>  things.
</span><span class='line'>
</span><span class='line'>etc...
</span><span class='line'>Message from bacula-server-7.4.7_1:
</span><span class='line'>###############################################################################
</span><span class='line'>
</span><span class='line'>bacula server was installed
</span><span class='line'>
</span><span class='line'>An auto-changer manipulation script based on FreeBSDs
</span><span class='line'>chio command is included and installed at
</span><span class='line'>
</span><span class='line'>  /usr/local/sbin/chio-bacula
</span><span class='line'>
</span><span class='line'>Please have a look at it if you want to use an
</span><span class='line'>autochanger. You have to configure the usage in
</span><span class='line'>
</span><span class='line'>  /usr/local/etc/bacula/bacula-dir.conf
</span><span class='line'>
</span><span class='line'>Take care of correct permissions for changer and
</span><span class='line'>tape device (e.g. /dev/ch0 and /dev/n[r]sa0) i.e.
</span><span class='line'>they must be accessible by user bacula.
</span><span class='line'>
</span><span class='line'>Due to lack of some features in the FreeBSD tape driver
</span><span class='line'>implementation you MUST add some OS dependent options to
</span><span class='line'>the bacula-sd.conf file:
</span><span class='line'>
</span><span class='line'>  Hardware End of Medium = no;
</span><span class='line'>  Backward Space Record  = no;
</span><span class='line'>  Backward Space File    = no;
</span><span class='line'>
</span><span class='line'>With 2 filemarks at EOT (see man mt):
</span><span class='line'>  Fast Forward Space File = no;
</span><span class='line'>  BSF at EOM = yes;
</span><span class='line'>  TWO EOF    = yes;
</span><span class='line'>
</span><span class='line'>With 1 filemarks at EOT (see man mt):
</span><span class='line'>  Fast Forward Space File = yes;
</span><span class='line'>  BSF at EOM = no;
</span><span class='line'>  TWO EOF   = no;
</span><span class='line'>
</span><span class='line'>NOTE: YOU CAN SWITCH EOT model ONLY when starting
</span><span class='line'>      from scratch with EMPTY tapes.
</span><span class='line'>
</span><span class='line'>It is also important that all the scripts accessed
</span><span class='line'>by RunBeforeJob and RunAfterJob will be executed by
</span><span class='line'>the user bacula.  Check your permissions.
</span><span class='line'>
</span><span class='line'>For USB support read the bacula manual. It could be necessary
</span><span class='line'>to configure/compile a new kernel.
</span><span class='line'>
</span><span class='line'>Look at /usr/local/share/bacula/update_bacula_tables for
</span><span class='line'>database update procedure. Details can be found in the
</span><span class='line'>ReleaseNotes
</span><span class='line'>
</span><span class='line'>If you are using sqlite you need to run the make_sqlite_tables script as
</span><span class='line'>the bacula user. Do this using 'sudo su -m bacula'.
</span><span class='line'>
</span><span class='line'>################################################################################
</span><span class='line'>root@stafbacula:~ # </span></code></pre></td></tr></table></div></figure>


<h1>Initialize the bacula catalog</h1>

<p>We&rsquo;ll have a postgreSQL server running in a FreeBSD jail as our catalog (see <a href="http://stafwag.github.io/blog/blog/2017/08/06/bacula-on-freebsd:w_part1/"><a href="http://stafwag.github.io/blog/blog/2017/08/06/bacula-on-freebsd:w_part1/">http://stafwag.github.io/blog/blog/2017/08/06/bacula-on-freebsd:w_part1/</a></a> howto install PostgreSQL into a FreeBSD jail).</p>

<h2>PostgreSQL setup</h2>

<p>The setup below describes howto configure the PostgreSQL catalog with certificate and username/password authentication. This might be overkill the bacula server runs on the same physical host so no data is going out on the network. But I wanted to setup the database conneection as secure as possible and will reuse this setup for my other database connection. We&rsquo;ll setup a &ldquo;self signed&rdquo; root ca for now, but I replace this with my own CA in further.</p>

<h3>PostgreSQL authentication methods</h3>

<p>PostgreSQL support a lot of authentication methods you&rsquo;ll find a description of the supported of the support authentication methods below (without too much details):</p>

<ul>
<li><strong>Trust Authentication</strong> <br />
With trust authentication the postgreSQL trust the connection from the remote host, this is the default for localhost host connection and &ldquo;socket&rdquo; connections.
<br />&nbsp;<br /></li>
<li><strong>Password Authentication</strong> <br />
Authentication with login/password
<br />&nbsp;<br /></li>
<li><strong>GSSAPI Authentication</strong> <br />
Authentication with the <a href="https://en.wikipedia.org/wiki/Generic_Security_Services_Application_Program_Interface">Generic Security Services Application Program Interface</a>
<br />&nbsp;<br /></li>
<li><strong>SSPI Authentication</strong> <br />
Authentication with the <a href="https://en.wikipedia.org/wiki/Security_Support_Provider_Interface"">Security Support Provider Interface</a> - SSPI is a proprietary variant of GSSAPI with extensions and very Windows-specific data types -
<br />&nbsp;<br /></li>
<li><strong>Kerberos Authentication</strong> <br />
Authentication using the <a href="https://en.wikipedia.org/wiki/Kerberos_(protocol)">Kerberos protocol</a>
<br />&nbsp;<br /></li>
<li><strong>Ident Authentication</strong> <br />
Authentication using the <a href="https://en.wikipedia.org/wiki/Ident_protocol">ident protocol</a>
<br />&nbsp;<br /></li>
<li><strong>Peer Authentication</strong> <br />
Authentication using the <a href="https://www.freebsd.org/cgi/man.cgi?query=getpeereid">getpeereid()</a> kernel function, only supported for local connection on BSD, MacOS and GNU/Linux.
<br />&nbsp;<br /></li>
<li><strong>LDAP Authentication</strong> <br />
<a href="https://en.wikipedia.org/wiki/Lightweight_Directory_Access_Protocol">LDAP</a> authentication.</a>
<br />&nbsp;<br /></li>
<li><strong>RADIUS Authentication</strong> <br />
<a href="https://en.wikipedia.org/wiki/RADIUS">Radius</a> authentication.
<br />&nbsp;<br /></li>
<li><strong>Certificate Authentication</strong> <br />
Authentication with a <a href="https://en.wikipedia.org/wiki/Public_key_infrastructure">PKI certificate</a>.
<br />&nbsp;<br /></li>
<li><strong>PAM Authentication</strong> <br />
<a href="https://en.wikipedia.org/wiki/Pluggable_authentication_module">PAM</a> based authentication</a>
<br />&nbsp;<br />
<br />&nbsp;<br />
I wanted to use password authentication over ssl with a client certificate.
The bacula documents isn&rsquo;t very clear on howto configure it. After a quick lot at the bacula source code it should be supported, so let&rsquo;s give it a try&hellip;</li>
</ul>


<h3>Configure the PostgreSQL jail</h3>

<h4>Allow network connections</h4>

<p>Logon the postgreSQL server jail move to the postgreSQL data directory and edit postgresql.conf to allow TCP/IP connections.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafdb:/var/db/postgres/data96 # pwd
</span><span class='line'>/var/db/postgres/data96
</span><span class='line'>root@stafdb:/var/db/postgres/data96 # vim postgresql.conf</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># - Connection Settings -
</span><span class='line'>
</span><span class='line'>listen_addresses = '192.168.1.51'               # what IP address(es) to listen on;
</span><span class='line'># listen_addresses = 'localhost'                # what IP address(es) to listen on;
</span><span class='line'>                                        # comma-separated list of addresses;
</span><span class='line'>                                        # defaults to 'localhost'; use '*' for all
</span><span class='line'>                                        # (change requires restart)
</span><span class='line'>#port = 5432                            # (change requires restart)
</span></code></pre></td></tr></table></div></figure>


<h4>SSL encryption</h4>

<p>It&rsquo;s always a good idea to encrypt your connections.</p>

<h5>SSL Server setup</h5>

<h6>Umask</h6>

<p>set the umask to prevent somebody can read you private key.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafdb:/var/db/postgres/data96 # su - postgres
</span><span class='line'>$ umask 077 
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h6>Create a private key</h6>

<p>Create a private key without encrypting it.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl genrsa -out server.key 4096
</span><span class='line'>Generating RSA private key, 4096 bit long modulus
</span><span class='line'>........................................................................................................................................................................................................................++
</span><span class='line'>......++
</span><span class='line'>e is 65537 (0x10001)
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h6>Create a self-signed certificate</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ openssl req -new -key server.key -days 3650 -out server.crt -x509 -subj '/C=BE/ST=Flanders/L=Antwerp/O=stafnet/CN=stafdb'
</span><span class='line'>$ ls -ltr                                                                                               total 23
</span><span class='line'>-rw-------   1 postgres  postgres  3247 Sep  9 11:47 server.key
</span><span class='line'>-rw-------   1 postgres  postgres  1964 Sep  9 11:52 server.crt
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h6>Root ca</h6>

<p>We created a self signed certificate so the server certificate is our trusted ca root.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ln -s server.crt root.crt
</span><span class='line'>$ ls -ltr
</span><span class='line'>total 24
</span><span class='line'>-rw-------   1 postgres  postgres  3247 Sep  9 11:47 server.key
</span><span class='line'>-rw-------   1 postgres  postgres  1964 Sep  9 11:52 server.crt
</span><span class='line'>lrwx------   1 postgres  postgres    10 Sep  9 11:53 root.crt -&gt; server.crt
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h6>Enable ssl</h6>

<p>Edit postgresql.conf and  update the ssl setting</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vi postgresql.conf
</span></code></pre></td></tr></table></div></figure>


<p>By default ssl_ca_file is not set but this directive is required so don&rsquo;t forget to set it.
We disable the 3DES ciphers they&rsquo;re obsolete&hellip; We don&rsquo;t speficy a crl for now.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#authentication_timeout = 1min          # 1s-600s
</span><span class='line'>ssl = on                                # (change requires restart)
</span><span class='line'>ssl_ciphers = 'HIGH:MEDIUM:!3DES:!aNULL' # allowed SSL ciphers
</span><span class='line'>                                        # (change requires restart)
</span><span class='line'>ssl_prefer_server_ciphers = on          # (change requires restart)
</span><span class='line'>#ssl_ecdh_curve = 'prime256v1'          # (change requires restart)
</span><span class='line'>ssl_cert_file = 'server.crt'            # (change requires restart)
</span><span class='line'>ssl_key_file = 'server.key'             # (change requires restart)
</span><span class='line'>ssl_ca_file = 'root.crt'                        # (change requires restart)
</span><span class='line'>#ssl_crl_file = ''                      # (change requires restart)
</span><span class='line'>#password_encryption = on</span></code></pre></td></tr></table></div></figure>


<h5>SSL Client setup</h5>

<h6>Become bacula</h6>

<p>Logon to the bacula jail and become the bacula user. We use &ldquo;su -m &hellip;&rdquo; to logon to the locked daemon account, this will take over the root environment.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # ezjail-admin console stafbacula
</span><span class='line'>Last login: Wed Sep  9 09:33:16 on pts/0
</span><span class='line'>FreeBSD 11.1-RELEASE-p1 (GENERIC) #0: Wed Sep  9 11:55:48 UTC 2017
</span><span class='line'>
</span><span class='line'>Welcome to FreeBSD!
</span><span class='line'>
</span><span class='line'>Release Notes, Errata: https://www.FreeBSD.org/releases/
</span><span class='line'>Security Advisories:   https://www.FreeBSD.org/security/
</span><span class='line'>FreeBSD Handbook:      https://www.FreeBSD.org/handbook/
</span><span class='line'>FreeBSD FAQ:           https://www.FreeBSD.org/faq/
</span><span class='line'>Questions List: https://lists.FreeBSD.org/mailman/listinfo/freebsd-questions/
</span><span class='line'>FreeBSD Forums:        https://forums.FreeBSD.org/
</span><span class='line'>
</span><span class='line'>Documents installed with the system are in the /usr/local/share/doc/freebsd/
</span><span class='line'>directory, or can be installed later with:  pkg install en-freebsd-doc
</span><span class='line'>For other languages, replace "en" with a language code like de or fr.
</span><span class='line'>
</span><span class='line'>Show the version of FreeBSD installed:  freebsd-version ; uname -a
</span><span class='line'>Please include that output and any error messages when posting questions.
</span><span class='line'>Introduction to manual pages:  man man
</span><span class='line'>FreeBSD directory layout:      man hier
</span><span class='line'>
</span><span class='line'>Edit /etc/motd to change this login announcement.
</span><span class='line'>You have new mail.
</span><span class='line'>root@stafbacula:~ # su -m bacula -c "/bin/sh"
</span><span class='line'>$ id
</span><span class='line'>uid=910(bacula) gid=910(bacula) groups=910(bacula)
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h6>umask</h6>

<p>Set the umask to prevent somebody can read you private key.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ umask 077
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h6>move to the bacula home directory</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat /etc/passwd | grep bacula
</span><span class='line'>bacula:*:910:910:Bacula Daemon:/var/db/bacula:/usr/sbin/nologin
</span><span class='line'>$ cd /var/db/bacula</span></code></pre></td></tr></table></div></figure>


<h6>create the .postges directory</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir .postgres
</span><span class='line'>$ ls -la
</span><span class='line'>total 12
</span><span class='line'>drwxrwx---   3 bacula  bacula   3 Sep  9 09:41 .
</span><span class='line'>drwxr-xr-x  14 root    wheel   18 Sep  9 14:41 ..
</span><span class='line'>drwx------   2 bacula  bacula   2 Sep  9 09:41 .postgres
</span><span class='line'>$ cd .postgres/
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h6>Create a private key</h6>

<p>We took over the root evironment therefor we need to set the RANDFILE variable to randfile in the bacula home directory.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ pwd
</span><span class='line'>/var/db/bacula/.postgres
</span><span class='line'>$ export RANDFILE=/var/db/bacula/.rnd
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<p>Create the private key.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ openssl genrsa -out `hostname`.key 4096
</span><span class='line'>Generating RSA private key, 4096 bit long modulus
</span><span class='line'>..........++
</span><span class='line'>.......................................................++
</span><span class='line'>e is 65537 (0x10001)
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h6>Create the client csr</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ openssl req -new -key stafbacula.key -out stafbacula.csr -subj '/C=BE/ST=Flanders/L=Antwerp/O=stafnet/CN=stafbacula'
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h6>Create the client certifocate</h6>

<p>Logon to the postgreSQL jail as postgres and sign the client csr.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[postgres@stafdb ~/data96]$ openssl x509 -req -in stafbacula.csr -CAcreateserial -CA root.crt -CAkey server.key -out stafbacula.crt 
</span><span class='line'>Signature ok
</span><span class='line'>subject=/C=BE/ST=Flanders/L=Antwerp/O=stafnet/CN=stafbacula
</span><span class='line'>Getting CA Private Key
</span><span class='line'>[postgres@stafdb ~/data96]$ 
</span></code></pre></td></tr></table></div></figure>


<h5>Copy the client certificate and the trusted root certificate to bacula jail</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ uname -a
</span><span class='line'>FreeBSD stafbacula 11.1-RELEASE-p1 FreeBSD 11.1-RELEASE-p1 #0: Wed Sep  9 11:55:48 UTC 2017     root@amd64-builder.daemonology.net:/usr/obj/usr/src/sys/GENERIC  amd64
</span><span class='line'>$ pwd
</span><span class='line'>/var/db/bacula/.postgres
</span><span class='line'>$ ls -ltr
</span><span class='line'>total 24
</span><span class='line'>-rw-------  1 bacula  bacula  3243 Sep  9 09:47 stafbacula.key
</span><span class='line'>-rw-------  1 bacula  bacula  1679 Sep  9 09:54 stafbacula.csr
</span><span class='line'>-rw-------  1 bacula  bacula  1964 Sep  9 10:04 root.crt
</span><span class='line'>-rw-------  1 bacula  bacula  1850 Sep  9 10:06 stafbacula.crt
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h4>Host file on the bacula jail</h4>

<p>The hostname of the posgresql jail has to match with the CN of the server certificate. So we&rsquo;ll add the hostname to /etc/hosts</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafbacula:~ # vi /etc/hosts</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>192.168.1.51    stafdb</span></code></pre></td></tr></table></div></figure>


<h2>Setup the bacula database</h2>

<h4>Create the bacula database user</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[postgres@stafdb ~/data96]$ id
</span><span class='line'>uid=770(postgres) gid=770(postgres) groups=770(postgres)
</span><span class='line'>[postgres@stafdb ~/data96]$ psql postgres
</span><span class='line'>psql (9.6.3)
</span><span class='line'>Type "help" for help.
</span><span class='line'>
</span><span class='line'>postgres=# create user bacula WITH PASSWORD 'xxxxxx';
</span><span class='line'>CREATE ROLE
</span><span class='line'>postgres=# </span></code></pre></td></tr></table></div></figure>


<p>To update the user password;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>postgres=# alter user bacula PASSWORD 'yyyyyyy';
</span><span class='line'>ALTER ROLE
</span><span class='line'>postgres=# </span></code></pre></td></tr></table></div></figure>


<p>You can view the new permissions in the pg_user table or by execute the \du (describe user shortcut), by default the user has minimal permissions.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>postgres=# select * from pg_user where usename = 'bacula';
</span><span class='line'> usename | usesysid | usecreatedb | usesuper | userepl | usebypassrls |  passwd  | valuntil | useconfig 
</span><span class='line'>---------+----------+-------------+----------+---------+--------------+----------+----------+-----------
</span><span class='line'> bacula  |    16386 | f           | f        | f       | f            | ******** |          | 
</span><span class='line'>(1 row)
</span><span class='line'>
</span><span class='line'>postgres=# 
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>postgres=# \du
</span><span class='line'>                                   List of roles
</span><span class='line'> Role name |                         Attributes                         | Member of 
</span><span class='line'>-----------+------------------------------------------------------------+-----------
</span><span class='line'> bacula    |                                                            | {}
</span><span class='line'> postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS | {}
</span><span class='line'>
</span><span class='line'>postgres=# </span></code></pre></td></tr></table></div></figure>


<h3>Allow the bacula user to create databases</h3>

<p>The bacula database script will try to create the bacula catalog database.
We&rsquo;ll allow the bacula user to create databases,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>postgres=# alter user bacula CREATEDB;
</span><span class='line'>ALTER ROLE
</span><span class='line'>postgres=# select * from pg_user where usename = 'bacula';
</span><span class='line'> usename | usesysid | usecreatedb | usesuper | userepl | usebypassrls |  passwd  | valuntil | useconfig 
</span><span class='line'>---------+----------+-------------+----------+---------+--------------+----------+----------+-----------
</span><span class='line'> bacula  |    16386 | t           | f        | f       | f            | ******** |          | 
</span><span class='line'>(1 row)
</span><span class='line'>
</span><span class='line'>postgres=# \du
</span><span class='line'>                                   List of roles
</span><span class='line'> Role name |                         Attributes                         | Member of 
</span><span class='line'>-----------+------------------------------------------------------------+-----------
</span><span class='line'> bacula    | Create DB                                                  | {}
</span><span class='line'> postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS | {}
</span><span class='line'>
</span><span class='line'>postgres=# </span></code></pre></td></tr></table></div></figure>


<h3>Create the bacula database</h3>

<p>We&rsquo;ll create a bacula database so we can verify the database connection from the bacula user to the bacula database.</p>

<p>Create a new bacula database</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>postgres=# create database bacula;
</span><span class='line'>CREATE DATABASE
</span><span class='line'>postgres=# </span></code></pre></td></tr></table></div></figure>


<p>Grant all permissions to the bacula user</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>postgres=# grant ALL on DATABASE bacula to bacula;
</span><span class='line'>GRANT
</span><span class='line'>postgres=# </span></code></pre></td></tr></table></div></figure>


<h2>Update pg_hba</h2>

<p>The pg_hba.conf configuration controls the <strong>H</strong>ost <strong>B</strong>ased <strong>A</strong>ccess to your postgreSQL database(s).</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[postgres@stafdb ~/data96]$ pwd
</span><span class='line'>/var/db/postgres/data96
</span><span class='line'>[postgres@stafdb ~/data96]$ id
</span><span class='line'>uid=770(postgres) gid=770(postgres) groups=770(postgres)
</span><span class='line'>[postgres@stafdb ~/data96]$ vi pg_hba.conf </span></code></pre></td></tr></table></div></figure>


<p>And add the next lines;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># TYPE  DATABASE        USER            ADDRESS                 METHOD
</span><span class='line'>hostssl bacula          bacula          192.168.1.52/32         md5 clientcert=1
</span><span class='line'>hostssl template0       bacula          192.168.1.52/32         md5 clientcert=1
</span><span class='line'>hostssl template1       bacula          192.168.1.52/32         md5 clientcert=1
</span><span class='line'>hostssl postgres        bacula          192.168.1.52/32         md5 clientcert=1</span></code></pre></td></tr></table></div></figure>


<p>Our bacula jail <strong><em>192.168.1.52</em></strong> only needs to have to the <strong><em>bacula</em></strong> database with the <strong><em>bacula</em></strong> user over ssl <strong><em>hostssl</em></strong> passwords will be send as a <strong><em>md5</em></strong> hash and a client certificate is required <strong><em>clientcert=1</em></strong>.</p>

<p>We could also used the <strong><em>cert</em></strong> method and <strong><em>map</em></strong> the client certificate to postgresql user so we could authenticate with the client certificate only&hellip;</p>

<p>We allow access to the template* and the postgres database because it&rsquo;s required for the bacula database xcreate script. We can remove them ( only allow access to the bacula database ) after the catalog database is created.</p>

<h2>Restart postgresql</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafdb:/var/db/postgres/data96 # service postgresql restart
</span><span class='line'>DEBUG:  postgres: PostmasterMain: initial environment dump:
</span><span class='line'>DEBUG:  -----------------------------------------
</span><span class='line'>DEBUG:          LC_TIME=C
</span><span class='line'>DEBUG:          LC_NUMERIC=C
</span><span class='line'>DEBUG:          LC_MONETARY=C
</span><span class='line'>DEBUG:          LC_MESSAGES=C
</span><span class='line'>DEBUG:          LC_CTYPE=C
</span><span class='line'>DEBUG:          LC_COLLATE=C
</span><span class='line'>DEBUG:          MAIL=/var/mail/postgres
</span><span class='line'>DEBUG:          PGLOCALEDIR=/usr/local/share/locale
</span><span class='line'>DEBUG:          PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin:/var/db/postgres/bin
</span><span class='line'>DEBUG:          PGDATA=/var/db/postgres/data96
</span><span class='line'>DEBUG:          PWD=/var/db/postgres
</span><span class='line'>DEBUG:          PGSYSCONFDIR=/usr/local/etc/postgresql
</span><span class='line'>DEBUG:          HOME=/var/db/postgres
</span><span class='line'>DEBUG:          USER=postgres
</span><span class='line'>DEBUG:          SHELL=/bin/sh
</span><span class='line'>DEBUG:          PG_GRANDPARENT_PID=79045
</span><span class='line'>DEBUG:          BLOCKSIZE=K
</span><span class='line'>DEBUG:  -----------------------------------------
</span><span class='line'>LOG:  could not create IPv6 socket: Protocol not supported
</span><span class='line'>LOG:  could not bind IPv4 socket: Address already in use
</span><span class='line'>HINT:  Is another postmaster already running on port 5432? If not, wait a few seconds and retry.
</span><span class='line'>WARNING:  could not create listen socket for "192.168.1.51"
</span><span class='line'>DEBUG:  invoking IpcMemoryCreate(size=148480000)
</span><span class='line'>DEBUG:  SlruScanDirectory invoking callback on pg_notify/0000
</span><span class='line'>DEBUG:  removing file "pg_notify/0000"
</span><span class='line'>DEBUG:  dynamic shared memory system will support 288 segments
</span><span class='line'>DEBUG:  created dynamic shared memory control segment 773439544 (2316 bytes)
</span><span class='line'>DEBUG:  max_safe_fds = 984, usable_fds = 1000, already_open = 6
</span><span class='line'>LOG:  ending log output to stderr
</span><span class='line'>HINT:  Future log output will go to log destination "syslog".
</span><span class='line'>DEBUG:  CommitTransaction
</span><span class='line'>DEBUG:  name: unnamed; blockState:       STARTED; state: INPROGR, xid/subid/cid: 0/1/0, nestlvl: 1, children: 
</span><span class='line'>root@stafdb:/var/db/postgres/data96 #
</span></code></pre></td></tr></table></div></figure>


<h2>Test the database connection</h2>

<h3>Verify</h3>

<p>Verify the database connection for the bacula jail. See <a href="https://www.postgresql.org/docs/9.6/static/libpq-connect.html"><a href="https://www.postgresql.org/docs/9.6/static/libpq-connect.html">https://www.postgresql.org/docs/9.6/static/libpq-connect.html</a></a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[bacula@stafbacula /var/db/bacula/.postgres]$ psql "sslmode=verify-full host=stafdb dbname=bacula sslcert=`pwd`/postgresql.crt sslkey=`pwd`/postgresql.key sslrootcert=`pwd`/root.crt"
</span><span class='line'>Password:
</span><span class='line'>DEBUG:  CommitTransaction
</span><span class='line'>DEBUG:  name: unnamed; blockState:       STARTED; state: INPROGR, xid/subid/cid: 0/1/0, nestlvl: 1, children:
</span><span class='line'>psql (9.5.7, server 9.6.3)
</span><span class='line'>WARNING: psql major version 9.5, server major version 9.6.
</span><span class='line'>         Some psql features might not work.
</span><span class='line'>SSL connection (protocol: TLSv1.2, cipher: ECDHE-RSA-AES256-GCM-SHA384, bits: 256, compression: off)
</span><span class='line'>Type "help" for help.
</span><span class='line'>bacula=&gt;</span></code></pre></td></tr></table></div></figure>


<h3>Create environment script</h3>

<p>Bacula comes with a few scripts to popilate the catalog we will create an &ldquo;environment&rdquo; script to setup the required environment variabeles to connect to the database. <a href="https://www.postgresql.org/docs/9.6/static/libpq-envars.html"><a href="https://www.postgresql.org/docs/9.6/static/libpq-envars.html">https://www.postgresql.org/docs/9.6/static/libpq-envars.html</a></a> gives an overview of PostgreSQL environment variabeles.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[bacula@stafbacula /var/db/bacula]$ vi psql_env.sh</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>PGHOST=stafdb
</span><span class='line'>PGUSER=bacula
</span><span class='line'>PGSSLMODE=verify-full
</span><span class='line'>PGSSLCERT=/var/db/bacula/.postgres/postgresql.crt
</span><span class='line'>PGSSLKEY=/var/db/bacula/.postgres/postgresql.key
</span><span class='line'>PGSSLROOTCERT=/var/db/bacula/.postgres/root.crt
</span><span class='line'>
</span><span class='line'>export PGHOST
</span><span class='line'>export PGUSER
</span><span class='line'>export PGSSLMODE
</span><span class='line'>export PGSSLCERT
</span><span class='line'>export PGSSLKEY
</span><span class='line'>export PGSSLROOTCERT</span></code></pre></td></tr></table></div></figure>


<p>Test the environment script</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafbacula:~ # su -m bacula -c /bin/sh
</span><span class='line'>$ . /var/db/bacula/psql_env.sh
</span><span class='line'>$ psql bacula
</span><span class='line'>Password: 
</span><span class='line'>DEBUG:  CommitTransaction
</span><span class='line'>DEBUG:  name: unnamed; blockState:       STARTED; state: INPROGR, xid/subid/cid: 0/1/0, nestlvl: 1, children: 
</span><span class='line'>psql (9.5.8, server 9.6.4)
</span><span class='line'>WARNING: psql major version 9.5, server major version 9.6.
</span><span class='line'>         Some psql features might not work.
</span><span class='line'>SSL connection (protocol: TLSv1.2, cipher: ECDHE-RSA-AES256-GCM-SHA384, bits: 256, compression: off)
</span><span class='line'>Type "help" for help.
</span><span class='line'>
</span><span class='line'>bacula=&gt; </span></code></pre></td></tr></table></div></figure>


<h2>Configure the bacula catalog</h2>

<h3>Configuration directives</h3>

<p>I found the bacula documention not very clear howto setup the catalog connection with certificate authentication - or I looked at the wrong place - so I downloaded the bacula source code ( version 7.4.7 )to verify the required directives. ./src/dird/d/dird_conf.c</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky bacula-7.4.7]$ vim ./src/dird/dird_conf.c</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/*
</span><span class='line'>   Bacula(R) - The Network Backup Solution
</span><span class='line'>
</span><span class='line'>   Copyright (C) 2000-2016 Kern Sibbald
</span><span class='line'>
</span><span class='line'>   The original author of Bacula is Kern Sibbald, with contributions
</span><span class='line'>   from many others, a complete list can be found in the file AUTHORS.
</span><span class='line'>
</span><span class='line'>   You may use this file and others of this release according to the
</span><span class='line'>   license defined in the LICENSE file, which includes the Affero General
</span><span class='line'>   Public License, v3.0 ("AGPLv3") and some additional permissions and
</span><span class='line'>   terms pursuant to its AGPLv3 Section 7.
</span><span class='line'>
</span><span class='line'>   This notice must be preserved when any source code is
</span><span class='line'>   conveyed and/or propagated.
</span><span class='line'>
</span><span class='line'>   Bacula(R) is a registered trademark of Kern Sibbald.
</span><span class='line'>*/
</span><span class='line'>
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>
</span><span class='line'>/*
</span><span class='line'> *    Catalog Resource Directives
</span><span class='line'> *
</span><span class='line'> *   name          handler     value                 code flags    default_value
</span><span class='line'> */
</span><span class='line'>static RES_ITEM cat_items[] = {
</span><span class='line'>   {"Name",     store_name,     ITEM(res_cat.hdr.name),    0, ITEM_REQUIRED, 0},
</span><span class='line'>   {"Description", store_str,   ITEM(res_cat.hdr.desc),    0, 0, 0},
</span><span class='line'>   {"dbaddress", store_str,     ITEM(res_cat.db_address),  0, 0, 0},
</span><span class='line'>   {"Address",  store_str,      ITEM(res_cat.db_address),  0, 0, 0},
</span><span class='line'>   {"DbPort",   store_pint32,   ITEM(res_cat.db_port),      0, 0, 0},
</span><span class='line'>   /* keep this password as store_str for the moment */
</span><span class='line'>   {"dbpassword", store_str,    ITEM(res_cat.db_password), 0, 0, 0},
</span><span class='line'>   {"Password", store_str,      ITEM(res_cat.db_password), 0, 0, 0},
</span><span class='line'>   {"dbuser",   store_str,      ITEM(res_cat.db_user),     0, 0, 0},
</span><span class='line'>   {"User",     store_str,      ITEM(res_cat.db_user),     0, 0, 0},
</span><span class='line'>   {"DbName",   store_str,      ITEM(res_cat.db_name),     0, ITEM_REQUIRED, 0},
</span><span class='line'>   {"dbdriver", store_str,      ITEM(res_cat.db_driver),   0, 0, 0},
</span><span class='line'>   {"DbSocket", store_str,      ITEM(res_cat.db_socket),   0, 0, 0},
</span><span class='line'>   {"dbsslkey", store_str,      ITEM(res_cat.db_ssl_key),  0, 0, 0},
</span><span class='line'>   {"dbsslcert", store_str,     ITEM(res_cat.db_ssl_cert),  0, 0, 0},
</span><span class='line'>   {"dbsslca", store_str,       ITEM(res_cat.db_ssl_ca),  0, 0, 0},
</span><span class='line'>   {"dbsslcapath", store_str,   ITEM(res_cat.db_ssl_capath),  0, 0, 0},
</span><span class='line'>   {"dbsslcipher", store_str,   ITEM(res_cat.db_ssl_cipher),  0, 0, 0},
</span><span class='line'>   /* Turned off for the moment */
</span><span class='line'>   {"MultipleConnections", store_bit, ITEM(res_cat.mult_db_connections), 0, 0, 0},
</span><span class='line'>   {"DisableBatchInsert", store_bool, ITEM(res_cat.disable_batch_insert), 0, ITEM_DEFAULT, false},
</span><span class='line'>   {NULL, NULL, {0}, 0, 0, 0}
</span><span class='line'>};
</span></code></pre></td></tr></table></div></figure>


<p>The ssl directives didn&rsquo;t seem to work with postgresql :-( If we feed the postgresql environment variables with the correct ssl settings to the bacula director it seems to work.</p>

<h2>Initialize the database</h2>

<h3>Drop the existing bacula database</h3>

<p>The bacacla create script will try to create a new bacaula database so we&rsquo;ll to drop or test database on our database server.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafdb:~ # su - postgres
</span><span class='line'>$ psql
</span><span class='line'>psql (9.6.4)
</span><span class='line'>Type "help" for help.
</span><span class='line'>
</span><span class='line'>postgres=# drop database bacula ;
</span><span class='line'>DROP DATABASE
</span><span class='line'>postgres=# \l
</span><span class='line'>                             List of databases
</span><span class='line'>   Name    |  Owner   | Encoding | Collate | Ctype |   Access privileges   
</span><span class='line'>-----------+----------+----------+---------+-------+-----------------------
</span><span class='line'> postgres  | postgres | UTF8     | C       | C     | 
</span><span class='line'> template0 | postgres | UTF8     | C       | C     | =c/postgres          +
</span><span class='line'>           |          |          |         |       | postgres=CTc/postgres
</span><span class='line'> template1 | postgres | UTF8     | C       | C     | =c/postgres          +
</span><span class='line'>           |          |          |         |       | postgres=CTc/postgres
</span><span class='line'>(3 rows)
</span><span class='line'>
</span><span class='line'>postgres=# </span></code></pre></td></tr></table></div></figure>


<h3>Create the database</h3>

<p>Logon the bacula jail and create the bacula database.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ . /var/db/bacula/psql_env.sh
</span><span class='line'>$ ./create_bacula_database
</span><span class='line'>Creating postgresql database
</span><span class='line'>Password: 
</span><span class='line'>Password: 
</span><span class='line'>CREATE DATABASE
</span><span class='line'>ALTER DATABASE
</span><span class='line'>Creation of bacula database succeeded.
</span><span class='line'>Password: 
</span><span class='line'>Password: 
</span><span class='line'>Database encoding OK</span></code></pre></td></tr></table></div></figure>


<h3>Populate the bacula tables</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ./make_bacula_tables 
</span><span class='line'>Making postgresql tables
</span><span class='line'>Password: 
</span><span class='line'>CREATE TABLE
</span><span class='line'>ALTER TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>ALTER TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE TABLE
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>INSERT 0 1
</span><span class='line'>CREATE TABLE
</span><span class='line'>CREATE INDEX
</span><span class='line'>INSERT 0 1
</span><span class='line'>Creation of Bacula PostgreSQL tables succeeded.
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h3>Verify</h3>

<p>Logon the bacula database and verify that the database populated.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ psql
</span><span class='line'>Password: 
</span><span class='line'>psql (9.5.8, server 9.6.4)
</span><span class='line'>WARNING: psql major version 9.5, server major version 9.6.
</span><span class='line'>         Some psql features might not work.
</span><span class='line'>SSL connection (protocol: TLSv1.2, cipher: ECDHE-RSA-AES256-GCM-SHA384, bits: 256, compression: off)
</span><span class='line'>Type "help" for help.
</span><span class='line'>
</span><span class='line'>bacula=&gt; \d
</span><span class='line'>                       List of relations
</span><span class='line'> Schema |               Name                |   Type   | Owner  
</span><span class='line'>--------+-----------------------------------+----------+--------
</span><span class='line'> public | basefiles                         | table    | bacula
</span><span class='line'> public | basefiles_baseid_seq              | sequence | bacula
</span><span class='line'> public | cdimages                          | table    | bacula
</span><span class='line'> public | client                            | table    | bacula
</span><span class='line'> public | client_clientid_seq               | sequence | bacula
</span><span class='line'> public | counters                          | table    | bacula
</span><span class='line'> public | device                            | table    | bacula
</span><span class='line'> public | device_deviceid_seq               | sequence | bacula
</span><span class='line'> public | file                              | table    | bacula
</span><span class='line'> public | file_fileid_seq                   | sequence | bacula
</span><span class='line'> public | filename                          | table    | bacula
</span><span class='line'> public | filename_filenameid_seq           | sequence | bacula
</span><span class='line'> public | fileset                           | table    | bacula
</span><span class='line'> public | fileset_filesetid_seq             | sequence | bacula
</span><span class='line'> public | job                               | table    | bacula
</span><span class='line'> public | job_jobid_seq                     | sequence | bacula
</span><span class='line'> public | jobhisto                          | table    | bacula
</span><span class='line'> public | jobmedia                          | table    | bacula
</span><span class='line'> public | jobmedia_jobmediaid_seq           | sequence | bacula
</span><span class='line'> public | location                          | table    | bacula
</span><span class='line'> public | location_locationid_seq           | sequence | bacula
</span><span class='line'> public | locationlog                       | table    | bacula
</span><span class='line'> public | locationlog_loclogid_seq          | sequence | bacula
</span><span class='line'> public | log                               | table    | bacula
</span><span class='line'> public | log_logid_seq                     | sequence | bacula
</span><span class='line'> public | media                             | table    | bacula
</span><span class='line'> public | media_mediaid_seq                 | sequence | bacula
</span><span class='line'> public | mediatype                         | table    | bacula
</span><span class='line'> public | mediatype_mediatypeid_seq         | sequence | bacula
</span><span class='line'> public | path                              | table    | bacula
</span><span class='line'> public | path_pathid_seq                   | sequence | bacula
</span><span class='line'> public | pathhierarchy                     | table    | bacula
</span><span class='line'> public | pathvisibility                    | table    | bacula
</span><span class='line'> public | pool                              | table    | bacula
</span><span class='line'> public | pool_poolid_seq                   | sequence | bacula
</span><span class='line'> public | restoreobject                     | table    | bacula
</span><span class='line'> public | restoreobject_restoreobjectid_seq | sequence | bacula
</span><span class='line'> public | snapshot                          | table    | bacula
</span><span class='line'> public | snapshot_snapshotid_seq           | sequence | bacula
</span><span class='line'>--More--(byte 2667)</span></code></pre></td></tr></table></div></figure>


<h3>Cleanup</h3>

<p>Disable the access to template? and postgres databases.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafdb:/var/db/postgres/data96 # vi pg_hba.conf</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>host    all             all             ::1/128                 trust
</span><span class='line'>hostssl bacula          bacula          192.168.1.52/32         md5 clientcert=1
</span><span class='line'># hostssl       template0       bacula          192.168.1.52/32         md5 clientcert=1
</span><span class='line'># hostssl       template1       bacula          192.168.1.52/32         md5 clientcert=1
</span><span class='line'># hostssl       postgres        bacula          192.168.1.52/32         md5 clientcert=1</span></code></pre></td></tr></table></div></figure>


<p>Reload</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafdb:/var/db/postgres/data96 # service postgresql reload
</span><span class='line'>root@stafdb:/var/db/postgres/data96 # </span></code></pre></td></tr></table></div></figure>


<p>Test it. Verify that access to the postgres database is denied from the bacula host.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ psql postgres
</span><span class='line'>psql: FATAL:  no pg_hba.conf entry for host "192.168.1.52", user "bacula", database "postgres", SSL on
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>


<h2>Bacula catalog configuration</h2>

<h3>Update the bacula director configuration</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafbacula:/usr/local/etc/bacula # vi bacula-dir.conf</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Generic catalog service
</span><span class='line'>Catalog { 
</span><span class='line'>  Name = MyCatalog
</span><span class='line'>  dbname = "bacula"; dbuser = "bacula"; dbpassword = "********" ; dbsslkey = "/var/db/bacula/.postgres
</span><span class='line'>/postgresql.key"; dbsslcert = "/var/db/bacula/.postgres/postgresql.crt"; dbsslca= "/var/db/bacula/.postgres
</span><span class='line'>/root.crt"
</span><span class='line'>
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>Test the catalog connection</h3>

<p>bacula include a program to verify the bacula catalog &ldquo;dbcheck&rdquo;, the -c switch select the bacula director configuration file the -B switch print out the configuration.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bacula@stafbacula /usr/local]$ dbcheck -c /usr/local/etc/bacula/bacula-dir.conf -B -v
</span><span class='line'>catalog=MyCatalog
</span><span class='line'>db_name=bacula
</span><span class='line'>db_driver=
</span><span class='line'>db_user=bacula
</span><span class='line'>db_password=*******
</span><span class='line'>db_address=stafdb
</span><span class='line'>db_port=0
</span><span class='line'>db_socket=
</span><span class='line'>db_type=PostgreSQL
</span><span class='line'>working_dir=/var/db/bacula
</span><span class='line'>[bacula@stafbacula /usr/local]$ 
</span></code></pre></td></tr></table></div></figure>


<p>For some reason the ssl directives aren&rsquo;t include and the connection fails</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[bacula@stafbacula /usr/local/etc/rc.d]$ dbcheck -c /usr/local/etc/bacula/bacula-dir.conf -v
</span><span class='line'>dbcheck: Fatal Error at dbcheck.c:303 because:
</span><span class='line'>postgresql.c:271 Unable to connect to PostgreSQL server. Database=bacula User=bacula
</span><span class='line'>Possible causes: SQL server not running; password incorrect; max_connections exceeded.
</span><span class='line'>09-Sep 14:22 dbcheck: Fatal Error at dbcheck.c:303 because:
</span><span class='line'>postgresql.c:271 Unable to connect to PostgreSQL server. Database=bacula User=bacula
</span><span class='line'>Possible causes: SQL server not running; password incorrect; max_connections exceeded.
</span><span class='line'>[bacula@stafbacula /usr/local/etc/rc.d]$ 
</span></code></pre></td></tr></table></div></figure>


<p>On our postgres host we get the error message that the bacula host tries to connect without SSL.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>oot@stafdb:/var/db/postgres/data96 # tail -f /var/log/messages
</span><span class='line'>Sep  9 14:22:10 stafdb postgres[14183]: [10-1] FATAL:  connection requires a valid client certificate
</span><span class='line'>Sep  9 14:22:10 stafdb postgres[14184]: [10-1] FATAL:  no pg_hba.conf entry for host "192.168.1.52", user "bacula", database "bacula", SSL off
</span><span class='line'>Sep  9 14:22:15 stafdb postgres[14185]: [10-1] FATAL:  connection requires a valid client certificate
</span><span class='line'>Sep  9 14:22:15 stafdb postgres[14186]: [10-1] FATAL:  no pg_hba.conf entry for host "192.168.1.52", user "bacula", database "bacula", SSL off
</span><span class='line'>Sep  9 14:22:20 stafdb postgres[14187]: [10-1] FATAL:  connection requires a valid client certificate
</span><span class='line'>Sep  9 14:22:20 stafdb postgres[14188]: [10-1] FATAL:  no pg_hba.conf entry for host "192.168.1.52", user "bacula", database "bacula", SSL off
</span><span class='line'>Sep  9 14:22:25 stafdb postgres[14190]: [10-1] FATAL:  connection requires a valid client certificate
</span><span class='line'>Sep  9 14:22:25 stafdb postgres[14191]: [10-1] FATAL:  no pg_hba.conf entry for host "192.168.1.52", user "bacula", database "bacula", SSL off
</span><span class='line'>Sep  9 14:22:30 stafdb postgres[14193]: [10-1] FATAL:  connection requires a valid client certificate
</span><span class='line'>Sep  9 14:22:30 stafdb postgres[14194]: [10-1] FATAL:  no pg_hba.conf entry for host "192.168.1.52", user "bacula", database "bacula", SSL off</span></code></pre></td></tr></table></div></figure>


<p>When set the postgresql varialables with the correct ssl settings the connnection works fine.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[bacula@stafbacula /usr/local/etc/rc.d]$ dbcheck -c /usr/local/etc/bacula/bacula-dir.conf -v
</span><span class='line'>Hello, this is the database check/correct program.
</span><span class='line'>Modify database is off. Verbose is on.
</span><span class='line'>Please select the function you want to perform.
</span><span class='line'>
</span><span class='line'>     1) Toggle modify database flag
</span><span class='line'>     2) Toggle verbose flag
</span><span class='line'>     3) Check for bad Filename records
</span><span class='line'>     4) Check for bad Path records
</span><span class='line'>     5) Check for duplicate Filename records
</span><span class='line'>     6) Check for duplicate Path records
</span><span class='line'>     7) Check for orphaned Jobmedia records
</span><span class='line'>     8) Check for orphaned File records
</span><span class='line'>     9) Check for orphaned Path records
</span><span class='line'>    10) Check for orphaned Filename records
</span><span class='line'>    11) Check for orphaned FileSet records
</span><span class='line'>    12) Check for orphaned Client records
</span><span class='line'>    13) Check for orphaned Job records
</span><span class='line'>    14) Check for all Admin records
</span><span class='line'>    15) Check for all Restore records
</span><span class='line'>    16) All (3-15)
</span><span class='line'>    17) Quit
</span><span class='line'>Select function number: 
</span></code></pre></td></tr></table></div></figure>


<h2>Bacula director</h2>

<h3>Enable the  bacula director</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafbacula:/usr/local/etc/rc.d # sysrc bacula_dir_enable=yes
</span><span class='line'>bacula_dir_enable:  -&gt; yes
</span><span class='line'>root@stafbacula:/usr/local/etc/rc.d # 
</span></code></pre></td></tr></table></div></figure>


<h4>Create the bacula.log</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafbacula:/var/log # touch /var/log/bacula.log
</span><span class='line'>root@stafbacula:/var/log # chown bacula:bacula /var/log/bacula.log</span></code></pre></td></tr></table></div></figure>


<h4>Include the postgreSQL ssl settings in the bacula director startup script</h4>

<p>Update the bacula-dir startup sript to include the ssl settings.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Add the following lines to /etc/rc.conf.local or /etc/rc.conf
</span><span class='line'># to enable this service:
</span><span class='line'>#
</span><span class='line'># bacula_dir_enable  (bool):   Set to NO by default.
</span><span class='line'>#                Set it to YES to enable bacula_dir.
</span><span class='line'># bacula_dir_flags (params):   Set params used to start bacula_dir.
</span><span class='line'>#
</span><span class='line'>
</span><span class='line'>. /etc/rc.subr
</span><span class='line'>. /var/db/bacula/psql_env.sh
</span></code></pre></td></tr></table></div></figure>


<h3>bconsole access</h3>

<p>To test that the catalog works correctly with the director we need to setup bconsole access.
Open the bacula director configuration file.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@stafbacula /usr/local/etc/bacula]# vim bacula-dir.conf</span></code></pre></td></tr></table></div></figure>


<p>And defined and Password</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Director {                            # define myself
</span><span class='line'>  Name = MyBaculaDirector
</span><span class='line'>  DIRport = 9101                # where we listen for UA connections
</span><span class='line'>  QueryFile = "/usr/local/share/bacula/query.sql"
</span><span class='line'>  WorkingDirectory = "/var/db/bacula"
</span><span class='line'>  PidDirectory = "/var/run"
</span><span class='line'>  Maximum Concurrent Jobs = 20
</span><span class='line'>  Password = "*******"         # Console password
</span><span class='line'>  Messages = Daemon
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Open the bconsole configuration file</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@stafbacula /usr/local/etc/bacula]# vi bconsole.conf</span></code></pre></td></tr></table></div></figure>


<p>and setup the same password</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Bacula User Agent (or Console) Configuration File
</span><span class='line'>#
</span><span class='line'># Copyright (C) 2000-2015 Kern Sibbald
</span><span class='line'># License: BSD 2-Clause; see file LICENSE-FOSS
</span><span class='line'>#
</span><span class='line'>
</span><span class='line'>Director {
</span><span class='line'>  Name = MyBaculaDirector
</span><span class='line'>  DIRport = 9101
</span><span class='line'>  address = localhost
</span><span class='line'>  Password = "*****"
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<h3>Start the director &amp; test</h3>

<p>Start the bacula-dir service</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafbacula /usr/local/etc/bacula]# service bacula-dir start
</span><span class='line'>Starting bacula_dir.
</span><span class='line'>[root@stafbacula /usr/local/etc/bacula]# ps aux | grep -i bacula 
</span><span class='line'>bacula 14416  0.0  0.1 51424 6588  -  SsJ  14:40   0:00.12 /usr/local/sbin/bacula-dir -u bacula -g bacula 
</span><span class='line'>root   14420  0.0  0.0 14796 1968  0  R+J  14:40   0:00.00 grep -i bacula
</span><span class='line'>root   13530  0.0  0.0  8300 1596  2  I+J  13:47   0:00.00 tail -f /var/log/bacula.log
</span><span class='line'>[root@stafbacula /usr/local/etc/bacula]#
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>And test the console access</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bacula@stafbacula:/usr/local/etc/bacula % bconsole
</span><span class='line'>Connecting to Director localhost:9101
</span><span class='line'>1000 OK: 102 MyBaculaDirector Version: 7.4.7 (16 March 2017)
</span><span class='line'>Enter a period to cancel a command.
</span><span class='line'>*version
</span><span class='line'>MyBaculaDirector Version: 7.4.7 (16 March 2017) amd64-portbld-freebsd11.0 freebsd 11.0-RELEASE-p12 
</span><span class='line'>You have messages.
</span><span class='line'>*</span></code></pre></td></tr></table></div></figure>


<p>In a next blog post we&rsquo;ll continue with the bacula configuration.</p>

<p style="font-style: italic;">
Have fun!
</p>


<h1>Links</h1>

<ul>
<li>bacula manual: <a href="http://www.bacula.org/9.0.x-manuals/en/main/"><a href="http://www.bacula.org/9.0.x-manuals/en/main/">http://www.bacula.org/9.0.x-manuals/en/main/</a></a></li>
<li><a href="https://dan.langille.org/2015/01/10/bacula-on-freebsd-with-zfs/"><a href="https://dan.langille.org/2015/01/10/bacula-on-freebsd-with-zfs/">https://dan.langille.org/2015/01/10/bacula-on-freebsd-with-zfs/</a></a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Bacula on FreeBSD (Part 1 PostgresSQL in a Jail)]]></title>
    <link href="http://stafwag.github.io/blog/blog/2017/08/06/bacula-on-freebsd:w_part1/"/>
    <updated>2017-08-06T08:43:28+02:00</updated>
    <id>http://stafwag.github.io/blog/blog/2017/08/06/bacula-on-freebsd:w_part1</id>
    <content type="html"><![CDATA[<p>I do take backups; my current solution are couple of shell script wrapper around dump/zfs send/btrfs send/rsync which is a mess.
So decided give <a href="http://www.bacula.org/">bacula</a> a try</p>

<p>I use <a href="http://erdgeist.org/arts/software/ezjail/">ezjail</a> to manage my <a href="https://en.wikipedia.org/wiki/FreeBSD_jail">FreeBSD jails</a>. <a href="https://www.postgresql.org/">PostgresSQL</a> is my favorite database and will use this database as the backend for bacula  and will use this database as the backend for bacula. I want to move all my databases to 1 FreeBSD jail this should make the easier to create reliable database backup in the further. For this reason we&rsquo;ll setup 2 FreeBSD jails 1 for the database and 1 for bacula.</p>

<p>You&rsquo;ll find my journey of installing PostgreSQL on a FreeBSD jail. In another blog post we will continue with the installation of baccula.</p>

<h2>PostgreSQL</h2>

<h3>Jail</h3>

<h4>Create the PostgreSQL Jail</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # ezjail-admin create stafdb "em0|192.168.1.51"
</span><span class='line'>Warning: Some services already seem to be listening on all IP, (including 192.168.1.51)
</span><span class='line'>  This may cause some confusion, here they are:
</span><span class='line'>root     ntpd       754   20 udp6   *:123                 *:*
</span><span class='line'>root     ntpd       754   21 udp4   *:123                 *:*
</span><span class='line'>root     rpc.statd  717   4  udp6   *:640                 *:*
</span><span class='line'>root     rpc.statd  717   5  tcp6   *:640                 *:*
</span><span class='line'>root     rpc.statd  717   6  udp4   *:640                 *:*
</span><span class='line'>root     rpc.statd  717   7  tcp4   *:640                 *:*
</span><span class='line'>root     nfsd       713   5  tcp4   *:2049                *:*
</span><span class='line'>root     nfsd       713   6  tcp6   *:2049                *:*
</span><span class='line'>root     mountd     707   5  udp6   *:753                 *:*
</span><span class='line'>root     mountd     707   6  tcp6   *:753                 *:*
</span><span class='line'>root     mountd     707   7  udp4   *:753                 *:*
</span><span class='line'>root     mountd     707   8  tcp4   *:753                 *:*
</span><span class='line'>root     rpcbind    676   6  udp6   *:111                 *:*
</span><span class='line'>root     rpcbind    676   7  udp6   *:847                 *:*
</span><span class='line'>root     rpcbind    676   8  tcp6   *:111                 *:*
</span><span class='line'>root     rpcbind    676   9  udp4   *:111                 *:*
</span><span class='line'>root     rpcbind    676   10 udp4   *:766                 *:*
</span><span class='line'>root     rpcbind    676   11 tcp4   *:111                 *:*
</span><span class='line'>root     syslogd    657   6  udp6   *:514                 *:*
</span><span class='line'>root     syslogd    657   7  udp4   *:514                 *:*
</span><span class='line'>root@rataplan:~ # </span></code></pre></td></tr></table></div></figure>


<h4>PostgreSQL requires shared memory</h4>

<p>PostgreSQL uses shared memory it&rsquo;s required to set &ldquo;allow.sysvipc=1&rdquo; for the jail. I don&rsquo;t want to enable this globaly since this might be a security risk. Shared memory has permissions set based on the uid enabling sysvipc on a jail might cause the jail to read shared memory from the host system or another jail.</p>

<p>To enable &ldquo;allow.sysvipc=1&rdquo; a jail we can update the ezjail configuration. Ezjail keep the jail configuration in /usr/local/etc/ezjail</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # cd /usr/local/etc/ezjail
</span><span class='line'>root@rataplan:/usr/local/etc/ezjail # ls
</span><span class='line'>stafansible     staffs          stafproxy       staftestbuild
</span><span class='line'>stafdb          stafmail        stafpuppet
</span><span class='line'>root@rataplan:/usr/local/etc/ezjail # </span></code></pre></td></tr></table></div></figure>


<p>Open the database jail file and update the configuration.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:/usr/local/etc/ezjail # vi stafdb</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#
</span><span class='line'># Required to run PostgeSQL in the jail
</span><span class='line'>#
</span><span class='line'>
</span><span class='line'>export jail_stafdb_parameters="allow.sysvipc=1"</span></code></pre></td></tr></table></div></figure>


<h4>Start the database jail</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # ezjail-admin start stafdb
</span><span class='line'>Starting jails: stafdb.
</span><span class='line'>/etc/rc.d/jail: WARNING: Per-jail configuration via jail_* variables  is obsolete.  Please consider migrating to /etc/jail.conf.
</span><span class='line'>root@rataplan:~ #</span></code></pre></td></tr></table></div></figure>


<h4>Console access</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:~ # ezjail-admin console stafdb
</span><span class='line'>FreeBSD 11.0-RELEASE-p9 (GENERIC) #0: Tue Apr 11 08:48:40 UTC 2017
</span><span class='line'>
</span><span class='line'>Welcome to FreeBSD!
</span><span class='line'>
</span><span class='line'>Release Notes, Errata: https://www.FreeBSD.org/releases/
</span><span class='line'>Security Advisories:   https://www.FreeBSD.org/security/
</span><span class='line'>FreeBSD Handbook:      https://www.FreeBSD.org/handbook/
</span><span class='line'>FreeBSD FAQ:           https://www.FreeBSD.org/faq/
</span><span class='line'>Questions List: https://lists.FreeBSD.org/mailman/listinfo/freebsd-questions/
</span><span class='line'>FreeBSD Forums:        https://forums.FreeBSD.org/
</span><span class='line'>
</span><span class='line'>Documents installed with the system are in the /usr/local/share/doc/freebsd/
</span><span class='line'>directory, or can be installed later with:  pkg install en-freebsd-doc
</span><span class='line'>For other languages, replace "en" with a language code like de or fr.
</span><span class='line'>
</span><span class='line'>Show the version of FreeBSD installed:  freebsd-version ; uname -a
</span><span class='line'>Please include that output and any error messages when posting questions.
</span><span class='line'>Introduction to manual pages:  man man
</span><span class='line'>FreeBSD directory layout:      man hier
</span><span class='line'>
</span><span class='line'>Edit /etc/motd to change this login announcement.
</span><span class='line'>root@stafdb:~ # 
</span><span class='line'>root@stafdb:~ # </span></code></pre></td></tr></table></div></figure>


<h3>ProgreSQL installation</h3>

<h4>Install pkg</h4>

<p>Set up dns</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafdb:~ # vi /etc/resolv.conf</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>nameserver 192.168.1.1</span></code></pre></td></tr></table></div></figure>


<p>Bootstrap pkg</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafdb:~ # pkg
</span><span class='line'>The package management tool is not yet installed on your system.
</span><span class='line'>Do you want to fetch and install it now? [y/N]: y
</span><span class='line'>Bootstrapping pkg from pkg+http://pkg.FreeBSD.org/FreeBSD:11:amd64/quarterly, please wait...
</span><span class='line'>Verifying signature with trusted certificate pkg.freebsd.org.2013102301... done
</span><span class='line'>[stafdb] Installing pkg-1.10.1...
</span><span class='line'>[stafdb] Extracting pkg-1.10.1: 100%
</span><span class='line'>pkg: not enough arguments
</span><span class='line'>Usage: pkg [-v] [-d] [-l] [-N] [-j &lt;jail name or id&gt;|-c &lt;chroot path&gt;|-r &lt;rootdir&gt;] [-C &lt;configuration file&gt;] [-R &lt;repo config dir&gt;] [-o var=value] [-4|-6] &lt;command&gt; [&lt;args&gt;]
</span><span class='line'>
</span><span class='line'>For more information on available commands and options see 'pkg help'.
</span><span class='line'>root@stafdb:~ # </span></code></pre></td></tr></table></div></figure>


<h4>Install PostgreSQL</h4>

<p>Search for the latest PostgreSQL server version.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafdb:~ # pkg search postgresql | grep server
</span><span class='line'>pgtcl-postgresql92-2.0.0_1     TCL extension for accessing a PostgreSQL server (PGTCL-NG)
</span><span class='line'>pgtcl-postgresql93-2.0.0_1     TCL extension for accessing a PostgreSQL server (PGTCL-NG)
</span><span class='line'>pgtcl-postgresql94-2.0.0_1     TCL extension for accessing a PostgreSQL server (PGTCL-NG)
</span><span class='line'>pgtcl-postgresql95-2.0.0_1     TCL extension for accessing a PostgreSQL server (PGTCL-NG)
</span><span class='line'>pgtcl-postgresql96-2.0.0_1     TCL extension for accessing a PostgreSQL server (PGTCL-NG)
</span><span class='line'>postgresql92-server-9.2.21_1   PostgreSQL is the most advanced open-source database available anywhere
</span><span class='line'>postgresql93-server-9.3.17_1   PostgreSQL is the most advanced open-source database available anywhere
</span><span class='line'>postgresql94-server-9.4.12_1   PostgreSQL is the most advanced open-source database available anywhere
</span><span class='line'>postgresql95-server-9.5.7_1    PostgreSQL is the most advanced open-source database available anywhere
</span><span class='line'>postgresql96-server-9.6.3_1    PostgreSQL is the most advanced open-source database available anywhere
</span><span class='line'>root@stafdb:~ # </span></code></pre></td></tr></table></div></figure>


<p>Install the PostgreSQL package.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafdb:~ # pkg install postgresql96-server
</span><span class='line'>Updating FreeBSD repository catalogue...
</span><span class='line'>FreeBSD repository is up to date.
</span><span class='line'>All repositories are up to date.
</span><span class='line'>The following 8 package(s) will be affected (of 0 checked):
</span><span class='line'>
</span><span class='line'>New packages to be INSTALLED:
</span><span class='line'>        postgresql96-server: 9.6.3_1
</span><span class='line'>        libxml2: 2.9.4
</span><span class='line'>        icu: 58.2_2,1
</span><span class='line'>        gettext-runtime: 0.19.8.1_1
</span><span class='line'>        indexinfo: 0.2.6
</span><span class='line'>        postgresql96-client: 9.6.3_2
</span><span class='line'>        perl5: 5.24.1_1
</span><span class='line'>        readline: 7.0.3
</span><span class='line'>
</span><span class='line'>Number of packages to be installed: 8
</span><span class='line'>
</span><span class='line'>The process will require 131 MiB more space.
</span><span class='line'>30 MiB to be downloaded.
</span><span class='line'>
</span><span class='line'>Proceed with this action? [y/N]: y
</span><span class='line'>[stafdb] [1/8] Fetching postgresql96-server-9.6.3_1.txz: 100%    4 MiB 357.1kB/s    00:11    
</span><span class='line'>[stafdb] [2/8] Fetching libxml2-2.9.4.txz: 100%  802 KiB 410.4kB/s    00:02    
</span><span class='line'>[stafdb] [3/8] Fetching icu-58.2_2,1.txz: 100%    9 MiB 313.3kB/s    00:30    
</span><span class='line'>[stafdb] [4/8] Fetching gettext-runtime-0.19.8.1_1.txz: 100%  147 KiB 151.0kB/s    00:01    
</span><span class='line'>[stafdb] [5/8] Fetching indexinfo-0.2.6.txz: 100%    5 KiB   5.3kB/s    00:01    
</span><span class='line'>[stafdb] [6/8] Fetching postgresql96-client-9.6.3_2.txz: 100%    2 MiB 300.0kB/s    00:08    
</span><span class='line'>[stafdb] [7/8] Fetching perl5-5.24.1_1.txz: 100%   13 MiB 341.5kB/s    00:41    
</span><span class='line'>[stafdb] [8/8] Fetching readline-7.0.3.txz: 100%  334 KiB 342.3kB/s    00:01    
</span><span class='line'>Checking integrity... done (0 conflicting)
</span><span class='line'>[stafdb] [1/8] Installing indexinfo-0.2.6...
</span><span class='line'>[stafdb] [1/8] Extracting indexinfo-0.2.6: 100%
</span><span class='line'>[stafdb] [2/8] Installing gettext-runtime-0.19.8.1_1...
</span><span class='line'>[stafdb] [2/8] Extracting gettext-runtime-0.19.8.1_1: 100%
</span><span class='line'>[stafdb] [3/8] Installing perl5-5.24.1_1...
</span><span class='line'>[stafdb] [3/8] Extracting perl5-5.24.1_1: 100%
</span><span class='line'>[stafdb] [4/8] Installing readline-7.0.3...
</span><span class='line'>[stafdb] [4/8] Extracting readline-7.0.3: 100%
</span><span class='line'>[stafdb] [5/8] Installing libxml2-2.9.4...
</span><span class='line'>[stafdb] [5/8] Extracting libxml2-2.9.4: 100%
</span><span class='line'>[stafdb] [6/8] Installing icu-58.2_2,1...
</span><span class='line'>[stafdb] [6/8] Extracting icu-58.2_2,1: 100%
</span><span class='line'>[stafdb] [7/8] Installing postgresql96-client-9.6.3_2...
</span><span class='line'>[stafdb] [7/8] Extracting postgresql96-client-9.6.3_2: 100%
</span><span class='line'>[stafdb] [8/8] Installing postgresql96-server-9.6.3_1...
</span><span class='line'>===&gt; Creating groups.
</span><span class='line'>Creating group 'postgres' with gid '770'.
</span><span class='line'>===&gt; Creating users
</span><span class='line'>Creating user 'postgres' with uid '770'.
</span><span class='line'>
</span><span class='line'>  =========== BACKUP YOUR DATA! =============
</span><span class='line'>  As always, backup your data before
</span><span class='line'>  upgrading. If the upgrade leads to a higher
</span><span class='line'>  minor revision (e.g. 8.3.x -&gt; 8.4), a dump
</span><span class='line'>  and restore of all databases is
</span><span class='line'>  required. This is *NOT* done by the port!
</span><span class='line'>  ===========================================
</span><span class='line'>[stafdb] Extracting postgresql96-server-9.6.3_1: 100%
</span><span class='line'>Message from perl5-5.24.1_1:
</span><span class='line'>The /usr/bin/perl symlink has been removed starting with Perl 5.20.
</span><span class='line'>For shebangs, you should either use:
</span><span class='line'>
</span><span class='line'>#!/usr/local/bin/perl
</span><span class='line'>
</span><span class='line'>or
</span><span class='line'>
</span><span class='line'>#!/usr/bin/env perl
</span><span class='line'>
</span><span class='line'>The first one will only work if you have a /usr/local/bin/perl,
</span><span class='line'>the second will work as long as perl is in PATH.
</span><span class='line'>Message from postgresql96-client-9.6.3_2:
</span><span class='line'>The PostgreSQL port has a collection of "side orders":
</span><span class='line'>
</span><span class='line'>postgresql-docs
</span><span class='line'>  For all of the html documentation
</span><span class='line'>
</span><span class='line'>p5-Pg
</span><span class='line'>  A perl5 API for client access to PostgreSQL databases.
</span><span class='line'>
</span><span class='line'>postgresql-tcltk 
</span><span class='line'>  If you want tcl/tk client support.
</span><span class='line'>
</span><span class='line'>postgresql-jdbc
</span><span class='line'>  For Java JDBC support.
</span><span class='line'>
</span><span class='line'>postgresql-odbc
</span><span class='line'>  For client access from unix applications using ODBC as access
</span><span class='line'>  method. Not needed to access unix PostgreSQL servers from Win32
</span><span class='line'>  using ODBC. See below.
</span><span class='line'>
</span><span class='line'>ruby-postgres, py-PyGreSQL
</span><span class='line'>  For client access to PostgreSQL databases using the ruby & python
</span><span class='line'>  languages.
</span><span class='line'>
</span><span class='line'>postgresql-plperl, postgresql-pltcl & postgresql-plruby
</span><span class='line'>  For using perl5, tcl & ruby as procedural languages.
</span><span class='line'>
</span><span class='line'>postgresql-contrib
</span><span class='line'>  Lots of contributed utilities, postgresql functions and
</span><span class='line'>  datatypes. There you find pg_standby, pgcrypto and many other cool
</span><span class='line'>  things.
</span><span class='line'>
</span><span class='line'>etc...
</span><span class='line'>Message from postgresql96-server-9.6.3_1:
</span><span class='line'>For procedural languages and postgresql functions, please note that
</span><span class='line'>you might have to update them when updating the server.
</span><span class='line'>
</span><span class='line'>If you have many tables and many clients running, consider raising
</span><span class='line'>kern.maxfiles using sysctl(8), or reconfigure your kernel
</span><span class='line'>appropriately.
</span><span class='line'>
</span><span class='line'>The port is set up to use autovacuum for new databases, but you might
</span><span class='line'>also want to vacuum and perhaps backup your database regularly. There
</span><span class='line'>is a periodic script, /usr/local/etc/periodic/daily/502.pgsql, that
</span><span class='line'>you may find useful. You can use it to backup and perform vacuum on all
</span><span class='line'>databases nightly. Per default, it performs `vacuum analyze'. See the
</span><span class='line'>script for instructions. For autovacuum settings, please review
</span><span class='line'>~pgsql/data/postgresql.conf.
</span><span class='line'>
</span><span class='line'>If you plan to access your PostgreSQL server using ODBC, please
</span><span class='line'>consider running the SQL script /usr/local/share/postgresql/odbc.sql
</span><span class='line'>to get the functions required for ODBC compliance.
</span><span class='line'>
</span><span class='line'>Please note that if you use the rc script,
</span><span class='line'>/usr/local/etc/rc.d/postgresql, to initialize the database, unicode
</span><span class='line'>(UTF-8) will be used to store character data by default.  Set
</span><span class='line'>postgresql_initdb_flags or use login.conf settings described below to
</span><span class='line'>alter this behaviour. See the start rc script for more info.
</span><span class='line'>
</span><span class='line'>To set limits, environment stuff like locale and collation and other
</span><span class='line'>things, you can set up a class in /etc/login.conf before initializing
</span><span class='line'>the database. Add something similar to this to /etc/login.conf:
</span><span class='line'>---
</span><span class='line'>postgres:\
</span><span class='line'>        :lang=en_US.UTF-8:\
</span><span class='line'>        :setenv=LC_COLLATE=C:\
</span><span class='line'>        :tc=default:
</span><span class='line'>---
</span><span class='line'>and run `cap_mkdb /etc/login.conf'.
</span><span class='line'>Then add 'postgresql_class="postgres"' to /etc/rc.conf.
</span><span class='line'>
</span><span class='line'>======================================================================
</span><span class='line'>
</span><span class='line'>To initialize the database, run
</span><span class='line'>
</span><span class='line'>  /usr/local/etc/rc.d/postgresql initdb
</span><span class='line'>
</span><span class='line'>You can then start PostgreSQL by running:
</span><span class='line'>
</span><span class='line'>  /usr/local/etc/rc.d/postgresql start
</span><span class='line'>
</span><span class='line'>For postmaster settings, see ~pgsql/data/postgresql.conf
</span><span class='line'>
</span><span class='line'>NB. FreeBSD's PostgreSQL port logs to syslog by default
</span><span class='line'>    See ~pgsql/data/postgresql.conf for more info
</span><span class='line'>
</span><span class='line'>======================================================================
</span><span class='line'>
</span><span class='line'>To run PostgreSQL at startup, add
</span><span class='line'>'postgresql_enable="YES"' to /etc/rc.conf</span></code></pre></td></tr></table></div></figure>


<p>Enable the postgresql daemon at the jail startup</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafdb:~ # sysrc postgresql_enable="YES"
</span><span class='line'>postgresql_enable:  -&gt; YES
</span><span class='line'>root@stafdb:~ # grep postgresql_enable /etc/rc.conf
</span><span class='line'>postgresql_enable="YES"
</span><span class='line'>root@stafdb:~ # </span></code></pre></td></tr></table></div></figure>


<p>Initialize the database</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafdb:~ # service postgresql initdb
</span><span class='line'>The files belonging to this database system will be owned by user "postgres".
</span><span class='line'>This user must also own the server process.
</span><span class='line'>
</span><span class='line'>The database cluster will be initialized with locale "C".
</span><span class='line'>The default text search configuration will be set to "english".
</span><span class='line'>
</span><span class='line'>Data page checksums are disabled.
</span><span class='line'>
</span><span class='line'>creating directory /var/db/postgres/data96 ... ok
</span><span class='line'>creating subdirectories ... ok
</span><span class='line'>selecting default max_connections ... 100
</span><span class='line'>selecting default shared_buffers ... 128MB
</span><span class='line'>selecting dynamic shared memory implementation ... posix
</span><span class='line'>creating configuration files ... ok
</span><span class='line'>running bootstrap script ... ok
</span><span class='line'>performing post-bootstrap initialization ... ok
</span><span class='line'>syncing data to disk ... ok
</span><span class='line'>
</span><span class='line'>WARNING: enabling "trust" authentication for local connections
</span><span class='line'>You can change this by editing pg_hba.conf or using the option -A, or
</span><span class='line'>--auth-local and --auth-host, the next time you run initdb.
</span><span class='line'>
</span><span class='line'>Success. You can now start the database server using:
</span><span class='line'>
</span><span class='line'>    /usr/local/bin/pg_ctl -D /var/db/postgres/data96 -l logfile start
</span><span class='line'>
</span><span class='line'>root@stafdb:~ # </span></code></pre></td></tr></table></div></figure>


<p>Start the database</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Droot@stafdb:~ # service postgresql start
</span><span class='line'>LOG:  could not create IPv6 socket: Protocol not supported
</span><span class='line'>LOG:  ending log output to stderr
</span><span class='line'>HINT:  Future log output will go to log destination "syslog".
</span><span class='line'>root@stafdb:~ # </span></code></pre></td></tr></table></div></figure>


<p>Verify the database</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafdb:~ # su - postgres                                                                                                   
</span><span class='line'>$ psql -l                                                                                                                       
</span><span class='line'>psql: could not connect to server: No such file or directory                                                                    
</span><span class='line'>        Is the server running locally and accepting                                                                             
</span><span class='line'>        connections on Unix domain socket "/tmp/.s.PGSQL.5432"?                                                                 
</span><span class='line'>$ ^Droot@stafdb:~ # service postgresql start
</span><span class='line'>LOG:  could not create IPv6 socket: Protocol not supported                                                                      
</span><span class='line'>LOG:  ending log output to stderr                                                                                               
</span><span class='line'>HINT:  Future log output will go to log destination "syslog".                                                                   
</span><span class='line'>root@stafdb:~ # su - postgres
</span><span class='line'>$ psql -l
</span><span class='line'>                             List of databases
</span><span class='line'>   Name    |  Owner   | Encoding | Collate | Ctype |   Access privileges   
</span><span class='line'>-----------+----------+----------+---------+-------+-----------------------
</span><span class='line'> postgres  | postgres | UTF8     | C       | C     | 
</span><span class='line'> template0 | postgres | UTF8     | C       | C     | =c/postgres          +
</span><span class='line'>           |          |          |         |       | postgres=CTc/postgres
</span><span class='line'> template1 | postgres | UTF8     | C       | C     | =c/postgres          +
</span><span class='line'>           |          |          |         |       | postgres=CTc/postgres
</span><span class='line'>(3 rows)
</span><span class='line'>
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>




<p style="font-style: italic;">
Have fun!
</p>


<h1>Links</h1>

<ul>
<li><a href="https://dan.langille.org/2015/01/10/bacula-on-freebsd-with-zfs/">https://dan.langille.org/2015/01/10/bacula-on-freebsd-with-zfs/</a></li>
<li><a href="https://cwharton.com/blog/2016/10/postgresql-and-freebsd-quick-start/">https://cwharton.com/blog/2016/10/postgresql-and-freebsd-quick-start/</a></li>
<li><a href="https://dan.langille.org/2013/07/09/fatal-could-not-create-shared-memory-segment-function-not-implemented/">https://dan.langille.org/2013/07/09/fatal-could-not-create-shared-memory-segment-function-not-implemented/</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Install Parabola GNU/Linux on an Encrypted Btrfs Logical Volume]]></title>
    <link href="http://stafwag.github.io/blog/blog/2017/05/25/install-parabola-gnu-slash-linux-on-an-encrypted-btrfs-logical-volume/"/>
    <updated>2017-05-25T09:05:38+02:00</updated>
    <id>http://stafwag.github.io/blog/blog/2017/05/25/install-parabola-gnu-slash-linux-on-an-encrypted-btrfs-logical-volume</id>
    <content type="html"><![CDATA[<p><img class="left" src="http://stafwag.github.io/blog/images/413px-Gnu10-mascot-logo_100ppi.png" width="200" height="291" title="&#34;413px-Gnu10-mascot-logo_100ppi.png&#34;" alt="&#34;413px-Gnu10-mascot-logo_100ppi.png&#34;"></p>

<p>I finally found time to complete the installation of my <a href="http://stafwag.github.io/blog/blog/2017/02/11/how-to-install-libreboot-on-a-thinkpad-x60/">Libreboot laptop</a></p>

<p>I decided to give <a href="https://www.parabola.nu/">Parabola GNU/Linux</a> a try as my daily driver to get a fully <a href="https://en.wikipedia.org/wiki/Free_software">Free Software</a> Laptop/tablet.</p>

<h2>Download the Parabola GNU/Linux iso and boot it</h2>

<p>After Parabola GNU/Linux is booted verify that you have internet access if the network card is support and dhcp is enabled on you network you should get a network address.</p>

<h2>Network access</h2>

<p>To setup the system remotely we first need to setup network to our system.</p>

<h3>Verify the interface</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>1 root@parabolaiso ~ # ip a
</span><span class='line'>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1
</span><span class='line'>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span><span class='line'>    inet 127.0.0.1/8 scope host lo
</span><span class='line'>       valid_lft forever preferred_lft forever
</span><span class='line'>    inet6 ::1/128 scope host 
</span><span class='line'>       valid_lft forever preferred_lft forever
</span><span class='line'>2: enp1s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
</span><span class='line'>    link/ether 00:16:d3:b7:3a:96 brd ff:ff:ff:ff:ff:ff
</span><span class='line'>    inet 192.168.1.11/24 brd 192.168.1.255 scope global enp1s0
</span><span class='line'>       valid_lft forever preferred_lft forever
</span><span class='line'>    inet6 fe80::e5db:c85f:4478:1f44/64 scope link 
</span><span class='line'>       valid_lft forever preferred_lft forever
</span><span class='line'>3: wlp2s0: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000
</span><span class='line'>    link/ether 00:1b:77:4d:5a:57 brd ff:ff:ff:ff:ff:ff
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h3>Verify internet access</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # ping -c 3 www.google.be
</span><span class='line'>PING www.google.be (172.217.17.67) 56(84) bytes of data.
</span><span class='line'>64 bytes from ams16s30-in-f3.1e100.net (172.217.17.67): icmp_seq=1 ttl=56 time=91.3 ms
</span><span class='line'>64 bytes from ams16s30-in-f3.1e100.net (172.217.17.67): icmp_seq=2 ttl=56 time=48.7 ms
</span><span class='line'>64 bytes from ams16s30-in-f3.1e100.net (172.217.17.67): icmp_seq=3 ttl=56 time=47.9 ms
</span><span class='line'>
</span><span class='line'>--- www.google.be ping statistics ---
</span><span class='line'>3 packets transmitted, 3 received, 0% packet loss, time 2003ms
</span><span class='line'>rtt min/avg/max/mdev = 47.998/62.714/91.366/20.264 ms
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h2>ssh access</h2>

<p>If you want to install Parabola GNU/Linux over ssh you need to assign a root passwd and start the sshd service.</p>

<h3>root password</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # passwd root
</span><span class='line'>New password: 
</span><span class='line'>Retype new password: 
</span><span class='line'>passwd: password updated successfully
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h3>create a user account</h3>

<p>Parabola doesn&rsquo;t allow remote ssh root logons. Create a new account to access the system remotely.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # useradd install
</span><span class='line'>root@parabolaiso ~ # passwd install
</span><span class='line'>New password: 
</span><span class='line'>Retype new password: 
</span><span class='line'>passwd: password updated successfully
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h3>start sshd</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # systemctl start sshd
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h3>Logon remotely</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ ssh install@petronella 
</span><span class='line'>install@petronella's password: 
</span><span class='line'>
</span><span class='line'>===============================================================================
</span><span class='line'>                                                                          
</span><span class='line'>         Parabola live media 2016.11.03                                
</span><span class='line'>                                                                          
</span><span class='line'>    To install Parabola, the system must be connected to the internet.    
</span><span class='line'>    For instructions, enter this command:                                 
</span><span class='line'>      lynx network.html                                           
</span><span class='line'>                                                                          
</span><span class='line'>    Press the number keys while holding Alt to switch virtual terminals.  
</span><span class='line'>    This allows entering commands without closing lynx.                   
</span><span class='line'>                                                                          
</span><span class='line'>===============================================================================
</span><span class='line'>
</span><span class='line'>Could not chdir to home directory /home/install: No such file or directory
</span><span class='line'>[install@parabolaiso /]$ su -
</span><span class='line'>Password: 
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h2>Partition your harddisk</h2>

<h3>Find your harddisk device name</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # lsblk -o NAME,VENDOR,MODEL,TYPE,SIZE 
</span><span class='line'>NAME                  VENDOR   MODEL            TYPE   SIZE
</span><span class='line'>loop1                                           loop   1.9G
</span><span class='line'>`-parabola_root-image                           dm     1.9G
</span><span class='line'>sdb                   ATA      OCZ-VERTEX2      disk 107.1G
</span><span class='line'>`-sdb1                                          part 107.1G
</span><span class='line'>loop2                                           loop   1.9G
</span><span class='line'>`-parabola_root-image                           dm     1.9G
</span><span class='line'>loop0                                           loop 269.7M
</span><span class='line'>sda                   Kingston DataTraveler 2.0 disk   7.2G
</span><span class='line'>|-sda2                                          part    31M
</span><span class='line'>`-sda1                                          part   613M
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h3>Overwrite it with random data</h3>

<p>Because we are creating an ecrypted filesystem it&rsquo;s a good idea to overwrite it with random data.</p>

<p>We&rsquo;ll use badblocks for this another method is to use &ldquo;dd if=/dev/random of=/dev/xxx&rdquo; the &ldquo;dd&rdquo; method is probably the best method but is a lot slower.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # badblocks -c 10240 -s -w -t random -v /dev/sdb
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Checking for bad blocks in read-write mode
</span><span class='line'>From block 0 to 112337063
</span><span class='line'>Testing with random pattern: done                                                 
</span><span class='line'>Reading and comparing: done                                                 
</span><span class='line'>Pass completed, 0 bad blocks found. (0/0/0 errors)
</span><span class='line'>badblocks -c 10240 -s -w -t random -v /dev/sdb  82.82s user 20.08s system 3% cpu 48:12.29 total
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h3>Partition the harddisk</h3>

<p>We&rsquo;ll use lvm is this setup, while it should be possible to  boot from an encrypted partition with Libreboot partition I create a small unencrypted boot partition.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # fdisk /dev/sdb
</span><span class='line'>
</span><span class='line'>Welcome to fdisk (util-linux 2.28.2).
</span><span class='line'>Changes will remain in memory only, until you decide to write them.
</span><span class='line'>Be careful before using the write command.
</span><span class='line'>
</span><span class='line'>Device does not contain a recognized partition table.
</span><span class='line'>Created a new DOS disklabel with disk identifier 0x2640923c.
</span><span class='line'>
</span><span class='line'>Command (m for help): p
</span><span class='line'>Disk /dev/sdb: 107.1 GiB, 115033153536 bytes, 224674128 sectors
</span><span class='line'>Units: sectors of 1 * 512 = 512 bytes
</span><span class='line'>Sector size (logical/physical): 512 bytes / 512 bytes
</span><span class='line'>I/O size (minimum/optimal): 512 bytes / 512 bytes
</span><span class='line'>Disklabel type: dos
</span><span class='line'>Disk identifier: 0x2640923c
</span><span class='line'>
</span><span class='line'>Command (m for help): n
</span><span class='line'>Partition type
</span><span class='line'>   p   primary (0 primary, 0 extended, 4 free)
</span><span class='line'>   e   extended (container for logical partitions)
</span><span class='line'>Select (default p): p
</span><span class='line'>Partition number (1-4, default 1): 
</span><span class='line'>First sector (2048-224674127, default 2048): 
</span><span class='line'>Last sector, +sectors or +size{K,M,G,T,P} (2048-224674127, default 224674127): +1G
</span><span class='line'>
</span><span class='line'>Created a new partition 1 of type 'Linux' and of size 1 GiB.
</span><span class='line'>
</span><span class='line'>Command (m for help): n
</span><span class='line'>Partition type
</span><span class='line'>   p   primary (1 primary, 0 extended, 3 free)
</span><span class='line'>   e   extended (container for logical partitions)
</span><span class='line'>Select (default p): p
</span><span class='line'>Partition number (2-4, default 2): 
</span><span class='line'>First sector (2099200-224674127, default 2099200): 
</span><span class='line'>Last sector, +sectors or +size{K,M,G,T,P} (2099200-224674127, default 224674127): 
</span><span class='line'>
</span><span class='line'>Created a new partition 2 of type 'Linux' and of size 106.1 GiB.
</span><span class='line'>
</span><span class='line'>Command (m for help): p
</span><span class='line'>Disk /dev/sdb: 107.1 GiB, 115033153536 bytes, 224674128 sectors
</span><span class='line'>Units: sectors of 1 * 512 = 512 bytes
</span><span class='line'>Sector size (logical/physical): 512 bytes / 512 bytes
</span><span class='line'>I/O size (minimum/optimal): 512 bytes / 512 bytes
</span><span class='line'>Disklabel type: dos
</span><span class='line'>Disk identifier: 0x2640923c
</span><span class='line'>
</span><span class='line'>Device     Boot   Start       End   Sectors   Size Id Type
</span><span class='line'>/dev/sdb1          2048   2099199   2097152     1G 83 Linux
</span><span class='line'>/dev/sdb2       2099200 224674127 222574928 106.1G 83 Linux
</span><span class='line'>
</span><span class='line'>Command (m for help): w
</span><span class='line'>The partition table has been altered.
</span><span class='line'>Calling ioctl() to re-read partition table.
</span><span class='line'>Syncing disks.
</span><span class='line'>
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h3>Encrypt the LVM physical volume</h3>

<h4>Benchmark</h4>

<p>We bechmark the encryption to decide which encryption we&rsquo;ll use.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # cryptsetup benchmark
</span><span class='line'># Tests are approximate using memory only (no storage IO).
</span><span class='line'>PBKDF2-sha1       382134 iterations per second for 256-bit key
</span><span class='line'>PBKDF2-sha256     479239 iterations per second for 256-bit key
</span><span class='line'>PBKDF2-sha512     347671 iterations per second for 256-bit key
</span><span class='line'>PBKDF2-ripemd160  319687 iterations per second for 256-bit key
</span><span class='line'>PBKDF2-whirlpool  221032 iterations per second for 256-bit key
</span><span class='line'>#  Algorithm | Key |  Encryption |  Decryption
</span><span class='line'>     aes-cbc   128b    79.1 MiB/s    93.9 MiB/s
</span><span class='line'> serpent-cbc   128b    30.0 MiB/s   112.0 MiB/s
</span><span class='line'> twofish-cbc   128b    77.5 MiB/s   102.5 MiB/s
</span><span class='line'>     aes-cbc   256b    62.7 MiB/s    71.0 MiB/s
</span><span class='line'> serpent-cbc   256b    30.0 MiB/s   111.9 MiB/s
</span><span class='line'> twofish-cbc   256b    77.5 MiB/s   102.4 MiB/s
</span><span class='line'>     aes-xts   256b    93.0 MiB/s    93.3 MiB/s
</span><span class='line'> serpent-xts   256b   100.3 MiB/s   104.5 MiB/s
</span><span class='line'> twofish-xts   256b    93.8 MiB/s    95.0 MiB/s
</span><span class='line'>     aes-xts   512b    70.5 MiB/s    70.7 MiB/s
</span><span class='line'> serpent-xts   512b   100.3 MiB/s   104.4 MiB/s
</span><span class='line'> twofish-xts   512b    93.9 MiB/s    94.9 MiB/s
</span><span class='line'>cryptsetup benchmark  3.91s user 24.02s system 99% cpu 28.093 total
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h4>Create Luks volume</h4>

<p>The serpent xts with a 512 bits keys seems to give a pretty good performance while sha256 hashing gives the best performance.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # cryptsetup luksFormat --cipher serpent-xts-plain64 --key-size 512 --hash sha256 --use-random /dev/sdb2 
</span><span class='line'>
</span><span class='line'>WARNING!
</span><span class='line'>========
</span><span class='line'>This will overwrite data on /dev/sdb2 irrevocably.
</span><span class='line'>
</span><span class='line'>Are you sure? (Type uppercase yes): YES
</span><span class='line'>Enter passphrase: 
</span><span class='line'>Verify passphrase: 
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h2>LVM setup</h2>

<h3>Create the volumes</h3>

<h4>Open the LUKS volume</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ #  cryptsetup luksOpen /dev/sdb2 pv
</span><span class='line'>Enter passphrase for /dev/sdb2: 
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<p>This create /dev/mapper/pv</p>

<h4>Create the physical volume</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # pvcreate /dev/mapper/pv                 
</span><span class='line'>  Physical volume "/dev/mapper/pv" successfully created.
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<p>Show the pv</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # pvs
</span><span class='line'>  PV             VG Fmt  Attr PSize   PFree  
</span><span class='line'>  /dev/mapper/pv    lvm2 ---  106.13g 106.13g
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h4>Create the volume group</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # vgcreate vg /dev/mapper/pv
</span><span class='line'>  Volume group "vg" successfully created
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<p>Show the created volume group</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # vgs
</span><span class='line'>  VG #PV #LV #SN Attr   VSize   VFree  
</span><span class='line'>  vg   1   0   0 wz--n- 106.13g 106.13g
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h4>Create the swap logical volume</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # lvcreate -L 4G vg -n lv_swap 
</span><span class='line'>  Logical volume "lv_swap" created.
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h4>Create the root logical volume</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # lvcreate -L 20G vg -n lv_root   
</span><span class='line'>  Logical volume "lv_root" created.
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h4>Display the create logical volumes</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # lvs
</span><span class='line'>  LV      VG Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
</span><span class='line'>  lv_root vg -wi-a----- 20.00g                                                    
</span><span class='line'>  lv_swap vg -wi-a-----  4.00g                                                    
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h3>Format the logical volumes</h3>

<h4>Create the swapspace</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # mkswap /dev/mapper/vg-lv_swap       
</span><span class='line'>Setting up swapspace version 1, size = 4 GiB (4294963200 bytes)
</span><span class='line'>no label, UUID=32f6e5d4-67a3-42e3-8a90-6ee3ae0fdaa3
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<p>And activate it;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # swapon /dev/mapper/vg-lv_swap       
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h4>Create the root filesystem</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # mkfs.btrfs /dev/mapper/vg-lv_root       
</span><span class='line'>btrfs-progs v4.8.2
</span><span class='line'>See http://btrfs.wiki.kernel.org for more information.
</span><span class='line'>
</span><span class='line'>Detected a SSD, turning off metadata duplication.  Mkfs with -m dup if you want to force metadata duplication.
</span><span class='line'>Label:              (null)
</span><span class='line'>UUID:               
</span><span class='line'>Node size:          16384
</span><span class='line'>Sector size:        4096
</span><span class='line'>Filesystem size:    20.00GiB
</span><span class='line'>Block group profiles:
</span><span class='line'>  Data:             single            8.00MiB
</span><span class='line'>  Metadata:         single            8.00MiB
</span><span class='line'>  System:           single            4.00MiB
</span><span class='line'>SSD detected:       yes
</span><span class='line'>Incompat features:  extref, skinny-metadata
</span><span class='line'>Number of devices:  1
</span><span class='line'>Devices:
</span><span class='line'>   ID        SIZE  PATH
</span><span class='line'>    1    20.00GiB  /dev/mapper/vg-lv_root
</span><span class='line'>
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h4>Create the boot filesystem</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # mkfs.ext2 /dev/sdb1 
</span><span class='line'>mke2fs 1.43.3 (04-Sep-2016)
</span><span class='line'>Discarding device blocks: done                            
</span><span class='line'>Creating filesystem with 262144 4k blocks and 65536 inodes
</span><span class='line'>Filesystem UUID: e3fd741d-d0e0-483f-a9cd-3fbd3f9d66d1
</span><span class='line'>Superblock backups stored on blocks: 
</span><span class='line'>        32768, 98304, 163840, 229376
</span><span class='line'>
</span><span class='line'>Allocating group tables: done                            
</span><span class='line'>Writing inode tables: done                            
</span><span class='line'>Writing superblocks and filesystem accounting information: done
</span><span class='line'>
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h4>Mount the filesystems</h4>

<p>Mount the root filesystem;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # 
</span><span class='line'>root@parabolaiso ~ # mount -o noatime,compress=lzo,discard,ssd,defaults /dev/mapper/vg-lv_root /mnt
</span><span class='line'>root@parabolaiso ~ # 
</span></code></pre></td></tr></table></div></figure>


<p>Create the /home and /boot directories</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # mkdir -p /mnt/{boot,home}</span></code></pre></td></tr></table></div></figure>


<p>Mount the boot filesystem</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # mount /dev/sdb1 /mnt/boot
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<p>Show;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # df -h
</span><span class='line'>Filesystem                       Size  Used Avail Use% Mounted on
</span><span class='line'>dev                              1.6G     0  1.6G   0% /dev
</span><span class='line'>run                              1.6G   26M  1.6G   2% /run
</span><span class='line'>/dev/sda1                        613M  613M     0 100% /run/parabolaiso/bootmnt
</span><span class='line'>cowspace                         2.4G  8.9M  2.4G   1% /run/parabolaiso/cowspace
</span><span class='line'>/dev/loop0                       270M  270M     0 100% /run/parabolaiso/sfs/root-image
</span><span class='line'>/dev/mapper/parabola_root-image  1.9G  885M 1003M  47% /
</span><span class='line'>tmpfs                            1.6G     0  1.6G   0% /dev/shm
</span><span class='line'>tmpfs                            1.6G     0  1.6G   0% /sys/fs/cgroup
</span><span class='line'>tmpfs                            1.6G     0  1.6G   0% /tmp
</span><span class='line'>tmpfs                            1.6G  1.6M  1.6G   1% /etc/pacman.d/gnupg
</span><span class='line'>tmpfs                            320M     0  320M   0% /run/user/0
</span><span class='line'>tmpfs                            320M     0  320M   0% /run/user/1001
</span><span class='line'>/dev/mapper/vg-lv_root            20G   17M   20G   1% /mnt
</span><span class='line'>/dev/sdb1                       1008M  1.3M  956M   1% /mnt/boot
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h2>System installation</h2>

<h3>boostrap the system</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # pacstrap /mnt base base-devel btrfs-progs
</span><span class='line'>==&gt; Creating install root at /mnt
</span><span class='line'>==&gt; Installing packages to /mnt
</span><span class='line'>:: Synchronizing package databases...
</span><span class='line'> libre                                              437.7 KiB   228K/s 00:02 [############################################] 100%
</span><span class='line'> core                                               111.1 KiB   280K/s 00:00 [############################################] 100%
</span><span class='line'> extra                                             1535.4 KiB   544K/s 00:03 [############################################] 100%
</span><span class='line'> community                                            3.6 MiB   615K/s 00:06 [############################################] 100%
</span><span class='line'> pcr                                                620.0 KiB   662K/s 00:01 [############################################] 100%
</span><span class='line'>:: There are 52 members in group base:
</span><span class='line'>:: Repository libre
</span><span class='line'>   1) filesystem  2) licenses  3) linux-libre  4) pacman  5) pacman-mirrorlist  6) systemd-sysvcompat  7) your-freedom
</span><span class='line'>:: Repository core
</span><span class='line'>   8) bash  9) bzip2  10) coreutils  11) cryptsetup  12) device-mapper  13) dhcpcd  14) diffutils  15) e2fsprogs  16) file
</span><span class='line'>   17) findutils  18) gawk  19) gcc-libs  20) gettext  21) glibc  22) grep  23) gzip  24) inetutils  25) iproute2  26) iputils
</span><span class='line'>   27) jfsutils  28) less  29) logrotate  30) lvm2  31) man-db  32) man-pages  33) mdadm  34) nano  35) netctl  36) pciutils
</span><span class='line'>   37) pcmciautils  38) perl  39) procps-ng  40) psmisc  41) reiserfsprogs  42) s-nail  43) sed  44) shadow  45) sysfsutils
</span><span class='line'>   46) tar  47) texinfo  48) usbutils  49) util-linux  50) vi  51) which  52) xfsprogs
</span><span class='line'>
</span><span class='line'>Enter a selection (default=all): </span></code></pre></td></tr></table></div></figure>


<p>&lt; snip &gt;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(2/7) Updating udev hardware database...
</span><span class='line'>(3/7) Updating system user accounts...
</span><span class='line'>(4/7) Creating temporary files...
</span><span class='line'>(5/7) Arming ConditionNeedsUpdate...
</span><span class='line'>(6/7) Updating the info directory file...
</span><span class='line'>(7/7) Rebuilding certificate stores...
</span><span class='line'>pacstrap /mnt base base-devel btrfs-progs  62.07s user 14.31s system 1% cpu 1:13:22.44 total
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h3>Generate /etc/fstab</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ #
</span><span class='line'>root@parabolaiso ~ # genfstab -U -p /mnt  &gt;&gt; /mnt/etc/fstab
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<p>review</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # cat /mnt/etc/fstab
</span><span class='line'># 
</span><span class='line'># /etc/fstab: static file system information
</span><span class='line'>#
</span><span class='line'># &lt;file system&gt; &lt;dir&gt;   &lt;type&gt;  &lt;options&gt;       &lt;dump&gt;  &lt;pass&gt;
</span><span class='line'># UUID=3731a69b-7240-4618-8e5e-4684d7e719e3
</span><span class='line'># /dev/mapper/vg-lv_root
</span><span class='line'>UUID=3731a69b-7240-4618-8e5e-4684d7e719e3       /               btrfs           rw,relatime,ssd,space_cache,subvolid=5,subvol=/0 0
</span><span class='line'>
</span><span class='line'># /dev/sdb1
</span><span class='line'>UUID=e3fd741d-d0e0-483f-a9cd-3fbd3f9d66d1       /boot           ext2            rw,relatime,block_validity,barrier,user_xattr,acl       0 2
</span><span class='line'>
</span><span class='line'># /dev/mapper/vg-lv_swap
</span><span class='line'>UUID=32f6e5d4-67a3-42e3-8a90-6ee3ae0fdaa3       none            swap            defaults        0 0
</span><span class='line'>
</span><span class='line'>root@parabolaiso ~ # </span></code></pre></td></tr></table></div></figure>


<h3>chroot</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@parabolaiso ~ # arch-chroot /mnt
</span><span class='line'>[root@parabolaiso /]# </span></code></pre></td></tr></table></div></figure>


<h3>Set the timezone</h3>

<p>Set the link for the correct timezone</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@parabolaiso /]# ln -sf /usr/share/zoneinfo/Europe/Brussels /etc/localtime
</span><span class='line'>[root@parabolaiso /]# </span></code></pre></td></tr></table></div></figure>


<p>Set the hardwareclock to UTC</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@parabolaiso /]# hwclock --systohc --utc
</span><span class='line'>[root@parabolaiso /]# </span></code></pre></td></tr></table></div></figure>


<h3>Generate the required locales</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@parabolaiso /]# vi /etc/locale.gen 
</span><span class='line'>[root@parabolaiso /]# local 
</span><span class='line'>local       locale      locale-gen  localectl   localedef   
</span><span class='line'>[root@parabolaiso /]# locale-gen
</span><span class='line'>Generating locales...
</span><span class='line'>  en_IE.UTF-8... done
</span><span class='line'>  en_IE.ISO-8859-1... done
</span><span class='line'>  en_IE.ISO-8859-15@euro... done
</span><span class='line'>  en_US.UTF-8... done
</span><span class='line'>  en_US.ISO-8859-1... done
</span><span class='line'>  nl_BE.UTF-8... done
</span><span class='line'>  nl_BE.ISO-8859-1... done
</span><span class='line'>  nl_BE.ISO-8859-15@euro... done
</span><span class='line'>Generation complete.
</span><span class='line'>[root@parabolaiso /]# </span></code></pre></td></tr></table></div></figure>


<h3>Hostname</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@parabolaiso /]# vi /etc/hostname
</span><span class='line'>[root@parabolaiso /]# </span></code></pre></td></tr></table></div></figure>


<h3>mkinitcpio</h3>

<h4>HOOKS</h4>

<p>Add &ldquo;encrypt lvm2&rdquo; to HOOKS before filesystems in /etc/mkinitcpio.conf</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@parabolaiso /]# vi /etc/mkinitcpio.conf</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>HOOKS="base udev autodetect modconf block encrypt lvm2 filesystems keyboard fsck"</span></code></pre></td></tr></table></div></figure>


<h4>Create boot image</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@parabolaiso /]#  mkinitcpio -p linux-libre
</span><span class='line'>==&gt; Building image from preset: /etc/mkinitcpio.d/linux-libre.preset: 'default'
</span><span class='line'>  -&gt; -k /boot/vmlinuz-linux-libre -c /etc/mkinitcpio.conf -g /boot/initramfs-linux-libre.img
</span><span class='line'>==&gt; Starting build: 4.10.6-gnu-1
</span><span class='line'>  -&gt; Running build hook: [base]
</span><span class='line'>  -&gt; Running build hook: [udev]
</span><span class='line'>  -&gt; Running build hook: [autodetect]
</span><span class='line'>  -&gt; Running build hook: [modconf]
</span><span class='line'>  -&gt; Running build hook: [block]
</span><span class='line'>  -&gt; Running build hook: [sd-encrypt]
</span><span class='line'>/usr/lib/initcpio/install/sd-encrypt: line 21: add_systemd_unit: command not found
</span><span class='line'>/usr/lib/initcpio/install/sd-encrypt: line 25: add_systemd_unit: command not found
</span><span class='line'>/usr/lib/initcpio/install/sd-encrypt: line 26: add_systemd_unit: command not found
</span><span class='line'>  -&gt; Running build hook: [lvm2]
</span><span class='line'>  -&gt; Running build hook: [filesystems]
</span><span class='line'>  -&gt; Running build hook: [keyboard]
</span><span class='line'>  -&gt; Running build hook: [fsck]
</span><span class='line'>==&gt; Generating module dependencies
</span><span class='line'>==&gt; Creating gzip-compressed initcpio image: /boot/initramfs-linux-libre.img
</span><span class='line'>==&gt; Image generation successful
</span><span class='line'>==&gt; Building image from preset: /etc/mkinitcpio.d/linux-libre.preset: 'fallback'
</span><span class='line'>  -&gt; -k /boot/vmlinuz-linux-libre -c /etc/mkinitcpio.conf -g /boot/initramfs-linux-libre-fallback.img -S autodetect
</span><span class='line'>==&gt; Starting build: 4.10.6-gnu-1
</span><span class='line'>  -&gt; Running build hook: [base]
</span><span class='line'>  -&gt; Running build hook: [udev]
</span><span class='line'>  -&gt; Running build hook: [modconf]
</span><span class='line'>  -&gt; Running build hook: [block]
</span><span class='line'>==&gt; WARNING: Possibly missing firmware for module: isci
</span><span class='line'>  -&gt; Running build hook: [sd-encrypt]
</span><span class='line'>/usr/lib/initcpio/install/sd-encrypt: line 21: add_systemd_unit: command not found
</span><span class='line'>/usr/lib/initcpio/install/sd-encrypt: line 25: add_systemd_unit: command not found
</span><span class='line'>/usr/lib/initcpio/install/sd-encrypt: line 26: add_systemd_unit: command not found
</span><span class='line'>  -&gt; Running build hook: [lvm2]
</span><span class='line'>  -&gt; Running build hook: [filesystems]
</span><span class='line'>  -&gt; Running build hook: [keyboard]
</span><span class='line'>  -&gt; Running build hook: [fsck]
</span><span class='line'>==&gt; Generating module dependencies
</span><span class='line'>==&gt; Creating gzip-compressed initcpio image: /boot/initramfs-linux-libre-fallback.img
</span><span class='line'>==&gt; Image generation successful
</span><span class='line'>[root@parabolaiso /]# </span></code></pre></td></tr></table></div></figure>


<h3>set the root password</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@parabolaiso /]# passwd root
</span><span class='line'>New password: 
</span><span class='line'>Retype new password: 
</span><span class='line'>passwd: password updated successfully
</span><span class='line'>[root@parabolaiso /]# </span></code></pre></td></tr></table></div></figure>


<h3>GRUB</h3>

<h4>install Grub</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@parabolaiso /]#  pacman -Sy grub
</span><span class='line'>:: Synchronizing package databases...
</span><span class='line'> libre is up to date
</span><span class='line'> core is up to date
</span><span class='line'> extra is up to date
</span><span class='line'> community is up to date
</span><span class='line'> pcr is up to date
</span><span class='line'>resolving dependencies...
</span><span class='line'>looking for conflicting packages...
</span><span class='line'>
</span><span class='line'>Packages (1) grub-1:2.02.rc2-1.parabola1
</span><span class='line'>
</span><span class='line'>Total Download Size:    6.04 MiB
</span><span class='line'>Total Installed Size:  35.87 MiB
</span><span class='line'>
</span><span class='line'>:: Proceed with installation? [Y/n] 
</span><span class='line'>:: Retrieving packages...
</span><span class='line'> grub-1:2.02.rc2-1.parabola1-x86_64                   6.0 MiB   128K/s 00:48 [############################################] 100%
</span><span class='line'>(1/1) checking keys in keyring                                               [############################################] 100%
</span><span class='line'>(1/1) checking package integrity                                             [############################################] 100%
</span><span class='line'>(1/1) loading package files                                                  [############################################] 100%
</span><span class='line'>(1/1) checking for file conflicts                                            [############################################] 100%
</span><span class='line'>(1/1) checking available disk space                                          [############################################] 100%
</span><span class='line'>:: Processing package changes...
</span><span class='line'>(1/1) installing grub                                                        [############################################] 100%
</span><span class='line'>Generating grub.cfg.example config file...
</span><span class='line'>This may fail on some machines running a custom kernel.
</span><span class='line'>done.
</span><span class='line'>Optional dependencies for grub
</span><span class='line'>    freetype2: For grub-mkfont usage
</span><span class='line'>    fuse: For grub-mount usage
</span><span class='line'>    dosfstools: For grub-mkrescue FAT FS and EFI support
</span><span class='line'>    efibootmgr: For grub-install EFI support
</span><span class='line'>    libisoburn: Provides xorriso for generating grub rescue iso using grub-mkrescue
</span><span class='line'>    os-prober: To detect other OSes when generating grub.cfg in BIOS systems
</span><span class='line'>    mtools: For grub-mkrescue FAT FS support
</span><span class='line'>:: Running post-transaction hooks...
</span><span class='line'>(1/2) Arming ConditionNeedsUpdate...
</span><span class='line'>(2/2) Updating the info directory file...
</span><span class='line'>[root@parabolaiso /]# </span></code></pre></td></tr></table></div></figure>


<h4>Install grub to your boot disk</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@parabolaiso /]# grub-install --target=i386-pc /dev/sdb
</span><span class='line'>Installing for i386-pc platform.
</span><span class='line'>Installation finished. No error reported.
</span><span class='line'>[root@parabolaiso /]# </span></code></pre></td></tr></table></div></figure>


<h4>Create grub.cfg</h4>

<p>We&rsquo;ll use the uuid for the crypted device.</p>

<h5>Get the UUID for the encrypted physical volume</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@parabolaiso /]# ls -l /dev/disk/by-uuid/
</span><span class='line'>total 0
</span><span class='line'>lrwxrwxrwx 1 root root 10 Apr  3 10:07 2016-11-03-15-52-21-00 -&gt; ../../sda1
</span><span class='line'>lrwxrwxrwx 1 root root 10 Apr  3 10:09 32f6e5d4-67a3-42e3-8a90-6ee3ae0fdaa3 -&gt; ../../dm-2
</span><span class='line'>lrwxrwxrwx 1 root root 10 Apr  3 10:09 3731a69b-7240-4618-8e5e-4684d7e719e3 -&gt; ../../dm-3
</span><span class='line'>lrwxrwxrwx 1 root root 10 Apr  3 10:07 BD3C-9D8E -&gt; ../../sda2
</span><span class='line'>lrwxrwxrwx 1 root root 10 Apr  3 10:07 e3fd741d-d0e0-483f-a9cd-3fbd3f9d66d1 -&gt; ../../sdb1
</span><span class='line'>lrwxrwxrwx 1 root root 10 Apr  3 10:09 eb600d4a-a2fd-4698-8847-14e6dc1b5e6c -&gt; ../../sdb2
</span><span class='line'>lrwxrwxrwx 1 root root 10 Apr  3 10:07 f6312bc5-7593-4b6d-8427-0cf92d9de40b -&gt; ../../dm-0
</span><span class='line'>[root@parabolaiso /]# </span></code></pre></td></tr></table></div></figure>


<h5>Update /etc/default/grub</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>GRUB_DEFAULT=0
</span><span class='line'>GRUB_TIMEOUT=5
</span><span class='line'>GRUB_DISTRIBUTOR="Parabola"
</span><span class='line'>GRUB_CMDLINE_LINUX_DEFAULT="quiet"
</span><span class='line'>GRUB_CMDLINE_LINUX="cryptdevice=/dev/disk/by-uuid/eb600d4a-a2fd-4698-8847-14e6dc1b5e6c:pv"</span></code></pre></td></tr></table></div></figure>


<h5>Generate grub.cfg</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@parabolaiso /]# grub-mkconfig -o /boot/grub/grub.cfg
</span><span class='line'>Generating grub configuration file ...
</span><span class='line'>  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
</span><span class='line'>  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
</span><span class='line'>  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
</span><span class='line'>  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
</span><span class='line'>  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
</span><span class='line'>  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
</span><span class='line'>  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
</span><span class='line'>  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
</span><span class='line'>  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
</span><span class='line'>  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
</span><span class='line'>Found linux image: /boot/vmlinuz-linux-libre
</span><span class='line'>Found initrd image: /boot/initramfs-linux-libre.img
</span><span class='line'>Found fallback initramfs image: /boot/initramfs-linux-libre-fallback.img
</span><span class='line'>  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
</span><span class='line'>  WARNING: Failed to connect to lvmetad. Falling back to device scanning.
</span><span class='line'>done
</span><span class='line'>[root@parabolaiso /]# </span></code></pre></td></tr></table></div></figure>


<h2>Reboot</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@parabolaiso /]# exit
</span><span class='line'>root@parabolaiso ~ # umount /mnt/boot
</span><span class='line'>root@parabolaiso ~ # umount /mnt/    
</span><span class='line'>root@parabolaiso ~ # lvchange -an /dev/vg/lv_root  
</span><span class='line'>root@parabolaiso ~ # swapoff /dev/vg/lv_swap
</span><span class='line'>root@parabolaiso ~ # lvchange -an /dev/vg/lv_swap
</span><span class='line'>root@parabolaiso ~ # cryptsetup luksClose  /dev/mapper/pv
</span><span class='line'>root@parabolaiso ~ # reboot
</span><span class='line'>Connection to petronella closed by remote host.
</span><span class='line'>Connection to petronella closed.
</span><span class='line'>[staf@vicky octopress]$ </span></code></pre></td></tr></table></div></figure>


<h2>First boot</h2>

<p>If everything goes well GNU/Linux get booted, &hellip; if not. You&rsquo;ll have some fun to resolve the boot issues :-)</p>

<p style="font-style: italic;">
Have fun!
</p>


<h1>Links</h1>

<ul>
<li><a href="https://libreboot.org/docs/gnulinux/encrypted_parabola.html">https://libreboot.org/docs/gnulinux/encrypted_parabola.html</a></li>
<li><a href="http://stafwag.github.io/blog/blog/2016/08/30/arch-on-an-encrypted-btrfs-partition/">http://stafwag.github.io/blog/blog/2016/08/30/arch-on-an-encrypted-btrfs-partition/</a></li>
<li><a href="http://www.brunoparmentier.be/blog/how-to-install-arch-linux-on-an-encrypted-btrfs-partition.html">http://www.brunoparmentier.be/blog/how-to-install-arch-linux-on-an-encrypted-btrfs-partition.html</a></li>
<li><a href="http://blog.fabio.mancinelli.me/2012/12/28/Arch_Linux_on_BTRFS.html">http://blog.fabio.mancinelli.me/2012/12/28/Arch_Linux_on_BTRFS.html</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How to Install Libreboot on a ThinkPad X60]]></title>
    <link href="http://stafwag.github.io/blog/blog/2017/02/11/how-to-install-libreboot-on-a-thinkpad-x60/"/>
    <updated>2017-02-11T16:09:11+01:00</updated>
    <id>http://stafwag.github.io/blog/blog/2017/02/11/how-to-install-libreboot-on-a-thinkpad-x60</id>
    <content type="html"><![CDATA[<p><br />&nbsp;<br />
I got a <a href="https://en.wikipedia.org/wiki/ThinkPad_X_Series#X60_Tablet">ThinkPad x60 (tablet version)</a> from <a href="http://ebay.be">ebay.be</a> to install <a href="https://libreboot.org/">libreboot</a> on it.
<br />&nbsp;<br />
I tried to compile libreboot on <a href="http://www.debian">Debian</a> and <a href="https://www.parabola.nu/">Parabola</a> GNU/Linux but both failed, compling Libreboot on <a href="https://trisquel.info/">Trisquel 7</a> works fine so I&rsquo;ll use Trisquel to replace the BIOS with libreboot.
<br />&nbsp;<br />
I&rsquo;m not sure that I&rsquo;ll use Trisquel 7 as my daily driver since it is a bit outdated&hellip;
I might go with <a href="http://https://wiki.debian.org/DebianStretch">Debian Strech</a> without the non-free repositories to get a fully <a href="https://en.wikipedia.org/wiki/Free_software">Free Software</a> Laptop/tablet. I&rsquo;ll need to replace the Intel wifi adapter since this requires non-free firmware.
<br />&nbsp;<br />
You&rsquo;ll find a small howto install libreboot on a Thinkpad X60 below.
<br />&nbsp;<br /></p>

<p><img class="centre" src="http://stafwag.github.io/blog/images/x60_open.jpg" width="750" height="1050" title="&#34;Thinkpad x60 open&#34;" alt="&#34;Thinkpad x60 open&#34;"></p>

<h1>Build Libreboot</h1>

<p>The latest version of libreboot isn&rsquo;t available via a binary distribution so I decided to build it from source.</p>

<h2>Download the Libreboot source</h2>

<p>Download the latest libreboot image from <a href="https://libreboot.org/download/"><a href="https://libreboot.org/download/">https://libreboot.org/download/</a></a></p>

<h3>Download the source tarball</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot$ wget https://libreboot.org/release/stable/20160907/libreboot_r20160907_src.tar.xz
</span><span class='line'>--2017-02-11 10:24:41--  https://libreboot.org/release/stable/20160907/libreboot_r20160907_src.tar.xz
</span><span class='line'>Resolving libreboot.org (libreboot.org)... 149.56.232.100
</span><span class='line'>Connecting to libreboot.org (libreboot.org)|149.56.232.100|:443... connected.
</span><span class='line'>HTTP request sent, awaiting response... 200 OK
</span><span class='line'>Length: 438622508 (418M) [application/x-xz]
</span><span class='line'>Saving to: libreboot_r20160907_src.tar.xz
</span><span class='line'>
</span><span class='line'>100%[==========================================================&gt;] 438.622.508  541KB/s   in 18m 35s
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>2017-02-11 10:43:17 (384 KB/s) - libreboot_r20160907_src.tar.xz saved [438622508/438622508]
</span><span class='line'>
</span><span class='line'>staf@petronella:~/libreboot$ </span></code></pre></td></tr></table></div></figure>


<h3>Verify</h3>

<p>As always verify the checksums and the gpg signature, the gpg public key is available at:
<a href="https://libreboot.org/gpg/"</a><a href="https://libreboot.org/gpg/">https://libreboot.org/gpg/</a></a></p>

<h4>Download the  SHA512SUMS and SHA512SUMS.sig</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot$ wget https://libreboot.org/release/stable/20160907/SHA512SUMS                                                      
</span><span class='line'>--2017-02-11 10:52:23--  https://libreboot.org/release/stable/20160907/SHA512SUMS                                                                          
</span><span class='line'>Resolving libreboot.org (libreboot.org)... 149.56.232.100                                                                                                            
</span><span class='line'>Connecting to libreboot.org (libreboot.org)|149.56.232.100|:443... connected.                                                                                                  
</span><span class='line'>HTTP request sent, awaiting response... 200 OK                                                                                                                                 
</span><span class='line'>Length: 5112 (5,0K) [application/octet-stream]                                                                                                                                        
</span><span class='line'>Saving to: 'SHA512SUMS'                                                                                                                                                                          
</span><span class='line'>                                                                                                                                                                                                         
</span><span class='line'>100%[=====================================================================================================================================================================================================&gt;] 5.112       --.-K/s   in 0,006s  
</span><span class='line'>                                                                                                                                                                                                                          
</span><span class='line'>2017-02-11 10:52:24 (852 KB/s) - 'SHA512SUMS' saved [5112/5112]                                                                                                                                                                      
</span><span class='line'>                                                                                                                                                                                                                                             
</span><span class='line'>staf@petronella:~/libreboot$ wget https://libreboot.org/release/stable/20160907/SHA512SUMS.sig
</span><span class='line'>--2017-02-11 10:52:39--  https://libreboot.org/release/stable/20160907/SHA512SUMS.sig
</span><span class='line'>Resolving libreboot.org (libreboot.org)... 149.56.232.100
</span><span class='line'>Connecting to libreboot.org (libreboot.org)|149.56.232.100|:443... connected.
</span><span class='line'>HTTP request sent, awaiting response... 200 OK
</span><span class='line'>Length: 543 [application/pgp-signature]
</span><span class='line'>Saving to: 'SHA512SUMS.sig'
</span><span class='line'>
</span><span class='line'>100%[=====================================================================================================================================================================================================&gt;] 543         --.-K/s   in 0s      
</span><span class='line'>
</span><span class='line'>2017-02-11 10:52:39 (11,4 MB/s) - 'SHA512SUMS.sig' saved [543/543]
</span><span class='line'>
</span><span class='line'>staf@petronella:~/libreboot$ </span></code></pre></td></tr></table></div></figure>


<h4>Import the public gpg key</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot$ gpg --recv-keys 0x05E8C5B2
</span><span class='line'>gpg: directory `/home/staf/.gnupg' created
</span><span class='line'>gpg: new configuration file `/home/staf/.gnupg/gpg.conf' created
</span><span class='line'>gpg: WARNING: options in `/home/staf/.gnupg/gpg.conf' are not yet active during this run
</span><span class='line'>gpg: keyring `/home/staf/.gnupg/secring.gpg' created
</span><span class='line'>gpg: keyring `/home/staf/.gnupg/pubring.gpg' created
</span><span class='line'>gpg: no keyserver known (use option --keyserver)
</span><span class='line'>gpg: keyserver receive failed: bad URI
</span><span class='line'>staf@petronella:~/libreboot$ gpg --recv-keys 0x05E8C5B2
</span><span class='line'>gpg: requesting key 05E8C5B2 from hkp server keys.gnupg.net
</span><span class='line'>gpg: /home/staf/.gnupg/trustdb.gpg: trustdb created
</span><span class='line'>gpg: key 05E8C5B2: public key "Leah Rowe (Libreboot signing key) &lt;info@minifree.org&gt;" imported
</span><span class='line'>gpg: key 05E8C5B2: public key "Leah Rowe (Libreboot signing key) &lt;info@minifree.org&gt;" imported
</span><span class='line'>gpg: no ultimately trusted keys found
</span><span class='line'>gpg: Total number processed: 2
</span><span class='line'>gpg:               imported: 2  (RSA: 2)
</span><span class='line'>staf@petronella:~/libreboot$ </span></code></pre></td></tr></table></div></figure>


<h4>Verify the checksum file</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot$ gpg --verify SHA512SUMS.sig SHA512SUMS
</span><span class='line'>gpg: Signature made Don 08 Sep 2016 00:15:17 CEST using RSA key ID 05E8C5B2
</span><span class='line'>gpg: Good signature from "Leah Rowe (Libreboot signing key) &lt;info@minifree.org&gt;"
</span><span class='line'>gpg: WARNING: This key is not certified with a trusted signature!
</span><span class='line'>gpg:          There is no indication that the signature belongs to the owner.
</span><span class='line'>Primary key fingerprint: CDC9 CAE3 2CB4 B7FC 84FD  C804 969A 9795 05E8 C5B2
</span><span class='line'>staf@petronella:~/libreboot$ </span></code></pre></td></tr></table></div></figure>


<h4>Verify the checksum</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot$ sha512sum -c SHA512SUMS | head -2
</span><span class='line'>sha512sum: ./libreboot_r20160907_util.tar.xz: No such file or directory
</span><span class='line'>sha512sum: ./rom/depthcharge/libreboot_r20160907_depthcharge_veyron_speedy.tar.xz: No such file or directory
</span><span class='line'>sha512sum: ./rom/grub/libreboot_r20160907_grub_d510mo.tar.xz: No such file or directory
</span><span class='line'>sha512sum: ./libreboot_r20160907_src.tar.xz: OK
</span><span class='line'>./rom/grub/libreboot_r20160907_grub_ga-g41m-es2l.tar.xz./libreboot_r20160907_util.tar.xz: FAILED open or read
</span><span class='line'>: No such file or directory
</span><span class='line'>staf@petronella:~/libreboot$ </span></code></pre></td></tr></table></div></figure>


<p></p>

<h2>Build the modules</h2>

<h3>Git</h3>

<p>It&rsquo;s required to have git installed and to set the user email &amp; name if you don&rsquo;t do this the complilation will fail.</p>

<p>Install git</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot$ sudo apt-get install git
</span><span class='line'>[sudo] password for staf: 
</span><span class='line'>Reading package lists... Done
</span><span class='line'>Building dependency tree       
</span><span class='line'>Reading state information... Done
</span><span class='line'>The following extra packages will be installed:
</span><span class='line'>  git-man liberror-perl
</span><span class='line'>Suggested packages:
</span><span class='line'>  git-daemon-run git-daemon-sysvinit git-doc git-el git-email git-gui gitk
</span><span class='line'>  gitweb git-arch git-bzr git-cvs git-mediawiki git-svn
</span><span class='line'>The following NEW packages will be installed:
</span><span class='line'>  git git-man liberror-perl
</span><span class='line'>0 upgraded, 3 newly installed, 0 to remove and 0 not upgraded.
</span><span class='line'>Need to get 3.306 kB of archives.
</span><span class='line'>After this operation, 21,9 MB of additional disk space will be used.
</span><span class='line'>Do you want to continue? [Y/n] y
</span><span class='line'>Get:1 http://fr.archive.trisquel.info/trisquel/ belenos/main liberror-perl all 0.17-1.1 [21,1 kB]
</span><span class='line'>Get:2 http://fr.archive.trisquel.info/trisquel/ belenos-security/main git-man all 1:1.9.1-1ubuntu0.3 [699 kB]
</span><span class='line'>Get:3 http://fr.archive.trisquel.info/trisquel/ belenos-security/main git amd64 1:1.9.1-1ubuntu0.3 [2.586 kB]
</span><span class='line'>Fetched 3.306 kB in 4s (723 kB/s)
</span><span class='line'>Selecting previously unselected package liberror-perl.
</span><span class='line'>(Reading database ... 206214 files and directories currently installed.)
</span><span class='line'>Preparing to unpack .../liberror-perl_0.17-1.1_all.deb ...
</span><span class='line'>Unpacking liberror-perl (0.17-1.1) ...
</span><span class='line'>Selecting previously unselected package git-man.
</span><span class='line'>Preparing to unpack .../git-man_1%3a1.9.1-1ubuntu0.3_all.deb ...
</span><span class='line'>Unpacking git-man (1:1.9.1-1ubuntu0.3) ...
</span><span class='line'>Selecting previously unselected package git.
</span><span class='line'>Preparing to unpack .../git_1%3a1.9.1-1ubuntu0.3_amd64.deb ...
</span><span class='line'>Unpacking git (1:1.9.1-1ubuntu0.3) ...
</span><span class='line'>Processing triggers for man-db (2.6.7.1-1ubuntu1) ...
</span><span class='line'>Setting up liberror-perl (0.17-1.1) ...
</span><span class='line'>Setting up git-man (1:1.9.1-1ubuntu0.3) ...
</span><span class='line'>Setting up git (1:1.9.1-1ubuntu0.3) ...
</span><span class='line'>staf@petronella:~/libreboot$ </span></code></pre></td></tr></table></div></figure>


<p>Set the git username and password.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot$ git config --global user.email "staf@wagemakers.be"
</span><span class='line'>staf@petronella:~/libreboot$ git config --global user.name "staf wagemakers"
</span><span class='line'>staf@petronella:~/libreboot$ </span></code></pre></td></tr></table></div></figure>


<p></p>

<h3>Extract the source</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot$ tar xf libreboot_r20160907_src.tar.xz 
</span><span class='line'>staf@petronella:~/libreboot$ </span></code></pre></td></tr></table></div></figure>


<h3>Install the dependencies</h3>

<p>cd into the extracted directory</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot$ ls
</span><span class='line'>SHA512SUMS  SHA512SUMS.sig  libreboot_r20160907_src  libreboot_r20160907_src.tar.xz
</span><span class='line'>staf@petronella:~/libreboot$ cd libreboot_r20160907_src</span></code></pre></td></tr></table></div></figure>


<p>run dependencies trisquel7 to install the software dependencies.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ sudo ./build dependencies trisquel7
</span><span class='line'>Reading package lists... Done
</span><span class='line'>Building dependency tree       
</span><span class='line'>Reading state information... Done
</span><span class='line'>wget is already the newest version.
</span><span class='line'>0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
</span><span class='line'>Reading package lists... Done
</span><span class='line'>Building dependency tree       
</span><span class='line'>Reading state information... Done
</span><span class='line'>git is already the newest version.
</span><span class='line'>0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
</span><span class='line'>Reading package lists... Done
</span><span class='line'>Building dependency tree       
</span><span class='line'>Reading state information... Done
</span><span class='line'>The following extra packages will be installed:
</span><span class='line'>  fonts-lmodern fonts-texgyre latex-beamer latex-xcolor libintl-perl
</span><span class='line'>  liblua5.1-0 libpaper-utils libptexenc1 libruby1.9.1 libtext-unidecode-perl
</span><span class='line'>  libxml-libxml-perl libxml-namespacesupport-perl libxml-sax-base-perl
</span><span class='line'>  libxml-sax-expat-perl libxml-sax-perl libyaml-0-2 lmodern luatex pandoc-data
</span><span class='line'>  pgf prosper ps2eps ruby ruby1.9.1 tcl tcl8.6 tex-common tex-gyre
</span><span class='line'>  texlive-base texlive-binaries texlive-extra-utils texlive-font-utils</span></code></pre></td></tr></table></div></figure>


<p>&lt; snip &gt;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(Reading database ... 236394 files and directories currently installed.)
</span><span class='line'>Preparing to unpack .../lib32z1_1%3a1.2.8.dfsg-1ubuntu1_amd64.deb ...
</span><span class='line'>Unpacking lib32z1 (1:1.2.8.dfsg-1ubuntu1) ...
</span><span class='line'>Selecting previously unselected package lib32z1-dev.
</span><span class='line'>Preparing to unpack .../lib32z1-dev_1%3a1.2.8.dfsg-1ubuntu1_amd64.deb ...
</span><span class='line'>Unpacking lib32z1-dev (1:1.2.8.dfsg-1ubuntu1) ...
</span><span class='line'>Setting up lib32z1 (1:1.2.8.dfsg-1ubuntu1) ...
</span><span class='line'>Setting up lib32z1-dev (1:1.2.8.dfsg-1ubuntu1) ...
</span><span class='line'>Processing triggers for libc-bin (2.19-0ubuntu6.9) ...
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ </span></code></pre></td></tr></table></div></figure>


<h3>Build module all</h3>

<p>Build the modules by excuting build module all</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot/libreboot/libreboot_r20160907_src$ ./build module all
</span><span class='line'>Building bucts
</span><span class='line'>rm -f bucts bucts.o
</span><span class='line'>gcc  -DVERSION='"withoutgit"' -c bucts.c
</span><span class='line'>gcc -o bucts bucts.o  -lpci
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Building the utilities in coreboot
</span><span class='line'>make: Entering directory `/home/staf/libreboot/libreboot_r20160907_src/coreboot/15fca66bf08db45937ce88b950491963654805b9/15fca66bf08db45937ce88b950491963654805b9/util/cbfstool'
</span><span class='line'>    HOSTCC     cbfstool/cbfstool.o
</span><span class='line'>    HOSTCC     cbfstool/common.o
</span><span class='line'>    HOSTCC     cbfstool/compress.o
</span><span class='line'>    HOSTCC     cbfstool/cbfs_hash.o
</span><span class='line'>    HOSTCC     cbfstool/cbfs_image.o
</span><span class='line'>    HOSTCC     cbfstool/cbfs-mkstage.o
</span><span class='line'>    HOSTCC     cbfstool/cbfs-mkpayload.o
</span><span class='line'>    HOSTCC     cbfstool/elfheaders.o
</span><span class='line'>    HOSTCC     cbfstool/rmodule.o
</span><span class='line'>    HOSTCC     cbfstool/xdr.o
</span><span class='line'>    HOSTCC     cbfstool/fit.o
</span><span class='line'>    HOSTCC     cbfstool/partitioned_file.o</span></code></pre></td></tr></table></div></figure>


<p>&lt; snip &gt;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  Compile checking out/vgasrc/stdvgamodes.o
</span><span class='line'>  Compile checking out/vgasrc/stdvgaio.o
</span><span class='line'>  Compile checking out/vgasrc/clext.o
</span><span class='line'>  Compile checking out/vgasrc/bochsvga.o
</span><span class='line'>  Compile checking out/vgasrc/geodevga.o
</span><span class='line'>  Compile checking out/vgasrc/cbvga.o
</span><span class='line'>  Compiling whole program out/vgaccode16.raw.s
</span><span class='line'>  Fixup VGA rom assembler
</span><span class='line'>  Compiling (16bit) out/vgaentry.o
</span><span class='line'>  Precompiling out/vgasrc/vgalayout.lds
</span><span class='line'>  Linking out/vgarom.o
</span><span class='line'>Version: ?-20170211_123929-petronella
</span><span class='line'>  Extracting binary out/vgabios.bin.raw
</span><span class='line'>  Finalizing rom out/vgabios.bin
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ </span></code></pre></td></tr></table></div></figure>


<h2>Build the ROMS</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ ./build roms withgrub
</span><span class='line'>Building ROM images with the GRUB payload
</span><span class='line'>Creating GRUB ELF executable for configuration 'txtmode'
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Creating GRUB ELF executable for configuration 'vesafb'
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>GRUB Helper script: build ROM images for 'd510mo'
</span><span class='line'>M       3rdparty/vboot
</span><span class='line'>Switched to branch 'grub_d510mo'
</span><span class='line'>Switched to branch 'grub_d510mo'
</span><span class='line'>No submodule mapping found in .gitmodules for path '3rdparty/vboot'
</span><span class='line'>No submodule mapping found in .gitmodules for path '3rdparty/vboot'</span></code></pre></td></tr></table></div></figure>


<p>&lt; snip &gt;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>12288 bytes (12 kB) copied, 0,026113 s, 471 kB/s
</span><span class='line'>12288+0 records in
</span><span class='line'>12288+0 records out
</span><span class='line'>12288 bytes (12 kB) copied, 0,0259776 s, 473 kB/s
</span><span class='line'>12288+0 records in
</span><span class='line'>12288+0 records out
</span><span class='line'>12288 bytes (12 kB) copied, 0,0261767 s, 469 kB/s
</span><span class='line'>12288+0 records in
</span><span class='line'>12288+0 records out
</span><span class='line'>12288 bytes (12 kB) copied, 0,0261144 s, 471 kB/s
</span><span class='line'>12288+0 records in
</span><span class='line'>12288+0 records out
</span><span class='line'>12288 bytes (12 kB) copied, 0,0282761 s, 435 kB/s
</span><span class='line'>12288+0 records in
</span><span class='line'>12288+0 records out
</span><span class='line'>12288 bytes (12 kB) copied, 0,0271539 s, 453 kB/s
</span><span class='line'>12288+0 records in
</span><span class='line'>12288+0 records out
</span><span class='line'>12288 bytes (12 kB) copied, 0,0295147 s, 416 kB/s
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ </span></code></pre></td></tr></table></div></figure>


<p>The rom build command creates a bin directory, verify that required roms are available.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ cd bin/
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src/bin$ ls -l
</span><span class='line'>total 4
</span><span class='line'>drwxrwxr-x 23 staf staf 4096 Feb  11 15:58 grub
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src/bin$ cd grub/
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src/bin/grub$ ls -l
</span><span class='line'>total 84
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:28 d510mo
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:29 ga-g41m-es2l
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:30 kcma-d8
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:31 kgpe-d16
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:32 macbook21
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:33 qemu_i440fx_piix4
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:34 qemu_q35_ich9
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:59 r400_16mb
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:59 r400_4mb
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:59 r400_8mb
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:59 t400_16mb
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:59 t400_4mb
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:59 t400_8mb
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:59 t500_16mb
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:59 t500_4mb
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:59 t500_8mb
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:58 t60
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:59 x200_16mb
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:58 x200_4mb
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:58 x200_8mb
</span><span class='line'>drwxrwxr-x 2 staf staf 4096 Feb  11 15:58 x60
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src/bin/grub$ </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src/bin/grub$ cd x60
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src/bin/grub/x60$ ls -l
</span><span class='line'>total 40960
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_deqwertz_txtmode.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_deqwertz_vesafb.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_esqwerty_txtmode.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_esqwerty_vesafb.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_frazerty_txtmode.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_frazerty_vesafb.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_frdvbepo_txtmode.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_frdvbepo_vesafb.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_itqwerty_txtmode.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_itqwerty_vesafb.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_svenska_txtmode.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_svenska_vesafb.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_ukdvorak_txtmode.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_ukdvorak_vesafb.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_ukqwerty_txtmode.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_ukqwerty_vesafb.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_usdvorak_txtmode.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_usdvorak_vesafb.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_usqwerty_txtmode.rom
</span><span class='line'>-rw-rw-r-- 1 staf staf 2097152 Feb  11 15:58 x60_usqwerty_vesafb.rom</span></code></pre></td></tr></table></div></figure>


<h1>Libreboot Installation</h1>

<h2>Backup</h2>

<p>Backups are important. We&rsquo;ll first backup the orginal proprietary <a href="https://en.wikipedia.org/wiki/BIOS">BIOS</a> before we free the laptop and install a <a href="https://en.wikipedia.org/wiki/Free_software">Free Software firmware</a></p>

<p>The documentation that I found (see Links below) describes that the backup has 2 step flashrom_lenovobios_sst &amp; flashrom_lenovobios_macronix.</p>

<p>The flashrom_lenovobios_macronix command fails on my Laptop/Table but I decided to continue with the installation since I didn&rsquo;t pay a lot for the laptop on ebay.be.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ sudo flashrom/flashrom_lenovobios_sst -p internal -r factory.bin
</span><span class='line'>[sudo] password for staf: 
</span><span class='line'>flashrom v0.9.9-unknown on Linux 3.13.0-108-lowlatency (x86_64)
</span><span class='line'>flashrom is free software, get the source code at https://flashrom.org
</span><span class='line'>
</span><span class='line'>Calibrating delay loop... OK.
</span><span class='line'>Found chipset "Intel ICH7M".
</span><span class='line'>Enabling flash write... WARNING: SPI Configuration Lockdown activated.
</span><span class='line'>OK.
</span><span class='line'>Found SST flash chip "SST25VF016B" (2048 kB, SPI) mapped at physical address 0x00000000ffe00000.
</span><span class='line'>Reading flash... done.
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src/flashrom$ sudo ./flashrom_lenovobios_macronix -p internal -r factory.bin
</span><span class='line'>flashrom v0.9.9-unknown on Linux 3.13.0-108-lowlatency (x86_64)
</span><span class='line'>flashrom is free software, get the source code at https://flashrom.org
</span><span class='line'>
</span><span class='line'>Calibrating delay loop... OK.
</span><span class='line'>Found chipset "Intel ICH7M".
</span><span class='line'>Enabling flash write... WARNING: SPI Configuration Lockdown activated.
</span><span class='line'>OK.
</span><span class='line'>No EEPROM/flash device found.
</span><span class='line'>Note: flashrom can never write if the flash chip isn't found automatically.
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src/flashrom$ </span></code></pre></td></tr></table></div></figure>


<h2>Install the rom</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ sudo ./flash i945lenovo_firstflash bin/grub/x
</span><span class='line'>x200_16mb/ x200_4mb/  x200_8mb/  x60/       
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ sudo ./flash i945lenovo_firstflash bin/grub/x60/x60_
</span><span class='line'>x60_deqwertz_txtmode.rom  x60_frazerty_txtmode.rom  x60_itqwerty_txtmode.rom  x60_ukdvorak_txtmode.rom  x60_usdvorak_txtmode.rom
</span><span class='line'>x60_deqwertz_vesafb.rom   x60_frazerty_vesafb.rom   x60_itqwerty_vesafb.rom   x60_ukdvorak_vesafb.rom   x60_usdvorak_vesafb.rom
</span><span class='line'>x60_esqwerty_txtmode.rom  x60_frdvbepo_txtmode.rom  x60_svenska_txtmode.rom   x60_ukqwerty_txtmode.rom  x60_usqwerty_txtmode.rom
</span><span class='line'>x60_esqwerty_vesafb.rom   x60_frdvbepo_vesafb.rom   x60_svenska_vesafb.rom    x60_ukqwerty_vesafb.rom   x60_usqwerty_vesafb.rom
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ sudo ./flash i945lenovo_firstflash bin/grub/x60/x60_us
</span><span class='line'>x60_usdvorak_txtmode.rom  x60_usdvorak_vesafb.rom   x60_usqwerty_txtmode.rom  x60_usqwerty_vesafb.rom   
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ sudo ./flash i945lenovo_firstflash bin/grub/x60/x60_usqwerty_vesafb.rom 
</span><span class='line'>[sudo] password for staf: 
</span><span class='line'>Mode selected: i945lenovo_firstflash
</span><span class='line'>bucts utility version 'withoutgit'
</span><span class='line'>Using LPC bridge 8086:27b9 at 0000:1f.00
</span><span class='line'>Current BUC.TS=0 - 128kb address range 0xFFFE0000-0xFFFFFFFF is untranslated
</span><span class='line'>Updated BUC.TS=1 - 64kb address ranges at 0xFFFE0000 and 0xFFFF0000 are swapped
</span><span class='line'>flashrom v0.9.9-unknown on Linux 3.13.0-108-lowlatency (x86_64)
</span><span class='line'>flashrom is free software, get the source code at https://flashrom.org
</span><span class='line'>
</span><span class='line'>Calibrating delay loop... OK.
</span><span class='line'>Found chipset "Intel ICH7M".
</span><span class='line'>Enabling flash write... WARNING: SPI Configuration Lockdown activated.
</span><span class='line'>OK.
</span><span class='line'>Found SST flash chip "SST25VF016B" (2048 kB, SPI) mapped at physical address 0x00000000ffe00000.
</span><span class='line'>Reading old flash chip contents... done.
</span><span class='line'>Erasing and writing flash chip... spi_block_erase_20 failed during command execution at address 0x0
</span><span class='line'>Reading current flash chip contents... done. Looking for another erase function.
</span><span class='line'>spi_block_erase_52 failed during command execution at address 0x0
</span><span class='line'>Reading current flash chip contents... done. Looking for another erase function.
</span><span class='line'>Transaction error!
</span><span class='line'>spi_block_erase_d8 failed during command execution at address 0x1f0000
</span><span class='line'>Reading current flash chip contents... done. Looking for another erase function.
</span><span class='line'>spi_chip_erase_60 failed during command execution
</span><span class='line'>Reading current flash chip contents... done. Looking for another erase function.
</span><span class='line'>spi_chip_erase_c7 failed during command execution
</span><span class='line'>Looking for another erase function.
</span><span class='line'>No usable erase functions left.
</span><span class='line'>FAILED!
</span><span class='line'>Uh oh. Erase/write failed. Checking if anything has changed.
</span><span class='line'>Reading current flash chip contents... done.
</span><span class='line'>Apparently at least some data has changed.
</span><span class='line'>Your flash chip is in an unknown state.
</span><span class='line'>Get help on IRC at chat.freenode.net (channel #flashrom) or
</span><span class='line'>mail flashrom@flashrom.org with the subject "FAILED: &lt;your board name&gt;"!
</span><span class='line'>-------------------------------------------------------------------------------
</span><span class='line'>DO NOT REBOOT OR POWEROFF!
</span><span class='line'>flashrom v0.9.9-unknown on Linux 3.13.0-108-lowlatency (x86_64)
</span><span class='line'>flashrom is free software, get the source code at https://flashrom.org
</span><span class='line'>
</span><span class='line'>Calibrating delay loop... OK.
</span><span class='line'>Found chipset "Intel ICH7M".
</span><span class='line'>Enabling flash write... WARNING: SPI Configuration Lockdown activated.
</span><span class='line'>OK.
</span><span class='line'>No EEPROM/flash device found.
</span><span class='line'>Note: flashrom can never write if the flash chip isn't found automatically.
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ </span></code></pre></td></tr></table></div></figure>


<p>Power down your system</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ sudo poweroff
</span><span class='line'>
</span><span class='line'>Broadcast message from staf@petronella
</span><span class='line'>        (/dev/pts/7) at 16:11 ...
</span><span class='line'>
</span><span class='line'>The system is going down for power off NOW!
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ Connection to petronella closed by remote host.
</span><span class='line'>Connection to petronella closed.
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<p>Wait 2 minutes and boot the system again. If you&rsquo;re lucky the system will boot with the Free Libreboot firmware.
Logon the system again and continue with the secondflash phase</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ ssh petronella 
</span><span class='line'>C_GetAttributeValue failed: 18
</span><span class='line'>no such identity: /home/staf/.ssh/id_rsa: No such file or directory
</span><span class='line'>no such identity: /home/staf/.ssh/id_dsa: No such file or directory
</span><span class='line'>no such identity: /home/staf/.ssh/id_ecdsa: No such file or directory
</span><span class='line'>no such identity: /home/staf/.ssh/id_ed25519: No such file or directory
</span><span class='line'>staf@petronella's password: 
</span><span class='line'>Welcome to Trisquel GNU/Linux 7.0, Belenos (GNU/Linux 3.13.0-108-lowlatency x86_64)
</span><span class='line'>   ___        ___               ___        ___       ___        ___        ___
</span><span class='line'>  /\  \      /\  \      ___    /\  \      /\  \     /\__\      /\  \      /\__\
</span><span class='line'>  \ \  \    /  \  \    /\  \  /  \  \    /  \  \   / /  /     /  \  \    / /  /
</span><span class='line'>   \ \  \  / /\ \  \   \ \  \/ /\ \  \  / /\ \  \ / /  /     / /\ \  \  / /  /
</span><span class='line'>   /  \  \/  \ \ \  \  /  \__\ \ \ \  \/ /  \ \  \ /  /  ___/  \ \ \  \/ /  /
</span><span class='line'>  / /\ \__\/\ \ \ \__\/ /\/__/\ \ \ \__\/__/ \ \__\__/  /\__\/\ \ \ \__\/__/
</span><span class='line'> / /  \/__/_|  \/ /  / /  /\ \ \ \ \/__/\  \ / /  /  \ / /  /\ \ \ \/__/\  \
</span><span class='line'>/ /  /      | |  /  / /__/  \ \ \ \__\ \ \/\/ /  / \  / /  /\ \ \ \__\ \ \  \
</span><span class='line'>\/__/       | |\/__/\ \__\   \ \/ /  /  \    /  / \ \/ /  /  \ \ \/__/  \ \  \
</span><span class='line'>            | |  |   \/__/    \  /  /    \  /  /   \  /  /    \ \__\     \ \__\
</span><span class='line'>             \|__|             \/__/      \/__/     \/__/      \/__/      \/__/
</span><span class='line'>
</span><span class='line'>Welcome to Trisquel GNU/Linux
</span><span class='line'>Documentation: http://trisquel.info/wiki/
</span><span class='line'>
</span><span class='line'>Last login: Sat Feb 11 15:43:11 2017 from 192.168.1.10
</span><span class='line'>staf@petronella:~$ cd libreboot/libreboot
</span><span class='line'>libreboot/               libreboot_r20160907_src/ 
</span><span class='line'>staf@petronella:~$ cd libreboot/libreboot_r20160907_src/
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$  ./flash i945lenovo_secondflash bin/grub/x60/x60_usqwerty_vesafb.rom 
</span><span class='line'>This script must be run as root
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ ^C libreboot/libreboot_r20160907_src/
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ sudo ./flash i945lenovo_secondflash bin/grub/x60/x60_usqwerty_vesafb.rom
</span><span class='line'>[sudo] password for staf: 
</span><span class='line'>Mode selected: i945lenovo_secondflash
</span><span class='line'>flashrom v0.9.9-unknown on Linux 3.13.0-108-lowlatency (x86_64)
</span><span class='line'>flashrom is free software, get the source code at https://flashrom.org
</span><span class='line'>
</span><span class='line'>Calibrating delay loop... OK.
</span><span class='line'>coreboot table found at 0xcbe9f000.
</span><span class='line'>Found chipset "Intel ICH7M".
</span><span class='line'>Enabling flash write... OK.
</span><span class='line'>Found SST flash chip "SST25VF016B" (2048 kB, SPI) mapped at physical address 0x00000000ffe00000.
</span><span class='line'>Reading old flash chip contents... done.
</span><span class='line'>Erasing and writing flash chip... Erase/write done.
</span><span class='line'>Verifying flash... VERIFIED.
</span><span class='line'>bucts utility version 'withoutgit'
</span><span class='line'>Using LPC bridge 8086:27b9 at 0000:1f.00
</span><span class='line'>Current BUC.TS=1 - 64kb address ranges at 0xFFFE0000 and 0xFFFF0000 are swapped
</span><span class='line'>Updated BUC.TS=0 - 128kb address range 0xFFFE0000-0xFFFFFFFF is untranslated
</span><span class='line'>staf@petronella:~/libreboot/libreboot_r20160907_src$ </span></code></pre></td></tr></table></div></figure>


<p>The installation is completed! Reboot our system and enjoy your Free As In Freedom Laptop.</p>

<p><img class="centre" src="http://stafwag.github.io/blog/images/x60_free.jpg" width="750" height="853" title="&#34;Thinkpad x60 open&#34;" alt="&#34;Thinkpad x60 open&#34;"></p>

<p style="font-style: italic;">
Have fun
</p>


<h1>Links</h1>

<ul>
<li><a href="https://www.libreboot.org"><a href="https://www.libreboot.org">https://www.libreboot.org</a></a></li>
<li><a href="https://libreboot.org/docs/install/#rom"><a href="https://libreboot.org/docs/install/#rom">https://libreboot.org/docs/install/#rom</a></a></li>
<li><a href="https://www.coreboot.org/Board:lenovo/x60/Installation"><a href="https://www.coreboot.org/Board:lenovo/x60/Installation">https://www.coreboot.org/Board:lenovo/x60/Installation</a></a></li>
<li><a href="http://www.linuxjournal.com/content/libreboot-x60-part-ii-installation"><a href="http://www.linuxjournal.com/content/libreboot-x60-part-ii-installation">http://www.linuxjournal.com/content/libreboot-x60-part-ii-installation</a></a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Best Wishes 2017!]]></title>
    <link href="http://stafwag.github.io/blog/blog/2017/01/01/best-wishes-2017/"/>
    <updated>2017-01-01T09:43:34+01:00</updated>
    <id>http://stafwag.github.io/blog/blog/2017/01/01/best-wishes-2017</id>
    <content type="html"><![CDATA[<p><strong><em> Best Wishes 2017! </em></strong></p>

<p><img class="center" src="http://stafwag.github.io/blog/images/best_wishes_2017_scaled.jpg" width="1000" height="667" title="&#34;best_wishes_2017_scaled.jpg&#34;" alt="&#34;best_wishes_2017_scaled.jpg&#34;"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Install Arch on an Encrypted Btrfs Partition]]></title>
    <link href="http://stafwag.github.io/blog/blog/2016/08/30/arch-on-an-encrypted-btrfs-partition/"/>
    <updated>2016-08-30T08:59:00+02:00</updated>
    <id>http://stafwag.github.io/blog/blog/2016/08/30/arch-on-an-encrypted-btrfs-partition</id>
    <content type="html"><![CDATA[<p><img class="right" src="http://stafwag.github.io/blog/images/Arch-linux-logo.png" width="300" height="225" title="&#34;Arch Linux Logo&#34;" alt="&#34;Arch Linux Logo&#34;"></p>

<p>I&rsquo;m preparing to move <a href="http://stafwag.github.io/blog/blog/2013/08/25/the-benefits-of-stopping-smoking-dot-dot-dot/">my workstation</a> to <a href="https://www.archlinux.org/">arch linux</a> Before I&rsquo;ll install it on my physical workstation I did the installation on a virtual machine. I&rsquo;ll use <a href="https://btrfs.wiki.kernel.org/index.php/Main_Page">btrfs</a> as the filesystem during the installation. btrfs is a nice filesystem but it had some serious dataloss issue with <a href="https://btrfs.wiki.kernel.org/index.php/RAID56">RAID5/RAID6</a> recently.</p>

<p>btrfs might not stable enough for a production environment but it has some nice features like snapshots, send/recieve, compression etc. I use <a href="http://www.open-zfs.org/wiki/Main_Page">zfs</a> for my important date anyway.</p>

<h2>To encrypt or not to encrypt&hellip;</h2>

<p>It&rsquo;s possible to encrypt your boot partition <a href="https://www.gnu.org/software/grub/">grub</a> has support for <a href="https://en.wikipedia.org/wiki/Linux_Unified_Key_Setup">luks</a> volumes. This cause grub to ask for a password during the system startup you&rsquo;ll need to type in your password a second time during the system startup when you Linux initrd image is booted. It&rsquo;s possible to avoid this by adding a keyfile to your crypttab - which migh be considered as a security risk -.</p>

<p>In this howto we&rsquo;ll setup a single root partition to have full disk encryption. I&rsquo;m not sure I go with an encrypted boot partition during my final installation. I might just create an empty partition of 1G so I can move switch between an encrypted and an non-encrypted boot filesystem.</p>

<p><img class="left" src="http://stafwag.github.io/blog/images/arch-on-an-encrypted-btrfs-partition/00_boot.png" width="440" title="&#34;00_boot.png&#34;" alt="&#34;00_boot.png&#34;"></p>

<h2>Download the arch linux iso and boot it</h2>

<p>After arch linux is booted verify that you have internet access if the network card is support and dchp is enabled on you network you should get a network address.</p>

<h2>Network access</h2>

<p>To setup the system remotely we first need to setup network to our system.</p>

<h3>Verify the interface</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@archiso ~ # ip a
</span><span class='line'>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default 
</span><span class='line'>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span><span class='line'>    inet 127.0.0.1/8 scope host lo
</span><span class='line'>       valid_lft forever preferred_lft forever
</span><span class='line'>    inet6 ::1/128 scope host 
</span><span class='line'>       valid_lft forever preferred_lft forever
</span><span class='line'>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
</span><span class='line'>    link/ether 52:54:00:69:d4:94 brd ff:ff:ff:ff:ff:ff
</span><span class='line'>    inet 192.168.122.23/24 brd 192.168.122.255 scope global eth0
</span><span class='line'>       valid_lft forever preferred_lft forever
</span><span class='line'>    inet6 fe80::a7b:481f:2f70:e688/64 scope link 
</span><span class='line'>       valid_lft forever preferred_lft forever
</span><span class='line'>root@archiso ~ # </span></code></pre></td></tr></table></div></figure>


<h3>Verify internet access</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@archiso ~ # ping -c 3 8.8.8.8                                                                                      :(
</span><span class='line'>PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
</span><span class='line'>64 bytes from 8.8.8.8: icmp_seq=1 ttl=49 time=49.2 ms
</span><span class='line'>64 bytes from 8.8.8.8: icmp_seq=2 ttl=49 time=45.8 ms
</span><span class='line'>64 bytes from 8.8.8.8: icmp_seq=3 ttl=49 time=46.8 ms
</span><span class='line'>
</span><span class='line'>--- 8.8.8.8 ping statistics ---
</span><span class='line'>3 packets transmitted, 3 received, 0% packet loss, time 2003ms
</span><span class='line'>rtt min/avg/max/mdev = 45.896/47.329/49.201/1.406 ms
</span><span class='line'>root@archiso ~ # nslookup www.google.be
</span><span class='line'>Server:         192.168.122.1
</span><span class='line'>Address:        192.168.122.1#53
</span><span class='line'>
</span><span class='line'>Non-authoritative answer:
</span><span class='line'>Name:   www.google.be
</span><span class='line'>Address: 64.233.167.94
</span><span class='line'>
</span><span class='line'>root@archiso ~ # ping www.google.be
</span><span class='line'>PING www.google.be (64.233.167.94) 56(84) bytes of data.
</span><span class='line'>64 bytes from wl-in-f94.1e100.net (64.233.167.94): icmp_seq=1 ttl=46 time=58.7 ms
</span><span class='line'>64 bytes from wl-in-f94.1e100.net (64.233.167.94): icmp_seq=2 ttl=46 time=58.7 ms
</span><span class='line'>64 bytes from wl-in-f94.1e100.net (64.233.167.94): icmp_seq=3 ttl=46 time=58.4 ms
</span><span class='line'>^C
</span><span class='line'>--- www.google.be ping statistics ---
</span><span class='line'>3 packets transmitted, 3 received, 0% packet loss, time 2000ms
</span><span class='line'>rtt min/avg/max/mdev = 58.479/58.645/58.742/0.230 ms
</span><span class='line'>root@archiso ~ #                   
</span></code></pre></td></tr></table></div></figure>


<h2>ssh access</h2>

<p>If you want to install arch linux over ssh you need to assign a root passwd and start the sshd service.</p>

<h3>root password</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@archiso ~ # passwd root       
</span><span class='line'>Enter new UNIX password: 
</span><span class='line'>Retype new UNIX password: 
</span><span class='line'>passwd: password updated successfully
</span><span class='line'>root@archiso ~ # </span></code></pre></td></tr></table></div></figure>


<h3>start sshd</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@archiso ~ # systemctl list-unit-files -t service | grep ssh
</span><span class='line'>sshd.service                               disabled
</span><span class='line'>sshd@.service                              static  
</span><span class='line'>sshdgenkeys.service                        static  
</span><span class='line'>root@archiso ~ # systemctl start sshd                           
</span><span class='line'>root@archiso ~ #
</span></code></pre></td></tr></table></div></figure>


<h3>Logon remotely</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ ssh -l root 192.168.122.23
</span><span class='line'>root@192.168.122.23's password: 
</span><span class='line'>Last login: Tue Jun 30 09:06:00 2015 from 192.168.122.1
</span><span class='line'>root@archiso ~ # </span></code></pre></td></tr></table></div></figure>


<h2>Partition</h2>

<h3>Find your harddisk device name</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@archiso ~ # cat /proc/partitions
</span><span class='line'>major minor  #blocks  name
</span><span class='line'>
</span><span class='line'>   8        0  268435456 sda
</span><span class='line'>  11        0     759808 sr0
</span><span class='line'>   7        0     328616 loop0
</span><span class='line'>root@archiso ~ # </span></code></pre></td></tr></table></div></figure>


<h3>Overwrite it with random data</h3>

<p>Because we are creating an ecrypted filesystem it&rsquo;s a good idea to overwrite it with random data.</p>

<p>We&rsquo;ll use badblocks for this another method is to use &ldquo;dd if=/dev/random of=/dev/xxx&rdquo; the &ldquo;dd&rdquo; method is probably the best method but is a lot slower.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@archiso ~ # badblocks -c 10240 -s -w -t random -v /dev/sda
</span><span class='line'>Checking for bad blocks in read-write mode
</span><span class='line'>From block 0 to 268435455
</span><span class='line'>Testing with random pattern: done                                                 
</span><span class='line'>Reading and comparing: done                                                 
</span><span class='line'>Pass completed, 0 bad blocks found. (0/0/0 errors)
</span><span class='line'>badblocks -c 10240 -s -w -t random -v /dev/sda  49.22s user 21.72s system 3% cpu 33:48.40 total
</span><span class='line'>root@archiso ~ # </span></code></pre></td></tr></table></div></figure>


<h3>Partition the harddisk</h3>

<p>Create 3 partitions:</p>

<ul>
<li>1G /boot (we&rsquo;ll not use this during the installation - see above - )</li>
<li>32G swap</li>
<li>root btrfs partition</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@archiso ~ # fdisk /dev/sda                                
</span><span class='line'>
</span><span class='line'>Welcome to fdisk (util-linux 2.28).                                                    
</span><span class='line'>Changes will remain in memory only, until you decide to write them.
</span><span class='line'>Be careful before using the write command.
</span><span class='line'>
</span><span class='line'>Device does not contain a recognized partition table.
</span><span class='line'>Created a new DOS disklabel with disk identifier 0x7ff944e5.
</span><span class='line'>
</span><span class='line'>Command (m for help): p
</span><span class='line'>Disk /dev/sda: 256 GiB, 274877906944 bytes, 536870912 sectors
</span><span class='line'>Units: sectors of 1 * 512 = 512 bytes
</span><span class='line'>Sector size (logical/physical): 512 bytes / 512 bytes
</span><span class='line'>I/O size (minimum/optimal): 512 bytes / 512 bytes
</span><span class='line'>Disklabel type: dos
</span><span class='line'>Disk identifier: 0x7ff944e5
</span><span class='line'>
</span><span class='line'>Command (m for help): n
</span><span class='line'>Partition type
</span><span class='line'>   p   primary (0 primary, 0 extended, 4 free)
</span><span class='line'>   e   extended (container for logical partitions)
</span><span class='line'>Select (default p): p
</span><span class='line'>Partition number (1-4, default 1): 1
</span><span class='line'>First sector (2048-536870911, default 2048): +1G
</span><span class='line'>Value out of range.
</span><span class='line'>First sector (2048-536870911, default 2048): 
</span><span class='line'>Last sector, +sectors or +size{K,M,G,T,P} (2048-536870911, default 536870911): 
</span><span class='line'>Do you really want to quit? y
</span><span class='line'>1 root@archiso ~ # fdisk /dev/sda                                                   :(
</span><span class='line'>
</span><span class='line'>Welcome to fdisk (util-linux 2.28).                                                    
</span><span class='line'>Changes will remain in memory only, until you decide to write them.
</span><span class='line'>Be careful before using the write command.
</span><span class='line'>
</span><span class='line'>Device does not contain a recognized partition table.
</span><span class='line'>Created a new DOS disklabel with disk identifier 0xa806e281.
</span><span class='line'>
</span><span class='line'>Command (m for help): p
</span><span class='line'>Disk /dev/sda: 256 GiB, 274877906944 bytes, 536870912 sectors
</span><span class='line'>Units: sectors of 1 * 512 = 512 bytes
</span><span class='line'>Sector size (logical/physical): 512 bytes / 512 bytes
</span><span class='line'>I/O size (minimum/optimal): 512 bytes / 512 bytes
</span><span class='line'>Disklabel type: dos
</span><span class='line'>Disk identifier: 0xa806e281
</span><span class='line'>
</span><span class='line'>Command (m for help): n
</span><span class='line'>Partition type
</span><span class='line'>   p   primary (0 primary, 0 extended, 4 free)
</span><span class='line'>   e   extended (container for logical partitions)
</span><span class='line'>Select (default p): p
</span><span class='line'>Partition number (1-4, default 1): 1
</span><span class='line'>First sector (2048-536870911, default 2048): 
</span><span class='line'>Last sector, +sectors or +size{K,M,G,T,P} (2048-536870911, default 536870911): +1G
</span><span class='line'>
</span><span class='line'>Created a new partition 1 of type 'Linux' and of size 1 GiB.
</span><span class='line'>
</span><span class='line'>Command (m for help): n
</span><span class='line'>Partition type
</span><span class='line'>   p   primary (1 primary, 0 extended, 3 free)
</span><span class='line'>   e   extended (container for logical partitions)
</span><span class='line'>Select (default p): p
</span><span class='line'>Partition number (2-4, default 2): 
</span><span class='line'>First sector (2099200-536870911, default 2099200): 
</span><span class='line'>Last sector, +sectors or +size{K,M,G,T,P} (2099200-536870911, default 536870911): +32G
</span><span class='line'>
</span><span class='line'>Created a new partition 2 of type 'Linux' and of size 32 GiB.
</span><span class='line'>
</span><span class='line'>Command (m for help): n
</span><span class='line'>Partition type
</span><span class='line'>   p   primary (2 primary, 0 extended, 2 free)
</span><span class='line'>   e   extended (container for logical partitions)
</span><span class='line'>Select (default p): p
</span><span class='line'>Partition number (3,4, default 3): 
</span><span class='line'>First sector (69208064-536870911, default 69208064): 
</span><span class='line'>Last sector, +sectors or +size{K,M,G,T,P} (69208064-536870911, default 536870911): 
</span><span class='line'>
</span><span class='line'>Created a new partition 3 of type 'Linux' and of size 223 GiB.
</span><span class='line'>
</span><span class='line'>Command (m for help): w
</span><span class='line'>The partition table has been altered.
</span><span class='line'>Calling ioctl() to re-read partition table.
</span><span class='line'>Syncing disks.
</span><span class='line'>
</span><span class='line'>root@archiso ~ # </span></code></pre></td></tr></table></div></figure>


<h3>Format the root partition</h3>

<p>We&rsquo;ll continue with the root filesystem - we&rsquo;ll initialize the swapspace after the installation -</p>

<h4>Create the root luks volume;</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@archiso ~ # cryptsetup luksFormat --cipher aes-xts-plain64 --key-size 256 --hash sha256 --use-random /dev/sda3
</span><span class='line'>
</span><span class='line'>WARNING!
</span><span class='line'>========
</span><span class='line'>This will overwrite data on /dev/sda3 irrevocably.
</span><span class='line'>
</span><span class='line'>Are you sure? (Type uppercase yes): YES
</span><span class='line'>Enter passphrase: 
</span><span class='line'>Verify passphrase: 
</span><span class='line'>5.01s user 0.04s system 21% cpu 23.750 total
</span><span class='line'>root@archiso ~ # </span></code></pre></td></tr></table></div></figure>


<h4>Open the root luks volume</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@archiso ~ # cryptsetup luksOpen /dev/sda3 cryptroot
</span><span class='line'>Enter passphrase for /dev/sda3: 
</span><span class='line'>root@archiso ~ # </span></code></pre></td></tr></table></div></figure>


<h4>Format the root volume with btrfs</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@archiso ~ # mkfs.btrfs /dev/mapper/cryptroot
</span><span class='line'>btrfs-progs v4.6.1
</span><span class='line'>See http://btrfs.wiki.kernel.org for more information.
</span><span class='line'>
</span><span class='line'>Label:              (null)
</span><span class='line'>UUID:               cbfcc8d6-0cf9-4656-bcda-2525faeadfe6
</span><span class='line'>Node size:          16384
</span><span class='line'>Sector size:        4096
</span><span class='line'>Filesystem size:    217.00GiB
</span><span class='line'>Block group profiles:
</span><span class='line'>  Data:             single            8.00MiB
</span><span class='line'>  Metadata:         DUP               1.01GiB
</span><span class='line'>  System:           DUP              12.00MiB
</span><span class='line'>SSD detected:       no
</span><span class='line'>Incompat features:  extref, skinny-metadata
</span><span class='line'>Number of devices:  1
</span><span class='line'>Devices:
</span><span class='line'>   ID        SIZE  PATH
</span><span class='line'>    1   217.00GiB  /dev/mapper/cryptroot
</span><span class='line'>
</span><span class='line'>root@archiso ~ # </span></code></pre></td></tr></table></div></figure>


<h4>Mount the root filesystem</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@archiso ~ # mount -o noatime,compress=lzo,discard,ssd,defaults /dev/mapper/cryptroot /mnt
</span><span class='line'>root@archiso ~ # </span></code></pre></td></tr></table></div></figure>


<h4>Create the subvolumes</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@archiso ~ # cd /mnt
</span><span class='line'>root@archiso /mnt # btrfs subvolume create __active
</span><span class='line'>Create subvolume './__active'
</span><span class='line'>root@archiso /mnt # btrfs subvolume create __active/rootvol
</span><span class='line'>Create subvolume '__active/rootvol'
</span><span class='line'>root@archiso /mnt # btrfs subvolume create __active/home
</span><span class='line'>Create subvolume '__active/home'
</span><span class='line'>root@archiso /mnt # btrfs subvolume create __active/var
</span><span class='line'>Create subvolume '__active/var'
</span><span class='line'>root@archiso /mnt # btrfs subvolume create __snapshots
</span><span class='line'>Create subvolume './__snapshots'
</span><span class='line'>root@archiso /mnt #</span></code></pre></td></tr></table></div></figure>


<h4>Mount the subvolumes</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@archiso /mnt # cd 
</span><span class='line'>root@archiso ~ # umount /mnt
</span><span class='line'>root@archiso ~ # mount -o noatime,compress=lzo,discard,ssd,defaults,subvol=__active/rootvol /dev/mapper/cryptroot /mnt
</span><span class='line'>root@archiso ~ # mkdir /mnt/{home,var}
</span><span class='line'>root@archiso ~ # mount -o noatime,compress=lzo,discard,ssd,defaults,subvol=__active/home /dev/mapper/cryptroot /mnt/home
</span><span class='line'>root@archiso ~ # mount -o noatime,compress=lzo,discard,ssd,defaults,subvol=__active/var /dev/mapper/cryptroot /mnt/var
</span><span class='line'>root@archiso ~ # sync
</span><span class='line'>root@archiso ~ # </span></code></pre></td></tr></table></div></figure>


<h2>System installation</h2>

<h3>bootstrap the system</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@archiso ~ # pacstrap /mnt base base-devel btrfs-progs
</span><span class='line'>==&gt; Creating install root at /mnt
</span><span class='line'>==&gt; Installing packages to /mnt
</span><span class='line'>:: Synchronizing package databases...
</span><span class='line'> core                     119.9 KiB   652K/s 00:00 [######################] 100%
</span><span class='line'> extra                   1760.1 KiB   688K/s 00:03 [######################] 100%
</span><span class='line'> community                  3.6 MiB   906K/s 00:04 [######################] 100%
</span><span class='line'>:: There are 50 members in group base:
</span><span class='line'>:: Repository core
</span><span class='line'>   1) bash  2) bzip2  3) coreutils  4) cryptsetup  5) device-mapper  6) dhcpcd
</span><span class='line'>   7) diffutils  8) e2fsprogs  9) file  10) filesystem  11) findutils  12) gawk
</span><span class='line'>   13) gcc-libs  14) gettext  15) glibc  16) grep  17) gzip  18) inetutils
</span><span class='line'>   19) iproute2  20) iputils  21) jfsutils  22) less  23) licenses  24) linux
</span><span class='line'>   25) logrotate  26) lvm2  27) man-db  28) man-pages  29) mdadm  30) nano
</span><span class='line'>   31) netctl  32) pacman  33) pciutils  34) pcmciautils  35) perl
</span><span class='line'>   36) procps-ng  37) psmisc  38) reiserfsprogs  39) s-nail  40) sed
</span><span class='line'>   41) shadow  42) sysfsutils  43) systemd-sysvcompat  44) tar  45) texinfo
</span><span class='line'>   46) usbutils  47) util-linux  48) vi  49) which  50) xfsprogs
</span><span class='line'>
</span><span class='line'>Enter a selection (default=all): 
</span><span class='line'>:: There are 25 members in group base-devel:
</span><span class='line'>:: Repository core
</span><span class='line'>   1) autoconf  2) automake  3) binutils  4) bison  5) fakeroot  6) file
</span><span class='line'>   7) findutils  8) flex  9) gawk  10) gcc  11) gettext  12) grep  13) groff
</span><span class='line'>   14) gzip  15) libtool  16) m4  17) make  18) pacman  19) patch
</span><span class='line'>   20) pkg-config  21) sed  22) sudo  23) texinfo  24) util-linux  25) which
</span><span class='line'>
</span><span class='line'>Enter a selection (default=all): 
</span><span class='line'>warning: skipping target: file
</span><span class='line'>warning: skipping target: findutils
</span><span class='line'>warning: skipping target: gawk
</span><span class='line'>warning: skipping target: gettext
</span><span class='line'>warning: skipping target: grep
</span><span class='line'>warning: skipping target: gzip
</span><span class='line'>warning: skipping target: pacman
</span><span class='line'>warning: skipping target: sed
</span><span class='line'>warning: skipping target: texinfo
</span><span class='line'>warning: skipping target: util-linux
</span><span class='line'>warning: skipping target: which
</span><span class='line'>resolving dependencies...
</span><span class='line'>looking for conflicting packages...
</span><span class='line'>
</span><span class='line'>Packages (144) acl-2.2.52-2  archlinux-keyring-20160812-1  attr-2.4.47-1
</span><span class='line'>               ca-certificates-20160507-1  ca-certificates-cacert-20140824-3
</span><span class='line'>               ca-certificates-mozilla-3.26-1  ca-certificates-utils-20160507-1
</span><span class='line'>               cracklib-2.9.6-1  curl-7.50.1-1  db-5.3.28-3  dbus-1.10.8-1
</span><span class='line'>               expat-2.2.0-2  gc-7.4.2-4  gdbm-1.12-2  glib2-2.48.1-1
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>               procps-ng-3.3.12-1  psmisc-22.21-3  reiserfsprogs-3.6.25-1
</span><span class='line'>               s-nail-14.8.10-1  sed-4.2.2-4  shadow-4.2.1-3  sudo-1.8.17.p1-1
</span><span class='line'>               sysfsutils-2.1.0-9  systemd-sysvcompat-231-1  tar-1.29-1
</span><span class='line'>               texinfo-6.1-4  usbutils-008-1  util-linux-2.28.1-1
</span><span class='line'>               vi-1:070224-2  which-2.21-2  xfsprogs-4.7.0-1
</span><span class='line'>
</span><span class='line'>Total Download Size:   231.85 MiB
</span><span class='line'>Total Installed Size:  801.27 MiB
</span><span class='line'>
</span><span class='line'>:: Proceed with installation? [Y/n] 
</span><span class='line'>:: Retrieving packages...
</span><span class='line'> linux-api-headers-4...   810.7 KiB   891K/s 00:01 [######################] 100%
</span><span class='line'> tzdata-2016f-1-any       215.4 KiB   909K/s 00:00 [######################] 100%
</span><span class='line'> iana-etc-20160513-1-any  352.2 KiB   723K/s 00:00 [######################] 100%
</span><span class='line'> filesystem-2015.09-...     8.8 KiB   875K/s 00:00 [######################] 100%
</span><span class='line'> glibc-2.24-2-x86_64        8.1 MiB   918K/s 00:09 [######################] 100%
</span><span class='line'> gcc-libs-6.1.1-5-x86_64   14.9 MiB   899K/s 00:17 [######################] 100%
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>(144/144) installing btrfs-progs                   [######################] 100%
</span><span class='line'>:: Running post-transaction hooks...
</span><span class='line'>(1/4) Updating manpage index...
</span><span class='line'>mandb: can't set the locale; make sure $LC_* and $LANG are correct
</span><span class='line'>(2/4) Updating the info directory file...
</span><span class='line'>(3/4) Updating udev Hardware Database...
</span><span class='line'>(4/4) Rebuilding certificate stores...
</span><span class='line'>pacstrap /mnt base base-devel btrfs-progs  27.81s user 10.20s system 10% cpu 5:50.56 total
</span><span class='line'>root@archiso ~ # </span></code></pre></td></tr></table></div></figure>


<h3>Generate /etc/fstab</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@archiso ~ # genfstab -p /mnt &gt;&gt; /mnt/etc/fstab
</span><span class='line'>root@archiso ~ # vi /mnt/etc/fstab
</span><span class='line'># 
</span><span class='line'># /etc/fstab: static file system information
</span><span class='line'>#
</span><span class='line'># &lt;file system&gt; &lt;dir&gt;   &lt;type&gt;  &lt;options&gt;       &lt;dump&gt;  &lt;pass&gt;
</span><span class='line'># UUID=c8ca38de-4e58-4c7c-8f5b-c9c3f92f6a24
</span><span class='line'>/dev/mapper/cryptroot   /               btrfs           rw,noatime,compress=lzo,ssd,dis
</span><span class='line'>card,space_cache,subvolid=258,subvol=/__active/rootvol,subvol=__active/rootvol  0 0
</span><span class='line'>
</span><span class='line'># UUID=c8ca38de-4e58-4c7c-8f5b-c9c3f92f6a24
</span><span class='line'>/dev/mapper/cryptroot   /home           btrfs           rw,noatime,compress=lzo,ssd,dis
</span><span class='line'>card,space_cache,subvolid=259,subvol=/__active/home,subvol=__active/home        0 0
</span><span class='line'>
</span><span class='line'># UUID=c8ca38de-4e58-4c7c-8f5b-c9c3f92f6a24
</span><span class='line'>/dev/mapper/cryptroot   /var            btrfs           rw,noatime,compress=lzo,ssd,dis
</span><span class='line'>card,space_cache,subvolid=260,subvol=/__active/var,subvol=__active/var  0 0</span></code></pre></td></tr></table></div></figure>


<h3>chroot</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@archiso ~ # arch-chroot /mnt
</span><span class='line'>[root@archiso /]# </span></code></pre></td></tr></table></div></figure>


<h3>Set the timezone</h3>

<p>Link for timezone to /etc/localtime</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@archiso /]# ln -s /usr/share/zoneinfo/Europe/Brussels /etc/localtime
</span><span class='line'>[root@archiso /]# </span></code></pre></td></tr></table></div></figure>


<p>Set the hardwareclock to UTC</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>hwclock --systohc --utc</span></code></pre></td></tr></table></div></figure>


<h3>Generate the required locales</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@archiso /]# vi /etc/locale.gen 
</span><span class='line'>[root@archiso /]# locale-gen
</span><span class='line'>Generating locales...
</span><span class='line'>  en_IE.UTF-8... done
</span><span class='line'>  en_IE.ISO-8859-1... done
</span><span class='line'>  en_IE.ISO-8859-15@euro... done
</span><span class='line'>  en_US.UTF-8... done
</span><span class='line'>  en_US.ISO-8859-1... done
</span><span class='line'>  nl_BE.UTF-8... done
</span><span class='line'>  nl_BE.ISO-8859-1... done
</span><span class='line'>  nl_BE.ISO-8859-15@euro... done
</span><span class='line'>Generation complete.
</span><span class='line'>[root@archiso /]# </span></code></pre></td></tr></table></div></figure>


<h3>Hostname</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@archiso /]# vi /etc/hostname
</span><span class='line'>[root@archiso /]# 
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@archiso /]# vi /etc/hosts</span></code></pre></td></tr></table></div></figure>


<h3>mkinitcpio</h3>

<h4>HOOKS</h4>

<p>Add encrypt to HOOKS before filesystems in /etc/mkinitcpio.conf</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@archiso /]# vi /etc/mkinitcpio.conf </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>HOOKS="base udev autodetect modconf block encrypt filesystems keyboard fsck"</span></code></pre></td></tr></table></div></figure>


<h4>Create boot image</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@archiso /]# mkinitcpio -p linux
</span><span class='line'>==&gt; Building image from preset: /etc/mkinitcpio.d/linux.preset: 'default'
</span><span class='line'>  -&gt; -k /boot/vmlinuz-linux -c /etc/mkinitcpio.conf -g /boot/initramfs-linux.img
</span><span class='line'>==&gt; Starting build: 4.7.1-1-ARCH
</span><span class='line'>  -&gt; Running build hook: [base]
</span><span class='line'>  -&gt; Running build hook: [udev]
</span><span class='line'>  -&gt; Running build hook: [autodetect]
</span><span class='line'>  -&gt; Running build hook: [modconf]
</span><span class='line'>  -&gt; Running build hook: [block]
</span><span class='line'>  -&gt; Running build hook: [encrypt]
</span><span class='line'>  -&gt; Running build hook: [filesystems]
</span><span class='line'>  -&gt; Running build hook: [keyboard]
</span><span class='line'>  -&gt; Running build hook: [fsck]
</span><span class='line'>==&gt; Generating module dependencies
</span><span class='line'>==&gt; Creating gzip-compressed initcpio image: /boot/initramfs-linux.img
</span><span class='line'>==&gt; Image generation successful
</span><span class='line'>==&gt; Building image from preset: /etc/mkinitcpio.d/linux.preset: 'fallback'
</span><span class='line'>  -&gt; -k /boot/vmlinuz-linux -c /etc/mkinitcpio.conf -g /boot/initramfs-linux-fallback.img -S autodetect
</span><span class='line'>==&gt; Starting build: 4.7.1-1-ARCH
</span><span class='line'>  -&gt; Running build hook: [base]
</span><span class='line'>  -&gt; Running build hook: [udev]
</span><span class='line'>  -&gt; Running build hook: [modconf]
</span><span class='line'>  -&gt; Running build hook: [block]
</span><span class='line'>==&gt; WARNING: Possibly missing firmware for module: wd719x
</span><span class='line'>==&gt; WARNING: Possibly missing firmware for module: aic94xx
</span><span class='line'>  -&gt; Running build hook: [encrypt]
</span><span class='line'>  -&gt; Running build hook: [filesystems]
</span><span class='line'>  -&gt; Running build hook: [keyboard]
</span><span class='line'>  -&gt; Running build hook: [fsck]
</span><span class='line'>==&gt; Generating module dependencies
</span><span class='line'>==&gt; Creating gzip-compressed initcpio image: /boot/initramfs-linux-fallback.img
</span><span class='line'>==&gt; Image generation successful
</span><span class='line'>[root@archiso /]#</span></code></pre></td></tr></table></div></figure>


<h3>set the root password</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@archiso /]# passwd root
</span><span class='line'>New password: 
</span><span class='line'>Retype new password: 
</span><span class='line'>passwd: password updated successfully
</span><span class='line'>[root@archiso /]# </span></code></pre></td></tr></table></div></figure>


<h3>GRUB</h3>

<h4>install Grub</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@archiso /]# pacman -Sy grub
</span><span class='line'>:: Synchronizing package databases...
</span><span class='line'> core is up to date
</span><span class='line'> extra                   1760.1 KiB   917K/s 00:02 [######################] 100%
</span><span class='line'> community                  3.6 MiB   896K/s 00:04 [######################] 100%
</span><span class='line'>resolving dependencies...
</span><span class='line'>looking for conflicting packages...
</span><span class='line'>
</span><span class='line'>Packages (1) grub-1:2.02.beta3-3
</span><span class='line'>
</span><span class='line'>Total Download Size:    5.83 MiB
</span><span class='line'>Total Installed Size:  28.70 MiB
</span><span class='line'>
</span><span class='line'>:: Proceed with installation? [Y/n] y
</span><span class='line'>:: Retrieving packages...
</span><span class='line'> grub-1:2.02.beta3-3...     5.8 MiB   917K/s 00:07 [######################] 100%
</span><span class='line'>(1/1) checking keys in keyring                     [######################] 100%
</span><span class='line'>(1/1) checking package integrity                   [######################] 100%
</span><span class='line'>(1/1) loading package files                        [######################] 100%
</span><span class='line'>(1/1) checking for file conflicts                  [######################] 100%
</span><span class='line'>(1/1) checking available disk space                [######################] 100%
</span><span class='line'>:: Processing package changes...
</span><span class='line'>(1/1) installing grub                              [######################] 100%
</span><span class='line'>Generating grub.cfg.example config file...
</span><span class='line'>This may fail on some machines running a custom kernel.
</span><span class='line'>done.
</span><span class='line'>Optional dependencies for grub
</span><span class='line'>    freetype2: For grub-mkfont usage
</span><span class='line'>    fuse: For grub-mount usage
</span><span class='line'>    dosfstools: For grub-mkrescue FAT FS and EFI support
</span><span class='line'>    efibootmgr: For grub-install EFI support
</span><span class='line'>    libisoburn: Provides xorriso for generating grub rescue iso using
</span><span class='line'>    grub-mkrescue
</span><span class='line'>    os-prober: To detect other OSes when generating grub.cfg in BIOS systems
</span><span class='line'>    mtools: For grub-mkrescue FAT FS support
</span><span class='line'>:: Running post-transaction hooks...
</span><span class='line'>(1/2) Updating manpage index...
</span><span class='line'>(2/2) Updating the info directory file...
</span><span class='line'>[root@archiso /]# </span></code></pre></td></tr></table></div></figure>


<h4>Install grub to your boot disk</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@archiso /]# grub-install --target=i386-pc /dev/sda
</span><span class='line'>Installing for i386-pc platform.
</span><span class='line'>grub-install: error: attempt to install to encrypted disk without cryptodisk enabled. Set `GRUB_ENABLE_CRYPTODISK=y' in file `/etc/default/grub'.
</span><span class='line'>[root@archiso /]# 
</span></code></pre></td></tr></table></div></figure>


<h4>Enable cryptodisk</h4>

<p>Because we use an encrypted boot disk we need to enable cryptdisk support.</p>

<p>Add  GRUB_ENABLE_CRYPTODISK=y to /etc/default/grub</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@archiso /]# vi /etc/default/grub
</span><span class='line'>[root@archiso /]# 
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>GRUB_DEFAULT=0
</span><span class='line'>GRUB_TIMEOUT=5
</span><span class='line'>GRUB_DISTRIBUTOR="Arch"
</span><span class='line'>GRUB_CMDLINE_LINUX_DEFAULT="quiet"
</span><span class='line'>GRUB_CMDLINE_LINUX=""
</span><span class='line'>GRUB_ENABLE_CRYPTODISK=y</span></code></pre></td></tr></table></div></figure>


<p>And run grub-install again</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@archiso /]# grub-install --target=i386-pc /dev/sda
</span><span class='line'>Installing for i386-pc platform.
</span><span class='line'>Installation finished. No error reported.
</span><span class='line'>[root@archiso /]# </span></code></pre></td></tr></table></div></figure>


<h4>Create grub.cfg</h4>

<p>Add your encrypted root partition to GRUB_CMDLINE_LINUX= in /etc/default/grub</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>GRUB_DEFAULT=0
</span><span class='line'>GRUB_TIMEOUT=5
</span><span class='line'>GRUB_DISTRIBUTOR="Arch"
</span><span class='line'>GRUB_CMDLINE_LINUX_DEFAULT="quiet"
</span><span class='line'>GRUB_CMDLINE_LINUX=""cryptdevice=/dev/sda3:cryptroot""
</span><span class='line'>ENABLE_CRYPTODISK=y 
</span></code></pre></td></tr></table></div></figure>


<p>And generate grub.cfg</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@archiso /]# grub-mkconfig -o /boot/grub/grub.cfg
</span><span class='line'>Generating grub configuration file ...
</span><span class='line'>Found linux image: /boot/vmlinuz-linux
</span><span class='line'>Found initrd image(s) in /boot: initramfs-linux.img
</span><span class='line'>Found fallback initrd image(s) in /boot: initramfs-linux-fallback.img
</span><span class='line'>done
</span><span class='line'>[root@archiso /]# 
</span></code></pre></td></tr></table></div></figure>


<h2>Reboot</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@archiso /]# vi /boot/grub/grub.cfg
</span><span class='line'>[root@archiso /]# sync
</span><span class='line'>[root@archiso /]# reboot
</span><span class='line'>Running in chroot, ignoring request.
</span><span class='line'>[root@archiso /]# exit
</span><span class='line'>arch-chroot /mnt  9.76s user 1.37s system 0% cpu 23:13.29 total
</span><span class='line'>root@archiso ~ # reboot</span></code></pre></td></tr></table></div></figure>


<h2>Finish the installation</h2>

<h3>1st boot</h3>

<p>As mentioned before the GRUB will as for a passphrase to decrypt the boot partition.</p>

<p><img class="center" src="http://stafwag.github.io/blog/images/arch-on-an-encrypted-btrfs-partition/01_1st_boot.png" width="700" height="274" title="&#34;01_1st_boot.png&#34;" alt="&#34;01_1st_boot.png&#34;">
<img class="center" src="http://stafwag.github.io/blog/images/arch-on-an-encrypted-btrfs-partition/02_1st_grub_menu.png" width="700" height="484" title="&#34;01_1st_boot.png&#34;" alt="&#34;01_1st_boot.png&#34;"></p>

<p>You&rsquo;ll need to type it the password a secod time during the loading of initrd.</p>

<p><img class="center" src="http://stafwag.github.io/blog/images/arch-on-an-encrypted-btrfs-partition/02_1st_decrypt_root.png" width="700" height="165" title="&#34;01_1st_boot.png&#34;" alt="&#34;01_1st_boot.png&#34;"></p>

<h3>Setup swap space</h3>

<p>Update /etc/crypttab</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>swap         /dev/sda2                                    /dev/urandom            swap,
</span><span class='line'>cipher=aes-cbc-essiv:sha256,size=256</span></code></pre></td></tr></table></div></figure>


<p>reboot the system to verify that the encrypted swap partition is mapper correctly during the system startup</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# ls -l /dev/mapper/
</span><span class='line'>total 0
</span><span class='line'>crw------- 1 root root 10, 236 Aug 29 15:43 control
</span><span class='line'>lrwxrwxrwx 1 root root       7 Aug 29 15:43 cryptroot -&gt; ../dm-0
</span><span class='line'>lrwxrwxrwx 1 root root       7 Aug 29 15:43 swap -&gt; ../dm-1
</span><span class='line'>[root@vicky ~]# </span></code></pre></td></tr></table></div></figure>


<p>Create swap</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# mkswap /dev/mapper/swap 
</span><span class='line'>Setting up swapspace version 1, size = 32 GiB (34359734272 bytes)
</span><span class='line'>no label, UUID=66ea5a08-0833-4e84-8b95-f1a9c2d772b2
</span><span class='line'>[root@vicky ~]# </span></code></pre></td></tr></table></div></figure>


<p>Activate swap</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# swapon /dev/mapper/swap
</span><span class='line'>[root@vicky ~]# free
</span><span class='line'>              total        used        free      shared  buff/cache   available
</span><span class='line'>Mem:        4051236       85932     3890708         440       74596     3807084
</span><span class='line'>Swap:      33554428           0    33554428
</span><span class='line'>[root@vicky ~]# </span></code></pre></td></tr></table></div></figure>


<p>Update /etc/fstab</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/dev/mapper/swap swap                    swap    defaults,discard,pri=3        0 0 </span></code></pre></td></tr></table></div></figure>




<p style="font-style: italic;">
Have fun
</p>


<h2>Links</h2>

<ul>
<li><a href="https://wiki.archlinux.org/index.php/Installation_guide"><a href="https://wiki.archlinux.org/index.php/Installation_guide">https://wiki.archlinux.org/index.php/Installation_guide</a></a></li>
<li><a href="http://www.brunoparmentier.be/blog/how-to-install-arch-linux-on-an-encrypted-btrfs-partition.html"><a href="http://www.brunoparmentier.be/blog/how-to-install-arch-linux-on-an-encrypted-btrfs-partition.html">http://www.brunoparmentier.be/blog/how-to-install-arch-linux-on-an-encrypted-btrfs-partition.html</a></a></li>
<li><a href="http://blog.fabio.mancinelli.me/2012/12/28/Arch_Linux_on_BTRFS.html"><a href="http://blog.fabio.mancinelli.me/2012/12/28/Arch_Linux_on_BTRFS.html">http://blog.fabio.mancinelli.me/2012/12/28/Arch_Linux_on_BTRFS.html</a></a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[CGIpaf 1.3.5 Released]]></title>
    <link href="http://stafwag.github.io/blog/blog/2016/04/13/cgipaf-1-dot-3-5-released/"/>
    <updated>2016-04-13T11:00:13+02:00</updated>
    <id>http://stafwag.github.io/blog/blog/2016/04/13/cgipaf-1-dot-3-5-released</id>
    <content type="html"><![CDATA[<p>CGIpaf 1.3.5 has been released</p>

<h3>ChangeLog</h3>

<h5>version 1.3.5         ( 13 Apr 2016 )</h5>

<blockquote><ul>
<li>pwd_mkdb errors were not handled correctly on BSD</li>
<li>kyua test scripts added</li>
</ul>
</blockquote>

<p>CGIpaf 1.3.5 is  available at: <a href="http://www.wagemakers.be/english/programs/cgipaf"><a href="http://www.wagemakers.be/english/programs/cgipaf">http://www.wagemakers.be/english/programs/cgipaf</a></a></p>

<p>Download the tarball directly at:  <a href="http://www.wagemakers.be/downloads/cgipaf/"><a href="http://www.wagemakers.be/downloads/cgipaf/">http://www.wagemakers.be/downloads/cgipaf/</a></a></p>

<p>Or at the the Git repository  on github: <a href="https://github.com/stafwag/cgipaf"><a href="https://github.com/stafwag/cgipaf">https://github.com/stafwag/cgipaf</a></a></p>

<p style="font-style: italic;">
Have fun...
</p>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Thunderbird: Importing S/mime Certificate Failed]]></title>
    <link href="http://stafwag.github.io/blog/blog/2016/01/17/thunderbird-importing-s-slash-mime-certificate-failed/"/>
    <updated>2016-01-17T09:03:53+01:00</updated>
    <id>http://stafwag.github.io/blog/blog/2016/01/17/thunderbird-importing-s-slash-mime-certificate-failed</id>
    <content type="html"><![CDATA[<p><img class="left" src="http://stafwag.github.io/blog/images/thunderbird_import_smime_failed.png" width="1000" height="835" title="&#34;thunderbird smime failed&#34;" alt="&#34;thunderbird smime failed&#34;"></p>

<p>On <a href="http://kb.mozillazine.org/Getting_an_SMIME_certificate"><a href="http://kb.mozillazine.org/Getting_an_SMIME_certificate">http://kb.mozillazine.org/Getting_an_SMIME_certificate</a></a>
you get a list of free <a href="https://en.wikipedia.org/wiki/S/MIME">s/mime</a> certificate.</p>

<p>I ordered a free 30 days certificate at <a href="globalsign">globalsign</a>: <a href="https://www.globalsign.com/en/personalsign/trial/"><a href="https://www.globalsign.com/en/personalsign/trial/">https://www.globalsign.com/en/personalsign/trial/</a></a></p>

<p>The import of the <a href="https://en.wikipedia.org/wiki/PKCS_12">pkcs12</a> failed in Thunderbird with the message: &ldquo;The PKCS #12 operation failed for unknown reasons.&rdquo;</p>

<p>Searching the internet didn&rsquo;t provide a solution. To debug this issue I started to extract the private / certificate from the pkcs12 file provided by globalsign and creating a new one.</p>

<p>To execute this command I use an encrypted <a href="https://gitlab.com/cryptsetup/cryptsetup/blob/master/README.md">luks</a> volume.</p>

<h1>Create a new pkcs12 file</h1>

<h2>verifying the pkx file</h2>

<h3>password too long?</h3>

<p>The first issue was that the password of my pkx was too long by default the openssl pkcs12 command seems to have a limit of 32 characters.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky staf@wagemakers.be]$ openssl pkcs12 -in staf.pkx 
</span><span class='line'>Enter Import Password:
</span><span class='line'>Can't read Password
</span><span class='line'>[staf@vicky staf@wagemakers.be]$ </span></code></pre></td></tr></table></div></figure>


<p>Use the &ldquo;-passin pass&rdquo;, &ldquo;-passin stdin&rdquo; or &ldquo;-passin file&rdquo; argument resolves this issue. The &ldquo;-passin pass&rdquo; argument will show the password on the screen and in shell history, the &ldquo;-passin stdin&rdquo; will show your password on the screen, the &ldquo;-passin file&rdquo; will leave your password on the (hopefully encrypted) filesystem  so I went with the &ldquo;-pass file&rdquo; option.</p>

<h3>Created password file</h3>

<p>Create the file that holds your password with the corrected file permissions, you must be the only one that is able to read this file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky staf@wagemakers.be]$ touch pass
</span><span class='line'>[staf@vicky staf@wagemakers.be]$ chmod 600 pass
</span><span class='line'>[staf@vicky staf@wagemakers.be]$ vi pass</span></code></pre></td></tr></table></div></figure>


<h3>Try again</h3>

<p>With the &ldquo;-passin file&rdquo; argument we are able to the pkcs12 file.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky staf@wagemakers.be]$ openssl pkcs12 -in staf.pkx -passin file:pass
</span><span class='line'>MAC verified OK
</span><span class='line'>Bag Attributes
</span><span class='line'>    localKeyID: 9B B7 F3 7A 96 46 1F 08 28 A2 BC 2B 87 0E 53 92 29 B4 7D 7D 
</span><span class='line'>Key Attributes: &lt;No Attributes&gt;
</span><span class='line'>Enter PEM pass phrase:
</span><span class='line'>Bag Attributes
</span><span class='line'>    localKeyID: 9B B7 F3 7A 96 46 1F 08 28 A2 BC 2B 87 0E 53 92 29 B4 7D 7D 
</span><span class='line'>subject=/CN=staf@wagemakers.be/emailAddress=staf@wagemakers.be
</span><span class='line'>issuer=/C=BE/O=GlobalSign nv-sa/CN=GlobalSign PersonalSign 1 CA - SHA256 - G2
</span><span class='line'>-----BEGIN CERTIFICATE-----
</span><span class='line'>&lt;snip&gt;</span></code></pre></td></tr></table></div></figure>


<h2>Extract</h2>

<p>We&rsquo;ll extract the private key and the certificates and build a new pkcs12 file and import this pkcs12 file into thunderbird.</p>

<h3>Extract the private key</h3>

<p>The private key is encrypted with the &ldquo;bag&rdquo; so need to type it or copy/pass it&hellip;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky staf@wagemakers.be]$ openssl pkcs12 -in staf.pkx -nocerts -out key.pem -passin file:pass 
</span><span class='line'>MAC verified OK
</span><span class='line'>Enter PEM pass phrase:
</span><span class='line'>Verifying - Enter PEM pass phrase:</span></code></pre></td></tr></table></div></figure>


<h3>Extract the client certificate</h3>

<p>The client certificate isn&rsquo;t encrypted so you can leave the pem password empty.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky staf@wagemakers.be]$ openssl pkcs12 -in staf.pkx -clcerts -out staf.pem -passin file:pass 
</span><span class='line'>MAC verified OK
</span><span class='line'>
</span><span class='line'>Enter PEM pass phrase:
</span><span class='line'>[staf@vicky staf@wagemakers.be]$ </span></code></pre></td></tr></table></div></figure>


<h3>Verify the key and certificate</h3>

<p>To verify that the certificate and the private belongs together we need to verify the modulus of the key and the certificate the sha1sum should match.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@vicky staf@wagemakers.be]$ openssl rsa -in key.pem -modulus -noout | sha1sum
</span><span class='line'>Enter pass phrase for key.pem:
</span><span class='line'>1234567890123456789012345678901234567890  -
</span><span class='line'>[staf@vicky staf@wagemakers.be]$ </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky staf@wagemakers.be]$ openssl x509 -in staf.pem -modulus -noout | sha1sum
</span><span class='line'>1234567890123456789012345678901234567890  -
</span><span class='line'>[staf@vicky staf@wagemakers.be]$ </span></code></pre></td></tr></table></div></figure>


<h3>Extract the signing certificate(s)</h3>

<p>The following command extracts the ca certificates.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky staf@wagemakers.be]$ openssl pkcs12 -in staf.pkx -cacerts -out cacerts.pem -passin file:pass
</span><span class='line'>MAC verified OK
</span><span class='line'>Enter PEM pass phrase:</span></code></pre></td></tr></table></div></figure>


<h2>Create a new pkcs12 file</h2>

<p>This time we use a 32 characters password.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky staf@wagemakers.be]$ openssl pkcs12 -export -in staf.pem -inkey key.pem -certfile cacerts.pem -out staf_new.p12
</span><span class='line'>Enter pass phrase for key.pem:
</span><span class='line'>Enter Export Password:
</span><span class='line'>Verifying - Enter Export Password:</span></code></pre></td></tr></table></div></figure>


<h1>Import the the new pkcs12 file</h1>

<p><img class="right" src="http://stafwag.github.io/blog/images/thunderbird_import_smime_ok.png" width="598" height="152" title="&#34;thunderbird smime import ok&#34;" alt="&#34;thunderbird smime import ok&#34;">
Not sure what the issue was with original pkcs12 but the import works now&hellip;.
 - it might have been the 32 characters password -.   After I was able to use the signing and encryption part in thunderbird.</p>

<p><strong><em> Have fun </em></strong></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Happy New Year 2016]]></title>
    <link href="http://stafwag.github.io/blog/blog/2016/01/01/happy-new-year-2016/"/>
    <updated>2016-01-01T10:24:48+01:00</updated>
    <id>http://stafwag.github.io/blog/blog/2016/01/01/happy-new-year-2016</id>
    <content type="html"><![CDATA[<p><strong><em> Happy new year! </em></strong></p>

<p><img class="center" src="http://stafwag.github.io/blog/images/2016.jpg" width="1000" height="625" title="&#34;2016.jpg&#34;" alt="&#34;2016.jpg&#34;"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Lookat 1.4.4 Released]]></title>
    <link href="http://stafwag.github.io/blog/blog/2015/12/28/lookat-1-dot-4-4-released/"/>
    <updated>2015-12-28T15:48:50+01:00</updated>
    <id>http://stafwag.github.io/blog/blog/2015/12/28/lookat-1-dot-4-4-released</id>
    <content type="html"><![CDATA[<p> Lookat 1.4.4 is the latest stable release of Lookat/Bekijk the userfriendly file browser/viewer.</p>

<h3>ChangeLog</h3>

<ul>
<li>NetBSD support</li>
<li>OpenBSD support</li>
<li>English translation issues corrected</li>
<li>autoconf updated to 2.69</li>
<li>Corrected minor compile warnings</li>
</ul>


<h3>Lookat 1.4.4 is available at:</h3>

<p><a href="http://www.wagemakers.be/english/programs/lookat"><a href="http://www.wagemakers.be/english/programs/lookat">http://www.wagemakers.be/english/programs/lookat</a></a>
, download it directly <a href="http://www.wagemakers.be/downloads/lookat/lookat_bekijk-1.4.4.tar.gz">Download latest stable release (1.4.4)</a>.</p>

<p>Or at the Git repository at GNU savannah <a href="http://git.savannah.gnu.org/cgit/lookat.git/"><a href="http://git.savannah.gnu.org/cgit/lookat.git/">http://git.savannah.gnu.org/cgit/lookat.git/</a></a></p>

<p><strong><em> Have fun </em></strong></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Running Docker on ARM]]></title>
    <link href="http://stafwag.github.io/blog/blog/2015/12/26/running-docker-on-arm/"/>
    <updated>2015-12-26T14:55:59+01:00</updated>
    <id>http://stafwag.github.io/blog/blog/2015/12/26/running-docker-on-arm</id>
    <content type="html"><![CDATA[<p><img class="right" src="http://stafwag.github.io/blog/images/odroid_2_euro.jpg" width="500" height="256" title="&#34;odroid u3 2 euro&#34;" alt="&#34;odroid u3 2 euro&#34;"></p>

<p>I own an <a href="http://www.hardkernel.com/main/products/prdt_info.php?g_code=g138745696275">odroid u3</a> that I used for my media center with <a href="https://xbmc.org/">xbmc</a> while I like the performance of the <a href="https://en.wikipedia.org/wiki/Exynos">Exynos4412 CPU</a> but the drivers for the <a href="https://en.wikipedia.org/wiki/Mali_%28GPU%29">Mali GPU</a> aren&rsquo;t <a href="https://en.wikipedia.org/wiki/Open_source">opensource</a>.</p>

<p>I like <a href="https://en.wikipedia.org/wiki/ARM_architecture">ARM</a> but unfortunatelly a lot of the ARM <a href="https://en.wikipedia.org/wiki/System_on_a_chip">soc</a>&rsquo;s  have no opensource drivers for the <a href="https://en.wikipedia.org/wiki/Graphics_processing_unit">GPU</a></p>

<p>The manufacturer of the odroid u3 - <a href="http://www.hardkernel.com/">hardkernel</a> - provides <a href="http://com.odroid.com/sigong/nf_file_board/nfile_board.php?tag=ODROID-U3">ubuntu 14.04 images</a> with xbmc and mali support. It isn&rsquo;t possible to get the newer of version of xbmc - now <a href="http://www.kodi.org">kodi</a> - running, or I didn&rsquo;t succeed withit. I&rsquo;ll look for another solution for my media server needs this might be my <a href="https://www.raspberrypi.org/">raspberry pi</a> <a href="https://www.raspberrypi.org/products/model-b-plus/">1 model B+</a> that is laying around doing nothing running <a href="http://openelec.tv/">openelec</a><br /><br />
<img class="left" src="http://stafwag.github.io/blog/images/odroid_u3_with_usbdisk.jpg" width="500" height="352" title="&#34;odroid u3 with usb disk&#34;" alt="&#34;odroid u3 with usb disk&#34;"></p>

<p>Like I said I like the performance of the ordoid U3 that why I installed <a href="http://archlinuxarm.org/">archLinuxArm</a> to play with <a href="https://www.docker.com/">Docker</a>. I could have sticked with Ubuntu 14.04 but with Arch Linux I get more up-to-date software.</p>

<p><a href="http://archlinuxarm.org/platforms/armv7/samsung/odroid-u3">The installion</a> was pretty straightforward even the <a href="https://wiki.archlinux.org/index.php/Docker">docker installation</a> was the same as on a <a href="https://en.wikipedia.org/wiki/X86">x86 platform</a>.<br /></p>

<p>Since we are using docker on arm we have to build our own docker base images instead of using the <a href="https://hub.docker.com/_/registry/">docker registery</a>. I have security concerns about installtion and using unsigned non-verified software anyway. If you build your own image it possible to audit/verify the build process.</p>

<h2>Creating your own docker base images</h2>

<h3>Arch</h3>

<p>To build a Arch Base Image download mkimage-arch.sh and mkimage-arch-pacman.conf from the Docker source <a href="https://github.com/docker/docker/blob/master/contrib/"><a href="https://github.com/docker/docker/blob/master/contrib/">https://github.com/docker/docker/blob/master/contrib/</a></a></p>

<h4>Download mkimage-arch.sh</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@fanny arch]$ wget https://raw.githubusercontent.com/docker/docker/master/contrib/mkimage-arch.sh
</span><span class='line'>--2015-12-26 10:21:10--  https://raw.githubusercontent.com/docker/docker/master/contrib/mkimage-arch.sh
</span><span class='line'>Resolving raw.githubusercontent.com (raw.githubusercontent.com)... 23.235.43.133
</span><span class='line'>Connecting to raw.githubusercontent.com (raw.githubusercontent.com)|23.235.43.133|:443... connected.
</span><span class='line'>HTTP request sent, awaiting response... 200 OK
</span><span class='line'>Length: 2351 (2.3K) [text/plain]
</span><span class='line'>Saving to: 'mkimage-arch.sh'
</span><span class='line'>
</span><span class='line'>mkimage-arch.sh                     100%[=====================================================================&gt;]   2.30K  --.-KB/s   in 0s     
</span><span class='line'>
</span><span class='line'>2015-12-26 10:21:10 (144 MB/s) - 'mkimage-arch.sh' saved [2351/2351]
</span><span class='line'>
</span><span class='line'>[staf@fanny arch]$ chmod +x mkimage-arch.sh 
</span><span class='line'>[staf@fanny arch]$ </span></code></pre></td></tr></table></div></figure>


<h4>Increase the timeout</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@fanny arch]$ sed -i 's/timeout 60/timeout 120/' mkimage-arch.sh
</span><span class='line'>[staf@fanny arch]$ </span></code></pre></td></tr></table></div></figure>


<h4>Copy pacman.conf</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@fanny arch]$ cp /etc/pacman.conf mkimage-arch-pacman.conf
</span><span class='line'>[staf@fanny arch]$ </span></code></pre></td></tr></table></div></figure>


<h4>Install the arch keyring</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@fanny debian]$ sudo pacman -Ss keyring                                                                                                                                                                                                                                                                                                                                                                                             
</span><span class='line'>core/archlinux-keyring 20151206-1                                                                                                                                                                                                                                                                                                                                                                                                        
</span><span class='line'>    Arch Linux PGP keyring                                                                                                                                                                                                                                                                                                                                                                                                               
</span><span class='line'>core/archlinuxarm-keyring 20140119-1                                                                                                                                                                                                                                                                                                                                                                                                     
</span><span class='line'>    Arch Linux ARM PGP keyring                                                                                                                                                                                                                                                                                                                                                                                                           
</span><span class='line'>extra/gnome-keyring 1:3.18.3-1 (gnome)                                                                                                                                                                                                                                                                                                                                                                                                   
</span><span class='line'>    GNOME Password Management daemon                                                                                                                                                                                                                                                                                                                                                                                                     
</span><span class='line'>extra/gnome-keyring-sharp 1.0.2-5                                                                                                                                                                                                                                                                                                                                                                                                        
</span><span class='line'>    A fully managed implementation of libgnome-keyring                                                                                                                                                                                                                                                                                                                                                                                   
</span><span class='line'>extra/libgnome-keyring 3.12.0-2                                                                                                                                                                                                                                                                                                                                                                                                          
</span><span class='line'>    GNOME keyring client library                                                                                                                                                                                                                                                                                                                                                                                                         
</span><span class='line'>extra/python2-gnomekeyring 2.32.0-15                                                                                                                                                                                                                                                                                                                                                                                                     
</span><span class='line'>    Python bindings for libgnome-keyring                                                                                                                                                                                                                                                                                                                                                                                                 
</span><span class='line'>community/python-keyring 5.7.1-1                                                                                                                                                                                                                                                                                                                                                                                                         
</span><span class='line'>    Store and access your passwords safely.                                                                                                                                                                                                                                                                                                                                                                                              
</span><span class='line'>community/python2-keyring 5.7.1-1                                                                                                                                                                                                                                                                                                                                                                                                        
</span><span class='line'>    Store and access your passwords safely.                                                                                                                                                                                                                                                                                                                                                                                              
</span><span class='line'>[staf@fanny debian]$ sudo pacman -S archlinuxarm-keyring                                                                                                                                                                                                                                                                                                                                                                                 
</span><span class='line'>resolving dependencies...                                                                                                                                                                                                                                                                                                                                                                                                                
</span><span class='line'>looking for conflicting packages...                                                                                                                                                                                                                                                                                                                                                                                                      
</span><span class='line'>                                                                                                                                                                                                                                                                                                                                                                                                                                         
</span><span class='line'>Packages (1) archlinuxarm-keyring-20140119-1                                                                                                                                                                                                                                                                                                                                                                                             
</span><span class='line'>                                                                                                                                                                                                                                                                                                                                                                                                                                         
</span><span class='line'>Total Download Size:   0.01 MiB                                                                                                                                                                                                                                                                                                                                                                                                          
</span><span class='line'>Total Installed Size:  0.03 MiB                                                                                                                                                                                                                                                                                                                                                                                                          
</span><span class='line'>                                                                                                                                                                                                                                                                                                                                                                                                                                         
</span><span class='line'>:: Proceed with installation? [Y/n] y                                                                                                                                                                                                                                                                                                                                                                                                    
</span><span class='line'>:: Retrieving packages ...                                                                                                                                                                                                                                                                                                                                                                                                               
</span><span class='line'> archlinuxarm-keyring-20140119-1-any                                                                                                                                                                                                    12.2 KiB  1218K/s 00:00 [##################################################################################################################################################################] 100%
</span><span class='line'>(1/1) checking keys in keyring                                                                                                                                                                                                                                  [##################################################################################################################################################################] 100%
</span><span class='line'>(1/1) checking package integrity                                                                                                                                                                                                                                [##################################################################################################################################################################] 100%
</span><span class='line'>(1/1) loading package files                                                                                                                                                                                                                                     [##################################################################################################################################################################] 100%
</span><span class='line'>(1/1) checking for file conflicts                                                                                                                                                                                                                               [##################################################################################################################################################################] 100%
</span><span class='line'>(1/1) checking available disk space                                                                                                                                                                                                                             [##################################################################################################################################################################] 100%
</span><span class='line'>(1/1) installing archlinuxarm-keyring                                                                                                                                                                                                                           [##################################################################################################################################################################] 100%
</span><span class='line'>[staf@fanny debian]$ sudo pacman -S archlinux-keyring                                                                                                                                                                                                                                                                                                                                                                                    
</span><span class='line'>resolving dependencies...                                                                                                                                                                                                                                                                                                                                                                                                                
</span><span class='line'>looking for conflicting packages...                                                                                                                                                                                                                                                                                                                                                                                                      
</span><span class='line'>                                                                                                                                                                                                                                                                                                                                                                                                                                         
</span><span class='line'>Packages (1) archlinux-keyring-20151206-1                                                                                                                                                                                                                                                                                                                                                                                                
</span><span class='line'>                                                                                                                                                                                                                                                                                                                                                                                                                                         
</span><span class='line'>Total Download Size:   0.49 MiB                                                                                                                                                                                                                                                                                                                                                                                                          
</span><span class='line'>Total Installed Size:  0.70 MiB                                                                                                                                                                                                                                                                                                                                                                                                          
</span><span class='line'>                                                                                                                                                                                                                                                                                                                                                                                                                                         
</span><span class='line'>:: Proceed with installation? [Y/n] y                                                                                                                                                                                                                                                                                                                                                                                                    
</span><span class='line'>:: Retrieving packages ...                                                                                                                                                                                                                                                                                                                                                                                                               
</span><span class='line'> archlinux-keyring-20151206-1-any                                                                                                                                                                                                      505.5 KiB   231K/s 00:02 [##################################################################################################################################################################] 100%
</span><span class='line'>(1/1) checking keys in keyring                                                                                                                                                                                                                                  [##################################################################################################################################################################] 100%
</span><span class='line'>(1/1) checking package integrity                                                                                                                                                                                                                                [##################################################################################################################################################################] 100%
</span><span class='line'>(1/1) loading package files                                                                                                                                                                                                                                     [##################################################################################################################################################################] 100%
</span><span class='line'>(1/1) checking for file conflicts                                                                                                                                                                                                                               [##################################################################################################################################################################] 100%
</span><span class='line'>(1/1) checking available disk space                                                                                                                                                                                                                             [##################################################################################################################################################################] 100%
</span><span class='line'>(1/1) installing archlinux-keyring                                                                                                                                                                                                                              [##################################################################################################################################################################] 100%
</span><span class='line'>[staf@fanny debian]$                                                                                                                                                                                                                                                                                                                                                                                                                     </span></code></pre></td></tr></table></div></figure>


<h4>Create the base Arch Image</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@fanny arch]$ sudo LC_ALL=C TMPDIR=`pwd`/tmp ./mkimage-arch.sh
</span><span class='line'>spawn pacstrap -C ./mkimage-arch-pacman.conf -c -d -G -i /home/staf/docker/docker/base-images/arch/tmp/rootfs-archlinux-eYGavMPZLd base haveged --ignore cryptsetup,device-mapper,dhcpcd,iproute2,jfsutils,linux,lvm2,man-db,man-pages,mdadm,nano,netctl,openresolv,pciutils,pcmciautils,reiserfsprogs,s-nail,systemd-sysvcompat,usbutils,vi,xfsprogs
</span><span class='line'>==&gt; Creating install root at /home/staf/docker/docker/base-images/arch/tmp/rootfs-archlinux-eYGavMPZLd
</span><span class='line'>==&gt; Installing packages to /home/staf/docker/docker/base-images/arch/tmp/rootfs-archlinux-eYGavMPZLd
</span><span class='line'>:: Synchronizing package databases...
</span><span class='line'> core                                                         210.4 KiB   288K/s 00:01 [##################################################] 100%
</span><span class='line'> extra                                                          2.3 MiB   409K/s 00:06 [##################################################] 100%
</span><span class='line'> community                                                      3.2 MiB   314K/s 00:10 [##################################################] 100%
</span><span class='line'> alarm                                                        105.4 KiB  77.8K/s 00:01 [##################################################] 100%
</span><span class='line'> aur                                                           31.2 KiB   164K/s 00:00 [##################################################] 100%
</span><span class='line'>:: cryptsetup is in IgnorePkg/IgnoreGroup. Install anyway? [Y/n] n
</span><span class='line'>:: device-mapper is in IgnorePkg/IgnoreGroup. Install anyway? [Y/n] n
</span><span class='line'>:: dhcpcd is in IgnorePkg/IgnoreGroup. Install anyway? [Y/n] n
</span><span class='line'>:: iproute2 is in IgnorePkg/IgnoreGroup. Install anyway? [Y/n] n
</span><span class='line'>:: jfsutils is in IgnorePkg/IgnoreGroup. Install anyway? [Y/n] n
</span><span class='line'>:: lvm2 is in IgnorePkg/IgnoreGroup. Install anyway? [Y/n] n
</span><span class='line'>:: man-db is in IgnorePkg/IgnoreGroup. Install anyway? [Y/n] n
</span><span class='line'>:: man-pages is in IgnorePkg/IgnoreGroup. Install anyway? [Y/n] n
</span><span class='line'>:: mdadm is in IgnorePkg/IgnoreGroup. Install anyway? [Y/n] n
</span><span class='line'>:: nano is in IgnorePkg/IgnoreGroup. Install anyway? [Y/n] n
</span><span class='line'>:: netctl is in IgnorePkg/IgnoreGroup. Install anyway? [Y/n] n
</span><span class='line'>:: pciutils is in IgnorePkg/IgnoreGroup. Install anyway? [Y/n] n
</span><span class='line'>:: reiserfsprogs is in IgnorePkg/IgnoreGroup. Install anyway? [Y/n] n
</span><span class='line'>:: s-nail is in IgnorePkg/IgnoreGroup. Install anyway? [Y/n] n
</span><span class='line'>:: systemd-sysvcompat is in IgnorePkg/IgnoreGroup. Install anyway? [Y/n] n
</span><span class='line'>:: usbutils is in IgnorePkg/IgnoreGroup. Install anyway? [Y/n] n
</span><span class='line'>:: vi is in IgnorePkg/IgnoreGroup. Install anyway? [Y/n] n
</span><span class='line'>:: xfsprogs is in IgnorePkg/IgnoreGroup. Install anyway? [Y/n] n
</span><span class='line'>:: There are 31 members in group base:
</span><span class='line'>:: Repository core
</span><span class='line'>   1) bash  2) bzip2  3) coreutils  4) diffutils  5) e2fsprogs  6) file  7) filesystem  8) findutils  9) gawk  10) gcc-libs  11) gettext
</span><span class='line'>   12) glibc  13) grep  14) gzip  15) inetutils  16) iputils  17) less  18) licenses  19) logrotate  20) pacman  21) pacman-mirrorlist
</span><span class='line'>   22) perl  23) procps-ng  24) psmisc  25) sed  26) shadow  27) sysfsutils  28) tar  29) texinfo  30) util-linux  31) which
</span><span class='line'>
</span><span class='line'>Enter a selection (default=all): 
</span><span class='line'>resolving dependencies...
</span><span class='line'>looking for conflicting packages...
</span><span class='line'>
</span><span class='line'>Packages (86) acl-2.2.52-2  attr-2.4.47-1  ca-certificates-20150402-1  ca-certificates-cacert-20140824-2  ca-certificates-mozilla-3.20.1-1
</span><span class='line'>              ca-certificates-utils-20150402-1  cracklib-2.9.4-1  curl-7.46.0-1  db-5.3.28-3  expat-2.1.0-4  gdbm-1.11-1  glib2-2.46.2-2
</span><span class='line'>              gmp-6.1.0-2  gnupg-2.1.10-3  gnutls-3.4.7-2  gpgme-1.6.0-2  iana-etc-20151016-1  keyutils-1.5.9-1  krb5-1.13.2-1
</span><span class='line'>              libarchive-3.1.2-8  libassuan-2.4.2-1  libcap-2.24-2  libffi-3.2.1-1  libgcrypt-1.6.4-1  libgpg-error-1.21-1  libidn-1.32-1
</span><span class='line'>              libksba-1.3.3-1  libldap-2.4.42-2  libsasl-2.1.26-7  libssh2-1.6.0-1  libsystemd-228-3  libtasn1-4.7-1  libtirpc-1.0.1-2
</span><span class='line'>              libunistring-0.9.6-1  libutil-linux-2.27.1-1  linux-api-headers-4.1.4-1  lz4-131-1  lzo-2.09-1  mpfr-3.1.3.p4-1  ncurses-6.0-4
</span><span class='line'>              nettle-3.1.1-1  npth-1.2-1  openssl-1.0.2.e-1  p11-kit-0.23.1-3  pam-1.2.1-3  pambase-20130928-1  pcre-8.38-2  pinentry-0.9.7-1
</span><span class='line'>              popt-1.16-7  readline-6.3.008-3  sqlite-3.9.2-1  tzdata-2015g-1  xz-5.2.2-1  zlib-1.2.8-4  bash-4.3.042-4  bzip2-1.0.6-5
</span><span class='line'>              coreutils-8.24-1  diffutils-3.3-2  e2fsprogs-1.42.13-1  file-5.25-1  filesystem-2015.09-1  findutils-4.4.2-6  gawk-4.1.3-1
</span><span class='line'>              gcc-libs-5.3.0-3  gettext-0.19.6-2  glibc-2.22-3  grep-2.22-1  gzip-1.6-1  haveged-1.9.1-2  inetutils-1.9.4-2.1
</span><span class='line'>              iputils-20140519.fad11dc-1  less-481-2  licenses-20140629-1  logrotate-3.9.1-1  pacman-4.2.1-4  pacman-mirrorlist-20151217-1
</span><span class='line'>              perl-5.22.1-1  procps-ng-3.3.11-2  psmisc-22.21-3  sed-4.2.2-3  shadow-4.2.1-3  sysfsutils-2.1.0-9  tar-1.28-1  texinfo-6.0-1
</span><span class='line'>              util-linux-2.27.1-1  which-2.21-1
</span><span class='line'>
</span><span class='line'>Total Installed Size:  272.82 MiB
</span><span class='line'>
</span><span class='line'>:: Proceed with installation? [Y/n] y
</span><span class='line'>(86/86) checking keys in keyring                                                       [##################################################] 100%
</span><span class='line'>(86/86) checking package integrity                                                     [##################################################] 100%
</span><span class='line'>(86/86) loading package files                                                          [##################################################] 100%
</span><span class='line'>(86/86) checking for file conflicts                                                    [##################################################] 100%
</span><span class='line'>(86/86) checking available disk space                                                  [##################################################] 100%
</span><span class='line'>( 1/86) installing linux-api-headers                                                   [##################################################] 100%
</span><span class='line'>( 2/86) installing tzdata                                                              [##################################################] 100%
</span><span class='line'>( 3/86) installing iana-etc                                                            [##################################################] 100%
</span><span class='line'>( 4/86) installing filesystem                                                          [##################################################] 100%
</span><span class='line'>( 5/86) installing glibc                                                               [##################################################] 100%
</span><span class='line'>( 6/86) installing gcc-libs                                                            [##################################################] 100%
</span><span class='line'>( 7/86) installing ncurses                                                             [##################################################] 100%
</span><span class='line'>( 8/86) installing readline                                                            [##################################################] 100%
</span><span class='line'>( 9/86) installing bash                                                                [##################################################] 100%
</span><span class='line'>Optional dependencies for bash
</span><span class='line'>    bash-completion: for tab completion
</span><span class='line'>(10/86) installing bzip2                                                               [##################################################] 100%
</span><span class='line'>(11/86) installing attr                                                                [##################################################] 100%
</span><span class='line'>(12/86) installing acl                                                                 [##################################################] 100%
</span><span class='line'>(13/86) installing gmp                                                                 [##################################################] 100%
</span><span class='line'>(14/86) installing libcap                                                              [##################################################] 100%
</span><span class='line'>(15/86) installing zlib                                                                [##################################################] 100%
</span><span class='line'>(16/86) installing gdbm                                                                [##################################################] 100%
</span><span class='line'>(17/86) installing db                                                                  [##################################################] 100%
</span><span class='line'>(18/86) installing perl                                                                [##################################################] 100%
</span><span class='line'>(19/86) installing openssl                                                             [##################################################] 100%
</span><span class='line'>Optional dependencies for openssl
</span><span class='line'>    ca-certificates [pending]
</span><span class='line'>(20/86) installing coreutils                                                           [##################################################] 100%
</span><span class='line'>(21/86) installing diffutils                                                           [##################################################] 100%
</span><span class='line'>(22/86) installing libutil-linux                                                       [##################################################] 100%
</span><span class='line'>(23/86) installing e2fsprogs                                                           [##################################################] 100%
</span><span class='line'>(24/86) installing file                                                                [##################################################] 100%
</span><span class='line'>(25/86) installing findutils                                                           [##################################################] 100%
</span><span class='line'>(26/86) installing mpfr                                                                [##################################################] 100%
</span><span class='line'>(27/86) installing gawk                                                                [##################################################] 100%
</span><span class='line'>(28/86) installing pcre                                                                [##################################################] 100%
</span><span class='line'>(29/86) installing libffi                                                              [##################################################] 100%
</span><span class='line'>(30/86) installing glib2                                                               [##################################################] 100%
</span><span class='line'>Optional dependencies for glib2
</span><span class='line'>    python2: for gdbus-codegen and gtester-report
</span><span class='line'>    libelf: gresource inspection tool
</span><span class='line'>(31/86) installing libunistring                                                        [##################################################] 100%
</span><span class='line'>(32/86) installing gettext                                                             [##################################################] 100%
</span><span class='line'>Optional dependencies for gettext
</span><span class='line'>    git: for autopoint infrastructure updates
</span><span class='line'>(33/86) installing grep                                                                [##################################################] 100%
</span><span class='line'>(34/86) installing less                                                                [##################################################] 100%
</span><span class='line'>(35/86) installing gzip                                                                [##################################################] 100%
</span><span class='line'>(36/86) installing cracklib                                                            [##################################################] 100%
</span><span class='line'>(37/86) installing libsasl                                                             [##################################################] 100%
</span><span class='line'>(38/86) installing libldap                                                             [##################################################] 100%
</span><span class='line'>(39/86) installing keyutils                                                            [##################################################] 100%
</span><span class='line'>(40/86) installing krb5                                                                [##################################################] 100%
</span><span class='line'>(41/86) installing libtirpc                                                            [##################################################] 100%
</span><span class='line'>(42/86) installing pambase                                                             [##################################################] 100%
</span><span class='line'>(43/86) installing pam                                                                 [##################################################] 100%
</span><span class='line'>(44/86) installing inetutils                                                           [##################################################] 100%
</span><span class='line'>(45/86) installing sysfsutils                                                          [##################################################] 100%
</span><span class='line'>(46/86) installing iputils                                                             [##################################################] 100%
</span><span class='line'>Optional dependencies for iputils
</span><span class='line'>    xinetd: for tftpd
</span><span class='line'>(47/86) installing licenses                                                            [##################################################] 100%
</span><span class='line'>(48/86) installing popt                                                                [##################################################] 100%
</span><span class='line'>(49/86) installing logrotate                                                           [##################################################] 100%
</span><span class='line'>(50/86) installing expat                                                               [##################################################] 100%
</span><span class='line'>(51/86) installing lzo                                                                 [##################################################] 100%
</span><span class='line'>(52/86) installing xz                                                                  [##################################################] 100%
</span><span class='line'>(53/86) installing libarchive                                                          [##################################################] 100%
</span><span class='line'>(54/86) installing texinfo                                                             [##################################################] 100%
</span><span class='line'>(55/86) installing libtasn1                                                            [##################################################] 100%
</span><span class='line'>(56/86) installing p11-kit                                                             [##################################################] 100%
</span><span class='line'>(57/86) installing ca-certificates-utils                                               [##################################################] 100%
</span><span class='line'>(58/86) installing ca-certificates-mozilla                                             [##################################################] 100%
</span><span class='line'>(59/86) installing ca-certificates-cacert                                              [##################################################] 100%
</span><span class='line'>(60/86) installing ca-certificates                                                     [##################################################] 100%
</span><span class='line'>(61/86) installing libidn                                                              [##################################################] 100%
</span><span class='line'>(62/86) installing libssh2                                                             [##################################################] 100%
</span><span class='line'>(63/86) installing curl                                                                [##################################################] 100%
</span><span class='line'>(64/86) installing libgpg-error                                                        [##################################################] 100%
</span><span class='line'>(65/86) installing npth                                                                [##################################################] 100%
</span><span class='line'>(66/86) installing libgcrypt                                                           [##################################################] 100%
</span><span class='line'>(67/86) installing libksba                                                             [##################################################] 100%
</span><span class='line'>(68/86) installing libassuan                                                           [##################################################] 100%
</span><span class='line'>(69/86) installing pinentry                                                            [##################################################] 100%
</span><span class='line'>Optional dependencies for pinentry
</span><span class='line'>    gtk2: gtk2 backend
</span><span class='line'>    qt5-base: qt backend
</span><span class='line'>    gcr: gnome3 backend
</span><span class='line'>(70/86) installing nettle                                                              [##################################################] 100%
</span><span class='line'>(71/86) installing gnutls                                                              [##################################################] 100%
</span><span class='line'>Optional dependencies for gnutls
</span><span class='line'>    guile: for use with Guile bindings
</span><span class='line'>(72/86) installing sqlite                                                              [##################################################] 100%
</span><span class='line'>(73/86) installing gnupg                                                               [##################################################] 100%
</span><span class='line'>Optional dependencies for gnupg
</span><span class='line'>    libldap: gpg2keys_ldap [installed]
</span><span class='line'>    libusb-compat: scdaemon
</span><span class='line'>(74/86) installing gpgme                                                               [##################################################] 100%
</span><span class='line'>(75/86) installing pacman-mirrorlist                                                   [##################################################] 100%
</span><span class='line'>(76/86) installing pacman                                                              [##################################################] 100%
</span><span class='line'>Optional dependencies for pacman
</span><span class='line'>    fakeroot: for makepkg usage as normal user
</span><span class='line'>(77/86) installing lz4                                                                 [##################################################] 100%
</span><span class='line'>(78/86) installing libsystemd                                                          [##################################################] 100%
</span><span class='line'>(79/86) installing procps-ng                                                           [##################################################] 100%
</span><span class='line'>(80/86) installing psmisc                                                              [##################################################] 100%
</span><span class='line'>(81/86) installing sed                                                                 [##################################################] 100%
</span><span class='line'>(82/86) installing shadow                                                              [##################################################] 100%
</span><span class='line'>(83/86) installing tar                                                                 [##################################################] 100%
</span><span class='line'>(84/86) installing util-linux                                                          [##################################################] 100%
</span><span class='line'>Optional dependencies for util-linux
</span><span class='line'>    python: python bindings to libmount
</span><span class='line'>(85/86) installing which                                                               [##################################################] 100%
</span><span class='line'>(86/86) installing haveged                                                             [##################################################] 100%
</span><span class='line'>gpg: /etc/pacman.d/gnupg/trustdb.gpg: trustdb created
</span><span class='line'>gpg: no ultimately trusted keys found
</span><span class='line'>gpg: starting migration from earlier GnuPG versions
</span><span class='line'>gpg: porting secret keys from '/etc/pacman.d/gnupg/secring.gpg' to gpg-agent
</span><span class='line'>gpg: migration succeeded
</span><span class='line'>gpg: Generating pacman keyring master key...
</span><span class='line'>gpg: key 4C4DCB68 marked as ultimately trusted
</span><span class='line'>gpg: directory '/etc/pacman.d/gnupg/openpgp-revocs.d' created
</span><span class='line'>gpg: Done
</span><span class='line'>==&gt; Updating trust database...
</span><span class='line'>gpg: 3 marginal(s) needed, 1 complete(s) needed, PGP trust model
</span><span class='line'>gpg: depth: 0  valid:   1  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 1u
</span><span class='line'>checking dependencies...
</span><span class='line'>
</span><span class='line'>Packages (1) haveged-1.9.1-2
</span><span class='line'>
</span><span class='line'>Total Removed Size:  0.18 MiB
</span><span class='line'>
</span><span class='line'>:: Do you want to remove these packages? [Y/n] 
</span><span class='line'>(1/1) removing haveged                                                                 [##################################################] 100%
</span><span class='line'>==&gt; ERROR: The keyring file /usr/share/pacman/keyrings/archlinux.gpg does not exist.
</span><span class='line'>Generating locales...
</span><span class='line'>  en_US.UTF-8... done
</span><span class='line'>Generation complete.
</span><span class='line'>tar: ./etc/pacman.d/gnupg/S.gpg-agent: socket ignored
</span><span class='line'>5de54cc959c36d2064ee4389c0cc50acdb2246b3eac4edeb5e83cac7f4d9b350
</span><span class='line'>Success.
</span><span class='line'>[staf@fanny arch]$</span></code></pre></td></tr></table></div></figure>


<h4>Try it</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@fanny arch]$ docker run -t -i --rm archlinux /bin/bash
</span><span class='line'>[root@6c24a79778f9 /]# </span></code></pre></td></tr></table></div></figure>


<h3>Debian</h3>

<p>To create a debian base images you need <a href="https://wiki.debian.org/Debootstrap">debootstrap</a>. There is a <a href="https://aur.archlinux.org/">aur</a> available.</p>

<h4>Install yaort</h4>

<p><a href="https://wiki.archlinux.org/index.php/Yaourt">Yaourt</a> is a nice tool to install aur ports.</p>

<h5>Install the base development tools</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@fanny ~]$ sudo pacman -Sy base-devel
</span><span class='line'>:: Synchronizing package databases...
</span><span class='line'> core                                                                      210.4 KiB   198K/s 00:01 [##########################################################] 100%
</span><span class='line'> extra                                                                       2.3 MiB   385K/s 00:06 [##########################################################] 100%
</span><span class='line'> community                                                                   3.2 MiB   208K/s 00:16 [##########################################################] 100%
</span><span class='line'> alarm                                                                     105.4 KiB   335K/s 00:00 [##########################################################] 100%
</span><span class='line'> aur                                                                        31.2 KiB  49.1K/s 00:01 [##########################################################] 100%
</span><span class='line'>:: There are 25 members in group base-devel:
</span><span class='line'>:: Repository core
</span><span class='line'>   1) autoconf  2) automake  3) binutils  4) bison  5) fakeroot  6) file  7) findutils  8) flex  9) gawk  10) gcc  11) gettext  12) grep  13) groff  14) gzip
</span><span class='line'>   15) libtool  16) m4  17) make  18) pacman  19) patch  20) pkg-config  21) sed  22) sudo  23) texinfo  24) util-linux  25) which
</span><span class='line'>
</span><span class='line'>Enter a selection (default=all): 
</span><span class='line'>warning: autoconf-2.69-2 is up to date -- reinstalling
</span><span class='line'>warning: automake-1.15-1 is up to date -- reinstalling
</span><span class='line'>warning: binutils-2.25.1-3 is up to date -- reinstalling
</span><span class='line'>warning: bison-3.0.4-1 is up to date -- reinstalling
</span><span class='line'>warning: fakeroot-1.20.2-1 is up to date -- reinstalling
</span><span class='line'>warning: file-5.25-1 is up to date -- reinstalling
</span><span class='line'>warning: findutils-4.4.2-6 is up to date -- reinstalling
</span><span class='line'>warning: flex-2.6.0-1 is up to date -- reinstalling
</span><span class='line'>warning: gawk-4.1.3-1 is up to date -- reinstalling
</span><span class='line'>warning: gcc-5.3.0-3 is up to date -- reinstalling
</span><span class='line'>warning: gettext-0.19.6-2 is up to date -- reinstalling
</span><span class='line'>warning: grep-2.22-1 is up to date -- reinstalling
</span><span class='line'>warning: groff-1.22.3-5 is up to date -- reinstalling
</span><span class='line'>warning: gzip-1.6-1 is up to date -- reinstalling
</span><span class='line'>warning: libtool-2.4.6-4 is up to date -- reinstalling
</span><span class='line'>warning: m4-1.4.17-1 is up to date -- reinstalling
</span><span class='line'>warning: make-4.1-1 is up to date -- reinstalling
</span><span class='line'>warning: pacman-4.2.1-4 is up to date -- reinstalling
</span><span class='line'>warning: patch-2.7.5-1 is up to date -- reinstalling
</span><span class='line'>warning: pkg-config-0.29-1 is up to date -- reinstalling
</span><span class='line'>warning: sed-4.2.2-3 is up to date -- reinstalling
</span><span class='line'>warning: sudo-1.8.15-1 is up to date -- reinstalling
</span><span class='line'>warning: texinfo-6.0-1 is up to date -- reinstalling
</span><span class='line'>warning: util-linux-2.27.1-1 is up to date -- reinstalling
</span><span class='line'>warning: which-2.21-1 is up to date -- reinstalling
</span><span class='line'>resolving dependencies...
</span><span class='line'>looking for conflicting packages...
</span><span class='line'>
</span><span class='line'>Packages (25) autoconf-2.69-2  automake-1.15-1  binutils-2.25.1-3  bison-3.0.4-1  fakeroot-1.20.2-1  file-5.25-1  findutils-4.4.2-6  flex-2.6.0-1  gawk-4.1.3-1
</span><span class='line'>              gcc-5.3.0-3  gettext-0.19.6-2  grep-2.22-1  groff-1.22.3-5  gzip-1.6-1  libtool-2.4.6-4  m4-1.4.17-1  make-4.1-1  pacman-4.2.1-4  patch-2.7.5-1
</span><span class='line'>              pkg-config-0.29-1  sed-4.2.2-3  sudo-1.8.15-1  texinfo-6.0-1  util-linux-2.27.1-1  which-2.21-1
</span><span class='line'>
</span><span class='line'>Total Installed Size:  166.11 MiB
</span><span class='line'>Net Upgrade Size:        0.00 MiB
</span><span class='line'>
</span><span class='line'>:: Proceed with installation? [Y/n] y
</span><span class='line'>(25/25) checking keys in keyring                                                                    [##########################################################] 100%
</span><span class='line'>(25/25) checking package integrity                                                                  [##########################################################] 100%
</span><span class='line'>(25/25) loading package files                                                                       [##########################################################] 100%
</span><span class='line'>(25/25) checking for file conflicts                                                                 [##########################################################] 100%
</span><span class='line'>(25/25) checking available disk space                                                               [##########################################################] 100%
</span><span class='line'>( 1/25) reinstalling gawk                                                                           [##########################################################] 100%
</span><span class='line'>( 2/25) reinstalling m4                                                                             [##########################################################] 100%
</span><span class='line'>( 3/25) reinstalling autoconf                                                                       [##########################################################] 100%
</span><span class='line'>( 4/25) reinstalling automake                                                                       [##########################################################] 100%
</span><span class='line'>( 5/25) reinstalling binutils                                                                       [##########################################################] 100%
</span><span class='line'>( 6/25) reinstalling bison                                                                          [##########################################################] 100%
</span><span class='line'>( 7/25) reinstalling sed                                                                            [##########################################################] 100%
</span><span class='line'>( 8/25) reinstalling util-linux                                                                     [##########################################################] 100%
</span><span class='line'>( 9/25) reinstalling fakeroot                                                                       [##########################################################] 100%
</span><span class='line'>(10/25) reinstalling file                                                                           [##########################################################] 100%
</span><span class='line'>(11/25) reinstalling findutils                                                                      [##########################################################] 100%
</span><span class='line'>(12/25) reinstalling flex                                                                           [##########################################################] 100%
</span><span class='line'>(13/25) reinstalling gcc                                                                            [##########################################################] 100%
</span><span class='line'>(14/25) reinstalling gettext                                                                        [##########################################################] 100%
</span><span class='line'>(15/25) reinstalling grep                                                                           [##########################################################] 100%
</span><span class='line'>(16/25) reinstalling groff                                                                          [##########################################################] 100%
</span><span class='line'>(17/25) reinstalling gzip                                                                           [##########################################################] 100%
</span><span class='line'>(18/25) reinstalling libtool                                                                        [##########################################################] 100%
</span><span class='line'>(19/25) reinstalling texinfo                                                                        [##########################################################] 100%
</span><span class='line'>(20/25) reinstalling make                                                                           [##########################################################] 100%
</span><span class='line'>(21/25) reinstalling pacman                                                                         [##########################################################] 100%
</span><span class='line'>(22/25) reinstalling patch                                                                          [##########################################################] 100%
</span><span class='line'>(23/25) reinstalling pkg-config                                                                     [##########################################################] 100%
</span><span class='line'>(24/25) reinstalling sudo                                                                           [##########################################################] 100%
</span><span class='line'>(25/25) reinstalling which                                                                          [##########################################################] 100%
</span><span class='line'>[staf@fanny ~]$ </span></code></pre></td></tr></table></div></figure>


<h5>Install git</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@fanny ~]$ sudo pacman -S git        
</span><span class='line'>warning: git-2.6.4-1 is up to date -- reinstalling
</span><span class='line'>resolving dependencies...
</span><span class='line'>looking for conflicting packages...
</span><span class='line'>
</span><span class='line'>Packages (1) git-2.6.4-1
</span><span class='line'>
</span><span class='line'>Total Installed Size:  22.92 MiB
</span><span class='line'>Net Upgrade Size:       0.00 MiB
</span><span class='line'>
</span><span class='line'>:: Proceed with installation? [Y/n] y
</span><span class='line'>(1/1) checking keys in keyring                                                                      [##########################################################] 100%
</span><span class='line'>(1/1) checking package integrity                                                                    [##########################################################] 100%
</span><span class='line'>(1/1) loading package files                                                                         [##########################################################] 100%
</span><span class='line'>(1/1) checking for file conflicts                                                                   [##########################################################] 100%
</span><span class='line'>(1/1) checking available disk space                                                                 [##########################################################] 100%
</span><span class='line'>(1/1) reinstalling git                                                                              [##########################################################] 100%
</span><span class='line'>[staf@fanny ~]$ </span></code></pre></td></tr></table></div></figure>


<h5>Install package-query</h5>

<h6>git clone</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@fanny aur]$ git clone https://aur.archlinux.org/package-query.git 
</span><span class='line'>Cloning into 'package-query'...
</span><span class='line'>remote: Counting objects: 16, done.
</span><span class='line'>remote: Compressing objects: 100% (16/16), done.
</span><span class='line'>remote: Total 16 (delta 0), reused 16 (delta 0)
</span><span class='line'>Unpacking objects: 100% (16/16), done.
</span><span class='line'>Checking connectivity... done.
</span><span class='line'>[staf@fanny aur]$ </span></code></pre></td></tr></table></div></figure>


<h5>makepkg</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@fanny aur]$ cd package-query/
</span><span class='line'>[staf@fanny package-query]$ makepkg -sri
</span><span class='line'>==&gt; Making package: package-query 1.7-1 (Fri Dec 25 14:33:39 UTC 2015)
</span><span class='line'>==&gt; Checking runtime dependencies...
</span><span class='line'>==&gt; Checking buildtime dependencies...
</span><span class='line'>==&gt; Retrieving sources...
</span><span class='line'>  -&gt; Downloading package-query-1.7.tar.gz...
</span><span class='line'>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span><span class='line'>                                 Dload  Upload   Total   Spent    Left  Speed
</span><span class='line'>100  380k  100  380k    0     0   413k      0 --:--:-- --:--:-- --:--:--  413k
</span><span class='line'>==&gt; Validating source files with md5sums...
</span><span class='line'>    package-query-1.7.tar.gz ... Passed
</span><span class='line'>==&gt; Extracting sources...
</span><span class='line'>  -&gt; Extracting package-query-1.7.tar.gz with bsdtar
</span><span class='line'>==&gt; Starting build()...
</span><span class='line'>checking for a BSD-compatible install... /usr/bin/install -c
</span><span class='line'>checking whether build environment is sane... yes
</span><span class='line'>checking for a thread-safe mkdir -p... /usr/bin/mkdir -p
</span><span class='line'>checking for gawk... gawk
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>config.status: executing depfiles commands
</span><span class='line'>config.status: executing libtool commands
</span><span class='line'>config.status: executing po-directories commands
</span><span class='line'>
</span><span class='line'>package-query:
</span><span class='line'>
</span><span class='line'>  Build information:
</span><span class='line'>    source code location   : .
</span><span class='line'>    prefix                 : /usr
</span><span class='line'>    sysconfdir             : /etc
</span><span class='line'>       conf file           : /etc/pacman.conf
</span><span class='line'>    localstatedir          : /var
</span><span class='line'>       database dir        : /var/lib/pacman/
</span><span class='line'>    compiler               : gcc
</span><span class='line'>    compiler flags         : -march=armv7-a -mfloat-abi=hard -mfpu=vfpv3-d16 -O2 -pipe -fstack-protector --param=ssp-buffer-size=4
</span><span class='line'>
</span><span class='line'>    package-query version  : 1.7
</span><span class='line'>    using git version      : no
</span><span class='line'>       git ver             : 
</span><span class='line'>
</span><span class='line'>  Variable information:
</span><span class='line'>    root working directory : /
</span><span class='line'>    aur base url           : https://aur.archlinux.org
</span><span class='line'>
</span><span class='line'>make  all-recursive
</span><span class='line'>make[1]: Entering directory '/home/staf/git/aur/package-query/src/package-query-1.7'
</span><span class='line'>Making all in src
</span><span class='line'>make[2]: Entering directory '/home/staf/git/aur/package-query/src/package-query-1.7/src'
</span><span class='line'>gcc -DLOCALEDIR=\"/usr/share/locale\" -DCONFFILE=\"/etc/pacman.conf\" -DROOTDIR=\"/\" -DDBPATH=\"/var/lib/pacman/\" -DAUR_BASE_URL=\"https://aur.archlinux.org\" -DHAVE_CONFIG_H  -I. -I..   -D_FORTIFY_SOURCE=2 -D_GNU_SOURCE -march=armv7-a -mfloat-abi=hard -mfpu=vfpv3-d16 -O2 -pipe -fstack-protector --param=ssp-buffer-size=4 -MT aur.o -MD -MP -MF .deps/aur.Tpo -c -o aur.o aur.c
</span><span class='line'>mv -f .deps/aur.Tpo .deps/aur.Po
</span><span class='line'>gcc -DLOCALEDIR=\"/usr/share/locale\" -DCONFFILE=\"/etc/pacman.conf\" -DROOTDIR=\"/\" -DDBPATH=\"/var/lib/pacman/\" -DAUR_BASE_URL=\"https://aur.archlinux.org\" -DHAVE_CONFIG_H  -I. -I..   -D_FORTIFY_SOURCE=2 -D_GNU_SOURCE -march=armv7-a -mfloat-abi=hard -mfpu=vfpv3-d16 -O2 -pipe -fstack-protector --param=ssp-buffer-size=4 -MT alpm-query.o -MD -MP -MF .deps/alpm-query.Tpo -c -o alpm-query.o alpm-query.c
</span><span class='line'>alpm-query.c: In function 'alpm_pkg_get_realsize':
</span><span class='line'> /usr/bin/mkdir -p '/home/staf/git/aur/package-query/pkg/package-query/usr/share/man/man8'
</span><span class='line'>&lt;snip&gt;
</span><span class='line'> /usr/bin/install -c -m 644 package-query.8 '/home/staf/git/aur/package-query/pkg/package-query/usr/share/man/man8'
</span><span class='line'>make[2]: Leaving directory '/home/staf/git/aur/package-query/src/package-query-1.7/doc'
</span><span class='line'>make[1]: Leaving directory '/home/staf/git/aur/package-query/src/package-query-1.7/doc'
</span><span class='line'>make[1]: Entering directory '/home/staf/git/aur/package-query/src/package-query-1.7'
</span><span class='line'>make[2]: Entering directory '/home/staf/git/aur/package-query/src/package-query-1.7'
</span><span class='line'>make[2]: Nothing to be done for 'install-exec-am'.
</span><span class='line'>make[2]: Nothing to be done for 'install-data-am'.
</span><span class='line'>make[2]: Leaving directory '/home/staf/git/aur/package-query/src/package-query-1.7'
</span><span class='line'>make[1]: Leaving directory '/home/staf/git/aur/package-query/src/package-query-1.7'
</span><span class='line'>==&gt; Tidying install...
</span><span class='line'>  -&gt; Purging unwanted files...
</span><span class='line'>  -&gt; Removing libtool files...
</span><span class='line'>  -&gt; Removing static library files...
</span><span class='line'>  -&gt; Compressing man and info pages...
</span><span class='line'>  -&gt; Stripping unneeded symbols from binaries and libraries...
</span><span class='line'>==&gt; Creating package "package-query"...
</span><span class='line'>  -&gt; Generating .PKGINFO file...
</span><span class='line'>  -&gt; Generating .MTREE file...
</span><span class='line'>  -&gt; Compressing package...
</span><span class='line'>==&gt; Leaving fakeroot environment.
</span><span class='line'>==&gt; Finished making: package-query 1.7-1 (Fri Dec 25 14:34:02 UTC 2015)
</span><span class='line'>==&gt; Installing package package-query with pacman -U...
</span><span class='line'>[sudo] password for staf: 
</span><span class='line'>loading packages...
</span><span class='line'>warning: package-query-1.7-1 is up to date -- reinstalling
</span><span class='line'>resolving dependencies...
</span><span class='line'>looking for conflicting packages...
</span><span class='line'>
</span><span class='line'>Packages (1) package-query-1.7-1
</span><span class='line'>
</span><span class='line'>Total Installed Size:  0.07 MiB
</span><span class='line'>Net Upgrade Size:      0.00 MiB
</span><span class='line'>
</span><span class='line'>:: Proceed with installation? [Y/n] y
</span><span class='line'>(1/1) checking keys in keyring                                                                      [##########################################################] 100%
</span><span class='line'>(1/1) checking package integrity                                                                    [##########################################################] 100%
</span><span class='line'>(1/1) loading package files                                                                         [##########################################################] 100%
</span><span class='line'>(1/1) checking for file conflicts                                                                   [##########################################################] 100%
</span><span class='line'>(1/1) checking available disk space                                                                 [##########################################################] 100%
</span><span class='line'>(1/1) reinstalling package-query                                                                    [##########################################################] 100%
</span><span class='line'>[staf@fanny package-query]$ </span></code></pre></td></tr></table></div></figure>


<h5>Install yaourt</h5>

<h6>git clone</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@fanny package-query]$ cd ~/git/aur   
</span><span class='line'>staf@fanny aur]$ git clone https://aur.archlinux.org/yaourt.git  
</span><span class='line'>Cloning into 'yaourt'...
</span><span class='line'>remote: Counting objects: 14, done.
</span><span class='line'>remote: Compressing objects: 100% (11/11), done.
</span><span class='line'>remote: Total 14 (delta 3), reused 14 (delta 3)
</span><span class='line'>Unpacking objects: 100% (14/14), done.
</span><span class='line'>Checking connectivity... done.
</span><span class='line'>[staf@fanny aur]$ </span></code></pre></td></tr></table></div></figure>


<p></p>

<h6>makepkg</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@fanny yaourt]$ makepkg -sri
</span><span class='line'>==&gt; Making package: yaourt 1.7-1 (Fri Dec 25 14:44:12 UTC 2015)
</span><span class='line'>==&gt; Checking runtime dependencies...
</span><span class='line'>==&gt; Checking buildtime dependencies...
</span><span class='line'>==&gt; Retrieving sources...
</span><span class='line'>  -&gt; Downloading yaourt-1.7.tar.gz...
</span><span class='line'>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span><span class='line'>                                 Dload  Upload   Total   Spent    Left  Speed
</span><span class='line'>100  123k  100  123k    0     0   222k      0 --:--:-- --:--:-- --:--:--  222k
</span><span class='line'>==&gt; Validating source files with md5sums...
</span><span class='line'>    yaourt-1.7.tar.gz ... Passed
</span><span class='line'>==&gt; Extracting sources...
</span><span class='line'>  -&gt; Extracting yaourt-1.7.tar.gz with bsdtar
</span><span class='line'>==&gt; Starting build()...
</span><span class='line'>        GEN yaourt.sh
</span><span class='line'>        GEN pacdiffviewer.sh
</span><span class='line'>        GEN yaourtrc
</span><span class='line'>        GEN lib/util.sh
</span><span class='line'>        GEN lib/pkgbuild.sh
</span><span class='line'>        GEN lib/pacman.sh
</span><span class='line'>        GEN lib/abs.sh
</span><span class='line'>==&gt; Entering fakeroot environment...
</span><span class='line'>==&gt; Starting package()...
</span><span class='line'>/usr/bin/env install -d /home/staf/git/aur/yaourt/pkg/yaourt/usr/bin
</span><span class='line'>/usr/bin/env install -d /home/staf/git/aur/yaourt/pkg/yaourt/usr/lib/yaourt
</span><span class='line'>/usr/bin/env install -d /home/staf/git/aur/yaourt/pkg/yaourt/etc
</span><span class='line'>/usr/bin/env install -d /home/staf/git/aur/yaourt/pkg/yaourt/usr/share/bash-completion/completions
</span><span class='line'>/usr/bin/env install -d /home/staf/git/aur/yaourt/pkg/yaourt/usr/share/man/man{5,8}
</span><span class='line'># Scripts
</span><span class='line'>/usr/bin/env install -m755 yaourt.sh /home/staf/git/aur/yaourt/pkg/yaourt/usr/bin/yaourt
</span><span class='line'>/usr/bin/env install -m755 pacdiffviewer.sh /home/staf/git/aur/yaourt/pkg/yaourt/usr/bin/pacdiffviewer
</span><span class='line'># Configuration
</span><span class='line'>/usr/bin/env install -m644 yaourtrc /home/staf/git/aur/yaourt/pkg/yaourt/etc/yaourtrc
</span><span class='line'>/usr/bin/env install -m644 bashcompletion /home/staf/git/aur/yaourt/pkg/yaourt/usr/share/bash-completion/completions/yaourt
</span><span class='line'># Libs
</span><span class='line'>/usr/bin/env install -m644 lib/alpm_backup.sh /home/staf/git/aur/yaourt/pkg/yaourt/usr/lib/yaourt
</span><span class='line'>/usr/bin/env install -m644 lib/alpm_query.sh /home/staf/git/aur/yaourt/pkg/yaourt/usr/lib/yaourt
</span><span class='line'>/usr/bin/env install -m644 lib/alpm_stats.sh /home/staf/git/aur/yaourt/pkg/yaourt/usr/lib/yaourt
</span><span class='line'>/usr/bin/env install -m644 lib/abs.sh /home/staf/git/aur/yaourt/pkg/yaourt/usr/lib/yaourt
</span><span class='line'>/usr/bin/env install -m644 lib/aur.sh /home/staf/git/aur/yaourt/pkg/yaourt/usr/lib/yaourt
</span><span class='line'>/usr/bin/env install -m644 lib/util.sh /home/staf/git/aur/yaourt/pkg/yaourt/usr/lib/yaourt
</span><span class='line'>/usr/bin/env install -m644 lib/io.sh /home/staf/git/aur/yaourt/pkg/yaourt/usr/lib/yaourt
</span><span class='line'>/usr/bin/env install -m644 lib/pacman.sh /home/staf/git/aur/yaourt/pkg/yaourt/usr/lib/yaourt
</span><span class='line'>/usr/bin/env install -m644 lib/pkgbuild.sh /home/staf/git/aur/yaourt/pkg/yaourt/usr/lib/yaourt
</span><span class='line'>/usr/bin/env install -m644 lib/misc.sh /home/staf/git/aur/yaourt/pkg/yaourt/usr/lib/yaourt
</span><span class='line'># Man
</span><span class='line'>/usr/bin/env install -m644 man/*.5 /home/staf/git/aur/yaourt/pkg/yaourt/usr/share/man/man5
</span><span class='line'>/usr/bin/env install -m644 man/*.8 /home/staf/git/aur/yaourt/pkg/yaourt/usr/share/man/man8
</span><span class='line'># Locales
</span><span class='line'>test -x /usr/bin/msgfmt && for file in po/*/*.po; \
</span><span class='line'>do \
</span><span class='line'>  package=$(echo $file | /bin/sed -e 's#po/\([^/]\+\).*#\1#'); \
</span><span class='line'>  lang=$(echo $file | /bin/sed -e 's#.*/\([^/]\+\).po#\1#'); \
</span><span class='line'>  /usr/bin/env install -d /home/staf/git/aur/yaourt/pkg/yaourt/usr/share/locale/$lang/LC_MESSAGES; \
</span><span class='line'>  /usr/bin/msgfmt -o /home/staf/git/aur/yaourt/pkg/yaourt/usr/share/locale/$lang/LC_MESSAGES/$package.mo $file; \
</span><span class='line'>done
</span><span class='line'>==&gt; Tidying install...
</span><span class='line'>  -&gt; Purging unwanted files...
</span><span class='line'>  -&gt; Removing libtool files...
</span><span class='line'>  -&gt; Removing static library files...
</span><span class='line'>  -&gt; Compressing man and info pages...
</span><span class='line'>  -&gt; Stripping unneeded symbols from binaries and libraries...
</span><span class='line'>==&gt; Creating package "yaourt"...
</span><span class='line'>  -&gt; Generating .PKGINFO file...
</span><span class='line'>  -&gt; Generating .MTREE file...
</span><span class='line'>  -&gt; Compressing package...
</span><span class='line'>==&gt; Leaving fakeroot environment.
</span><span class='line'>==&gt; Finished making: yaourt 1.7-1 (Fri Dec 25 14:44:16 UTC 2015)
</span><span class='line'>==&gt; Installing package yaourt with pacman -U...
</span><span class='line'>[sudo] password for staf: 
</span><span class='line'>loading packages...
</span><span class='line'>warning: yaourt-1.7-1 is up to date -- reinstalling
</span><span class='line'>resolving dependencies...
</span><span class='line'>looking for conflicting packages...
</span><span class='line'>
</span><span class='line'>Packages (1) yaourt-1.7-1
</span><span class='line'>
</span><span class='line'>Total Installed Size:  0.72 MiB
</span><span class='line'>Net Upgrade Size:      0.00 MiB
</span><span class='line'>
</span><span class='line'>:: Proceed with installation? [Y/n] y
</span><span class='line'>(1/1) checking keys in keyring                                                                      [##########################################################] 100%
</span><span class='line'>(1/1) checking package integrity                                                                    [##########################################################] 100%
</span><span class='line'>(1/1) loading package files                                                                         [##########################################################] 100%
</span><span class='line'>(1/1) checking for file conflicts                                                                   [##########################################################] 100%
</span><span class='line'>(1/1) checking available disk space                                                                 [##########################################################] 100%
</span><span class='line'>(1/1) reinstalling yaourt                                                                           [##########################################################] 100%
</span><span class='line'>[staf@fanny yaourt]$ </span></code></pre></td></tr></table></div></figure>


<h4>Install debootstrap</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@fanny ~]$ yaourt debootstrap
</span><span class='line'>1 aur/cdebootstrap-static 0.6.5-1 (10)
</span><span class='line'>    Bootstrap a Debian system
</span><span class='line'>2 aur/debootstrap 1.0.75-1 [installed] (224)
</span><span class='line'>    A tool used to create a Debian base system from scratch, without requiring the availability of dpkg or apt
</span><span class='line'>3 aur/rinse 3.0.2-2 (0)
</span><span class='line'>    Bootstrap a rpm based distribution like debootstrap
</span><span class='line'>==&gt; Enter n of packages to be installed (ex: 1 2 3 or 1-3)
</span><span class='line'>==&gt; --------------------------------------------------------
</span><span class='line'>==&gt; 2
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>==&gt; Downloading debootstrap PKGBUILD from AUR...
</span><span class='line'>x .SRCINFO
</span><span class='line'>x .gitignore
</span><span class='line'>x PKGBUILD
</span><span class='line'>zeilenleser commented on 2015-07-29 10:49 
</span><span class='line'>Thanks for maintaining this package.
</span><span class='line'>
</span><span class='line'>just for your information, version 1.0.72 is out since 2015-07-28
</span><span class='line'>
</span><span class='line'>Regards
</span><span class='line'>
</span><span class='line'>zeilenleser commented on 2015-07-29 12:13 
</span><span class='line'>I followed @Tigrouzens suggestion with this modification
</span><span class='line'>
</span><span class='line'>DEF_MIRROR="http://mirrors.kernel.org/ubuntu"
</span><span class='line'>
</span><span class='line'>Since only DEF_HTTPS_MIRROR is used in my case I don't know if this works. Testing with the browser was successful.
</span><span class='line'>
</span><span class='line'>bricewge commented on 2015-12-07 16:58 (last edited on 2015-12-07 16:58 by bricewge) 
</span><span class='line'>@Tigrouzens why don't you want to install ubuntu-keyring?
</span><span class='line'>
</span><span class='line'>Your advice didn't work for me, I still had the error about GPG. But after installing gnupg1 and ubuntu-keyring, enrering the following command worked fine.
</span><span class='line'># debootstrap wily ubuntu https://mirrors.kernel.org/ubuntu
</span><span class='line'>
</span><span class='line'>abeutot commented on 2015-12-08 11:57 
</span><span class='line'>Seems like there is a missing dependency to binutils since ar is needed to extract deb packages.
</span><span class='line'>
</span><span class='line'>JonnyJD commented on 2015-12-08 12:12 
</span><span class='line'>binutils is in the "base-devel" group which is an implicit requirement before using the AUR altogether:
</span><span class='line'>https://wiki.archlinux.org/index.php/Arch_User_Repository#Prerequisites
</span><span class='line'>
</span><span class='line'>debootstrap 1.0.75-1  (2015-11-12 16:15)
</span><span class='line'>( Unsupported package: Potentially dangerous ! )
</span><span class='line'>==&gt; Edit PKGBUILD ? [Y/n] ("A" to abort)
</span><span class='line'>==&gt; ------------------------------------
</span><span class='line'>==&gt; n
</span><span class='line'>
</span><span class='line'>==&gt; debootstrap dependencies:
</span><span class='line'> - wget (already installed)
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>==&gt; Continue building debootstrap ? [Y/n]
</span><span class='line'>==&gt; -------------------------------------
</span><span class='line'>==&gt; 
</span><span class='line'>==&gt; Building and installing package
</span><span class='line'>==&gt; Making package: debootstrap 1.0.75-1 (Fri Dec 25 14:48:55 UTC 2015)
</span><span class='line'>==&gt; Checking runtime dependencies...
</span><span class='line'>==&gt; Checking buildtime dependencies...
</span><span class='line'>==&gt; Retrieving sources...
</span><span class='line'>  -&gt; Downloading debootstrap_1.0.75_all.deb...
</span><span class='line'>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span><span class='line'>                                 Dload  Upload   Total   Spent    Left  Speed
</span><span class='line'>100 65978  100 65978    0     0   155k      0 --:--:-- --:--:-- --:--:--  155k
</span><span class='line'>==&gt; Validating source files with md5sums...
</span><span class='line'>    debootstrap_1.0.75_all.deb ... Passed
</span><span class='line'>==&gt; Extracting sources...
</span><span class='line'>  -&gt; Extracting debootstrap_1.0.75_all.deb with bsdtar
</span><span class='line'>==&gt; Entering fakeroot environment...
</span><span class='line'>==&gt; Starting package()...
</span><span class='line'>==&gt; Tidying install...
</span><span class='line'>  -&gt; Purging unwanted files...
</span><span class='line'>  -&gt; Removing libtool files...
</span><span class='line'>  -&gt; Removing static library files...
</span><span class='line'>  -&gt; Compressing man and info pages...
</span><span class='line'>  -&gt; Stripping unneeded symbols from binaries and libraries...
</span><span class='line'>==&gt; Creating package "debootstrap"...
</span><span class='line'>  -&gt; Generating .PKGINFO file...
</span><span class='line'>  -&gt; Generating .MTREE file...
</span><span class='line'>  -&gt; Compressing package...
</span><span class='line'>==&gt; Leaving fakeroot environment.
</span><span class='line'>==&gt; Finished making: debootstrap 1.0.75-1 (Fri Dec 25 14:48:57 UTC 2015)
</span><span class='line'>
</span><span class='line'>==&gt; Continue installing debootstrap ? [Y/n]
</span><span class='line'>==&gt; [v]iew package contents [c]heck package with namcap
</span><span class='line'>==&gt; ---------------------------------------------------
</span><span class='line'>==&gt; y
</span><span class='line'>
</span><span class='line'>loading packages...
</span><span class='line'>warning: debootstrap-1.0.75-1 is up to date -- reinstalling
</span><span class='line'>resolving dependencies...
</span><span class='line'>looking for conflicting packages...
</span><span class='line'>
</span><span class='line'>Packages (1) debootstrap-1.0.75-1
</span><span class='line'>
</span><span class='line'>Total Installed Size:  0.19 MiB
</span><span class='line'>Net Upgrade Size:      0.00 MiB
</span><span class='line'>
</span><span class='line'>:: Proceed with installation? [Y/n] y
</span><span class='line'>(1/1) checking keys in keyring                                                                      [##########################################################] 100%
</span><span class='line'>(1/1) checking package integrity                                                                    [##########################################################] 100%
</span><span class='line'>(1/1) loading package files                                                                         [##########################################################] 100%
</span><span class='line'>(1/1) checking for file conflicts                                                                   [##########################################################] 100%
</span><span class='line'>(1/1) checking available disk space                                                                 [##########################################################] 100%
</span><span class='line'>(1/1) reinstalling debootstrap                                                                      [##########################################################] 100%
</span><span class='line'>[staf@fanny ~]$ </span></code></pre></td></tr></table></div></figure>


<h4>gpg keyring</h4>

<p>debootrap needs gnupg1 there is an aur available <a href="https://aur.archlinux.org/packages/gnupg1/"><a href="https://aur.archlinux.org/packages/gnupg1/">https://aur.archlinux.org/packages/gnupg1/</a></a> but armv7h isn&rsquo;t include in the supported architectures so we&rsquo;ll need to add it.</p>

<h5>Install gnupg1</h5>

<h6>Git clone</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@fanny ~]$ cd ~/git/aur
</span><span class='line'>staf@fanny aur]$ git clone https://aur.archlinux.org/gnupg1.git
</span><span class='line'>Cloning into 'gnupg1'...
</span><span class='line'>remote: Counting objects: 8, done.
</span><span class='line'>remote: Compressing objects: 100% (8/8), done.
</span><span class='line'>remote: Total 8 (delta 0), reused 8 (delta 0)
</span><span class='line'>Unpacking objects: 100% (8/8), done.
</span><span class='line'>Checking connectivity... done.
</span><span class='line'>[staf@fanny aur]$ </span></code></pre></td></tr></table></div></figure>


<h6>Update PKGBUILD</h6>

<p>Edit PKGBUILD</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@fanny gnupg1]$ vi PKGBUILD </span></code></pre></td></tr></table></div></figure>


<p>and add armv7h to the arch</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pkgdesc="GNU Privacy Guard - a PGP replacement tool"
</span><span class='line'>arch=('i686' 'x86_64' 'armv6h' 'armv7h')
</span><span class='line'>license=('GPL3')
</span><span class='line'>depends=('zlib' 'bzip2' 'libldap&gt;=2.4.18' 'libusb-compat' 'curl&gt;=7.16.2' 'readline&gt;=6.0.00')</span></code></pre></td></tr></table></div></figure>


<h6>Update the keyring</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@fanny gnupg1]$ gpg --keyserver pgpkeys.mit.edu --recv-keys 2071B08A33BD3F06 
</span><span class='line'>gpg: key 33BD3F06: "NIIBE Yutaka (GnuPG Release Key) &lt;gniibe@fsij.org&gt;" not changed
</span><span class='line'>gpg: Total number processed: 1
</span><span class='line'>gpg:              unchanged: 1
</span><span class='line'>[staf@fanny gnupg1]$ </span></code></pre></td></tr></table></div></figure>


<h6>makepkg</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@fanny gnupg1]$ makepkg -sri
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>  -&gt; Adding install file...
</span><span class='line'>  -&gt; Generating .MTREE file...
</span><span class='line'>  -&gt; Compressing package...
</span><span class='line'>==&gt; Leaving fakeroot environment.
</span><span class='line'>==&gt; Finished making: gnupg1 1.4.19-4 (Sat Dec 26 13:49:19 UTC 2015)
</span><span class='line'>==&gt; Installing package gnupg1 with pacman -U...
</span><span class='line'>[sudo] password for staf: 
</span><span class='line'>loading packages...
</span><span class='line'>resolving dependencies...
</span><span class='line'>looking for conflicting packages...
</span><span class='line'>
</span><span class='line'>Packages (1) gnupg1-1.4.19-4
</span><span class='line'>
</span><span class='line'>Total Installed Size:  4.97 MiB
</span><span class='line'>
</span><span class='line'>:: Proceed with installation? [Y/n] y
</span><span class='line'>(1/1) checking keys in keyring                                                         [##################################################] 100%
</span><span class='line'>(1/1) checking package integrity                                                       [##################################################] 100%
</span><span class='line'>(1/1) loading package files                                                            [##################################################] 100%
</span><span class='line'>(1/1) checking for file conflicts                                                      [##################################################] 100%
</span><span class='line'>(1/1) checking available disk space                                                    [##################################################] 100%
</span><span class='line'>(1/1) installing gnupg1                                                                [##################################################] 100%
</span><span class='line'>[staf@fanny gnupg1]$ </span></code></pre></td></tr></table></div></figure>


<h5>Install the  debian-archive-keyring aur</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@fanny debian]$ yaourt debian-archive-keyring 
</span><span class='line'>1 aur/debian-archive-keyring 2014.3-2 (59)
</span><span class='line'>    GnuPG archive keys of the Debian archive
</span><span class='line'>==&gt; Enter n of packages to be installed (ex: 1 2 3 or 1-3)
</span><span class='line'>==&gt; --------------------------------------------------------
</span><span class='line'>==&gt; 1
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>==&gt; Downloading debian-archive-keyring PKGBUILD from AUR...
</span><span class='line'>x .SRCINFO
</span><span class='line'>x PKGBUILD
</span><span class='line'>eworm commented on 2013-05-13 12:20 
</span><span class='line'>Please use package() function, recent makepkg warns about that.
</span><span class='line'>
</span><span class='line'>hcartiaux commented on 2013-05-15 08:00 
</span><span class='line'>Fixed
</span><span class='line'>
</span><span class='line'>ansys commented on 2014-10-24 11:31 
</span><span class='line'>New url http://ftp.fr.debian.org/debian/pool/main/d/debian-archive-keyring/debian-archive-keyring_2014.1_all.deb
</span><span class='line'>
</span><span class='line'>kozaki commented on 2014-12-11 14:58 
</span><span class='line'>Update
</span><span class='line'>url: http://ftp.fr.debian.org/debian/pool/main/d/debian-archive-keyring/debian-archive-keyring_2014.3_all.deb
</span><span class='line'>md5: 02b6818bd7cada9ef9d24534290b559c
</span><span class='line'>
</span><span class='line'>Thank you.
</span><span class='line'>
</span><span class='line'>debian-archive-keyring 2014.3-2  (2015-06-08 20:20)
</span><span class='line'>( Unsupported package: Potentially dangerous ! )
</span><span class='line'>==&gt; Edit PKGBUILD ? [Y/n] ("A" to abort)
</span><span class='line'>==&gt; ------------------------------------
</span><span class='line'>==&gt; n
</span><span class='line'>
</span><span class='line'>==&gt; debian-archive-keyring dependencies:
</span><span class='line'> - gnupg (already installed)
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>==&gt; Continue building debian-archive-keyring ? [Y/n]
</span><span class='line'>==&gt; ------------------------------------------------
</span><span class='line'>==&gt; 
</span><span class='line'>==&gt; Building and installing package
</span><span class='line'>==&gt; Making package: debian-archive-keyring 2014.3-2 (Sat Dec 26 13:02:52 UTC 2015)
</span><span class='line'>==&gt; Checking runtime dependencies...
</span><span class='line'>==&gt; Checking buildtime dependencies...
</span><span class='line'>==&gt; Retrieving sources...
</span><span class='line'>  -&gt; Downloading debian-archive-keyring_2014.3_all.deb...
</span><span class='line'>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span><span class='line'>                                 Dload  Upload   Total   Spent    Left  Speed
</span><span class='line'>100 40060  100 40060    0     0   103k      0 --:--:-- --:--:-- --:--:--  103k
</span><span class='line'>==&gt; Validating source files with md5sums...
</span><span class='line'>    debian-archive-keyring_2014.3_all.deb ... Passed
</span><span class='line'>==&gt; Extracting sources...
</span><span class='line'>  -&gt; Extracting debian-archive-keyring_2014.3_all.deb with bsdtar
</span><span class='line'>==&gt; Entering fakeroot environment...
</span><span class='line'>==&gt; Starting package()...
</span><span class='line'>./
</span><span class='line'>./usr/
</span><span class='line'>./usr/share/
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>
</span><span class='line'>==&gt; Continue installing debian-archive-keyring ? [Y/n]
</span><span class='line'>==&gt; [v]iew package contents [c]heck package with namcap
</span><span class='line'>==&gt; ---------------------------------------------------
</span><span class='line'>==&gt; y
</span><span class='line'>
</span><span class='line'>loading packages...
</span><span class='line'>resolving dependencies...
</span><span class='line'>looking for conflicting packages...
</span><span class='line'>
</span><span class='line'>Packages (1) debian-archive-keyring-2014.3-2
</span><span class='line'>
</span><span class='line'>Total Installed Size:  0.07 MiB
</span><span class='line'>
</span><span class='line'>:: Proceed with installation? [Y/n] y
</span><span class='line'>(1/1) checking keys in keyring                                                                                                                                                                                                                                  [##################################################################################################################################################################] 100%
</span><span class='line'>(1/1) checking package integrity                                                                                                                                                                                                                                [##################################################################################################################################################################] 100%
</span><span class='line'>(1/1) loading package files                                                                                                                                                                                                                                     [##################################################################################################################################################################] 100%
</span><span class='line'>(1/1) checking for file conflicts                                                                                                                                                                                                                               [##################################################################################################################################################################] 100%
</span><span class='line'>(1/1) checking available disk space                                                                                                                                                                                                                             [##################################################################################################################################################################] 100%
</span><span class='line'>(1/1) installing debian-archive-keyring                                                                                                                                                                                                                         [##################################################################################################################################################################] 100%
</span><span class='line'>[staf@fanny debian]$ </span></code></pre></td></tr></table></div></figure>


<h4>debootstrap</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@fanny debian]$ sudo debootstrap --verbose --include=iproute,iputils-ping --arch armhf jessie ./jessie-chroot http://http.debian.net/debian/
</span><span class='line'>[staf@fanny debian]$ sudo debootstrap --verbose --include=iproute,iputils-ping --arch armhf jessie ./jessie-chroot http://http.debian.net/debian/
</span><span class='line'>[sudo] password for staf: 
</span><span class='line'>I: Retrieving Release 
</span><span class='line'>I: Retrieving Release.gpg 
</span><span class='line'>I: Checking Release signature
</span><span class='line'>I: Valid Release signature (key id 75DDC3C4A499F1A18CB5F3C8CBF8D6FD518E17E1)
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>I: Configuring libgnutls-openssl27:armhf...
</span><span class='line'>I: Configuring iputils-ping...
</span><span class='line'>I: Configuring isc-dhcp-common...
</span><span class='line'>I: Configuring isc-dhcp-client...
</span><span class='line'>I: Configuring tasksel...
</span><span class='line'>I: Configuring tasksel-data...
</span><span class='line'>I: Configuring libc-bin...
</span><span class='line'>I: Configuring systemd...
</span><span class='line'>I: Base system installed successfully.
</span></code></pre></td></tr></table></div></figure>


<h4>Import</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@fanny jessie-chroot]$ sudo tar cpf - . | docker import - debian
</span><span class='line'>[sudo] password for staf: 
</span><span class='line'>1ec165fa2ccb264ab8196b8cd0c339b5d95e1b90879019cde0c633cca738277a
</span><span class='line'>[staf@fanny jessie-chroot]$ </span></code></pre></td></tr></table></div></figure>


<h4>Try it</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@fanny jessie-chroot]$ docker run -t -i --rm debian /bin/bash
</span><span class='line'>root@81afce29909f:/# cat /etc/debian_version 
</span><span class='line'>8.2
</span><span class='line'>root@81afce29909f:/# </span></code></pre></td></tr></table></div></figure>


<p><strong><em> Have fun &hellip; </em></strong></p>

<h4>Links</h4>

<ul>
<li><a href="http://archlinuxarm.org/"><a href="http://archlinuxarm.org/">http://archlinuxarm.org/</a></a></li>
<li><a href="http://archlinuxarm.org/platforms/armv7/samsung/odroid-u3"><a href="http://archlinuxarm.org/platforms/armv7/samsung/odroid-u3">http://archlinuxarm.org/platforms/armv7/samsung/odroid-u3</a></a></li>
<li><a href="https://wiki.archlinux.org/index.php/Docker"><a href="https://wiki.archlinux.org/index.php/Docker">https://wiki.archlinux.org/index.php/Docker</a></a></li>
<li><a href="http://forum.odroid.com/viewtopic.php?f=98&t=6638"><a href="http://forum.odroid.com/viewtopic.php?f=98&amp;t=6638">http://forum.odroid.com/viewtopic.php?f=98&amp;t=6638</a>">[Docker] lightweight virtualisation for your odroid host</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Protecting Your SSH Keys With SmartCard-HSM]]></title>
    <link href="http://stafwag.github.io/blog/blog/2015/12/05/protecting-your-ssh-keys-with-smartcard-hsm/"/>
    <updated>2015-12-05T09:37:41+01:00</updated>
    <id>http://stafwag.github.io/blog/blog/2015/12/05/protecting-your-ssh-keys-with-smartcard-hsm</id>
    <content type="html"><![CDATA[<p>I <a href="http://stafwag.github.io/blog/blog/2015/06/16/using-yubikey-neo-as-gpg-smartcard-for-ssh-authentication/">use</a> a  <a href="https://www.yubico.com/products/yubikey-hardware/yubikey-neo/">yubi key</a> for my ssh authentication. But I&rsquo;ve other ssh keys for my remote services so wanted something that allows me to take a backup of my keys see <a href="http://stafwag.github.io/blog/blog/2015/11/21/starting-to-protect-my-private-keys-with-smartcard-hsm/">this post</a> for more information on to backup/restore a <a href="http://www.smartcard-hsm.com">SmartCard-HSM</a></p>

<h2>Create your first ssh keypair</h2>

<h3>Verify your smartcard connection</h3>

<p>Insert you smartcard and verify the connection, see <a href="http://stafwag.github.io/blog/blog/2015/11/21/starting-to-protect-my-private-keys-with-smartcard-hsm/">my previous post</a> if  you need more information about the smartcard initialization</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ pkcs11-tool -L
</span><span class='line'>Available slots:
</span><span class='line'>Slot 0 (0xffffffffffffffff): Virtual hotplug slot
</span><span class='line'>  (empty)
</span><span class='line'>Slot 1 (0x1): Generic Smart Card Reader Interface [Smart Card Reader Interface
</span><span class='line'>  token label        : SmartCard-HSM (UserPIN)
</span><span class='line'>  token manufacturer : www.CardContact.de
</span><span class='line'>  token model        : PKCS#15 emulated
</span><span class='line'>  token flags        : rng, login required, PIN initialized, token initialized
</span><span class='line'>  hardware version   : 24.13
</span><span class='line'>  firmware version   : 1.2
</span><span class='line'>  serial num         : DECM0102331
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h3>Create your keypair</h3>

<p>Create your ssh key pair and give the a meaningful label</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ pkcs11-tool --slot 1 --keypairgen --key-type rsa:2048 --label my_ssh_key --login
</span><span class='line'>Logging in to "SmartCard-HSM (UserPIN)".
</span><span class='line'>Please enter User PIN: 
</span><span class='line'>Key pair generated:
</span><span class='line'>Private Key Object; RSA 
</span><span class='line'>  label:      my_ssh_key
</span><span class='line'>  ID:         fca6240eeef8d3156f0c4dfc591b2d938d6104cb
</span><span class='line'>  Usage:      decrypt, sign, unwrap
</span><span class='line'>Public Key Object; RSA 2048 bits
</span><span class='line'>  label:      my_ssh_key
</span><span class='line'>  ID:         fca6240eeef8d3156f0c4dfc591b2d938d6104cb
</span><span class='line'>  Usage:      encrypt, verify, wrap
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h3>Extract your public key</h3>

<p>We used <a href="https://en.wikipedia.org/wiki/PKCS_11">PKCS11</a> to generate the keypair, <a href="https://en.wikipedia.org/wiki/PKCS">PKCS15</a> is designed identify users to applications.</p>

<h4>Dump the token content</h4>

<p>Dump the token content to get the id of your ssh keypair.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ pkcs15-tool -D
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>PKCS#15 Card [SmartCard-HSM]:
</span><span class='line'>        Version        : 0
</span><span class='line'>        Serial number  : DECM0102331
</span><span class='line'>        Manufacturer ID: www.CardContact.de
</span><span class='line'>        Flags          : 
</span><span class='line'>
</span><span class='line'>PIN [UserPIN]
</span><span class='line'>        Object Flags   : [0x3], private, modifiable
</span><span class='line'>        ID             : 01
</span><span class='line'>        Flags          : [0x81A], local, unblock-disabled, initialized, exchangeRefData
</span><span class='line'>        Length         : min_len:6, max_len:15, stored_len:0
</span><span class='line'>        Pad char       : 0x00
</span><span class='line'>        Reference      : 129 (0x81)
</span><span class='line'>        Type           : ascii-numeric
</span><span class='line'>        Tries left     : 3
</span><span class='line'>
</span><span class='line'>PIN [SOPIN]
</span><span class='line'>        Object Flags   : [0x1], private
</span><span class='line'>        ID             : 02
</span><span class='line'>        Flags          : [0x9E], local, change-disabled, unblock-disabled, initialized, soPin
</span><span class='line'>        Length         : min_len:16, max_len:16, stored_len:0
</span><span class='line'>        Pad char       : 0x00
</span><span class='line'>        Reference      : 136 (0x88)
</span><span class='line'>        Type           : bcd
</span><span class='line'>        Tries left     : 3
</span><span class='line'>
</span><span class='line'>Private EC Key [myfirst_keypair]
</span><span class='line'>        Object Flags   : [0x3], private, modifiable
</span><span class='line'>        Usage          : [0x10C], sign, signRecover, derive
</span><span class='line'>        Access Flags   : [0x1D], sensitive, alwaysSensitive, neverExtract, local
</span><span class='line'>        FieldLength    : 256
</span><span class='line'>        Key ref        : 1 (0x1)
</span><span class='line'>        Native         : yes
</span><span class='line'>        Path           : e82b0601040181c31f0201::
</span><span class='line'>        Auth ID        : 01
</span><span class='line'>        ID             : ae79417e809ed19b9a69d4c14f444462ad0bd66c
</span><span class='line'>        MD:guid        : {efac9b29-2289-658c-98d1-af5af965d484}
</span><span class='line'>          :cmap flags  : 0x0
</span><span class='line'>          :sign        : 0
</span><span class='line'>          :key-exchange: 0
</span><span class='line'>
</span><span class='line'>Private RSA Key [my_ssh_key]
</span><span class='line'>        Object Flags   : [0x3], private, modifiable
</span><span class='line'>        Usage          : [0x2E], decrypt, sign, signRecover, unwrap
</span><span class='line'>        Access Flags   : [0x1D], sensitive, alwaysSensitive, neverExtract, local
</span><span class='line'>        ModLength      : 2048
</span><span class='line'>        Key ref        : 2 (0x2)
</span><span class='line'>        Native         : yes
</span><span class='line'>        Path           : e82b0601040181c31f0201::
</span><span class='line'>        Auth ID        : 01
</span><span class='line'>        ID             : fca6240eeef8d3156f0c4dfc591b2d938d6104cb
</span><span class='line'>        MD:guid        : {a272b2ad-ff6f-606c-801a-4153be498018}
</span><span class='line'>          :cmap flags  : 0x0
</span><span class='line'>          :sign        : 0
</span><span class='line'>          :key-exchange: 0
</span><span class='line'>
</span><span class='line'>Public EC Key [myfirst_keypair]
</span><span class='line'>        Object Flags   : [0x0]
</span><span class='line'>        Usage          : [0x0]
</span><span class='line'>        Access Flags   : [0x2], extract
</span><span class='line'>        FieldLength    : 256
</span><span class='line'>        Key ref        : 0 (0x0)
</span><span class='line'>        Native         : no
</span><span class='line'>        ID             : ae79417e809ed19b9a69d4c14f444462ad0bd66c
</span><span class='line'>        DirectValue    : &lt;present&gt;
</span><span class='line'>
</span><span class='line'>Public RSA Key [my_ssh_key]
</span><span class='line'>        Object Flags   : [0x0]
</span><span class='line'>        Usage          : [0x0]
</span><span class='line'>        Access Flags   : [0x2], extract
</span><span class='line'>        ModLength      : 2048
</span><span class='line'>        Key ref        : 0 (0x0)
</span><span class='line'>        Native         : no
</span><span class='line'>        ID             : fca6240eeef8d3156f0c4dfc591b2d938d6104cb
</span><span class='line'>        DirectValue    : &lt;present&gt;
</span><span class='line'>
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h4>Get the public key</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ pkcs15-tool --read-ssh-key fca6240eeef8d3156f0c4dfc591b2d938d6104cb
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCWShfPjqh+pU8lCoIhXIXh+cGpSem1iNFH6TuluQQLPiqPIeObCTfqC8q9TjR/2FYzG+3ECdiRr0fiywE9OnzUgJI5oOjXfMwY3xE1PbYBrSvYERofhkEv2ejlyRifN3sbLGSU0V7pX+BNOuiJCquCehPMV9+ehkjbk9hPRFUzL1GywsOkmWUoIzrdjH0dlhPX3TUCdoizWAIdUqg+RX4DCEc52RvaGdX4Tn2THxeffXqFJ/gKkParZSLmOND1iRhtJeJ8CmgAqfD8ReshbcSs231h/QvUl3JaThcrLbPrSQFzVUH+rN+pGlSl722NWyPNPWlwwE+SreTLbQRoWayN my_ssh_key
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h3>Configure the remote host</h3>

<p>Add the key to the remote host</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@vicky .ssh]$ vi authorized_keys 
</span><span class='line'>[staf@vicky .ssh]$ 
</span></code></pre></td></tr></table></div></figure>


<h3>Test the connection</h3>

<p>Test you ssh connection with the PKCS11 interface:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ ssh localhost
</span><span class='line'>Permission denied (publickey,gssapi-keyex,gssapi-with-mic).</span></code></pre></td></tr></table></div></figure>


<p>With the PKCS11 interface enabled:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ ssh -o "PKCS11Provider opensc-pkcs11.so" localhost
</span><span class='line'>C_GetAttributeValue failed: 18
</span><span class='line'>Enter PIN for 'SmartCard-HSM (UserPIN)': 
</span><span class='line'>Last login: Thu Dec  3 09:55:23 2015 from ::1
</span><span class='line'>gpg-agent[17327]: enabled debug flags: command cache ipc
</span><span class='line'>gpg-agent: a gpg-agent is already running - not starting a new one
</span><span class='line'>gpg-agent: secmem usage: 0/32768 bytes in 0 blocks
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h3>Update your ssh_config</h3>

<p>Add PKCS11Provider opensc-pkcs11.so to your ~/.ssh/config or your global ssh_config</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@vicky ~]$ cd .ssh/
</span><span class='line'>[staf@vicky .ssh]$ vim config
</span><span class='line'>PKCS11Provider opensc-pkcs11.so
</span><span class='line'>[staf@vicky .ssh]$ </span></code></pre></td></tr></table></div></figure>


<p></p>

<p><strong><em> Have fun &hellip; </em></strong></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Starting to Protect My Private Keys With SmartCard-Hsm]]></title>
    <link href="http://stafwag.github.io/blog/blog/2015/11/21/starting-to-protect-my-private-keys-with-smartcard-hsm/"/>
    <updated>2015-11-21T10:32:06+01:00</updated>
    <id>http://stafwag.github.io/blog/blog/2015/11/21/starting-to-protect-my-private-keys-with-smartcard-hsm</id>
    <content type="html"><![CDATA[<p>I still have too many private keys on a local filesystem, I started to use the <a href="https://www.yubico.com/products/yubikey-hardware/yubikey-neo/">yubikey neo</a> for <a href="http://stafwag.github.io/blog/blog/2015/06/16/using-yubikey-neo-as-gpg-smartcard-for-ssh-authentication/">my ssh authentication</a>. Mainly because the nice formfactor of the yubikey.</p>

<p>For my other private keys/data I was looking for something cheeper since I need to have a backup of my secured data so I bought a few <a href="http://www.smartcard-hsm.com">Smartcard-HSM smartcards</a> they cost 16 &euro; each while a yubi-key neo cost 54 &euro; at amazon.de</p>

<h2>Preparing Backup and Restore</h2>

<p>The Smartcard-HSM has a backup/restore functionality this needs to be enabled before any keys are generated on the HSM.</p>

<p>To store our Device Key Encryption Key (DKEK) securely we need a safe place, we&rsquo;ll use an ecrypted usb stick.</p>

<p>It'is possible to configure multiple DKEK shares e.g. you will need multiple keys to perform a backup restore you might want to store these DKEK shares over multiple (encrypted) USB sticks/people.</p>

<p>If you want to create a backup of your DKEK shares we need to store at least two encrypted USB sticks.</p>

<p>For the convenience we&rsquo;ll store all DKEK shares on 1 encrypted USB stick in the example below you should executed it on an secured computer.</p>

<h3>Install opensc</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@vicky ~]$ sudo dnf install opensc
</span><span class='line'>Last metadata expiration check performed 0:23:14 ago on Wed Nov 11 14:47:21 2015.
</span><span class='line'>Package opensc-0.15.0-2.fc23.x86_64 is already installed, skipping.
</span><span class='line'>Dependencies resolved.
</span><span class='line'>Nothing to do.
</span><span class='line'>Complete!
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h3>Create an encrypted USB key stick</h3>

<h4>Write random data to the USB stick</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ sudo dd if=/dev/urandom of=/dev/sdn bs=1024
</span><span class='line'>[sudo] password for staf:                                                                                      
</span><span class='line'>dd: error writing /dev/sdn: No space left on device                                                          
</span><span class='line'>4029441+0 records in                                                                                           
</span><span class='line'>4029440+0 records out                                                                                          
</span><span class='line'>4126146560 bytes (4.1 GB) copied, 1280.14 s, 3.2 MB/s                                                          
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h4>luksFormat</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ sudo cryptsetup luksFormat --cipher serpent-cbc-essiv:sha256 --key-size 256 /dev/sdn
</span><span class='line'>
</span><span class='line'>WARNING!
</span><span class='line'>========
</span><span class='line'>This will overwrite data on /dev/sdn irrevocably.
</span><span class='line'>
</span><span class='line'>Are you sure? (Type uppercase yes): YES
</span><span class='line'>Enter passphrase: 
</span><span class='line'>Verify passphrase: 
</span><span class='line'>[staf@vicky ~]$ sudo cry
</span><span class='line'>cryptoflex-tool  cryptsetup       crywrap          
</span><span class='line'>[staf@vicky ~]$ sudo cryptsetup luksOpen /dev/sdn myprivatedata
</span><span class='line'>Enter passphrase for /dev/sdn: 
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h4>luksOpen</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ sudo cryptsetup luksOpen /dev/sdn myprivatedata
</span><span class='line'>Enter passphrase for /dev/sdn: 
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h4>mkfs</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ sudo mkfs.ext4 /dev/mapper/myprivatedata
</span><span class='line'>mke2fs 1.42.13 (17-May-2015)
</span><span class='line'>Creating filesystem with 1007360 4k blocks and 251968 inodes
</span><span class='line'>Filesystem UUID: 49390936-49e3-4606-abf2-567c3f5b50e1
</span><span class='line'>Superblock backups stored on blocks: 
</span><span class='line'>        32768, 98304, 163840, 229376, 294912, 819200, 884736
</span><span class='line'>
</span><span class='line'>Allocating group tables: done                            
</span><span class='line'>Writing inode tables: done                            
</span><span class='line'>Creating journal (16384 blocks): done
</span><span class='line'>Writing superblocks and filesystem accounting information: done 
</span><span class='line'>
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h3>Verify the encrypted USB stick</h3>

<p>To verify that the USB stick is encrypted and we can&rsquo;t mount without typing our passphrase we&rsquo;ll close the luks device and mount it.</p>

<h4>luksClose</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ sudo cryptsetup luksClose myprivatedata
</span><span class='line'>[sudo] password for staf: 
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h4>Try to mount it without luksOpen</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ sudo mount /dev/sdn /mnt
</span><span class='line'>mount: unknown filesystem type 'crypto_LUKS'
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h4>Mount it with luksOpen / mount</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ sudo cryptsetup luksOpen /dev/sdn myhsm_dkek
</span><span class='line'>Enter passphrase for /dev/sdn: 
</span><span class='line'>[staf@vicky ~]$ sudo mount /dev/mapper/myhsm_dkek /mnt
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h4>update the ownership</h4>

<p>Update the usb stick ownership</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ sudo chown staf:staf .
</span><span class='line'>[sudo] password for staf: 
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<h2>SmartCard initialization</h2>

<h3>pcsc_scan</h3>

<h4>start the pcscd service</h4>

<p>Start/enable the pcscd service if didn&rsquo;t enable it before</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@vicky ~]# systemctl list-unit-files -t service | grep pcscd
</span><span class='line'>pcscd.service                               static  
</span><span class='line'>[root@vicky ~]# systemctl start pcscd
</span><span class='line'>[root@vicky ~]# systemctl enable pcscd
</span><span class='line'>[root@vicky ~]# </span></code></pre></td></tr></table></div></figure>


<h4>run pcsc_scan</h4>

<p>Insert the smartcard into the read, run pcsc_scan to verify that you see the smartcard</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ pcsc_scan                    
</span><span class='line'>PC/SC device scanner
</span><span class='line'>V 1.4.23 (c) 2001-2011, Ludovic Rousseau &lt;ludovic.rousseau@free.fr&gt;
</span><span class='line'>Compiled with PC/SC lite version: 1.8.13
</span><span class='line'>Using reader plug'n play mechanism
</span><span class='line'>Scanning present readers...
</span><span class='line'>0: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>
</span><span class='line'>Wed Nov 11 10:58:59 2015
</span><span class='line'>Reader 0: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>  Card state: Card inserted, 
</span><span class='line'>  ATR: 3B FE 18 00 00 81 31 FE 45 80 31 81 54 48 53 4D 31 73 80 21 40 81 07 FA
</span><span class='line'>
</span><span class='line'>ATR: 3B FE 18 00 00 81 31 FE 45 80 31 81 54 48 53 4D 31 73 80 21 40 81 07 FA
</span><span class='line'>+ TS = 3B --&gt; Direct Convention
</span><span class='line'>+ T0 = FE, Y(1): 1111, K: 14 (historical bytes)
</span><span class='line'>  TA(1) = 18 --&gt; Fi=372, Di=12, 31 cycles/ETU
</span><span class='line'>    129032 bits/s at 4 MHz, fMax for Fi = 5 MHz =&gt; 161290 bits/s                                                     
</span><span class='line'>  TB(1) = 00 --&gt; VPP is not electrically connected
</span><span class='line'>  TC(1) = 00 --&gt; Extra guard time: 0
</span><span class='line'>  TD(1) = 81 --&gt; Y(i+1) = 1000, Protocol T = 1 
</span><span class='line'>-----
</span><span class='line'>  TD(2) = 31 --&gt; Y(i+1) = 0011, Protocol T = 1 
</span><span class='line'>-----
</span><span class='line'>  TA(3) = FE --&gt; IFSC: 254
</span><span class='line'>  TB(3) = 45 --&gt; Block Waiting Integer: 4 - Character Waiting Integer: 5
</span><span class='line'>+ Historical bytes: 80 31 81 54 48 53 4D 31 73 80 21 40 81 07
</span><span class='line'>  Category indicator byte: 80 (compact TLV data object)
</span><span class='line'>    Tag: 3, len: 1 (card service data byte)
</span><span class='line'>      Card service data byte: 81
</span><span class='line'>        - Application selection: by full DF name
</span><span class='line'>        - EF.DIR and EF.ATR access services: by GET RECORD(s) command
</span><span class='line'>        - Card without MF
</span><span class='line'>    Tag: 5, len: 4 (card issuer's data)
</span><span class='line'>      Card issuer data: 48 53 4D 31
</span><span class='line'>    Tag: 7, len: 3 (card capabilities)
</span><span class='line'>      Selection methods: 80
</span><span class='line'>        - DF selection by full DF name
</span><span class='line'>      Data coding byte: 21
</span><span class='line'>        - Behaviour of write functions: proprietary
</span><span class='line'>        - Value 'FF' for the first byte of BER-TLV tag fields: invalid
</span><span class='line'>        - Data unit in quartets: 2
</span><span class='line'>      Command chaining, length fields and logical channels: 40
</span><span class='line'>        - Extended Lc and Le fields
</span><span class='line'>        - Logical channel number assignment: No logical channel
</span><span class='line'>        - Maximum number of logical channels: 1
</span><span class='line'>    Tag: 8, len: 1 (status indicator)
</span><span class='line'>      LCS (life card cycle): 07
</span><span class='line'>+ TCK = FA (correct checksum)
</span><span class='line'>
</span><span class='line'>Possibly identified card (using /usr/share/pcsc/smartcard_list.txt):
</span><span class='line'>3B FE 18 00 00 81 31 FE 45 80 31 81 54 48 53 4D 31 73 80 21 40 81 07 FA
</span><span class='line'>        Smartcard-HSM
</span><span class='line'>        http://www.cardcontact.de/products/sc-hsm.html
</span></code></pre></td></tr></table></div></figure>


<h3>Initialize the first smartcard</h3>

<h4>Create two DKEK shares</h4>

<ul>
<li>1st share;</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --create-dkek-share dkek-share-1.pbe
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>
</span><span class='line'>The DKEK share will be enciphered using a key derived from a user supplied password.
</span><span class='line'>The security of the DKEK share relies on a well chosen and sufficiently long password.
</span><span class='line'>The recommended length is more than 10 characters, which are mixed letters, numbers and
</span><span class='line'>symbols.
</span><span class='line'>
</span><span class='line'>Please keep the generated DKEK share file in a safe location. We also recommend to keep a
</span><span class='line'>paper printout, in case the electronic version becomes unavailable. A printable version
</span><span class='line'>of the file can be generated using "openssl base64 -in &lt;filename&gt;".
</span><span class='line'>Enter password to encrypt DKEK share : 
</span><span class='line'>
</span><span class='line'>Please retype password to confirm : 
</span><span class='line'>
</span><span class='line'>Passwords do not match. Please retry.
</span><span class='line'>Enter password to encrypt DKEK share : 
</span><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --create-dkek-share dkek-share-1.pbe
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>
</span><span class='line'>The DKEK share will be enciphered using a key derived from a user supplied password.
</span><span class='line'>The security of the DKEK share relies on a well chosen and sufficiently long password.
</span><span class='line'>The recommended length is more than 10 characters, which are mixed letters, numbers and
</span><span class='line'>symbols.
</span><span class='line'>
</span><span class='line'>Please keep the generated DKEK share file in a safe location. We also recommend to keep a
</span><span class='line'>paper printout, in case the electronic version becomes unavailable. A printable version
</span><span class='line'>of the file can be generated using "openssl base64 -in &lt;filename&gt;".
</span><span class='line'>Enter password to encrypt DKEK share : 
</span><span class='line'>
</span><span class='line'>Please retype password to confirm : 
</span><span class='line'>
</span><span class='line'>Enciphering DKEK share, please wait...
</span><span class='line'>DKEK share created and saved to dkek-share-1.pbe
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<ul>
<li>2nd share;</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --create-dkek-share dkek-share-2.pbe
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>
</span><span class='line'>The DKEK share will be enciphered using a key derived from a user supplied password.
</span><span class='line'>The security of the DKEK share relies on a well chosen and sufficiently long password.
</span><span class='line'>The recommended length is more than 10 characters, which are mixed letters, numbers and
</span><span class='line'>symbols.
</span><span class='line'>
</span><span class='line'>Please keep the generated DKEK share file in a safe location. We also recommend to keep a
</span><span class='line'>paper printout, in case the electronic version becomes unavailable. A printable version
</span><span class='line'>of the file can be generated using "openssl base64 -in &lt;filename&gt;".
</span><span class='line'>Enter password to encrypt DKEK share : 
</span><span class='line'>
</span><span class='line'>Please retype password to confirm : 
</span><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --create-dkek-share dkek-share-2.pbe
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>
</span><span class='line'>The DKEK share will be enciphered using a key derived from a user supplied password.
</span><span class='line'>The security of the DKEK share relies on a well chosen and sufficiently long password.
</span><span class='line'>The recommended length is more than 10 characters, which are mixed letters, numbers and
</span><span class='line'>symbols.
</span><span class='line'>
</span><span class='line'>Please keep the generated DKEK share file in a safe location. We also recommend to keep a
</span><span class='line'>paper printout, in case the electronic version becomes unavailable. A printable version
</span><span class='line'>of the file can be generated using "openssl base64 -in &lt;filename&gt;".
</span><span class='line'>Enter password to encrypt DKEK share : 
</span><span class='line'>
</span><span class='line'>Please retype password to confirm : 
</span><span class='line'>
</span><span class='line'>Enciphering DKEK share, please wait...
</span><span class='line'>DKEK share created and saved to dkek-share-2.pbe
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<p>If you want a backup of DKEK shares copy them to another (encrypted) USB stick(s).</p>

<h4>Initialize the SmartCard</h4>

<ul>
<li>Initialize</li>
</ul>


<p>Use sc-hsm-tool to Intialize the smartcard and specify the number DKEK shares that you&rsquo;ll use. You&rsquo;ll need to pick a PIN code for the &ldquo;security officer&rdquo; and the &ldquo;user&rdquo;.</p>

<p>If you forget the so-pin you can not reinitialize the smartcard again so be sure that you pick so-pin that you can remember or write it down and store it on secure location. The so-pin has to be 16 digits long.</p>

<p><strong>
The sc-hsm-tool only asks for the PIN code ones so be sure that you know what you have typed. If you don&rsquo;t know it you smartcard becomes trash&hellip;
</strong></p>

<p>It possible to specify the pin code with &ldquo;&ndash;so-pin&rdquo; and &ldquo;&ndash;pin&rdquo; argument but this leaves the pin code in your shell history or in the process list&hellip;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --initialize --dkek-shares 2
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>Enter SO-PIN (16 hexadecimal characters) : 
</span><span class='line'>
</span><span class='line'>Enter initial User-PIN (6 - 16 characters) : 
</span><span class='line'>
</span><span class='line'>[staf@vicky mnt]$ 
</span></code></pre></td></tr></table></div></figure>


<p>If you execute the sc-hsm-tool command you&rsquo;ll see that the DKEK shares are still missing;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ sc-hsm-tool 
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>Version              : 1.2
</span><span class='line'>User PIN tries left  : 3
</span><span class='line'>DKEK shares          : 2
</span><span class='line'>DKEK import pending, 2 share(s) still missing
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<ul>
<li>import the dkek shares</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --import-dkek-share dkek-share-1.pbe
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>Enter password to decrypt DKEK share : 
</span><span class='line'>
</span><span class='line'>Deciphering DKEK share, please wait...
</span><span class='line'>DKEK share imported
</span><span class='line'>DKEK shares          : 2
</span><span class='line'>DKEK import pending, 1 share(s) still missing
</span><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --import-dkek-share dkek-share-2.pbe
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>Enter password to decrypt DKEK share : 
</span><span class='line'>
</span><span class='line'>Deciphering DKEK share, please wait...
</span><span class='line'>DKEK share imported
</span><span class='line'>DKEK shares          : 2
</span><span class='line'>DKEK key check value : 2C63E9E5D6FE0B8C
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<h4>test the user and so pin</h4>

<p>list the pkcs#11 slots</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ pkcs11-tool --module opensc-pkcs11.so -L
</span><span class='line'>Available slots:
</span><span class='line'>Slot 0 (0xffffffffffffffff): Virtual hotplug slot
</span><span class='line'>  (empty)
</span><span class='line'>Slot 1 (0x1): Generic Smart Card Reader Interface [Smart Card Reader Interface
</span><span class='line'>  token label        : SmartCard-HSM (UserPIN)
</span><span class='line'>  token manufacturer : www.CardContact.de
</span><span class='line'>  token model        : PKCS#15 emulated
</span><span class='line'>  token flags        : rng, login required, PIN initialized, token initialized
</span><span class='line'>  hardware version   : 24.13
</span><span class='line'>  firmware version   : 1.2
</span><span class='line'>  serial num         : DECM0102332
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<p>test the user pin;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@vicky mnt]$ pkcs11-tool --module opensc-pkcs11.so --slot 1 --login --test
</span><span class='line'>Logging in to "SmartCard-HSM (UserPIN)".
</span><span class='line'>Please enter User PIN: 
</span><span class='line'>C_SeedRandom() and C_GenerateRandom():
</span><span class='line'>  seeding (C_SeedRandom) not supported
</span><span class='line'>  seems to be OK
</span><span class='line'>Digests:
</span><span class='line'>  all 4 digest functions seem to work
</span><span class='line'>  MD5: OK
</span><span class='line'>  SHA-1: OK
</span><span class='line'>  RIPEMD160: OK
</span><span class='line'>Signatures (currently only RSA signatures)
</span><span class='line'>Signatures: no private key found in this slot
</span><span class='line'>Verify (currently only for RSA):
</span><span class='line'>  No private key found for testing
</span><span class='line'>Unwrap: not implemented
</span><span class='line'>Decryption (RSA)
</span><span class='line'>No errors
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<p>test the so pin</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ pkcs11-tool --module opensc-pkcs11.so --slot 1 --login --test --login-type so
</span><span class='line'>Logging in to "SmartCard-HSM (UserPIN)".
</span><span class='line'>Please enter SO PIN: 
</span><span class='line'>C_SeedRandom() and C_GenerateRandom():
</span><span class='line'>  seeding (C_SeedRandom) not supported
</span><span class='line'>  seems to be OK
</span><span class='line'>Digests:
</span><span class='line'>  all 4 digest functions seem to work
</span><span class='line'>  MD5: OK
</span><span class='line'>  SHA-1: OK
</span><span class='line'>  RIPEMD160: OK
</span><span class='line'>Signatures: not logged in, skipping signature tests
</span><span class='line'>Verify: not logged in, skipping verify tests
</span><span class='line'>Key unwrap: not a R/W session, skipping key unwrap tests
</span><span class='line'>Decryption: not logged in, skipping decryption tests
</span><span class='line'>No errors
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<h3>Create your first keypair</h3>

<h4>create key pair</h4>

<p>The command below an <a href="https://en.wikipedia.org/wiki/Elliptic_curve_cryptography">Elliptic Curve Cryptography (ECC)</a> key pair.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ pkcs11-tool --module opensc-pkcs11.so --keypairgen --key-type EC:prime256v1 --label myfirst_keypair --login
</span><span class='line'>Using slot 1 with a present token (0x1)
</span><span class='line'>Logging in to "SmartCard-HSM (UserPIN)".
</span><span class='line'>Please enter User PIN: 
</span><span class='line'>Key pair generated:
</span><span class='line'>Private Key Object; EC
</span><span class='line'>  label:      myfirst_keypair
</span><span class='line'>  ID:         ae79417e809ed19b9a69d4c14f444462ad0bd66c
</span><span class='line'>  Usage:      sign, derive
</span><span class='line'>Public Key Object; EC  EC_POINT 256 bits
</span><span class='line'>  EC_POINT:   044104f8ead77d1411e016196141d9d1f747a481aec4be40d1f8822d26d407fee05902082e18843ee58db4f5575b19ff243a735b66b2c91adbec1a59aeacc7c1ae8b52
</span><span class='line'>  EC_PARAMS:  06082a8648ce3d030107
</span><span class='line'>  label:      myfirst_keypair
</span><span class='line'>  ID:         ae79417e809ed19b9a69d4c14f444462ad0bd66c
</span><span class='line'>  Usage:      verify
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<h4>list objects</h4>

<p>list the objects to verif that your keypair in on the smartcard</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@vicky mnt]$ pkcs11-tool --module opensc-pkcs11.so --list-objects
</span><span class='line'>Using slot 1 with a present token (0x1)
</span><span class='line'>Public Key Object; EC  EC_POINT 256 bits
</span><span class='line'>  EC_POINT:   044104f8ead77d1411e016196141d9d1f747a481aec4be40d1f8822d26d407fee05902082e18843ee58db4f5575b19ff243a735b66b2c91adbec1a59aeacc7c1ae8b52
</span><span class='line'>  EC_PARAMS:  06082a8648ce3d030107
</span><span class='line'>  label:      myfirst_keypair
</span><span class='line'>  ID:         ae79417e809ed19b9a69d4c14f444462ad0bd66c
</span><span class='line'>  Usage:      none
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<h2>Copy objects to another smartcard</h2>

<h3>Backup</h3>

<p>To create a backup of our keys or data we need to extract it from the smartcard and copy it to another.
To store the object temporary we can use an encrypted filesystem or even a ram disk on a secured computer.</p>

<p>For security reasons you might want to separate your DKEK share from you key backups,
For the convenience we&rsquo;ll store everything on an encrypted USB stick.</p>

<h4>get the object reference</h4>

<p>First we need to find the object reference</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ pkcs15-tool -D
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>PKCS#15 Card [SmartCard-HSM]:
</span><span class='line'>        Version        : 0
</span><span class='line'>        Serial number  : DECM0102332
</span><span class='line'>        Manufacturer ID: www.CardContact.de
</span><span class='line'>        Flags          : 
</span><span class='line'>
</span><span class='line'>PIN [UserPIN]
</span><span class='line'>        Object Flags   : [0x3], private, modifiable
</span><span class='line'>        ID             : 01
</span><span class='line'>        Flags          : [0x81A], local, unblock-disabled, initialized, exchangeRefData
</span><span class='line'>        Length         : min_len:6, max_len:15, stored_len:0
</span><span class='line'>        Pad char       : 0x00
</span><span class='line'>        Reference      : 129 (0x81)
</span><span class='line'>        Type           : ascii-numeric
</span><span class='line'>        Tries left     : 3
</span><span class='line'>
</span><span class='line'>PIN [SOPIN]
</span><span class='line'>        Object Flags   : [0x1], private
</span><span class='line'>        ID             : 02
</span><span class='line'>        Flags          : [0x9E], local, change-disabled, unblock-disabled, initialized, soPin
</span><span class='line'>        Length         : min_len:16, max_len:16, stored_len:0
</span><span class='line'>        Pad char       : 0x00
</span><span class='line'>        Reference      : 136 (0x88)
</span><span class='line'>        Type           : bcd
</span><span class='line'>        Tries left     : 3
</span><span class='line'>
</span><span class='line'>Private EC Key [myfirst_keypair]
</span><span class='line'>        Object Flags   : [0x3], private, modifiable
</span><span class='line'>        Usage          : [0x10C], sign, signRecover, derive
</span><span class='line'>        Access Flags   : [0x1D], sensitive, alwaysSensitive, neverExtract, local
</span><span class='line'>        FieldLength    : 256
</span><span class='line'>        Key ref        : 1 (0x1)
</span><span class='line'>        Native         : yes
</span><span class='line'>        Path           : e82b0601040181c31f0201::
</span><span class='line'>        Auth ID        : 01
</span><span class='line'>        ID             : ae79417e809ed19b9a69d4c14f444462ad0bd66c
</span><span class='line'>        MD:guid        : {3a03d245-ea49-1da1-d8cd-f2ced0526400}
</span><span class='line'>          :cmap flags  : 0x0
</span><span class='line'>          :sign        : 0
</span><span class='line'>          :key-exchange: 0
</span><span class='line'>
</span><span class='line'>Public EC Key [myfirst_keypair]
</span><span class='line'>        Object Flags   : [0x0]
</span><span class='line'>        Usage          : [0x0]
</span><span class='line'>        Access Flags   : [0x2], extract
</span><span class='line'>        FieldLength    : 256
</span><span class='line'>        Key ref        : 0 (0x0)
</span><span class='line'>        Native         : no
</span><span class='line'>        ID             : ae79417e809ed19b9a69d4c14f444462ad0bd66c
</span><span class='line'>        DirectValue    : &lt;present&gt;
</span><span class='line'>
</span><span class='line'>[staf@vicky mnt]$ pkcs15-tool -D</span></code></pre></td></tr></table></div></figure>


<p></p>

<h4>extract the object(s)</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --wrap-key private_myfirst_keypair --key-reference 1 
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>Enter User PIN : 
</span><span class='line'>
</span><span class='line'>[staf@vicky mnt]$ ls -l
</span><span class='line'>total 28
</span><span class='line'>-rw-r--r-- 1 swagemakers backup    64 Nov 11 13:42 dkek-share-1.pbe
</span><span class='line'>-rw-r--r-- 1 swagemakers backup    64 Nov 11 13:42 dkek-share-2.pbe
</span><span class='line'>drwx------ 2 root        root   16384 Nov 11 13:37 lost+found
</span><span class='line'>-rw-rw-r-- 1 staf        staf     926 Nov 11 14:05 private_myfirst_keypair
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<p>Please not that we only need to copy the private key, the backup object also contains the public keypair.</p>

<h3>Initialize a second smartcard</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --initialize --dkek-shares 2
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>Enter SO-PIN (16 hexadecimal characters) : 
</span><span class='line'>
</span><span class='line'>Enter initial User-PIN (6 - 16 characters) : 
</span><span class='line'>
</span><span class='line'>[staf@vicky mnt]$ sc-hsm-tool 
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>Version              : 1.2
</span><span class='line'>User PIN tries left  : 3
</span><span class='line'>DKEK shares          : 2
</span><span class='line'>DKEK import pending, 2 share(s) still missing
</span><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --import-dkek-share dkek-share-1.pbe
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>Enter password to decrypt DKEK share : 
</span><span class='line'>
</span><span class='line'>Deciphering DKEK share, please wait...
</span><span class='line'>DKEK share imported
</span><span class='line'>DKEK shares          : 2
</span><span class='line'>DKEK import pending, 1 share(s) still missing
</span><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --import-dkek-share dkek-share-2.pbe
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>Enter password to decrypt DKEK share : 
</span><span class='line'>
</span><span class='line'>Deciphering DKEK share, please wait...
</span><span class='line'>DKEK share imported
</span><span class='line'>DKEK shares          : 2
</span><span class='line'>DKEK key check value : 2C63E9E5D6FE0B8C
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<h3>Store the key pair</h3>

<p>It&rsquo;s possible to write the private object to another smartcard with the same DKEK shares.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --unwrap-key private_myfirst_keypair --key-reference 1
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>Wrapped key contains:
</span><span class='line'>  Key blob
</span><span class='line'>  Private Key Description (PRKD)
</span><span class='line'>  Certificate
</span><span class='line'>Enter User PIN : 
</span><span class='line'>
</span><span class='line'>Key successfully imported
</span><span class='line'>[staf@vicky mnt]$ pkcs11-tool --list-objects 
</span><span class='line'>Using slot 1 with a present token (0x1)
</span><span class='line'>Public Key Object; EC  EC_POINT 256 bits
</span><span class='line'>  EC_POINT:   044104f8ead77d1411e016196141d9d1f747a481aec4be40d1f8822d26d407fee05902082e18843ee58db4f5575b19ff243a735b66b2c91adbec1a59aeacc7c1ae8b52
</span><span class='line'>  EC_PARAMS:  06082a8648ce3d030107
</span><span class='line'>  label:      myfirst_keypair
</span><span class='line'>  ID:         ae79417e809ed19b9a69d4c14f444462ad0bd66c
</span><span class='line'>  Usage:      none
</span><span class='line'>[staf@vicky mnt]$ pkcs15-tool -D
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>PKCS#15 Card [SmartCard-HSM]:
</span><span class='line'>        Version        : 0
</span><span class='line'>        Serial number  : DECM0102330
</span><span class='line'>        Manufacturer ID: www.CardContact.de
</span><span class='line'>        Flags          : 
</span><span class='line'>
</span><span class='line'>PIN [UserPIN]
</span><span class='line'>        Object Flags   : [0x3], private, modifiable
</span><span class='line'>        ID             : 01
</span><span class='line'>        Flags          : [0x81A], local, unblock-disabled, initialized, exchangeRefData
</span><span class='line'>        Length         : min_len:6, max_len:15, stored_len:0
</span><span class='line'>        Pad char       : 0x00
</span><span class='line'>        Reference      : 129 (0x81)
</span><span class='line'>        Type           : ascii-numeric
</span><span class='line'>        Tries left     : 3
</span><span class='line'>
</span><span class='line'>PIN [SOPIN]
</span><span class='line'>        Object Flags   : [0x1], private
</span><span class='line'>        ID             : 02
</span><span class='line'>        Flags          : [0x9E], local, change-disabled, unblock-disabled, initialized, soPin
</span><span class='line'>        Length         : min_len:16, max_len:16, stored_len:0
</span><span class='line'>        Pad char       : 0x00
</span><span class='line'>        Reference      : 136 (0x88)
</span><span class='line'>        Type           : bcd
</span><span class='line'>        Tries left     : 3
</span><span class='line'>
</span><span class='line'>Private EC Key [myfirst_keypair]
</span><span class='line'>        Object Flags   : [0x3], private, modifiable
</span><span class='line'>        Usage          : [0x10C], sign, signRecover, derive
</span><span class='line'>        Access Flags   : [0x1D], sensitive, alwaysSensitive, neverExtract, local
</span><span class='line'>        FieldLength    : 256
</span><span class='line'>        Key ref        : 1 (0x1)
</span><span class='line'>        Native         : yes
</span><span class='line'>        Path           : e82b0601040181c31f0201::
</span><span class='line'>        Auth ID        : 01
</span><span class='line'>        ID             : ae79417e809ed19b9a69d4c14f444462ad0bd66c
</span><span class='line'>        MD:guid        : {8e96ad75-4f6c-eb5e-6bb3-4a637bbcda50}
</span><span class='line'>          :cmap flags  : 0x0
</span><span class='line'>          :sign        : 0
</span><span class='line'>          :key-exchange: 0
</span><span class='line'>
</span><span class='line'>Public EC Key [myfirst_keypair]
</span><span class='line'>        Object Flags   : [0x0]
</span><span class='line'>        Usage          : [0x0]
</span><span class='line'>        Access Flags   : [0x2], extract
</span><span class='line'>        FieldLength    : 256
</span><span class='line'>        Key ref        : 0 (0x0)
</span><span class='line'>        Native         : no
</span><span class='line'>        ID             : ae79417e809ed19b9a69d4c14f444462ad0bd66c
</span><span class='line'>        DirectValue    : &lt;present&gt;
</span><span class='line'>
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<h3>Done&hellip;</h3>

<p>We have a backup to our second smartcard and an ecrypted backup of the key on the usb, umount the backup and store it to a safe location.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ mount | grep mnt
</span><span class='line'>/dev/mapper/my on /mnt type ext4 (rw,relatime,data=ordered)
</span><span class='line'>[staf@vicky ~]$ umount /mnt
</span><span class='line'>umount: /mnt: umount failed: Operation not permitted
</span><span class='line'>[staf@vicky ~]$ sudo umount /mnt
</span><span class='line'>[sudo] password for staf: 
</span><span class='line'>[staf@vicky ~]$ sudo cryptsetup luksClose my
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<p><strong><em> I might publish some smartcard-hsm usage examples in the further&hellip;. </em></strong></p>

<h3>Links</h3>

<p><a href="https://github.com/OpenSC/OpenSC/wiki/SmartCardHSM">https://github.com/OpenSC/OpenSC/wiki/SmartCardHSM</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Lookat 1.4.4rc2 Released]]></title>
    <link href="http://stafwag.github.io/blog/blog/2015/10/17/lookat-1-dot-4-4rc2-released/"/>
    <updated>2015-10-17T15:36:05+02:00</updated>
    <id>http://stafwag.github.io/blog/blog/2015/10/17/lookat-1-dot-4-4rc2-released</id>
    <content type="html"><![CDATA[<p>Lookat 1.4.4rc2 is the second release candicate of Lookat 1.4.4</p>

<h3>ChangeLog</h3>

<ul>
<li>NetBSD support</li>
</ul>


<h3>Lookat 1.4.4rc2 is available at:</h3>

<p><a href="http://www.wagemakers.be/english/programs/lookat"><a href="http://www.wagemakers.be/english/programs/lookat">http://www.wagemakers.be/english/programs/lookat</a></a>
, download it directly <a href="http://www.wagemakers.be/downloads/lookat/lookat_bekijk-1.4.4rc2.tar.gz">Download latest development release (1.4.4rc2)</a>.</p>

<p>Or at the Git repository at GNU savannah <a href="http://git.savannah.gnu.org/cgit/lookat.git/"><a href="http://git.savannah.gnu.org/cgit/lookat.git/">http://git.savannah.gnu.org/cgit/lookat.git/</a></a></p>

<p><strong><em> Have fun </em></strong></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rataplan Becomes a Watchdog]]></title>
    <link href="http://stafwag.github.io/blog/blog/2015/09/05/rataplan-becomes-a-watchdog/"/>
    <updated>2015-09-05T14:47:54+02:00</updated>
    <id>http://stafwag.github.io/blog/blog/2015/09/05/rataplan-becomes-a-watchdog</id>
    <content type="html"><![CDATA[<p><img class="left" src="http://stafwag.github.io/blog/images/watchdog_rataplan.jpg">
<a href="http://stafwag.github.io/blog/blog/2012/12/16/running-freebsd-9.0-on-asus-c60m1-i-motherboard/">My NAS</a> runs on <a href="http://www.freebsd.org">FreeBSD</a> I&rsquo;m quiet happy with it. It&rsquo;s named after the dog <a href="https://nl.wikipedia.org/wiki/Rataplan">rataplan</a> from the <a href="https://en.wikipedia.org/wiki/Lucky_Luke">Lucky Luke comic</a></p>

<p>However transferring large data files to it causes the network to hang. The realtek network interface had issues with freebsd from the <a href="http://stafwag.github.io/blog/blog/2012/12/16/running-freebsd-9.0-on-asus-c60m1-i-motherboard/">beginning</a>. On the screen and in syslog the entry &ldquo;re0: watchdog timeout&rdquo; is printed.</p>

<p>Most FreeBSD people recommends to use Intel nics, I ordered <a href="http://www.dx.com/nl/p/winyao-wy574t-intel-wg82574l-chipset-pci-e-x1-server-gigabit-network-card-adapter-green-280966">a new Intel nic at dx.com</a>. After the installation of the new NIC the network seems to be stable again.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Lookat 1.4.4rc1 Released]]></title>
    <link href="http://stafwag.github.io/blog/blog/2015/07/21/lookat-1-dot-4-4rc1-released/"/>
    <updated>2015-07-21T12:24:00+02:00</updated>
    <id>http://stafwag.github.io/blog/blog/2015/07/21/lookat-1-dot-4-4rc1-released</id>
    <content type="html"><![CDATA[<p>It is a <a href="https://en.wikipedia.org/wiki/July_21">national holiday in Belgium</a> so I have some time to code again.</p>

<p>Lookat 1.4.4rc1 is the first release candicate of Lookat 1.4.4</p>

<h3>ChangeLog</h3>

<ul>
<li>openBSD support</li>
<li>English translation issues corrected</li>
<li>autoconf updated to 2.69</li>
<li>Corrected mirror compile warnings</li>
</ul>


<h3>Lookat 1.4.4rc1 is available at:</h3>

<p><a href="http://www.wagemakers.be/english/programs/lookat"><a href="http://www.wagemakers.be/english/programs/lookat">http://www.wagemakers.be/english/programs/lookat</a></a>
, download it directly <a href="http://www.wagemakers.be/downloads/lookat/lookat_bekijk-1.4.4rc1.tar.gz">Download latest development release (1.4.4rc1)</a>.</p>

<p>Or at the Git repository at GNU savannah <a href="http://git.savannah.gnu.org/cgit/lookat.git/"><a href="http://git.savannah.gnu.org/cgit/lookat.git/">http://git.savannah.gnu.org/cgit/lookat.git/</a></a></p>

<h3>OpenBSD</h3>

<p>I forgot to mention it but Lookat has landed in <a href="http://www.openbsd.org">OpenBSD</a>
Thanks to Brian Callahan for the port!</p>

<p><strong><em> Have fun </em></strong></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Using Squid to Cache FreeBSD Packages]]></title>
    <link href="http://stafwag.github.io/blog/blog/2015/06/23/using-squid-to-cache-freebsd-packages/"/>
    <updated>2015-06-23T08:43:00+02:00</updated>
    <id>http://stafwag.github.io/blog/blog/2015/06/23/using-squid-to-cache-freebsd-packages</id>
    <content type="html"><![CDATA[<h2>PKGNG config</h2>

<p>I manage a few <a href="https://www.freebsd.org/doc/handbook/jails.html">FreeBSD jails</a> behind a <a href="http://www.squid-cache.org/">squid proxy</a>. <a href="https://wiki.freebsd.org/pkgng">pkgng</a> is configured to use the proxy:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:/root # cat /etc/pkg/FreeBSD.conf 
</span><span class='line'># $FreeBSD: releng/10.1/etc/pkg/FreeBSD.conf 263938 2014-03-30 15:29:54Z bdrewery $
</span><span class='line'>#
</span><span class='line'># To disable this repository, instead of modifying or removing this file,
</span><span class='line'># create a /usr/local/etc/pkg/repos/FreeBSD.conf file:
</span><span class='line'>#
</span><span class='line'>#   mkdir -p /usr/local/etc/pkg/repos
</span><span class='line'>#   echo "FreeBSD: { enabled: no }" &gt; /usr/local/etc/pkg/repos/FreeBSD.conf
</span><span class='line'>#
</span><span class='line'>
</span><span class='line'>pkg_env: {
</span><span class='line'>
</span><span class='line'>        http_proxy: "http://xxx.xxx.xxx.xxx:3128"
</span><span class='line'>
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>FreeBSD: {
</span><span class='line'>  url: "pkg+http://pkg.FreeBSD.org/${ABI}/latest",
</span><span class='line'>  mirror_type: "srv",
</span><span class='line'>  signature_type: "fingerprints",
</span><span class='line'>  fingerprints: "/usr/share/keys/pkg",
</span><span class='line'>  enabled: yes
</span><span class='line'>}
</span><span class='line'>root@rataplan:/root # 
</span></code></pre></td></tr></table></div></figure>


<h2>SQUID config</h2>

<h3>Recompile</h3>

<p>The squid proxy doesn&rsquo;t cache to the FreeBSD packages. The squid pkgng package  is compiled with
&ldquo;LAX_HTTP  Do not enforce strict HTTP compliance&rdquo; option disabled. which doesn&rsquo;t allow you to override the cache headers sent by the remote site.</p>

<p>In order to cache the FreeBSD packages we need to recompile squid with &ldquo;LAX_HTTPD&rdquo; enabled.</p>

<h4>Updating the ports</h4>

<h5>Physical system</h5>

<p>If you use a physical FreeBSD system as your proxy run the &ldquo;portsnap fetch&rdquo; command.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@rataplan ~]# portsnap fetch
</span><span class='line'>Looking up portsnap.FreeBSD.org mirrors... 7 mirrors found.
</span><span class='line'>Fetching snapshot tag from ec2-eu-west-1.portsnap.freebsd.org... done.
</span><span class='line'>Fetching snapshot metadata... done.
</span><span class='line'>Updating from Mon Jun 22 14:30:21 CEST 2015 to Tue Jun 23 08:39:41 CEST 2015.
</span><span class='line'>Fetching 4 metadata patches... done.
</span><span class='line'>Applying metadata patches... done.
</span><span class='line'>Fetching 0 metadata files... done.
</span><span class='line'>Fetching 417 patches. 
</span><span class='line'>(417/417) 100.00%  done.                                       
</span><span class='line'>done.
</span><span class='line'>Applying patches... 
</span><span class='line'>done.
</span><span class='line'>Fetching 3 new ports or files... done.
</span><span class='line'>[root@rataplan ~]# </span></code></pre></td></tr></table></div></figure>


<p></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@rataplan ~]# portsnap extract
</span><span class='line'>/usr/ports/.arcconfig
</span><span class='line'>/usr/ports/.gitignore
</span><span class='line'>/usr/ports/CHANGES
</span><span class='line'>/usr/ports/CONTRIBUTING.md
</span><span class='line'>/usr/ports/COPYRIGHT
</span><span class='line'>/usr/ports/GIDs
</span><span class='line'>
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>
</span><span class='line'>/usr/ports/x11/zenity/
</span><span class='line'>Building new INDEX files... done.
</span><span class='line'>[root@rataplan ~]# 
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<h5>Jail</h5>

<p>If you use an <a href="http://erdgeist.org/arts/software/ezjail/">ezjail</a> as your proxy run the &ldquo;ezjail-admin update -P&rdquo; command.</p>

<h4>Build</h4>

<h5>Stop SQUID</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/ports/www/squid # /usr/local/etc/rc.d/squid stop
</span><span class='line'>squid not running? (check /var/run/squid/squid.pid).
</span><span class='line'>root@stafproxy:/usr/ports/www/squid # </span></code></pre></td></tr></table></div></figure>


<h5>Make config</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/ports/www/squid # cd
</span><span class='line'>root@stafproxy:/root # cd /usr/ports/www/squid
</span><span class='line'>root@stafproxy:/usr/ports/www/squid # make config</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>        squid-3.5.5 
</span><span class='line'>           
</span><span class='line'>         [ ] ARP_ACL         ARP/MAC/EUI based authentification                      
</span><span class='line'>         [ ] AUTH_LDAP       Install LDAP authentication helpers                     
</span><span class='line'>         [x] AUTH_NIS        Install NIS/YP authentication helpers                   
</span><span class='line'>         [ ] AUTH_SASL       Install SASL authentication helpers                     
</span><span class='line'>         [ ] AUTH_SMB        Install SMB auth. helpers (req. Samba)                  
</span><span class='line'>         [ ] AUTH_SQL        Install SQL based auth (uses MySQL)                     
</span><span class='line'>         [ ] CACHE_DIGESTS   Use cache digests                                       
</span><span class='line'>         [ ] DEBUG           Build with extended debugging support                   
</span><span class='line'>         [ ] DELAY_POOLS     Delay pools (bandwidth limiting)                        
</span><span class='line'>         [x] DOCS            Build and/or install documentation                      
</span><span class='line'>         [ ] ECAP            Loadable content adaptation modules                     
</span><span class='line'>         [ ] ESI             ESI support                                             
</span><span class='line'>         [x] EXAMPLES        Build and/or install examples                           
</span><span class='line'>         [ ] FOLLOW_XFF      Support for the X-Following-For header                  
</span><span class='line'>         [x] FS_AUFS         AUFS (threaded-io) support                              
</span><span class='line'>         [x] FS_DISKD        DISKD storage engine controlled by separate service     
</span><span class='line'>         [ ] FS_ROCK         ROCK storage engine                                     
</span><span class='line'>         [x] HTCP            HTCP support                                            
</span><span class='line'>         [ ] ICAP            the ICAP client                                         
</span><span class='line'>         [ ] ICMP            ICMP pinging and network measurement                    
</span><span class='line'>         [x] IDENT           Ident lookups (RFC 931)                                 
</span><span class='line'>         [x] IPV6            IPv6 protocol support                                   
</span><span class='line'>         [x] KQUEUE          Kqueue(2) support                                       
</span><span class='line'>         [ ] LARGEFILE       Support large (&gt;2GB) cache and log files                
</span><span class='line'>         [x] LAX_HTTP        Do not enforce strict HTTP compliance                   
</span><span class='line'>         [ ] NETTLE          Nettle MD5 algorithm support                            
</span><span class='line'>         [x] SNMP            SNMP support                                            
</span><span class='line'>         [ ] SSL             SSL gatewaying support                                  
</span><span class='line'>         [ ] SSL_CRTD        Use ssl_crtd to handle SSL cert requests                
</span><span class='line'>         [ ] STACKTRACES     Enable automatic backtraces on fatal errors             
</span><span class='line'>         [ ] TP_IPF          Transparent proxying with IPFilter                      
</span><span class='line'>         [ ] TP_IPFW         Transparent proxying with IPFW                          
</span><span class='line'>         [ ] TP_PF           Transparent proxying with PF                            
</span><span class='line'>         [ ] VIA_DB          Forward/Via database                                    
</span><span class='line'>        v(+)82%   
</span><span class='line'>         
</span><span class='line'>                              &lt;  OK  &gt;            &lt;Cancel&gt;                             
</span><span class='line'>         
</span><span class='line'>                                                                                         
</span></code></pre></td></tr></table></div></figure>


<h5>Make install</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/ports/www/squid # make
</span><span class='line'>===&gt;  License GPLv2 accepted by the user
</span><span class='line'>===&gt;  Found saved configuration for squid-3.5.5
</span><span class='line'>===&gt;   squid-3.5.5 depends on file: /usr/local/sbin/pkg - found
</span><span class='line'>===&gt; Fetching all distfiles required by squid-3.5.5 for building
</span><span class='line'>===&gt;  Extracting for squid-3.5.5
</span><span class='line'>=&gt; SHA256 Checksum OK for squid3.5/squid-3.5.5.tar.xz.
</span><span class='line'>
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>
</span><span class='line'>Making install in test-suite
</span><span class='line'>install  -m 0644 /var/ports/basejail/usr/ports/www/squid/work/squid-3.5.5/helpers/basic_auth/DB/passwd.sql  /var/ports/basejail/usr/ports/www/squid/work/stage/usr/local/share/examples/squid
</span><span class='line'>(cd /var/ports/basejail/usr/ports/www/squid/work/squid-3.5.5 && install  -m 0644 QUICKSTART README RELEASENOTES.html doc/debug-sections.txt /var/ports/basejail/usr/ports/www/squid/work/stage/usr/local/share/doc/squid)
</span><span class='line'>/bin/mkdir -p /var/ports/basejail/usr/ports/www/squid/work/stage/var/squid/logs
</span><span class='line'>/bin/rmdir /var/ports/basejail/usr/ports/www/squid/work/stage/var/run/squid
</span><span class='line'>====&gt; Compressing man pages (compress-man)
</span><span class='line'>===&gt; Staging rc.d startup script(s)</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/ports/www/squid # make install clean
</span><span class='line'>===&gt;  Installing for squid-3.5.5                                                                                                                                                                                                             
</span><span class='line'>===&gt;   squid-3.5.5 depends on file: /usr/local/bin/perl5.20.2 - found                                                                                                                                                                        
</span><span class='line'>===&gt;  Checking if squid already installed                                                                                                                                                                                                    
</span><span class='line'>===&gt;   Registering installation for squid-3.5.5                                                                                                                                                                                              
</span><span class='line'>
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>
</span><span class='line'>===&gt; SECURITY REPORT: 
</span><span class='line'>      This port has installed the following files which may act as network
</span><span class='line'>      servers and may therefore pose a remote security risk to the system.
</span><span class='line'>/usr/local/libexec/squid/basic_radius_auth
</span><span class='line'>/usr/local/sbin/squid
</span><span class='line'>
</span><span class='line'>      This port has installed the following startup scripts which may cause
</span><span class='line'>      these network services to be started at boot time.
</span><span class='line'>/usr/local/etc/rc.d/squid
</span><span class='line'>
</span><span class='line'>      If there are vulnerabilities in these programs there may be a security
</span><span class='line'>      risk to the system. FreeBSD makes no guarantee about the security of
</span><span class='line'>      ports included in the Ports Collection. Please type 'make deinstall'
</span><span class='line'>      to deinstall the port if this is a concern.
</span><span class='line'>
</span><span class='line'>      For more information, and contact details about the security
</span><span class='line'>      status of this software, see the following webpage: 
</span><span class='line'>http://www.squid-cache.org/
</span></code></pre></td></tr></table></div></figure>


<h5>pkg lock</h5>

<p>Lock the squid package to prevent the upgrade from pkgng tree.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/ports/www/squid # pkg lock squid
</span><span class='line'>squid-3.5.5: lock this package? [y/N]: y
</span><span class='line'>Locking squid-3.5.5
</span><span class='line'>root@stafproxy:/usr/ports/www/squid #
</span></code></pre></td></tr></table></div></figure>


<p>View the locked pkgng packages</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/ports/www/squid # pkg lock -l
</span><span class='line'>Currently locked packages:
</span><span class='line'>squid-3.5.5
</span><span class='line'>root@stafproxy:/usr/ports/www/squid # </span></code></pre></td></tr></table></div></figure>


<h3>SQUID config</h3>

<h4>Update squid.conf</h4>

<p>Edit the squid config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/ports/www/squid # cd /usr/local/etc/squid/
</span><span class='line'>root@stafproxy:/usr/local/etc/squid # vi squid.conf
</span></code></pre></td></tr></table></div></figure>


<p>Add a &ldquo;refresh_pattern&rdquo; for &ldquo;pkgmir.pkg.freebsd.org&rdquo;:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>refresh_pattern ^ftp:           1440    20%     10080
</span><span class='line'>refresh_pattern ^http://pkgmir.pkg.freebsd.org/.*\.txz          1440    100%    10080 ignore-private ignore-must-revalidate override-expire ignore-no-cache
</span><span class='line'>refresh_pattern ^gopher:        1440    0%      1440
</span><span class='line'>refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
</span><span class='line'>refresh_pattern .               0       20%     4320</span></code></pre></td></tr></table></div></figure>


<h4>Start squid</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/local/etc/squid # ../rc.d/squid start
</span><span class='line'>Starting squid.
</span><span class='line'>root@stafproxy:/usr/local/etc/squid # 
</span></code></pre></td></tr></table></div></figure>


<h4>rc.conf</h4>

<p>Make sure that the system is configured to start squid during the system startup.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/local/etc/squid # cat /etc/rc.conf 
</span><span class='line'>#
</span><span class='line'># squid
</span><span class='line'>#
</span><span class='line'>
</span><span class='line'>squid_enable="YES"
</span><span class='line'>
</span><span class='line'>root@stafproxy:/usr/local/etc/squid # </span></code></pre></td></tr></table></div></figure>


<p>SQUID should cache the pkgng downloads now.</p>

<p><em>Have fun</em></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Using YubiKey Neo as Gpg Smartcard for SSH Authentication]]></title>
    <link href="http://stafwag.github.io/blog/blog/2015/06/16/using-yubikey-neo-as-gpg-smartcard-for-ssh-authentication/"/>
    <updated>2015-06-16T10:32:00+02:00</updated>
    <id>http://stafwag.github.io/blog/blog/2015/06/16/using-yubikey-neo-as-gpg-smartcard-for-ssh-authentication</id>
    <content type="html"><![CDATA[<p>I purchased a <a href="https://www.yubico.com/products/yubikey-hardware/">Yubi NEO</a> I&rsquo;ll use it to hold my  <a href="https://en.wikipedia.org/wiki/Linux_Unified_Key_Setup">Luks</a> password and for ssh authentication instead of the password authentication that I still use.</p>

<p>You&rsquo;ll find  my journey to get the smartcard interface working with ssh on a fedora 22 system below;</p>

<h2>Install the yubiclient and smartcard software</h2>

<h3>Install the ykclient</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ykclient.x86_64 : Yubikey management library and client
</span><span class='line'>[root@vicky ~]# dnf install ykclient
</span><span class='line'>Last metadata expiration check performed 1:00:07 ago on Sun Jun 14 09:14:34 2015.
</span><span class='line'>Dependencies resolved.
</span><span class='line'>====================================================================================================================
</span><span class='line'> Package                    Arch                     Version                         Repository                Size
</span><span class='line'>====================================================================================================================
</span><span class='line'>Installing:
</span><span class='line'> ykclient                   x86_64                   2.13-1.fc22                     fedora                    35 k
</span><span class='line'>
</span><span class='line'>Transaction Summary
</span><span class='line'>====================================================================================================================
</span><span class='line'>Install  1 Package
</span><span class='line'>
</span><span class='line'>Total download size: 35 k
</span><span class='line'>Installed size: 58 k
</span><span class='line'>Is this ok [y/N]: y
</span><span class='line'>Downloading Packages:
</span><span class='line'>ykclient-2.13-1.fc22.x86_64.rpm                                                      48 kB/s |  35 kB     00:00    
</span><span class='line'>--------------------------------------------------------------------------------------------------------------------
</span><span class='line'>Total                                                                                11 kB/s |  35 kB     00:03     
</span><span class='line'>Running transaction check
</span><span class='line'>Transaction check succeeded.
</span><span class='line'>Running transaction test
</span><span class='line'>Transaction test succeeded.
</span><span class='line'>Running transaction
</span><span class='line'>  Installing  : ykclient-2.13-1.fc22.x86_64                                                                     1/1 
</span><span class='line'>  Verifying   : ykclient-2.13-1.fc22.x86_64                                                                     1/1 
</span><span class='line'>
</span><span class='line'>Installed:
</span><span class='line'>  ykclient.x86_64 2.13-1.fc22                                                                                       
</span><span class='line'>
</span><span class='line'>Complete!
</span><span class='line'>[root@vicky ~]# </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@vicky ~]# ykinfo
</span><span class='line'>bash: ykinfo: command not found...
</span><span class='line'>Install package 'ykpers' to provide command 'ykinfo'? [N/y] ^C
</span><span class='line'>
</span><span class='line'>[root@vicky ~]# dnf install ykpers
</span><span class='line'>Last metadata expiration check performed 1:01:23 ago on Sun Jun 14 09:14:34 2015.
</span><span class='line'>Dependencies resolved.
</span><span class='line'>====================================================================================================================
</span><span class='line'> Package                     Arch                    Version                          Repository               Size
</span><span class='line'>====================================================================================================================
</span><span class='line'>Installing:
</span><span class='line'> libyubikey                  x86_64                  1.11-3.fc22                      fedora                   33 k
</span><span class='line'> ykpers                      x86_64                  1.17.1-1.fc22                    fedora                  101 k
</span><span class='line'>
</span><span class='line'>Transaction Summary
</span><span class='line'>====================================================================================================================
</span><span class='line'>Install  2 Packages
</span><span class='line'>
</span><span class='line'>Total download size: 135 k
</span><span class='line'>Installed size: 372 k
</span><span class='line'>Is this ok [y/N]: y
</span><span class='line'>Downloading Packages:
</span><span class='line'>(1/2): libyubikey-1.11-3.fc22.x86_64.rpm                                             13 kB/s |  33 kB     00:02    
</span><span class='line'>(2/2): ykpers-1.17.1-1.fc22.x86_64.rpm                                               38 kB/s | 101 kB     00:02    
</span><span class='line'>--------------------------------------------------------------------------------------------------------------------
</span><span class='line'>Total                                                                                22 kB/s | 135 kB     00:06     
</span><span class='line'>Running transaction check
</span><span class='line'>Transaction check succeeded.
</span><span class='line'>Running transaction test
</span><span class='line'>Transaction test succeeded.
</span><span class='line'>Running transaction
</span><span class='line'>  Installing  : libyubikey-1.11-3.fc22.x86_64                                                                   1/2 
</span><span class='line'>  Installing  : ykpers-1.17.1-1.fc22.x86_64                                                                     2/2 
</span><span class='line'>  Verifying   : ykpers-1.17.1-1.fc22.x86_64                                                                     1/2 
</span><span class='line'>  Verifying   : libyubikey-1.11-3.fc22.x86_64                                                                   2/2 
</span><span class='line'>
</span><span class='line'>Installed:
</span><span class='line'>  libyubikey.x86_64 1.11-3.fc22                             ykpers.x86_64 1.17.1-1.fc22                            
</span><span class='line'>
</span><span class='line'>Complete!
</span></code></pre></td></tr></table></div></figure>


<h3>Verify that you&rsquo;ve access to the yubikey</h3>

<p>&ldquo;ykinfo -v&rdquo; shows you the version on the yubikey.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# ykinfo -v
</span><span class='line'>version: 3.4.0
</span><span class='line'>[root@vicky ~]# 
</span></code></pre></td></tr></table></div></figure>


<p>If you try with the user that you&rsquo;ll for the yubi authentication you might get a permission denied:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@vicky ~]$ ykinfo -v
</span><span class='line'>USB error: Access denied (insufficient permissions)
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h4>Update the udev permissions</h4>

<h5>Update rule file</h5>

<p>On a fedora 22 system to udev rules for the yubi key are defined in &ldquo;/usr/lib/udev/rules.d/69-yubikey.rules&rdquo;</p>

<p>It is a good practice to only grant access to user that will use the yubikey.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# cd /usr/lib/udev/rules.d/
</span><span class='line'>[root@vicky rules.d]# vi 69-yubikey.rules </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ACTION!="add|change", GOTO="yubico_end"
</span><span class='line'>
</span><span class='line'># Udev rules for letting the console user access the Yubikey USB
</span><span class='line'># device node, needed for challenge/response to work correctly.
</span><span class='line'>
</span><span class='line'># Yubico Yubikey II
</span><span class='line'>ATTRS{idVendor}=="1050", ATTRS{idProduct}=="0010|0110|0111|0114|0116|0401|0403|0405|0407|0410", OWNER="staf", MODE="0600"
</span><span class='line'>
</span><span class='line'>LABEL="yubico_end"</span></code></pre></td></tr></table></div></figure>


<h5>Update udev rules</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># udevadm control --reload
</span><span class='line'># udevadm trigger</span></code></pre></td></tr></table></div></figure>


<h5>Test it again</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ ykinfo -v
</span><span class='line'>version: 3.4.0
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h3>Enable the smartcard interface</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@vicky yubi]$ ykpersonalize -m82
</span><span class='line'>Firmware version 3.4.0 Touch level 1551 Program sequence 3
</span><span class='line'>
</span><span class='line'>The USB mode will be set to: 0x82
</span><span class='line'>
</span><span class='line'>Commit? (y/n) [n]: y
</span><span class='line'>[staf@vicky yubi]$ 
</span></code></pre></td></tr></table></div></figure>


<p>Remove the yubi key from your system and plug it back to activate the new interface.</p>

<h3>Install the required smartcard software</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# dnf install pcsc-tools   
</span><span class='line'>Last metadata expiration check performed 0:33:58 ago on Sun Jun 14 09:14:34 2015.
</span><span class='line'>Dependencies resolved.                                       
</span><span class='line'>====================================================================================================================
</span><span class='line'> Package                         Arch                  Version                          Repository             Size
</span><span class='line'>====================================================================================================================
</span><span class='line'>Installing:                                                 
</span><span class='line'> pcsc-lite                       x86_64                1.8.13-1.fc22                    fedora                101 k
</span><span class='line'> pcsc-lite-asekey                x86_64                3.7-1.fc22                       fedora                 34 k
</span><span class='line'> pcsc-perl                       x86_64                1.4.12-11.fc22                   fedora                 61 k
</span><span class='line'> pcsc-tools                      x86_64                1.4.23-1.fc22                    fedora                116 k
</span><span class='line'> perl-Cairo                      x86_64                1.105-1.fc22                     fedora                126 k
</span><span class='line'> perl-Glib                       x86_64                1.310-1.fc22                     fedora                362 k
</span><span class='line'> perl-Gtk2                       x86_64                1.2495-1.fc22                    fedora                1.8 M
</span><span class='line'> perl-HTML-Tree                  noarch                1:5.03-8.fc22                    fedora                223 k
</span><span class='line'> perl-Pango                      x86_64                1.226-3.fc22                     fedora                220 k
</span><span class='line'>                                                           
</span><span class='line'>Transaction Summary                                        
</span><span class='line'>====================================================================================================================
</span><span class='line'>Install  9 Packages                                        
</span><span class='line'>                                                            
</span><span class='line'>Total download size: 3.0 M                                  
</span><span class='line'>Installed size: 8.4 M                                       
</span><span class='line'>Is this ok [y/N]: y                                          
</span><span class='line'>Downloading Packages:                                        
</span><span class='line'>(1/9): pcsc-tools-1.4.23-1.fc22.x86_64.rpm                                           38 kB/s | 116 kB     00:03    
</span><span class='line'>(2/9): pcsc-perl-1.4.12-11.fc22.x86_64.rpm                                           20 kB/s |  61 kB     00:03    
</span><span class='line'>(3/9): pcsc-lite-1.8.13-1.fc22.x86_64.rpm                                            23 kB/s | 101 kB     00:04    
</span><span class='line'>(4/9): perl-Glib-1.310-1.fc22.x86_64.rpm                                            159 kB/s | 362 kB     00:02    
</span><span class='line'>(5/9): perl-Cairo-1.105-1.fc22.x86_64.rpm                                            56 kB/s | 126 kB     00:02    
</span><span class='line'>(6/9): perl-HTML-Tree-5.03-8.fc22.noarch.rpm                                         99 kB/s | 223 kB     00:02    
</span><span class='line'>(7/9): perl-Gtk2-1.2495-1.fc22.x86_64.rpm                                           342 kB/s | 1.8 MB     00:05    
</span><span class='line'>(8/9): perl-Pango-1.226-3.fc22.x86_64.rpm                                            89 kB/s | 220 kB     00:02    
</span><span class='line'>(9/9): pcsc-lite-asekey-3.7-1.fc22.x86_64.rpm                                        21 kB/s |  34 kB     00:01    
</span><span class='line'>--------------------------------------------------------------------------------------------------------------------
</span><span class='line'>Total                                                                               257 kB/s | 3.0 MB     00:11     
</span><span class='line'>Running transaction check                                   
</span><span class='line'>Transaction check succeeded.                                
</span><span class='line'>Running transaction test                                     
</span><span class='line'>Transaction test succeeded.                                   
</span><span class='line'>Running transaction                                             
</span><span class='line'>  Installing  : perl-Glib-1.310-1.fc22.x86_64                                                                   1/9 
</span><span class='line'>  Installing  : pcsc-lite-asekey-3.7-1.fc22.x86_64                                                              2/9 
</span><span class='line'>  Installing  : pcsc-lite-1.8.13-1.fc22.x86_64                                                                  3/9 
</span><span class='line'>  Installing  : perl-Cairo-1.105-1.fc22.x86_64                                                                  4/9 
</span><span class='line'>  Installing  : perl-Pango-1.226-3.fc22.x86_64                                                                  5/9 
</span><span class='line'>  Installing  : perl-HTML-Tree-1:5.03-8.fc22.noarch                                                             6/9 
</span><span class='line'>  Installing  : perl-Gtk2-1.2495-1.fc22.x86_64                                                                  7/9 
</span><span class='line'>  Installing  : pcsc-perl-1.4.12-11.fc22.x86_64                                                                 8/9 
</span><span class='line'>  Installing  : pcsc-tools-1.4.23-1.fc22.x86_64                                                                 9/9 
</span><span class='line'>  Verifying   : pcsc-tools-1.4.23-1.fc22.x86_64                                                                 1/9 
</span><span class='line'>  Verifying   : pcsc-lite-1.8.13-1.fc22.x86_64                                                                  2/9 
</span><span class='line'>  Verifying   : pcsc-perl-1.4.12-11.fc22.x86_64                                                                 3/9 
</span><span class='line'>  Verifying   : perl-Glib-1.310-1.fc22.x86_64                                                                   4/9 
</span><span class='line'>  Verifying   : perl-Gtk2-1.2495-1.fc22.x86_64                                                                  5/9 
</span><span class='line'>  Verifying   : perl-Cairo-1.105-1.fc22.x86_64                                                                  6/9 
</span><span class='line'>  Verifying   : perl-HTML-Tree-1:5.03-8.fc22.noarch                                                             7/9 
</span><span class='line'>  Verifying   : perl-Pango-1.226-3.fc22.x86_64                                                                  8/9 
</span><span class='line'>  Verifying   : pcsc-lite-asekey-3.7-1.fc22.x86_64                                                              9/9 
</span><span class='line'>
</span><span class='line'>Installed:
</span><span class='line'>  pcsc-lite.x86_64 1.8.13-1.fc22       pcsc-lite-asekey.x86_64 3.7-1.fc22       pcsc-perl.x86_64 1.4.12-11.fc22     
</span><span class='line'>  pcsc-tools.x86_64 1.4.23-1.fc22      perl-Cairo.x86_64 1.105-1.fc22           perl-Glib.x86_64 1.310-1.fc22       
</span><span class='line'>  perl-Gtk2.x86_64 1.2495-1.fc22       perl-HTML-Tree.noarch 1:5.03-8.fc22      perl-Pango.x86_64 1.226-3.fc22      
</span><span class='line'>
</span><span class='line'>Complete!
</span><span class='line'>[root@vicky ~]# 
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@vicky ~]# dnf install opensc
</span><span class='line'>Last metadata expiration check performed 0:37:38 ago on Sun Jun 14 09:14:34 2015.
</span><span class='line'>Dependencies resolved.
</span><span class='line'>====================================================================================================================
</span><span class='line'> Package                  Arch                     Version                           Repository                Size
</span><span class='line'>====================================================================================================================
</span><span class='line'>Installing:
</span><span class='line'> opensc                   x86_64                   0.14.0-2.fc22                     fedora                   976 k
</span><span class='line'>
</span><span class='line'>Transaction Summary
</span><span class='line'>====================================================================================================================
</span><span class='line'>Install  1 Package
</span><span class='line'>
</span><span class='line'>Total download size: 976 k
</span><span class='line'>Installed size: 2.8 M
</span><span class='line'>Is this ok [y/N]: y
</span><span class='line'>Downloading Packages:
</span><span class='line'>opensc-0.14.0-2.fc22.x86_64.rpm                                                     277 kB/s | 976 kB     00:03    
</span><span class='line'>--------------------------------------------------------------------------------------------------------------------
</span><span class='line'>Total                                                                               203 kB/s | 976 kB     00:04     
</span><span class='line'>Running transaction check
</span><span class='line'>Transaction check succeeded.
</span><span class='line'>Running transaction test
</span><span class='line'>Transaction test succeeded.
</span><span class='line'>Running transaction
</span><span class='line'>  Installing  : opensc-0.14.0-2.fc22.x86_64                                                                     1/1 
</span><span class='line'>  Verifying   : opensc-0.14.0-2.fc22.x86_64                                                                     1/1 
</span><span class='line'>
</span><span class='line'>Installed:
</span><span class='line'>  opensc.x86_64 0.14.0-2.fc22                                                                                       
</span><span class='line'>
</span><span class='line'>Complete!
</span><span class='line'>[root@vicky ~]# dnf search opensc</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# dnf search ccid
</span><span class='line'>Last metadata expiration check performed 0:39:03 ago on Sun Jun 14 09:14:34 2015.
</span><span class='line'>================================================ N/S Matched: ccid =================================================
</span><span class='line'>pcsc-lite-ccid.x86_64 : Generic USB CCID smart card reader driver
</span><span class='line'>libykneomgr.i686 : YubiKey NEO CCID Manager C Library
</span><span class='line'>libykneomgr.x86_64 : YubiKey NEO CCID Manager C Library
</span><span class='line'>[root@vicky ~]# dnf install pcsc-lite-ccid
</span><span class='line'>Last metadata expiration check performed 0:39:34 ago on Sun Jun 14 09:14:34 2015.
</span><span class='line'>Dependencies resolved.
</span><span class='line'>====================================================================================================================
</span><span class='line'> Package                        Arch                   Version                         Repository              Size
</span><span class='line'>====================================================================================================================
</span><span class='line'>Installing:
</span><span class='line'> pcsc-lite-ccid                 x86_64                 1.4.18-1.fc22                   fedora                 177 k
</span><span class='line'>
</span><span class='line'>Transaction Summary
</span><span class='line'>====================================================================================================================
</span><span class='line'>Install  1 Package
</span><span class='line'>
</span><span class='line'>Total download size: 177 k
</span><span class='line'>Installed size: 599 k
</span><span class='line'>Is this ok [y/N]: y
</span><span class='line'>Downloading Packages:
</span><span class='line'>pcsc-lite-ccid-1.4.18-1.fc22.x86_64.rpm                                              47 kB/s | 177 kB     00:03    
</span><span class='line'>--------------------------------------------------------------------------------------------------------------------
</span><span class='line'>Total                                                                                27 kB/s | 177 kB     00:06     
</span><span class='line'>Running transaction check
</span><span class='line'>Transaction check succeeded.
</span><span class='line'>Running transaction test
</span><span class='line'>Transaction test succeeded.
</span><span class='line'>Running transaction
</span><span class='line'>  Installing  : pcsc-lite-ccid-1.4.18-1.fc22.x86_64                                                             1/1 
</span><span class='line'>  Verifying   : pcsc-lite-ccid-1.4.18-1.fc22.x86_64                                                             1/1 
</span><span class='line'>
</span><span class='line'>Installed:
</span><span class='line'>  pcsc-lite-ccid.x86_64 1.4.18-1.fc22                                                                               
</span><span class='line'>
</span><span class='line'>Complete!
</span><span class='line'>[root@vicky ~]# </span></code></pre></td></tr></table></div></figure>


<h4>Start the pcscd service</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@vicky ~]# systemctl list-unit-files -t service | grep pcscd
</span><span class='line'>pcscd.service                               static  
</span><span class='line'>[root@vicky ~]# systemctl start pcscd
</span><span class='line'>[root@vicky ~]# systemctl enable pcscd
</span><span class='line'>[root@vicky ~]# </span></code></pre></td></tr></table></div></figure>


<h4>Verify that you are able to see the yubi smartcard</h4>

<h5>Run pcsc_scan</h5>

<p>Execute &ldquo;pcsc_scan&rdquo; to verify that you see the smartcard</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ pcsc_scan 
</span><span class='line'>PC/SC device scanner
</span><span class='line'>V 1.4.23 (c) 2001-2011, Ludovic Rousseau &lt;ludovic.rousseau@free.fr&gt;
</span><span class='line'>Compiled with PC/SC lite version: 1.8.13
</span><span class='line'>Using reader plug'n play mechanism
</span><span class='line'>Scanning present readers...
</span><span class='line'>0: Gemalto Gemplus USB SmartCard Reader 433-Swap [CCID Interface] (1-0000:00:06.7-1) 00 00
</span><span class='line'>1: Yubico Yubikey NEO OTP+CCID 01 00
</span><span class='line'>
</span><span class='line'>Mon Jun 15 11:36:44 2015
</span><span class='line'>Reader 0: Gemalto Gemplus USB SmartCard Reader 433-Swap [CCID Interface] (1-0000:00:06.7-1) 00 00
</span><span class='line'>  Card state: Card removed, 
</span><span class='line'>Reader 1: Yubico Yubikey NEO OTP+CCID 01 00
</span><span class='line'>  Card state: Card inserted, 
</span><span class='line'>  ATR: 3B FC 13 00 00 81 31 FE 15 59 75 62 69 6B 65 79 4E 45 4F 72 33 E1
</span><span class='line'>
</span><span class='line'>defined(@array) is deprecated at /usr/lib64/perl5/vendor_perl/Chipcard/PCSC.pm line 69.
</span><span class='line'>        (Maybe you should just omit the defined()?)
</span><span class='line'>ATR: 3B FC 13 00 00 81 31 FE 15 59 75 62 69 6B 65 79 4E 45 4F 72 33 E1
</span><span class='line'>+ TS = 3B --&gt; Direct Convention
</span><span class='line'>+ T0 = FC, Y(1): 1111, K: 12 (historical bytes)
</span><span class='line'>  TA(1) = 13 --&gt; Fi=372, Di=4, 93 cycles/ETU
</span><span class='line'>    43010 bits/s at 4 MHz, fMax for Fi = 5 MHz =&gt; 53763 bits/s
</span><span class='line'>  TB(1) = 00 --&gt; VPP is not electrically connected
</span><span class='line'>  TC(1) = 00 --&gt; Extra guard time: 0
</span><span class='line'>  TD(1) = 81 --&gt; Y(i+1) = 1000, Protocol T = 1 
</span><span class='line'>-----
</span><span class='line'>  TD(2) = 31 --&gt; Y(i+1) = 0011, Protocol T = 1 
</span><span class='line'>-----
</span><span class='line'>  TA(3) = FE --&gt; IFSC: 254
</span><span class='line'>  TB(3) = 15 --&gt; Block Waiting Integer: 1 - Character Waiting Integer: 5
</span><span class='line'>+ Historical bytes: 59 75 62 69 6B 65 79 4E 45 4F 72 33
</span><span class='line'>  Category indicator byte: 59 (proprietary format)
</span><span class='line'>+ TCK = E1 (correct checksum)
</span><span class='line'>
</span><span class='line'>Possibly identified card (using /usr/share/pcsc/smartcard_list.txt):
</span><span class='line'>3B FC 13 00 00 81 31 FE 15 59 75 62 69 6B 65 79 4E 45 4F 72 33 E1
</span><span class='line'>        YubiKey NEO (PKI)
</span><span class='line'>        http://www.yubico.com/
</span></code></pre></td></tr></table></div></figure>


<h4>Remote smartcard access</h4>

<p>By default only console logins have access to the smartcard if you want to grant access to remote logins (e.g. ssh)
create a polkit rule for the user that will use the smartcard.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# cd /usr/share/polkit-1/rules.d/                                    
</span><span class='line'>[root@vicky rules.d]# vi 30_smartcard_access.rules </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>polkit.addRule(function(action, subject) {
</span><span class='line'>    if (action.id == "org.debian.pcsc-lite.access_pcsc" &&
</span><span class='line'>        subject.user == "staf") {
</span><span class='line'>            return polkit.Result.YES;
</span><span class='line'>    }
</span><span class='line'>});
</span><span class='line'>
</span><span class='line'>polkit.addRule(function(action, subject) {
</span><span class='line'>    if (action.id == "org.debian.pcsc-lite.access_card" &&
</span><span class='line'>        action.lookup("reader") == 'name_of_reader' &&
</span><span class='line'>        subject.user == "staf") {
</span><span class='line'>            return polkit.Result.YES;    }
</span><span class='line'>});
</span></code></pre></td></tr></table></div></figure>


<h3>Reset smartcard PIN codes</h3>

<p>The default user PIN code is &ldquo;123456&rdquo; the default admin PIN code is &ldquo;12345678&rdquo;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ gpg --change-pin 
</span><span class='line'>gpg: OpenPGP card no. D2760001240102000006035062250000 detected
</span><span class='line'>
</span><span class='line'>1 - change PIN
</span><span class='line'>2 - unblock PIN
</span><span class='line'>3 - change Admin PIN
</span><span class='line'>4 - set the Reset Code
</span><span class='line'>Q - quit
</span><span class='line'>
</span><span class='line'>#### Change user PIN
</span><span class='line'>
</span><span class='line'>Your selection? </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Your selection? 1
</span><span class='line'>
</span><span class='line'>Please enter the PIN
</span><span class='line'>           
</span><span class='line'>New PIN
</span><span class='line'>               
</span><span class='line'>New PIN
</span><span class='line'>PIN changed.     
</span></code></pre></td></tr></table></div></figure>


<h4>Change admin PIN</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> - change PIN
</span><span class='line'>2 - unblock PIN
</span><span class='line'>3 - change Admin PIN
</span><span class='line'>4 - set the Reset Code
</span><span class='line'>Q - quit
</span><span class='line'>
</span><span class='line'>Your selection? 3
</span><span class='line'>gpg: 3 Admin PIN attempts remaining before card is permanently locked
</span><span class='line'>
</span><span class='line'>Please enter the Admin PIN
</span><span class='line'>                 
</span><span class='line'>New Admin PIN
</span><span class='line'>                     
</span><span class='line'>New Admin PIN
</span><span class='line'>PIN changed.     
</span><span class='line'>
</span><span class='line'>1 - change PIN
</span><span class='line'>2 - unblock PIN
</span><span class='line'>3 - change Admin PIN
</span><span class='line'>4 - set the Reset Code
</span><span class='line'>Q - quit
</span><span class='line'>
</span><span class='line'>Your selection? 
</span></code></pre></td></tr></table></div></figure>


<h3>Generate a new key pair</h3>

<h4>Execute &ldquo;gpg &ndash;card-edit&rdquo;</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ gpg --card-edit 
</span><span class='line'>
</span><span class='line'>Application ID ...: D2760001240102000006035062250000
</span><span class='line'>Version ..........: 2.0
</span><span class='line'>Manufacturer .....: unknown
</span><span class='line'>Serial number ....: 03506225
</span><span class='line'>Name of cardholder: [not set]
</span><span class='line'>Language prefs ...: [not set]
</span><span class='line'>Sex ..............: unspecified
</span><span class='line'>URL of public key : [not set]
</span><span class='line'>Login data .......: [not set]
</span><span class='line'>Signature PIN ....: forced
</span><span class='line'>Key attributes ...: 2048R 2048R 2048R
</span><span class='line'>Max. PIN lengths .: 127 127 127
</span><span class='line'>PIN retry counter : 3 3 3
</span><span class='line'>Signature counter : 5
</span><span class='line'>Signature key ....: 1E41 4C61 B1CE F02A F431  85BF 46B9 3657 54DF 802E
</span><span class='line'>      created ....: 2015-06-15 11:47:23
</span><span class='line'>Encryption key....: BB75 75F4 404A 2681 4331  4B46 34E7 EE51 4199 C702
</span><span class='line'>      created ....: 2015-06-15 11:47:23
</span><span class='line'>Authentication key: A7F8 A844 4762 C44D 20C7  A2AF E06D 602C 069D 7EFF
</span><span class='line'>      created ....: 2015-06-15 11:47:23
</span><span class='line'>General key info..: 
</span><span class='line'>pub  2048R/54DF802E 2015-06-15 qwerty &lt;qwert@qwert&gt;
</span><span class='line'>sec&gt;  2048R/54DF802E  created: 2015-06-15  expires: never     
</span><span class='line'>                      card-no: 0006 03506225
</span><span class='line'>ssb&gt;  2048R/069D7EFF  created: 2015-06-15  expires: never     
</span><span class='line'>                      card-no: 0006 03506225
</span><span class='line'>ssb&gt;  2048R/4199C702  created: 2015-06-15  expires: never     
</span><span class='line'>                      card-no: 0006 03506225
</span><span class='line'>
</span><span class='line'>gpg/card&gt; </span></code></pre></td></tr></table></div></figure>


<h4>Enable admin commands</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gpg/card&gt; admin
</span><span class='line'>Admin commands are allowed                                                      
</span><span class='line'>                                                                                
</span><span class='line'>gpg/card&gt;                                                                        </span></code></pre></td></tr></table></div></figure>


<h4>Generate key</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gpg/card&gt; generate 
</span><span class='line'>Make off-card backup of encryption key? (Y/n) n
</span><span class='line'>
</span><span class='line'>gpg: NOTE: keys are already stored on the card!
</span><span class='line'>
</span><span class='line'>Replace existing keys? (y/N) y
</span><span class='line'>
</span><span class='line'>Please note that the factory settings of the PINs are
</span><span class='line'>   PIN = `123456'     Admin PIN = `12345678'
</span><span class='line'>You should change them using the command --change-pin
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Please enter the PIN
</span><span class='line'>Please specify how long the key should be valid.
</span><span class='line'>         0 = key does not expire
</span><span class='line'>      &lt;n&gt;  = key expires in n days
</span><span class='line'>      &lt;n&gt;w = key expires in n weeks
</span><span class='line'>      &lt;n&gt;m = key expires in n months
</span><span class='line'>      &lt;n&gt;y = key expires in n years
</span><span class='line'>Key is valid for? (0) 
</span><span class='line'>Key does not expire at all
</span><span class='line'>Is this correct? (y/N) y
</span><span class='line'>
</span><span class='line'>You need a user ID to identify your key; the software constructs the user ID
</span><span class='line'>from the Real Name, Comment and Email Address in this form:
</span><span class='line'>    "Heinrich Heine (Der Dichter) &lt;heinrichh@duesseldorf.de&gt;"
</span><span class='line'>
</span><span class='line'>Real name: staf wagemakers
</span><span class='line'>Email address: staf@wagemakers.be
</span><span class='line'>Comment: 
</span><span class='line'>You selected this USER-ID:
</span><span class='line'>    "staf wagemakers &lt;staf@wagemakers.be&gt;"
</span><span class='line'>
</span><span class='line'>Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? O
</span><span class='line'>gpg: existing key will be replaced
</span><span class='line'>gpg: 3 Admin PIN attempts remaining before card is permanently locked
</span><span class='line'>
</span><span class='line'>Please enter the Admin PIN
</span><span class='line'>gpg: please wait while key is being generated ...
</span><span class='line'>gpg: key generation completed (5 seconds)
</span><span class='line'>gpg: signatures created so far: 0
</span><span class='line'>gpg: existing key will be replaced
</span><span class='line'>gpg: please wait while key is being generated ...
</span><span class='line'>gpg: key generation completed (35 seconds)
</span><span class='line'>gpg: signatures created so far: 1
</span><span class='line'>gpg: signatures created so far: 2
</span><span class='line'>gpg: existing key will be replaced
</span><span class='line'>gpg: please wait while key is being generated ...
</span><span class='line'>gpg: key generation completed (9 seconds)
</span><span class='line'>gpg: signatures created so far: 3
</span><span class='line'>gpg: signatures created so far: 4
</span><span class='line'>gpg: key C15CE3D7 marked as ultimately trusted
</span><span class='line'>public and secret key created and signed.
</span><span class='line'>
</span><span class='line'>gpg: checking the trustdb
</span><span class='line'>gpg: 3 marginal(s) needed, 1 complete(s) needed, PGP trust model
</span><span class='line'>gpg: depth: 0  valid:   2  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 2u
</span><span class='line'>pub   2048R/C15CE3D7 2015-06-15
</span><span class='line'>      Key fingerprint = B702 663D 833B DC19 0EEF  663A 54FA 0B1E C15C E3D7
</span><span class='line'>uid                  staf wagemakers &lt;staf@wagemakers.be&gt;
</span><span class='line'>sub   2048R/D2AEBBA3 2015-06-15
</span><span class='line'>sub   2048R/6C2C699A 2015-06-15
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>gpg/card&gt; 
</span></code></pre></td></tr></table></div></figure>


<h3>Extract the public key</h3>

<h4>Execute gpg &ndash;card-status</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@vicky ~]$ gpg --card-status
</span><span class='line'>Application ID ...: D2760001240102000006035062250000
</span><span class='line'>Version ..........: 2.0
</span><span class='line'>Manufacturer .....: unknown
</span><span class='line'>Serial number ....: 03506225
</span><span class='line'>Name of cardholder: [not set]
</span><span class='line'>Language prefs ...: [not set]
</span><span class='line'>Sex ..............: unspecified
</span><span class='line'>URL of public key : [not set]
</span><span class='line'>Login data .......: [not set]
</span><span class='line'>Signature PIN ....: not forced
</span><span class='line'>Key attributes ...: 2048R 2048R 2048R
</span><span class='line'>Max. PIN lengths .: 127 127 127
</span><span class='line'>PIN retry counter : 3 3 3
</span><span class='line'>Signature counter : 5
</span><span class='line'>Signature key ....: AED7 C79B 574D 45CC 7C1B  CC35 BDDE E66F 0C2C CF82
</span><span class='line'>      created ....: 2015-06-16 06:32:02
</span><span class='line'>Encryption key....: 6650 AB0A 5F31 059F 3221  3F29 C9F3 2031 01B3 1F53
</span><span class='line'>      created ....: 2015-06-16 06:32:02
</span><span class='line'>Authentication key: A387 A45A 446E DC9C D78E  F173 7C19 5D7D A1D9 9813
</span><span class='line'>      created ....: 2015-06-16 06:32:02
</span><span class='line'>General key info..: pub  2048R/0C2CCF82 2015-06-16 staf wagemakers &lt;staf@wagemakers.be&gt;
</span><span class='line'>sec&gt;  2048R/0C2CCF82  created: 2015-06-16  expires: never     
</span><span class='line'>                      card-no: 0006 03506225
</span><span class='line'>ssb&gt;  2048R/A1D99813  created: 2015-06-16  expires: never     
</span><span class='line'>                      card-no: 0006 03506225
</span><span class='line'>ssb&gt;  2048R/01B31F53  created: 2015-06-16  expires: never     
</span><span class='line'>                      card-no: 0006 03506225
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h4>Run gpgkey2ssh on the authentication key</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ gpgkey2ssh A1D99813
</span><span class='line'>ssh-rsa qwertyqwertyqwerty COMMENT
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h3>Test ssh access</h3>

<h4>Configure the gpg agent</h4>

<p>The gpg-agent can be use as a ssh-agent</p>

<h5>Enable ssh support in your gpg-agent.conf</h5>

<p>Create your gpg-agent.conf file</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ vi .gnupg/gpg-agent.conf</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pinentry-program  /usr/bin/pinentry
</span><span class='line'>enable-ssh-support</span></code></pre></td></tr></table></div></figure>


<h4>Start the gpg-agent</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@vicky ~]$ gpg-agent --daemon --verbose
</span><span class='line'>gpg-agent[1395]: listening on socket '/home/staf/.gnupg/S.gpg-agent'
</span><span class='line'>gpg-agent[1395]: listening on socket '/home/staf/.gnupg/S.gpg-agent.ssh'
</span><span class='line'>gpg-agent[1396]: gpg-agent (GnuPG) 2.1.4 started
</span><span class='line'>SSH_AUTH_SOCK=/home/staf/.gnupg/S.gpg-agent.ssh; export SSH_AUTH_SOCK;
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h4>Export the SSH_AUTH_SOCK variable</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>SSH_AUTH_SOCK=/home/staf/.gnupg/S.gpg-agent.ssh; export SSH_AUTH_SOCK;
</span></code></pre></td></tr></table></div></figure>


<h4>Verify the agent</h4>

<p>Run ssh-add -L</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ ssh-add -L
</span><span class='line'>error fetching identities for protocol 1: agent refused operation
</span><span class='line'>ssh-rsa qwertyqwertyqwerty cardno:xxxx</span></code></pre></td></tr></table></div></figure>


<p>The public key must be the same as extracted with &ldquo;gpgkey2ssh&rdquo;</p>

<h4>Add the public key to the remote system</h4>

<p>Add this public key to ~/.ssh/authorized_keys on the remote system.</p>

<h4>Test</h4>

<p>Try to logon to your remote system</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@vicky ~]$ ssh -v xxx.xxx.xxx.xxx</span></code></pre></td></tr></table></div></figure>


<p>You should get a window that asks for user PIN code.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>               
</span><span class='line'>                Please enter the PIN                         
</span><span class='line'>                                                             
</span><span class='line'>                PIN ________________________________________ 
</span><span class='line'>                                                             
</span><span class='line'>                     &lt;OK&gt;                        &lt;Cancel&gt;    
</span><span class='line'>               
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>FreeBSD 10.1-RELEASE-p10 (GENERIC) #0: Wed May 13 06:54:13 UTC 2015
</span><span class='line'>
</span><span class='line'>Welcome to FreeBSD!
</span><span class='line'>
</span><span class='line'>Release Notes, Errata: https://www.FreeBSD.org/releases/
</span><span class='line'>Security Advisories:   https://www.FreeBSD.org/security/
</span><span class='line'>FreeBSD Handbook:      https://www.FreeBSD.org/handbook/
</span><span class='line'>FreeBSD FAQ:           https://www.FreeBSD.org/faq/
</span><span class='line'>Questions List: https://lists.FreeBSD.org/mailman/listinfo/freebsd-questions/
</span><span class='line'>FreeBSD Forums:        https://forums.FreeBSD.org/
</span><span class='line'>
</span><span class='line'>Documents installed with the system are in the /usr/local/share/doc/freebsd/
</span><span class='line'>directory, or can be installed later with:  pkg install en-freebsd-doc
</span><span class='line'>For other languages, replace "en" with a language code like de or fr.
</span><span class='line'>
</span><span class='line'>Show the version of FreeBSD installed:  freebsd-version ; uname -a
</span><span class='line'>Please include that output and any error messages when posting questions.
</span><span class='line'>Introduction to manual pages:  man man
</span><span class='line'>FreeBSD directory layout:      man hier
</span><span class='line'>
</span><span class='line'>Edit /etc/motd to change this login announcement.
</span><span class='line'>Want to run the same command again?
</span><span class='line'>In tcsh you can type "!!"
</span><span class='line'>$ 
</span></code></pre></td></tr></table></div></figure>


<h2>CleanUp</h2>

<h3>Start the gpg-daemon</h3>

<p>Add</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gpg-agent --daemon
</span><span class='line'>SSH_AUTH_SOCK=/home/staf/.gnupg/S.gpg-agent.ssh; export SSH_AUTH_SOCK;</span></code></pre></td></tr></table></div></figure>


<p>To your .bash_profile or setup a generic script for all users in /etc/profile.d/</p>

<h3>Disable password login in the /etc/ssh/sshd_config</h3>

<p><em>Have fun!</em></p>

<h2>Links</h2>

<ul>
<li><a href="https://www.yubico.com/2012/12/yubikey-neo-openpgp/"><a href="https://www.yubico.com/2012/12/yubikey-neo-openpgp/">https://www.yubico.com/2012/12/yubikey-neo-openpgp/</a></a></li>
<li><a href="https://blog.habets.se/2013/02/GPG-and-SSH-with-Yubikey-NEO"><a href="https://blog.habets.se/2013/02/GPG-and-SSH-with-Yubikey-NEO">https://blog.habets.se/2013/02/GPG-and-SSH-with-Yubikey-NEO</a></a></li>
<li><a href="http://25thandclement.com/~william/YubiKey_NEO.html"><a href="http://25thandclement.com/~william/YubiKey_NEO.html">http://25thandclement.com/~william/YubiKey_NEO.html</a></a></li>
<li><a href="http://forum.yubico.com/viewtopic.php?f=26&t=1171"><a href="http://forum.yubico.com/viewtopic.php?f=26&amp;t=1171">http://forum.yubico.com/viewtopic.php?f=26&amp;t=1171</a></a></li>
<li><a href="https://developers.yubico.com/yubikey-personalization/Releases/"><a href="https://developers.yubico.com/yubikey-personalization/Releases/">https://developers.yubico.com/yubikey-personalization/Releases/</a></a></li>
<li><a href="http://www.incenp.org/notes/2014/gnupg-for-ssh-authentication.html"><a href="http://www.incenp.org/notes/2014/gnupg-for-ssh-authentication.html">http://www.incenp.org/notes/2014/gnupg-for-ssh-authentication.html</a></a></li>
<li><a href="http://www.programmierecke.net/howto/gpg-ssh.html"><a href="http://www.programmierecke.net/howto/gpg-ssh.html">http://www.programmierecke.net/howto/gpg-ssh.html</a></a></li>
<li><a href="http://www.bradfordembedded.com/2013/12/yubikey-smartcard/"><a href="http://www.bradfordembedded.com/2013/12/yubikey-smartcard/">http://www.bradfordembedded.com/2013/12/yubikey-smartcard/</a></a></li>
<li><a href="http://www.incenp.org/notes/2014/gnupg-for-ssh-authentication.html"><a href="http://www.incenp.org/notes/2014/gnupg-for-ssh-authentication.html">http://www.incenp.org/notes/2014/gnupg-for-ssh-authentication.html</a></a></li>
<li><a href="https://github.com/herlo/ssh-gpg-smartcard-config/blob/master/YubiKey_NEO.rst"><a href="https://github.com/herlo/ssh-gpg-smartcard-config/blob/master/YubiKey_NEO.rst">https://github.com/herlo/ssh-gpg-smartcard-config/blob/master/YubiKey_NEO.rst</a></a></li>
<li><a href="https://www.esev.com/blog/post/2015-01-pgp-ssh-key-on-yubikey-neo/"><a href="https://www.esev.com/blog/post/2015-01-pgp-ssh-key-on-yubikey-neo/">https://www.esev.com/blog/post/2015-01-pgp-ssh-key-on-yubikey-neo/</a></a></li>
<li><a href="https://wiki.archlinux.org/index.php/Common_Access_Card"><a href="https://wiki.archlinux.org/index.php/Common_Access_Card">https://wiki.archlinux.org/index.php/Common_Access_Card</a></a></li>
<li><a href="https://wiki.archlinux.org/index.php/Udev"><a href="https://wiki.archlinux.org/index.php/Udev">https://wiki.archlinux.org/index.php/Udev</a></a></li>
<li><a href="https://securityblog.redhat.com/2014/07/30/controlling-access-to-smart-cards/"><a href="https://securityblog.redhat.com/2014/07/30/controlling-access-to-smart-cards/">https://securityblog.redhat.com/2014/07/30/controlling-access-to-smart-cards/</a></a></li>
</ul>

]]></content>
  </entry>
  
</feed>
