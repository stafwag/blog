
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>stafwag Blog</title>
  <meta name="author" content="staf wagemakers">

  
  <meta name="description" content="Protecting Your SSH Keys With SmartCard-HSM Dec 5th, 2015 9:37 am I use a yubi key for my ssh authentication. But I&rsquo;ve other ssh keys for my &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="https://stafwag.github.io/blog/posts/4/">
  <link href="/blog/favicon.png" rel="icon">
  <link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/blog/atom.xml" rel="alternate" title="stafwag Blog" type="application/atom+xml">
  <script src="/blog/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/blog/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37258385-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/blog/">stafwag Blog</a></h1>
  
    <h2>staf wagemakers blog</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/blog/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="stafwag.github.io/blog">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/">Blog</a></li>
  <li><a href="/blog/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2015/12/05/protecting-your-ssh-keys-with-smartcard-hsm/">Protecting Your SSH Keys With SmartCard-HSM</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-12-05T09:37:41+01:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:37 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I <a href="http://stafwag.github.io/blog/blog/2015/06/16/using-yubikey-neo-as-gpg-smartcard-for-ssh-authentication/">use</a> a  <a href="https://www.yubico.com/products/yubikey-hardware/yubikey-neo/">yubi key</a> for my ssh authentication. But I&rsquo;ve other ssh keys for my remote services so wanted something that allows me to take a backup of my keys see <a href="http://stafwag.github.io/blog/blog/2015/11/21/starting-to-protect-my-private-keys-with-smartcard-hsm/">this post</a> for more information on to backup/restore a <a href="http://www.smartcard-hsm.com">SmartCard-HSM</a></p>

<h2>Create your first ssh keypair</h2>

<h3>Verify your smartcard connection</h3>

<p>Insert you smartcard and verify the connection, see <a href="http://stafwag.github.io/blog/blog/2015/11/21/starting-to-protect-my-private-keys-with-smartcard-hsm/">my previous post</a> if  you need more information about the smartcard initialization</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ pkcs11-tool -L
</span><span class='line'>Available slots:
</span><span class='line'>Slot 0 (0xffffffffffffffff): Virtual hotplug slot
</span><span class='line'>  (empty)
</span><span class='line'>Slot 1 (0x1): Generic Smart Card Reader Interface [Smart Card Reader Interface
</span><span class='line'>  token label        : SmartCard-HSM (UserPIN)
</span><span class='line'>  token manufacturer : www.CardContact.de
</span><span class='line'>  token model        : PKCS#15 emulated
</span><span class='line'>  token flags        : rng, login required, PIN initialized, token initialized
</span><span class='line'>  hardware version   : 24.13
</span><span class='line'>  firmware version   : 1.2
</span><span class='line'>  serial num         : DECM0102331
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h3>Create your keypair</h3>

<p>Create your ssh key pair and give the a meaningful label</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ pkcs11-tool --slot 1 --keypairgen --key-type rsa:2048 --label my_ssh_key --login
</span><span class='line'>Logging in to "SmartCard-HSM (UserPIN)".
</span><span class='line'>Please enter User PIN: 
</span><span class='line'>Key pair generated:
</span><span class='line'>Private Key Object; RSA 
</span><span class='line'>  label:      my_ssh_key
</span><span class='line'>  ID:         fca6240eeef8d3156f0c4dfc591b2d938d6104cb
</span><span class='line'>  Usage:      decrypt, sign, unwrap
</span><span class='line'>Public Key Object; RSA 2048 bits
</span><span class='line'>  label:      my_ssh_key
</span><span class='line'>  ID:         fca6240eeef8d3156f0c4dfc591b2d938d6104cb
</span><span class='line'>  Usage:      encrypt, verify, wrap
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h3>Extract your public key</h3>

<p>We used <a href="https://en.wikipedia.org/wiki/PKCS_11">PKCS11</a> to generate the keypair, <a href="https://en.wikipedia.org/wiki/PKCS">PKCS15</a> is designed identify users to applications.</p>

<h4>Dump the token content</h4>

<p>Dump the token content to get the id of your ssh keypair.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ pkcs15-tool -D
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>PKCS#15 Card [SmartCard-HSM]:
</span><span class='line'>        Version        : 0
</span><span class='line'>        Serial number  : DECM0102331
</span><span class='line'>        Manufacturer ID: www.CardContact.de
</span><span class='line'>        Flags          : 
</span><span class='line'>
</span><span class='line'>PIN [UserPIN]
</span><span class='line'>        Object Flags   : [0x3], private, modifiable
</span><span class='line'>        ID             : 01
</span><span class='line'>        Flags          : [0x81A], local, unblock-disabled, initialized, exchangeRefData
</span><span class='line'>        Length         : min_len:6, max_len:15, stored_len:0
</span><span class='line'>        Pad char       : 0x00
</span><span class='line'>        Reference      : 129 (0x81)
</span><span class='line'>        Type           : ascii-numeric
</span><span class='line'>        Tries left     : 3
</span><span class='line'>
</span><span class='line'>PIN [SOPIN]
</span><span class='line'>        Object Flags   : [0x1], private
</span><span class='line'>        ID             : 02
</span><span class='line'>        Flags          : [0x9E], local, change-disabled, unblock-disabled, initialized, soPin
</span><span class='line'>        Length         : min_len:16, max_len:16, stored_len:0
</span><span class='line'>        Pad char       : 0x00
</span><span class='line'>        Reference      : 136 (0x88)
</span><span class='line'>        Type           : bcd
</span><span class='line'>        Tries left     : 3
</span><span class='line'>
</span><span class='line'>Private EC Key [myfirst_keypair]
</span><span class='line'>        Object Flags   : [0x3], private, modifiable
</span><span class='line'>        Usage          : [0x10C], sign, signRecover, derive
</span><span class='line'>        Access Flags   : [0x1D], sensitive, alwaysSensitive, neverExtract, local
</span><span class='line'>        FieldLength    : 256
</span><span class='line'>        Key ref        : 1 (0x1)
</span><span class='line'>        Native         : yes
</span><span class='line'>        Path           : e82b0601040181c31f0201::
</span><span class='line'>        Auth ID        : 01
</span><span class='line'>        ID             : ae79417e809ed19b9a69d4c14f444462ad0bd66c
</span><span class='line'>        MD:guid        : {efac9b29-2289-658c-98d1-af5af965d484}
</span><span class='line'>          :cmap flags  : 0x0
</span><span class='line'>          :sign        : 0
</span><span class='line'>          :key-exchange: 0
</span><span class='line'>
</span><span class='line'>Private RSA Key [my_ssh_key]
</span><span class='line'>        Object Flags   : [0x3], private, modifiable
</span><span class='line'>        Usage          : [0x2E], decrypt, sign, signRecover, unwrap
</span><span class='line'>        Access Flags   : [0x1D], sensitive, alwaysSensitive, neverExtract, local
</span><span class='line'>        ModLength      : 2048
</span><span class='line'>        Key ref        : 2 (0x2)
</span><span class='line'>        Native         : yes
</span><span class='line'>        Path           : e82b0601040181c31f0201::
</span><span class='line'>        Auth ID        : 01
</span><span class='line'>        ID             : fca6240eeef8d3156f0c4dfc591b2d938d6104cb
</span><span class='line'>        MD:guid        : {a272b2ad-ff6f-606c-801a-4153be498018}
</span><span class='line'>          :cmap flags  : 0x0
</span><span class='line'>          :sign        : 0
</span><span class='line'>          :key-exchange: 0
</span><span class='line'>
</span><span class='line'>Public EC Key [myfirst_keypair]
</span><span class='line'>        Object Flags   : [0x0]
</span><span class='line'>        Usage          : [0x0]
</span><span class='line'>        Access Flags   : [0x2], extract
</span><span class='line'>        FieldLength    : 256
</span><span class='line'>        Key ref        : 0 (0x0)
</span><span class='line'>        Native         : no
</span><span class='line'>        ID             : ae79417e809ed19b9a69d4c14f444462ad0bd66c
</span><span class='line'>        DirectValue    : &lt;present&gt;
</span><span class='line'>
</span><span class='line'>Public RSA Key [my_ssh_key]
</span><span class='line'>        Object Flags   : [0x0]
</span><span class='line'>        Usage          : [0x0]
</span><span class='line'>        Access Flags   : [0x2], extract
</span><span class='line'>        ModLength      : 2048
</span><span class='line'>        Key ref        : 0 (0x0)
</span><span class='line'>        Native         : no
</span><span class='line'>        ID             : fca6240eeef8d3156f0c4dfc591b2d938d6104cb
</span><span class='line'>        DirectValue    : &lt;present&gt;
</span><span class='line'>
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h4>Get the public key</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ pkcs15-tool --read-ssh-key fca6240eeef8d3156f0c4dfc591b2d938d6104cb
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCWShfPjqh+pU8lCoIhXIXh+cGpSem1iNFH6TuluQQLPiqPIeObCTfqC8q9TjR/2FYzG+3ECdiRr0fiywE9OnzUgJI5oOjXfMwY3xE1PbYBrSvYERofhkEv2ejlyRifN3sbLGSU0V7pX+BNOuiJCquCehPMV9+ehkjbk9hPRFUzL1GywsOkmWUoIzrdjH0dlhPX3TUCdoizWAIdUqg+RX4DCEc52RvaGdX4Tn2THxeffXqFJ/gKkParZSLmOND1iRhtJeJ8CmgAqfD8ReshbcSs231h/QvUl3JaThcrLbPrSQFzVUH+rN+pGlSl722NWyPNPWlwwE+SreTLbQRoWayN my_ssh_key
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h3>Configure the remote host</h3>

<p>Add the key to the remote host</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@vicky .ssh]$ vi authorized_keys 
</span><span class='line'>[staf@vicky .ssh]$ 
</span></code></pre></td></tr></table></div></figure>


<h3>Test the connection</h3>

<p>Test you ssh connection with the PKCS11 interface:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ ssh localhost
</span><span class='line'>Permission denied (publickey,gssapi-keyex,gssapi-with-mic).</span></code></pre></td></tr></table></div></figure>


<p>With the PKCS11 interface enabled:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ ssh -o "PKCS11Provider opensc-pkcs11.so" localhost
</span><span class='line'>C_GetAttributeValue failed: 18
</span><span class='line'>Enter PIN for 'SmartCard-HSM (UserPIN)': 
</span><span class='line'>Last login: Thu Dec  3 09:55:23 2015 from ::1
</span><span class='line'>gpg-agent[17327]: enabled debug flags: command cache ipc
</span><span class='line'>gpg-agent: a gpg-agent is already running - not starting a new one
</span><span class='line'>gpg-agent: secmem usage: 0/32768 bytes in 0 blocks
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h3>Update your ssh_config</h3>

<p>Add PKCS11Provider opensc-pkcs11.so to your ~/.ssh/config or your global ssh_config</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@vicky ~]$ cd .ssh/
</span><span class='line'>[staf@vicky .ssh]$ vim config
</span><span class='line'>PKCS11Provider opensc-pkcs11.so
</span><span class='line'>[staf@vicky .ssh]$ </span></code></pre></td></tr></table></div></figure>


<p></p>

<p><strong><em> Have fun &hellip; </em></strong></p>
</div>
  
  

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog_actrikel -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4659298941528586"
     data-ad-slot="7394058542"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2015/11/21/starting-to-protect-my-private-keys-with-smartcard-hsm/">Starting to Protect My Private Keys With SmartCard-Hsm</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-11-21T10:32:06+01:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2015</span></span> <span class='time'>10:32 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I still have too many private keys on a local filesystem, I started to use the <a href="https://www.yubico.com/products/yubikey-hardware/yubikey-neo/">yubikey neo</a> for <a href="http://stafwag.github.io/blog/blog/2015/06/16/using-yubikey-neo-as-gpg-smartcard-for-ssh-authentication/">my ssh authentication</a>. Mainly because the nice formfactor of the yubikey.</p>

<p>For my other private keys/data I was looking for something cheeper since I need to have a backup of my secured data so I bought a few <a href="http://www.smartcard-hsm.com">Smartcard-HSM smartcards</a> they cost 16 &euro; each while a yubi-key neo cost 54 &euro; at amazon.de</p>

<h2>Preparing Backup and Restore</h2>

<p>The Smartcard-HSM has a backup/restore functionality this needs to be enabled before any keys are generated on the HSM.</p>

<p>To store our Device Key Encryption Key (DKEK) securely we need a safe place, we&rsquo;ll use an ecrypted usb stick.</p>

<p>It'is possible to configure multiple DKEK shares e.g. you will need multiple keys to perform a backup restore you might want to store these DKEK shares over multiple (encrypted) USB sticks/people.</p>

<p>If you want to create a backup of your DKEK shares we need to store at least two encrypted USB sticks.</p>

<p>For the convenience we&rsquo;ll store all DKEK shares on 1 encrypted USB stick in the example below you should executed it on an secured computer.</p>

<h3>Install opensc</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@vicky ~]$ sudo dnf install opensc
</span><span class='line'>Last metadata expiration check performed 0:23:14 ago on Wed Nov 11 14:47:21 2015.
</span><span class='line'>Package opensc-0.15.0-2.fc23.x86_64 is already installed, skipping.
</span><span class='line'>Dependencies resolved.
</span><span class='line'>Nothing to do.
</span><span class='line'>Complete!
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h3>Create an encrypted USB key stick</h3>

<h4>Write random data to the USB stick</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ sudo dd if=/dev/urandom of=/dev/sdn bs=1024
</span><span class='line'>[sudo] password for staf:                                                                                      
</span><span class='line'>dd: error writing ‘/dev/sdn’: No space left on device                                                          
</span><span class='line'>4029441+0 records in                                                                                           
</span><span class='line'>4029440+0 records out                                                                                          
</span><span class='line'>4126146560 bytes (4.1 GB) copied, 1280.14 s, 3.2 MB/s                                                          
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h4>luksFormat</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ sudo cryptsetup luksFormat --cipher serpent-cbc-essiv:sha256 --key-size 256 /dev/sdn
</span><span class='line'>
</span><span class='line'>WARNING!
</span><span class='line'>========
</span><span class='line'>This will overwrite data on /dev/sdn irrevocably.
</span><span class='line'>
</span><span class='line'>Are you sure? (Type uppercase yes): YES
</span><span class='line'>Enter passphrase: 
</span><span class='line'>Verify passphrase: 
</span><span class='line'>[staf@vicky ~]$ sudo cry
</span><span class='line'>cryptoflex-tool  cryptsetup       crywrap          
</span><span class='line'>[staf@vicky ~]$ sudo cryptsetup luksOpen /dev/sdn myprivatedata
</span><span class='line'>Enter passphrase for /dev/sdn: 
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h4>luksOpen</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ sudo cryptsetup luksOpen /dev/sdn myprivatedata
</span><span class='line'>Enter passphrase for /dev/sdn: 
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h4>mkfs</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ sudo mkfs.ext4 /dev/mapper/myprivatedata
</span><span class='line'>mke2fs 1.42.13 (17-May-2015)
</span><span class='line'>Creating filesystem with 1007360 4k blocks and 251968 inodes
</span><span class='line'>Filesystem UUID: 49390936-49e3-4606-abf2-567c3f5b50e1
</span><span class='line'>Superblock backups stored on blocks: 
</span><span class='line'>        32768, 98304, 163840, 229376, 294912, 819200, 884736
</span><span class='line'>
</span><span class='line'>Allocating group tables: done                            
</span><span class='line'>Writing inode tables: done                            
</span><span class='line'>Creating journal (16384 blocks): done
</span><span class='line'>Writing superblocks and filesystem accounting information: done 
</span><span class='line'>
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h3>Verify the encrypted USB stick</h3>

<p>To verify that the USB stick is encrypted and we can&rsquo;t mount without typing our passphrase we&rsquo;ll close the luks device and mount it.</p>

<h4>luksClose</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ sudo cryptsetup luksClose myprivatedata
</span><span class='line'>[sudo] password for staf: 
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h4>Try to mount it without luksOpen</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ sudo mount /dev/sdn /mnt
</span><span class='line'>mount: unknown filesystem type 'crypto_LUKS'
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h4>Mount it with luksOpen / mount</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ sudo cryptsetup luksOpen /dev/sdn myhsm_dkek
</span><span class='line'>Enter passphrase for /dev/sdn: 
</span><span class='line'>[staf@vicky ~]$ sudo mount /dev/mapper/myhsm_dkek /mnt
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h4>update the ownership</h4>

<p>Update the usb stick ownership</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ sudo chown staf:staf .
</span><span class='line'>[sudo] password for staf: 
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<h2>SmartCard initialization</h2>

<h3>pcsc_scan</h3>

<h4>start the pcscd service</h4>

<p>Start/enable the pcscd service if didn&rsquo;t enable it before</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@vicky ~]# systemctl list-unit-files -t service | grep pcscd
</span><span class='line'>pcscd.service                               static  
</span><span class='line'>[root@vicky ~]# systemctl start pcscd
</span><span class='line'>[root@vicky ~]# systemctl enable pcscd
</span><span class='line'>[root@vicky ~]# </span></code></pre></td></tr></table></div></figure>


<h4>run pcsc_scan</h4>

<p>Insert the smartcard into the read, run pcsc_scan to verify that you see the smartcard</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ pcsc_scan                    
</span><span class='line'>PC/SC device scanner
</span><span class='line'>V 1.4.23 (c) 2001-2011, Ludovic Rousseau &lt;ludovic.rousseau@free.fr&gt;
</span><span class='line'>Compiled with PC/SC lite version: 1.8.13
</span><span class='line'>Using reader plug'n play mechanism
</span><span class='line'>Scanning present readers...
</span><span class='line'>0: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>
</span><span class='line'>Wed Nov 11 10:58:59 2015
</span><span class='line'>Reader 0: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>  Card state: Card inserted, 
</span><span class='line'>  ATR: 3B FE 18 00 00 81 31 FE 45 80 31 81 54 48 53 4D 31 73 80 21 40 81 07 FA
</span><span class='line'>
</span><span class='line'>ATR: 3B FE 18 00 00 81 31 FE 45 80 31 81 54 48 53 4D 31 73 80 21 40 81 07 FA
</span><span class='line'>+ TS = 3B --&gt; Direct Convention
</span><span class='line'>+ T0 = FE, Y(1): 1111, K: 14 (historical bytes)
</span><span class='line'>  TA(1) = 18 --&gt; Fi=372, Di=12, 31 cycles/ETU
</span><span class='line'>    129032 bits/s at 4 MHz, fMax for Fi = 5 MHz =&gt; 161290 bits/s                                                     
</span><span class='line'>  TB(1) = 00 --&gt; VPP is not electrically connected
</span><span class='line'>  TC(1) = 00 --&gt; Extra guard time: 0
</span><span class='line'>  TD(1) = 81 --&gt; Y(i+1) = 1000, Protocol T = 1 
</span><span class='line'>-----
</span><span class='line'>  TD(2) = 31 --&gt; Y(i+1) = 0011, Protocol T = 1 
</span><span class='line'>-----
</span><span class='line'>  TA(3) = FE --&gt; IFSC: 254
</span><span class='line'>  TB(3) = 45 --&gt; Block Waiting Integer: 4 - Character Waiting Integer: 5
</span><span class='line'>+ Historical bytes: 80 31 81 54 48 53 4D 31 73 80 21 40 81 07
</span><span class='line'>  Category indicator byte: 80 (compact TLV data object)
</span><span class='line'>    Tag: 3, len: 1 (card service data byte)
</span><span class='line'>      Card service data byte: 81
</span><span class='line'>        - Application selection: by full DF name
</span><span class='line'>        - EF.DIR and EF.ATR access services: by GET RECORD(s) command
</span><span class='line'>        - Card without MF
</span><span class='line'>    Tag: 5, len: 4 (card issuer's data)
</span><span class='line'>      Card issuer data: 48 53 4D 31
</span><span class='line'>    Tag: 7, len: 3 (card capabilities)
</span><span class='line'>      Selection methods: 80
</span><span class='line'>        - DF selection by full DF name
</span><span class='line'>      Data coding byte: 21
</span><span class='line'>        - Behaviour of write functions: proprietary
</span><span class='line'>        - Value 'FF' for the first byte of BER-TLV tag fields: invalid
</span><span class='line'>        - Data unit in quartets: 2
</span><span class='line'>      Command chaining, length fields and logical channels: 40
</span><span class='line'>        - Extended Lc and Le fields
</span><span class='line'>        - Logical channel number assignment: No logical channel
</span><span class='line'>        - Maximum number of logical channels: 1
</span><span class='line'>    Tag: 8, len: 1 (status indicator)
</span><span class='line'>      LCS (life card cycle): 07
</span><span class='line'>+ TCK = FA (correct checksum)
</span><span class='line'>
</span><span class='line'>Possibly identified card (using /usr/share/pcsc/smartcard_list.txt):
</span><span class='line'>3B FE 18 00 00 81 31 FE 45 80 31 81 54 48 53 4D 31 73 80 21 40 81 07 FA
</span><span class='line'>        Smartcard-HSM
</span><span class='line'>        http://www.cardcontact.de/products/sc-hsm.html
</span></code></pre></td></tr></table></div></figure>


<h3>Initialize the first smartcard</h3>

<h4>Create two DKEK shares</h4>

<ul>
<li>1st share;</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --create-dkek-share dkek-share-1.pbe
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>
</span><span class='line'>The DKEK share will be enciphered using a key derived from a user supplied password.
</span><span class='line'>The security of the DKEK share relies on a well chosen and sufficiently long password.
</span><span class='line'>The recommended length is more than 10 characters, which are mixed letters, numbers and
</span><span class='line'>symbols.
</span><span class='line'>
</span><span class='line'>Please keep the generated DKEK share file in a safe location. We also recommend to keep a
</span><span class='line'>paper printout, in case the electronic version becomes unavailable. A printable version
</span><span class='line'>of the file can be generated using "openssl base64 -in &lt;filename&gt;".
</span><span class='line'>Enter password to encrypt DKEK share : 
</span><span class='line'>
</span><span class='line'>Please retype password to confirm : 
</span><span class='line'>
</span><span class='line'>Passwords do not match. Please retry.
</span><span class='line'>Enter password to encrypt DKEK share : 
</span><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --create-dkek-share dkek-share-1.pbe
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>
</span><span class='line'>The DKEK share will be enciphered using a key derived from a user supplied password.
</span><span class='line'>The security of the DKEK share relies on a well chosen and sufficiently long password.
</span><span class='line'>The recommended length is more than 10 characters, which are mixed letters, numbers and
</span><span class='line'>symbols.
</span><span class='line'>
</span><span class='line'>Please keep the generated DKEK share file in a safe location. We also recommend to keep a
</span><span class='line'>paper printout, in case the electronic version becomes unavailable. A printable version
</span><span class='line'>of the file can be generated using "openssl base64 -in &lt;filename&gt;".
</span><span class='line'>Enter password to encrypt DKEK share : 
</span><span class='line'>
</span><span class='line'>Please retype password to confirm : 
</span><span class='line'>
</span><span class='line'>Enciphering DKEK share, please wait...
</span><span class='line'>DKEK share created and saved to dkek-share-1.pbe
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<ul>
<li>2nd share;</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --create-dkek-share dkek-share-2.pbe
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>
</span><span class='line'>The DKEK share will be enciphered using a key derived from a user supplied password.
</span><span class='line'>The security of the DKEK share relies on a well chosen and sufficiently long password.
</span><span class='line'>The recommended length is more than 10 characters, which are mixed letters, numbers and
</span><span class='line'>symbols.
</span><span class='line'>
</span><span class='line'>Please keep the generated DKEK share file in a safe location. We also recommend to keep a
</span><span class='line'>paper printout, in case the electronic version becomes unavailable. A printable version
</span><span class='line'>of the file can be generated using "openssl base64 -in &lt;filename&gt;".
</span><span class='line'>Enter password to encrypt DKEK share : 
</span><span class='line'>
</span><span class='line'>Please retype password to confirm : 
</span><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --create-dkek-share dkek-share-2.pbe
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>
</span><span class='line'>The DKEK share will be enciphered using a key derived from a user supplied password.
</span><span class='line'>The security of the DKEK share relies on a well chosen and sufficiently long password.
</span><span class='line'>The recommended length is more than 10 characters, which are mixed letters, numbers and
</span><span class='line'>symbols.
</span><span class='line'>
</span><span class='line'>Please keep the generated DKEK share file in a safe location. We also recommend to keep a
</span><span class='line'>paper printout, in case the electronic version becomes unavailable. A printable version
</span><span class='line'>of the file can be generated using "openssl base64 -in &lt;filename&gt;".
</span><span class='line'>Enter password to encrypt DKEK share : 
</span><span class='line'>
</span><span class='line'>Please retype password to confirm : 
</span><span class='line'>
</span><span class='line'>Enciphering DKEK share, please wait...
</span><span class='line'>DKEK share created and saved to dkek-share-2.pbe
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<p>If you want a backup of DKEK shares copy them to another (encrypted) USB stick(s).</p>

<h4>Initialize the SmartCard</h4>

<ul>
<li>Initialize</li>
</ul>


<p>Use sc-hsm-tool to Intialize the smartcard and specify the number DKEK shares that you&rsquo;ll use. You&rsquo;ll need to pick a PIN code for the &ldquo;security officer&rdquo; and the &ldquo;user&rdquo;.</p>

<p>If you forget the so-pin you can not reinitialize the smartcard again so be sure that you pick so-pin that you can remember or write it down and store it on secure location. The so-pin has to be 16 digits long.</p>

<p><strong>
The sc-hsm-tool only asks for the PIN code ones so be sure that you know what you have typed. If you don&rsquo;t know it you smartcard becomes trash&hellip;
</strong></p>

<p>It possible to specify the pin code with &ldquo;&ndash;so-pin&rdquo; and &ldquo;&ndash;pin&rdquo; argument but this leaves the pin code in your shell history or in the process list&hellip;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --initialize --dkek-shares 2
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>Enter SO-PIN (16 hexadecimal characters) : 
</span><span class='line'>
</span><span class='line'>Enter initial User-PIN (6 - 16 characters) : 
</span><span class='line'>
</span><span class='line'>[staf@vicky mnt]$ 
</span></code></pre></td></tr></table></div></figure>


<p>If you execute the sc-hsm-tool command you&rsquo;ll see that the DKEK shares are still missing;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ sc-hsm-tool 
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>Version              : 1.2
</span><span class='line'>User PIN tries left  : 3
</span><span class='line'>DKEK shares          : 2
</span><span class='line'>DKEK import pending, 2 share(s) still missing
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<ul>
<li>import the dkek shares</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --import-dkek-share dkek-share-1.pbe
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>Enter password to decrypt DKEK share : 
</span><span class='line'>
</span><span class='line'>Deciphering DKEK share, please wait...
</span><span class='line'>DKEK share imported
</span><span class='line'>DKEK shares          : 2
</span><span class='line'>DKEK import pending, 1 share(s) still missing
</span><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --import-dkek-share dkek-share-2.pbe
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>Enter password to decrypt DKEK share : 
</span><span class='line'>
</span><span class='line'>Deciphering DKEK share, please wait...
</span><span class='line'>DKEK share imported
</span><span class='line'>DKEK shares          : 2
</span><span class='line'>DKEK key check value : 2C63E9E5D6FE0B8C
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<h4>test the user and so pin</h4>

<p>list the pkcs#11 slots</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ pkcs11-tool --module opensc-pkcs11.so -L
</span><span class='line'>Available slots:
</span><span class='line'>Slot 0 (0xffffffffffffffff): Virtual hotplug slot
</span><span class='line'>  (empty)
</span><span class='line'>Slot 1 (0x1): Generic Smart Card Reader Interface [Smart Card Reader Interface
</span><span class='line'>  token label        : SmartCard-HSM (UserPIN)
</span><span class='line'>  token manufacturer : www.CardContact.de
</span><span class='line'>  token model        : PKCS#15 emulated
</span><span class='line'>  token flags        : rng, login required, PIN initialized, token initialized
</span><span class='line'>  hardware version   : 24.13
</span><span class='line'>  firmware version   : 1.2
</span><span class='line'>  serial num         : DECM0102332
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<p>test the user pin;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@vicky mnt]$ pkcs11-tool --module opensc-pkcs11.so --slot 1 --login --test
</span><span class='line'>Logging in to "SmartCard-HSM (UserPIN)".
</span><span class='line'>Please enter User PIN: 
</span><span class='line'>C_SeedRandom() and C_GenerateRandom():
</span><span class='line'>  seeding (C_SeedRandom) not supported
</span><span class='line'>  seems to be OK
</span><span class='line'>Digests:
</span><span class='line'>  all 4 digest functions seem to work
</span><span class='line'>  MD5: OK
</span><span class='line'>  SHA-1: OK
</span><span class='line'>  RIPEMD160: OK
</span><span class='line'>Signatures (currently only RSA signatures)
</span><span class='line'>Signatures: no private key found in this slot
</span><span class='line'>Verify (currently only for RSA):
</span><span class='line'>  No private key found for testing
</span><span class='line'>Unwrap: not implemented
</span><span class='line'>Decryption (RSA)
</span><span class='line'>No errors
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<p>test the so pin</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ pkcs11-tool --module opensc-pkcs11.so --slot 1 --login --test --login-type so
</span><span class='line'>Logging in to "SmartCard-HSM (UserPIN)".
</span><span class='line'>Please enter SO PIN: 
</span><span class='line'>C_SeedRandom() and C_GenerateRandom():
</span><span class='line'>  seeding (C_SeedRandom) not supported
</span><span class='line'>  seems to be OK
</span><span class='line'>Digests:
</span><span class='line'>  all 4 digest functions seem to work
</span><span class='line'>  MD5: OK
</span><span class='line'>  SHA-1: OK
</span><span class='line'>  RIPEMD160: OK
</span><span class='line'>Signatures: not logged in, skipping signature tests
</span><span class='line'>Verify: not logged in, skipping verify tests
</span><span class='line'>Key unwrap: not a R/W session, skipping key unwrap tests
</span><span class='line'>Decryption: not logged in, skipping decryption tests
</span><span class='line'>No errors
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<h3>Create your first keypair</h3>

<h4>create key pair</h4>

<p>The command below an <a href="https://en.wikipedia.org/wiki/Elliptic_curve_cryptography">Elliptic Curve Cryptography (ECC)</a> key pair.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ pkcs11-tool --module opensc-pkcs11.so --keypairgen --key-type EC:prime256v1 --label myfirst_keypair --login
</span><span class='line'>Using slot 1 with a present token (0x1)
</span><span class='line'>Logging in to "SmartCard-HSM (UserPIN)".
</span><span class='line'>Please enter User PIN: 
</span><span class='line'>Key pair generated:
</span><span class='line'>Private Key Object; EC
</span><span class='line'>  label:      myfirst_keypair
</span><span class='line'>  ID:         ae79417e809ed19b9a69d4c14f444462ad0bd66c
</span><span class='line'>  Usage:      sign, derive
</span><span class='line'>Public Key Object; EC  EC_POINT 256 bits
</span><span class='line'>  EC_POINT:   044104f8ead77d1411e016196141d9d1f747a481aec4be40d1f8822d26d407fee05902082e18843ee58db4f5575b19ff243a735b66b2c91adbec1a59aeacc7c1ae8b52
</span><span class='line'>  EC_PARAMS:  06082a8648ce3d030107
</span><span class='line'>  label:      myfirst_keypair
</span><span class='line'>  ID:         ae79417e809ed19b9a69d4c14f444462ad0bd66c
</span><span class='line'>  Usage:      verify
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<h4>list objects</h4>

<p>list the objects to verif that your keypair in on the smartcard</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@vicky mnt]$ pkcs11-tool --module opensc-pkcs11.so --list-objects
</span><span class='line'>Using slot 1 with a present token (0x1)
</span><span class='line'>Public Key Object; EC  EC_POINT 256 bits
</span><span class='line'>  EC_POINT:   044104f8ead77d1411e016196141d9d1f747a481aec4be40d1f8822d26d407fee05902082e18843ee58db4f5575b19ff243a735b66b2c91adbec1a59aeacc7c1ae8b52
</span><span class='line'>  EC_PARAMS:  06082a8648ce3d030107
</span><span class='line'>  label:      myfirst_keypair
</span><span class='line'>  ID:         ae79417e809ed19b9a69d4c14f444462ad0bd66c
</span><span class='line'>  Usage:      none
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<h2>Copy objects to another smartcard</h2>

<h3>Backup</h3>

<p>To create a backup of our keys or data we need to extract it from the smartcard and copy it to another.
To store the object temporary we can use an encrypted filesystem or even a ram disk on a secured computer.</p>

<p>For security reasons you might want to separate your DKEK share from you key backups,
For the convenience we&rsquo;ll store everything on an encrypted USB stick.</p>

<h4>get the object reference</h4>

<p>First we need to find the object reference</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ pkcs15-tool -D
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>PKCS#15 Card [SmartCard-HSM]:
</span><span class='line'>        Version        : 0
</span><span class='line'>        Serial number  : DECM0102332
</span><span class='line'>        Manufacturer ID: www.CardContact.de
</span><span class='line'>        Flags          : 
</span><span class='line'>
</span><span class='line'>PIN [UserPIN]
</span><span class='line'>        Object Flags   : [0x3], private, modifiable
</span><span class='line'>        ID             : 01
</span><span class='line'>        Flags          : [0x81A], local, unblock-disabled, initialized, exchangeRefData
</span><span class='line'>        Length         : min_len:6, max_len:15, stored_len:0
</span><span class='line'>        Pad char       : 0x00
</span><span class='line'>        Reference      : 129 (0x81)
</span><span class='line'>        Type           : ascii-numeric
</span><span class='line'>        Tries left     : 3
</span><span class='line'>
</span><span class='line'>PIN [SOPIN]
</span><span class='line'>        Object Flags   : [0x1], private
</span><span class='line'>        ID             : 02
</span><span class='line'>        Flags          : [0x9E], local, change-disabled, unblock-disabled, initialized, soPin
</span><span class='line'>        Length         : min_len:16, max_len:16, stored_len:0
</span><span class='line'>        Pad char       : 0x00
</span><span class='line'>        Reference      : 136 (0x88)
</span><span class='line'>        Type           : bcd
</span><span class='line'>        Tries left     : 3
</span><span class='line'>
</span><span class='line'>Private EC Key [myfirst_keypair]
</span><span class='line'>        Object Flags   : [0x3], private, modifiable
</span><span class='line'>        Usage          : [0x10C], sign, signRecover, derive
</span><span class='line'>        Access Flags   : [0x1D], sensitive, alwaysSensitive, neverExtract, local
</span><span class='line'>        FieldLength    : 256
</span><span class='line'>        Key ref        : 1 (0x1)
</span><span class='line'>        Native         : yes
</span><span class='line'>        Path           : e82b0601040181c31f0201::
</span><span class='line'>        Auth ID        : 01
</span><span class='line'>        ID             : ae79417e809ed19b9a69d4c14f444462ad0bd66c
</span><span class='line'>        MD:guid        : {3a03d245-ea49-1da1-d8cd-f2ced0526400}
</span><span class='line'>          :cmap flags  : 0x0
</span><span class='line'>          :sign        : 0
</span><span class='line'>          :key-exchange: 0
</span><span class='line'>
</span><span class='line'>Public EC Key [myfirst_keypair]
</span><span class='line'>        Object Flags   : [0x0]
</span><span class='line'>        Usage          : [0x0]
</span><span class='line'>        Access Flags   : [0x2], extract
</span><span class='line'>        FieldLength    : 256
</span><span class='line'>        Key ref        : 0 (0x0)
</span><span class='line'>        Native         : no
</span><span class='line'>        ID             : ae79417e809ed19b9a69d4c14f444462ad0bd66c
</span><span class='line'>        DirectValue    : &lt;present&gt;
</span><span class='line'>
</span><span class='line'>[staf@vicky mnt]$ pkcs15-tool -D</span></code></pre></td></tr></table></div></figure>


<p></p>

<h4>extract the object(s)</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --wrap-key private_myfirst_keypair --key-reference 1 
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>Enter User PIN : 
</span><span class='line'>
</span><span class='line'>[staf@vicky mnt]$ ls -l
</span><span class='line'>total 28
</span><span class='line'>-rw-r--r-- 1 swagemakers backup    64 Nov 11 13:42 dkek-share-1.pbe
</span><span class='line'>-rw-r--r-- 1 swagemakers backup    64 Nov 11 13:42 dkek-share-2.pbe
</span><span class='line'>drwx------ 2 root        root   16384 Nov 11 13:37 lost+found
</span><span class='line'>-rw-rw-r-- 1 staf        staf     926 Nov 11 14:05 private_myfirst_keypair
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<p>Please not that we only need to copy the private key, the backup object also contains the public keypair.</p>

<h3>Initialize a second smartcard</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --initialize --dkek-shares 2
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>Enter SO-PIN (16 hexadecimal characters) : 
</span><span class='line'>
</span><span class='line'>Enter initial User-PIN (6 - 16 characters) : 
</span><span class='line'>
</span><span class='line'>[staf@vicky mnt]$ sc-hsm-tool 
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>Version              : 1.2
</span><span class='line'>User PIN tries left  : 3
</span><span class='line'>DKEK shares          : 2
</span><span class='line'>DKEK import pending, 2 share(s) still missing
</span><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --import-dkek-share dkek-share-1.pbe
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>Enter password to decrypt DKEK share : 
</span><span class='line'>
</span><span class='line'>Deciphering DKEK share, please wait...
</span><span class='line'>DKEK share imported
</span><span class='line'>DKEK shares          : 2
</span><span class='line'>DKEK import pending, 1 share(s) still missing
</span><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --import-dkek-share dkek-share-2.pbe
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>Enter password to decrypt DKEK share : 
</span><span class='line'>
</span><span class='line'>Deciphering DKEK share, please wait...
</span><span class='line'>DKEK share imported
</span><span class='line'>DKEK shares          : 2
</span><span class='line'>DKEK key check value : 2C63E9E5D6FE0B8C
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<h3>Store the key pair</h3>

<p>It&rsquo;s possible to write the private object to another smartcard with the same DKEK shares.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky mnt]$ sc-hsm-tool --unwrap-key private_myfirst_keypair --key-reference 1
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>Wrapped key contains:
</span><span class='line'>  Key blob
</span><span class='line'>  Private Key Description (PRKD)
</span><span class='line'>  Certificate
</span><span class='line'>Enter User PIN : 
</span><span class='line'>
</span><span class='line'>Key successfully imported
</span><span class='line'>[staf@vicky mnt]$ pkcs11-tool --list-objects 
</span><span class='line'>Using slot 1 with a present token (0x1)
</span><span class='line'>Public Key Object; EC  EC_POINT 256 bits
</span><span class='line'>  EC_POINT:   044104f8ead77d1411e016196141d9d1f747a481aec4be40d1f8822d26d407fee05902082e18843ee58db4f5575b19ff243a735b66b2c91adbec1a59aeacc7c1ae8b52
</span><span class='line'>  EC_PARAMS:  06082a8648ce3d030107
</span><span class='line'>  label:      myfirst_keypair
</span><span class='line'>  ID:         ae79417e809ed19b9a69d4c14f444462ad0bd66c
</span><span class='line'>  Usage:      none
</span><span class='line'>[staf@vicky mnt]$ pkcs15-tool -D
</span><span class='line'>Using reader with a card: Generic Smart Card Reader Interface [Smart Card Reader Interface] (20070818000000000) 00 00
</span><span class='line'>PKCS#15 Card [SmartCard-HSM]:
</span><span class='line'>        Version        : 0
</span><span class='line'>        Serial number  : DECM0102330
</span><span class='line'>        Manufacturer ID: www.CardContact.de
</span><span class='line'>        Flags          : 
</span><span class='line'>
</span><span class='line'>PIN [UserPIN]
</span><span class='line'>        Object Flags   : [0x3], private, modifiable
</span><span class='line'>        ID             : 01
</span><span class='line'>        Flags          : [0x81A], local, unblock-disabled, initialized, exchangeRefData
</span><span class='line'>        Length         : min_len:6, max_len:15, stored_len:0
</span><span class='line'>        Pad char       : 0x00
</span><span class='line'>        Reference      : 129 (0x81)
</span><span class='line'>        Type           : ascii-numeric
</span><span class='line'>        Tries left     : 3
</span><span class='line'>
</span><span class='line'>PIN [SOPIN]
</span><span class='line'>        Object Flags   : [0x1], private
</span><span class='line'>        ID             : 02
</span><span class='line'>        Flags          : [0x9E], local, change-disabled, unblock-disabled, initialized, soPin
</span><span class='line'>        Length         : min_len:16, max_len:16, stored_len:0
</span><span class='line'>        Pad char       : 0x00
</span><span class='line'>        Reference      : 136 (0x88)
</span><span class='line'>        Type           : bcd
</span><span class='line'>        Tries left     : 3
</span><span class='line'>
</span><span class='line'>Private EC Key [myfirst_keypair]
</span><span class='line'>        Object Flags   : [0x3], private, modifiable
</span><span class='line'>        Usage          : [0x10C], sign, signRecover, derive
</span><span class='line'>        Access Flags   : [0x1D], sensitive, alwaysSensitive, neverExtract, local
</span><span class='line'>        FieldLength    : 256
</span><span class='line'>        Key ref        : 1 (0x1)
</span><span class='line'>        Native         : yes
</span><span class='line'>        Path           : e82b0601040181c31f0201::
</span><span class='line'>        Auth ID        : 01
</span><span class='line'>        ID             : ae79417e809ed19b9a69d4c14f444462ad0bd66c
</span><span class='line'>        MD:guid        : {8e96ad75-4f6c-eb5e-6bb3-4a637bbcda50}
</span><span class='line'>          :cmap flags  : 0x0
</span><span class='line'>          :sign        : 0
</span><span class='line'>          :key-exchange: 0
</span><span class='line'>
</span><span class='line'>Public EC Key [myfirst_keypair]
</span><span class='line'>        Object Flags   : [0x0]
</span><span class='line'>        Usage          : [0x0]
</span><span class='line'>        Access Flags   : [0x2], extract
</span><span class='line'>        FieldLength    : 256
</span><span class='line'>        Key ref        : 0 (0x0)
</span><span class='line'>        Native         : no
</span><span class='line'>        ID             : ae79417e809ed19b9a69d4c14f444462ad0bd66c
</span><span class='line'>        DirectValue    : &lt;present&gt;
</span><span class='line'>
</span><span class='line'>[staf@vicky mnt]$ </span></code></pre></td></tr></table></div></figure>


<h3>Done&hellip;</h3>

<p>We have a backup to our second smartcard and an ecrypted backup of the key on the usb, umount the backup and store it to a safe location.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ mount | grep mnt
</span><span class='line'>/dev/mapper/my on /mnt type ext4 (rw,relatime,data=ordered)
</span><span class='line'>[staf@vicky ~]$ umount /mnt
</span><span class='line'>umount: /mnt: umount failed: Operation not permitted
</span><span class='line'>[staf@vicky ~]$ sudo umount /mnt
</span><span class='line'>[sudo] password for staf: 
</span><span class='line'>[staf@vicky ~]$ sudo cryptsetup luksClose my
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<p><strong><em> I might publish some smartcard-hsm usage examples in the further&hellip;. </em></strong></p>

<h3>Links</h3>

<p><a href="https://github.com/OpenSC/OpenSC/wiki/SmartCardHSM">https://github.com/OpenSC/OpenSC/wiki/SmartCardHSM</a></p>
</div>
  
  

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog_actrikel -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4659298941528586"
     data-ad-slot="7394058542"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2015/10/17/lookat-1-dot-4-4rc2-released/">Lookat 1.4.4rc2 Released</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-10-17T15:36:05+02:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>3:36 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Lookat 1.4.4rc2 is the second release candicate of Lookat 1.4.4</p>

<h3>ChangeLog</h3>

<ul>
<li>NetBSD support</li>
</ul>


<h3>Lookat 1.4.4rc2 is available at:</h3>

<p><a href="http://www.wagemakers.be/english/programs/lookat"><a href="http://www.wagemakers.be/english/programs/lookat">http://www.wagemakers.be/english/programs/lookat</a></a>
, download it directly <a href="http://www.wagemakers.be/downloads/lookat/lookat_bekijk-1.4.4rc2.tar.gz">Download latest development release (1.4.4rc2)</a>.</p>

<p>Or at the Git repository at GNU savannah <a href="http://git.savannah.gnu.org/cgit/lookat.git/"><a href="http://git.savannah.gnu.org/cgit/lookat.git/">http://git.savannah.gnu.org/cgit/lookat.git/</a></a></p>

<p><strong><em> Have fun </em></strong></p>
</div>
  
  

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog_actrikel -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4659298941528586"
     data-ad-slot="7394058542"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2015/09/05/rataplan-becomes-a-watchdog/">Rataplan Becomes a Watchdog</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-09-05T14:47:54+02:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>2:47 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img class="left" src="/blog/images/watchdog_rataplan.jpg">
<a href="http://stafwag.github.io/blog/blog/2012/12/16/running-freebsd-9.0-on-asus-c60m1-i-motherboard/">My NAS</a> runs on <a href="http://www.freebsd.org">FreeBSD</a> I&rsquo;m quiet happy with it. It&rsquo;s named after the dog <a href="https://nl.wikipedia.org/wiki/Rataplan">rataplan</a> from the <a href="https://en.wikipedia.org/wiki/Lucky_Luke">Lucky Luke comic</a></p>

<p>However transferring large data files to it causes the network to hang. The realtek network interface had issues with freebsd from the <a href="http://stafwag.github.io/blog/blog/2012/12/16/running-freebsd-9.0-on-asus-c60m1-i-motherboard/">beginning</a>. On the screen and in syslog the entry &ldquo;re0: watchdog timeout&rdquo; is printed.</p>

<p>Most FreeBSD people recommends to use Intel nics, I ordered <a href="http://www.dx.com/nl/p/winyao-wy574t-intel-wg82574l-chipset-pci-e-x1-server-gigabit-network-card-adapter-green-280966">a new Intel nic at dx.com</a>. After the installation of the new NIC the network seems to be stable again.</p>
</div>
  
  

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog_actrikel -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4659298941528586"
     data-ad-slot="7394058542"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2015/07/21/lookat-1-dot-4-4rc1-released/">Lookat 1.4.4rc1 Released</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-07-21T12:24:00+02:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2015</span></span> <span class='time'>12:24 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>It is a <a href="https://en.wikipedia.org/wiki/July_21">national holiday in Belgium</a> so I have some time to code again.</p>

<p>Lookat 1.4.4rc1 is the first release candicate of Lookat 1.4.4</p>

<h3>ChangeLog</h3>

<ul>
<li>openBSD support</li>
<li>English translation issues corrected</li>
<li>autoconf updated to 2.69</li>
<li>Corrected mirror compile warnings</li>
</ul>


<h3>Lookat 1.4.4rc1 is available at:</h3>

<p><a href="http://www.wagemakers.be/english/programs/lookat"><a href="http://www.wagemakers.be/english/programs/lookat">http://www.wagemakers.be/english/programs/lookat</a></a>
, download it directly <a href="http://www.wagemakers.be/downloads/lookat/lookat_bekijk-1.4.4rc1.tar.gz">Download latest development release (1.4.4rc1)</a>.</p>

<p>Or at the Git repository at GNU savannah <a href="http://git.savannah.gnu.org/cgit/lookat.git/"><a href="http://git.savannah.gnu.org/cgit/lookat.git/">http://git.savannah.gnu.org/cgit/lookat.git/</a></a></p>

<h3>OpenBSD</h3>

<p>I forgot to mention it but Lookat has landed in <a href="http://www.openbsd.org">OpenBSD</a>
Thanks to Brian Callahan for the port!</p>

<p><strong><em> Have fun </em></strong></p>
</div>
  
  

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog_actrikel -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4659298941528586"
     data-ad-slot="7394058542"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2015/06/23/using-squid-to-cache-freebsd-packages/">Using Squid to Cache FreeBSD Packages</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-23T08:43:00+02:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2015</span></span> <span class='time'>8:43 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>PKGNG config</h2>

<p>I manage a few <a href="https://www.freebsd.org/doc/handbook/jails.html">FreeBSD jails</a> behind a <a href="http://www.squid-cache.org/">squid proxy</a>. <a href="https://wiki.freebsd.org/pkgng">pkgng</a> is configured to use the proxy:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@rataplan:/root # cat /etc/pkg/FreeBSD.conf 
</span><span class='line'># $FreeBSD: releng/10.1/etc/pkg/FreeBSD.conf 263938 2014-03-30 15:29:54Z bdrewery $
</span><span class='line'>#
</span><span class='line'># To disable this repository, instead of modifying or removing this file,
</span><span class='line'># create a /usr/local/etc/pkg/repos/FreeBSD.conf file:
</span><span class='line'>#
</span><span class='line'>#   mkdir -p /usr/local/etc/pkg/repos
</span><span class='line'>#   echo "FreeBSD: { enabled: no }" &gt; /usr/local/etc/pkg/repos/FreeBSD.conf
</span><span class='line'>#
</span><span class='line'>
</span><span class='line'>pkg_env: {
</span><span class='line'>
</span><span class='line'>        http_proxy: "http://xxx.xxx.xxx.xxx:3128"
</span><span class='line'>
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>FreeBSD: {
</span><span class='line'>  url: "pkg+http://pkg.FreeBSD.org/${ABI}/latest",
</span><span class='line'>  mirror_type: "srv",
</span><span class='line'>  signature_type: "fingerprints",
</span><span class='line'>  fingerprints: "/usr/share/keys/pkg",
</span><span class='line'>  enabled: yes
</span><span class='line'>}
</span><span class='line'>root@rataplan:/root # 
</span></code></pre></td></tr></table></div></figure>


<h2>SQUID config</h2>

<h3>Recompile</h3>

<p>The squid proxy doesn&rsquo;t cache to the FreeBSD packages. The squid pkgng package  is compiled with
&ldquo;LAX_HTTP  Do not enforce strict HTTP compliance&rdquo; option disabled. which doesn&rsquo;t allow you to override the cache headers sent by the remote site.</p>

<p>In order to cache the FreeBSD packages we need to recompile squid with &ldquo;LAX_HTTPD&rdquo; enabled.</p>

<h4>Updating the ports</h4>

<h5>Physical system</h5>

<p>If you use a physical FreeBSD system as your proxy run the &ldquo;portsnap fetch&rdquo; command.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@rataplan ~]# portsnap fetch
</span><span class='line'>Looking up portsnap.FreeBSD.org mirrors... 7 mirrors found.
</span><span class='line'>Fetching snapshot tag from ec2-eu-west-1.portsnap.freebsd.org... done.
</span><span class='line'>Fetching snapshot metadata... done.
</span><span class='line'>Updating from Mon Jun 22 14:30:21 CEST 2015 to Tue Jun 23 08:39:41 CEST 2015.
</span><span class='line'>Fetching 4 metadata patches... done.
</span><span class='line'>Applying metadata patches... done.
</span><span class='line'>Fetching 0 metadata files... done.
</span><span class='line'>Fetching 417 patches. 
</span><span class='line'>(417/417) 100.00%  done.                                       
</span><span class='line'>done.
</span><span class='line'>Applying patches... 
</span><span class='line'>done.
</span><span class='line'>Fetching 3 new ports or files... done.
</span><span class='line'>[root@rataplan ~]# </span></code></pre></td></tr></table></div></figure>


<p></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@rataplan ~]# portsnap extract
</span><span class='line'>/usr/ports/.arcconfig
</span><span class='line'>/usr/ports/.gitignore
</span><span class='line'>/usr/ports/CHANGES
</span><span class='line'>/usr/ports/CONTRIBUTING.md
</span><span class='line'>/usr/ports/COPYRIGHT
</span><span class='line'>/usr/ports/GIDs
</span><span class='line'>
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>
</span><span class='line'>/usr/ports/x11/zenity/
</span><span class='line'>Building new INDEX files... done.
</span><span class='line'>[root@rataplan ~]# 
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<h5>Jail</h5>

<p>If you use an <a href="http://erdgeist.org/arts/software/ezjail/">ezjail</a> as your proxy run the &ldquo;ezjail-admin update -P&rdquo; command.</p>

<h4>Build</h4>

<h5>Stop SQUID</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/ports/www/squid # /usr/local/etc/rc.d/squid stop
</span><span class='line'>squid not running? (check /var/run/squid/squid.pid).
</span><span class='line'>root@stafproxy:/usr/ports/www/squid # </span></code></pre></td></tr></table></div></figure>


<h5>Make config</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/ports/www/squid # cd
</span><span class='line'>root@stafproxy:/root # cd /usr/ports/www/squid
</span><span class='line'>root@stafproxy:/usr/ports/www/squid # make config</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>       ┌─────────────────────────────── squid-3.5.5 ──────────────────────────────────┐
</span><span class='line'>       │ ┌──────────────────────────────────────────────────────────────────────────┐ │  
</span><span class='line'>       │ │ [ ] ARP_ACL         ARP/MAC/EUI based authentification                   │ │  
</span><span class='line'>       │ │ [ ] AUTH_LDAP       Install LDAP authentication helpers                  │ │  
</span><span class='line'>       │ │ [x] AUTH_NIS        Install NIS/YP authentication helpers                │ │  
</span><span class='line'>       │ │ [ ] AUTH_SASL       Install SASL authentication helpers                  │ │  
</span><span class='line'>       │ │ [ ] AUTH_SMB        Install SMB auth. helpers (req. Samba)               │ │  
</span><span class='line'>       │ │ [ ] AUTH_SQL        Install SQL based auth (uses MySQL)                  │ │  
</span><span class='line'>       │ │ [ ] CACHE_DIGESTS   Use cache digests                                    │ │  
</span><span class='line'>       │ │ [ ] DEBUG           Build with extended debugging support                │ │  
</span><span class='line'>       │ │ [ ] DELAY_POOLS     Delay pools (bandwidth limiting)                     │ │  
</span><span class='line'>       │ │ [x] DOCS            Build and/or install documentation                   │ │  
</span><span class='line'>       │ │ [ ] ECAP            Loadable content adaptation modules                  │ │  
</span><span class='line'>       │ │ [ ] ESI             ESI support                                          │ │  
</span><span class='line'>       │ │ [x] EXAMPLES        Build and/or install examples                        │ │  
</span><span class='line'>       │ │ [ ] FOLLOW_XFF      Support for the X-Following-For header               │ │  
</span><span class='line'>       │ │ [x] FS_AUFS         AUFS (threaded-io) support                           │ │  
</span><span class='line'>       │ │ [x] FS_DISKD        DISKD storage engine controlled by separate service  │ │  
</span><span class='line'>       │ │ [ ] FS_ROCK         ROCK storage engine                                  │ │  
</span><span class='line'>       │ │ [x] HTCP            HTCP support                                         │ │  
</span><span class='line'>       │ │ [ ] ICAP            the ICAP client                                      │ │  
</span><span class='line'>       │ │ [ ] ICMP            ICMP pinging and network measurement                 │ │  
</span><span class='line'>       │ │ [x] IDENT           Ident lookups (RFC 931)                              │ │  
</span><span class='line'>       │ │ [x] IPV6            IPv6 protocol support                                │ │  
</span><span class='line'>       │ │ [x] KQUEUE          Kqueue(2) support                                    │ │  
</span><span class='line'>       │ │ [ ] LARGEFILE       Support large (&gt;2GB) cache and log files             │ │  
</span><span class='line'>       │ │ [x] LAX_HTTP        Do not enforce strict HTTP compliance                │ │  
</span><span class='line'>       │ │ [ ] NETTLE          Nettle MD5 algorithm support                         │ │  
</span><span class='line'>       │ │ [x] SNMP            SNMP support                                         │ │  
</span><span class='line'>       │ │ [ ] SSL             SSL gatewaying support                               │ │  
</span><span class='line'>       │ │ [ ] SSL_CRTD        Use ssl_crtd to handle SSL cert requests             │ │  
</span><span class='line'>       │ │ [ ] STACKTRACES     Enable automatic backtraces on fatal errors          │ │  
</span><span class='line'>       │ │ [ ] TP_IPF          Transparent proxying with IPFilter                   │ │  
</span><span class='line'>       │ │ [ ] TP_IPFW         Transparent proxying with IPFW                       │ │  
</span><span class='line'>       │ │ [ ] TP_PF           Transparent proxying with PF                         │ │  
</span><span class='line'>       │ │ [ ] VIA_DB          Forward/Via database                                 │ │  
</span><span class='line'>       │ └─────v(+)─────────────────────────────────────────────────────────82%─────┘ │  
</span><span class='line'>       ├──────────────────────────────────────────────────────────────────────────────┤  
</span><span class='line'>       │                       &lt;  OK  &gt;            &lt;Cancel&gt;                           │  
</span><span class='line'>       └──────────────────────────────────────────────────────────────────────────────┘  
</span><span class='line'>                                                                                         
</span></code></pre></td></tr></table></div></figure>


<h5>Make install</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/ports/www/squid # make
</span><span class='line'>===&gt;  License GPLv2 accepted by the user
</span><span class='line'>===&gt;  Found saved configuration for squid-3.5.5
</span><span class='line'>===&gt;   squid-3.5.5 depends on file: /usr/local/sbin/pkg - found
</span><span class='line'>===&gt; Fetching all distfiles required by squid-3.5.5 for building
</span><span class='line'>===&gt;  Extracting for squid-3.5.5
</span><span class='line'>=&gt; SHA256 Checksum OK for squid3.5/squid-3.5.5.tar.xz.
</span><span class='line'>
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>
</span><span class='line'>Making install in test-suite
</span><span class='line'>install  -m 0644 /var/ports/basejail/usr/ports/www/squid/work/squid-3.5.5/helpers/basic_auth/DB/passwd.sql  /var/ports/basejail/usr/ports/www/squid/work/stage/usr/local/share/examples/squid
</span><span class='line'>(cd /var/ports/basejail/usr/ports/www/squid/work/squid-3.5.5 && install  -m 0644 QUICKSTART README RELEASENOTES.html doc/debug-sections.txt /var/ports/basejail/usr/ports/www/squid/work/stage/usr/local/share/doc/squid)
</span><span class='line'>/bin/mkdir -p /var/ports/basejail/usr/ports/www/squid/work/stage/var/squid/logs
</span><span class='line'>/bin/rmdir /var/ports/basejail/usr/ports/www/squid/work/stage/var/run/squid
</span><span class='line'>====&gt; Compressing man pages (compress-man)
</span><span class='line'>===&gt; Staging rc.d startup script(s)</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/ports/www/squid # make install clean
</span><span class='line'>===&gt;  Installing for squid-3.5.5                                                                                                                                                                                                             
</span><span class='line'>===&gt;   squid-3.5.5 depends on file: /usr/local/bin/perl5.20.2 - found                                                                                                                                                                        
</span><span class='line'>===&gt;  Checking if squid already installed                                                                                                                                                                                                    
</span><span class='line'>===&gt;   Registering installation for squid-3.5.5                                                                                                                                                                                              
</span><span class='line'>
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>
</span><span class='line'>===&gt; SECURITY REPORT: 
</span><span class='line'>      This port has installed the following files which may act as network
</span><span class='line'>      servers and may therefore pose a remote security risk to the system.
</span><span class='line'>/usr/local/libexec/squid/basic_radius_auth
</span><span class='line'>/usr/local/sbin/squid
</span><span class='line'>
</span><span class='line'>      This port has installed the following startup scripts which may cause
</span><span class='line'>      these network services to be started at boot time.
</span><span class='line'>/usr/local/etc/rc.d/squid
</span><span class='line'>
</span><span class='line'>      If there are vulnerabilities in these programs there may be a security
</span><span class='line'>      risk to the system. FreeBSD makes no guarantee about the security of
</span><span class='line'>      ports included in the Ports Collection. Please type 'make deinstall'
</span><span class='line'>      to deinstall the port if this is a concern.
</span><span class='line'>
</span><span class='line'>      For more information, and contact details about the security
</span><span class='line'>      status of this software, see the following webpage: 
</span><span class='line'>http://www.squid-cache.org/
</span></code></pre></td></tr></table></div></figure>


<h5>pkg lock</h5>

<p>Lock the squid package to prevent the upgrade from pkgng tree.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/ports/www/squid # pkg lock squid
</span><span class='line'>squid-3.5.5: lock this package? [y/N]: y
</span><span class='line'>Locking squid-3.5.5
</span><span class='line'>root@stafproxy:/usr/ports/www/squid #
</span></code></pre></td></tr></table></div></figure>


<p>View the locked pkgng packages</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/ports/www/squid # pkg lock -l
</span><span class='line'>Currently locked packages:
</span><span class='line'>squid-3.5.5
</span><span class='line'>root@stafproxy:/usr/ports/www/squid # </span></code></pre></td></tr></table></div></figure>


<h3>SQUID config</h3>

<h4>Update squid.conf</h4>

<p>Edit the squid config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/ports/www/squid # cd /usr/local/etc/squid/
</span><span class='line'>root@stafproxy:/usr/local/etc/squid # vi squid.conf
</span></code></pre></td></tr></table></div></figure>


<p>Add a &ldquo;refresh_pattern&rdquo; for &ldquo;pkgmir.pkg.freebsd.org&rdquo;:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>refresh_pattern ^ftp:           1440    20%     10080
</span><span class='line'>refresh_pattern ^http://pkgmir.pkg.freebsd.org/.*\.txz          1440    100%    10080 ignore-private ignore-must-revalidate override-expire ignore-no-cache
</span><span class='line'>refresh_pattern ^gopher:        1440    0%      1440
</span><span class='line'>refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
</span><span class='line'>refresh_pattern .               0       20%     4320</span></code></pre></td></tr></table></div></figure>


<h4>Start squid</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/local/etc/squid # ../rc.d/squid start
</span><span class='line'>Starting squid.
</span><span class='line'>root@stafproxy:/usr/local/etc/squid # 
</span></code></pre></td></tr></table></div></figure>


<h4>rc.conf</h4>

<p>Make sure that the system is configured to start squid during the system startup.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@stafproxy:/usr/local/etc/squid # cat /etc/rc.conf 
</span><span class='line'>#
</span><span class='line'># squid
</span><span class='line'>#
</span><span class='line'>
</span><span class='line'>squid_enable="YES"
</span><span class='line'>
</span><span class='line'>root@stafproxy:/usr/local/etc/squid # </span></code></pre></td></tr></table></div></figure>


<p>SQUID should cache the pkgng downloads now.</p>

<p><em>Have fun</em></p>
</div>
  
  

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog_actrikel -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4659298941528586"
     data-ad-slot="7394058542"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2015/06/16/using-yubikey-neo-as-gpg-smartcard-for-ssh-authentication/">Using YubiKey Neo as Gpg Smartcard for SSH Authentication</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-16T10:32:00+02:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>16</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>10:32 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I purchased a <a href="https://www.yubico.com/products/yubikey-hardware/">Yubi NEO</a> I&rsquo;ll use it to hold my  <a href="https://en.wikipedia.org/wiki/Linux_Unified_Key_Setup">Luks</a> password and for ssh authentication instead of the password authentication that I still use.</p>

<p>You&rsquo;ll find  my journey to get the smartcard interface working with ssh on a fedora 22 system below;</p>

<h2>Install the yubiclient and smartcard software</h2>

<h3>Install the ykclient</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ykclient.x86_64 : Yubikey management library and client
</span><span class='line'>[root@vicky ~]# dnf install ykclient
</span><span class='line'>Last metadata expiration check performed 1:00:07 ago on Sun Jun 14 09:14:34 2015.
</span><span class='line'>Dependencies resolved.
</span><span class='line'>====================================================================================================================
</span><span class='line'> Package                    Arch                     Version                         Repository                Size
</span><span class='line'>====================================================================================================================
</span><span class='line'>Installing:
</span><span class='line'> ykclient                   x86_64                   2.13-1.fc22                     fedora                    35 k
</span><span class='line'>
</span><span class='line'>Transaction Summary
</span><span class='line'>====================================================================================================================
</span><span class='line'>Install  1 Package
</span><span class='line'>
</span><span class='line'>Total download size: 35 k
</span><span class='line'>Installed size: 58 k
</span><span class='line'>Is this ok [y/N]: y
</span><span class='line'>Downloading Packages:
</span><span class='line'>ykclient-2.13-1.fc22.x86_64.rpm                                                      48 kB/s |  35 kB     00:00    
</span><span class='line'>--------------------------------------------------------------------------------------------------------------------
</span><span class='line'>Total                                                                                11 kB/s |  35 kB     00:03     
</span><span class='line'>Running transaction check
</span><span class='line'>Transaction check succeeded.
</span><span class='line'>Running transaction test
</span><span class='line'>Transaction test succeeded.
</span><span class='line'>Running transaction
</span><span class='line'>  Installing  : ykclient-2.13-1.fc22.x86_64                                                                     1/1 
</span><span class='line'>  Verifying   : ykclient-2.13-1.fc22.x86_64                                                                     1/1 
</span><span class='line'>
</span><span class='line'>Installed:
</span><span class='line'>  ykclient.x86_64 2.13-1.fc22                                                                                       
</span><span class='line'>
</span><span class='line'>Complete!
</span><span class='line'>[root@vicky ~]# </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@vicky ~]# ykinfo
</span><span class='line'>bash: ykinfo: command not found...
</span><span class='line'>Install package 'ykpers' to provide command 'ykinfo'? [N/y] ^C
</span><span class='line'>
</span><span class='line'>[root@vicky ~]# dnf install ykpers
</span><span class='line'>Last metadata expiration check performed 1:01:23 ago on Sun Jun 14 09:14:34 2015.
</span><span class='line'>Dependencies resolved.
</span><span class='line'>====================================================================================================================
</span><span class='line'> Package                     Arch                    Version                          Repository               Size
</span><span class='line'>====================================================================================================================
</span><span class='line'>Installing:
</span><span class='line'> libyubikey                  x86_64                  1.11-3.fc22                      fedora                   33 k
</span><span class='line'> ykpers                      x86_64                  1.17.1-1.fc22                    fedora                  101 k
</span><span class='line'>
</span><span class='line'>Transaction Summary
</span><span class='line'>====================================================================================================================
</span><span class='line'>Install  2 Packages
</span><span class='line'>
</span><span class='line'>Total download size: 135 k
</span><span class='line'>Installed size: 372 k
</span><span class='line'>Is this ok [y/N]: y
</span><span class='line'>Downloading Packages:
</span><span class='line'>(1/2): libyubikey-1.11-3.fc22.x86_64.rpm                                             13 kB/s |  33 kB     00:02    
</span><span class='line'>(2/2): ykpers-1.17.1-1.fc22.x86_64.rpm                                               38 kB/s | 101 kB     00:02    
</span><span class='line'>--------------------------------------------------------------------------------------------------------------------
</span><span class='line'>Total                                                                                22 kB/s | 135 kB     00:06     
</span><span class='line'>Running transaction check
</span><span class='line'>Transaction check succeeded.
</span><span class='line'>Running transaction test
</span><span class='line'>Transaction test succeeded.
</span><span class='line'>Running transaction
</span><span class='line'>  Installing  : libyubikey-1.11-3.fc22.x86_64                                                                   1/2 
</span><span class='line'>  Installing  : ykpers-1.17.1-1.fc22.x86_64                                                                     2/2 
</span><span class='line'>  Verifying   : ykpers-1.17.1-1.fc22.x86_64                                                                     1/2 
</span><span class='line'>  Verifying   : libyubikey-1.11-3.fc22.x86_64                                                                   2/2 
</span><span class='line'>
</span><span class='line'>Installed:
</span><span class='line'>  libyubikey.x86_64 1.11-3.fc22                             ykpers.x86_64 1.17.1-1.fc22                            
</span><span class='line'>
</span><span class='line'>Complete!
</span></code></pre></td></tr></table></div></figure>


<h3>Verify that you&rsquo;ve access to the yubikey</h3>

<p>&ldquo;ykinfo -v&rdquo; shows you the version on the yubikey.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# ykinfo -v
</span><span class='line'>version: 3.4.0
</span><span class='line'>[root@vicky ~]# 
</span></code></pre></td></tr></table></div></figure>


<p>If you try with the user that you&rsquo;ll for the yubi authentication you might get a permission denied:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@vicky ~]$ ykinfo -v
</span><span class='line'>USB error: Access denied (insufficient permissions)
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h4>Update the udev permissions</h4>

<h5>Update rule file</h5>

<p>On a fedora 22 system to udev rules for the yubi key are defined in &ldquo;/usr/lib/udev/rules.d/69-yubikey.rules&rdquo;</p>

<p>It is a good practice to only grant access to user that will use the yubikey.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# cd /usr/lib/udev/rules.d/
</span><span class='line'>[root@vicky rules.d]# vi 69-yubikey.rules </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ACTION!="add|change", GOTO="yubico_end"
</span><span class='line'>
</span><span class='line'># Udev rules for letting the console user access the Yubikey USB
</span><span class='line'># device node, needed for challenge/response to work correctly.
</span><span class='line'>
</span><span class='line'># Yubico Yubikey II
</span><span class='line'>ATTRS{idVendor}=="1050", ATTRS{idProduct}=="0010|0110|0111|0114|0116|0401|0403|0405|0407|0410", OWNER="staf", MODE="0600"
</span><span class='line'>
</span><span class='line'>LABEL="yubico_end"</span></code></pre></td></tr></table></div></figure>


<h5>Update udev rules</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># udevadm control --reload
</span><span class='line'># udevadm trigger</span></code></pre></td></tr></table></div></figure>


<h5>Test it again</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ ykinfo -v
</span><span class='line'>version: 3.4.0
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h3>Enable the smartcard interface</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@vicky yubi]$ ykpersonalize -m82
</span><span class='line'>Firmware version 3.4.0 Touch level 1551 Program sequence 3
</span><span class='line'>
</span><span class='line'>The USB mode will be set to: 0x82
</span><span class='line'>
</span><span class='line'>Commit? (y/n) [n]: y
</span><span class='line'>[staf@vicky yubi]$ 
</span></code></pre></td></tr></table></div></figure>


<p>Remove the yubi key from your system and plug it back to activate the new interface.</p>

<h3>Install the required smartcard software</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# dnf install pcsc-tools   
</span><span class='line'>Last metadata expiration check performed 0:33:58 ago on Sun Jun 14 09:14:34 2015.
</span><span class='line'>Dependencies resolved.                                       
</span><span class='line'>====================================================================================================================
</span><span class='line'> Package                         Arch                  Version                          Repository             Size
</span><span class='line'>====================================================================================================================
</span><span class='line'>Installing:                                                 
</span><span class='line'> pcsc-lite                       x86_64                1.8.13-1.fc22                    fedora                101 k
</span><span class='line'> pcsc-lite-asekey                x86_64                3.7-1.fc22                       fedora                 34 k
</span><span class='line'> pcsc-perl                       x86_64                1.4.12-11.fc22                   fedora                 61 k
</span><span class='line'> pcsc-tools                      x86_64                1.4.23-1.fc22                    fedora                116 k
</span><span class='line'> perl-Cairo                      x86_64                1.105-1.fc22                     fedora                126 k
</span><span class='line'> perl-Glib                       x86_64                1.310-1.fc22                     fedora                362 k
</span><span class='line'> perl-Gtk2                       x86_64                1.2495-1.fc22                    fedora                1.8 M
</span><span class='line'> perl-HTML-Tree                  noarch                1:5.03-8.fc22                    fedora                223 k
</span><span class='line'> perl-Pango                      x86_64                1.226-3.fc22                     fedora                220 k
</span><span class='line'>                                                           
</span><span class='line'>Transaction Summary                                        
</span><span class='line'>====================================================================================================================
</span><span class='line'>Install  9 Packages                                        
</span><span class='line'>                                                            
</span><span class='line'>Total download size: 3.0 M                                  
</span><span class='line'>Installed size: 8.4 M                                       
</span><span class='line'>Is this ok [y/N]: y                                          
</span><span class='line'>Downloading Packages:                                        
</span><span class='line'>(1/9): pcsc-tools-1.4.23-1.fc22.x86_64.rpm                                           38 kB/s | 116 kB     00:03    
</span><span class='line'>(2/9): pcsc-perl-1.4.12-11.fc22.x86_64.rpm                                           20 kB/s |  61 kB     00:03    
</span><span class='line'>(3/9): pcsc-lite-1.8.13-1.fc22.x86_64.rpm                                            23 kB/s | 101 kB     00:04    
</span><span class='line'>(4/9): perl-Glib-1.310-1.fc22.x86_64.rpm                                            159 kB/s | 362 kB     00:02    
</span><span class='line'>(5/9): perl-Cairo-1.105-1.fc22.x86_64.rpm                                            56 kB/s | 126 kB     00:02    
</span><span class='line'>(6/9): perl-HTML-Tree-5.03-8.fc22.noarch.rpm                                         99 kB/s | 223 kB     00:02    
</span><span class='line'>(7/9): perl-Gtk2-1.2495-1.fc22.x86_64.rpm                                           342 kB/s | 1.8 MB     00:05    
</span><span class='line'>(8/9): perl-Pango-1.226-3.fc22.x86_64.rpm                                            89 kB/s | 220 kB     00:02    
</span><span class='line'>(9/9): pcsc-lite-asekey-3.7-1.fc22.x86_64.rpm                                        21 kB/s |  34 kB     00:01    
</span><span class='line'>--------------------------------------------------------------------------------------------------------------------
</span><span class='line'>Total                                                                               257 kB/s | 3.0 MB     00:11     
</span><span class='line'>Running transaction check                                   
</span><span class='line'>Transaction check succeeded.                                
</span><span class='line'>Running transaction test                                     
</span><span class='line'>Transaction test succeeded.                                   
</span><span class='line'>Running transaction                                             
</span><span class='line'>  Installing  : perl-Glib-1.310-1.fc22.x86_64                                                                   1/9 
</span><span class='line'>  Installing  : pcsc-lite-asekey-3.7-1.fc22.x86_64                                                              2/9 
</span><span class='line'>  Installing  : pcsc-lite-1.8.13-1.fc22.x86_64                                                                  3/9 
</span><span class='line'>  Installing  : perl-Cairo-1.105-1.fc22.x86_64                                                                  4/9 
</span><span class='line'>  Installing  : perl-Pango-1.226-3.fc22.x86_64                                                                  5/9 
</span><span class='line'>  Installing  : perl-HTML-Tree-1:5.03-8.fc22.noarch                                                             6/9 
</span><span class='line'>  Installing  : perl-Gtk2-1.2495-1.fc22.x86_64                                                                  7/9 
</span><span class='line'>  Installing  : pcsc-perl-1.4.12-11.fc22.x86_64                                                                 8/9 
</span><span class='line'>  Installing  : pcsc-tools-1.4.23-1.fc22.x86_64                                                                 9/9 
</span><span class='line'>  Verifying   : pcsc-tools-1.4.23-1.fc22.x86_64                                                                 1/9 
</span><span class='line'>  Verifying   : pcsc-lite-1.8.13-1.fc22.x86_64                                                                  2/9 
</span><span class='line'>  Verifying   : pcsc-perl-1.4.12-11.fc22.x86_64                                                                 3/9 
</span><span class='line'>  Verifying   : perl-Glib-1.310-1.fc22.x86_64                                                                   4/9 
</span><span class='line'>  Verifying   : perl-Gtk2-1.2495-1.fc22.x86_64                                                                  5/9 
</span><span class='line'>  Verifying   : perl-Cairo-1.105-1.fc22.x86_64                                                                  6/9 
</span><span class='line'>  Verifying   : perl-HTML-Tree-1:5.03-8.fc22.noarch                                                             7/9 
</span><span class='line'>  Verifying   : perl-Pango-1.226-3.fc22.x86_64                                                                  8/9 
</span><span class='line'>  Verifying   : pcsc-lite-asekey-3.7-1.fc22.x86_64                                                              9/9 
</span><span class='line'>
</span><span class='line'>Installed:
</span><span class='line'>  pcsc-lite.x86_64 1.8.13-1.fc22       pcsc-lite-asekey.x86_64 3.7-1.fc22       pcsc-perl.x86_64 1.4.12-11.fc22     
</span><span class='line'>  pcsc-tools.x86_64 1.4.23-1.fc22      perl-Cairo.x86_64 1.105-1.fc22           perl-Glib.x86_64 1.310-1.fc22       
</span><span class='line'>  perl-Gtk2.x86_64 1.2495-1.fc22       perl-HTML-Tree.noarch 1:5.03-8.fc22      perl-Pango.x86_64 1.226-3.fc22      
</span><span class='line'>
</span><span class='line'>Complete!
</span><span class='line'>[root@vicky ~]# 
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@vicky ~]# dnf install opensc
</span><span class='line'>Last metadata expiration check performed 0:37:38 ago on Sun Jun 14 09:14:34 2015.
</span><span class='line'>Dependencies resolved.
</span><span class='line'>====================================================================================================================
</span><span class='line'> Package                  Arch                     Version                           Repository                Size
</span><span class='line'>====================================================================================================================
</span><span class='line'>Installing:
</span><span class='line'> opensc                   x86_64                   0.14.0-2.fc22                     fedora                   976 k
</span><span class='line'>
</span><span class='line'>Transaction Summary
</span><span class='line'>====================================================================================================================
</span><span class='line'>Install  1 Package
</span><span class='line'>
</span><span class='line'>Total download size: 976 k
</span><span class='line'>Installed size: 2.8 M
</span><span class='line'>Is this ok [y/N]: y
</span><span class='line'>Downloading Packages:
</span><span class='line'>opensc-0.14.0-2.fc22.x86_64.rpm                                                     277 kB/s | 976 kB     00:03    
</span><span class='line'>--------------------------------------------------------------------------------------------------------------------
</span><span class='line'>Total                                                                               203 kB/s | 976 kB     00:04     
</span><span class='line'>Running transaction check
</span><span class='line'>Transaction check succeeded.
</span><span class='line'>Running transaction test
</span><span class='line'>Transaction test succeeded.
</span><span class='line'>Running transaction
</span><span class='line'>  Installing  : opensc-0.14.0-2.fc22.x86_64                                                                     1/1 
</span><span class='line'>  Verifying   : opensc-0.14.0-2.fc22.x86_64                                                                     1/1 
</span><span class='line'>
</span><span class='line'>Installed:
</span><span class='line'>  opensc.x86_64 0.14.0-2.fc22                                                                                       
</span><span class='line'>
</span><span class='line'>Complete!
</span><span class='line'>[root@vicky ~]# dnf search opensc</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# dnf search ccid
</span><span class='line'>Last metadata expiration check performed 0:39:03 ago on Sun Jun 14 09:14:34 2015.
</span><span class='line'>================================================ N/S Matched: ccid =================================================
</span><span class='line'>pcsc-lite-ccid.x86_64 : Generic USB CCID smart card reader driver
</span><span class='line'>libykneomgr.i686 : YubiKey NEO CCID Manager C Library
</span><span class='line'>libykneomgr.x86_64 : YubiKey NEO CCID Manager C Library
</span><span class='line'>[root@vicky ~]# dnf install pcsc-lite-ccid
</span><span class='line'>Last metadata expiration check performed 0:39:34 ago on Sun Jun 14 09:14:34 2015.
</span><span class='line'>Dependencies resolved.
</span><span class='line'>====================================================================================================================
</span><span class='line'> Package                        Arch                   Version                         Repository              Size
</span><span class='line'>====================================================================================================================
</span><span class='line'>Installing:
</span><span class='line'> pcsc-lite-ccid                 x86_64                 1.4.18-1.fc22                   fedora                 177 k
</span><span class='line'>
</span><span class='line'>Transaction Summary
</span><span class='line'>====================================================================================================================
</span><span class='line'>Install  1 Package
</span><span class='line'>
</span><span class='line'>Total download size: 177 k
</span><span class='line'>Installed size: 599 k
</span><span class='line'>Is this ok [y/N]: y
</span><span class='line'>Downloading Packages:
</span><span class='line'>pcsc-lite-ccid-1.4.18-1.fc22.x86_64.rpm                                              47 kB/s | 177 kB     00:03    
</span><span class='line'>--------------------------------------------------------------------------------------------------------------------
</span><span class='line'>Total                                                                                27 kB/s | 177 kB     00:06     
</span><span class='line'>Running transaction check
</span><span class='line'>Transaction check succeeded.
</span><span class='line'>Running transaction test
</span><span class='line'>Transaction test succeeded.
</span><span class='line'>Running transaction
</span><span class='line'>  Installing  : pcsc-lite-ccid-1.4.18-1.fc22.x86_64                                                             1/1 
</span><span class='line'>  Verifying   : pcsc-lite-ccid-1.4.18-1.fc22.x86_64                                                             1/1 
</span><span class='line'>
</span><span class='line'>Installed:
</span><span class='line'>  pcsc-lite-ccid.x86_64 1.4.18-1.fc22                                                                               
</span><span class='line'>
</span><span class='line'>Complete!
</span><span class='line'>[root@vicky ~]# </span></code></pre></td></tr></table></div></figure>


<h4>Start the pcscd service</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@vicky ~]# systemctl list-unit-files -t service | grep pcscd
</span><span class='line'>pcscd.service                               static  
</span><span class='line'>[root@vicky ~]# systemctl start pcscd
</span><span class='line'>[root@vicky ~]# systemctl enable pcscd
</span><span class='line'>[root@vicky ~]# </span></code></pre></td></tr></table></div></figure>


<h4>Verify that you are able to see the yubi smartcard</h4>

<h5>Run pcsc_scan</h5>

<p>Execute &ldquo;pcsc_scan&rdquo; to verify that you see the smartcard</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ pcsc_scan 
</span><span class='line'>PC/SC device scanner
</span><span class='line'>V 1.4.23 (c) 2001-2011, Ludovic Rousseau &lt;ludovic.rousseau@free.fr&gt;
</span><span class='line'>Compiled with PC/SC lite version: 1.8.13
</span><span class='line'>Using reader plug'n play mechanism
</span><span class='line'>Scanning present readers...
</span><span class='line'>0: Gemalto Gemplus USB SmartCard Reader 433-Swap [CCID Interface] (1-0000:00:06.7-1) 00 00
</span><span class='line'>1: Yubico Yubikey NEO OTP+CCID 01 00
</span><span class='line'>
</span><span class='line'>Mon Jun 15 11:36:44 2015
</span><span class='line'>Reader 0: Gemalto Gemplus USB SmartCard Reader 433-Swap [CCID Interface] (1-0000:00:06.7-1) 00 00
</span><span class='line'>  Card state: Card removed, 
</span><span class='line'>Reader 1: Yubico Yubikey NEO OTP+CCID 01 00
</span><span class='line'>  Card state: Card inserted, 
</span><span class='line'>  ATR: 3B FC 13 00 00 81 31 FE 15 59 75 62 69 6B 65 79 4E 45 4F 72 33 E1
</span><span class='line'>
</span><span class='line'>defined(@array) is deprecated at /usr/lib64/perl5/vendor_perl/Chipcard/PCSC.pm line 69.
</span><span class='line'>        (Maybe you should just omit the defined()?)
</span><span class='line'>ATR: 3B FC 13 00 00 81 31 FE 15 59 75 62 69 6B 65 79 4E 45 4F 72 33 E1
</span><span class='line'>+ TS = 3B --&gt; Direct Convention
</span><span class='line'>+ T0 = FC, Y(1): 1111, K: 12 (historical bytes)
</span><span class='line'>  TA(1) = 13 --&gt; Fi=372, Di=4, 93 cycles/ETU
</span><span class='line'>    43010 bits/s at 4 MHz, fMax for Fi = 5 MHz =&gt; 53763 bits/s
</span><span class='line'>  TB(1) = 00 --&gt; VPP is not electrically connected
</span><span class='line'>  TC(1) = 00 --&gt; Extra guard time: 0
</span><span class='line'>  TD(1) = 81 --&gt; Y(i+1) = 1000, Protocol T = 1 
</span><span class='line'>-----
</span><span class='line'>  TD(2) = 31 --&gt; Y(i+1) = 0011, Protocol T = 1 
</span><span class='line'>-----
</span><span class='line'>  TA(3) = FE --&gt; IFSC: 254
</span><span class='line'>  TB(3) = 15 --&gt; Block Waiting Integer: 1 - Character Waiting Integer: 5
</span><span class='line'>+ Historical bytes: 59 75 62 69 6B 65 79 4E 45 4F 72 33
</span><span class='line'>  Category indicator byte: 59 (proprietary format)
</span><span class='line'>+ TCK = E1 (correct checksum)
</span><span class='line'>
</span><span class='line'>Possibly identified card (using /usr/share/pcsc/smartcard_list.txt):
</span><span class='line'>3B FC 13 00 00 81 31 FE 15 59 75 62 69 6B 65 79 4E 45 4F 72 33 E1
</span><span class='line'>        YubiKey NEO (PKI)
</span><span class='line'>        http://www.yubico.com/
</span></code></pre></td></tr></table></div></figure>


<h4>Remote smartcard access</h4>

<p>By default only console logins have access to the smartcard if you want to grant access to remote logins (e.g. ssh)
create a polkit rule for the user that will use the smartcard.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@vicky ~]# cd /usr/share/polkit-1/rules.d/                                    
</span><span class='line'>[root@vicky rules.d]# vi 30_smartcard_access.rules </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>polkit.addRule(function(action, subject) {
</span><span class='line'>    if (action.id == "org.debian.pcsc-lite.access_pcsc" &&
</span><span class='line'>        subject.user == "staf") {
</span><span class='line'>            return polkit.Result.YES;
</span><span class='line'>    }
</span><span class='line'>});
</span><span class='line'>
</span><span class='line'>polkit.addRule(function(action, subject) {
</span><span class='line'>    if (action.id == "org.debian.pcsc-lite.access_card" &&
</span><span class='line'>        action.lookup("reader") == 'name_of_reader' &&
</span><span class='line'>        subject.user == "staf") {
</span><span class='line'>            return polkit.Result.YES;    }
</span><span class='line'>});
</span></code></pre></td></tr></table></div></figure>


<h3>Reset smartcard PIN codes</h3>

<p>The default user PIN code is &ldquo;123456&rdquo; the default admin PIN code is &ldquo;12345678&rdquo;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ gpg --change-pin 
</span><span class='line'>gpg: OpenPGP card no. D2760001240102000006035062250000 detected
</span><span class='line'>
</span><span class='line'>1 - change PIN
</span><span class='line'>2 - unblock PIN
</span><span class='line'>3 - change Admin PIN
</span><span class='line'>4 - set the Reset Code
</span><span class='line'>Q - quit
</span><span class='line'>
</span><span class='line'>#### Change user PIN
</span><span class='line'>
</span><span class='line'>Your selection? </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Your selection? 1
</span><span class='line'>
</span><span class='line'>Please enter the PIN
</span><span class='line'>           
</span><span class='line'>New PIN
</span><span class='line'>               
</span><span class='line'>New PIN
</span><span class='line'>PIN changed.     
</span></code></pre></td></tr></table></div></figure>


<h4>Change admin PIN</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> - change PIN
</span><span class='line'>2 - unblock PIN
</span><span class='line'>3 - change Admin PIN
</span><span class='line'>4 - set the Reset Code
</span><span class='line'>Q - quit
</span><span class='line'>
</span><span class='line'>Your selection? 3
</span><span class='line'>gpg: 3 Admin PIN attempts remaining before card is permanently locked
</span><span class='line'>
</span><span class='line'>Please enter the Admin PIN
</span><span class='line'>                 
</span><span class='line'>New Admin PIN
</span><span class='line'>                     
</span><span class='line'>New Admin PIN
</span><span class='line'>PIN changed.     
</span><span class='line'>
</span><span class='line'>1 - change PIN
</span><span class='line'>2 - unblock PIN
</span><span class='line'>3 - change Admin PIN
</span><span class='line'>4 - set the Reset Code
</span><span class='line'>Q - quit
</span><span class='line'>
</span><span class='line'>Your selection? 
</span></code></pre></td></tr></table></div></figure>


<h3>Generate a new key pair</h3>

<h4>Execute &ldquo;gpg &ndash;card-edit&rdquo;</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ gpg --card-edit 
</span><span class='line'>
</span><span class='line'>Application ID ...: D2760001240102000006035062250000
</span><span class='line'>Version ..........: 2.0
</span><span class='line'>Manufacturer .....: unknown
</span><span class='line'>Serial number ....: 03506225
</span><span class='line'>Name of cardholder: [not set]
</span><span class='line'>Language prefs ...: [not set]
</span><span class='line'>Sex ..............: unspecified
</span><span class='line'>URL of public key : [not set]
</span><span class='line'>Login data .......: [not set]
</span><span class='line'>Signature PIN ....: forced
</span><span class='line'>Key attributes ...: 2048R 2048R 2048R
</span><span class='line'>Max. PIN lengths .: 127 127 127
</span><span class='line'>PIN retry counter : 3 3 3
</span><span class='line'>Signature counter : 5
</span><span class='line'>Signature key ....: 1E41 4C61 B1CE F02A F431  85BF 46B9 3657 54DF 802E
</span><span class='line'>      created ....: 2015-06-15 11:47:23
</span><span class='line'>Encryption key....: BB75 75F4 404A 2681 4331  4B46 34E7 EE51 4199 C702
</span><span class='line'>      created ....: 2015-06-15 11:47:23
</span><span class='line'>Authentication key: A7F8 A844 4762 C44D 20C7  A2AF E06D 602C 069D 7EFF
</span><span class='line'>      created ....: 2015-06-15 11:47:23
</span><span class='line'>General key info..: 
</span><span class='line'>pub  2048R/54DF802E 2015-06-15 qwerty &lt;qwert@qwert&gt;
</span><span class='line'>sec&gt;  2048R/54DF802E  created: 2015-06-15  expires: never     
</span><span class='line'>                      card-no: 0006 03506225
</span><span class='line'>ssb&gt;  2048R/069D7EFF  created: 2015-06-15  expires: never     
</span><span class='line'>                      card-no: 0006 03506225
</span><span class='line'>ssb&gt;  2048R/4199C702  created: 2015-06-15  expires: never     
</span><span class='line'>                      card-no: 0006 03506225
</span><span class='line'>
</span><span class='line'>gpg/card&gt; </span></code></pre></td></tr></table></div></figure>


<h4>Enable admin commands</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gpg/card&gt; admin
</span><span class='line'>Admin commands are allowed                                                      
</span><span class='line'>                                                                                
</span><span class='line'>gpg/card&gt;                                                                        </span></code></pre></td></tr></table></div></figure>


<h4>Generate key</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gpg/card&gt; generate 
</span><span class='line'>Make off-card backup of encryption key? (Y/n) n
</span><span class='line'>
</span><span class='line'>gpg: NOTE: keys are already stored on the card!
</span><span class='line'>
</span><span class='line'>Replace existing keys? (y/N) y
</span><span class='line'>
</span><span class='line'>Please note that the factory settings of the PINs are
</span><span class='line'>   PIN = `123456'     Admin PIN = `12345678'
</span><span class='line'>You should change them using the command --change-pin
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Please enter the PIN
</span><span class='line'>Please specify how long the key should be valid.
</span><span class='line'>         0 = key does not expire
</span><span class='line'>      &lt;n&gt;  = key expires in n days
</span><span class='line'>      &lt;n&gt;w = key expires in n weeks
</span><span class='line'>      &lt;n&gt;m = key expires in n months
</span><span class='line'>      &lt;n&gt;y = key expires in n years
</span><span class='line'>Key is valid for? (0) 
</span><span class='line'>Key does not expire at all
</span><span class='line'>Is this correct? (y/N) y
</span><span class='line'>
</span><span class='line'>You need a user ID to identify your key; the software constructs the user ID
</span><span class='line'>from the Real Name, Comment and Email Address in this form:
</span><span class='line'>    "Heinrich Heine (Der Dichter) &lt;heinrichh@duesseldorf.de&gt;"
</span><span class='line'>
</span><span class='line'>Real name: staf wagemakers
</span><span class='line'>Email address: staf@wagemakers.be
</span><span class='line'>Comment: 
</span><span class='line'>You selected this USER-ID:
</span><span class='line'>    "staf wagemakers &lt;staf@wagemakers.be&gt;"
</span><span class='line'>
</span><span class='line'>Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? O
</span><span class='line'>gpg: existing key will be replaced
</span><span class='line'>gpg: 3 Admin PIN attempts remaining before card is permanently locked
</span><span class='line'>
</span><span class='line'>Please enter the Admin PIN
</span><span class='line'>gpg: please wait while key is being generated ...
</span><span class='line'>gpg: key generation completed (5 seconds)
</span><span class='line'>gpg: signatures created so far: 0
</span><span class='line'>gpg: existing key will be replaced
</span><span class='line'>gpg: please wait while key is being generated ...
</span><span class='line'>gpg: key generation completed (35 seconds)
</span><span class='line'>gpg: signatures created so far: 1
</span><span class='line'>gpg: signatures created so far: 2
</span><span class='line'>gpg: existing key will be replaced
</span><span class='line'>gpg: please wait while key is being generated ...
</span><span class='line'>gpg: key generation completed (9 seconds)
</span><span class='line'>gpg: signatures created so far: 3
</span><span class='line'>gpg: signatures created so far: 4
</span><span class='line'>gpg: key C15CE3D7 marked as ultimately trusted
</span><span class='line'>public and secret key created and signed.
</span><span class='line'>
</span><span class='line'>gpg: checking the trustdb
</span><span class='line'>gpg: 3 marginal(s) needed, 1 complete(s) needed, PGP trust model
</span><span class='line'>gpg: depth: 0  valid:   2  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 2u
</span><span class='line'>pub   2048R/C15CE3D7 2015-06-15
</span><span class='line'>      Key fingerprint = B702 663D 833B DC19 0EEF  663A 54FA 0B1E C15C E3D7
</span><span class='line'>uid                  staf wagemakers &lt;staf@wagemakers.be&gt;
</span><span class='line'>sub   2048R/D2AEBBA3 2015-06-15
</span><span class='line'>sub   2048R/6C2C699A 2015-06-15
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>gpg/card&gt; 
</span></code></pre></td></tr></table></div></figure>


<h3>Extract the public key</h3>

<h4>Execute gpg &ndash;card-status</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@vicky ~]$ gpg --card-status
</span><span class='line'>Application ID ...: D2760001240102000006035062250000
</span><span class='line'>Version ..........: 2.0
</span><span class='line'>Manufacturer .....: unknown
</span><span class='line'>Serial number ....: 03506225
</span><span class='line'>Name of cardholder: [not set]
</span><span class='line'>Language prefs ...: [not set]
</span><span class='line'>Sex ..............: unspecified
</span><span class='line'>URL of public key : [not set]
</span><span class='line'>Login data .......: [not set]
</span><span class='line'>Signature PIN ....: not forced
</span><span class='line'>Key attributes ...: 2048R 2048R 2048R
</span><span class='line'>Max. PIN lengths .: 127 127 127
</span><span class='line'>PIN retry counter : 3 3 3
</span><span class='line'>Signature counter : 5
</span><span class='line'>Signature key ....: AED7 C79B 574D 45CC 7C1B  CC35 BDDE E66F 0C2C CF82
</span><span class='line'>      created ....: 2015-06-16 06:32:02
</span><span class='line'>Encryption key....: 6650 AB0A 5F31 059F 3221  3F29 C9F3 2031 01B3 1F53
</span><span class='line'>      created ....: 2015-06-16 06:32:02
</span><span class='line'>Authentication key: A387 A45A 446E DC9C D78E  F173 7C19 5D7D A1D9 9813
</span><span class='line'>      created ....: 2015-06-16 06:32:02
</span><span class='line'>General key info..: pub  2048R/0C2CCF82 2015-06-16 staf wagemakers &lt;staf@wagemakers.be&gt;
</span><span class='line'>sec&gt;  2048R/0C2CCF82  created: 2015-06-16  expires: never     
</span><span class='line'>                      card-no: 0006 03506225
</span><span class='line'>ssb&gt;  2048R/A1D99813  created: 2015-06-16  expires: never     
</span><span class='line'>                      card-no: 0006 03506225
</span><span class='line'>ssb&gt;  2048R/01B31F53  created: 2015-06-16  expires: never     
</span><span class='line'>                      card-no: 0006 03506225
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h4>Run gpgkey2ssh on the authentication key</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ gpgkey2ssh A1D99813
</span><span class='line'>ssh-rsa qwertyqwertyqwerty COMMENT
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h3>Test ssh access</h3>

<h4>Configure the gpg agent</h4>

<p>The gpg-agent can be use as a ssh-agent</p>

<h5>Enable ssh support in your gpg-agent.conf</h5>

<p>Create your gpg-agent.conf file</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ vi .gnupg/gpg-agent.conf</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pinentry-program  /usr/bin/pinentry
</span><span class='line'>enable-ssh-support</span></code></pre></td></tr></table></div></figure>


<h4>Start the gpg-agent</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@vicky ~]$ gpg-agent --daemon --verbose
</span><span class='line'>gpg-agent[1395]: listening on socket '/home/staf/.gnupg/S.gpg-agent'
</span><span class='line'>gpg-agent[1395]: listening on socket '/home/staf/.gnupg/S.gpg-agent.ssh'
</span><span class='line'>gpg-agent[1396]: gpg-agent (GnuPG) 2.1.4 started
</span><span class='line'>SSH_AUTH_SOCK=/home/staf/.gnupg/S.gpg-agent.ssh; export SSH_AUTH_SOCK;
</span><span class='line'>[staf@vicky ~]$ </span></code></pre></td></tr></table></div></figure>


<h4>Export the SSH_AUTH_SOCK variable</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>SSH_AUTH_SOCK=/home/staf/.gnupg/S.gpg-agent.ssh; export SSH_AUTH_SOCK;
</span></code></pre></td></tr></table></div></figure>


<h4>Verify the agent</h4>

<p>Run ssh-add -L</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[staf@vicky ~]$ ssh-add -L
</span><span class='line'>error fetching identities for protocol 1: agent refused operation
</span><span class='line'>ssh-rsa qwertyqwertyqwerty cardno:xxxx</span></code></pre></td></tr></table></div></figure>


<p>The public key must be the same as extracted with &ldquo;gpgkey2ssh&rdquo;</p>

<h4>Add the public key to the remote system</h4>

<p>Add this public key to ~/.ssh/authorized_keys on the remote system.</p>

<h4>Test</h4>

<p>Try to logon to your remote system</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staf@vicky ~]$ ssh -v xxx.xxx.xxx.xxx</span></code></pre></td></tr></table></div></figure>


<p>You should get a window that asks for user PIN code.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>               ┌──────────────────────────────────────────────┐
</span><span class='line'>               │ Please enter the PIN                         │
</span><span class='line'>               │                                              │
</span><span class='line'>               │ PIN ________________________________________ │
</span><span class='line'>               │                                              │
</span><span class='line'>               │      &lt;OK&gt;                        &lt;Cancel&gt;    │
</span><span class='line'>               └──────────────────────────────────────────────┘
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>FreeBSD 10.1-RELEASE-p10 (GENERIC) #0: Wed May 13 06:54:13 UTC 2015
</span><span class='line'>
</span><span class='line'>Welcome to FreeBSD!
</span><span class='line'>
</span><span class='line'>Release Notes, Errata: https://www.FreeBSD.org/releases/
</span><span class='line'>Security Advisories:   https://www.FreeBSD.org/security/
</span><span class='line'>FreeBSD Handbook:      https://www.FreeBSD.org/handbook/
</span><span class='line'>FreeBSD FAQ:           https://www.FreeBSD.org/faq/
</span><span class='line'>Questions List: https://lists.FreeBSD.org/mailman/listinfo/freebsd-questions/
</span><span class='line'>FreeBSD Forums:        https://forums.FreeBSD.org/
</span><span class='line'>
</span><span class='line'>Documents installed with the system are in the /usr/local/share/doc/freebsd/
</span><span class='line'>directory, or can be installed later with:  pkg install en-freebsd-doc
</span><span class='line'>For other languages, replace "en" with a language code like de or fr.
</span><span class='line'>
</span><span class='line'>Show the version of FreeBSD installed:  freebsd-version ; uname -a
</span><span class='line'>Please include that output and any error messages when posting questions.
</span><span class='line'>Introduction to manual pages:  man man
</span><span class='line'>FreeBSD directory layout:      man hier
</span><span class='line'>
</span><span class='line'>Edit /etc/motd to change this login announcement.
</span><span class='line'>Want to run the same command again?
</span><span class='line'>In tcsh you can type "!!"
</span><span class='line'>$ 
</span></code></pre></td></tr></table></div></figure>


<h2>CleanUp</h2>

<h3>Start the gpg-daemon</h3>

<p>Add</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gpg-agent --daemon
</span><span class='line'>SSH_AUTH_SOCK=/home/staf/.gnupg/S.gpg-agent.ssh; export SSH_AUTH_SOCK;</span></code></pre></td></tr></table></div></figure>


<p>To your .bash_profile or setup a generic script for all users in /etc/profile.d/</p>

<h3>Disable password login in the /etc/ssh/sshd_config</h3>

<p><em>Have fun!</em></p>

<h2>Links</h2>

<ul>
<li><a href="https://www.yubico.com/2012/12/yubikey-neo-openpgp/"><a href="https://www.yubico.com/2012/12/yubikey-neo-openpgp/">https://www.yubico.com/2012/12/yubikey-neo-openpgp/</a></a></li>
<li><a href="https://blog.habets.se/2013/02/GPG-and-SSH-with-Yubikey-NEO"><a href="https://blog.habets.se/2013/02/GPG-and-SSH-with-Yubikey-NEO">https://blog.habets.se/2013/02/GPG-and-SSH-with-Yubikey-NEO</a></a></li>
<li><a href="http://25thandclement.com/~william/YubiKey_NEO.html"><a href="http://25thandclement.com/~william/YubiKey_NEO.html">http://25thandclement.com/~william/YubiKey_NEO.html</a></a></li>
<li><a href="http://forum.yubico.com/viewtopic.php?f=26&t=1171"><a href="http://forum.yubico.com/viewtopic.php?f=26&amp;t=1171">http://forum.yubico.com/viewtopic.php?f=26&amp;t=1171</a></a></li>
<li><a href="https://developers.yubico.com/yubikey-personalization/Releases/"><a href="https://developers.yubico.com/yubikey-personalization/Releases/">https://developers.yubico.com/yubikey-personalization/Releases/</a></a></li>
<li><a href="http://www.incenp.org/notes/2014/gnupg-for-ssh-authentication.html"><a href="http://www.incenp.org/notes/2014/gnupg-for-ssh-authentication.html">http://www.incenp.org/notes/2014/gnupg-for-ssh-authentication.html</a></a></li>
<li><a href="http://www.programmierecke.net/howto/gpg-ssh.html"><a href="http://www.programmierecke.net/howto/gpg-ssh.html">http://www.programmierecke.net/howto/gpg-ssh.html</a></a></li>
<li><a href="http://www.bradfordembedded.com/2013/12/yubikey-smartcard/"><a href="http://www.bradfordembedded.com/2013/12/yubikey-smartcard/">http://www.bradfordembedded.com/2013/12/yubikey-smartcard/</a></a></li>
<li><a href="http://www.incenp.org/notes/2014/gnupg-for-ssh-authentication.html"><a href="http://www.incenp.org/notes/2014/gnupg-for-ssh-authentication.html">http://www.incenp.org/notes/2014/gnupg-for-ssh-authentication.html</a></a></li>
<li><a href="https://github.com/herlo/ssh-gpg-smartcard-config/blob/master/YubiKey_NEO.rst"><a href="https://github.com/herlo/ssh-gpg-smartcard-config/blob/master/YubiKey_NEO.rst">https://github.com/herlo/ssh-gpg-smartcard-config/blob/master/YubiKey_NEO.rst</a></a></li>
<li><a href="https://www.esev.com/blog/post/2015-01-pgp-ssh-key-on-yubikey-neo/"><a href="https://www.esev.com/blog/post/2015-01-pgp-ssh-key-on-yubikey-neo/">https://www.esev.com/blog/post/2015-01-pgp-ssh-key-on-yubikey-neo/</a></a></li>
<li><a href="https://wiki.archlinux.org/index.php/Common_Access_Card"><a href="https://wiki.archlinux.org/index.php/Common_Access_Card">https://wiki.archlinux.org/index.php/Common_Access_Card</a></a></li>
<li><a href="https://wiki.archlinux.org/index.php/Udev"><a href="https://wiki.archlinux.org/index.php/Udev">https://wiki.archlinux.org/index.php/Udev</a></a></li>
<li><a href="https://securityblog.redhat.com/2014/07/30/controlling-access-to-smart-cards/"><a href="https://securityblog.redhat.com/2014/07/30/controlling-access-to-smart-cards/">https://securityblog.redhat.com/2014/07/30/controlling-access-to-smart-cards/</a></a></li>
</ul>

</div>
  
  

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog_actrikel -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4659298941528586"
     data-ad-slot="7394058542"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2015/05/14/openvas-7-adding-credentials-failed/">Openvas 7: Adding Credentials Failed</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-14T16:56:00+02:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>4:56 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;m creating a new <a href="http://www.openvas.org">openvas 7</a> system running <a href="http://www.centos.org">centos 7</a> as a <a href="http://www.linux-kvm.org/">KVM</a> instance.</p>

<p><a href="http://www.openvas.org/install-packages-v7.html">The installation</a> went fine but it was impossible to create new credentials.</p>

<p>I had a similar issue with my openvas 6 installation, this was resolved by creating the  <code>/etc/openvas/gnupg</code> directory and creating the key  <code>openvasmd --create-credentials-encryption-key</code></p>

<p>But on my openvas 7 installation a creation of the encryption key was slooooow.
As always Good Randomness is important for creating keys. So I decided to install haveged to get more randomness and hopefully this would speed up key creation.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@localhost ~]# yum install haveged
</span><span class='line'>
</span><span class='line'>Loaded plugins: fastestmirror
</span><span class='line'>Loading mirror speeds from cached hostfile
</span><span class='line'> * atomic: www6.atomicorp.com
</span><span class='line'> * base: centos.cu.be
</span><span class='line'> * extras: centos.cu.be
</span><span class='line'> * updates: centos.cu.be
</span><span class='line'>Package haveged-1.9.1-2.el7.art.x86_64 already installed and latest version
</span><span class='line'>Nothing to do
</span><span class='line'>[root@localhost ~]# 
</span><span class='line'>[root@localhost ~]# systemct list-unit-files --type=service | grep haveged
</span><span class='line'>-bash: systemct: command not found
</span><span class='line'>[root@localhost ~]# systemctl list-unit-files --type=service | grep haveged
</span><span class='line'>haveged.service                             disabled
</span><span class='line'>[root@localhost ~]# systemctl enable haveged
</span><span class='line'>ln -s '/usr/lib/systemd/system/haveged.service' '/etc/systemd/system/multi-user.target.wants/haveged.service'
</span><span class='line'>[root@localhost ~]# systemctl start haveged
</span><span class='line'>[root@localhost ~]# </span></code></pre></td></tr></table></div></figure>


<p>The key creation took a only sec.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@localhost ~]# openvasmd --create-credentials-encryption-key
</span><span class='line'>Key creation succeeded.
</span><span class='line'>[root@localhost ~]# </span></code></pre></td></tr></table></div></figure>


<p>Adding new credentials works like a charm now.</p>

<p style="font-style: italic;">
Happy hacking!
</p>



</div>
  
  

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog_actrikel -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4659298941528586"
     data-ad-slot="7394058542"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2015/05/12/run-google-chrome-inside-a-fedora-docker-container-over-ssh/">Run Google Chrome Inside a Fedora Docker Container Over Ssh</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-12T14:55:00+02:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>12</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>2:55 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong></p>

<hr />


<p>Update (Mon Jun  8 2015):</p>

<p>Running google-chrome inside a docker container isn&rsquo;t stable for me.
I switched back to LXC to run google-chrome which seems to be more stable.</p>

<hr />


<p></strong></p>

<p>Created a docker image to start a docker container with chrome.
Destroying the container each time that you start a browser is a easy way to get rid of your cookies and browser history.</p>

<h2>Run google chrome inside a fedora docker container over ssh</h2>

<h3>Installation instructions</h3>

<p>1/ Clone the git repo</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git clone https://github.com/stafwag/docker-fedora-chrome-ssh.git</span></code></pre></td></tr></table></div></figure>


<p>2/ Copy your public ssh to id_rsa.pub</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd docker-fedora-chrome-ssh
</span><span class='line'>$ cp ~/.ssh/id_rsa.pub .</span></code></pre></td></tr></table></div></figure>


<p>3/ Build the docker image</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker build -t stafwag/docker-fedora-chrome-ssh .</span></code></pre></td></tr></table></div></figure>


<p>4/ Update your ssh config</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vi ~/.ssh/config</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Host mychrome
</span><span class='line'>          User      chrome
</span><span class='line'>          Port      8022
</span><span class='line'>          HostName  127.0.0.1
</span><span class='line'>          StrictHostKeyChecking no
</span><span class='line'>          UserKnownHostsFile=/dev/null
</span><span class='line'>          ForwardX11 yes</span></code></pre></td></tr></table></div></figure>


<p>5/ Start chrome</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ./startchrome.sh</span></code></pre></td></tr></table></div></figure>



</div>
  
  

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog_actrikel -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4659298941528586"
     data-ad-slot="7394058542"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2015/01/01/happy-new-year-2015/">Happy_new_year_2015</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-01-01T12:20:00+01:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>1</span><span class='date-suffix'>st</span>, <span class='date-year'>2015</span></span> <span class='time'>12:20 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
Happy new year!
</p>


<p><img class="center" src="/blog/images/2015.jpg" width="1000" height="625" title="&#34;2014.jpg&#34;" alt="&#34;2014.jpg&#34;"></p>
</div>
  
  

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog_actrikel -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4659298941528586"
     data-ad-slot="7394058542"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/posts/5">&larr; Older</a>
    
    <a href="/blog/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/posts/3">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <p><a href="http://www.wagemakers.be">http://www.wagemakers.be</a></p>
  <p><a href="http://www.linkedin.com/in/stafwagemakers">LinkedIn profile</a></p>
  <p><a href="https://google.com/+StafWagemakers">Google Plus profile</a></p>
<!-- Place this tag where you want the widget to render. -->
<div class="g-person" data-width="180" data-href="http://google.com/+StafWagemakers" data-showtagline="false" data-showcoverphoto="false" data-rel="author"></div>

<!-- Place this tag after the last widget tag. -->
<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
</section>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/blog/2019/04/22/building-your-own-docker-images_part1/">Building Your Own Docker Base Images (Part 1: Debian GNU/Linux & Co)</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2019/03/03/howto-use-centos-cloud-images-with-cloud-init/">Howto Use Centos Cloud Images With Cloud-init on KVM/libvirtd</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2019/02/10/how-to-install-libreboot-on-a-thinkspad-w500/">How to Install Libreboot on a ThinkPad W500</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2019/01/21/settinp-up-openstack-ansible-all-in-one-on-a-centos-7-system/">Setting Up OpenStack-Ansible All-In-One on a Centos 7 System</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2019/01/02/best-wishes-2019/">Best Wishes 2019</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/stafwag">@stafwag</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'stafwag',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/blog/javascripts/github.js" type="text/javascript"> </script>
</section>





<hr />
<br />
<br />
<br />
<br />
<script type="text/javascript"><!--
google_ad_client = "ca-pub-4659298941528586";
/* blogads_right */
google_ad_slot = "8839948148";
google_ad_width = 160;
google_ad_height = 600;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2019 - staf wagemakers -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'stafwag';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
